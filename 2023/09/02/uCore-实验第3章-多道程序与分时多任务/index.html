<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>uCore 实验第 3 章 - 多道程序与分时多任务 - 如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">










<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="../../../../css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>



<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="../../../../index.html">
                
                <img src="../../../../images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            uCore 实验第 3 章 - 多道程序与分时多任务
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-09-02T08:03:02.000Z" itemprop="datePublished">9月 2 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../../../categories/uCore-%E5%AE%9E%E9%AA%8C/">uCore 实验</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            26 分钟 lesen (Über 3882 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动时初始化进程表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (p = pool; p &lt; &amp;pool[NPROC]; p++) &#123;</span><br><span class="line">        p-&gt;state = UNUSED;</span><br><span class="line">        <span class="comment">// p - pool 是 p 指向的 proc 在 pool 中的下标，因此 p - pool 变化情况是 0, 1, 2, ..., NPROC - 1</span></span><br><span class="line">        p-&gt;kstack    = (uint64)kstack[p - pool];</span><br><span class="line">        p-&gt;ustack    = (uint64)ustack[p - pool];</span><br><span class="line">        p-&gt;trapframe = (struct trapframe *)trapframe[p - pool];</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    idle.kstack  = (uint64)boot_stack_top;</span><br><span class="line">    idle.pid     = <span class="number">0</span>;</span><br><span class="line">    current_proc = &amp;idle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>p - pool 表示什么？<br>假设我们有一个名为 pool 的数组，其中包含了多个类型为 struct proc 的元素，并且有一个指针 p 指向其中的某个元素。<br>当 p 指向 pool 数组的第一个元素时，p - pool 的结果将是 0，因为指针相对于数组首地址的偏移量为 0。<br>当 p 指向 pool 数组的第二个元素时，p - pool 的结果将是 1，因为指针相对于数组首地址的偏移量为 1。<br>以此类推，当 p 指向 pool 数组的第 N 个元素时，p - pool 的结果将是 N-1，因为指针相对于数组首地址的偏移量为 N-1。<br>总结来说，如果 p 是指向 pool 数组中第 N 个元素的指针，那么 p - pool 的结果将是 N-1。</p>
</blockquote>
<p>原调度函数每次都会从 pool 数组的第一个元素开始遍历，这样会导致每次都是从第一个进程开始运行，而不是从上次运行的进程开始运行。需要修改为如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调度程序永不返回。它循环执行以下操作：</span></span><br><span class="line"><span class="comment">//  - 选择要运行的进程。</span></span><br><span class="line"><span class="comment">//  - 切换以启动运行该进程。</span></span><br><span class="line"><span class="comment">//  - 最终，该进程通过切换将控制权</span></span><br><span class="line"><span class="comment">//    传递回调度程序。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">last_checked_proc</span> =</span> pool; <span class="comment">// 初始化指针为 pool</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (p = last_checked_proc; p &lt; &amp;pool[NPROC];</span><br><span class="line">             p++) &#123; <span class="comment">// 将 p 初始化为 last_checked_proc</span></span><br><span class="line">            <span class="keyword">if</span> (p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * LAB1：你可能需要在这里初始化进程的起始时间</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                p-&gt;state     = RUNNING;</span><br><span class="line">                current_proc = p;</span><br><span class="line">                swtch(&amp;idle.context, &amp;p-&gt;context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        last_checked_proc = pool + <span class="number">1</span>; <span class="comment">// 更新 last_checked_proc 的值为下一个位置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="LAB1"><a href="#LAB1" class="headerlink" title="LAB1"></a>LAB1</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"> os/loader.c           |   <span class="number">5</span> +-</span><br><span class="line"> os/proc.c             |  <span class="number">15</span> +-</span><br><span class="line"> os/proc.h             |  <span class="number">23</span> +-</span><br><span class="line"> os/syscall.c          |  <span class="number">55</span> ++++-</span><br><span class="line"> os/syscall_ids.h      |   <span class="number">5</span> +-</span><br><span class="line"> os/timer.h            |   <span class="number">2</span> +</span><br><span class="line"> <span class="number">9</span> files changed, <span class="number">374</span> insertions(+), <span class="number">291</span> deletions(-)</span><br><span class="line"></span><br><span class="line">diff --git a/os/loader.c b/os/loader.c</span><br><span class="line">index b45e85d..b21b0a4 <span class="number">100644</span></span><br><span class="line">--- a/os/loader.c</span><br><span class="line">+++ b/os/loader.c</span><br><span class="line">@@ <span class="number">-1</span>,<span class="number">6</span> +<span class="number">1</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;loader.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">static</span> uint64  app_num;</span><br><span class="line"> <span class="keyword">static</span> uint64 *app_info_ptr;</span><br><span class="line">@@ <span class="number">-49</span>,<span class="number">8</span> +<span class="number">50</span>,<span class="number">10</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">run_all_app</span><span class="params">()</span></span></span><br><span class="line"><span class="function">         trapframe-&gt;sp  </span>= (uint64)p-&gt;ustack + USER_STACK_SIZE;</span><br><span class="line">         p-&gt;state       = RUNNABLE;</span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">-		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">+		* LAB1: 初始化系统调用数以及进程开始时间</span></span><br><span class="line"><span class="comment"> 		*/</span></span><br><span class="line">+        <span class="built_in">memset</span>(p-&gt;syscall_times, <span class="number">0</span>, MAX_SYSCALL_NUM * <span class="keyword">sizeof</span>(uint32));</span><br><span class="line">+        p-&gt;start_time = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/os/proc.c b/os/proc.c</span><br><span class="line">index fee3886.<span class="number">.0</span>c69ae5 <span class="number">100644</span></span><br><span class="line">--- a/os/proc.c</span><br><span class="line">+++ b/os/proc.c</span><br><span class="line">@@ <span class="number">-2</span>,<span class="number">6</span> +<span class="number">2</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;loader.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> <span class="title">pool</span>[<span class="title">NPROC</span>];</span></span><br><span class="line"> <span class="keyword">char</span>        kstack[NPROC][PAGE_SIZE];</span><br><span class="line">@@ <span class="number">-33</span>,<span class="number">9</span> +<span class="number">34</span>,<span class="number">8</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">         p-&gt;kstack    </span>= (uint64)kstack[p - pool];</span><br><span class="line">         p-&gt;ustack    = (uint64)ustack[p - pool];</span><br><span class="line">         p-&gt;trapframe = (struct trapframe *)trapframe[p - pool];</span><br><span class="line">-        <span class="comment">/*</span></span><br><span class="line"><span class="comment">-		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">-		*/</span></span><br><span class="line">+        <span class="built_in">memset</span>(p-&gt;syscall_times, <span class="number">0</span>, MAX_SYSCALL_NUM * <span class="keyword">sizeof</span>(uint32));</span><br><span class="line">+        p-&gt;start_time = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     idle.kstack  = (uint64)boot_stack_top;</span><br><span class="line">     idle.pid     = <span class="number">0</span>;</span><br><span class="line">@@ <span class="number">-47</span>,<span class="number">6</span> +<span class="number">47</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">allocpid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">     <span class="keyword">static</span> <span class="keyword">int</span> PID </span>= <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">return</span> PID++;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line"> <span class="comment">// 在进程表中寻找一个未使用的进程。</span></span><br><span class="line"> <span class="comment">// 如果找到，则初始化在内核中运行所需的状态。</span></span><br><span class="line"> <span class="comment">// 如果没有空闲的进程，或者内存分配失败，则返回 0。</span></span><br><span class="line">@@ <span class="number">-80</span>,<span class="number">14</span> +<span class="number">81</span>,<span class="number">18</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">last_checked_proc</span> =</span> pool; <span class="comment">// 初始化指针为 pool</span></span><br><span class="line">-</span><br><span class="line">     <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">         <span class="keyword">for</span> (p = last_checked_proc; p &lt; &amp;pool[NPROC];</span><br><span class="line">              p++) &#123; <span class="comment">// 将 p 初始化为 last_checked_proc</span></span><br><span class="line">             <span class="keyword">if</span> (p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">                 <span class="comment">/*</span></span><br><span class="line"><span class="comment">-                * LAB1：你可能需要在这里初始化进程的起始时间</span></span><br><span class="line"><span class="comment">+                * LAB1：在这里初始化进程的开始时间</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">+                <span class="keyword">if</span> (p-&gt;start_time == <span class="number">0</span>) &#123;</span><br><span class="line">+                    uint64 cycle = get_cycle();</span><br><span class="line">+                    p-&gt;start_time =</span><br><span class="line">+                        (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+                &#125;</span><br><span class="line">                 p-&gt;state     = RUNNING;</span><br><span class="line">                 current_proc = p;</span><br><span class="line">                 swtch(&amp;idle.context, &amp;p-&gt;context);</span><br><span class="line">diff --git a/os/proc.h b/os/proc.h</span><br><span class="line">index d208c5d.<span class="number">.53576</span>bf <span class="number">100644</span></span><br><span class="line">--- a/os/proc.h</span><br><span class="line">+++ b/os/proc.h</span><br><span class="line">@@ <span class="number">-3</span>,<span class="number">7</span> +<span class="number">3</span>,<span class="number">8</span> @@</span><br><span class="line"> </span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">-<span class="meta">#<span class="meta-keyword">define</span> NPROC (16)</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> NPROC           (16)  <span class="comment">// 最大进程数</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> MAX_SYSCALL_NUM (500) <span class="comment">// 最大系统调用数</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">@@ <span class="number">-42</span>,<span class="number">14</span> +<span class="number">43</span>,<span class="number">28</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">     uint64            kstack;    <span class="comment">// 进程内核栈虚拟地址 (内核页表)</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">trapframe</span>;</span> <span class="comment">// 进程中断帧</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">context</span>    <span class="title">context</span>;</span> <span class="comment">// 用于保存进程内核态的寄存器信息，进程切换时使用</span></span><br><span class="line">-                               <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to add some new fields here</span></span><br><span class="line"><span class="comment">+    /*</span></span><br><span class="line"><span class="comment">+	* LAB1: 添加一些新的成员用于新的 sys_task_info 系统调用</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    uint32 syscall_times[MAX_SYSCALL_NUM]; <span class="comment">// 系统调用次数统计 <span class="doctag">TODO:</span> 后续改为指针</span></span><br><span class="line">+    uint64 start_time;                     <span class="comment">// 进程开始运行时间</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define struct for TaskInfo here</span></span><br><span class="line"><span class="comment">+* LAB1: 定义 TaskInfo 结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">+    UnInit,</span><br><span class="line">+    Ready,</span><br><span class="line">+    Running,</span><br><span class="line">+    Exited,</span><br><span class="line">+&#125; TaskStatus;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+    TaskStatus status;</span><br><span class="line">+    uint32     syscall_times[MAX_SYSCALL_NUM];</span><br><span class="line">+    <span class="keyword">int</span>        time; <span class="comment">// 进程运行时间统计</span></span><br><span class="line">+&#125; TaskInfo;</span><br><span class="line"> </span><br><span class="line"> <span class="function">struct proc *<span class="title">curr_proc</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span>         <span class="title">exit</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">diff --git a/os/syscall.c b/os/syscall.c</span><br><span class="line">index <span class="number">1</span>cc5aeb..f54ed86 <span class="number">100644</span></span><br><span class="line">--- a/os/syscall.c</span><br><span class="line">+++ b/os/syscall.c</span><br><span class="line">@@ <span class="number">-4</span>,<span class="number">6</span> +<span class="number">4</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;syscall_ids.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;proc.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="function">uint64 <span class="title">sys_write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *str, uint len)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">@@ <span class="number">-31</span>,<span class="number">14</span> +<span class="number">32</span>,<span class="number">46</span> @@ <span class="function">uint64 <span class="title">sys_sched_yield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> uint64 <span class="title">sys_gettimeofday</span><span class="params">(TimeVal *val, <span class="keyword">int</span> _tz)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     uint64 cycle = get_cycle();</span><br><span class="line">-    val-&gt;sec     = cycle / CPU_FREQ;</span><br><span class="line">-    val-&gt;usec    = (cycle % CPU_FREQ) * MICROSECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    tracef(<span class="string">&quot;sys_gettimeofday cycle = %d&quot;</span>, cycle);</span><br><span class="line">+    val-&gt;sec  = cycle / CPU_FREQ;</span><br><span class="line">+    val-&gt;msec = (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    val-&gt;usec = (cycle % CPU_FREQ) * MICROSECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">-<span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define sys_task_info here</span></span><br><span class="line"><span class="comment">-*/</span></span><br><span class="line">+<span class="comment">/** </span></span><br><span class="line"><span class="comment">+ * LAB1：此处定义 sys_task_info 函数</span></span><br><span class="line"><span class="comment">+ * 查询当前正在执行的任务信息，任务信息包括任务控制块相关信息（任务状态）、任务使用的系统调用次数、任务总运行时长。 </span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="function"><span class="keyword">int</span> <span class="title">sys_task_info</span><span class="params">(TaskInfo *ti)</span></span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">proc</span> =</span> curr_proc();</span><br><span class="line">+    <span class="comment">// <span class="doctag">TODO:</span> proc 检查为空</span></span><br><span class="line">+    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_SYSCALL_NUM; i++) &#123;</span><br><span class="line">+        ti-&gt;syscall_times[i] = proc-&gt;syscall_times[i];</span><br><span class="line">+    &#125;</span><br><span class="line">+    uint64 cycle = get_cycle();</span><br><span class="line">+    uint64 current_time =</span><br><span class="line">+        (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    infof(<span class="string">&quot;sys_task_info current_time = %d&quot;</span>, current_time);</span><br><span class="line">+    infof(<span class="string">&quot;proc-&gt;start_time = %d&quot;</span>, proc-&gt;start_time);</span><br><span class="line">+    infof(<span class="string">&quot;ti-&gt;time = %d&quot;</span>, current_time - proc-&gt;start_time);</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (proc-&gt;state == RUNNING) &#123;</span><br><span class="line">+        ti-&gt;status = Running;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == RUNNABLE) &#123;</span><br><span class="line">+        ti-&gt;status = Ready;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == SLEEPING) &#123;</span><br><span class="line">+        ti-&gt;status = Ready;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == ZOMBIE) &#123;</span><br><span class="line">+        ti-&gt;status = Exited;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == UNUSED) &#123;</span><br><span class="line">+        ti-&gt;status = UnInit;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    ti-&gt;time = current_time - proc-&gt;start_time;</span><br><span class="line">+    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">extern</span> <span class="keyword">char</span> trap_page[];</span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-51</span>,<span class="number">8</span> +<span class="number">84</span>,<span class="number">9</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">syscall</span><span class="params">()</span></span></span><br><span class="line"><span class="function">     <span class="title">tracef</span><span class="params">(<span class="string">&quot;syscall %d args = [%x, %x, %x, %x, %x, %x]&quot;</span>, id, args[<span class="number">0</span>], args[<span class="number">1</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            args[<span class="number">2</span>], args[<span class="number">3</span>], args[<span class="number">4</span>], args[<span class="number">5</span>])</span></span>;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to update syscall counter for task info here</span></span><br><span class="line"><span class="comment">+	* LAB1: 更新系统调用次数</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    curr_proc()-&gt;syscall_times[id]++;</span><br><span class="line">     <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">     <span class="keyword">case</span> SYS_write:</span><br><span class="line">         ret = sys_write(args[<span class="number">0</span>], (<span class="keyword">char</span> *)args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">@@ <span class="number">-67</span>,<span class="number">8</span> +<span class="number">101</span>,<span class="number">15</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">syscall</span><span class="params">()</span></span></span><br><span class="line"><span class="function">         ret </span>= sys_gettimeofday((TimeVal *)args[<span class="number">0</span>], args[<span class="number">1</span>]);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to add SYS_taskinfo case here</span></span><br><span class="line"><span class="comment">+	* LAB1: 在此处添加 SYS_task_info 的系统调用处理情况</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    <span class="keyword">case</span> SYS_task_info:</span><br><span class="line">+        ret = sys_task_info((TaskInfo *)args[<span class="number">0</span>]);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+    <span class="keyword">case</span> SYS_getpid:</span><br><span class="line">+        infof(<span class="string">&quot;SYS_getpid %d&quot;</span>, SYS_getpid);</span><br><span class="line">+        ret = curr_proc()-&gt;pid;</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">         ret = <span class="number">-1</span>;</span><br><span class="line">         errorf(<span class="string">&quot;unknown syscall %d&quot;</span>, id);</span><br><span class="line">diff --git a/os/syscall_ids.h b/os/syscall_ids.h</span><br><span class="line">index <span class="number">05</span>a6cb9.<span class="number">.3</span>c1a5a9 <span class="number">100644</span></span><br><span class="line">--- a/os/syscall_ids.h</span><br><span class="line">+++ b/os/syscall_ids.h</span><br><span class="line">@@ <span class="number">-277</span>,<span class="number">9</span> +<span class="number">277</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_pgetevents          292</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_rseq                   293</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_kexec_file_load        294</span></span><br><span class="line">-<span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define SYS_task_info here</span></span><br><span class="line"><span class="comment">-*/</span></span><br><span class="line">+<span class="comment">// LAB1：添加 SYS_task_info 的系统调用号</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> SYS_task_info          410</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_pidfd_send_signal  424</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_uring_setup     425</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_uring_enter     426</span></span><br><span class="line">diff --git a/os/timer.h b/os/timer.h</span><br><span class="line">index c6ebd14.<span class="number">.63</span>ab45c <span class="number">100644</span></span><br><span class="line">--- a/os/timer.h</span><br><span class="line">+++ b/os/timer.h</span><br><span class="line">@@ <span class="number">-6</span>,<span class="number">6</span> +<span class="number">6</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> TICKS_PER_SEC (100)</span></span><br><span class="line"> <span class="comment">// QEMU</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CPU_FREQ                (12500000)</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> MILLISECONDS_PER_SECOND (1000)</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> MICROSECONDS_PER_SECOND (1000000)</span></span><br><span class="line"> </span><br><span class="line"> <span class="function">uint64 <span class="title">get_cycle</span><span class="params">()</span></span>;</span><br><span class="line">@@ <span class="number">-14</span>,<span class="number">6</span> +<span class="number">15</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">void</span>   <span class="title">set_next_timer</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">     uint64 sec;  <span class="comment">// 自 Unix 纪元起的秒数</span></span><br><span class="line">+    uint64 msec; <span class="comment">// 毫秒数</span></span><br><span class="line">     uint64 usec; <span class="comment">// 微秒数</span></span><br><span class="line"> &#125; TimeVal;</span><br><span class="line"> </span><br><span class="line">-- </span><br><span class="line"><span class="number">2.34</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="问答作业"><a href="#问答作业" class="headerlink" title="问答作业"></a>问答作业</h1><h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h2><p>正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。请同学们可以自行测试这些内容（参考 前三个测例，描述程序出错行为，同时注意注明你使用的 sbi 及其版本。</p>
<p>测试前三个测试用例指的是<code>uCore-Tutorial-Code-2023S/user/src/</code> 目录下的三个<code>bad</code>测试用例，查看<code>user</code>项目的 Makefile 可以发现在编译时修改<code>CHAPTER</code>参数值为<code>2_bad</code>即可编译运行这些测试用例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[rustsbi] RustSBI version 0.3.0-alpha.2, adapting to RISC-V SBI v1.0.0</span><br><span class="line">.______       __    __      _______.___________.  _______..______   __</span><br><span class="line">|   _  \     |  |  |  |    /       |           | /       ||   _  \ |  |</span><br><span class="line">|  |_)  |    |  |  |  |   |   (----`---|  |----`|   (----`|  |_)  ||  |</span><br><span class="line">|      /     |  |  |  |    \   \       |  |      \   \    |   _  &lt; |  |</span><br><span class="line">|  |\  \----.|  `--<span class="string">&#x27;  |.----)   |      |  |  .----)   |   |  |_)  ||  |</span></span><br><span class="line"><span class="string">| _| `._____| \______/ |_______/       |__|  |_______/    |______/ |__|</span></span><br><span class="line"><span class="string">[rustsbi] Implementation     : RustSBI-QEMU Version 0.2.0-alpha.2</span></span><br><span class="line"><span class="string">[rustsbi] Platform Name      : riscv-virtio,qemu</span></span><br><span class="line"><span class="string">[rustsbi] Platform SMP       : 1</span></span><br><span class="line"><span class="string">[rustsbi] Platform Memory    : 0x80000000..0x88000000</span></span><br><span class="line"><span class="string">[rustsbi] Boot HART          : 0</span></span><br><span class="line"><span class="string">[rustsbi] Device Tree Region : 0x87000000..0x87000ef2</span></span><br><span class="line"><span class="string">[rustsbi] Firmware Address   : 0x80000000</span></span><br><span class="line"><span class="string">[rustsbi] Supervisor Address : 0x80200000</span></span><br><span class="line"><span class="string">[rustsbi] pmp01: 0x00000000..0x80000000 (-wr)</span></span><br><span class="line"><span class="string">[rustsbi] pmp02: 0x80000000..0x80200000 (---)</span></span><br><span class="line"><span class="string">[rustsbi] pmp03: 0x80200000..0x88000000 (xwr)</span></span><br><span class="line"><span class="string">[rustsbi] pmp04: 0x88000000..0x00000000 (-wr)</span></span><br><span class="line"><span class="string">[TRACE 0]load app 0 at 0x0000000080400000</span></span><br><span class="line"><span class="string">[TRACE 0]load app 1 at 0x0000000080420000</span></span><br><span class="line"><span class="string">[TRACE 0]load app 2 at 0x0000000080440000</span></span><br><span class="line"><span class="string">[INFO 0]start scheduler!</span></span><br><span class="line"><span class="string">[ERROR 1]unknown trap: 0x0000000000000007, stval = 0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[INFO 1]进程 1 以代码 -1 退出</span></span><br><span class="line"><span class="string">IllegalInstruction in application, core dumped.</span></span><br><span class="line"><span class="string">[INFO 2]进程 2 以代码 -3 退出</span></span><br><span class="line"><span class="string">IllegalInstruction in application, core dumped.</span></span><br><span class="line"><span class="string">[INFO 3]进程 3 以代码 -3 退出</span></span><br><span class="line"><span class="string">[PANIC 3] os/loader.c:15: all apps over</span></span><br></pre></td></tr></table></figure>

<p>第一个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> *p = (<span class="keyword">int</span> *)<span class="number">0</span>;</span><br><span class="line">	*p = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在您提供的代码中，将空指针分配给指针变量*p 后，试图对其进行解引用并将值 0 赋给该指针。由于用户模式下禁止直接访问物理内存，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped.</p>
<p>在 RISC-V 架构中，U 模式是最低的用户模式，用户程序无法直接访问物理内存或其他特权级别资源。这种限制是为了确保操作系统的安全性和稳定性。</p>
<p>第二个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;sret&quot;</span>)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>试图使用汇编语言执行 sret 指令，该指令用于从中断或异常处理程序返回。由于用户模式下禁止直接访问特权级别寄存器，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped。</p>
<p>第三个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	uint64 x;</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;csrr %0, sstatus&quot;</span> : <span class="string">&quot;=r&quot;</span>(x))</span></span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因同上，试图使用汇编语言执行 csrr 指令，该指令用于从特权级别寄存器中读取值。由于用户模式下禁止直接访问特权级别寄存器，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped。</p>
<p>在操作系统代码中，触发异常后会进入<code>void usertrap()</code> 函数，该函数会根据 <code>scause</code> 寄存器的值判断异常类型，用例中的结果进入了<code>case IllegalInstruction</code>，其中 <code>IllegalInstruction = 2</code>。我们查阅手册 <code>riscv-privileged.pdf</code> ，可以查到 <code>IllegalInstruction</code> 的值为 2，与预期相符。</p>
<h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h2><p>请结合用例理解 trampoline.S 中两个函数 <code>userret</code> 和 <code>uservec</code> 的作用，并回答如下几个问题：</p>
<h3 id="L79-刚进入-userret-时，a0、a1-分别代表了什么值。"><a href="#L79-刚进入-userret-时，a0、a1-分别代表了什么值。" class="headerlink" title="L79: 刚进入 userret 时，a0、a1 分别代表了什么值。"></a>L79: 刚进入 <code>userret</code> 时，<code>a0</code>、<code>a1</code> 分别代表了什么值。</h3><p>在进入<code>userret</code>函数时，<code>a0</code>和<code>a1</code>分别代表以下值：</p>
<ul>
<li><code>a0</code>: TRAPFRAME 的地址，指向当前进程的陷阱帧（trapframe）结构体。</li>
<li><code>a1</code>: 用户页表的地址，即进程的页表（pagetable）。这个地址会被写入到<code>satp</code>寄存器中，用于切换到用户模式的页表。</li>
</ul>
<h3 id="L87-L88-sfence-指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？"><a href="#L87-L88-sfence-指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？" class="headerlink" title="L87-L88: sfence 指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？"></a>L87-L88: <code>sfence</code> 指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">csrw satp, a1</span><br><span class="line">sfence.vma zero, zero</span><br></pre></td></tr></table></figure>

<p><code>sfence</code>指令（Store Fence）的作用是确保之前的存储操作完成，并且对其他处理器上的核心可见。</p>
<p>执行<code>sfence</code>指令的主要目的是为了保证内存访问的顺序性和一致性。在多核处理器系统中，不同的核心可能会有自己的缓存，当一个核心修改了共享内存中的数据时，为了保证其他核心能够看到这个修改，需要使用<code>sfence</code>指令来刷新缓存并将修改写回共享内存。</p>
<p>在代码中，<code>sfence</code>指令被用于确保对用户页表的修改对其他处理器上的核心可见。因为目前我只使用了单核处理器，所以不会出现多核处理器的情况，因此<code>sfence</code>指令的作用是确保对用户页表的修改对当前核心可见。</p>
<p>因此，当前章节中，<strong>删掉该指令不会导致错误</strong>。</p>
<h3 id="L96-L125-为何注释中说要除去-a0？哪一个地址代表-a0？现在-a0-的值存在何处？"><a href="#L96-L125-为何注释中说要除去-a0？哪一个地址代表-a0？现在-a0-的值存在何处？" class="headerlink" title="L96-L125: 为何注释中说要除去 a0？哪一个地址代表 a0？现在 a0 的值存在何处？"></a>L96-L125: 为何注释中说要除去 <code>a0</code>？哪一个地址代表 <code>a0</code>？现在 <code>a0</code> 的值存在何处？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># restore all but a0 from TRAPFRAME</span><br><span class="line">ld ra, 40(a0)</span><br><span class="line">ld sp, 48(a0)</span><br><span class="line">ld t5, 272(a0)</span><br><span class="line">ld t6, 280(a0)</span><br></pre></td></tr></table></figure>

<p><code>a0</code> 是<strong>保存在 <code>sscratch</code> 寄存器中的</strong>，首先，该代码通过 <code>ld</code> 指令从 <code>TRAPFRAME</code> 中加载各个寄存器的值。然后，这些值被存储在相应的寄存器中，以便在恢复用户上下文时使用。</p>
<p>接下来，代码使用 <code>csrrw</code> 指令将 sscratch 寄存器的值与 <code>a0</code>（即 <code>TRAPFRAME</code>）进行交换。这样做是为了将用户的 <code>a0</code>（<code>TRAPFRAME</code>）保存在 <code>sscratch</code> 寄存器中，以便后续步骤可以正确地恢复用户上下文。</p>
<p>最后，通过 <code>sret</code> 指令返回到用户模式，并将控制权交给用户代码。在执行 <code>sret</code> 指令后，处理器将根据用户上下文中的 <code>sepc</code> 寄存器的值跳转到用户代码的指令地址。返回的同时，处理器还会自动恢复 <code>sstatus</code> 寄存器的值，以确保正确的特权级别和中断状态。</p>
<h3 id="userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？"><a href="#userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？" class="headerlink" title="userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？"></a><code>userret</code>：中发生状态切换在哪一条指令？为何执行之后会进入用户态？</h3><p>在<code>userret</code>函数中，发生状态切换的指令是<code>sret</code>指令。 </p>
<p><code>sret</code>指令用于从内核模式切换到用户模式，并将控制权交给用户代码。执行<code>sret</code>指令后，处理器会根据用户上下文中的<code>sepc</code>寄存器的值跳转到用户代码的指令地址。</p>
<p>执行<code>sret</code>指令之后进入用户态的原因是，该指令会自动恢复<code>sstatus</code>寄存器的值，以确保正确的特权级别和中断状态。当<code>sret</code>指令执行后，处理器将从内核态切换回用户态，程序将继续执行用户代码。这意味着<code>userret</code>函数成功完成了从内核切换到用户模式的过程。</p>
<h3 id="L29：执行之后，a0-和-sscratch-中各是什么值，为什么？"><a href="#L29：执行之后，a0-和-sscratch-中各是什么值，为什么？" class="headerlink" title="L29：执行之后，a0 和 sscratch 中各是什么值，为什么？"></a>L29：执行之后，a0 和 sscratch 中各是什么值，为什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csrrw a0, sscratch, a0     </span><br></pre></td></tr></table></figure>

<p>在执行指令后，<code>a0</code>和<code>sscratch</code>中的值发生了互换。</p>
<p>假设原始<code>a0</code>寄存器中的值为 X，而<code>sscratch</code>寄存器中的值为 Y。执行<code>csrrw a0, sscratch, a0</code>指令后，<code>a0</code>寄存器中的值变为 Y，而<code>sscratch</code>寄存器中的值变为 X。</p>
<p>这是因为<code>csrrw</code>指令是一个特权指令，用于将某个 CSR（Control and Status Register）的值读取到目标寄存器，然后将目标寄存器的值写回到该 CSR 中。在这里，<code>csrrw a0, sscratch, a0</code>指令将<code>sscratch</code>寄存器的值读取到<code>a0</code>寄存器中，同时将<code>a0</code>寄存器中的值写回到<code>sscratch</code>寄存器中，从而实现了两者之间的数据交换。</p>
<h3 id="L32-L61-从-trapframe-第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？"><a href="#L32-L61-从-trapframe-第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？" class="headerlink" title="L32-L61: 从 trapframe 第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？"></a>L32-L61: 从 trapframe 第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sd ra, 40(a0)</span><br><span class="line">sd sp, 48(a0)</span><br><span class="line">...</span><br><span class="line">sd t5, 272(a0)</span><br><span class="line">sd t6, 280(a0)</span><br></pre></td></tr></table></figure>

<h3 id="进入-S-态是哪一条指令发生的？"><a href="#进入-S-态是哪一条指令发生的？" class="headerlink" title="进入 S 态是哪一条指令发生的？"></a>进入 S 态是哪一条指令发生的？</h3><h3 id="L75-L76-ld-t0-16-a0-执行之后，t0中的值是什么，解释该值的由来？"><a href="#L75-L76-ld-t0-16-a0-执行之后，t0中的值是什么，解释该值的由来？" class="headerlink" title="L75-L76: ld t0, 16(a0) 执行之后，t0中的值是什么，解释该值的由来？"></a>L75-L76: <code>ld t0, 16(a0)</code> 执行之后，<code>t0</code>中的值是什么，解释该值的由来？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld t0, 16(a0)</span><br><span class="line">jr t0</span><br></pre></td></tr></table></figure>

<p><code>ld t0, 16(a0)</code>就是从 <code>trapframe</code> 中恢复 <code>t0</code>寄存器值，<code>t0</code>保存了<code>kernel_trap</code>的入口地址。使用 <code>jr t0</code>，就跳转到了我们早先设定在 <code>trapframe-&gt;kernel_trap</code> 中的地址，也就是 <code>trap.c</code> 之中的 <code>usertrap</code> 函数。这个函数在 <code>main</code> 的初始化之中已经调用了。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/Linux/">#Linux</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/RISC-V/">#RISC-V</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/OS/">#OS</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/uCore/">#uCore</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/Lab/">#Lab</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="../../04/uCore-%E5%AE%9E%E9%AA%8C%E7%AC%AC4%E7%AB%A0-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/">uCore 实验第 4 章 - 地址空间</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="../../01/yq%E4%B8%BAyaml%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%8E%92%E5%BA%8F/">yq 为 yaml 文件内容排序</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>




<script src="../../../../js/script.js"></script>


    
</body>
</html>