<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8888&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>一生一芯笔记 | PaperMod</title>
<meta name="keywords" content="">
<meta name="description" content="一生一芯概述 “一生一芯”概述 _哔哩哔哩_bilibili
程序的执行和模拟器 freestanding 运行时环境 程序如何结束运行 在正常的环境中，写了一段代码return之后，实际上调用了一个系统调用exit。但是在 freestanding 环境中，没有操作系统支持，根据 C99 手册规定，在 freestanding 环境中结束运行是由用户实现决定的。
5.1.2.1 Freestanding environment 2 The effect of program termination in a freestanding environment is implementation-defined. 在 qemu-system-riscv64 中的 virt 机器模型中，往一个特殊的地址写入一个特殊的“暗号”即可结束 QEMU
#include &lt;stdint.h&gt; void _start() { volatile uint8_t *p = (uint8_t *)(uintptr_t)0x10000000; *p = &#39;A&#39;; volatile uint32_t *exit = (uint32_t *)(uintptr_t)0x100000; *exit = 0x5555; // magic number _start(); // 递归调用，如果正常退出将不会再次打印A } 在自制 freestanding 运行时环境上运行 Hello 程序 QEMU 虽然是个开源项目，但还挺复杂，不利于我们理解细节。让我们来设计一个面向 RISC-V 程序的简单 freestanding 运行时环境，我做以下约定。">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:8888/posts/%E4%B8%80%E7%94%9F%E4%B8%80%E8%8A%AF%E7%AC%94%E8%AE%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:8888/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:8888/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:8888/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:8888/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:8888/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:8888/posts/%E4%B8%80%E7%94%9F%E4%B8%80%E8%8A%AF%E7%AC%94%E8%AE%B0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:8888/" accesskey="h" title="PaperMod (Alt + H)">PaperMod</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:8888/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:8888/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:8888/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      一生一芯笔记
    </h1>
    <div class="post-meta"><span title='2023-03-12 12:58:15 +0000 UTC'>March 12, 2023</span>&nbsp;·&nbsp;7 min

</div>
  </header> 
  <div class="post-content"><h1 id="一生一芯概述">一生一芯概述<a hidden class="anchor" aria-hidden="true" href="#一生一芯概述">#</a></h1>
<p><a href="https://www.bilibili.com/video/BV12e4y1Y76i/?spm_id_from=333.788&amp;vd_source=7ff88341de4b5111bdf3db48b4e9ca44">“一生一芯”概述 _哔哩哔哩_bilibili</a></p>
<h1 id="程序的执行和模拟器">程序的执行和模拟器<a hidden class="anchor" aria-hidden="true" href="#程序的执行和模拟器">#</a></h1>
<h2 id="freestanding-运行时环境">freestanding 运行时环境<a hidden class="anchor" aria-hidden="true" href="#freestanding-运行时环境">#</a></h2>
<h3 id="程序如何结束运行">程序如何结束运行<a hidden class="anchor" aria-hidden="true" href="#程序如何结束运行">#</a></h3>
<p>在正常的环境中，写了一段代码<code>return</code>之后，实际上调用了一个系统调用<code>exit</code>。但是在 freestanding 环境中，没有操作系统支持，根据 C99 手册规定，在 freestanding 环境中结束运行是由用户实现决定的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>5.1.2.1 Freestanding environment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2 The effect of program termination in a freestanding environment is
</span></span><span style="display:flex;"><span>implementation-defined.
</span></span></code></pre></div><p>在 qemu-system-riscv64 中的 virt 机器模型中，往一个特殊的地址写入一个特殊的“暗号”即可结束 QEMU</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_start</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">uintptr_t</span>)<span style="color:#ae81ff">0x10000000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>exit <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">uintptr_t</span>)<span style="color:#ae81ff">0x100000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>exit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555</span>;   <span style="color:#75715e">// magic number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">_start</span>();         <span style="color:#75715e">// 递归调用，如果正常退出将不会再次打印A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="在自制-freestanding-运行时环境上运行-hello-程序">在自制 freestanding 运行时环境上运行 Hello 程序<a hidden class="anchor" aria-hidden="true" href="#在自制-freestanding-运行时环境上运行-hello-程序">#</a></h3>
<p>QEMU 虽然是个开源项目，但还挺复杂，不利于我们理解细节。让我们来设计一个面向 RISC-V 程序的简单 freestanding 运行时环境，我做以下约定。</p>
<ul>
<li>程序从地址 0 开始执行</li>
<li>只支持两条指令
<ul>
<li>addi 指令</li>
<li>ebreak 指令
<ul>
<li>寄存器 a0=0 时，输出寄存器 a1 低 8 位的字符</li>
<li>寄存器 a0=1 时，结束运行
<ul>
<li>ABI Mnemonic（RISC-V 官方为每个寄存器起个名字）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ebreak</span>(<span style="color:#66d9ef">long</span> arg0, <span style="color:#66d9ef">long</span> arg1) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;addi a0, x0, %0;&#34;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#e6db74">&#34;addi a1, x0, %1;&#34;</span>
</span></span><span style="display:flex;"><span>               <span style="color:#e6db74">&#34;ebreak&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;i&#34;</span>(arg0), <span style="color:#e6db74">&#34;i&#34;</span>(arg1));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">putch</span>(<span style="color:#66d9ef">char</span> ch) { <span style="color:#a6e22e">ebreak</span>(<span style="color:#ae81ff">0</span>, ch); }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">halt</span>(<span style="color:#66d9ef">int</span> code) { <span style="color:#a6e22e">ebreak</span>(<span style="color:#ae81ff">1</span>, code); <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_start</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">putch</span>(<span style="color:#e6db74">&#39;A&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">halt</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/** 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 这段代码定义了三个函数：ebreak、putch 和 halt。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ebreak 函数是一个内联汇编函数，它执行 ebreak 指令。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 该指令是 RISC-V 架构中的一条调试指令，可以在调试器的控制下执行。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 该函数接受两个参数 arg0 和 arg1，它们将被存储在寄存器 a0 和 a1 中。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * putch 函数调用了 ebreak 函数，并将第一个参数设为 0，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 第二个参数设为函数参数 ch。这样做的目的可能是为了在调试器的控制下输出一个字符。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * halt 函数调用了 ebreak 函数，并将第一个参数设为 1，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 第二个参数设为函数参数 code。这样做的目的可能是为了通知调试器程序已经结束，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 并使用 code 作为结束状态。然后，halt 函数进入一个死循环，等待调试器的操作。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 最后，_start 函数调用了 putch 函数输出字符 &#39;A&#39;，然后调用 halt 函数结束程序 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>riscv64-linux-gnu-gcc -march<span style="color:#f92672">=</span>rv64g -ffreestanding -nostdlib -static -Wl,-Ttext<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -O2 -o prog a.c
</span></span></code></pre></div><ul>
<li>
<p>riscv64-linux-gnu-gcc: 这是 GCC 的可执行文件的名称，表示使用的是 GCC 编译器。riscv64-linux-gnu 是编译器的目标平台，表示生成的代码是针对 RISC-V 架构，运行在 Linux 系统上的二进制文件。</p>
</li>
<li>
<p>-march=rv64g: 这个参数指定了编译器使用的指令集。rv64g 表示使用 RISC-V 架构的 64 位指令集。</p>
</li>
<li>
<p>-ffreestanding: 这个参数指示编译器生成的代码将在 freestanding 运行环境中运行。在 freestanding 运行环境中，程序不会自动链接标准 C 库，也不会自动调用 main 函数。</p>
</li>
<li>
<p>-nostdlib: 这个参数表示编译器不需要链接标准 C 库。</p>
</li>
<li>
<p>-static: 这个参数表示生成的代码是静态链接的。</p>
</li>
<li>
<p>-Wl,-Ttext=0: 这个参数是传递给链接器的，表示设置代码段的起始地址为 0。</p>
</li>
<li>
<p>-O2: 这个参数指示编译器使用优化级别为 2 的优化选项。</p>
</li>
<li>
<p>-o prog: 这个参数指定生成的可执行文件的名称为 prog。</p>
</li>
<li>
<p>a.c: 这是要编译的 C 源文件的名称。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>llvm-objdump -d prog
</span></span></code></pre></div><p>反汇编结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>prog:   <span style="color:#a6e22e">file</span> <span style="color:#66d9ef">format</span> <span style="color:#66d9ef">elf64-littleriscv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Disassembly</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">section</span> <span style="color:#66d9ef">.text</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0000000000000000</span> <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">_start</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">0:</span> <span style="color:#960050;background-color:#1e0010">13</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">li</span>      <span style="color:#66d9ef">a0</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">4:</span> <span style="color:#960050;background-color:#1e0010">93</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">04</span>   <span style="color:#a6e22e">li</span>      <span style="color:#66d9ef">a1</span>, <span style="color:#ae81ff">65</span>
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">8:</span> <span style="color:#960050;background-color:#1e0010">73</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">ebreak</span>
</span></span><span style="display:flex;"><span>       c: <span style="color:#960050;background-color:#1e0010">13</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">li</span>      <span style="color:#66d9ef">a0</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">10:</span> <span style="color:#960050;background-color:#1e0010">93</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">li</span>      <span style="color:#66d9ef">a1</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">14:</span> <span style="color:#960050;background-color:#1e0010">73</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">ebreak</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">18:</span> <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>   <span style="color:#66d9ef">j</span>       <span style="color:#ae81ff">0x18</span> &lt;<span style="color:#66d9ef">_start</span>+<span style="color:#ae81ff">0x18</span>&gt;
</span></span></code></pre></div><p>我们约定中没有<code>li</code>指令，但是汇编中却出现了，这是因为<code>li</code>是一条伪指令，它的实际实现依然是<code>addi</code>。如果不使用伪指令可以使用以下命令反汇编：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>llvm-objdump -M no-aliases -d prog
</span></span></code></pre></div><p>结果如下，没有伪指令，只有我们约定的几条指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>prog:   <span style="color:#a6e22e">file</span> <span style="color:#66d9ef">format</span> <span style="color:#66d9ef">elf64-littleriscv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Disassembly</span> <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">section</span> <span style="color:#66d9ef">.text</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0000000000000000</span> <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">_start</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">0:</span> <span style="color:#960050;background-color:#1e0010">13</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">addi</span>    <span style="color:#66d9ef">a0</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">4:</span> <span style="color:#960050;background-color:#1e0010">93</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">04</span>   <span style="color:#a6e22e">addi</span>    <span style="color:#66d9ef">a1</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">65</span>
</span></span><span style="display:flex;"><span>       <span style="color:#960050;background-color:#1e0010">8:</span> <span style="color:#960050;background-color:#1e0010">73</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">ebreak</span>
</span></span><span style="display:flex;"><span>       c: <span style="color:#960050;background-color:#1e0010">13</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">addi</span>    <span style="color:#66d9ef">a0</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">10:</span> <span style="color:#960050;background-color:#1e0010">93</span> <span style="color:#960050;background-color:#1e0010">05</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">addi</span>    <span style="color:#66d9ef">a1</span>, <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">14:</span> <span style="color:#960050;background-color:#1e0010">73</span> <span style="color:#960050;background-color:#1e0010">00</span> <span style="color:#960050;background-color:#1e0010">10</span> <span style="color:#960050;background-color:#1e0010">00</span>   <span style="color:#a6e22e">ebreak</span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">18:</span> <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>   <span style="color:#66d9ef">jal</span>     <span style="color:#66d9ef">zero</span>, <span style="color:#ae81ff">0x18</span> &lt;<span style="color:#66d9ef">_start</span>+<span style="color:#ae81ff">0x18</span>&gt;
</span></span></code></pre></div><h2 id="yemu-指令如何执行">YEMU 指令如何执行<a hidden class="anchor" aria-hidden="true" href="#yemu-指令如何执行">#</a></h2>
<p>ISA 手册定义了一个状态机。</p>
<ul>
<li>
<p>状态集合 S = {&lt;R, M&gt;}</p>
<ul>
<li>R = {PC, x0, x1, x2, &hellip;}
<ul>
<li>RISC-V 手册 -&gt; 2.1 Programmers’Model for Base Integer ISA</li>
<li>PC = 程序计数器 = 当前执行的指令位置</li>
</ul>
</li>
<li>M = 内存
<ul>
<li>RISC-V 手册 -&gt; 1.4 Memory</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>激励事件：执行 PC 指向的指令
状态转移规则：指令的语义 (semantics)
初始状态 S0 = &lt;R0, M0&gt;</p>
<p>我们只要把这个状态机实现出来，就可以用它来执行指令了！</p>
<h3 id="用变量实现内存">用变量实现内存<a hidden class="anchor" aria-hidden="true" href="#用变量实现内存">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">uint64_t</span> R[<span style="color:#ae81ff">32</span>], PC; <span style="color:#75715e">// according to the RISC-V manual
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">uint8_t</span> M[<span style="color:#ae81ff">64</span>];      <span style="color:#75715e">// 64-Byte memory
</span></span></span></code></pre></div><p>Q: 为什么不使用 <code>int64_t</code> 和 <code>int8_t</code>?</p>
<p>A: C语言标准规定, 有符号数溢出是undefined behavior, 但无符号数不会溢出</p>
<blockquote>
<p>6.5 Expressions
5 If an exceptional condition occurs during the evaluation of an expression (that is,
if the result is not mathematically defined or not in the range of representable
values for its type), the behavior is undefined.
6.2.5 Types
9 A computation involving unsigned operands can never overflow, because a result that
cannot be represented by the resulting unsigned integer type is reduced modulo the
number that is one greater than the largest value that can be represented by the
resulting type.</p>
</blockquote>
<h3 id="用语句实现指令的语义">用语句实现指令的语义<a hidden class="anchor" aria-hidden="true" href="#用语句实现指令的语义">#</a></h3>
<p>指令周期 (instruction cycle): 执行一条指令的步骤</p>
<ul>
<li>取指 (fetch): 从 PC 所指示的内存位置读取一条指令</li>
<li>译码 (decode): 按照手册解析指令的操作码 (opcode) 和操作数 (operand)</li>
<li>执行 (execute): 按解析出的操作码，对操作数进行处理</li>
<li>更新 PC: 让 PC 指向下一条指令</li>
</ul>
<p>状态机不断执行指令，直到结束运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> halt <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>halt) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">inst_cycle</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span> 31           20 19 15 14 12 11  7 6       0
</span></span><span style="display:flex;"><span>+---------------+-----+-----+-----+---------+
</span></span><span style="display:flex;"><span>|   imm[11:0]   | rs1 | 000 | rd  | 0010011 |    ADDI
</span></span><span style="display:flex;"><span>+---------------+-----+-----+-----+---------+
</span></span><span style="display:flex;"><span>+---------------+-----+-----+-----+---------+
</span></span><span style="display:flex;"><span>| 000000000001  |00000| 000 |00000| 1110011 |   EBREAK
</span></span><span style="display:flex;"><span>+---------------+-----+-----+-----+---------+
</span></span></code></pre></div><p>一个简单的实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">inst_cycle</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint32_t</span> inst <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">uint32_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>M[PC];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((inst <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7f</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x13</span>) <span style="color:#f92672">&amp;&amp;</span> ((inst <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">// addi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (((inst <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      R[(inst <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>] <span style="color:#f92672">=</span> R[(inst <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">15</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>] <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        (((inst <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">20</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7ff</span>) <span style="color:#f92672">-</span> ((inst <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x80000000</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">4096</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (inst <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x00100073</span>) { <span style="color:#75715e">// ebreak
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (R[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">putchar</span>(R[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>); }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (R[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) { halt <span style="color:#f92672">=</span> true; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> { <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unsupported ebreak command</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> { <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Unsupported instuction</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); }
</span></span><span style="display:flex;"><span>  PC <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="nemu-代码导读">NEMU 代码导读<a hidden class="anchor" aria-hidden="true" href="#nemu-代码导读">#</a></h1>
<h2 id="make-项目构">make 项目构<a hidden class="anchor" aria-hidden="true" href="#make-项目构">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 显示make踪迹</span>
</span></span><span style="display:flex;"><span>strace make
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示构建过程</span>
</span></span><span style="display:flex;"><span>make -d
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示更详细的构建构过程</span>
</span></span><span style="display:flex;"><span>make --debug<span style="color:#f92672">=</span>v
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Reading makefiles...
</span></span><span style="display:flex;"><span>Reading makefile `Makefile&#39;...
</span></span><span style="display:flex;"><span>Updating goal targets....
</span></span><span style="display:flex;"><span> File `all&#39; does not exist.
</span></span><span style="display:flex;"><span>   File `all&#39; does not exist.
</span></span><span style="display:flex;"><span>   Looking for an implicit rule for `all&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.c&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.cc&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.C&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.cpp&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.CPP&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.cxx&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.CXX&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.c++&#39;.
</span></span><span style="display:flex;"><span>   Trying pattern rule with stem `all&#39;.
</span></span><span style="display:flex;"><span>   Trying implicit prerequisite `all.C++&#39;.
</span></span><span style="display:flex;"><span>   No implicit rule found for `all&#39;.
</span></span><span style="display:flex;"><span>   Finished prerequisites of target file `all&#39;.
</span></span><span style="display:flex;"><span> Must remake target `all&#39;.
</span></span><span style="display:flex;"><span>gcc -o all all.o
</span></span><span style="display:flex;"><span>Finished prerequisites of target file `all&#39;.
</span></span><span style="display:flex;"><span>Must remake target `all&#39;.
</span></span><span style="display:flex;"><span>gcc -o all all.o
</span></span><span style="display:flex;"><span>Successfully remade target file `all&#39;.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 只打印命令不执行</span>
</span></span><span style="display:flex;"><span>make -n
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输出目标被构建的原因和执行的命令</span>
</span></span><span style="display:flex;"><span>make --trace
</span></span></code></pre></div><p>例如，如果您有一个 makefile，其目标 <code>all</code> 依赖于目标 <code>foo</code> 和 <code>bar</code>，并且您运行 <code>make --trace all</code>，您可能会看到如下输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Entering directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span><span style="display:flex;"><span>gcc -o foo foo.c
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Leaving directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Entering directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span><span style="display:flex;"><span>gcc -o bar bar.c
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Leaving directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Entering directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span><span style="display:flex;"><span>gcc -o all foo.o bar.o
</span></span><span style="display:flex;"><span>make<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Leaving directory <span style="color:#e6db74">&#39;/path/to/project&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make -nB  <span style="color:#75715e"># -B 可以强制 make 构建所有目标，即使它们已经是最新的</span>
</span></span><span style="display:flex;"><span>make -nB | vim -
</span></span></code></pre></div><p>在 vim 编辑器中进行二次处理，过滤不需要的信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 只保留 gcc 或 g++开头的行</span>
</span></span><span style="display:flex;"><span>:%!grep <span style="color:#e6db74">&#34;^\(gcc\|g++\)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将环境变量$NEMU_HOME 所指示字符串替换为$NEMU_HOME</span>
</span></span><span style="display:flex;"><span>:%!sed -e <span style="color:#e6db74">&#34;s+</span>$NEMU_HOME<span style="color:#e6db74">+\$NEMU_HOME+g&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将$NEMU_HOME/build/obj-riscv64-nemu-interpreter 替换为$OBJ_DIR</span>
</span></span><span style="display:flex;"><span>:%s+<span style="color:#ae81ff">\$</span>NEMU_HOME/build/obj-riscv64-nemu-interpreter+$OBJ_DIR+g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将-c 之前的内容替换为$CFLAGS</span>
</span></span><span style="display:flex;"><span>:%s/-O2.*<span style="color:#f92672">=</span>riscv64/$CFLAGS/g
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将最后一行的空格替换成换行并缩进两格</span>
</span></span><span style="display:flex;"><span>:$s/  */<span style="color:#ae81ff">\r</span>  /g
</span></span></code></pre></div><h1 id="调试技巧选将">调试技巧选将<a hidden class="anchor" aria-hidden="true" href="#调试技巧选将">#</a></h1>
<h2 id="断言">断言<a hidden class="anchor" aria-hidden="true" href="#断言">#</a></h2>
<p>在 C 程序中使用断言（assert）不会增加额外的内存空间，也不会增加数据段空间。断言是一种在运行时检查程序假设是否为真的方法，当断言失败时，程序会终止执行并显示错误信息。</p>
<p>在 C 语言中，断言通常使用宏来实现。它在编译时被解释为一个简单的条件语句，因此它不会增加程序的内存空间或数据段空间。断言宏的定义通常类似于以下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;assert.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define assert(expression) ((void)0)
</span></span></span></code></pre></div><p>这里的 expression 是要检查的条件。如果 <code>expression</code> 为假，则 <code>assert()</code> 函数会发出错误消息并终止程序的执行。如果 <code>expression</code> 为真，则 <code>assert()</code> 函数不会产生任何操作，并且被解释为 <code>((void)0)</code>。这个语句不会增加任何内存或数据段空间。</p>
<p>需要注意的是，当一个程序使用大量的断言时，它可能会对程序的性能产生一些影响，因为每个断言都需要在运行时进行检查。因此，在生产环境中，应该尽可能减少使用断言，并在测试和调试阶段使用它们来确保代码的正
确性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// nemu/src/isa/riscv64/local-include/reg.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check_reg_idx</span>(<span style="color:#66d9ef">int</span> idx) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">IFDEF</span>(CONFIG_RT_CHECK, <span style="color:#a6e22e">assert</span>(idx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> idx;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="编译器工具-sanitizer">编译器工具 sanitizer<a hidden class="anchor" aria-hidden="true" href="#编译器工具-sanitizer">#</a></h2>
<p>让编译器自动插入 assert, 拦截常见的非预期行为</p>
<ul>
<li>AddressSanitizer - 检查指针越界，use-after-free</li>
<li>ThreadSanitizer - 检查多线程数据竞争</li>
<li>LeakSanitizer - 检查内存泄漏</li>
<li>UndefinedBehaviorSanitizer - 检查 UB</li>
<li>还能检查指针的比较和相减</li>
</ul>
<p>打开后程序运行效率有所下降</p>
<ul>
<li>但调试的时候非常值得，躺着就能让工具帮你找 bug</li>
<li>man gcc 查看具体用法</li>
</ul>
<h3 id="使用方法">使用方法<a hidden class="anchor" aria-hidden="true" href="#使用方法">#</a></h3>
<p>GCC 提供了多种 Sanitizer 工具，可以帮助开发者在编译时检测和修复常见的编程错误，例如内存泄漏、缓冲区溢出、使用未初始化的变量等。以下是几个 Sanitizer 工具的示例用法：</p>
<ol>
<li>
<p>Address Sanitizer（ASAN）：检测内存错误，例如使用已经释放的内存、堆栈和全局缓冲区的溢出和下溢等。</p>
<pre tabindex="0"><code>gcc -fsanitize=address -g &lt;source files&gt; -o &lt;output file&gt;
</code></pre></li>
<li>
<p>Undefined Behavior Sanitizer（UBSAN）：检测未定义行为，例如除以零、使用未初始化的变量、指针溢出等。</p>
<pre tabindex="0"><code>gcc -fsanitize=undefined -g &lt;source files&gt; -o &lt;output file&gt;
</code></pre></li>
<li>
<p>Thread Sanitizer（TSAN）：检测并发问题，例如竞争条件、死锁等。</p>
<pre tabindex="0"><code>gcc -fsanitize=thread -g &lt;source files&gt; -o &lt;output file&gt;
</code></pre></li>
<li>
<p>Memory Sanitizer（MSAN）：检测使用未初始化的内存，例如读取未初始化的内存、使用已释放的内存等。</p>
<pre tabindex="0"><code>gcc -fsanitize=memory -g &lt;source files&gt; -o &lt;output file&gt;
</code></pre></li>
</ol>
<p>需要注意的是，Sanitizer 工具可能会增加程序的执行时间和内存消耗，并且可能会产生误报，因此在生产环境中应该禁用 Sanitizer 工具。通常情况下，开发者可以在开发和测试阶段启用 Sanitizer 工具，以帮助他们发现和修复代码中的问题。</p>
<h2 id="自顶向下理解程序行为">自顶向下理解程序行为<a hidden class="anchor" aria-hidden="true" href="#自顶向下理解程序行为">#</a></h2>
<pre><code>ftrace - 函数调用层次，理解程序的大体行为
itrace - 指令执行层次，理解指令级别的行为
mtrace - 访存的踪迹
dtrace - 设备访问的踪迹
sdb - 灵活细致地检查客户程序的状态
si - 细粒度的状态转移
info r/x - 检查R/M
监视点 - 捕捉某状态发生变化的时刻
</code></pre>
<p>sdb 与 gdb 结合使用</p>
<pre><code>先用 sdb 定位到出错点附近
再用 gdb 观察 NEMU 的细节行为
</code></pre>
<h2 id="程序的运行时间都花在了哪里">程序的运行时间都花在了哪里<a hidden class="anchor" aria-hidden="true" href="#程序的运行时间都花在了哪里">#</a></h2>
<p>Linux 的性能分析工具 perf 是一款功能强大的性能分析工具，它可以通过硬件计数器（Hardware counter）或者性能事件（Performance event）来对 Linux 系统的性能进行分析。以下是 perf 工具的安装和使用方法。</p>
<h3 id="安装-perf-工具">安装 perf 工具<a hidden class="anchor" aria-hidden="true" href="#安装-perf-工具">#</a></h3>
<p>在大部分 Linux 发行版中，perf 工具已经预先安装，如果没有预先安装，可以通过以下命令进行安装。</p>
<ul>
<li>Debian/Ubuntu 系统：<code>sudo apt-get install linux-tools-common linux-tools-generic</code></li>
<li>Fedora 系统：<code>sudo dnf install perf</code></li>
<li>CentOS/RHEL 系统：<code>sudo yum install perf</code></li>
</ul>
<p>安装完毕之后，可以通过 <code>perf version</code> 命令来检查 perf 版本信息。</p>
<h3 id="编写一个简单的-c-代码">编写一个简单的 C 代码<a hidden class="anchor" aria-hidden="true" href="#编写一个简单的-c-代码">#</a></h3>
<p>这里我们编写一个简单的 C 代码，用于测试 perf 工具的使用。代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i, sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1000000</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>        sum <span style="color:#f92672">+=</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;sum = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, sum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>代码的作用是计算 1 到 1000000 的和。</p>
<h3 id="使用-perf-工具">使用 perf 工具<a hidden class="anchor" aria-hidden="true" href="#使用-perf-工具">#</a></h3>
<p>下面我们使用 perf 工具来对上述代码进行性能分析。假设代码保存在文件 test.c 中。</p>
<p>统计 CPU 周期数
以下命令用于统计程序的 CPU 周期数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>perf stat ./test
</span></span></code></pre></div><p>输出结果类似于：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> Performance counter stats <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;./test&#39;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>           19,23 msec task-clock:u              <span style="color:#75715e">#    0.988 CPUs utilized          </span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">0</span>      context-switches:u        <span style="color:#75715e">#    0.000 K/sec                  </span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">0</span>      cpu-migrations:u          <span style="color:#75715e">#    0.000 K/sec                  </span>
</span></span><span style="display:flex;"><span>               <span style="color:#ae81ff">575</span>      page-faults:u             <span style="color:#75715e">#    0.030 M/sec                  </span>
</span></span><span style="display:flex;"><span>    64,013,620,231      cycles:u                  <span style="color:#75715e">#    3.324 GHz                      (49.80%)</span>
</span></span><span style="display:flex;"><span>    40,010,335,480      instructions:u            <span style="color:#75715e">#    0.62  insn per cycle           (62.34%)</span>
</span></span><span style="display:flex;"><span>     9,998,469,566      branches:u                <span style="color:#75715e">#  518.693 M/sec                    (62.27%)</span>
</span></span><span style="display:flex;"><span>           763,176      branch-misses:u           <span style="color:#75715e">#    0.01% of all branches          (62.32%)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      0.019438122 seconds time elapsed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      0.019411000 seconds user
</span></span><span style="display:flex;"><span>      0.000007000 seconds sys
</span></span></code></pre></div><p>输出结果中的 cycles 表示 CPU 周期数，instructions 表示指令数，branches 表示分支指令数。其中，cycles 和 instructions 的比例代表了 CPU 的效率，即 IPC（Instructions Per Cycle）。</p>
<h3 id="统计函数调用次数">统计函数调用次数<a hidden class="anchor" aria-hidden="true" href="#统计函数调用次数">#</a></h3>
<p>以下命令用于统计程序中函数的调用次数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>perf record -e cycles -g ./test
</span></span></code></pre></div><p>这个命令将启动 perf 工具，并使用 -g 选项记录调用关系图。我们还需要使用 sudo 权限运行该命令，以便 perf 工具可以访问系统的硬件计数器。</p>
<h2 id="成为专业码农">成为专业码农<a hidden class="anchor" aria-hidden="true" href="#成为专业码农">#</a></h2>
<ul>
<li>要熟悉项目了 -&gt; STFW/RTFM/RTFSC, 尝试理解一切细节</li>
<li>要写代码了
<ul>
<li>仔细 RTFM, 正确理解需求</li>
<li>编写可读，可维护，易验证的代码 (不言自明，不言自证)</li>
<li>用 lint 工具检查代码</li>
<li>进行充分的测试</li>
<li>添加充分的断言</li>
</ul>
</li>
<li>要调试了
<ul>
<li>默念“机器永远是对的/未测试代码永远是错的”</li>
<li>sanitizer, trace, printf, gdb, …</li>
</ul>
</li>
<li>平时 -&gt; 用正确的工具/方法做事情</li>
<li>感到不爽了 -&gt; 找正确的工具/搭基础设施</li>
</ul>
<h1 id="总线选讲">总线选讲<a hidden class="anchor" aria-hidden="true" href="#总线选讲">#</a></h1>
<h2 id="定义">定义<a hidden class="anchor" aria-hidden="true" href="#定义">#</a></h2>
<p>广义上讲总线就是一个通信系统，以下这些都属于广义的总线概念:TCP/IP, 以太网，网线，RTL 信号，系统调用。</p>
<p>主动发起通信的叫 master，响应通信的叫 slave。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:8888/posts/wsl2%E5%AE%89%E8%A3%85docker/">
    <span class="title">« Prev</span>
    <br>
    <span>WSL2 安装 Docker</span>
  </a>
  <a class="next" href="http://localhost:8888/posts/java%E5%B0%8F%E7%99%BD%E7%AC%94%E8%AE%B0/">
    <span class="title">Next »</span>
    <br>
    <span>JAVA 小白笔记</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on x"
            href="https://x.com/intent/tweet/?text=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f&amp;title=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0&amp;summary=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0&amp;source=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f&title=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0%20-%20http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on telegram"
            href="https://telegram.me/share/url?text=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 一生一芯笔记 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e4%b8%80%e7%94%9f%e4%b8%80%e8%8a%af%e7%ac%94%e8%ae%b0&u=http%3a%2f%2flocalhost%3a8888%2fposts%2f%25E4%25B8%2580%25E7%2594%259F%25E4%25B8%2580%25E8%258A%25AF%25E7%25AC%2594%25E8%25AE%25B0%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:8888/">PaperMod</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
