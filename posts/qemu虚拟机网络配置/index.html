<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8888&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>QEMU 虚拟机网络配置 | PaperMod</title>
<meta name="keywords" content="QEMU, 虚拟机, 网络配置">
<meta name="description" content="Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡：
# 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y 配置脚本 qemu-ifup 将下面的脚本保存为文件 qemu-ifup，并赋予可执行权限：
为了方便复制脚本，在 confluence 页面提供了脚本内容，可以直接复制。
mkdir -p /etc/qemu mv qemu-ifup /etc/qemu &amp;&amp; mv qemu-ifdown /etc/qemu sudo chmod &#43;x qemu-ifup sudo chmod &#43;x qemu-ifdown 因为网卡信息不容易定位，可能一台机器有多个网卡，所以不方便用脚本获取，需要手动设置一下。将下面的NIC值修改为宿主机可以上网的网卡名称。可以通过ifconfig命令查看。
#!/bin/bash # 设置默认网卡信息 NIC=enp2s0 # 设置用户名 USER_NAME=user # 设置网桥名称 BRIDGE=br0 # 设置网络信息 NIC_IP=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $2}&#39;) NIC_NETMAST=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $4}&#39;) NIC_BROADCAST=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $6}&#39;) NETMASK=255.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:8888/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:8888/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:8888/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:8888/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:8888/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:8888/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:8888/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:8888/" accesskey="h" title="PaperMod (Alt + H)">PaperMod</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:8888/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:8888/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:8888/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      QEMU 虚拟机网络配置
    </h1>
    <div class="post-meta"><span title='2023-08-05 14:47:54 +0000 UTC'>August 5, 2023</span>&nbsp;·&nbsp;14 min

</div>
  </header> 
  <div class="post-content"><h1 id="quick-setup">Quick Setup<a hidden class="anchor" aria-hidden="true" href="#quick-setup">#</a></h1>
<h2 id="安装工具">安装工具<a hidden class="anchor" aria-hidden="true" href="#安装工具">#</a></h2>
<p>安装两个网络管理工具用于建立网桥以及虚拟网卡：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 安装虚拟网桥工具</span>
</span></span><span style="display:flex;"><span>sudo apt install bridge-utils -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># UML（User-mode linux）工具        </span>
</span></span><span style="display:flex;"><span>sudo apt install uml-utilities  -y   
</span></span></code></pre></div><h2 id="配置脚本">配置脚本<a hidden class="anchor" aria-hidden="true" href="#配置脚本">#</a></h2>
<h3 id="qemu-ifup">qemu-ifup<a hidden class="anchor" aria-hidden="true" href="#qemu-ifup">#</a></h3>
<p>将下面的脚本保存为文件 <code>qemu-ifup</code>，并赋予可执行权限：</p>
<blockquote>
<p>为了方便复制脚本，在 confluence 页面提供了脚本内容，可以直接复制。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /etc/qemu
</span></span><span style="display:flex;"><span>mv qemu-ifup /etc/qemu <span style="color:#f92672">&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span style="display:flex;"><span>sudo chmod +x qemu-ifup
</span></span><span style="display:flex;"><span>sudo chmod +x qemu-ifdown
</span></span></code></pre></div><p>因为网卡信息不容易定位，可能一台机器有多个网卡，所以不方便用脚本获取，需要手动设置一下。将下面的<code>NIC</code>值修改为宿主机可以上网的网卡名称。可以通过<code>ifconfig</code>命令查看。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># 设置默认网卡信息</span>
</span></span><span style="display:flex;"><span>NIC<span style="color:#f92672">=</span>enp2s0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置用户名</span>
</span></span><span style="display:flex;"><span>USER_NAME<span style="color:#f92672">=</span>user
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置网桥名称</span>
</span></span><span style="display:flex;"><span>BRIDGE<span style="color:#f92672">=</span>br0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置网络信息</span>
</span></span><span style="display:flex;"><span>NIC_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ifconfig $NIC | grep <span style="color:#e6db74">&#34;inet\b&#34;</span> | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NIC_NETMAST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ifconfig $NIC | grep <span style="color:#e6db74">&#34;inet\b&#34;</span> | awk <span style="color:#e6db74">&#39;{print $4}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NIC_BROADCAST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ifconfig $NIC | grep <span style="color:#e6db74">&#34;inet\b&#34;</span> | awk <span style="color:#e6db74">&#39;{print $6}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NETMASK<span style="color:#f92672">=</span>255.255.240.0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置默认网关地址</span>
</span></span><span style="display:flex;"><span>GATEWAY<span style="color:#f92672">=</span>10.12.192.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取宿主机网卡MAC地址，因为创建的网桥MAC地址是随机的，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 无法接入公司，需要从开发机网卡将其MAC地址赋值给网桥</span>
</span></span><span style="display:flex;"><span>MAC<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ifconfig $NIC | grep <span style="color:#e6db74">&#34;ether\b&#34;</span> | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查网桥是否已创建，已创建就忽略</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> check_bridge<span style="color:#f92672">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echO <span style="color:#e6db74">&#34;Check bridge...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> brctl show | grep <span style="color:#e6db74">&#34;^</span>$BRIDGE<span style="color:#e6db74">&#34;</span> &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建网桥</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> create_bridge<span style="color:#f92672">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Start Create bridge...&#34;</span>
</span></span><span style="display:flex;"><span>    brctl addbr <span style="color:#e6db74">&#34;</span>$BRIDGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    brctl addif <span style="color:#e6db74">&#34;</span>$BRIDGE<span style="color:#e6db74">&#34;</span>  <span style="color:#e6db74">&#34;</span>$NIC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    ifconfig br0 0.0.0.0 promisc up
</span></span><span style="display:flex;"><span>    dhclient $BRIDGE
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ifconfig &#34;$BRIDGE&#34; &#34;$NIC_IP&#34; netmask &#34;$NIC_NETMAST&#34; broadcast &#34;$NIC_BROADCAST&#34;  hw ether &#34;$MAC&#34; promisc up</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启用IP转发</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> enable_ip_forward<span style="color:#f92672">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#ae81ff">1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置网桥</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> setup_bridge<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    check_bridge <span style="color:#e6db74">&#34;</span>$BRIDGE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $? -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        create_bridge
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    enable_ip_forward
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    setup_bridge
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Creating </span>$1<span style="color:#e6db74">...&#34;</span>
</span></span><span style="display:flex;"><span>    tunctl -t <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> -u <span style="color:#e6db74">&#34;</span>$USER_NAME<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    ifconfig <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> 0.0.0.0 up
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Adding </span>$1<span style="color:#e6db74"> to </span>$BRIDGE<span style="color:#e6db74">...&#34;</span>
</span></span><span style="display:flex;"><span>    brctl addif <span style="color:#e6db74">&#34;</span>$BRIDGE<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    ifconfig <span style="color:#e6db74">&#34;</span>$BRIDGE<span style="color:#e6db74">&#34;</span>  hw ether <span style="color:#e6db74">&#34;</span>$MAC<span style="color:#e6db74">&#34;</span> promisc up
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Error: no interface specified.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><h3 id="qemu-ifdown">qemu-ifdown<a hidden class="anchor" aria-hidden="true" href="#qemu-ifdown">#</a></h3>
<p>以下是<code>qemu-ifdown</code>脚本，用于在关闭 QEMU 时关闭虚拟网卡，将其从网桥中移除，删除虚拟网卡。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># 设置网桥名称</span>
</span></span><span style="display:flex;"><span>BRIDGE<span style="color:#f92672">=</span>br0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将tap设备从网桥中移除</span>
</span></span><span style="display:flex;"><span>	brctl delif <span style="color:#e6db74">${</span>BRIDGE<span style="color:#e6db74">}</span> $1
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># 关闭tap设备</span>
</span></span><span style="display:flex;"><span>	ip link link $1 down
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 删除tap设备</span>
</span></span><span style="display:flex;"><span>    ip link del <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	tunctl -d <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	echo <span style="color:#e6db74">&#34;Error: no interface specified&#34;</span>
</span></span><span style="display:flex;"><span>	exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><p>将系统镜像复制一份并修改文件名，QEMU 不能同时使用一个镜像启动两个虚拟机。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp openEuler-22.09-riscv64-qemu.qcow2 openEuler-22.09-riscv64-qemu-vm1.qcow2
</span></span></code></pre></div><p>需要修改启动脚本中的镜像文件名，以及启动参数，将<code>drive</code>以及<code>cmd</code>变量的内容覆盖为下面的内容，修改<code>mac</code>为分配给自己的虚拟机的 MAC 地址，<code>script</code>为上面的脚本<code>qemu-ifup</code>的路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 该脚本用于启动VM0</span>
</span></span><span style="display:flex;"><span>drive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qemu-system-riscv64 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -nographic -machine virt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -smp &#34;</span>$vcpu<span style="color:#e6db74">&#34; -m &#34;</span>$memory<span style="color:#e6db74">&#34;G \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -bios &#34;</span>$fw<span style="color:#e6db74">&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -drive file=&#34;</span>$drive<span style="color:#e6db74">&#34;,format=qcow2,id=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-vga \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>以<code>sudo</code>权限启动脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ./preview_start_vm0.sh
</span></span></code></pre></div><p>以下为配置 VM1 过程，VM1 的启动脚本与 VM0 的启动脚本类似，只需要修改<code>drive</code>以及<code>MAC</code>，必须保证<code>MAC</code>与 VM0 的<code>MAC</code>不同。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 该脚本用于启动VM1</span>
</span></span><span style="display:flex;"><span>drive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qemu-system-riscv64 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -nographic -machine virt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -smp &#34;</span>$vcpu<span style="color:#e6db74">&#34; -m &#34;</span>$memory<span style="color:#e6db74">&#34;G \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -bios &#34;</span>$fw<span style="color:#e6db74">&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -drive file=&#34;</span>$drive<span style="color:#e6db74">&#34;,format=qcow2,id=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-vga \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-net-device,netdev=tapnet,mac=80:d4:09:62:cd:3c \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><h2 id="网络通信测试">网络通信测试<a hidden class="anchor" aria-hidden="true" href="#网络通信测试">#</a></h2>
<p>当前网络状态如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HOST:10.12.192.177
</span></span><span style="display:flex;"><span>VM0:10.12.193.53
</span></span><span style="display:flex;"><span>VM1:10.12.193.101
</span></span></code></pre></div><h3 id="host----vm0">HOST &ndash;&gt; VM0<a hidden class="anchor" aria-hidden="true" href="#host----vm0">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># user @ ubuntu18 in ~/openeuler/openEuler2209 [18:41:54] </span>
</span></span><span style="display:flex;"><span>$ ping -c <span style="color:#ae81ff">3</span> 10.12.193.101
</span></span><span style="display:flex;"><span>PING 10.12.193.101 <span style="color:#f92672">(</span>10.12.193.101<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.101: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.37 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.101: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.897 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.101: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.890 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 10.12.193.101 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> received, 0% packet loss, time 2002ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.890/1.055/1.378/0.228 ms
</span></span></code></pre></div><p>Host &ndash;&gt; VM1 的测试结果与 Host &ndash;&gt; VM0 的测试结果相同。</p>
<h3 id="vm0----host">VM0 &ndash;&gt; HOST<a hidden class="anchor" aria-hidden="true" href="#vm0----host">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@openEuler-riscv64 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ping -c 3 10.12.193.53 </span>
</span></span><span style="display:flex;"><span>PING 10.12.193.53 <span style="color:#f92672">(</span>10.12.193.53<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.716 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.74 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.81 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 10.12.193.53 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> received, 0% packet loss, time 2009ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM1 &ndash;&gt; Host 的测试结果与 Host &ndash;&gt; VM0 的测试结果相同。</p>
<h3 id="vm1----vm0">VM1 &ndash;&gt; VM0<a hidden class="anchor" aria-hidden="true" href="#vm1----vm0">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@openEuler-riscv64 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ping -c 3 10.12.193.53 </span>
</span></span><span style="display:flex;"><span>PING 10.12.193.53 <span style="color:#f92672">(</span>10.12.193.53<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.716 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.74 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 10.12.193.53: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.81 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- 10.12.193.53 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> received, 0% packet loss, time 2009ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM0 &ndash;&gt; VM1 与 VM1 &ndash;&gt; VM0 的测试结果相同。</p>
<h3 id="vm0----github">VM0 &ndash;&gt; github<a hidden class="anchor" aria-hidden="true" href="#vm0----github">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@openEuler-riscv64 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ping -c 4 github.com</span>
</span></span><span style="display:flex;"><span>PING github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">221</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">277</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">216</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">218</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- github.com ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> packets transmitted, <span style="color:#ae81ff">4</span> received, 0% packet loss, time 3014ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 215.984/232.733/276.593/25.374 ms
</span></span></code></pre></div><h3 id="host----github">HOST &ndash;&gt; github<a hidden class="anchor" aria-hidden="true" href="#host----github">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># user @ ubuntu18 in ~/openeuler/openEuler2209 [17:59:40] </span>
</span></span><span style="display:flex;"><span>$ ping -c <span style="color:#ae81ff">3</span>  github.com
</span></span><span style="display:flex;"><span>PING github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">218</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">216</span> ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from lb-192-30-255-113-sea.github.com <span style="color:#f92672">(</span>192.30.255.113<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">46</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">216</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- github.com ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> packets transmitted, <span style="color:#ae81ff">3</span> received, 0% packet loss, time 2002ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 216.252/217.087/218.409/0.945 ms
</span></span></code></pre></div><h1 id="原理探究-ongoing">原理探究 (Ongoing)<a hidden class="anchor" aria-hidden="true" href="#原理探究-ongoing">#</a></h1>
<h2 id="step-by-step-解析">Step by Step 解析<a hidden class="anchor" aria-hidden="true" href="#step-by-step-解析">#</a></h2>
<p>查看一下网络接口信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig
</span></span><span style="display:flex;"><span>enp3s0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span style="display:flex;"><span>        inet6 fe80::a00:27ff:fe32:e709  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 08:00:27:32:e7:09  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">6017</span>  bytes <span style="color:#ae81ff">5412928</span> <span style="color:#f92672">(</span>5.4 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">1979</span>  bytes <span style="color:#ae81ff">179467</span> <span style="color:#f92672">(</span>179.4 KB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>lo: flags<span style="color:#f92672">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span style="display:flex;"><span>        inet6 ::1  prefixlen <span style="color:#ae81ff">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span style="display:flex;"><span>        loop  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Local Loopback<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">125</span>  bytes <span style="color:#ae81ff">10142</span> <span style="color:#f92672">(</span>10.1 KB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">125</span>  bytes <span style="color:#ae81ff">10142</span> <span style="color:#f92672">(</span>10.1 KB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>创建一个名为<code>br0</code>的网桥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo brctl addbr br0
</span></span></code></pre></div><p>将网桥与宿主机的网卡绑定</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo brctl addif br0 enp3s0
</span></span></code></pre></div><p>启用 <code>br0</code> 接口，并从 DHCP 服务器获得 IP 地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ifconfig br0 0.0.0.0 promisc up
</span></span><span style="display:flex;"><span>sudo dhclient br0
</span></span></code></pre></div><p>查看虚拟网桥列表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo brctl show br0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bridge name	    bridge id		    STP enabled    interfaces
</span></span><span style="display:flex;"><span>br0		            8000.e0be0388eec9  no             enp3s0
</span></span></code></pre></div><p>查看 <code>br0</code> 的各接口信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo brctl showstp br0
</span></span><span style="display:flex;"><span>br0
</span></span><span style="display:flex;"><span> bridge id		8000.e0be0388eec9
</span></span><span style="display:flex;"><span> designated root	8000.e0be0388eec9
</span></span><span style="display:flex;"><span> root port			0			path cost <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> max age			20.00s
</span></span><span style="display:flex;"><span> forward delay		15.00s
</span></span><span style="display:flex;"><span> hello time			2.00s
</span></span><span style="display:flex;"><span> ageing time		300.00s
</span></span><span style="display:flex;"><span> hello timer		0.00s		&lt;tbd&gt;
</span></span><span style="display:flex;"><span> forward timer		0.00s		&lt;tbd&gt;
</span></span><span style="display:flex;"><span> ageing timer		0.00s		&lt;tbd&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> enp3s0 <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> port id			8001			local state forwarding
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709
</span></span><span style="display:flex;"><span> path cost			<span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span> designated bridge	8000.08002732e709
</span></span><span style="display:flex;"><span> designated port	<span style="color:#ae81ff">8001</span>
</span></span><span style="display:flex;"><span> forward delay		15.00s
</span></span><span style="display:flex;"><span> hello time			2.00s
</span></span><span style="display:flex;"><span> max age			20.00s
</span></span><span style="display:flex;"><span> ageing time		300.00s
</span></span><span style="display:flex;"><span> priority			<span style="color:#ae81ff">128</span>
</span></span></code></pre></div><p>当前网络拓扑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>            |          Internet                 |
</span></span><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                   enp3s0 (Host Interface)               |
</span></span><span style="display:flex;"><span>|                   IP: 10.12.192.173                     |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>                            |
</span></span><span style="display:flex;"><span>                            v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                         br0 (Bridge)                    |
</span></span><span style="display:flex;"><span>|                      IP: 10.12.192.173                  |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span></code></pre></div><p>创建一个 <code>tap0</code> 接口用于<code>VM0</code>使用，允许 <code>user</code> 用户访问</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tunctl -t tap0 -u user       
</span></span></code></pre></div><p>在虚拟网桥中增加 <code>tap0</code> 接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo brctl addif br0 tap0
</span></span></code></pre></div><p>启用 tap0 接口，混杂模式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ifconfig tap0 0.0.0.0 promisc up
</span></span></code></pre></div><p>将网桥的 MAC 地址修改为宿主机的 MAC 地址，这样就可以接入公司网络了。否则因为内网的 MAC 地址过滤，无法接入公司网络。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig br0  hw ether 08:00:27:32:e7:09  promisc up
</span></span></code></pre></div><p>查看虚拟网桥列表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo brctl show br0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bridge name	    bridge id		    STP enabled    interfaces
</span></span><span style="display:flex;"><span>br0		            8000.08002732e709  no             enp3s0
</span></span><span style="display:flex;"><span>                                                        tap0
</span></span></code></pre></div><p>查看当前的网桥状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo brctl showstp br0 
</span></span><span style="display:flex;"><span>br0
</span></span><span style="display:flex;"><span> bridge id		8000.08002732e709
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709
</span></span><span style="display:flex;"><span> root port		   0			path cost		   <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> max age		  20.00			bridge max age		  20.00
</span></span><span style="display:flex;"><span> hello time		   2.00			bridge hello time	   2.00
</span></span><span style="display:flex;"><span> forward delay		  15.00			bridge forward delay	  15.00
</span></span><span style="display:flex;"><span> ageing time		 300.00
</span></span><span style="display:flex;"><span> hello timer		   0.00			tcn timer		   0.00
</span></span><span style="display:flex;"><span> topology change timer	   0.00			gc timer		   7.75
</span></span><span style="display:flex;"><span> flags			
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>enp2s0 <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> port id		8001			state		     forwarding
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709	path cost		   <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span style="display:flex;"><span> designated port	8001			forward delay timer	   0.00
</span></span><span style="display:flex;"><span> designated cost	   0			hold timer		   0.00
</span></span><span style="display:flex;"><span> flags			
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tap0 <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> port id		8002			state		     disabled
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709	path cost		 <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span style="display:flex;"><span> designated port	8002			forward delay timer	   0.00
</span></span><span style="display:flex;"><span> designated cost	   0			hold timer		   0.00
</span></span><span style="display:flex;"><span> flags				
</span></span></code></pre></div><p><code>tap0</code>可能处于<code>disabled</code>状态，因为还没有虚拟机使用它。启动虚拟机之后会自动切换到<code>forwarding</code>状态。</p>
<p>当前网络拓扑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>            |          Internet                 |
</span></span><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                   enp3s0 (Host Interface)               |
</span></span><span style="display:flex;"><span>|                   IP: 10.12.192.173                     |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>                            |
</span></span><span style="display:flex;"><span>                            v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                         br0 (Bridge)                    |
</span></span><span style="display:flex;"><span>|                      IP: 10.12.192.173                  |
</span></span><span style="display:flex;"><span>|                  +---------------------+                |
</span></span><span style="display:flex;"><span>|                  |        tap0         |                |
</span></span><span style="display:flex;"><span>|                  |     IP: 0.0.0.0     |                |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span></code></pre></div><p>启动 QEMU</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qemu-system-riscv64 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -nographic -machine virt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -smp &#34;</span>$vcpu<span style="color:#e6db74">&#34; -m &#34;</span>$memory<span style="color:#e6db74">&#34;G \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -bios &#34;</span>$fw<span style="color:#e6db74">&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -drive file=&#34;</span>$drive<span style="color:#e6db74">&#34;,format=qcow2,id=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-vga \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -netdev tap,id=tapnet,ifname=tap0,script=no,downscript=no \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>关注这段脚本的网络配置部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>tapnet,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet,ifname<span style="color:#f92672">=</span>tap0,script<span style="color:#f92672">=</span>no,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span></code></pre></div><p>详细解释可以查看“QEMU 网络虚拟化章节”，第一个参数 <code>-device virtio-net-device</code> 定义了名为 <code>virtio-net-device</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。第二个参数 <code>-netdev tap</code> 用于指定后端实现，使用<code>tap</code>方式，并且指定唯一 ID 为<code>tapnet</code>由<code>-device</code>参数中的子参数<code>netdev</code>使用，指定<code>ifname=tap0</code>，表示使用<code>tap0</code>接口作为虚拟化的后端。<code>script=no</code>和<code>downscript=no</code>表示不使用脚本来启动和关闭<code>tap0</code>接口。</p>
<p>查看当前的网络接口信息<code>ifconfig</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>br0: flags<span style="color:#f92672">=</span>4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span style="display:flex;"><span>        inet6 fe80::e2be:3ff:fe88:eec9  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 08:00:27:32:e7:09  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">861148</span>  bytes <span style="color:#ae81ff">310707296</span> <span style="color:#f92672">(</span>310.7 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">17556062</span>  bytes <span style="color:#ae81ff">1516515693</span> <span style="color:#f92672">(</span>1.5 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>enp2s0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span style="display:flex;"><span>        inet6 fe80::4964:61f8:420d:6781  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 08:00:27:32:e7:09  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">894523</span>  bytes <span style="color:#ae81ff">325547917</span> <span style="color:#f92672">(</span>325.5 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">1926</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">17563568</span>  bytes <span style="color:#ae81ff">1516947572</span> <span style="color:#f92672">(</span>1.5 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lo: flags<span style="color:#f92672">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span style="display:flex;"><span>        inet6 ::1  prefixlen <span style="color:#ae81ff">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span style="display:flex;"><span>        loop  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Local Loopback<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">1654925876</span>  bytes <span style="color:#ae81ff">134933568498</span> <span style="color:#f92672">(</span>134.9 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">1654925876</span>  bytes <span style="color:#ae81ff">134933568498</span> <span style="color:#f92672">(</span>134.9 GB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tap0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet6 fe80::f8ae:85ff:fed7:f9cd  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether fa:ae:85:d7:f9:cd  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">557</span>  bytes <span style="color:#ae81ff">44913</span> <span style="color:#f92672">(</span>44.9 KB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">7165</span>  bytes <span style="color:#ae81ff">832171</span> <span style="color:#f92672">(</span>832.1 KB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">55942</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>当前网络拓扑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>            |          Internet                 |
</span></span><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                   enp3s0 (Host Interface)               |
</span></span><span style="display:flex;"><span>|                   IP: 10.12.192.173                     |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>                            |
</span></span><span style="display:flex;"><span>                            v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                         br0 (Bridge)                    |
</span></span><span style="display:flex;"><span>|                      IP: 10.12.192.173                  |
</span></span><span style="display:flex;"><span>|                  +---------------------+                |
</span></span><span style="display:flex;"><span>|                  |        tap0         |                |
</span></span><span style="display:flex;"><span>|                  |     IP: 0.0.0.0     |                |
</span></span><span style="display:flex;"><span>+---------------------------|-----------------------------+
</span></span><span style="display:flex;"><span>                            |
</span></span><span style="display:flex;"><span>                            v
</span></span><span style="display:flex;"><span>+---------------------------|-----------------------------+
</span></span><span style="display:flex;"><span>|                  |        eth0         |                |
</span></span><span style="display:flex;"><span>|                  |     IP:10.12.193.53 |                |
</span></span><span style="display:flex;"><span>|                  +---------------------+                |
</span></span><span style="display:flex;"><span>|                     VM0 (QEMU)                          |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span></code></pre></div><p>查看当前的网桥状态，可以看到 tap0 已经处于 forwarding 状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo brctl showstp br0 
</span></span><span style="display:flex;"><span>br0
</span></span><span style="display:flex;"><span> bridge id		8000.08002732e709
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>enp2s0 <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> port id		8001			state		     forwarding
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709	path cost		   <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span> designated bridge	8000.08002732e709	message age 		
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tap0 <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> port id		8002			state		     forwarding
</span></span><span style="display:flex;"><span> designated root	8000.08002732e709	path cost		 <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span> designated bridge	8000.08002732e709	message age 			
</span></span></code></pre></div><p>添加 VM1 过程就忽略了，添加后的网络拓扑如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>            |          Internet                 |
</span></span><span style="display:flex;"><span>            +-----------------------------------+
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             |
</span></span><span style="display:flex;"><span>                             v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                   enp3s0 (Host Interface)               |
</span></span><span style="display:flex;"><span>|                   IP: 10.12.192.173                     |
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>                            |
</span></span><span style="display:flex;"><span>                            v
</span></span><span style="display:flex;"><span>+---------------------------------------------------------+
</span></span><span style="display:flex;"><span>|                         br0 (Bridge)                    |
</span></span><span style="display:flex;"><span>|                      IP: 10.12.192.173                  |
</span></span><span style="display:flex;"><span>|    +---------------------+  +-------------------+       |
</span></span><span style="display:flex;"><span>|    |        tap0         |  |        tap1       |       |
</span></span><span style="display:flex;"><span>|    |     IP: 0.0.0.0     |  |     IP: 0.0.0.0   |       |
</span></span><span style="display:flex;"><span>+---------------|-------------------------|---------------+
</span></span><span style="display:flex;"><span>                |                         |
</span></span><span style="display:flex;"><span>                v                         v
</span></span><span style="display:flex;"><span>+---------------|----------+  +-----------|---------------+
</span></span><span style="display:flex;"><span>|   |     eth0         |   |  |   |        eth0       |   |
</span></span><span style="display:flex;"><span>|   |  IP:10.12.193.53 |   |  |   |  IP:10.12.193.101 |   |
</span></span><span style="display:flex;"><span>|   +---------------------+|  |   +-------------------+   |
</span></span><span style="display:flex;"><span>|         VM0 (QEMU)       |  |         VM1 (QEMU)        |
</span></span><span style="display:flex;"><span>+--------------------------+  +---------------------------+
</span></span></code></pre></div><h2 id="qemu-网络虚拟化">QEMU 网络虚拟化<a hidden class="anchor" aria-hidden="true" href="#qemu-网络虚拟化">#</a></h2>
<p>QEMU 对于网络的虚拟化需要两个参数来指定：</p>
<ul>
<li>其中一个用于指定网络的前端驱动，也就是 Guest 中的实现</li>
<li>另一个用于指定网络的后端实现，也就是在 Host 中的实现。</li>
</ul>
<p>QEMU 支持两种方式来实现网络虚拟化，一种是旧版本上使用的参数为 <code>-net</code> 配合 <code>-net</code> ，另一种是在新版本上支持的 <code>-device</code> 配合 <code>-netdev</code> 。QEMU 的发展趋势是倾向于用 <code>-device</code> 一种命令格式来虚拟出不同的设备，其中包括网卡设备。</p>
<h3 id="-net---net-legacy">-net &amp; -net (legacy)<a hidden class="anchor" aria-hidden="true" href="#-net---net-legacy">#</a></h3>
<p>虽然仍然支持，但是逐步被废弃，不推荐使用。</p>
<p>我们以以下命令为例，来说明 <code>-net</code> 和 <code>-net</code> 的使用方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vcpu<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>memory<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>drive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;openEuler-22.09-V1-riscv64-qemu.qcow2&#34;</span>
</span></span><span style="display:flex;"><span>fw<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;fw_payload_oe_qemuvirt.elf&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qemu-system-riscv64 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -nographic -machine virt \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -smp &#34;</span>$vcpu<span style="color:#e6db74">&#34; -m &#34;</span>$memory<span style="color:#e6db74">&#34;G \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -kernel &#34;</span>$fw<span style="color:#e6db74">&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -bios none \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -drive file=&#34;</span>$drive<span style="color:#e6db74">&#34;,format=qcow2,id=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-vga \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -net nic,mac=52:54:00:12:34:56 \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -net tap,ifname=tap0,script=no,downscript=no \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -append &#39;root=/dev/vda1 rw console=ttyS0 swiotlb=1 loglevel=3 systemd.default_timeout_start_sec=600 selinux=0 highres=off mem=&#34;</span>$memory_append<span style="color:#e6db74">&#34;M earlycon&#39; &#34;</span>
</span></span></code></pre></div><p>其中这两个参数即实现了虚拟化网络：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  -net nic,mac<span style="color:#f92672">=</span>52:54:00:12:34:56 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -net tap,ifname<span style="color:#f92672">=</span>tap0,script<span style="color:#f92672">=</span>no,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span></code></pre></div><p>第一个参数 <code>-net nic</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 默认的驱动，这个驱动是 QEMU 中的一个虚拟网卡设备，指定它的 MAC 地址为 <code>52:54:00:12:34:56</code>。</p>
<p>第二个参数 <code>-net tap</code> 用于指定后端实现，也就是 Host 中的实现，这里使用的是 <code>tap</code> 驱动，它的网卡名称为 <code>tap0</code>，并且不执行任何脚本。这两个参数的组合就实现了虚拟化网络。</p>
<p>更多示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-net nic,model<span style="color:#f92672">=</span>virtio <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-net tap,ifname<span style="color:#f92672">=</span>tap3,script<span style="color:#f92672">=</span>/ect/qemu/qemu-ifup,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span></code></pre></div><p>第一个参数 <code>-net nic</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 <code>virtio</code> 驱动，这个驱动是 QEMU 中的一个虚拟网卡设备。第二个参数 <code>-net tap</code> 用于指定后端实现，也就是 Host 中的实现，这里使用的是 <code>tap</code> 驱动，它的网卡名称为 <code>tap3</code>，并且执行脚本 <code>/ect/qemu/qemu-ifup</code>。</p>
<blockquote>
<p>解释<code>/ect/qemu/qemu-ifup</code>
该脚本用于创建网桥，将网桥与宿主机的网卡绑定，然后将虚拟网卡绑定到网桥上，这样虚拟机就可以通过网桥与宿主机通信，宿主机也可以通过网桥与虚拟机通信。</p>
</blockquote>
<h3 id="-device---netdev-recommended">-device &amp; -netdev （Recommended）<a hidden class="anchor" aria-hidden="true" href="#-device---netdev-recommended">#</a></h3>
<p>这是新版本的 QEMU 支持的命令格式，也是 QEMU 未来的发展趋势，我们以以下命令为例，来说明 <code>-device</code> 和 <code>-netdev</code> 的使用方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qemu-system-riscv64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -nographic -machine virt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -smp <span style="color:#e6db74">&#34;</span>$vcpu<span style="color:#e6db74">&#34;</span> -m <span style="color:#e6db74">&#34;</span>$memory<span style="color:#e6db74">&#34;</span>G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -bios <span style="color:#e6db74">&#34;</span>$fw<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -drive file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$drive<span style="color:#e6db74">&#34;</span>,format<span style="color:#f92672">=</span>qcow2,id<span style="color:#f92672">=</span>hd0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -object rng-random,filename<span style="color:#f92672">=</span>/dev/urandom,id<span style="color:#f92672">=</span>rng0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-vga <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-rng-device,rng<span style="color:#f92672">=</span>rng0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-blk-device,drive<span style="color:#f92672">=</span>hd0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>tapnet,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet,ifname<span style="color:#f92672">=</span>tap0,script<span style="color:#f92672">=</span>~/qemu-script/qemu-ifup,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>其中这两个参数即实现了虚拟化网络：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>tapnet,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet,ifname<span style="color:#f92672">=</span>tap0,script<span style="color:#f92672">=</span>~/qemu-script/qemu-ifup,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span></code></pre></div><p>第一个参数 <code>-device virtio-net-device</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，定义了名为 <code>virtio-net-device</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。</p>
<p>第二个参数 <code>-netdev tap</code> 用于指定后端实现，使用<code>tap</code>方式，并且指定唯一 ID 为<code>tapnet</code>由<code>-device</code>参数中的子参数<code>netdev</code>使用。网卡名称为<code>tap0</code>并且执行脚本 <code>~/qemu-script/qemu-ifup</code>。</p>
<blockquote>
<p>-netdev 参数中 id 的使用
-netdev 参数中的 id 用于指定唯一的 ID，这个 ID 会被 <code>-device</code> 参数中的子参数 <code>netdev</code> 使用，这样 <code>-device</code> 参数就知道要将前端驱动连接到哪个后端实现上了。id 可以自定义任意唯一字符串如<code>-netdev tap,id=test</code>对应<code>-device virtio-net-device,netdev=test</code></p>
</blockquote>
<p>更多示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  -device virtio-net-pci,netdev<span style="color:#f92672">=</span>tapnet,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet,script<span style="color:#f92672">=</span>no,downscript<span style="color:#f92672">=</span>no <span style="color:#ae81ff">\
</span></span></span></code></pre></div><p>第一个参数 <code>-device virtio-net-pci</code> 定义了名为 <code>virtio-net-pci</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。</p>
<p>第二个参数，仔细观察会发现，我们没有定义链接到后端网卡的名称<code>ifname</code>，这是因为以<code>tap</code>模式启动 QEMU 时会自动创建<code>tap</code>设备，具体网卡名称根据当前宿主机的网卡情况而定，默认会创建一个名为<code>tap0</code>的网卡，如果启动了两个虚拟机，那么第二个虚拟机的网卡名称就是<code>tap1</code>，以此类推。</p>
<h3 id="区分-tap-模式与-bridge-模式">区分 tap 模式与 bridge 模式<a hidden class="anchor" aria-hidden="true" href="#区分-tap-模式与-bridge-模式">#</a></h3>
<p>我们有时候会用以下的命令进行 QEMU 虚拟机桥接网络的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>bridgenet,mac<span style="color:#f92672">=</span>52:54:00:12:34:57 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev bridge,ifname<span style="color:#f92672">=</span>br0,id<span style="color:#f92672">=</span>bridgenet
</span></span></code></pre></div><p>这也能为我们创建一个桥接网络，这是因为它和 <code>-netdev tap</code> 的工作方式是一样的，只是 <code>-netdev bridge</code> 的简化写法，<code>qemu-bridge-helper</code> 在背后替我们做了 <code>tap</code> 设备创建以及将 <code>tap</code> 设备加入桥接口的所有事情。</p>
<h3 id="添加多张网卡">添加多张网卡<a hidden class="anchor" aria-hidden="true" href="#添加多张网卡">#</a></h3>
<p>如果了解上述内容，添加多张网卡就十分容易实现了，我们只需要再添加一对 <code>-device</code> 和 <code>-netdev</code> 参数即可，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qemu-system-riscv64 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -nographic -machine virt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -smp <span style="color:#e6db74">&#34;</span>$vcpu<span style="color:#e6db74">&#34;</span> -m <span style="color:#e6db74">&#34;</span>$memory<span style="color:#e6db74">&#34;</span>G <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -bios <span style="color:#e6db74">&#34;</span>$fw<span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -drive file<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$drive<span style="color:#e6db74">&#34;</span>,format<span style="color:#f92672">=</span>qcow2,id<span style="color:#f92672">=</span>hd0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -object rng-random,filename<span style="color:#f92672">=</span>/dev/urandom,id<span style="color:#f92672">=</span>rng0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-vga <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-rng-device,rng<span style="color:#f92672">=</span>rng0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-blk-device,drive<span style="color:#f92672">=</span>hd0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>tapnet0,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet0,script<span style="color:#f92672">=</span>/etc/qemu/qemu-ifup,downscript<span style="color:#f92672">=</span>/etc/qemu/qemu-ifdown <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device virtio-net-device,netdev<span style="color:#f92672">=</span>tapnet1,mac<span style="color:#f92672">=</span>e0:be:03:88:54:e8 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -netdev tap,id<span style="color:#f92672">=</span>tapnet1,script<span style="color:#f92672">=</span>/etc/qemu/qemu-ifup,downscript<span style="color:#f92672">=</span>/etc/qemu/qemu-ifdown <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>需要注意的是，我们需要为每个 <code>-device</code> 参数指定一个唯一的 ID，这个 ID 会被 <code>-netdev</code> 参数中的子参数 <code>netdev</code> 使用，这样 <code>-device</code> 参数就知道要将前端驱动连接到哪个后端实现上了。并且每个 <code>tap</code> 设备只能被一个虚拟机使用，所以每个虚拟机的 <code>tap</code> 设备名称不能相同。</p>
<p>登录虚拟机查看网卡信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@openEuler-riscv64 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ifconfig </span>
</span></span><span style="display:flex;"><span>eth0: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.12.193.53  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span style="display:flex;"><span>        inet6 fe80::9e6:287b:30a2:574d  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether e0:be:03:88:54:e8  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">81</span>  bytes <span style="color:#ae81ff">9871</span> <span style="color:#f92672">(</span>9.6 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">19</span>  bytes <span style="color:#ae81ff">1735</span> <span style="color:#f92672">(</span>1.6 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>eth1: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
</span></span><span style="display:flex;"><span>        inet 10.12.193.101  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span style="display:flex;"><span>        inet6 fe80::4fe0:9e1e:4681:52b7  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 80:d4:09:62:cd:3c  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">76</span>  bytes <span style="color:#ae81ff">9471</span> <span style="color:#f92672">(</span>9.2 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">15</span>  bytes <span style="color:#ae81ff">1708</span> <span style="color:#f92672">(</span>1.6 KiB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lo: flags<span style="color:#f92672">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span style="display:flex;"><span>        inet6 ::1  prefixlen <span style="color:#ae81ff">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span style="display:flex;"><span>        loop  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Local Loopback<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#ae81ff">0</span>  bytes <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>0.0 B<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#ae81ff">0</span>  bytes <span style="color:#ae81ff">0</span> <span style="color:#f92672">(</span>0.0 B<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h2 id="不同网络策略工作方式">不同网络策略工作方式<a hidden class="anchor" aria-hidden="true" href="#不同网络策略工作方式">#</a></h2>
<ul>
<li>NAT 网络模式
<ul>
<li>NAT 网络以路由器的 NAT 功能为原理，允许虚拟机通过共享主机的 IP 地址访问互联网，但虚拟机之间不能直接通信。通过端口转发可以实现虚拟机之间的连接。</li>
</ul>
</li>
<li>桥接网络模式
<ul>
<li>桥接网络模式通过虚拟交换机连接虚拟机和主机，使得虚拟机可以通过局域网访问互联网，并允许虚拟机之间直接通信。</li>
</ul>
</li>
<li>内部网络模式
<ul>
<li>内部网络模式使得虚拟机可以创建一个完全隔离的网络，虚拟机之间可以直接通信，但无法访问互联网或外部网络。</li>
</ul>
</li>
<li>仅主机网络模式
<ul>
<li>仅主机网络模式允许虚拟机之间可以通信，并且与主机之间也可以通信，但无法访问互联网或外部网络。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>VM &lt;&gt; VM</th>
<th>VM → HOST</th>
<th>HOST → VM</th>
<th>VM → Internet</th>
<th>Internet → VM</th>
</tr>
</thead>
<tbody>
<tr>
<td>网络地址转换 NAT</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>NAT 网络</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>Bridged Adapter 桥接网卡</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
</tbody>
</table>
<h2 id="tuntap-网络设备">TUN/TAP 网络设备<a hidden class="anchor" aria-hidden="true" href="#tuntap-网络设备">#</a></h2>
<p>TAP 属于 Linux 内核支持的一种虚拟化网络设备，还有 TUN 也属于这种设备，它们完全由软件模拟实现，TUN/TAP 负责在内核协议栈和用户进程之间传送协议数据单元。TUN 工作在网络层，而 TAP 工作在数据链路层，TUN 负责与应用程序交换 IP 数据包，而 TAP 与应用程序交换以太网帧。所以 TUN 经常涉及路由，而 TAP 常用于网络桥接。</p>
<h1 id="ssh-远程登录虚拟机">SSH 远程登录虚拟机<a hidden class="anchor" aria-hidden="true" href="#ssh-远程登录虚拟机">#</a></h1>
<p>宿主机任意下目录执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>$ ssh-keygen -t rsa
</span></span><span style="display:flex;"><span>Generating public/private rsa key pair.
</span></span><span style="display:flex;"><span>Enter file in which to save the key <span style="color:#f92672">(</span>/home/user/.ssh/id_rsa<span style="color:#f92672">)</span>: host2vm0_id_irsa
</span></span><span style="display:flex;"><span>Enter passphrase <span style="color:#f92672">(</span>empty <span style="color:#66d9ef">for</span> no passphrase<span style="color:#f92672">)</span>: 
</span></span><span style="display:flex;"><span>Enter same passphrase again: 
</span></span><span style="display:flex;"><span>Your identification has been saved in host2vm0_id_irsa.
</span></span><span style="display:flex;"><span>Your public key has been saved in host2vm0_id_irsa.pub.
</span></span><span style="display:flex;"><span>The key fingerprint is:
</span></span><span style="display:flex;"><span>SHA256:OkWcw+R3x6Z2mzeYQuG033H3N9qIeym3TZKzz6YD8tQ user@ubuntu18
</span></span><span style="display:flex;"><span>The key<span style="color:#960050;background-color:#1e0010">&#39;</span>s randomart image is:
</span></span><span style="display:flex;"><span>+---<span style="color:#f92672">[</span>RSA 2048<span style="color:#f92672">]</span>----+
</span></span><span style="display:flex;"><span>|        .        |
</span></span><span style="display:flex;"><span>|       <span style="color:#f92672">=</span> .   .   |
</span></span><span style="display:flex;"><span>|        B .o. +  |
</span></span><span style="display:flex;"><span>|       . oo.o+   |
</span></span><span style="display:flex;"><span>|        S  ++ ..o|
</span></span><span style="display:flex;"><span>|       o ..+.E<span style="color:#f92672">=</span>o<span style="color:#f92672">=</span>|
</span></span><span style="display:flex;"><span>|      o   +..B+<span style="color:#f92672">=</span>+|
</span></span><span style="display:flex;"><span>|       .   oo<span style="color:#f92672">=</span>@o+|
</span></span><span style="display:flex;"><span>|           o<span style="color:#f92672">=</span>**<span style="color:#f92672">=</span> |
</span></span><span style="display:flex;"><span>+----<span style="color:#f92672">[</span>SHA256<span style="color:#f92672">]</span>-----+
</span></span></code></pre></div><p>一直回车确定，生成公私钥，保存在<code>~/.ssh</code>目录下。</p>
<blockquote>
<p>我在宿主机上生成的公私钥名称为，分别是<code>host2vm0_id_rsa</code>,<code>host2vm0_id_rsa.pub</code>方便我记忆。如果一直回车，那么生成的公私钥名称为<code>id_rsa</code>，<code>id_rsa.pub</code>。</p>
</blockquote>
<p>将公钥复制到虚拟机 <code>VM0</code> 上，以当前虚拟机 <code>VM0</code> 的 IP：<code>10.12.193.53</code> 为例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>$ ssh-copy-id 10.12.193.53
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输入密码</span>
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>, to filter out any that are already installed
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: <span style="color:#ae81ff">1</span> key<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> remain to be installed -- <span style="color:#66d9ef">if</span> you are prompted now it is to install the new keys
</span></span><span style="display:flex;"><span>user@10.12.193.53<span style="color:#e6db74">&#39;s password: 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Number of key(s) added: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Now try logging into the machine, with:   &#34;ssh &#39;</span>10.12.193.53<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">and check to make sure that only the key(s) you wanted were added.
</span></span></span></code></pre></div><p>然后就可以直接免密码登录了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>ssh user@10.12.193.53
</span></span></code></pre></div><h1 id="fixed-problems-ongoing">Fixed Problems (Ongoing)<a hidden class="anchor" aria-hidden="true" href="#fixed-problems-ongoing">#</a></h1>
<h2 id="cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16">cannot ioctl tunsetiff tap0 device or resource busy (errno=16)<a hidden class="anchor" aria-hidden="true" href="#cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16">#</a></h2>
<h2 id="failed-to-initialize-tap-device-operation-not-permitted">failed to initialize tap device: Operation not permitted<a hidden class="anchor" aria-hidden="true" href="#failed-to-initialize-tap-device-operation-not-permitted">#</a></h2>
<p>同类型错误：failed to create TAP device: Operation not permitted。因为创建虚拟设备 <code>tap</code> 需要 <code>root</code> 权限，所以需要使用 <code>sudo</code> 命令。执行 QEMU 启动是需要添加 <code>sudo</code>。</p>
<h2 id="qemu-虚拟机启动后网卡处于-down-状态无法获取-ip">QEMU 虚拟机启动后网卡处于 DOWN 状态，无法获取 IP<a hidden class="anchor" aria-hidden="true" href="#qemu-虚拟机启动后网卡处于-down-状态无法获取-ip">#</a></h2>
<p>查看是否是 MAC 地址配置错误，使用下面命令检查：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo ifconfig eth0 up
</span></span><span style="display:flex;"><span>SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>如果报错，参考下面章节<strong>SIOCSIFFLAGS: Cannot assign requested address</strong>解决方法进行解决。</p>
<h2 id="虚拟机可以-ping-通外网宿主机无法-ping-外网">虚拟机可以 ping 通外网，宿主机无法 ping 外网<a hidden class="anchor" aria-hidden="true" href="#虚拟机可以-ping-通外网宿主机无法-ping-外网">#</a></h2>
<p>这种情况说明基本网络没有问题，只是 DNS 解析有问题，可以通过修改<code>/etc/resolv.conf</code>文件解决。</p>
<p>海宁 DNS 服务器地址：<code>10.12.2.21</code> 和 <code>10.12.2.22</code>，我的情况是只能 <code>ping 10.12.2.21</code>，可以选择自己能 <code>ping</code> 通的 DNS 服务器地址。如果无法 <code>ping</code> 通，说明问题不在这，需要自行解决。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 修改 DNS 服务器地址</span>
</span></span><span style="display:flex;"><span>sudo vim /etc/resolv.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加以下内容</span>
</span></span><span style="display:flex;"><span>nameserver 10.12.2.21
</span></span><span style="display:flex;"><span>nameserver 10.12.2.22
</span></span></code></pre></div><h2 id="网络配置错误如何恢复配置之前的状态">网络配置错误，如何恢复配置之前的状态<a hidden class="anchor" aria-hidden="true" href="#网络配置错误如何恢复配置之前的状态">#</a></h2>
<p>最简单的方式 - 重启，因为所有操作都是命令行配置，都是临时配置，可以直接重启解决。</p>
<p>既然有这一小节，说明肯定有时候不方便直接重启，那么就需要手动恢复配置之前的状态。但是能够恢复的<strong>前提是需要记得之前的网卡 IP 地址、子网掩码、网关、广播地址等信息</strong>。这些信息在局域网里，可能只有 IP 不同，其他信息如果没记住可以查看其他同事的网卡配置即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 将网桥绑定的网卡从网桥上移除</span>
</span></span><span style="display:flex;"><span>sudo brctl delif br0 enp2s0
</span></span><span style="display:flex;"><span>sudo brctl delif br0 tap0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置宿主机网卡信息，必须一字不差，保持和之前一模一样才能恢复</span>
</span></span><span style="display:flex;"><span>sudo ip addr add 10.12.192.173/20 broadcast 10.12.207.255 dev enp2s0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 必须设置网关</span>
</span></span><span style="display:flex;"><span>sudo ip route add default via 10.12.192.1 dev enp2s0
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启网络管理器</span>
</span></span><span style="display:flex;"><span>systemctl restart NetworkManager
</span></span></code></pre></div><h2 id="-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256">-netdev tap,id=tapnet,script=/qemu-script/qemu-ifup,:network script /qemu-script/qemu-ifup failed with status 256<a hidden class="anchor" aria-hidden="true" href="#-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256">#</a></h2>
<p>可能原因 1: <code>qemu-ifup</code> 脚本没有执行权限，需要添加执行权限。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x qemu-ifup
</span></span></code></pre></div><p>可能原因 2: <code>qemu-ifup</code> 路径不对，必须放到<code>/etc/qemu/</code>目录下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /etc/qemu
</span></span><span style="display:flex;"><span>mv qemu-ifup /etc/qemu <span style="color:#f92672">&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span style="display:flex;"><span>sudo chmod +x qemu-ifup
</span></span><span style="display:flex;"><span>sudo chmod +x qemu-ifdown
</span></span></code></pre></div><h2 id="siocsifflags-cannot-assign-requested-address">SIOCSIFFLAGS: Cannot assign requested address<a hidden class="anchor" aria-hidden="true" href="#siocsifflags-cannot-assign-requested-address">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo ifconfig eth0 up
</span></span><span style="display:flex;"><span>SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>一般由于 MAC 地址配置错误导致，可以通过修改 MAC 地址为多播地址解决。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo ifconfig enp2s0 hw ether 00:11:22:33:44:55
</span></span></code></pre></div><p>重启网卡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>sudo ifconfig enp2s0 down
</span></span><span style="display:flex;"><span>sudo ifconfig enp2s0 up
</span></span></code></pre></div><p>MAC 地址的第一个字节中的最后一位（即第 7 位）用于标识该地址是单播，多播还是广播地址。如果这个位设置为 0，则表示这是一个单播地址；如果设置为 1，则表示这是一个多播或广播地址。</p>
<p>使用这种方法，我们可以确定上述每个 MAC 地址是否是单播地址：</p>
<ul>
<li><code>cd:c2:05:84:c8:2c</code> - 单播地址</li>
<li><code>13:7b:49:fc:a6:aa</code> - 单播地址</li>
<li><code>8f:aa:42:29:e8:68</code> - 单播地址</li>
</ul>
<p><code>00:11:22:33:44:55</code> 是多播地址。</p>
<h2 id="qemu--device-drive-with-0-bus0-unit0-exists">qemu -device drive with 0 bus=0 unit=0 exists<a hidden class="anchor" aria-hidden="true" href="#qemu--device-drive-with-0-bus0-unit0-exists">#</a></h2>
<p>这个错误通常意味着您尝试在 QEMU VM 中添加一个重复的设备。</p>
<p>如果您已经在 VM 中添加了驱动器，则可能会出现此问题。您可以检查是否存在两个具有相同 <code>bus</code> 和 <code>unit</code> 的设备（在此情况下，都是 0）。解决此问题的方法是删除重复设备或更改其配置以包括唯一的 <code>bus</code> 和 <code>unit</code>。</p>
<p>如果您没有意图添加重复的设备，在运行 QEMU 之前，您可能需要检查您的命令行，以确保正确设置了 <code>-drive</code> 选项。请注意，当使用 <code>-device</code> 添加设备时，您还应该避免使用 <code>-drive</code> 选项，因为它们可能引起冲突。</p>
<p>如果您需要进一步帮助，建议提供完整的 QEMU 命令和参数列表，以便更好地理解问题并提供更详细的建议。</p>
<h1 id="参考资料">参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料">#</a></h1>
<ol>
<li><a href="https://tomwei7.com/2021/10/09/qemu-network-config/">QEMU 网络配置 // 围城</a></li>
<li><a href="https://www.junmajinlong.com/img/virtual/1594802457384.png">理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙</a></li>
<li><a href="https://wzt.ac.cn/2021/05/28/QEMU-networking/">QEMU 网络配置一把梭 | CataLpa&rsquo;s Site</a></li>
<li><a href="https://blog.csdn.net/u014022631/article/details/53411557">qemu 虚拟机与外部网络的通信 li_Jiejun 的博客-CSDN 博客</a></li>
<li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html">安装 qemu-kvm 以及配置桥接网络</a></li>
<li><a href="https://blog.csdn.net/rikeyone/article/details/106767540">QEMU 中的网络虚拟化配置_程序猿 Ricky 的日常干货的博客-CSDN 博客</a></li>
<li><a href="https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/QEMU/">Nginx Directory</a></li>
<li><a href="https://www.cnblogs.com/huqingyu/archive/2005/04/03/131102.html">QEMU 网络配置 - 浙林龙哥 - 博客园</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/432022126">【qemu】qemu 网络配置 - 知乎</a></li>
<li><a href="https://tomwei7.com/2021/10/09/qemu-network-config/">QEMU 网络配置 // 围城</a></li>
<li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html">安装 qemu-kvm 以及配置桥接网络</a></li>
<li><a href="https://blog.virt.ltd/blog/archives/37/">在 qemu 中使用桥接网络 - T^3 Blog</a></li>
<li><a href="http://wiki.yanick.site/wiki/os/qemu/">为 QEMU 配置网桥上网 | Yanick&rsquo;s Wiki</a></li>
<li><a href="https://www.junmajinlong.com/virtual/network/all_about_tun_tap/">理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙</a></li>
<li><a href="https://wzt.ac.cn/2021/05/28/QEMU-networking/">QEMU 网络配置一把梭 | CataLpa&rsquo;s Site</a></li>
</ol>
<h1 id="附录">附录<a hidden class="anchor" aria-hidden="true" href="#附录">#</a></h1>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:8888/tags/qemu/">QEMU</a></li>
      <li><a href="http://localhost:8888/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/">虚拟机</a></li>
      <li><a href="http://localhost:8888/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">网络配置</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:8888/posts/linux%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">
    <span class="title">« Prev</span>
    <br>
    <span>Linux 网络配置常用命令</span>
  </a>
  <a class="next" href="http://localhost:8888/posts/%E4%BD%BF%E7%94%A8yadm%E7%AE%A1%E7%90%86%E5%B9%B6%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6dotfile/">
    <span class="title">Next »</span>
    <br>
    <span>使用 Yadm 管理并同步配置文件 Dotfile</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on x"
            href="https://x.com/intent/tweet/?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&amp;hashtags=QEMU%2c%e8%99%9a%e6%8b%9f%e6%9c%ba%2c%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&amp;title=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;summary=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;source=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&title=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on whatsapp"
            href="https://api.whatsapp.com/send?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae%20-%20http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on telegram"
            href="https://telegram.me/share/url?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;url=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&u=http%3a%2f%2flocalhost%3a8888%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:8888/">PaperMod</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
