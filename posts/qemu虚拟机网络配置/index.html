<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>QEMU 虚拟机网络配置 | 夜云泊</title>
<meta name=keywords content="QEMU,虚拟机,网络配置"><meta name=description content="Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡： # 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y"><meta name=author content="Nic"><link rel=canonical href=https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/><link crossorigin=anonymous href=/assets/css/stylesheet.4490366ee59f83f7324bce1d2f81fb1ebba1a551f24577c75929014495a1d9b1.css integrity="sha256-RJA2buWfg/cyS84dL4H7HruhpVHyRXfHWSkBRJWh2bE=" rel="preload stylesheet" as=style><link rel=icon href=https://lifeislife.cn/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lifeislife.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lifeislife.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://lifeislife.cn/apple-touch-icon.png><link rel=mask-icon href=https://lifeislife.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Noto+Sans+SC:wght@100..900&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-PS8L2EEEPR"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PS8L2EEEPR")}</script><meta property="og:title" content="QEMU 虚拟机网络配置"><meta property="og:description" content="Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡： # 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y"><meta property="og:type" content="article"><meta property="og:url" content="https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-05T14:47:54+00:00"><meta property="article:modified_time" content="2023-08-05T14:47:54+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="QEMU 虚拟机网络配置"><meta name=twitter:description content="Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡： # 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://lifeislife.cn/posts/"},{"@type":"ListItem","position":2,"name":"QEMU 虚拟机网络配置","item":"https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"QEMU 虚拟机网络配置","name":"QEMU 虚拟机网络配置","description":"Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡： # 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y","keywords":["QEMU","虚拟机","网络配置"],"articleBody":"Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡：\n# 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y 配置脚本 qemu-ifup 将下面的脚本保存为文件 qemu-ifup，并赋予可执行权限：\n为了方便复制脚本，在 confluence 页面提供了脚本内容，可以直接复制。\nmkdir -p /etc/qemu mv qemu-ifup /etc/qemu \u0026\u0026 mv qemu-ifdown /etc/qemu sudo chmod +x qemu-ifup sudo chmod +x qemu-ifdown 因为网卡信息不容易定位，可能一台机器有多个网卡，所以不方便用脚本获取，需要手动设置一下。将下面的NIC值修改为宿主机可以上网的网卡名称。可以通过ifconfig命令查看。\n#!/bin/bash # 设置默认网卡信息 NIC=enp2s0 # 设置用户名 USER_NAME=user # 设置网桥名称 BRIDGE=br0 # 设置网络信息 NIC_IP=$(ifconfig $NIC | grep \"inet\\b\" | awk '{print $2}') NIC_NETMAST=$(ifconfig $NIC | grep \"inet\\b\" | awk '{print $4}') NIC_BROADCAST=$(ifconfig $NIC | grep \"inet\\b\" | awk '{print $6}') NETMASK=255.255.240.0 # 设置默认网关地址 GATEWAY=10.12.192.1 # 获取宿主机网卡MAC地址，因为创建的网桥MAC地址是随机的， # 无法接入公司，需要从开发机网卡将其MAC地址赋值给网桥 MAC=$(ifconfig $NIC | grep \"ether\\b\" | awk '{print $2}') # 检查网桥是否已创建，已创建就忽略 function check_bridge() { echO \"Check bridge...\" if brctl show | grep \"^$BRIDGE\" \u0026\u003e /dev/null; then return 1 else return 0 fi } # 创建网桥 function create_bridge() { echo \"Start Create bridge...\" brctl addbr \"$BRIDGE\" brctl addif \"$BRIDGE\" \"$NIC\" ifconfig br0 0.0.0.0 promisc up dhclient $BRIDGE } # ifconfig \"$BRIDGE\" \"$NIC_IP\" netmask \"$NIC_NETMAST\" broadcast \"$NIC_BROADCAST\" hw ether \"$MAC\" promisc up # 启用IP转发 function enable_ip_forward() { echo 1 \u003e /proc/sys/net/ipv4/ip_forward } # 设置网桥 function setup_bridge() { check_bridge \"$BRIDGE\" if [ $? -eq 0 ]; then create_bridge fi enable_ip_forward } if [ -n \"$1\" ]; then setup_bridge echo \"Creating $1...\" tunctl -t \"$1\" -u \"$USER_NAME\" ifconfig \"$1\" 0.0.0.0 up echo \"Adding $1 to $BRIDGE...\" brctl addif \"$BRIDGE\" \"$1\" sleep 5 ifconfig \"$BRIDGE\" hw ether \"$MAC\" promisc up exit 0 else echo \"Error: no interface specified.\" exit 1 fi qemu-ifdown 以下是qemu-ifdown脚本，用于在关闭 QEMU 时关闭虚拟网卡，将其从网桥中移除，删除虚拟网卡。\n#!/bin/bash # 设置网桥名称 BRIDGE=br0 if [ -n \"$1\" ]; then # 将tap设备从网桥中移除 brctl delif ${BRIDGE} $1 # 关闭tap设备 ip link link $1 down # 删除tap设备 ip link del \"$1\" tunctl -d \"$1\" exit 0 else echo \"Error: no interface specified\" exit 1 fi 将系统镜像复制一份并修改文件名，QEMU 不能同时使用一个镜像启动两个虚拟机。\ncp openEuler-22.09-riscv64-qemu.qcow2 openEuler-22.09-riscv64-qemu-vm1.qcow2 需要修改启动脚本中的镜像文件名，以及启动参数，将drive以及cmd变量的内容覆盖为下面的内容，修改mac为分配给自己的虚拟机的 MAC 地址，script为上面的脚本qemu-ifup的路径。\n# 该脚本用于启动VM0 drive=\"openEuler-22.09-riscv64-qemu.qcow2\" .... cmd=\"qemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -bios \"$fw\" \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet\" 以sudo权限启动脚本：\nsudo ./preview_start_vm0.sh 以下为配置 VM1 过程，VM1 的启动脚本与 VM0 的启动脚本类似，只需要修改drive以及MAC，必须保证MAC与 VM0 的MAC不同。\n# 该脚本用于启动VM1 drive=\"openEuler-22.09-riscv64-qemu.qcow2\" .... cmd=\"qemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -bios \"$fw\" \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -device virtio-net-device,netdev=tapnet,mac=80:d4:09:62:cd:3c \\ -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet\" 网络通信测试 当前网络状态如下：\nHOST:10.12.192.177 VM0:10.12.193.53 VM1:10.12.193.101 HOST –\u003e VM0 # user @ ubuntu18 in ~/openeuler/openEuler2209 [18:41:54] $ ping -c 3 10.12.193.101 PING 10.12.193.101 (10.12.193.101) 56(84) bytes of data. 64 bytes from 10.12.193.101: icmp_seq=1 ttl=64 time=1.37 ms 64 bytes from 10.12.193.101: icmp_seq=2 ttl=64 time=0.897 ms 64 bytes from 10.12.193.101: icmp_seq=3 ttl=64 time=0.890 ms --- 10.12.193.101 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2002ms rtt min/avg/max/mdev = 0.890/1.055/1.378/0.228 ms Host –\u003e VM1 的测试结果与 Host –\u003e VM0 的测试结果相同。\nVM0 –\u003e HOST [root@openEuler-riscv64 ~]# ping -c 3 10.12.193.53 PING 10.12.193.53 (10.12.193.53) 56(84) bytes of data. 64 bytes from 10.12.193.53: icmp_seq=1 ttl=64 time=0.716 ms 64 bytes from 10.12.193.53: icmp_seq=2 ttl=64 time=1.74 ms 64 bytes from 10.12.193.53: icmp_seq=3 ttl=64 time=1.81 ms --- 10.12.193.53 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2009ms rtt min/avg/max/mdev = 0.716/1.424/1.812/0.501 ms VM1 –\u003e Host 的测试结果与 Host –\u003e VM0 的测试结果相同。\nVM1 –\u003e VM0 [root@openEuler-riscv64 ~]# ping -c 3 10.12.193.53 PING 10.12.193.53 (10.12.193.53) 56(84) bytes of data. 64 bytes from 10.12.193.53: icmp_seq=1 ttl=64 time=0.716 ms 64 bytes from 10.12.193.53: icmp_seq=2 ttl=64 time=1.74 ms 64 bytes from 10.12.193.53: icmp_seq=3 ttl=64 time=1.81 ms --- 10.12.193.53 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2009ms rtt min/avg/max/mdev = 0.716/1.424/1.812/0.501 ms VM0 –\u003e VM1 与 VM1 –\u003e VM0 的测试结果相同。\nVM0 –\u003e github [root@openEuler-riscv64 ~]# ping -c 4 github.com PING github.com (192.30.255.113) 56(84) bytes of data. 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=1 ttl=46 time=221 ms 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=2 ttl=46 time=277 ms 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=3 ttl=46 time=216 ms 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=4 ttl=46 time=218 ms --- github.com ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3014ms rtt min/avg/max/mdev = 215.984/232.733/276.593/25.374 ms HOST –\u003e github # user @ ubuntu18 in ~/openeuler/openEuler2209 [17:59:40] $ ping -c 3 github.com PING github.com (192.30.255.113) 56(84) bytes of data. 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=1 ttl=46 time=218 ms 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=2 ttl=46 time=216 ms 64 bytes from lb-192-30-255-113-sea.github.com (192.30.255.113): icmp_seq=3 ttl=46 time=216 ms --- github.com ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2002ms rtt min/avg/max/mdev = 216.252/217.087/218.409/0.945 ms 原理探究 (Ongoing) Step by Step 解析 查看一下网络接口信息：\nifconfig enp3s0: flags=4163 mtu 1500 inet 10.12.192.173 netmask 255.255.240.0 broadcast 10.12.207.255 inet6 fe80::a00:27ff:fe32:e709 prefixlen 64 scopeid 0x20 ether 08:00:27:32:e7:09 txqueuelen 1000 (Ethernet) RX packets 6017 bytes 5412928 (5.4 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1979 bytes 179467 (179.4 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1000 (Local Loopback) RX packets 125 bytes 10142 (10.1 KB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 125 bytes 10142 (10.1 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 创建一个名为br0的网桥\nsudo brctl addbr br0 将网桥与宿主机的网卡绑定\nsudo brctl addif br0 enp3s0 启用 br0 接口，并从 DHCP 服务器获得 IP 地址\nsudo ifconfig br0 0.0.0.0 promisc up sudo dhclient br0 查看虚拟网桥列表\nsudo brctl show br0 bridge name\tbridge id\tSTP enabled interfaces br0\t8000.e0be0388eec9 no enp3s0 查看 br0 的各接口信息\nsudo brctl showstp br0 br0 bridge id\t8000.e0be0388eec9 designated root\t8000.e0be0388eec9 root port\t0\tpath cost 0 max age\t20.00s forward delay\t15.00s hello time\t2.00s ageing time\t300.00s hello timer\t0.00s\tforward timer\t0.00s\tageing timer\t0.00s\tenp3s0 (1) port id\t8001\tlocal state forwarding designated root\t8000.08002732e709 path cost\t100 designated bridge\t8000.08002732e709 designated port\t8001 forward delay\t15.00s hello time\t2.00s max age\t20.00s ageing time\t300.00s priority\t128 当前网络拓扑：\n+-----------------------------------+ | Internet | +-----------------------------------+ | | v +---------------------------------------------------------+ | enp3s0 (Host Interface) | | IP: 10.12.192.173 | +---------------------------------------------------------+ | v +---------------------------------------------------------+ | br0 (Bridge) | | IP: 10.12.192.173 | +---------------------------------------------------------+ 创建一个 tap0 接口用于VM0使用，允许 user 用户访问\nsudo tunctl -t tap0 -u user 在虚拟网桥中增加 tap0 接口\nsudo brctl addif br0 tap0 启用 tap0 接口，混杂模式\nsudo ifconfig tap0 0.0.0.0 promisc up 将网桥的 MAC 地址修改为宿主机的 MAC 地址，这样就可以接入公司网络了。否则因为内网的 MAC 地址过滤，无法接入公司网络。\nifconfig br0 hw ether 08:00:27:32:e7:09 promisc up 查看虚拟网桥列表\n$ sudo brctl show br0 bridge name\tbridge id\tSTP enabled interfaces br0\t8000.08002732e709 no enp3s0 tap0 查看当前的网桥状态：\n$ sudo brctl showstp br0 br0 bridge id\t8000.08002732e709 designated root\t8000.08002732e709 root port\t0\tpath cost\t0 max age\t20.00\tbridge max age\t20.00 hello time\t2.00\tbridge hello time\t2.00 forward delay\t15.00\tbridge forward delay\t15.00 ageing time\t300.00 hello timer\t0.00\ttcn timer\t0.00 topology change timer\t0.00\tgc timer\t7.75 flags\tenp2s0 (1) port id\t8001\tstate\tforwarding designated root\t8000.08002732e709\tpath cost\t4 designated bridge\t8000.08002732e709\tmessage age timer\t0.00 designated port\t8001\tforward delay timer\t0.00 designated cost\t0\thold timer\t0.00 flags\ttap0 (2) port id\t8002\tstate\tdisabled designated root\t8000.08002732e709\tpath cost\t100 designated bridge\t8000.08002732e709\tmessage age timer\t0.00 designated port\t8002\tforward delay timer\t0.00 designated cost\t0\thold timer\t0.00 flags\ttap0可能处于disabled状态，因为还没有虚拟机使用它。启动虚拟机之后会自动切换到forwarding状态。\n当前网络拓扑：\n+-----------------------------------+ | Internet | +-----------------------------------+ | | v +---------------------------------------------------------+ | enp3s0 (Host Interface) | | IP: 10.12.192.173 | +---------------------------------------------------------+ | v +---------------------------------------------------------+ | br0 (Bridge) | | IP: 10.12.192.173 | | +---------------------+ | | | tap0 | | | | IP: 0.0.0.0 | | +---------------------------------------------------------+ 启动 QEMU\ncmd=\"qemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -bios \"$fw\" \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,ifname=tap0,script=no,downscript=no \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet\" 关注这段脚本的网络配置部分：\n-device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,ifname=tap0,script=no,downscript=no \\ 详细解释可以查看“QEMU 网络虚拟化章节”，第一个参数 -device virtio-net-device 定义了名为 virtio-net-device 的网络设备，并将其连接到一个名为 tapnet 的网络设备上，指定它的 MAC 地址为 e0:be:03:88:54:e8。第二个参数 -netdev tap 用于指定后端实现，使用tap方式，并且指定唯一 ID 为tapnet由-device参数中的子参数netdev使用，指定ifname=tap0，表示使用tap0接口作为虚拟化的后端。script=no和downscript=no表示不使用脚本来启动和关闭tap0接口。\n查看当前的网络接口信息ifconfig：\nbr0: flags=4419 mtu 1500 inet 10.12.192.173 netmask 255.255.240.0 broadcast 10.12.207.255 inet6 fe80::e2be:3ff:fe88:eec9 prefixlen 64 scopeid 0x20 ether 08:00:27:32:e7:09 txqueuelen 1000 (Ethernet) RX packets 861148 bytes 310707296 (310.7 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 17556062 bytes 1516515693 (1.5 GB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 enp2s0: flags=4163 mtu 1500 inet 10.12.192.173 netmask 255.255.240.0 broadcast 10.12.207.255 inet6 fe80::4964:61f8:420d:6781 prefixlen 64 scopeid 0x20 ether 08:00:27:32:e7:09 txqueuelen 1000 (Ethernet) RX packets 894523 bytes 325547917 (325.5 MB) RX errors 0 dropped 1926 overruns 0 frame 0 TX packets 17563568 bytes 1516947572 (1.5 GB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1000 (Local Loopback) RX packets 1654925876 bytes 134933568498 (134.9 GB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1654925876 bytes 134933568498 (134.9 GB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 tap0: flags=4163 mtu 1500 inet6 fe80::f8ae:85ff:fed7:f9cd prefixlen 64 scopeid 0x20 ether fa:ae:85:d7:f9:cd txqueuelen 1000 (Ethernet) RX packets 557 bytes 44913 (44.9 KB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 7165 bytes 832171 (832.1 KB) TX errors 0 dropped 55942 overruns 0 carrier 0 collisions 0 当前网络拓扑：\n+-----------------------------------+ | Internet | +-----------------------------------+ | | v +---------------------------------------------------------+ | enp3s0 (Host Interface) | | IP: 10.12.192.173 | +---------------------------------------------------------+ | v +---------------------------------------------------------+ | br0 (Bridge) | | IP: 10.12.192.173 | | +---------------------+ | | | tap0 | | | | IP: 0.0.0.0 | | +---------------------------|-----------------------------+ | v +---------------------------|-----------------------------+ | | eth0 | | | | IP:10.12.193.53 | | | +---------------------+ | | VM0 (QEMU) | +---------------------------------------------------------+ 查看当前的网桥状态，可以看到 tap0 已经处于 forwarding 状态：\n$ sudo brctl showstp br0 br0 bridge id\t8000.08002732e709 designated root\t8000.08002732e709 enp2s0 (1) port id\t8001\tstate\tforwarding designated root\t8000.08002732e709\tpath cost\t4 designated bridge\t8000.08002732e709\tmessage age tap0 (2) port id\t8002\tstate\tforwarding designated root\t8000.08002732e709\tpath cost\t100 designated bridge\t8000.08002732e709\tmessage age 添加 VM1 过程就忽略了，添加后的网络拓扑如下：\n+-----------------------------------+ | Internet | +-----------------------------------+ | | v +---------------------------------------------------------+ | enp3s0 (Host Interface) | | IP: 10.12.192.173 | +---------------------------------------------------------+ | v +---------------------------------------------------------+ | br0 (Bridge) | | IP: 10.12.192.173 | | +---------------------+ +-------------------+ | | | tap0 | | tap1 | | | | IP: 0.0.0.0 | | IP: 0.0.0.0 | | +---------------|-------------------------|---------------+ | | v v +---------------|----------+ +-----------|---------------+ | | eth0 | | | | eth0 | | | | IP:10.12.193.53 | | | | IP:10.12.193.101 | | | +---------------------+| | +-------------------+ | | VM0 (QEMU) | | VM1 (QEMU) | +--------------------------+ +---------------------------+ QEMU 网络虚拟化 QEMU 对于网络的虚拟化需要两个参数来指定：\n其中一个用于指定网络的前端驱动，也就是 Guest 中的实现 另一个用于指定网络的后端实现，也就是在 Host 中的实现。 QEMU 支持两种方式来实现网络虚拟化，一种是旧版本上使用的参数为 -net 配合 -net ，另一种是在新版本上支持的 -device 配合 -netdev 。QEMU 的发展趋势是倾向于用 -device 一种命令格式来虚拟出不同的设备，其中包括网卡设备。\n-net \u0026 -net (legacy) 虽然仍然支持，但是逐步被废弃，不推荐使用。\n我们以以下命令为例，来说明 -net 和 -net 的使用方法：\nvcpu=8 memory=8 drive=\"openEuler-22.09-V1-riscv64-qemu.qcow2\" fw=\"fw_payload_oe_qemuvirt.elf\" cmd=\"qemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -kernel \"$fw\" \\ -bios none \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -net nic,mac=52:54:00:12:34:56 \\ -net tap,ifname=tap0,script=no,downscript=no \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet \\ -append 'root=/dev/vda1 rw console=ttyS0 swiotlb=1 loglevel=3 systemd.default_timeout_start_sec=600 selinux=0 highres=off mem=\"$memory_append\"M earlycon' \" 其中这两个参数即实现了虚拟化网络：\n-net nic,mac=52:54:00:12:34:56 \\ -net tap,ifname=tap0,script=no,downscript=no \\ 第一个参数 -net nic 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 默认的驱动，这个驱动是 QEMU 中的一个虚拟网卡设备，指定它的 MAC 地址为 52:54:00:12:34:56。\n第二个参数 -net tap 用于指定后端实现，也就是 Host 中的实现，这里使用的是 tap 驱动，它的网卡名称为 tap0，并且不执行任何脚本。这两个参数的组合就实现了虚拟化网络。\n更多示例：\n-net nic,model=virtio \\ -net tap,ifname=tap3,script=/ect/qemu/qemu-ifup,downscript=no \\ 第一个参数 -net nic 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 virtio 驱动，这个驱动是 QEMU 中的一个虚拟网卡设备。第二个参数 -net tap 用于指定后端实现，也就是 Host 中的实现，这里使用的是 tap 驱动，它的网卡名称为 tap3，并且执行脚本 /ect/qemu/qemu-ifup。\n解释/ect/qemu/qemu-ifup 该脚本用于创建网桥，将网桥与宿主机的网卡绑定，然后将虚拟网卡绑定到网桥上，这样虚拟机就可以通过网桥与宿主机通信，宿主机也可以通过网桥与虚拟机通信。\n-device \u0026 -netdev （Recommended） 这是新版本的 QEMU 支持的命令格式，也是 QEMU 未来的发展趋势，我们以以下命令为例，来说明 -device 和 -netdev 的使用方法：\nqemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -bios \"$fw\" \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,ifname=tap0,script=~/qemu-script/qemu-ifup,downscript=no \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet 其中这两个参数即实现了虚拟化网络：\n-device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,ifname=tap0,script=~/qemu-script/qemu-ifup,downscript=no \\ 第一个参数 -device virtio-net-device 用于指定上述所说的前端驱动，也就是 Guest 中的实现，定义了名为 virtio-net-device 的网络设备，并将其连接到一个名为 tapnet 的网络设备上，指定它的 MAC 地址为 e0:be:03:88:54:e8。\n第二个参数 -netdev tap 用于指定后端实现，使用tap方式，并且指定唯一 ID 为tapnet由-device参数中的子参数netdev使用。网卡名称为tap0并且执行脚本 ~/qemu-script/qemu-ifup。\n-netdev 参数中 id 的使用 -netdev 参数中的 id 用于指定唯一的 ID，这个 ID 会被 -device 参数中的子参数 netdev 使用，这样 -device 参数就知道要将前端驱动连接到哪个后端实现上了。id 可以自定义任意唯一字符串如-netdev tap,id=test对应-device virtio-net-device,netdev=test\n更多示例：\n-device virtio-net-pci,netdev=tapnet,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet,script=no,downscript=no \\ 第一个参数 -device virtio-net-pci 定义了名为 virtio-net-pci 的网络设备，并将其连接到一个名为 tapnet 的网络设备上，指定它的 MAC 地址为 e0:be:03:88:54:e8。\n第二个参数，仔细观察会发现，我们没有定义链接到后端网卡的名称ifname，这是因为以tap模式启动 QEMU 时会自动创建tap设备，具体网卡名称根据当前宿主机的网卡情况而定，默认会创建一个名为tap0的网卡，如果启动了两个虚拟机，那么第二个虚拟机的网卡名称就是tap1，以此类推。\n区分 tap 模式与 bridge 模式 我们有时候会用以下的命令进行 QEMU 虚拟机桥接网络的配置：\n-device virtio-net-device,netdev=bridgenet,mac=52:54:00:12:34:57 \\ -netdev bridge,ifname=br0,id=bridgenet 这也能为我们创建一个桥接网络，这是因为它和 -netdev tap 的工作方式是一样的，只是 -netdev bridge 的简化写法，qemu-bridge-helper 在背后替我们做了 tap 设备创建以及将 tap 设备加入桥接口的所有事情。\n添加多张网卡 如果了解上述内容，添加多张网卡就十分容易实现了，我们只需要再添加一对 -device 和 -netdev 参数即可，如下所示：\nqemu-system-riscv64 \\ -nographic -machine virt \\ -smp \"$vcpu\" -m \"$memory\"G \\ -bios \"$fw\" \\ -drive file=\"$drive\",format=qcow2,id=hd0 \\ -object rng-random,filename=/dev/urandom,id=rng0 \\ -device virtio-vga \\ -device virtio-rng-device,rng=rng0 \\ -device virtio-blk-device,drive=hd0 \\ -device virtio-net-device,netdev=tapnet0,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet0,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \\ -device virtio-net-device,netdev=tapnet1,mac=e0:be:03:88:54:e8 \\ -netdev tap,id=tapnet1,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \\ -device qemu-xhci -usb -device usb-kbd -device usb-tablet 需要注意的是，我们需要为每个 -device 参数指定一个唯一的 ID，这个 ID 会被 -netdev 参数中的子参数 netdev 使用，这样 -device 参数就知道要将前端驱动连接到哪个后端实现上了。并且每个 tap 设备只能被一个虚拟机使用，所以每个虚拟机的 tap 设备名称不能相同。\n登录虚拟机查看网卡信息：\n[root@openEuler-riscv64 ~]# ifconfig eth0: flags=4163 mtu 1500 inet 10.12.193.53 netmask 255.255.240.0 broadcast 10.12.207.255 inet6 fe80::9e6:287b:30a2:574d prefixlen 64 scopeid 0x20 ether e0:be:03:88:54:e8 txqueuelen 1000 (Ethernet) RX packets 81 bytes 9871 (9.6 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 19 bytes 1735 (1.6 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 eth1: flags=4163 mtu 1500 inet 10.12.193.101 netmask 255.255.240.0 broadcast 10.12.207.255 inet6 fe80::4fe0:9e1e:4681:52b7 prefixlen 64 scopeid 0x20 ether 80:d4:09:62:cd:3c txqueuelen 1000 (Ethernet) RX packets 76 bytes 9471 (9.2 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 15 bytes 1708 (1.6 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 1000 (Local Loopback) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 0 bytes 0 (0.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 不同网络策略工作方式 NAT 网络模式 NAT 网络以路由器的 NAT 功能为原理，允许虚拟机通过共享主机的 IP 地址访问互联网，但虚拟机之间不能直接通信。通过端口转发可以实现虚拟机之间的连接。 桥接网络模式 桥接网络模式通过虚拟交换机连接虚拟机和主机，使得虚拟机可以通过局域网访问互联网，并允许虚拟机之间直接通信。 内部网络模式 内部网络模式使得虚拟机可以创建一个完全隔离的网络，虚拟机之间可以直接通信，但无法访问互联网或外部网络。 仅主机网络模式 仅主机网络模式允许虚拟机之间可以通信，并且与主机之间也可以通信，但无法访问互联网或外部网络。 VM \u003c\u003e VM VM → HOST HOST → VM VM → Internet Internet → VM 网络地址转换 NAT × √ × √ × NAT 网络 √ √ × √ × Bridged Adapter 桥接网卡 √ √ √ √ √ TUN/TAP 网络设备 TAP 属于 Linux 内核支持的一种虚拟化网络设备，还有 TUN 也属于这种设备，它们完全由软件模拟实现，TUN/TAP 负责在内核协议栈和用户进程之间传送协议数据单元。TUN 工作在网络层，而 TAP 工作在数据链路层，TUN 负责与应用程序交换 IP 数据包，而 TAP 与应用程序交换以太网帧。所以 TUN 经常涉及路由，而 TAP 常用于网络桥接。\nSSH 远程登录虚拟机 宿主机任意下目录执行：\n$ ssh-keygen -t rsa Generating public/private rsa key pair. Enter file in which to save the key (/home/user/.ssh/id_rsa): host2vm0_id_irsa Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in host2vm0_id_irsa. Your public key has been saved in host2vm0_id_irsa.pub. The key fingerprint is: SHA256:OkWcw+R3x6Z2mzeYQuG033H3N9qIeym3TZKzz6YD8tQ user@ubuntu18 The key's randomart image is: +---[RSA 2048]----+ | . | | = . . | | B .o. + | | . oo.o+ | | S ++ ..o| | o ..+.E=o=| | o +..B+=+| | . oo=@o+| | o=**= | +----[SHA256]-----+ 一直回车确定，生成公私钥，保存在~/.ssh目录下。\n我在宿主机上生成的公私钥名称为，分别是host2vm0_id_rsa,host2vm0_id_rsa.pub方便我记忆。如果一直回车，那么生成的公私钥名称为id_rsa，id_rsa.pub。\n将公钥复制到虚拟机 VM0 上，以当前虚拟机 VM0 的 IP：10.12.193.53 为例。\n$ ssh-copy-id 10.12.193.53 # 输入密码 /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys user@10.12.193.53's password: Number of key(s) added: 1 Now try logging into the machine, with: \"ssh '10.12.193.53'\" and check to make sure that only the key(s) you wanted were added. 然后就可以直接免密码登录了：\nssh user@10.12.193.53 Fixed Problems (Ongoing) cannot ioctl tunsetiff tap0 device or resource busy (errno=16) failed to initialize tap device: Operation not permitted 同类型错误：failed to create TAP device: Operation not permitted。因为创建虚拟设备 tap 需要 root 权限，所以需要使用 sudo 命令。执行 QEMU 启动是需要添加 sudo。\nQEMU 虚拟机启动后网卡处于 DOWN 状态，无法获取 IP 查看是否是 MAC 地址配置错误，使用下面命令检查：\nsudo ifconfig eth0 up SIOCSIFFLAGS: Cannot assign requested address 如果报错，参考下面章节SIOCSIFFLAGS: Cannot assign requested address解决方法进行解决。\n虚拟机可以 ping 通外网，宿主机无法 ping 外网 这种情况说明基本网络没有问题，只是 DNS 解析有问题，可以通过修改/etc/resolv.conf文件解决。\n海宁 DNS 服务器地址：10.12.2.21 和 10.12.2.22，我的情况是只能 ping 10.12.2.21，可以选择自己能 ping 通的 DNS 服务器地址。如果无法 ping 通，说明问题不在这，需要自行解决。\n# 修改 DNS 服务器地址 sudo vim /etc/resolv.conf # 添加以下内容 nameserver 10.12.2.21 nameserver 10.12.2.22 网络配置错误，如何恢复配置之前的状态 最简单的方式 - 重启，因为所有操作都是命令行配置，都是临时配置，可以直接重启解决。\n既然有这一小节，说明肯定有时候不方便直接重启，那么就需要手动恢复配置之前的状态。但是能够恢复的前提是需要记得之前的网卡 IP 地址、子网掩码、网关、广播地址等信息。这些信息在局域网里，可能只有 IP 不同，其他信息如果没记住可以查看其他同事的网卡配置即可。\n# 将网桥绑定的网卡从网桥上移除 sudo brctl delif br0 enp2s0 sudo brctl delif br0 tap0 # 配置宿主机网卡信息，必须一字不差，保持和之前一模一样才能恢复 sudo ip addr add 10.12.192.173/20 broadcast 10.12.207.255 dev enp2s0 # 必须设置网关 sudo ip route add default via 10.12.192.1 dev enp2s0 # 重启网络管理器 systemctl restart NetworkManager -netdev tap,id=tapnet,script=/qemu-script/qemu-ifup,:network script /qemu-script/qemu-ifup failed with status 256 可能原因 1: qemu-ifup 脚本没有执行权限，需要添加执行权限。\nchmod +x qemu-ifup 可能原因 2: qemu-ifup 路径不对，必须放到/etc/qemu/目录下。\nmkdir -p /etc/qemu mv qemu-ifup /etc/qemu \u0026\u0026 mv qemu-ifdown /etc/qemu sudo chmod +x qemu-ifup sudo chmod +x qemu-ifdown SIOCSIFFLAGS: Cannot assign requested address sudo ifconfig eth0 up SIOCSIFFLAGS: Cannot assign requested address 一般由于 MAC 地址配置错误导致，可以通过修改 MAC 地址为多播地址解决。\nsudo ifconfig enp2s0 hw ether 00:11:22:33:44:55 重启网卡\nsudo ifconfig enp2s0 down sudo ifconfig enp2s0 up MAC 地址的第一个字节中的最后一位（即第 7 位）用于标识该地址是单播，多播还是广播地址。如果这个位设置为 0，则表示这是一个单播地址；如果设置为 1，则表示这是一个多播或广播地址。\n使用这种方法，我们可以确定上述每个 MAC 地址是否是单播地址：\ncd:c2:05:84:c8:2c - 单播地址 13:7b:49:fc:a6:aa - 单播地址 8f:aa:42:29:e8:68 - 单播地址 00:11:22:33:44:55 是多播地址。\nqemu -device drive with 0 bus=0 unit=0 exists 这个错误通常意味着您尝试在 QEMU VM 中添加一个重复的设备。\n如果您已经在 VM 中添加了驱动器，则可能会出现此问题。您可以检查是否存在两个具有相同 bus 和 unit 的设备（在此情况下，都是 0）。解决此问题的方法是删除重复设备或更改其配置以包括唯一的 bus 和 unit。\n如果您没有意图添加重复的设备，在运行 QEMU 之前，您可能需要检查您的命令行，以确保正确设置了 -drive 选项。请注意，当使用 -device 添加设备时，您还应该避免使用 -drive 选项，因为它们可能引起冲突。\n如果您需要进一步帮助，建议提供完整的 QEMU 命令和参数列表，以便更好地理解问题并提供更详细的建议。\n参考资料 QEMU 网络配置 // 围城 理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙 QEMU 网络配置一把梭 | CataLpa’s Site qemu 虚拟机与外部网络的通信 li_Jiejun 的博客-CSDN 博客 安装 qemu-kvm 以及配置桥接网络 QEMU 中的网络虚拟化配置_程序猿 Ricky 的日常干货的博客-CSDN 博客 Nginx Directory QEMU 网络配置 - 浙林龙哥 - 博客园 【qemu】qemu 网络配置 - 知乎 QEMU 网络配置 // 围城 安装 qemu-kvm 以及配置桥接网络 在 qemu 中使用桥接网络 - T^3 Blog 为 QEMU 配置网桥上网 | Yanick’s Wiki 理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙 QEMU 网络配置一把梭 | CataLpa’s Site 附录 ","wordCount":"6914","inLanguage":"zh","datePublished":"2023-08-05T14:47:54Z","dateModified":"2023-08-05T14:47:54Z","author":{"@type":"Person","name":"Nic"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"},"publisher":{"@type":"Organization","name":"夜云泊","logo":{"@type":"ImageObject","url":"https://lifeislife.cn/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css><script src=https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js></script><script defer src=/static/fontawesome/fontawesome-all.js></script><header class=header><nav class=nav><div class=logo><a href=https://lifeislife.cn/ accesskey=h title="夜云泊 (Alt + H)">夜云泊</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lifeislife.cn/archives/ title=归档><span>归档</span></a></li><li><a href=https://lifeislife.cn/tags/ title=标签><span>标签</span></a></li><li><a href=https://lifeislife.cn/categories/ title=分类><span>分类</span></a></li><li><a href=https://lifeislife.cn/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://www.travellings.cn/go.html title=开往><span><i class='fa-solid fa-train-subway'></i>开往</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lifeislife.cn/>主页</a>&nbsp;»&nbsp;<a href=https://lifeislife.cn/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">QEMU 虚拟机网络配置</h1><div class=post-meta><span title='2023-08-05 14:47:54 +0000 UTC'>八月 5, 2023</span>&nbsp;·&nbsp;14 分钟&nbsp;·&nbsp;6914 字&nbsp;·&nbsp;Nic</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#安装工具>安装工具</a></li><li><a href=#配置脚本>配置脚本</a><ul><li><a href=#qemu-ifup>qemu-ifup</a></li><li><a href=#qemu-ifdown>qemu-ifdown</a></li></ul></li><li><a href=#网络通信测试>网络通信测试</a><ul><li><a href=#host----vm0>HOST &ndash;> VM0</a></li><li><a href=#vm0----host>VM0 &ndash;> HOST</a></li><li><a href=#vm1----vm0>VM1 &ndash;> VM0</a></li><li><a href=#vm0----github>VM0 &ndash;> github</a></li><li><a href=#host----github>HOST &ndash;> github</a></li></ul></li></ul><ul><li><a href=#step-by-step-解析>Step by Step 解析</a></li><li><a href=#qemu-网络虚拟化>QEMU 网络虚拟化</a><ul><li><a href=#-net---net-legacy>-net & -net (legacy)</a></li><li><a href=#-device---netdev-recommended>-device & -netdev （Recommended）</a></li><li><a href=#区分-tap-模式与-bridge-模式>区分 tap 模式与 bridge 模式</a></li><li><a href=#添加多张网卡>添加多张网卡</a></li></ul></li><li><a href=#不同网络策略工作方式>不同网络策略工作方式</a></li><li><a href=#tuntap-网络设备>TUN/TAP 网络设备</a></li></ul><ul><li><a href=#cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16>cannot ioctl tunsetiff tap0 device or resource busy (errno=16)</a></li><li><a href=#failed-to-initialize-tap-device-operation-not-permitted>failed to initialize tap device: Operation not permitted</a></li><li><a href=#qemu-虚拟机启动后网卡处于-down-状态无法获取-ip>QEMU 虚拟机启动后网卡处于 DOWN 状态，无法获取 IP</a></li><li><a href=#虚拟机可以-ping-通外网宿主机无法-ping-外网>虚拟机可以 ping 通外网，宿主机无法 ping 外网</a></li><li><a href=#网络配置错误如何恢复配置之前的状态>网络配置错误，如何恢复配置之前的状态</a></li><li><a href=#-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256>-netdev tap,id=tapnet,script=/qemu-script/qemu-ifup,:network script /qemu-script/qemu-ifup failed with status 256</a></li><li><a href=#siocsifflags-cannot-assign-requested-address>SIOCSIFFLAGS: Cannot assign requested address</a></li><li><a href=#qemu--device-drive-with-0-bus0-unit0-exists>qemu -device drive with 0 bus=0 unit=0 exists</a></li></ul></nav></div></details></div><div class=post-content><h1 id=quick-setup>Quick Setup<a hidden class=anchor aria-hidden=true href=#quick-setup>#</a></h1><h2 id=安装工具>安装工具<a hidden class=anchor aria-hidden=true href=#安装工具>#</a></h2><p>安装两个网络管理工具用于建立网桥以及虚拟网卡：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装虚拟网桥工具</span>
</span></span><span class=line><span class=cl>sudo apt install bridge-utils -y
</span></span><span class=line><span class=cl><span class=c1># UML（User-mode linux）工具        </span>
</span></span><span class=line><span class=cl>sudo apt install uml-utilities  -y   
</span></span></code></pre></div><h2 id=配置脚本>配置脚本<a hidden class=anchor aria-hidden=true href=#配置脚本>#</a></h2><h3 id=qemu-ifup>qemu-ifup<a hidden class=anchor aria-hidden=true href=#qemu-ifup>#</a></h3><p>将下面的脚本保存为文件 <code>qemu-ifup</code>，并赋予可执行权限：</p><blockquote><p>为了方便复制脚本，在 confluence 页面提供了脚本内容，可以直接复制。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /etc/qemu
</span></span><span class=line><span class=cl>mv qemu-ifup /etc/qemu <span class=o>&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span class=line><span class=cl>sudo chmod +x qemu-ifup
</span></span><span class=line><span class=cl>sudo chmod +x qemu-ifdown
</span></span></code></pre></div><p>因为网卡信息不容易定位，可能一台机器有多个网卡，所以不方便用脚本获取，需要手动设置一下。将下面的<code>NIC</code>值修改为宿主机可以上网的网卡名称。可以通过<code>ifconfig</code>命令查看。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># 设置默认网卡信息</span>
</span></span><span class=line><span class=cl><span class=nv>NIC</span><span class=o>=</span>enp2s0
</span></span><span class=line><span class=cl><span class=c1># 设置用户名</span>
</span></span><span class=line><span class=cl><span class=nv>USER_NAME</span><span class=o>=</span>user
</span></span><span class=line><span class=cl><span class=c1># 设置网桥名称</span>
</span></span><span class=line><span class=cl><span class=nv>BRIDGE</span><span class=o>=</span>br0
</span></span><span class=line><span class=cl><span class=c1># 设置网络信息</span>
</span></span><span class=line><span class=cl><span class=nv>NIC_IP</span><span class=o>=</span><span class=k>$(</span>ifconfig <span class=nv>$NIC</span> <span class=p>|</span> grep <span class=s2>&#34;inet\b&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>NIC_NETMAST</span><span class=o>=</span><span class=k>$(</span>ifconfig <span class=nv>$NIC</span> <span class=p>|</span> grep <span class=s2>&#34;inet\b&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $4}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>NIC_BROADCAST</span><span class=o>=</span><span class=k>$(</span>ifconfig <span class=nv>$NIC</span> <span class=p>|</span> grep <span class=s2>&#34;inet\b&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $6}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>NETMASK</span><span class=o>=</span>255.255.240.0
</span></span><span class=line><span class=cl><span class=c1># 设置默认网关地址</span>
</span></span><span class=line><span class=cl><span class=nv>GATEWAY</span><span class=o>=</span>10.12.192.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取宿主机网卡MAC地址，因为创建的网桥MAC地址是随机的，</span>
</span></span><span class=line><span class=cl><span class=c1># 无法接入公司，需要从开发机网卡将其MAC地址赋值给网桥</span>
</span></span><span class=line><span class=cl><span class=nv>MAC</span><span class=o>=</span><span class=k>$(</span>ifconfig <span class=nv>$NIC</span> <span class=p>|</span> grep <span class=s2>&#34;ether\b&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查网桥是否已创建，已创建就忽略</span>
</span></span><span class=line><span class=cl><span class=k>function</span> check_bridge<span class=o>()</span> 
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    echO <span class=s2>&#34;Check bridge...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> brctl show <span class=p>|</span> grep <span class=s2>&#34;^</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span> <span class=p>&amp;</span>&gt; /dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建网桥</span>
</span></span><span class=line><span class=cl><span class=k>function</span> create_bridge<span class=o>()</span> 
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Start Create bridge...&#34;</span>
</span></span><span class=line><span class=cl>    brctl addbr <span class=s2>&#34;</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    brctl addif <span class=s2>&#34;</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span>  <span class=s2>&#34;</span><span class=nv>$NIC</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    ifconfig br0 0.0.0.0 promisc up
</span></span><span class=line><span class=cl>    dhclient <span class=nv>$BRIDGE</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ifconfig &#34;$BRIDGE&#34; &#34;$NIC_IP&#34; netmask &#34;$NIC_NETMAST&#34; broadcast &#34;$NIC_BROADCAST&#34;  hw ether &#34;$MAC&#34; promisc up</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用IP转发</span>
</span></span><span class=line><span class=cl><span class=k>function</span> enable_ip_forward<span class=o>()</span> 
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置网桥</span>
</span></span><span class=line><span class=cl><span class=k>function</span> setup_bridge<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    check_bridge <span class=s2>&#34;</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        create_bridge
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    enable_ip_forward
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    setup_bridge
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Creating </span><span class=nv>$1</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>    tunctl -t <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -u <span class=s2>&#34;</span><span class=nv>$USER_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    ifconfig <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> 0.0.0.0 up
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Adding </span><span class=nv>$1</span><span class=s2> to </span><span class=nv>$BRIDGE</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>    brctl addif <span class=s2>&#34;</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    sleep <span class=m>5</span>
</span></span><span class=line><span class=cl>    ifconfig <span class=s2>&#34;</span><span class=nv>$BRIDGE</span><span class=s2>&#34;</span>  hw ether <span class=s2>&#34;</span><span class=nv>$MAC</span><span class=s2>&#34;</span> promisc up
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Error: no interface specified.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><h3 id=qemu-ifdown>qemu-ifdown<a hidden class=anchor aria-hidden=true href=#qemu-ifdown>#</a></h3><p>以下是<code>qemu-ifdown</code>脚本，用于在关闭 QEMU 时关闭虚拟网卡，将其从网桥中移除，删除虚拟网卡。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># 设置网桥名称</span>
</span></span><span class=line><span class=cl><span class=nv>BRIDGE</span><span class=o>=</span>br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># 将tap设备从网桥中移除</span>
</span></span><span class=line><span class=cl>	brctl delif <span class=si>${</span><span class=nv>BRIDGE</span><span class=si>}</span> <span class=nv>$1</span>
</span></span><span class=line><span class=cl>	<span class=c1># 关闭tap设备</span>
</span></span><span class=line><span class=cl>	ip link link <span class=nv>$1</span> down
</span></span><span class=line><span class=cl>    <span class=c1># 删除tap设备</span>
</span></span><span class=line><span class=cl>    ip link del <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>	tunctl -d <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;Error: no interface specified&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>将系统镜像复制一份并修改文件名，QEMU 不能同时使用一个镜像启动两个虚拟机。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cp openEuler-22.09-riscv64-qemu.qcow2 openEuler-22.09-riscv64-qemu-vm1.qcow2
</span></span></code></pre></div><p>需要修改启动脚本中的镜像文件名，以及启动参数，将<code>drive</code>以及<code>cmd</code>变量的内容覆盖为下面的内容，修改<code>mac</code>为分配给自己的虚拟机的 MAC 地址，<code>script</code>为上面的脚本<code>qemu-ifup</code>的路径。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 该脚本用于启动VM0</span>
</span></span><span class=line><span class=cl><span class=nv>drive</span><span class=o>=</span><span class=s2>&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl><span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;qemu-system-riscv64 \
</span></span></span><span class=line><span class=cl><span class=s2>  -nographic -machine virt \
</span></span></span><span class=line><span class=cl><span class=s2>  -smp &#34;</span><span class=nv>$vcpu</span><span class=s2>&#34; -m &#34;</span><span class=nv>$memory</span><span class=s2>&#34;G \
</span></span></span><span class=line><span class=cl><span class=s2>  -bios &#34;</span><span class=nv>$fw</span><span class=s2>&#34; \
</span></span></span><span class=line><span class=cl><span class=s2>  -drive file=&#34;</span><span class=nv>$drive</span><span class=s2>&#34;,format=qcow2,id=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-vga \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span class=line><span class=cl><span class=s2>  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span class=line><span class=cl><span class=s2>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>以<code>sudo</code>权限启动脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ./preview_start_vm0.sh
</span></span></code></pre></div><p>以下为配置 VM1 过程，VM1 的启动脚本与 VM0 的启动脚本类似，只需要修改<code>drive</code>以及<code>MAC</code>，必须保证<code>MAC</code>与 VM0 的<code>MAC</code>不同。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 该脚本用于启动VM1</span>
</span></span><span class=line><span class=cl><span class=nv>drive</span><span class=o>=</span><span class=s2>&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl><span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;qemu-system-riscv64 \
</span></span></span><span class=line><span class=cl><span class=s2>  -nographic -machine virt \
</span></span></span><span class=line><span class=cl><span class=s2>  -smp &#34;</span><span class=nv>$vcpu</span><span class=s2>&#34; -m &#34;</span><span class=nv>$memory</span><span class=s2>&#34;G \
</span></span></span><span class=line><span class=cl><span class=s2>  -bios &#34;</span><span class=nv>$fw</span><span class=s2>&#34; \
</span></span></span><span class=line><span class=cl><span class=s2>  -drive file=&#34;</span><span class=nv>$drive</span><span class=s2>&#34;,format=qcow2,id=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-vga \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-net-device,netdev=tapnet,mac=80:d4:09:62:cd:3c \
</span></span></span><span class=line><span class=cl><span class=s2>  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span class=line><span class=cl><span class=s2>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><h2 id=网络通信测试>网络通信测试<a hidden class=anchor aria-hidden=true href=#网络通信测试>#</a></h2><p>当前网络状态如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>HOST:10.12.192.177
</span></span><span class=line><span class=cl>VM0:10.12.193.53
</span></span><span class=line><span class=cl>VM1:10.12.193.101
</span></span></code></pre></div><h3 id=host----vm0>HOST &ndash;> VM0<a hidden class=anchor aria-hidden=true href=#host----vm0>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># user @ ubuntu18 in ~/openeuler/openEuler2209 [18:41:54] </span>
</span></span><span class=line><span class=cl>$ ping -c <span class=m>3</span> 10.12.193.101
</span></span><span class=line><span class=cl>PING 10.12.193.101 <span class=o>(</span>10.12.193.101<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.101: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>1.37 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.101: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.897 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.101: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.890 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- 10.12.193.101 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2002ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.890/1.055/1.378/0.228 ms
</span></span></code></pre></div><p>Host &ndash;> VM1 的测试结果与 Host &ndash;> VM0 的测试结果相同。</p><h3 id=vm0----host>VM0 &ndash;> HOST<a hidden class=anchor aria-hidden=true href=#vm0----host>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@openEuler-riscv64 ~<span class=o>]</span><span class=c1># ping -c 3 10.12.193.53 </span>
</span></span><span class=line><span class=cl>PING 10.12.193.53 <span class=o>(</span>10.12.193.53<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.716 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>1.74 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>1.81 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- 10.12.193.53 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2009ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM1 &ndash;> Host 的测试结果与 Host &ndash;> VM0 的测试结果相同。</p><h3 id=vm1----vm0>VM1 &ndash;> VM0<a hidden class=anchor aria-hidden=true href=#vm1----vm0>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@openEuler-riscv64 ~<span class=o>]</span><span class=c1># ping -c 3 10.12.193.53 </span>
</span></span><span class=line><span class=cl>PING 10.12.193.53 <span class=o>(</span>10.12.193.53<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.716 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>1.74 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 10.12.193.53: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>1.81 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- 10.12.193.53 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2009ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM0 &ndash;> VM1 与 VM1 &ndash;> VM0 的测试结果相同。</p><h3 id=vm0----github>VM0 &ndash;> github<a hidden class=anchor aria-hidden=true href=#vm0----github>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@openEuler-riscv64 ~<span class=o>]</span><span class=c1># ping -c 4 github.com</span>
</span></span><span class=line><span class=cl>PING github.com <span class=o>(</span>192.30.255.113<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>221</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>277</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>216</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>4</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>218</span> ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- github.com ping statistics ---
</span></span><span class=line><span class=cl><span class=m>4</span> packets transmitted, <span class=m>4</span> received, 0% packet loss, <span class=nb>time</span> 3014ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 215.984/232.733/276.593/25.374 ms
</span></span></code></pre></div><h3 id=host----github>HOST &ndash;> github<a hidden class=anchor aria-hidden=true href=#host----github>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># user @ ubuntu18 in ~/openeuler/openEuler2209 [17:59:40] </span>
</span></span><span class=line><span class=cl>$ ping -c <span class=m>3</span>  github.com
</span></span><span class=line><span class=cl>PING github.com <span class=o>(</span>192.30.255.113<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>218</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>216</span> ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from lb-192-30-255-113-sea.github.com <span class=o>(</span>192.30.255.113<span class=o>)</span>: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>3</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>46</span> <span class=nv>time</span><span class=o>=</span><span class=m>216</span> ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- github.com ping statistics ---
</span></span><span class=line><span class=cl><span class=m>3</span> packets transmitted, <span class=m>3</span> received, 0% packet loss, <span class=nb>time</span> 2002ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 216.252/217.087/218.409/0.945 ms
</span></span></code></pre></div><h1 id=原理探究-ongoing>原理探究 (Ongoing)<a hidden class=anchor aria-hidden=true href=#原理探究-ongoing>#</a></h1><h2 id=step-by-step-解析>Step by Step 解析<a hidden class=anchor aria-hidden=true href=#step-by-step-解析>#</a></h2><p>查看一下网络接口信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ifconfig
</span></span><span class=line><span class=cl>enp3s0: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class=line><span class=cl>        inet6 fe80::a00:27ff:fe32:e709  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether 08:00:27:32:e7:09  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>6017</span>  bytes <span class=m>5412928</span> <span class=o>(</span>5.4 MB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>1979</span>  bytes <span class=m>179467</span> <span class=o>(</span>179.4 KB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>lo: <span class=nv>flags</span><span class=o>=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class=m>65536</span>
</span></span><span class=line><span class=cl>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class=line><span class=cl>        inet6 ::1  prefixlen <span class=m>128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class=line><span class=cl>        loop  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Local Loopback<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>125</span>  bytes <span class=m>10142</span> <span class=o>(</span>10.1 KB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>125</span>  bytes <span class=m>10142</span> <span class=o>(</span>10.1 KB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span></code></pre></div><p>创建一个名为<code>br0</code>的网桥</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo brctl addbr br0
</span></span></code></pre></div><p>将网桥与宿主机的网卡绑定</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo brctl addif br0 enp3s0
</span></span></code></pre></div><p>启用 <code>br0</code> 接口，并从 DHCP 服务器获得 IP 地址</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ifconfig br0 0.0.0.0 promisc up
</span></span><span class=line><span class=cl>sudo dhclient br0
</span></span></code></pre></div><p>查看虚拟网桥列表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo brctl show br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bridge name	    bridge id		    STP enabled    interfaces
</span></span><span class=line><span class=cl>br0		            8000.e0be0388eec9  no             enp3s0
</span></span></code></pre></div><p>查看 <code>br0</code> 的各接口信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo brctl showstp br0
</span></span><span class=line><span class=cl>br0
</span></span><span class=line><span class=cl> bridge id		8000.e0be0388eec9
</span></span><span class=line><span class=cl> designated root	8000.e0be0388eec9
</span></span><span class=line><span class=cl> root port			0			path cost <span class=m>0</span>
</span></span><span class=line><span class=cl> max age			20.00s
</span></span><span class=line><span class=cl> forward delay		15.00s
</span></span><span class=line><span class=cl> hello <span class=nb>time</span>			2.00s
</span></span><span class=line><span class=cl> ageing <span class=nb>time</span>		300.00s
</span></span><span class=line><span class=cl> hello timer		0.00s		&lt;tbd&gt;
</span></span><span class=line><span class=cl> forward timer		0.00s		&lt;tbd&gt;
</span></span><span class=line><span class=cl> ageing timer		0.00s		&lt;tbd&gt;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> enp3s0 <span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl> port id			8001			<span class=nb>local</span> state forwarding
</span></span><span class=line><span class=cl> designated root	8000.08002732e709
</span></span><span class=line><span class=cl> path cost			<span class=m>100</span>
</span></span><span class=line><span class=cl> designated bridge	8000.08002732e709
</span></span><span class=line><span class=cl> designated port	<span class=m>8001</span>
</span></span><span class=line><span class=cl> forward delay		15.00s
</span></span><span class=line><span class=cl> hello <span class=nb>time</span>			2.00s
</span></span><span class=line><span class=cl> max age			20.00s
</span></span><span class=line><span class=cl> ageing <span class=nb>time</span>		300.00s
</span></span><span class=line><span class=cl> priority			<span class=m>128</span>
</span></span></code></pre></div><p>当前网络拓扑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>            |          Internet                 |
</span></span><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                   enp3s0 (Host Interface)               |
</span></span><span class=line><span class=cl>|                   IP: 10.12.192.173                     |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>                            |
</span></span><span class=line><span class=cl>                            v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                         br0 (Bridge)                    |
</span></span><span class=line><span class=cl>|                      IP: 10.12.192.173                  |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span></code></pre></div><p>创建一个 <code>tap0</code> 接口用于<code>VM0</code>使用，允许 <code>user</code> 用户访问</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo tunctl -t tap0 -u user       
</span></span></code></pre></div><p>在虚拟网桥中增加 <code>tap0</code> 接口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo brctl addif br0 tap0
</span></span></code></pre></div><p>启用 tap0 接口，混杂模式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ifconfig tap0 0.0.0.0 promisc up
</span></span></code></pre></div><p>将网桥的 MAC 地址修改为宿主机的 MAC 地址，这样就可以接入公司网络了。否则因为内网的 MAC 地址过滤，无法接入公司网络。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ifconfig br0  hw ether 08:00:27:32:e7:09  promisc up
</span></span></code></pre></div><p>查看虚拟网桥列表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo brctl show br0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bridge name	    bridge id		    STP enabled    interfaces
</span></span><span class=line><span class=cl>br0		            8000.08002732e709  no             enp3s0
</span></span><span class=line><span class=cl>                                                        tap0
</span></span></code></pre></div><p>查看当前的网桥状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo brctl showstp br0 
</span></span><span class=line><span class=cl>br0
</span></span><span class=line><span class=cl> bridge id		8000.08002732e709
</span></span><span class=line><span class=cl> designated root	8000.08002732e709
</span></span><span class=line><span class=cl> root port		   0			path cost		   <span class=m>0</span>
</span></span><span class=line><span class=cl> max age		  20.00			bridge max age		  20.00
</span></span><span class=line><span class=cl> hello <span class=nb>time</span>		   2.00			bridge hello <span class=nb>time</span>	   2.00
</span></span><span class=line><span class=cl> forward delay		  15.00			bridge forward delay	  15.00
</span></span><span class=line><span class=cl> ageing <span class=nb>time</span>		 300.00
</span></span><span class=line><span class=cl> hello timer		   0.00			tcn timer		   0.00
</span></span><span class=line><span class=cl> topology change timer	   0.00			gc timer		   7.75
</span></span><span class=line><span class=cl> flags			
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>enp2s0 <span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl> port id		8001			state		     forwarding
</span></span><span class=line><span class=cl> designated root	8000.08002732e709	path cost		   <span class=m>4</span>
</span></span><span class=line><span class=cl> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span class=line><span class=cl> designated port	8001			forward delay timer	   0.00
</span></span><span class=line><span class=cl> designated cost	   0			hold timer		   0.00
</span></span><span class=line><span class=cl> flags			
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tap0 <span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl> port id		8002			state		     disabled
</span></span><span class=line><span class=cl> designated root	8000.08002732e709	path cost		 <span class=m>100</span>
</span></span><span class=line><span class=cl> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span class=line><span class=cl> designated port	8002			forward delay timer	   0.00
</span></span><span class=line><span class=cl> designated cost	   0			hold timer		   0.00
</span></span><span class=line><span class=cl> flags				
</span></span></code></pre></div><p><code>tap0</code>可能处于<code>disabled</code>状态，因为还没有虚拟机使用它。启动虚拟机之后会自动切换到<code>forwarding</code>状态。</p><p>当前网络拓扑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>            |          Internet                 |
</span></span><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                   enp3s0 (Host Interface)               |
</span></span><span class=line><span class=cl>|                   IP: 10.12.192.173                     |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>                            |
</span></span><span class=line><span class=cl>                            v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                         br0 (Bridge)                    |
</span></span><span class=line><span class=cl>|                      IP: 10.12.192.173                  |
</span></span><span class=line><span class=cl>|                  +---------------------+                |
</span></span><span class=line><span class=cl>|                  |        tap0         |                |
</span></span><span class=line><span class=cl>|                  |     IP: 0.0.0.0     |                |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span></code></pre></div><p>启动 QEMU</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;qemu-system-riscv64 \
</span></span></span><span class=line><span class=cl><span class=s2>  -nographic -machine virt \
</span></span></span><span class=line><span class=cl><span class=s2>  -smp &#34;</span><span class=nv>$vcpu</span><span class=s2>&#34; -m &#34;</span><span class=nv>$memory</span><span class=s2>&#34;G \
</span></span></span><span class=line><span class=cl><span class=s2>  -bios &#34;</span><span class=nv>$fw</span><span class=s2>&#34; \
</span></span></span><span class=line><span class=cl><span class=s2>  -drive file=&#34;</span><span class=nv>$drive</span><span class=s2>&#34;,format=qcow2,id=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-vga \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span class=line><span class=cl><span class=s2>  -netdev tap,id=tapnet,ifname=tap0,script=no,downscript=no \
</span></span></span><span class=line><span class=cl><span class=s2>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>关注这段脚本的网络配置部分：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  -device virtio-net-device,netdev<span class=o>=</span>tapnet,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet,ifname<span class=o>=</span>tap0,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\
</span></span></span></code></pre></div><p>详细解释可以查看“QEMU 网络虚拟化章节”，第一个参数 <code>-device virtio-net-device</code> 定义了名为 <code>virtio-net-device</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。第二个参数 <code>-netdev tap</code> 用于指定后端实现，使用<code>tap</code>方式，并且指定唯一 ID 为<code>tapnet</code>由<code>-device</code>参数中的子参数<code>netdev</code>使用，指定<code>ifname=tap0</code>，表示使用<code>tap0</code>接口作为虚拟化的后端。<code>script=no</code>和<code>downscript=no</code>表示不使用脚本来启动和关闭<code>tap0</code>接口。</p><p>查看当前的网络接口信息<code>ifconfig</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>br0: <span class=nv>flags</span><span class=o>=</span>4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class=line><span class=cl>        inet6 fe80::e2be:3ff:fe88:eec9  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether 08:00:27:32:e7:09  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>861148</span>  bytes <span class=m>310707296</span> <span class=o>(</span>310.7 MB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>17556062</span>  bytes <span class=m>1516515693</span> <span class=o>(</span>1.5 GB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>enp2s0: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class=line><span class=cl>        inet6 fe80::4964:61f8:420d:6781  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether 08:00:27:32:e7:09  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>894523</span>  bytes <span class=m>325547917</span> <span class=o>(</span>325.5 MB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>1926</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>17563568</span>  bytes <span class=m>1516947572</span> <span class=o>(</span>1.5 GB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lo: <span class=nv>flags</span><span class=o>=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class=m>65536</span>
</span></span><span class=line><span class=cl>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class=line><span class=cl>        inet6 ::1  prefixlen <span class=m>128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class=line><span class=cl>        loop  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Local Loopback<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>1654925876</span>  bytes <span class=m>134933568498</span> <span class=o>(</span>134.9 GB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>1654925876</span>  bytes <span class=m>134933568498</span> <span class=o>(</span>134.9 GB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tap0: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet6 fe80::f8ae:85ff:fed7:f9cd  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether fa:ae:85:d7:f9:cd  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>557</span>  bytes <span class=m>44913</span> <span class=o>(</span>44.9 KB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>7165</span>  bytes <span class=m>832171</span> <span class=o>(</span>832.1 KB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>55942</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span></code></pre></div><p>当前网络拓扑：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>            |          Internet                 |
</span></span><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                   enp3s0 (Host Interface)               |
</span></span><span class=line><span class=cl>|                   IP: 10.12.192.173                     |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>                            |
</span></span><span class=line><span class=cl>                            v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                         br0 (Bridge)                    |
</span></span><span class=line><span class=cl>|                      IP: 10.12.192.173                  |
</span></span><span class=line><span class=cl>|                  +---------------------+                |
</span></span><span class=line><span class=cl>|                  |        tap0         |                |
</span></span><span class=line><span class=cl>|                  |     IP: 0.0.0.0     |                |
</span></span><span class=line><span class=cl>+---------------------------|-----------------------------+
</span></span><span class=line><span class=cl>                            |
</span></span><span class=line><span class=cl>                            v
</span></span><span class=line><span class=cl>+---------------------------|-----------------------------+
</span></span><span class=line><span class=cl>|                  |        eth0         |                |
</span></span><span class=line><span class=cl>|                  |     IP:10.12.193.53 |                |
</span></span><span class=line><span class=cl>|                  +---------------------+                |
</span></span><span class=line><span class=cl>|                     VM0 (QEMU)                          |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span></code></pre></div><p>查看当前的网桥状态，可以看到 tap0 已经处于 forwarding 状态：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo brctl showstp br0 
</span></span><span class=line><span class=cl>br0
</span></span><span class=line><span class=cl> bridge id		8000.08002732e709
</span></span><span class=line><span class=cl> designated root	8000.08002732e709
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>enp2s0 <span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl> port id		8001			state		     forwarding
</span></span><span class=line><span class=cl> designated root	8000.08002732e709	path cost		   <span class=m>4</span>
</span></span><span class=line><span class=cl> designated bridge	8000.08002732e709	message age 		
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tap0 <span class=o>(</span>2<span class=o>)</span>
</span></span><span class=line><span class=cl> port id		8002			state		     forwarding
</span></span><span class=line><span class=cl> designated root	8000.08002732e709	path cost		 <span class=m>100</span>
</span></span><span class=line><span class=cl> designated bridge	8000.08002732e709	message age 			
</span></span></code></pre></div><p>添加 VM1 过程就忽略了，添加后的网络拓扑如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>            |          Internet                 |
</span></span><span class=line><span class=cl>            +-----------------------------------+
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             |
</span></span><span class=line><span class=cl>                             v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                   enp3s0 (Host Interface)               |
</span></span><span class=line><span class=cl>|                   IP: 10.12.192.173                     |
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>                            |
</span></span><span class=line><span class=cl>                            v
</span></span><span class=line><span class=cl>+---------------------------------------------------------+
</span></span><span class=line><span class=cl>|                         br0 (Bridge)                    |
</span></span><span class=line><span class=cl>|                      IP: 10.12.192.173                  |
</span></span><span class=line><span class=cl>|    +---------------------+  +-------------------+       |
</span></span><span class=line><span class=cl>|    |        tap0         |  |        tap1       |       |
</span></span><span class=line><span class=cl>|    |     IP: 0.0.0.0     |  |     IP: 0.0.0.0   |       |
</span></span><span class=line><span class=cl>+---------------|-------------------------|---------------+
</span></span><span class=line><span class=cl>                |                         |
</span></span><span class=line><span class=cl>                v                         v
</span></span><span class=line><span class=cl>+---------------|----------+  +-----------|---------------+
</span></span><span class=line><span class=cl>|   |     eth0         |   |  |   |        eth0       |   |
</span></span><span class=line><span class=cl>|   |  IP:10.12.193.53 |   |  |   |  IP:10.12.193.101 |   |
</span></span><span class=line><span class=cl>|   +---------------------+|  |   +-------------------+   |
</span></span><span class=line><span class=cl>|         VM0 (QEMU)       |  |         VM1 (QEMU)        |
</span></span><span class=line><span class=cl>+--------------------------+  +---------------------------+
</span></span></code></pre></div><h2 id=qemu-网络虚拟化>QEMU 网络虚拟化<a hidden class=anchor aria-hidden=true href=#qemu-网络虚拟化>#</a></h2><p>QEMU 对于网络的虚拟化需要两个参数来指定：</p><ul><li>其中一个用于指定网络的前端驱动，也就是 Guest 中的实现</li><li>另一个用于指定网络的后端实现，也就是在 Host 中的实现。</li></ul><p>QEMU 支持两种方式来实现网络虚拟化，一种是旧版本上使用的参数为 <code>-net</code> 配合 <code>-net</code> ，另一种是在新版本上支持的 <code>-device</code> 配合 <code>-netdev</code> 。QEMU 的发展趋势是倾向于用 <code>-device</code> 一种命令格式来虚拟出不同的设备，其中包括网卡设备。</p><h3 id=-net---net-legacy>-net & -net (legacy)<a hidden class=anchor aria-hidden=true href=#-net---net-legacy>#</a></h3><p>虽然仍然支持，但是逐步被废弃，不推荐使用。</p><p>我们以以下命令为例，来说明 <code>-net</code> 和 <code>-net</code> 的使用方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>vcpu</span><span class=o>=</span><span class=m>8</span>
</span></span><span class=line><span class=cl><span class=nv>memory</span><span class=o>=</span><span class=m>8</span>
</span></span><span class=line><span class=cl><span class=nv>drive</span><span class=o>=</span><span class=s2>&#34;openEuler-22.09-V1-riscv64-qemu.qcow2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>fw</span><span class=o>=</span><span class=s2>&#34;fw_payload_oe_qemuvirt.elf&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;qemu-system-riscv64 \
</span></span></span><span class=line><span class=cl><span class=s2>  -nographic -machine virt \
</span></span></span><span class=line><span class=cl><span class=s2>  -smp &#34;</span><span class=nv>$vcpu</span><span class=s2>&#34; -m &#34;</span><span class=nv>$memory</span><span class=s2>&#34;G \
</span></span></span><span class=line><span class=cl><span class=s2>  -kernel &#34;</span><span class=nv>$fw</span><span class=s2>&#34; \
</span></span></span><span class=line><span class=cl><span class=s2>  -bios none \
</span></span></span><span class=line><span class=cl><span class=s2>  -drive file=&#34;</span><span class=nv>$drive</span><span class=s2>&#34;,format=qcow2,id=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-vga \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class=line><span class=cl><span class=s2>  -net nic,mac=52:54:00:12:34:56 \
</span></span></span><span class=line><span class=cl><span class=s2>  -net tap,ifname=tap0,script=no,downscript=no \
</span></span></span><span class=line><span class=cl><span class=s2>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet \
</span></span></span><span class=line><span class=cl><span class=s2>  -append &#39;root=/dev/vda1 rw console=ttyS0 swiotlb=1 loglevel=3 systemd.default_timeout_start_sec=600 selinux=0 highres=off mem=&#34;</span><span class=nv>$memory_append</span><span class=s2>&#34;M earlycon&#39; &#34;</span>
</span></span></code></pre></div><p>其中这两个参数即实现了虚拟化网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  -net nic,mac<span class=o>=</span>52:54:00:12:34:56 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -net tap,ifname<span class=o>=</span>tap0,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\
</span></span></span></code></pre></div><p>第一个参数 <code>-net nic</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 默认的驱动，这个驱动是 QEMU 中的一个虚拟网卡设备，指定它的 MAC 地址为 <code>52:54:00:12:34:56</code>。</p><p>第二个参数 <code>-net tap</code> 用于指定后端实现，也就是 Host 中的实现，这里使用的是 <code>tap</code> 驱动，它的网卡名称为 <code>tap0</code>，并且不执行任何脚本。这两个参数的组合就实现了虚拟化网络。</p><p>更多示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>-net nic,model<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-net tap,ifname<span class=o>=</span>tap3,script<span class=o>=</span>/ect/qemu/qemu-ifup,downscript<span class=o>=</span>no <span class=se>\
</span></span></span></code></pre></div><p>第一个参数 <code>-net nic</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，这里使用的是 <code>virtio</code> 驱动，这个驱动是 QEMU 中的一个虚拟网卡设备。第二个参数 <code>-net tap</code> 用于指定后端实现，也就是 Host 中的实现，这里使用的是 <code>tap</code> 驱动，它的网卡名称为 <code>tap3</code>，并且执行脚本 <code>/ect/qemu/qemu-ifup</code>。</p><blockquote><p>解释<code>/ect/qemu/qemu-ifup</code>
该脚本用于创建网桥，将网桥与宿主机的网卡绑定，然后将虚拟网卡绑定到网桥上，这样虚拟机就可以通过网桥与宿主机通信，宿主机也可以通过网桥与虚拟机通信。</p></blockquote><h3 id=-device---netdev-recommended>-device & -netdev （Recommended）<a hidden class=anchor aria-hidden=true href=#-device---netdev-recommended>#</a></h3><p>这是新版本的 QEMU 支持的命令格式，也是 QEMU 未来的发展趋势，我们以以下命令为例，来说明 <code>-device</code> 和 <code>-netdev</code> 的使用方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-riscv64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -nographic -machine virt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -smp <span class=s2>&#34;</span><span class=nv>$vcpu</span><span class=s2>&#34;</span> -m <span class=s2>&#34;</span><span class=nv>$memory</span><span class=s2>&#34;</span>G <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -bios <span class=s2>&#34;</span><span class=nv>$fw</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -drive <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$drive</span><span class=s2>&#34;</span>,format<span class=o>=</span>qcow2,id<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -object rng-random,filename<span class=o>=</span>/dev/urandom,id<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-vga <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-rng-device,rng<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-blk-device,drive<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-net-device,netdev<span class=o>=</span>tapnet,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet,ifname<span class=o>=</span>tap0,script<span class=o>=</span>~/qemu-script/qemu-ifup,downscript<span class=o>=</span>no <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>其中这两个参数即实现了虚拟化网络：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  -device virtio-net-device,netdev<span class=o>=</span>tapnet,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet,ifname<span class=o>=</span>tap0,script<span class=o>=</span>~/qemu-script/qemu-ifup,downscript<span class=o>=</span>no <span class=se>\
</span></span></span></code></pre></div><p>第一个参数 <code>-device virtio-net-device</code> 用于指定上述所说的前端驱动，也就是 Guest 中的实现，定义了名为 <code>virtio-net-device</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。</p><p>第二个参数 <code>-netdev tap</code> 用于指定后端实现，使用<code>tap</code>方式，并且指定唯一 ID 为<code>tapnet</code>由<code>-device</code>参数中的子参数<code>netdev</code>使用。网卡名称为<code>tap0</code>并且执行脚本 <code>~/qemu-script/qemu-ifup</code>。</p><blockquote><p>-netdev 参数中 id 的使用
-netdev 参数中的 id 用于指定唯一的 ID，这个 ID 会被 <code>-device</code> 参数中的子参数 <code>netdev</code> 使用，这样 <code>-device</code> 参数就知道要将前端驱动连接到哪个后端实现上了。id 可以自定义任意唯一字符串如<code>-netdev tap,id=test</code>对应<code>-device virtio-net-device,netdev=test</code></p></blockquote><p>更多示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  -device virtio-net-pci,netdev<span class=o>=</span>tapnet,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\
</span></span></span></code></pre></div><p>第一个参数 <code>-device virtio-net-pci</code> 定义了名为 <code>virtio-net-pci</code> 的网络设备，并将其连接到一个名为 <code>tapnet</code> 的网络设备上，指定它的 MAC 地址为 <code>e0:be:03:88:54:e8</code>。</p><p>第二个参数，仔细观察会发现，我们没有定义链接到后端网卡的名称<code>ifname</code>，这是因为以<code>tap</code>模式启动 QEMU 时会自动创建<code>tap</code>设备，具体网卡名称根据当前宿主机的网卡情况而定，默认会创建一个名为<code>tap0</code>的网卡，如果启动了两个虚拟机，那么第二个虚拟机的网卡名称就是<code>tap1</code>，以此类推。</p><h3 id=区分-tap-模式与-bridge-模式>区分 tap 模式与 bridge 模式<a hidden class=anchor aria-hidden=true href=#区分-tap-模式与-bridge-模式>#</a></h3><p>我们有时候会用以下的命令进行 QEMU 虚拟机桥接网络的配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  -device virtio-net-device,netdev<span class=o>=</span>bridgenet,mac<span class=o>=</span>52:54:00:12:34:57 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev bridge,ifname<span class=o>=</span>br0,id<span class=o>=</span>bridgenet
</span></span></code></pre></div><p>这也能为我们创建一个桥接网络，这是因为它和 <code>-netdev tap</code> 的工作方式是一样的，只是 <code>-netdev bridge</code> 的简化写法，<code>qemu-bridge-helper</code> 在背后替我们做了 <code>tap</code> 设备创建以及将 <code>tap</code> 设备加入桥接口的所有事情。</p><h3 id=添加多张网卡>添加多张网卡<a hidden class=anchor aria-hidden=true href=#添加多张网卡>#</a></h3><p>如果了解上述内容，添加多张网卡就十分容易实现了，我们只需要再添加一对 <code>-device</code> 和 <code>-netdev</code> 参数即可，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-riscv64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -nographic -machine virt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -smp <span class=s2>&#34;</span><span class=nv>$vcpu</span><span class=s2>&#34;</span> -m <span class=s2>&#34;</span><span class=nv>$memory</span><span class=s2>&#34;</span>G <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -bios <span class=s2>&#34;</span><span class=nv>$fw</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -drive <span class=nv>file</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$drive</span><span class=s2>&#34;</span>,format<span class=o>=</span>qcow2,id<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -object rng-random,filename<span class=o>=</span>/dev/urandom,id<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-vga <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-rng-device,rng<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-blk-device,drive<span class=o>=</span>hd0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-net-device,netdev<span class=o>=</span>tapnet0,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet0,script<span class=o>=</span>/etc/qemu/qemu-ifup,downscript<span class=o>=</span>/etc/qemu/qemu-ifdown <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device virtio-net-device,netdev<span class=o>=</span>tapnet1,mac<span class=o>=</span>e0:be:03:88:54:e8 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -netdev tap,id<span class=o>=</span>tapnet1,script<span class=o>=</span>/etc/qemu/qemu-ifup,downscript<span class=o>=</span>/etc/qemu/qemu-ifdown <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>需要注意的是，我们需要为每个 <code>-device</code> 参数指定一个唯一的 ID，这个 ID 会被 <code>-netdev</code> 参数中的子参数 <code>netdev</code> 使用，这样 <code>-device</code> 参数就知道要将前端驱动连接到哪个后端实现上了。并且每个 <code>tap</code> 设备只能被一个虚拟机使用，所以每个虚拟机的 <code>tap</code> 设备名称不能相同。</p><p>登录虚拟机查看网卡信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>root@openEuler-riscv64 ~<span class=o>]</span><span class=c1># ifconfig </span>
</span></span><span class=line><span class=cl>eth0: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.12.193.53  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class=line><span class=cl>        inet6 fe80::9e6:287b:30a2:574d  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether e0:be:03:88:54:e8  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>81</span>  bytes <span class=m>9871</span> <span class=o>(</span>9.6 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>19</span>  bytes <span class=m>1735</span> <span class=o>(</span>1.6 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>eth1: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.12.193.101  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class=line><span class=cl>        inet6 fe80::4fe0:9e1e:4681:52b7  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether 80:d4:09:62:cd:3c  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>76</span>  bytes <span class=m>9471</span> <span class=o>(</span>9.2 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>15</span>  bytes <span class=m>1708</span> <span class=o>(</span>1.6 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lo: <span class=nv>flags</span><span class=o>=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class=m>65536</span>
</span></span><span class=line><span class=cl>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class=line><span class=cl>        inet6 ::1  prefixlen <span class=m>128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class=line><span class=cl>        loop  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Local Loopback<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>0</span>  bytes <span class=m>0</span> <span class=o>(</span>0.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>0</span>  bytes <span class=m>0</span> <span class=o>(</span>0.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span></code></pre></div><h2 id=不同网络策略工作方式>不同网络策略工作方式<a hidden class=anchor aria-hidden=true href=#不同网络策略工作方式>#</a></h2><ul><li>NAT 网络模式<ul><li>NAT 网络以路由器的 NAT 功能为原理，允许虚拟机通过共享主机的 IP 地址访问互联网，但虚拟机之间不能直接通信。通过端口转发可以实现虚拟机之间的连接。</li></ul></li><li>桥接网络模式<ul><li>桥接网络模式通过虚拟交换机连接虚拟机和主机，使得虚拟机可以通过局域网访问互联网，并允许虚拟机之间直接通信。</li></ul></li><li>内部网络模式<ul><li>内部网络模式使得虚拟机可以创建一个完全隔离的网络，虚拟机之间可以直接通信，但无法访问互联网或外部网络。</li></ul></li><li>仅主机网络模式<ul><li>仅主机网络模式允许虚拟机之间可以通信，并且与主机之间也可以通信，但无法访问互联网或外部网络。</li></ul></li></ul><table><thead><tr><th></th><th>VM &lt;> VM</th><th>VM → HOST</th><th>HOST → VM</th><th>VM → Internet</th><th>Internet → VM</th></tr></thead><tbody><tr><td>网络地址转换 NAT</td><td>×</td><td>√</td><td>×</td><td>√</td><td>×</td></tr><tr><td>NAT 网络</td><td>√</td><td>√</td><td>×</td><td>√</td><td>×</td></tr><tr><td>Bridged Adapter 桥接网卡</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr></tbody></table><h2 id=tuntap-网络设备>TUN/TAP 网络设备<a hidden class=anchor aria-hidden=true href=#tuntap-网络设备>#</a></h2><p>TAP 属于 Linux 内核支持的一种虚拟化网络设备，还有 TUN 也属于这种设备，它们完全由软件模拟实现，TUN/TAP 负责在内核协议栈和用户进程之间传送协议数据单元。TUN 工作在网络层，而 TAP 工作在数据链路层，TUN 负责与应用程序交换 IP 数据包，而 TAP 与应用程序交换以太网帧。所以 TUN 经常涉及路由，而 TAP 常用于网络桥接。</p><h1 id=ssh-远程登录虚拟机>SSH 远程登录虚拟机<a hidden class=anchor aria-hidden=true href=#ssh-远程登录虚拟机>#</a></h1><p>宿主机任意下目录执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>$ ssh-keygen -t rsa
</span></span><span class=line><span class=cl>Generating public/private rsa key pair.
</span></span><span class=line><span class=cl>Enter file in which to save the key <span class=o>(</span>/home/user/.ssh/id_rsa<span class=o>)</span>: host2vm0_id_irsa
</span></span><span class=line><span class=cl>Enter passphrase <span class=o>(</span>empty <span class=k>for</span> no passphrase<span class=o>)</span>: 
</span></span><span class=line><span class=cl>Enter same passphrase again: 
</span></span><span class=line><span class=cl>Your identification has been saved in host2vm0_id_irsa.
</span></span><span class=line><span class=cl>Your public key has been saved in host2vm0_id_irsa.pub.
</span></span><span class=line><span class=cl>The key fingerprint is:
</span></span><span class=line><span class=cl>SHA256:OkWcw+R3x6Z2mzeYQuG033H3N9qIeym3TZKzz6YD8tQ user@ubuntu18
</span></span><span class=line><span class=cl>The key<span class=err>&#39;</span>s randomart image is:
</span></span><span class=line><span class=cl>+---<span class=o>[</span>RSA 2048<span class=o>]</span>----+
</span></span><span class=line><span class=cl><span class=p>|</span>        .        <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       <span class=o>=</span> .   .   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>        B .o. +  <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       . oo.o+   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>        S  ++ ..o<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       o ..+.E<span class=o>=</span><span class=nv>o</span><span class=o>=</span><span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>      o   +..B+<span class=o>=</span>+<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       .   <span class=nv>oo</span><span class=o>=</span>@o+<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>           <span class=nv>o</span><span class=o>=</span>**<span class=o>=</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>+----<span class=o>[</span>SHA256<span class=o>]</span>-----+
</span></span></code></pre></div><p>一直回车确定，生成公私钥，保存在<code>~/.ssh</code>目录下。</p><blockquote><p>我在宿主机上生成的公私钥名称为，分别是<code>host2vm0_id_rsa</code>,<code>host2vm0_id_rsa.pub</code>方便我记忆。如果一直回车，那么生成的公私钥名称为<code>id_rsa</code>，<code>id_rsa.pub</code>。</p></blockquote><p>将公钥复制到虚拟机 <code>VM0</code> 上，以当前虚拟机 <code>VM0</code> 的 IP：<code>10.12.193.53</code> 为例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>$ ssh-copy-id 10.12.193.53
</span></span><span class=line><span class=cl><span class=c1># 输入密码</span>
</span></span><span class=line><span class=cl>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span class=o>(</span>s<span class=o>)</span>, to filter out any that are already installed
</span></span><span class=line><span class=cl>/usr/bin/ssh-copy-id: INFO: <span class=m>1</span> key<span class=o>(</span>s<span class=o>)</span> remain to be installed -- <span class=k>if</span> you are prompted now it is to install the new keys
</span></span><span class=line><span class=cl>user@10.12.193.53<span class=s1>&#39;s password: 
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Number of key(s) added: 1
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Now try logging into the machine, with:   &#34;ssh &#39;</span>10.12.193.53<span class=err>&#39;</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>and check to make sure that only the key(s) you wanted were added.
</span></span></span></code></pre></div><p>然后就可以直接免密码登录了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>ssh user@10.12.193.53
</span></span></code></pre></div><h1 id=fixed-problems-ongoing>Fixed Problems (Ongoing)<a hidden class=anchor aria-hidden=true href=#fixed-problems-ongoing>#</a></h1><h2 id=cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16>cannot ioctl tunsetiff tap0 device or resource busy (errno=16)<a hidden class=anchor aria-hidden=true href=#cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16>#</a></h2><h2 id=failed-to-initialize-tap-device-operation-not-permitted>failed to initialize tap device: Operation not permitted<a hidden class=anchor aria-hidden=true href=#failed-to-initialize-tap-device-operation-not-permitted>#</a></h2><p>同类型错误：failed to create TAP device: Operation not permitted。因为创建虚拟设备 <code>tap</code> 需要 <code>root</code> 权限，所以需要使用 <code>sudo</code> 命令。执行 QEMU 启动是需要添加 <code>sudo</code>。</p><h2 id=qemu-虚拟机启动后网卡处于-down-状态无法获取-ip>QEMU 虚拟机启动后网卡处于 DOWN 状态，无法获取 IP<a hidden class=anchor aria-hidden=true href=#qemu-虚拟机启动后网卡处于-down-状态无法获取-ip>#</a></h2><p>查看是否是 MAC 地址配置错误，使用下面命令检查：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo ifconfig eth0 up
</span></span><span class=line><span class=cl>SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>如果报错，参考下面章节<strong>SIOCSIFFLAGS: Cannot assign requested address</strong>解决方法进行解决。</p><h2 id=虚拟机可以-ping-通外网宿主机无法-ping-外网>虚拟机可以 ping 通外网，宿主机无法 ping 外网<a hidden class=anchor aria-hidden=true href=#虚拟机可以-ping-通外网宿主机无法-ping-外网>#</a></h2><p>这种情况说明基本网络没有问题，只是 DNS 解析有问题，可以通过修改<code>/etc/resolv.conf</code>文件解决。</p><p>海宁 DNS 服务器地址：<code>10.12.2.21</code> 和 <code>10.12.2.22</code>，我的情况是只能 <code>ping 10.12.2.21</code>，可以选择自己能 <code>ping</code> 通的 DNS 服务器地址。如果无法 <code>ping</code> 通，说明问题不在这，需要自行解决。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 修改 DNS 服务器地址</span>
</span></span><span class=line><span class=cl>sudo vim /etc/resolv.conf
</span></span><span class=line><span class=cl><span class=c1># 添加以下内容</span>
</span></span><span class=line><span class=cl>nameserver 10.12.2.21
</span></span><span class=line><span class=cl>nameserver 10.12.2.22
</span></span></code></pre></div><h2 id=网络配置错误如何恢复配置之前的状态>网络配置错误，如何恢复配置之前的状态<a hidden class=anchor aria-hidden=true href=#网络配置错误如何恢复配置之前的状态>#</a></h2><p>最简单的方式 - 重启，因为所有操作都是命令行配置，都是临时配置，可以直接重启解决。</p><p>既然有这一小节，说明肯定有时候不方便直接重启，那么就需要手动恢复配置之前的状态。但是能够恢复的<strong>前提是需要记得之前的网卡 IP 地址、子网掩码、网关、广播地址等信息</strong>。这些信息在局域网里，可能只有 IP 不同，其他信息如果没记住可以查看其他同事的网卡配置即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 将网桥绑定的网卡从网桥上移除</span>
</span></span><span class=line><span class=cl>sudo brctl delif br0 enp2s0
</span></span><span class=line><span class=cl>sudo brctl delif br0 tap0
</span></span><span class=line><span class=cl><span class=c1># 配置宿主机网卡信息，必须一字不差，保持和之前一模一样才能恢复</span>
</span></span><span class=line><span class=cl>sudo ip addr add 10.12.192.173/20 broadcast 10.12.207.255 dev enp2s0
</span></span><span class=line><span class=cl><span class=c1># 必须设置网关</span>
</span></span><span class=line><span class=cl>sudo ip route add default via 10.12.192.1 dev enp2s0
</span></span><span class=line><span class=cl><span class=c1># 重启网络管理器</span>
</span></span><span class=line><span class=cl>systemctl restart NetworkManager
</span></span></code></pre></div><h2 id=-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256>-netdev tap,id=tapnet,script=/qemu-script/qemu-ifup,:network script /qemu-script/qemu-ifup failed with status 256<a hidden class=anchor aria-hidden=true href=#-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256>#</a></h2><p>可能原因 1: <code>qemu-ifup</code> 脚本没有执行权限，需要添加执行权限。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x qemu-ifup
</span></span></code></pre></div><p>可能原因 2: <code>qemu-ifup</code> 路径不对，必须放到<code>/etc/qemu/</code>目录下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /etc/qemu
</span></span><span class=line><span class=cl>mv qemu-ifup /etc/qemu <span class=o>&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span class=line><span class=cl>sudo chmod +x qemu-ifup
</span></span><span class=line><span class=cl>sudo chmod +x qemu-ifdown
</span></span></code></pre></div><h2 id=siocsifflags-cannot-assign-requested-address>SIOCSIFFLAGS: Cannot assign requested address<a hidden class=anchor aria-hidden=true href=#siocsifflags-cannot-assign-requested-address>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo ifconfig eth0 up
</span></span><span class=line><span class=cl>SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>一般由于 MAC 地址配置错误导致，可以通过修改 MAC 地址为多播地址解决。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo ifconfig enp2s0 hw ether 00:11:22:33:44:55
</span></span></code></pre></div><p>重启网卡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>sudo ifconfig enp2s0 down
</span></span><span class=line><span class=cl>sudo ifconfig enp2s0 up
</span></span></code></pre></div><p>MAC 地址的第一个字节中的最后一位（即第 7 位）用于标识该地址是单播，多播还是广播地址。如果这个位设置为 0，则表示这是一个单播地址；如果设置为 1，则表示这是一个多播或广播地址。</p><p>使用这种方法，我们可以确定上述每个 MAC 地址是否是单播地址：</p><ul><li><code>cd:c2:05:84:c8:2c</code> - 单播地址</li><li><code>13:7b:49:fc:a6:aa</code> - 单播地址</li><li><code>8f:aa:42:29:e8:68</code> - 单播地址</li></ul><p><code>00:11:22:33:44:55</code> 是多播地址。</p><h2 id=qemu--device-drive-with-0-bus0-unit0-exists>qemu -device drive with 0 bus=0 unit=0 exists<a hidden class=anchor aria-hidden=true href=#qemu--device-drive-with-0-bus0-unit0-exists>#</a></h2><p>这个错误通常意味着您尝试在 QEMU VM 中添加一个重复的设备。</p><p>如果您已经在 VM 中添加了驱动器，则可能会出现此问题。您可以检查是否存在两个具有相同 <code>bus</code> 和 <code>unit</code> 的设备（在此情况下，都是 0）。解决此问题的方法是删除重复设备或更改其配置以包括唯一的 <code>bus</code> 和 <code>unit</code>。</p><p>如果您没有意图添加重复的设备，在运行 QEMU 之前，您可能需要检查您的命令行，以确保正确设置了 <code>-drive</code> 选项。请注意，当使用 <code>-device</code> 添加设备时，您还应该避免使用 <code>-drive</code> 选项，因为它们可能引起冲突。</p><p>如果您需要进一步帮助，建议提供完整的 QEMU 命令和参数列表，以便更好地理解问题并提供更详细的建议。</p><h1 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h1><ol><li><a href=https://tomwei7.com/2021/10/09/qemu-network-config/>QEMU 网络配置 // 围城</a></li><li><a href=https://www.junmajinlong.com/img/virtual/1594802457384.png>理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙</a></li><li><a href=https://wzt.ac.cn/2021/05/28/QEMU-networking/>QEMU 网络配置一把梭 | CataLpa&rsquo;s Site</a></li><li><a href=https://blog.csdn.net/u014022631/article/details/53411557>qemu 虚拟机与外部网络的通信 li_Jiejun 的博客-CSDN 博客</a></li><li><a href=https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html>安装 qemu-kvm 以及配置桥接网络</a></li><li><a href=https://blog.csdn.net/rikeyone/article/details/106767540>QEMU 中的网络虚拟化配置_程序猿 Ricky 的日常干货的博客-CSDN 博客</a></li><li><a href=https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/QEMU/>Nginx Directory</a></li><li><a href=https://www.cnblogs.com/huqingyu/archive/2005/04/03/131102.html>QEMU 网络配置 - 浙林龙哥 - 博客园</a></li><li><a href=https://zhuanlan.zhihu.com/p/432022126>【qemu】qemu 网络配置 - 知乎</a></li><li><a href=https://tomwei7.com/2021/10/09/qemu-network-config/>QEMU 网络配置 // 围城</a></li><li><a href=https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html>安装 qemu-kvm 以及配置桥接网络</a></li><li><a href=https://blog.virt.ltd/blog/archives/37/>在 qemu 中使用桥接网络 - T^3 Blog</a></li><li><a href=http://wiki.yanick.site/wiki/os/qemu/>为 QEMU 配置网桥上网 | Yanick&rsquo;s Wiki</a></li><li><a href=https://www.junmajinlong.com/virtual/network/all_about_tun_tap/>理解 Linux 虚拟网卡设备 tun/tap 的一切 | 骏马金龙</a></li><li><a href=https://wzt.ac.cn/2021/05/28/QEMU-networking/>QEMU 网络配置一把梭 | CataLpa&rsquo;s Site</a></li></ol><h1 id=附录>附录<a hidden class=anchor aria-hidden=true href=#附录>#</a></h1></div><footer class=post-footer><ul class=post-tags><li><a href=https://lifeislife.cn/tags/qemu/>QEMU</a></li><li><a href=https://lifeislife.cn/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/>虚拟机</a></li><li><a href=https://lifeislife.cn/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/>网络配置</a></li></ul><nav class=paginav><a class=prev href=https://lifeislife.cn/posts/linux%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/><span class=title>« 上一页</span><br><span>Linux 网络配置常用命令</span>
</a><a class=next href=https://lifeislife.cn/posts/%E4%BD%BF%E7%94%A8yadm%E7%AE%A1%E7%90%86%E5%B9%B6%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6dotfile/><span class=title>下一页 »</span><br><span>使用 Yadm 管理并同步配置文件 Dotfile</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on x" href="https://x.com/intent/tweet/?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&amp;hashtags=QEMU%2c%e8%99%9a%e6%8b%9f%e6%9c%ba%2c%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&amp;title=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;summary=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;source=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f&title=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on whatsapp" href="https://api.whatsapp.com/send?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae%20-%20https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on telegram" href="https://telegram.me/share/url?text=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&amp;url=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share QEMU 虚拟机网络配置 on ycombinator" href="https://news.ycombinator.com/submitlink?t=QEMU%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae&u=https%3a%2f%2flifeislife.cn%2fposts%2fqemu%25E8%2599%259A%25E6%258B%259F%25E6%259C%25BA%25E7%25BD%2591%25E7%25BB%259C%25E9%2585%258D%25E7%25BD%25AE%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://lifeislife-1.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2024 <a href=https://lifeislife.cn/>夜云泊</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>