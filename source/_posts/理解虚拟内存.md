---
title: 理解虚拟内存
date: 2022-07-17 21:45:20
updated:
tags: [虚拟内存, TLB, Linux, 内存管理, 页表, 多级页表, MMU]
categories:
---

## 为什么需要虚拟内存？

CPU访问内存的最自然的方式就是使用物理地址，这种方式称为**物理寻址**。1，计算机中并不是只有一个程序在运行，如果它们都是用物理寻址的方式，那么所有程序必须在链接之前确定好自己所用到的内存范围，否则两个程序就可能会发生冲突。2，程序大于内存的问题早在上世纪六十年代就出现，后来出现了**覆盖技术**（Overlay），把程序分割成许多片段。程序开始执行时，将覆盖管理模块装入内存，该管理模块立即装入并运行覆盖0。执行完成后，覆盖0通知管理模块装入覆盖1，或者占用覆盖0的上方位置（如果有空间），或者占用覆盖0（如果没有空间）。把一个大程序分割成小的、模块化的片段是非常费时和枯燥的，并且易于出错。很少程序员擅长使用覆盖技术。

为了更加有效地管理内存并且少出错，现代系统提供了一种对主存的抽象概念，叫做**虚拟内存**(VM)。主要有三个功能：
- 它将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保存活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式，它**高效地使用了主存**。
- 它为每个进程提供了一致的地址空间，从而**简化了内存管理**。
- 它**保护了每个进程**的地址空间不被其他进程破坏。



## 什么是虚拟寻址？

如果主存被分为长度为$M$的单字节大小的数组，每个字节都对应一个物理地址，CPU通过这个唯一的地址访问主存，这样的方式就是**物理寻址**。
![](https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202207212125636.png)
现代处理器使用**虚拟寻址**的方式。CPU通过生成的**虚拟地址**来访问内存，这个地址在送到内存之前会被转换成**物理地址**。这个过程称为**地址翻译**。CPU 芯片上叫做**内存管理单元**（Memory Management Unit, MMU）的专用硬件，利用存放在主存中的**查询表**来动态翻译虚拟地址，该表的内容由操作系统管理。
![](https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202207212128486.png)

[为什么 Linux 需要虚拟内存 - 面向信仰编程](https://draveness.me/whys-the-design-os-virtual-memory/)