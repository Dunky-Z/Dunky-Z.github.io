---
title: 进程间通信（IPC）之信号量（Semaphore）
date: 2021-08-19 15:36:02
tags: [Linux,IPC]
---

## 简介
为了防止出现因多个程序同时访问一个共享资源而引发的一系列问题，我们需要一种方法，它可以通过生成并使用令牌来授权，在任一时刻只能有一个执行线程访问代码的临界区域。临界区域是指执行数据更新的代码需要独占式地执行。而信号量就可以提供这样的一种访问机制，让一个临界区同一时间只有一个线程在访问它，也就是说信号量是用来调协进程对共享资源的访问的。

信号量是一个特殊的变量，程序对其访问都是原子操作，且只允许对它进行等待（即`P`)和发送（即`V`)信息操作。最简单的信号量是只能取0和1的变量，这也是信号量最常见的一种形式，叫做二进制信号量。而可以取多个正整数的信号量被称为通用信号量。这里主要讨论二进制信号量。

由于信号量只能进行两种操作等待和发送信号，即P(sv)和V(sv),他们的行为是这样的：

`P(sv)`：如果`sv`的值大于零，就给它减1；如果它的值为零，就挂起该进程的执行

`V(sv)`：如果有其他进程因等待`sv`而被挂起，就让它恢复运行，如果没有进程因等待`sv`而挂起，就给它加1.

举个例子，就是两个进程共享信号量`sv`，一旦其中一个进程执行了`P(sv)`操作，它将得到信号量，并可以进入临界区，使`sv`减1。而第二个进程将被阻止进入临界区，因为当它试图执行`P(sv)`时，`sv`为0，它会被挂起以等待第一个进程离开临界区域并执行`V(sv)`释放信号量，这时第二个进程就可以恢复执行。


本文[代码同步在这里](https://github.com/Dunky-Z/learning-linux/blob/main/IPC/Semaphore/main.c)。

## 相关函数
Linux提供了一组精心设计的信号量接口来对信号进行操作，它们不只是针对二进制信号量，下面将会对这些函数进行介绍，但请注意，这些函数都是用来对成组的信号量值进行操作的。它们声明在头文件sys/sem.h中。

### `semget()`

它的作用是创建一个新信号量或取得一个已有信号量，原型为：
```c
int semget(key_t key, int num_sems, int sem_flags);
```
- `key`是整数值（唯一非零），不相关的进程可以通过它访问一个信号量，它代表程序可能要使用的某个资源，程序对所有信号量的访问都是间接的，程序先通过调用`semget()`函数并提供一个键，再由系统生成一个相应的信号标识符（`semget()`函数的返回值），只有`semget()`函数才直接使用信号量键，所有其他的信号量函数使用由`semget()`函数返回的信号量标识符。如果多个程序使用相同的`key`值，`key`将负责协调工作。

- `num_sems`指定需要的信号量数目，它的值几乎总是1。

- `sem_flags`是一组标志，当想要当信号量不存在时创建一个新的信号量，可以和值`IPC_CREAT`做按位或操作。设置了`IPC_CREAT`标志后，即使给出的键是一个已有信号量的键，也不会产生错误。而`IPC_CREAT | IPC_EXCL`则可以创建一个新的，唯一的信号量，如果信号量已存在，返回一个错误。

`semget()`函数成功返回一个相应信号标识符（非零），失败返回`-1`.

### `semop()`

它的作用是改变信号量的值，原型为：
```c
int semop(int sem_id, struct sembuf *sem_opa, size_t num_sem_ops);
```
- `sem_id`是由`semget()`返回的信号量标识符，`sembuf`结构的定义如下：
    ```c
    struct sembuf{
        short sem_num; // 除非使用一组信号量，否则它为0
        short sem_op;  // 信号量在一次操作中需要改变的数据，通常是两个数，一个是-1，即P（等待）操作，
                    // 一个是+1，即V（发送信号）操作。
        short sem_flg; // 通常为SEM_UNDO,使操作系统跟踪信号，
                    // 并在进程没有释放该信号量而终止时，操作系统释放信号量
    };
    ```
- `num_sem_ops`：操作`sops`中的操作个数，通常取值为1
### `semctl()`

该函数用来直接控制信号量信息，它的原型为：
```c
int semctl(int sem_id, int sem_num, int command, ...);
```
- 如果有第四个参数，它通常是一个`union semum`结构，定义如下：
    ```c
    union semun {
        int val;
        struct semid_ds *buf;
        unsigned short *arry;
    };
    ```
- 前两个参数与前面一个函数中的一样，`command`通常是下面两个值中的其中一个

- `SETVAL`：用来把信号量初始化为一个已知的值。p 这个值通过union semun中的val成员设置，其作用是在信号量第一次使用前对它进行设置。

- `IPC_RMID`：用于删除一个已经无需继续使用的信号量标识符。