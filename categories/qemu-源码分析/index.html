<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=8888&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>QEMU 源码分析 | PaperMod</title>
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:8888/categories/qemu-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:8888/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:8888/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:8888/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:8888/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:8888/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="http://localhost:8888/categories/qemu-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.xml">
<link rel="alternate" hreflang="en" href="http://localhost:8888/categories/qemu-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:8888/" accesskey="h" title="PaperMod (Alt + H)">PaperMod</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:8888/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:8888/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="http://localhost:8888/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:8888/categories/">Categories</a></div>
  <h1>
    QEMU 源码分析
  </h1>
</header>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">QEMU 常用命令
    </h2>
  </header>
  <div class="entry-content">
    <p>QEMU 是一个开源的虚拟化软件，它能够模拟不同的硬件平台，让用户在不同的操作系统之间进行切换和测试。以下是 QEMU 常用命令的总结文档，包含每个命令的功能说明。
QEMU 安装 源码下载 压缩包方式 版本可以修改
cd qemu-build &amp;&amp; wget &#34;https://download.qemu.org/qemu-8.0.2.tar.xz&#34; tar -xf qemu-8.0.2.tar.xz --strip-components=1 Clone 方式 git clone https://gitlab.com/qemu-project/qemu.git cd qemu git submodule init git submodule update --recursive 配置编译选项 ./configure --target-list=riscv32-softmmu,riscv32-linux-user,riscv64-linux-user,riscv64-softmmu \ --enable-kvm \ --enable-debug \ --enable-sdl \ --prefix=/home/user/program/riscv64-qemu \ --python=/usr/bin/python3 # --python=python路径，如果提示默认python版本低，可以加这个参数 # --prefix 选项设置qemu的安装位置绝对路径，之后若要卸载删除qemu只要删除该文件夹即可，--enable-kvm开启kvm # config完，可以在指定的qemu安装文件夹下面找到config-host.mak文件， # 该文件记录着qemu配置的选项，可以和自己设置的进行对比，确保配置和自己已知 一些常用的编译选项 –enable-debug：编译调试版本，调试版本的运行速度非常慢 –disable-werror：忽略警告，否则任何编译警告都被视为编译错误 –enable-plugins：开启TCG Plugin支持 –disable-stack-protector：关闭QEMU自身的栈保护 –extra-cflags=&#34;-O3&#34;：能让你的QEMU提速5~10%，如果编译时报错，请加上--disable-werror –prefix=&lt;路径&gt;：指定安装目录的路径 –target-list=&lt;架构&gt;：指定要编译的目标架构列表，例如 x86_64-softmmu,arm-softmmu。 –enable-&lt;功能&gt;：启用指定的功能。例如，--enable-kvm 启用 KVM 支持，--enable-gtk 启用 GTK 图形界面等。 –disable-&lt;功能&gt;：禁用指定的功能。 –enable-debug：启用调试模式，包括调试符号和调试输出。 –enable-virtfs：启用 virtio 文件系统支持。 –enable-modules：启用模块支持。 –disable-guest-agent：禁用客户机代理支持。 –enable-trace-backend=&lt;后端&gt;：指定跟踪后端，例如 simple、log 或 dtrace。 –disable-vhost-net：禁用 vhost-net 支持。 编译时输出....</p>
  </div>
  <footer class="entry-footer"><span title='2024-07-07 10:22:12 +0000 UTC'>July 7, 2024</span>&nbsp;·&nbsp;2 min</footer>
  <a class="entry-link" aria-label="post link to QEMU 常用命令" href="http://localhost:8888/posts/qemu%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">QEMU 虚拟机网络配置
    </h2>
  </header>
  <div class="entry-content">
    <p>Quick Setup 安装工具 安装两个网络管理工具用于建立网桥以及虚拟网卡：
# 安装虚拟网桥工具 sudo apt install bridge-utils -y # UML（User-mode linux）工具 sudo apt install uml-utilities -y 配置脚本 qemu-ifup 将下面的脚本保存为文件 qemu-ifup，并赋予可执行权限：
为了方便复制脚本，在 confluence 页面提供了脚本内容，可以直接复制。
mkdir -p /etc/qemu mv qemu-ifup /etc/qemu &amp;&amp; mv qemu-ifdown /etc/qemu sudo chmod &#43;x qemu-ifup sudo chmod &#43;x qemu-ifdown 因为网卡信息不容易定位，可能一台机器有多个网卡，所以不方便用脚本获取，需要手动设置一下。将下面的NIC值修改为宿主机可以上网的网卡名称。可以通过ifconfig命令查看。
#!/bin/bash # 设置默认网卡信息 NIC=enp2s0 # 设置用户名 USER_NAME=user # 设置网桥名称 BRIDGE=br0 # 设置网络信息 NIC_IP=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $2}&#39;) NIC_NETMAST=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $4}&#39;) NIC_BROADCAST=$(ifconfig $NIC | grep &#34;inet\b&#34; | awk &#39;{print $6}&#39;) NETMASK=255....</p>
  </div>
  <footer class="entry-footer"><span title='2023-08-05 14:47:54 +0000 UTC'>August 5, 2023</span>&nbsp;·&nbsp;14 min</footer>
  <a class="entry-link" aria-label="post link to QEMU 虚拟机网络配置" href="http://localhost:8888/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">QEMU&#39;s instance_init() vs. realize()
    </h2>
  </header>
  <div class="entry-content">
    <p>转载自huth (Thomas Huth)的一篇文章，原文已经 404，从网页快照中找回的文章。
Note that this is a blog post for (new) QEMU developers. If you are just interested in using QEMU, you can certainly skip this text. Otherwise, in case you have ever been in touch with the QEMU device model (“qdev”), you are likely aware of the basic qdev code boilerplate already:
static void mydev_realize(DeviceState *dev, Error **errp) { } static void mydev_instance_init(Object *obj) { } static Property mydev_properties[] = { DEFINE_PROP_xxx(&#34;myprop&#34;, MyDevState, field, ....</p>
  </div>
  <footer class="entry-footer"><span title='2022-11-01 09:51:28 +0000 UTC'>November 1, 2022</span>&nbsp;·&nbsp;6 min</footer>
  <a class="entry-link" aria-label="post link to QEMU&#39;s instance_init() vs. realize()" href="http://localhost:8888/posts/qemu-s-instance-init-vs-realize/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">QEMU 源码分析-QOM
    </h2>
  </header>
  <div class="entry-content">
    <p>QOM 简介 QOM(QEMU Object Model) 是 QEMU 的一个模块，用于描述虚拟机的结构，包括虚拟机的 CPU、内存、硬盘、网络、输入输出设备等。QEMU 为了方便整个系统的构建，实现了自己的一套的面向对象机制，也就是 QOM(QEMU Object Model)。它能够方便的表示各个设备（Device）与总线（Bus）之间的关系。
这个模型主要包含四个结构体：
Object: 是所有对象的 基类 Base Object ObjectClass: 是所有类对象的基类 TypeInfo：是用户用来定义一个 Type 的工具型的数据结构 TypeImpl：TypeInfo 抽象数据结构，TypeInfo 的属性与 TypeImpl 的属性对应 在 QEMU 里要初始化一个对象需要完成四步：
将 TypeInfo 注册 TypeImpl 实例化 Class（ObjectClass） 实例化 Object 添加 Property QOM 中的面向对象 继承 在 QEMU 中通过 TypeInfo 来定义一个类。
例如 x86_base_cpu_type_info 就是一个 class，
static const TypeInfo x86_base_cpu_type_info = { .name = X86_CPU_TYPE_NAME(&#34;base&#34;), .parent = TYPE_X86_CPU, .class_init = x86_cpu_base_class_init, }; 利用结构体包含来实现继承。这应该是所有的语言实现继承的方法，在 C&#43;&#43; 中，结构体包含的操作被语言内部实现了，而 C 语言需要自己实现。...</p>
  </div>
  <footer class="entry-footer"><span title='2022-03-09 16:02:19 +0000 UTC'>March 9, 2022</span>&nbsp;·&nbsp;5 min</footer>
  <a class="entry-link" aria-label="post link to QEMU 源码分析-QOM" href="http://localhost:8888/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-qom/"></a>
</article>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2 class="entry-hint-parent">QEMU 源码分析-内存虚拟化
    </h2>
  </header>
  <div class="entry-content">
    <p>1.大部分转载自QEMU 内存虚拟化源码分析 | Keep Coding | 苏易北 2.原文源码为 QEMU1.2.0，版本较旧，部分源码内容根据 QEMU6.2 版本修改 3.部分内容根据自己理解补充添加
概述 我们知道操作系统给每个进程分配虚拟内存，通过页表映射，变成物理内存进行访问。当有了虚拟机之后，情况会变得更加复杂。因为虚拟机对于物理机来讲是一个进程，但是虚拟机里面也有内核，也有虚拟机里面跑的进程。所以有了虚拟机，内存就变成了四类：
虚拟机里面的虚拟内存（Guest OS Virtual Memory，GVA），这是虚拟机里面的进程看到的内存空间； 虚拟机里面的物理内存（Guest OS Physical Memory，GPA），这是虚拟机里面的操作系统看到的内存，它认为这是物理内存； 物理机的虚拟内存（Host Virtual Memory，HVA），这是物理机上的 qemu 进程看到的内存空间； 物理机的物理内存（Host Physical Memory，HPA），这是物理机上的操作系统看到的内存。 内存虚拟化的关键在于维护 GPA 到 HVA 的映射关系。
页面分配和映射的两种方式 要搞清楚 QEMU system emulation 的仿真架构，首先对于 Host OS，将 QEMU 作为进程启动，然后对于 QEMU 进程，会仿真各种硬件和运行 Guest OS，在这层 OS 上运行要全系统模拟的应用程序，因此对于 Guest OS 管理的内存要实现到 QEMU 进程的虚拟空间的转换需要 softMMU（即需要对 GPA 到 HVA 进行转换）。从 GVA 到 GPA 到 HVA 到 HPA，性能很差，为了解决这个问题，有两种主要的思路。
影子页表 Shadow Page Table，SPT 第一种方式就是软件的方式，影子页表（Shadow Page Table）。...</p>
  </div>
  <footer class="entry-footer"><span title='2022-01-25 13:42:11 +0000 UTC'>January 25, 2022</span>&nbsp;·&nbsp;17 min</footer>
  <a class="entry-link" aria-label="post link to QEMU 源码分析-内存虚拟化" href="http://localhost:8888/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="next" href="http://localhost:8888/categories/qemu-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/page/2/">Next&nbsp;&nbsp;»
    </a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:8888/">PaperMod</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
