<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">





    <meta property="og:type" content="website">
<meta property="og:title" content="如云泊">
<meta property="og:url" content="https://lifeislife.cn/index.html">
<meta property="og:site_name" content="如云泊">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Dominic">
<meta name="twitter:card" content="summary">





<link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PS8L2EEEPR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PS8L2EEEPR');
</script>


    


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="index.html">
                
                <img src="images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜索" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/Dunky-Z">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/03/03/RemoteX11-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E5%B8%A6GUI%E5%BA%94%E7%94%A8/" itemprop="url">RemoteX11 远程调试带GUI应用</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-03-03T12:45:56.000Z" itemprop="datePublished">3月 3 2024</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 读完 (约 295 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>Windows上通过WSL2进行Linux开发，但是有时候需要开发带GUI的引用，这样就需要将图像转发。</p>
<h2 id="配置Windows"><a href="#配置Windows" class="headerlink" title="配置Windows"></a>配置Windows</h2><p>下载安装XMing，启动Xlaunch。</p>
<ol>
<li>选择MultiWindow</li>
<li>设置Display number为10（可以自行设置，主要是需要和后面在WSL2中设置的变量保持一致）</li>
<li>选择Start no client（Windows的XMing是被动等待接收图像数据，所以选择该项）</li>
<li>一直下一页，其余保持默认，点击完成即可。</li>
</ol>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/03/b1fa974ebfa7e08576cc61bce4307640.png"></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/03/b0a29ceb2b30d4dc68a9d969859698c3.png"></p>
<h2 id="配置VSCode"><a href="#配置VSCode" class="headerlink" title="配置VSCode"></a>配置VSCode</h2><p>安装RemoteX11插件，直接在插件中心搜索安装即可。</p>
<p>打开设置页面，搜索Remote x11，找到如下配置项，将Display Number配置为10</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/03/6bf072325b38892eda270dabf4d3a1be.png"></p>
<h2 id="配置WSL2"><a href="#配置WSL2" class="headerlink" title="配置WSL2"></a>配置WSL2</h2><p>安装xclock用于测试</p>
<pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">sudo apt-get install xclock<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>设置环境变量</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">export DISPLAY=localhost:10.0
# 或者
export DISPLAY=:0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>运行xclock查看结果</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/03/2e35553c8672c1bd92e4320b2d88d562.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></body></html>
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/03/02/%E8%A7%A3%E5%86%B3%E7%B3%BB%E7%BB%9F%E4%BE%9D%E8%B5%96%E9%94%99%E8%AF%AFGLIBCXX-3-4-29-not-found/" itemprop="url">解决系统依赖错误GLIBCXX_3.4.29 not found</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-03-02T14:21:23.000Z" itemprop="datePublished">3月 2 2024</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="categories/Bug-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/">Bug 踩坑记录</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            5 分钟 读完 (约 685 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>以前对软件包的构建不太了解，喜欢随意修改软件源列表，软件源和当前系统的版本不一致就会出现安装了一个依赖较多的软件包后会出现连锁反应，修改了所有依赖的软件包版本，导致系统故障。最常出现的就是修改了GCC版本，导致GLIBCXX版本不一致，导致系统软件无法运行。</p>
<p>如果你的系统还能正常安装软件，那么修改软件源和当前系统版本保存一致，然后更新软件，并重新安装GCC即可解决问题。具体步骤如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改软件源</span>
<span class="token function">sudo</span> <span class="token function">vim</span> /etc/apt/sources.list
<span class="token comment"># 检查当前系统版本</span>
lsb_release -a
<span class="token comment"># 将软件源修改为当前系统版本的软件源，Ubuntu系统版本号对应的软件源列表可以在https://wiki.ubuntu.com/Releases查看</span>
<span class="token comment"># 更新软件</span>
<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token comment"># 安装GCC，build-essential包含了GCC</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你和我一样倒霉，连 apt 都无法使用，那么可以使用 dpkg 命令手动安装 GCC。</p>
<p>因为误操作在 Ubuntu 20.04 上安装了 Ubuntu 18.04 的 GCC，导致系统软件无法运行，apt 也无法使用，所以只能手动安装 GCC。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apt: libx86_64-linux-gnu-libstdc++.so.6: version `GLIBCXX_3.4.29' not found <span class="token punctuation">(</span>required by libx86_64-linux-gnulibapt-private.so.0.0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>既然libstdc++版本不一致，我们就去下载对应版本的GCC，访问<a target="_blank" rel="noopener" href="https://packages.ubuntu.com/%EF%BC%8C%E5%9C%A8%E4%B8%8B%E6%96%B9%E7%9A%84%E6%90%9C%E7%B4%A2%E6%A1%86%E4%B8%AD%E8%BE%93%E5%85%A5libstdc++6%EF%BC%8C%E9%80%89%E6%8B%A9%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%EF%BC%8C%E7%84%B6%E5%90%8E%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84GCC%E3%80%82">https://packages.ubuntu.com/，在下方的搜索框中输入libstdc++6，选择对应的系统版本，然后下载对应的GCC。</a></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/02/64ad9d26ea0d40d39a17330698dd805d.png"></p>
<p>点击搜索结果，点击系统的架构，一般为amd64，</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/02/4965061df423ae7897faa87cce2a5fc6.png"></p>
<p>具体下载地址比较隐蔽，直接点击红框的链接没有反应，你可以右键另存为到本地，我习惯复制链接后用wget下载。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/03/02/b69d28c1b5515dd8898213332baa9b99.png"></p>
<p>下载完成后，使用dpkg命令安装GCC。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> dpkg -i libstdc++6_12.3.0-1ubuntu1<span class="token punctuation">\</span>~22.04_amd64.deb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>之后可以检查一下缺失的GLIBCXX版本已经安装。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ strings /lib/x86_64-linux-gnu/libstdc++.so.6 <span class="token operator">|</span> <span class="token function">grep</span> GLIBCXX                               
GLIBCXX_3.4
GLIBCXX_3.4.1
GLIBCXX_3.4.2
GLIBCXX_3.4.3
GLIBCXX_3.4.4
GLIBCXX_3.4.5
GLIBCXX_3.4.6
GLIBCXX_3.4.7
GLIBCXX_3.4.8
GLIBCXX_3.4.9
GLIBCXX_3.4.10
GLIBCXX_3.4.11
GLIBCXX_3.4.12
GLIBCXX_3.4.13
GLIBCXX_3.4.14
GLIBCXX_3.4.15
GLIBCXX_3.4.16
GLIBCXX_3.4.17
GLIBCXX_3.4.18
GLIBCXX_3.4.19
GLIBCXX_3.4.20
GLIBCXX_3.4.21
GLIBCXX_3.4.22
GLIBCXX_3.4.23
GLIBCXX_3.4.24
GLIBCXX_3.4.25
GLIBCXX_3.4.26
GLIBCXX_3.4.27
GLIBCXX_3.4.28
GLIBCXX_3.4.29
GLIBCXX_3.4.30
GLIBCXX_DEBUG_MESSAGE_LENGTH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时apt 应该就可以正常使用了，我们只需要修复一下所有软件包，让它回到正确的版本即可恢复系统。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> --fix-broken <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/17/repo%E6%BA%90%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90/" itemprop="url">repo源配置解析</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-17T13:32:04.000Z" itemprop="datePublished">1月 17 2024</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            14 分钟 读完 (约 2166 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="repo-源配置解析"><a href="#repo-源配置解析" class="headerlink" title="repo 源配置解析"></a>repo 源配置解析</h1><p>openEuler 的软件源配置文件位于/etc/yum.repos.d/目录下，以.repo 为后缀名，文件名可以任意取，但是必须以.repo 结尾。</p>
<pre class="line-numbers language-repo" data-language="repo"><code class="language-repo">#generic-repos is licensed under the Mulan PSL v2.
#You can use this software according to the terms and conditions of the Mulan PSL v2.
#You may obtain a copy of Mulan PSL v2 at:
#    http:&#x2F;&#x2F;license.coscl.org.cn&#x2F;MulanPSL2
#THIS SOFTWARE IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR
#PURPOSE.
#See the Mulan PSL v2 for more details.

[OS]
name&#x3D;OS
baseurl&#x3D;http:&#x2F;&#x2F;repo.openeuler.org&#x2F;openEuler-23.09&#x2F;OS&#x2F;$basearch&#x2F;
metalink&#x3D;https:&#x2F;&#x2F;mirrors.openeuler.org&#x2F;metalink?repo&#x3D;$releasever&#x2F;OS&amp;arch&#x3D;$basearch
metadata_expire&#x3D;1h
enabled&#x3D;1
gpgcheck&#x3D;1
gpgkey&#x3D;http:&#x2F;&#x2F;repo.openeuler.org&#x2F;openEuler-23.09&#x2F;OS&#x2F;$basearch&#x2F;RPM-GPG-KEY-openEuler

[source]
name&#x3D;source
baseurl&#x3D;http:&#x2F;&#x2F;repo.openeuler.org&#x2F;openEuler-23.09&#x2F;source&#x2F;
metalink&#x3D;https:&#x2F;&#x2F;mirrors.openeuler.org&#x2F;metalink?repo&#x3D;$releasever&amp;arch&#x3D;source
metadata_expire&#x3D;1h
enabled&#x3D;1
gpgcheck&#x3D;1
gpgkey&#x3D;http:&#x2F;&#x2F;repo.openeuler.org&#x2F;openEuler-23.09&#x2F;source&#x2F;RPM-GPG-KEY-openEuler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中各个配置项的含义如下：</p>
<ul>
<li>[repoid]中的 repoid 为软件仓库（repository）的 ID 号，所有.repo 配置文件中的各 repoid 不能重复，必须唯一。示例中 repoid 为 OS 和 source。</li>
<li>name 为软件仓库描述的字符串，可以任意取，但是建议取一个有意义的名称，方便用户理解。示例中 name 为 OS 和 source。</li>
<li>baseurl 为软件仓库的地址，可以是 http、https、ftp 等协议，也可以是本地目录。</li>
<li>enabled 为是否启用该软件源仓库，可选值为 1 和 0。默认值为 1，表示启用该软件源仓库。示例中 enabled 为 1。</li>
<li>metalink 为动态的镜像地址，用于镜像加速。</li>
<li>metadata_expire 为元数据过期时间，单位为秒。默认值为 90 分钟，即 5400 秒。示例中 metadata_expire 为 1h，即 1 小时。</li>
<li>gpgcheck 可设置为 1 或 0，1 表示进行 gpg（GNU Private Guard）校验，0 表示不进行 gpg 校验，gpgcheck 可以确定 rpm 包的来源是有效和安全的。</li>
<li>gpgkey 为验证签名用的公钥地址，如果 gpgcheck 为 1，则必须设置 gpgkey。</li>
</ul>
<h2 id="gpgcheck-详解"><a href="#gpgcheck-详解" class="headerlink" title="gpgcheck 详解"></a>gpgcheck 详解</h2><p><code>RPM-GPG-KEY</code> 是一个公共密钥，用于验证由该密钥签名的RPM包的真实性和完整性。在使用 <code>yum</code> 或 <code>dnf</code> 这样的包管理工具时，这些工具会使用 GPG 密钥来验证软件包的签名，以确保软件包来自于可信的源，且未被篡改。</p>
<ol>
<li><p><strong>命名约定：</strong> <code>RPM-GPG-KEY</code> 是一个命名约定，通常与其所属的仓库或发行版相关。例如，如果你在使用某个特定发行版的官方仓库，它可能会提供一个 <code>RPM-GPG-KEY</code> 文件来进行软件包签名验证。如openEuler官方仓库提供的 <code>RPM-GPG-KEY</code> 文件名为 <code>RPM-GPG-KEY-openEuler</code>。</p>
</li>
<li><p><strong>密钥生成：</strong> 这个密钥是通过 GPG（GNU Privacy Guard）工具生成的。GPG 是一个用于进行加密和签名的开源工具。<code>RPM-GPG-KEY</code> 文件包含了一个公钥，该公钥由仓库所有者使用私钥签署软件包，而用户使用公钥验证软件包。</p>
</li>
<li><p><strong>验证软件包：</strong> 当用户使用 <code>yum</code> 或 <code>dnf</code> 安装软件包时，这些工具会检查软件包的签名，并使用相应的 <code>RPM-GPG-KEY</code> 文件中的公钥来验证签名。如果验证通过，工具会认为软件包是可信的，否则将会发出警告或拒绝安装。</p>
</li>
<li><p><strong>导入密钥：</strong> 为了使用 <code>RPM-GPG-KEY</code> 文件，用户通常需要将密钥导入到本地系统中。这通常可以通过运行类似于以下命令的导入密钥的操作来完成：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> --import /etc/pki/rpm-gpg/RPM-GPG-KEY-openEuler<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 上述命令中的 <code>/etc/pki/rpm-gpg/RPM-GPG-KEY-openEuler</code> 路径可能会因发行版和配置而有所不同。</p>
</li>
</ol>
<h2 id="RPM包签名"><a href="#RPM包签名" class="headerlink" title="RPM包签名"></a>RPM包签名</h2><p>对于发布的 RPM 包进行 GPG 签名是一种重要的安全措施，可以确保接收者能够验证软件包的真实性和完整性。以下是一般的步骤：</p>
<ol>
<li><p><strong>生成 GPG 密钥：</strong> 如果你还没有 GPG 密钥对，你需要使用 GPG 工具生成一对密钥，包括私钥和公钥。你可以运行以下命令来生成密钥：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gpg --gen-key <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 当你运行 <code>gpg --gen-key</code> 命令时，它会启动 GPG（GNU Privacy Guard）的密钥生成过程。这个过程将引导你提供一些必要的信息以生成密钥对，包括私钥和公钥。以下是这个命令的详细步骤：</p>
<ul>
<li><p><strong>选择密钥类型：</strong> 你将被要求选择密钥的类型。通常，默认的 RSA 和 DSA 都是可接受的选择，你可以通过键入数字来选择。</p>
</li>
<li><p><strong>选择密钥大小：</strong> 你将被要求选择密钥的大小。通常，默认值（通常是2048位）是足够的，但你也可以选择更大的值。</p>
</li>
<li><p><strong>选择密钥的有效期：</strong> 你将被要求选择密钥的有效期。你可以选择密钥永久有效，或者在一段特定的时间内有效。如果你选择了特定的时间，你需要输入一个表示有效期的值，例如1y表示一年，1m表示一个月。</p>
</li>
<li><p><strong>提供用户标识信息：</strong> 你将被要求提供与密钥相关联的用户标识信息。这包括你的真实姓名、电子邮件地址和一个可选的注释。</p>
</li>
<li><p><strong>确认提供的信息：</strong> GPG 将显示你提供的信息并询问你是否确认。如果确认无误，你可以输入 <code>O</code> 或直接按回车键。</p>
</li>
<li><p><strong>输入保护密语（passphrase）：</strong> 你将被要求输入保护密语，用于保护你的私钥。请确保选择一个强密码。</p>
</li>
<li><p><strong>等待密钥生成：</strong> GPG 将使用提供的信息生成密钥对。这可能需要一些时间，具体取决于你选择的密钥大小。</p>
</li>
<li><p><strong>生成完成：</strong> 一旦生成完成，你将看到一条消息表明密钥生成成功。</p>
</li>
</ul>
<p> 在整个过程中，你将看到类似以下的一些提示：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gpg: key ABCDEFGH marked as ultimately trusted
gpg: revocation certificate stored as <span class="token string">'/home/your_user/.gnupg/openpgp-revocs.d/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.rev'</span>
public and secret key created and signed.

gpg: checking the trustdb
gpg: <span class="token number">3</span> marginal<span class="token punctuation">(</span>s<span class="token punctuation">)</span> needed, <span class="token number">1</span> complete<span class="token punctuation">(</span>s<span class="token punctuation">)</span> needed, PGP trust model
gpg: depth: <span class="token number">0</span>  valid:   <span class="token number">2</span>  signed:   <span class="token number">0</span>  trust: <span class="token number">0</span>-, 0q, 0n, 0m, 0f, 2u
pub   2048R/XXXXXXXX <span class="token number">2024</span>-01-01 <span class="token punctuation">[</span>expires: <span class="token number">2024</span>-01-01<span class="token punctuation">]</span>
    Key fingerprint <span class="token operator">=</span> XXXX YYYY ZZZZ AAAA BBBB  CCCC DDDD EEEE FFFF <span class="token number">1111</span>
uid                  Your Name <span class="token operator">&lt;</span>your.email@example.com<span class="token operator">></span>
sub   2048R/YYYYYYYY <span class="token number">2024</span>-01-01 <span class="token punctuation">[</span>expires: <span class="token number">2024</span>-01-01<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 在这个例子中，<code>XXXXXXXX</code> 是你的密钥 ID，<code>YYYYYYYY</code> 是子密钥的 ID。你可以使用这些 ID 来引用你的密钥。</p>
</li>
<li><p><strong>导出公钥：</strong> 生成密钥后，你需要将公钥导出。运行以下命令：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gpg --output RPM-GPG-KEY-your-repo --armor --export your@email.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这将生成一个 ASCII 格式的公钥文件 <code>RPM-GPG-KEY-your-repo</code>，你可以与软件包一起发布。</p>
</li>
<li><p><strong>为 RPM 包签名：</strong> 在构建 RPM 包时，使用 <code>rpmbuild</code> 命令时，可以通过添加 <code>--sign</code> 选项来指示 <code>rpmbuild</code> 对 RPM 包进行签名。例如：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rpmbuild -ba your-package.spec --sign<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 当你执行 <code>rpmbuild -ba your-package.spec --sign</code> 命令时，<code>rpmbuild</code> 会使用默认的 GPG 密钥进行签名。这通常是你在系统上配置为默认 GPG 密钥的密钥。</p>
<p> 你可以通过检查 <code>rpmbuild</code> 使用的 GPG 密钥来确认它是哪个密钥：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> -q gpg-pubkey --qf <span class="token string">'%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125; --> %&#123;summary&#125;\n'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这个命令将显示系统上安装的 GPG 公钥，其中默认的密钥可能是 “gpg-pubkey-xxxxxxxx-yyyyyyyy”。你可以根据密钥的 “xxxxxxxx-yyyyyyyy” 部分来确定默认使用的 GPG 密钥。</p>
<p> 如果你想使用不同的 GPG 密钥进行签名，可以在 <code>rpmbuild</code> 命令中使用 <code>--signwith</code> 选项，例如：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">rpmbuild -ba your-package.spec --signwith <span class="token operator">&lt;</span>key-id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 其中 <code>&lt;key-id&gt;</code> 是你想要使用的 GPG 密钥的 ID。这会覆盖默认的密钥。确保你在构建和签名 RPM 包时使用的是正确的 GPG 密钥。</p>
</li>
<li><p><strong>导入密钥：</strong> 为了验证你的软件包，用户需要导入你的公钥。他们可以运行以下命令：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> --import RPM-GPG-KEY-your-repo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p><strong>发布：</strong> 将签名的 RPM 包和公钥一起发布。确保用户知道他们可以使用导入的公钥来验证软件包的签名。</p>
</li>
</ol>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/13/Linux%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E6%A0%A1%E9%AA%8C%E6%9C%BA%E5%88%B6/" itemprop="url">Linux内核模块校验机制</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-13T14:00:16.000Z" itemprop="datePublished">1月 13 2024</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            23 分钟 读完 (约 3484 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>初学 Linux 内核或者第一次编译使用内核模块时经常会遇到类似这样的错误：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod: ERROR: could not insert module kvm.ko: Invalid module <span class="token function">format</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个报错通常由于当前插入<code>kvm.ko</code>的<code>version magic</code>版本信息与正在运行的 kernel 的<code>version magic</code>版本不一致导致的。</p>
<h1 id="内核校验模块的流程"><a href="#内核校验模块的流程" class="headerlink" title="内核校验模块的流程"></a>内核校验模块的流程</h1><p>我们从问题出发，看看内核是如何校验模块的。搜索了内核源码，找到了在函数<code>check_version</code>中抛出了<code>disagrees about version of symbol</code>错误信息，我们根据源码来回溯一下整个过程。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">check_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>symname<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">,</span>
    <span class="token keyword">const</span> s32 <span class="token operator">*</span>crc<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 Elf_Shdr <span class="token operator">*</span>sechdrs <span class="token operator">=</span> info<span class="token operator">-></span>sechdrs<span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> versindex <span class="token operator">=</span> info<span class="token operator">-></span>index<span class="token punctuation">.</span>vers<span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> num_versions<span class="token punctuation">;</span>
 <span class="token keyword">struct</span> <span class="token class-name">modversion_info</span> <span class="token operator">*</span>versions<span class="token punctuation">;</span>

 <span class="token comment">/* Exporting module didn't supply crcs?  OK, we're already tainted. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>crc<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

 <span class="token comment">/* No versions at all?  modprobe --force does this. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>versindex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">try_to_force_load</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> symname<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>

 versions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> sechdrs<span class="token punctuation">[</span>versindex<span class="token punctuation">]</span><span class="token punctuation">.</span>sh_addr<span class="token punctuation">;</span>
 num_versions <span class="token operator">=</span> sechdrs<span class="token punctuation">[</span>versindex<span class="token punctuation">]</span><span class="token punctuation">.</span>sh_size
  <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">modversion_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_versions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u32 crcval<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token keyword">continue</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_MODULE_REL_CRCS<span class="token punctuation">)</span><span class="token punctuation">)</span>
   crcval <span class="token operator">=</span> <span class="token function">resolve_rel_crc</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
   crcval <span class="token operator">=</span> <span class="token operator">*</span>crc<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>crc <span class="token operator">==</span> crcval<span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Found checksum %X vs module %lX\n"</span><span class="token punctuation">,</span>
    crcval<span class="token punctuation">,</span> versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">goto</span> bad_version<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">/* Broken toolchain. Warn once, then let it go.. */</span>
 <span class="token function">pr_warn_once</span><span class="token punctuation">(</span><span class="token string">"%s: no symbol version for %s\n"</span><span class="token punctuation">,</span> info<span class="token operator">-></span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

bad_version<span class="token operator">:</span>
 <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"%s: disagrees about version of symbol %s\n"</span><span class="token punctuation">,</span>
        info<span class="token operator">-></span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数说明：</p>
<ul>
<li>info: 包含正在加载信息的结构体。</li>
<li>symname: 需要查找对比的符号的名称。</li>
<li>mod: 表示模块的结构体。</li>
<li>crc: 当前正在运行的内核的模块符号的 CRC（Cyclic Redundancy Check）值</li>
</ul>
<ol>
<li>如果 CRC 为空，不检查直接 PASS</li>
<li>如果模块中没有_versions 小节，表示模块没有开启 CRC<ol>
<li>如果开启了 CONFIG_MODULE_FORCE_LOAD，则强制加载，内核标记为 tainted，直接 PASS</li>
<li>如果没有开启 CONFIG_MODULE_FORCE_LOAD，则报错</li>
</ol>
</li>
<li>如果模块中有_versions 小节，没有找到 module_layout 符号，报 warning，直接 PASS</li>
<li>如果模块中有_versions 小节，找到 module_layout 符号<ol>
<li>对比_versions 小节中的 CRC 和参数中的 CRC，如果一致，PASS</li>
<li>如果不一致，报错</li>
</ol>
</li>
</ol>
<blockquote>
<p>插播一句，CRC是什么？在 Linux 内核中，模块符号 CRC（Cyclic Redundancy Check）是一种校验值，用于确保模块中的符号（函数、变量等）在加载时与内核中的符号一致。当模块被构建时，针对每个符号都会计算一个 CRC 值，然后将这些 CRC 值保存在模块的符号版本表中。简单理解就是如果要保持CRC不变，需要满足两个条件：</p>
<ol>
<li>语法保持不变<br>  遵守这个条件，说明如果模块在新内核下重新编译，那应该没有任何语法问题。 即导出符号的类型名没有变化，如果是函数，则要求参数和返回值类型没有任何变化；如果这些类型是结构体的话，结构体的成员名也没有有任何变化。</li>
<li>语义保持不变<br> 这要求符号的类型不能有变化，如果类型本身是结构体(struct)，则它成员的类型不能有变化，成员在结构体内的位置不能有变化，以及成员本身不能增删。<br>如果想要深入了解如何计算CRC可以参考这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/linyt/article/details/42559639">Linux内核模块符号CRC检查机制-CSDN博客</a></li>
</ol>
</blockquote>
<p>分析代码我们可以知道，内核会通过遍历正在加载的模块的版本信息的数组<code>versions</code>，从中查找与给定符号名称匹配的版本信息。如果找到匹配的版本信息，则计算 CRC 值，与参数中的 CRC 值进行比较。（通过后续分析我们知道参数的 CRC 就是正在运行的内核的 module_layout 符号的 CRC）如果匹配，表示版本一致，返回 1。如果不匹配，打印调试信息，并跳转到 <code>bad_version</code>，输出警告信息。</p>
<p>这里有两个疑问，</p>
<ol>
<li><code>versions</code> 内容是怎么链接到模块的 elf 文件中的？</li>
</ol>
<p>我们找到模块的<code>mod.c</code>文件，打开可以发现以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>vermagic<span class="token punctuation">,</span> VERMAGIC_STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> KBUILD_MODNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

__visible <span class="token keyword">struct</span> <span class="token class-name">module</span> __this_module
<span class="token function">__section</span><span class="token punctuation">(</span><span class="token punctuation">.</span>gnu<span class="token punctuation">.</span>linkonce<span class="token punctuation">.</span>this_module<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
 <span class="token punctuation">.</span>name <span class="token operator">=</span> KBUILD_MODNAME<span class="token punctuation">,</span>
 <span class="token punctuation">.</span>init <span class="token operator">=</span> init_module<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODULE_UNLOAD</span></span>
 <span class="token punctuation">.</span>exit <span class="token operator">=</span> cleanup_module<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 <span class="token punctuation">.</span>arch <span class="token operator">=</span> MODULE_ARCH_INIT<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_RETPOLINE</span></span>
<span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>retpoline<span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">modversion_info</span> ____versions<span class="token punctuation">[</span><span class="token punctuation">]</span>
__used <span class="token function">__section</span><span class="token punctuation">(</span>__versions<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x3e549f1d</span><span class="token punctuation">,</span> <span class="token string">"module_layout"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x5138e6ba</span><span class="token punctuation">,</span> <span class="token string">"param_ops_int"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x183b57f9</span><span class="token punctuation">,</span> <span class="token string">"phy_ethtool_nway_reset"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x6e5363eb</span><span class="token punctuation">,</span> <span class="token string">"eth_validate_addr"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x4df55e5b</span><span class="token punctuation">,</span> <span class="token string">"usb_deregister"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x8e48f69b</span><span class="token punctuation">,</span> <span class="token string">"usb_register_driver"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个文件是在编译过程中调用了<code>scripts/modpost</code>脚本生成的，它的功能是在里面增加了 2 个<code>__section</code>，<code>.gnu.linkonce.this_module</code>和<code>__versions</code>。__versions 小节的内容就是一些字符串和值组成的数组，<code>check_version</code>就是解析这个小节去做验证。</p>
<ol start="2">
<li>CRC 值哪来的？</li>
</ol>
<p>我们继续向上跟踪，找到函数<code>check_modstruct_version</code>，其中<code>find_symbol</code>会在内核符号表中查找给定符号名称的符号信息，接着调用<code>check_version</code>函数，传入符号名称、模块结构体和 CRC 值，进行版本匹配。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">check_modstruct_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
       <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">const</span> s32 <span class="token operator">*</span>crc<span class="token punctuation">;</span>

 <span class="token comment">/*
  * Since this should be found in kernel (which can't be removed), no
  * locking is necessary -- use preempt_disable() to placate lockdep.
  */</span>
 <span class="token function">preempt_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">find_symbol</span><span class="token punctuation">(</span><span class="token string">"module_layout"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>crc<span class="token punctuation">,</span> true<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">check_version</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"module_layout"</span><span class="token punctuation">,</span> mod<span class="token punctuation">,</span> crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 获取当前运行内核 module_layout 函数的 crc 值</span>
<span class="token function">find_symbol</span><span class="token punctuation">(</span><span class="token string">"module_layout"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>crc<span class="token punctuation">,</span> true<span class="token punctuation">,</span> false<span class="token punctuation">)</span>
    <span class="token function">each_symbol_section</span><span class="token punctuation">(</span>find_exported_symbol_in_section<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fsa<span class="token punctuation">)</span>
        <span class="token comment">// 遍历内核三个导出符号表段__start___ksymtab，__start___ksymtab_gpl 和__start___ksymtab_gpl_future，为每段调用 find_symbol_in_section</span>
        <span class="token function">each_symbol_in_section</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token comment">// 遍历内核每个已加载模块的三个导出符号表段 mod->syms,mod->gpl_syms,mod->gpl_future_syms，为每段调用 find_symbol_in_section</span>
        <span class="token function">each_symbol_in_section</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> mod<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token comment">// 对导出符号表进行二分查找，按照字符串排序，符号表的地址按照地址排序</span>
            <span class="token function">find_exported_symbol_in_section</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">symsearch</span> <span class="token operator">*</span>syms<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Linux 对可装载模块采取了两层验证</strong>：除了上述的模块 CRC 值校验外还有 <code>vermagic</code> 的检查。模块 vermagic（即 Version Magic String）保存了模块编译时的内核版本以及 SMP 等配置信息，当模块 vermagic 与主机信息不相符时也无法加载模块。</p>
<p>在内核中<code>load_module</code>函数调用<code>check_modstruct_version</code>函数完成 CRC 校验后，就会继续调用<code>layout_and_allocate --&gt; check_modinfo</code> 完成 vermagic 校验。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">check_modinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>modmagic <span class="token operator">=</span> <span class="token function">get_modinfo</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"vermagic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> err<span class="token punctuation">;</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> MODULE_INIT_IGNORE_VERMAGIC<span class="token punctuation">)</span>
  modmagic <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

 <span class="token comment">/* This is allowed: modprobe --force will invalidate it. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modmagic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  err <span class="token operator">=</span> <span class="token function">try_to_force_load</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"bad vermagic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token keyword">return</span> err<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">same_magic</span><span class="token punctuation">(</span>modmagic<span class="token punctuation">,</span> vermagic<span class="token punctuation">,</span> info<span class="token operator">-></span>index<span class="token punctuation">.</span>vers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: version magic '%s' should be '%s'\n"</span><span class="token punctuation">,</span>
         info<span class="token operator">-></span>name<span class="token punctuation">,</span> modmagic<span class="token punctuation">,</span> vermagic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">-</span>ENOEXEC<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>get_modinfo</code> 会获取内核中的 vermagic 信息，模块 vermagic 信息则被保存在了 ELF 的 <code>.modinfo</code> 小节中。这里我们说的 vermagic 就是下文提到的拓展版本信息，它就是系统配置信息组成的一个字符串。</p>
<h1 id="如何解决模块校验错误"><a href="#如何解决模块校验错误" class="headerlink" title="如何解决模块校验错误"></a>如何解决模块校验错误</h1><p>Linux 对可装载模块采取了两层验证，我们需要分别从 CRC 和 vermagic 两个方面来解决模块校验错误。首先从简单的 vermagic 校验开始。我们需要保证运行的内核版本与模块编译时的内核版本一致，这样才能保证 vermagic 校验通过。首先了解如何查看内核版本以及模块版本信息，然后修改内核模块版本信息。</p>
<h2 id="解决-vermagic-校验错误"><a href="#解决-vermagic-校验错误" class="headerlink" title="解决 vermagic 校验错误"></a>解决 vermagic 校验错误</h2><h3 id="如何查看内核版本以及模块版本信息"><a href="#如何查看内核版本以及模块版本信息" class="headerlink" title="如何查看内核版本以及模块版本信息"></a>如何查看内核版本以及模块版本信息</h3><p><code>uname</code>参数功能：</p>
<ul>
<li>-s, 输出 kernel 名称；</li>
<li>-n, 输出主机名；</li>
<li>-r, 输出 kernel 发行版本号；</li>
<li>-v, 输出操作系统版本；</li>
<li>-m, 输出主机的硬件架构名称；</li>
<li>-p, 输出处理器类型；</li>
<li>-i, 输出硬件平台；</li>
<li>-o, 输出操作系统名称</li>
<li>-a, 输出所有信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 输出kernel发行版本号</span>
<span class="token function">uname</span> -r
<span class="token number">6.4</span>.0-10.1.0.20.oe2309.riscv64
<span class="token comment"># 输出所有信息</span>
<span class="token function">uname</span> -a
Linux openeuler <span class="token number">6.4</span>.0-10.1.0.20.oe2309.riscv64 <span class="token comment">#1 SMP Sat Oct  7 06:19:28 UTC 2023 riscv64 riscv64 riscv64 GNU/Linux</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>modinfo 可以查看模块信息，包括模块vermagic信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">modinfo kvm.ko
filename:       /root/build-kernel/kernel/./arch/riscv/kvm/kvm.ko
license:        GPL
author:         Qumranet
srcversion:     5DA13DC0E55100B5FE1D56A
depends:
intree:         Y
name:           kvm
vermagic:       <span class="token number">6.4</span>.0 SMP mod_unload modversions riscv
parm:           halt_poll_ns:uint
parm:           halt_poll_ns_grow:uint
parm:           halt_poll_ns_grow_start:uint
parm:           halt_poll_ns_shrink:uint<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>vermagic</code>就是<code>version magic</code>版本信息，可以看到当前<code>kvm.ko</code>的<code>version magic</code>版本信息为<code>6.4.0</code>。与前文的<code>uname -r</code>输出的 kernel 发行版本号<code>6.4.0-10.1.0.20.oe2309.riscv64</code>不一致。所以会报错。</p>
<h3 id="修改内核模块版本信息"><a href="#修改内核模块版本信息" class="headerlink" title="修改内核模块版本信息"></a>修改内核模块版本信息</h3><ol>
<li>修改基础版本信息</li>
</ol>
<p>打开内核源代码根目录下的 Makefile 文件。你会找到一个包含内核版本信息的地方，类似于：</p>
<pre class="line-numbers language-Makefile" data-language="Makefile"><code class="language-Makefile"># SPDX-License-Identifier: GPL-2.0
VERSION &#x3D; 6
PATCHLEVEL &#x3D; 4
SUBLEVEL &#x3D; 0
EXTRAVERSION &#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表示内核版基础本号为<code>6.4.0</code>。</p>
<ol start="2">
<li>修改拓展版本信息</li>
</ol>
<p>kernel 引入了一些配置来增强版本信息，在内核源码的<code>&quot;include/linux/vermagic.h&quot;</code>下我们可以看到模块的健全版本信息，如下默认配置的有：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Simply sanity version stamp for modules. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SMP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_SMP</span> <span class="token string">"SMP "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_SMP</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PREEMPT_BUILD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">"preempt "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_PREEMPT_RT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">"preempt_rt "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODULE_UNLOAD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODULE_UNLOAD</span> <span class="token string">"mod_unload "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODULE_UNLOAD</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODVERSIONS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODVERSIONS</span> <span class="token string">"modversions "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODVERSIONS</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RANDSTRUCT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;generated/randstruct_hash.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_RANDSTRUCT</span> <span class="token string">"RANDSTRUCT_"</span> <span class="token expression">RANDSTRUCT_HASHED_SEED</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_RANDSTRUCT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VERMAGIC_STRING</span>                                                 <span class="token punctuation">\</span>
        <span class="token expression">UTS_RELEASE </span><span class="token string">" "</span>                                                 <span class="token punctuation">\</span>
        <span class="token expression">MODULE_VERMAGIC_SMP MODULE_VERMAGIC_PREEMPT                     </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_VERMAGIC_MODULE_UNLOAD MODULE_VERMAGIC_MODVERSIONS       </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_ARCH_VERMAGIC                                            </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_RANDSTRUCT</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，<code>&quot;UTS_RELEASE&quot;</code>的配置在内核源码的<code>&quot;include/generated/utsrelease.h&quot;</code>下可以看到，<code>utsrelease.h</code>的内容是由<code>Makefile</code>和``.config<code>的内容来生成的，当成功编译kernel以后，</code>utsrelease.h`得到更新，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#defineUTS_RELEASE "6.4.0"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>那么前文”6.4.0-d46299ae”中的”-d46299ae”是如何得来的呢？其实这个是开发者使用了 Git 来管理代码。当你修改或者提交代码以后，每次编译内核后，在”UTS_RELEASE”后面就会看到一串哈希值，例如”6.4.0-d46299ae”，其中”-d46299ae”这个就是 Git 版本控制而产生的哈希值。发行版本号只是各个厂商用于区别自己发布的不同时期的 kernel 版本或者产品版本而产生的编号，完全由各厂商自己定义。</p>
<h2 id="解决-CRC-校验错误"><a href="#解决-CRC-校验错误" class="headerlink" title="解决 CRC 校验错误"></a>解决 CRC 校验错误</h2><p>我们可以通过一些手段修改新模块的 module_layout 的 CRC 与内核CRC相同，再插入。<code>/boot</code>目录下通常有个在<code>symvers-&lt;kernel_version&gt;.gz</code> 文件通常包含了内核模块的符号版本信息。这个文件是由 Linux 内核构建时生成的，用于记录在该内核版本下构建的模块的符号信息，包括函数和变量的名称、版本号等。里面就保存了内核的 module_layout 的 CRC 值。我们可以使用<code>gzip -d</code>命令解压这个文件，找到 module_layout 的 CRC 值，记录下来。</p>
<ul>
<li><p>方法一：使用 16 进制编辑器修改模块文件，将 module_layout 的值修改为相同的值，再插入。<br>  在 Linux 中，可以使用 <code>hexdump</code> 和 <code>xxd</code> 等工具查看二进制文件的内容，并尝试编辑。下面是一种使用 <code>xxd</code> 查看和修改二进制文件的方法：</p>
<ol>
<li><p>使用 <code>xxd</code> 将二进制文件转换为十六进制文本：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xxd /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko <span class="token operator">></span> kvm_hex.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这将创建一个名为 <code>kvm_hex.txt</code> 的文本文件，其中包含 <code>kvm.ko</code> 的十六进制表示。</p>
</li>
<li><p>使用文本编辑器（如 <code>nano</code> 或 <code>vim</code>）打开 <code>kvm_hex.txt</code>，找到并编辑 <code>module_layout</code> 的值。请确保你了解所做更改的含义，并且只修改你确信的内容。</p>
</li>
<li><p>保存并关闭文本编辑器。</p>
</li>
<li><p>使用 <code>xxd</code> 将修改后的十六进制文本转换回二进制文件：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xxd -r kvm_hex.txt <span class="token operator">></span> /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这将覆盖原始的 <code>kvm.ko</code> 文件。</p>
</li>
</ol>
</li>
<li><p>方法二：修改 Module.symvers</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清理编译结果。不要使用 make distclean，这会删除.config 文件以及 Module.symvers 文件</span>
<span class="token function">make</span> clean
<span class="token comment"># 修改 Module.symvers 文件</span>
<span class="token function">sed</span> -i  <span class="token string">'/module_layout/ s/0x[0-9a-f][0-9a-f]*/0xdf88831e/'</span> Module.symvers
<span class="token comment"># 重新编译模块</span>
<span class="token function">make</span> <span class="token assign-left variable">M</span><span class="token operator">=</span>./arch/riscv/kvm/ -j33
<span class="token comment"># 检查模块的 module_layout</span>
modprobe --dump-modversions /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko <span class="token operator">|</span> <span class="token function">grep</span> module_layout
0xdf88831e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h1 id="如何生成-mod-c-文件"><a href="#如何生成-mod-c-文件" class="headerlink" title="如何生成 .mod.c 文件"></a>如何生成 .mod.c 文件</h1><p>如果是自己写的模块，可以根据下面的命令编译模块，就可以得到<code>.mod.c</code>文件，它是源文件到<code>.mod.o</code>文件的一个中间文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> -C /root/build-kernel/kernel <span class="token assign-left variable">M</span><span class="token operator">=</span>/driver_study/ modules -j22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果是用内核自己的模块，执行<code>make modules</code>命令，也可以得到<code>.mod.c</code>文件。但是一般执行<code>make -j22</code>命令就不会生成这些文件，我们可以找一个启用的内核模块，例如<code>kvm.ko</code>，执行下面的命令，就可以得到<code>.mod.c</code>文件。不能随便找个模块，必须在 config 中开启的模块，否则会报错<code>undefined!</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span>  <span class="token assign-left variable">M</span><span class="token operator">=</span>./arch/riscv/kvm modules -j22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/10/x86%E5%B9%B3%E5%8F%B0%E4%BD%BF%E7%94%A8Gitea-Actions%E6%9E%84%E5%BB%BA%E5%A4%9A%E6%9E%B6%E6%9E%84%E5%BA%94%E7%94%A8/" itemprop="url">x86 平台使用 Gitea Actions 构建多架构应用 (binfmt_misc)</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-10T03:10:04.000Z" itemprop="datePublished">1月 10 2024</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="categories/Self-Hosted/">Self-Hosted</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            15 分钟 读完 (约 2305 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="binfmt-misc-简介"><a href="#binfmt-misc-简介" class="headerlink" title="binfmt_misc 简介"></a>binfmt_misc 简介</h1><p><code>binfmt_misc</code> 是 Linux 内核提供的一个机制，它允许用户空间定义新的二进制格式，并将它们与相应的解释器关联起来。这个机制使得在 Linux 上能够动态地注册并运行不同架构的二进制可执行文件，从而支持交叉编译和多架构环境。</p>
<p>具体来说，<code>binfmt_misc</code> 的功能可以通过 <code>/proc/sys/fs/binfmt_misc/</code> 目录下的文件系统接口实现。这个目录下的文件用于注册和管理二进制格式和相应解释器之间的关联关系。</p>
<p>下面是一些与 <code>binfmt_misc</code> 相关的重要概念和文件：</p>
<ol>
<li><strong>注册表文件：</strong>   在 <code>/proc/sys/fs/binfmt_misc/</code> 目录下，每个注册的二进制格式都有一个对应的注册表文件。这些文件的命名通常遵循格式 <code>&lt;格式名称&gt;</code>，例如 <code>qemu-riscv64</code>。</li>
<li><strong>注册和注销：</strong>   用户空间可以通过在注册表目录下创建文件来注册新的二进制格式。这可以通过写入注册表文件的方式完成。相反，通过删除这些文件，可以注销二进制格式的支持。</li>
<li><strong>解释器：</strong>   对于每种注册的二进制格式，需要指定相应的解释器，即用于执行这种格式的程序。在注册表文件中，通过 <code>interpreter</code> 字段指定解释器的路径。</li>
<li><strong>参数：</strong>   除了解释器，还可以为每个注册的格式指定一些参数。这些参数可以影响如何运行二进制文件。</li>
</ol>
<h1 id="内核如何通过-binfmt-misc-机制添加新架构的支持？"><a href="#内核如何通过-binfmt-misc-机制添加新架构的支持？" class="headerlink" title="内核如何通过 binfmt_misc 机制添加新架构的支持？"></a>内核如何通过 binfmt_misc 机制添加新架构的支持？</h1><p>可以通过向 <code>/proc/sys/fs/binfmt_misc/register</code> 文件写入注册信息来注册新的二进制格式。告诉内核某一格式的文件用什么解释器来执行。写入的格式如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">:name:type:offset:magic:mask:interpreter:flags<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>各个字段以冒号分隔，部分字段可以缺省，但是冒号需要保留。</p>
</blockquote>
<p>字段含义如下：</p>
<ul>
<li><p><code>name</code>：二进制格式的名称，比如<code>qemu-riscv64</code>。</p>
</li>
<li><p><code>type</code>：类型为 E 或 M。</p>
<ul>
<li>如果是 E，可执行文件格式由其文件扩展名标识：magic 是要与二进制格式相关联的文件扩展名；offset 和 mask 将被忽略。</li>
<li>如果是 M，格式由文件中绝对偏移（默认为 0）处的魔数标识，并且 mask 是一个位掩码（默认为全 0xFF），表示数字中哪些位是有效的。</li>
</ul>
</li>
<li><p><code>interpreter</code>：是要作为匹配文件的参数运行的解释器，使用解释器的绝对路径，比如<code>/usr/bin/qemu-riscv64-static</code>。</p>
</li>
<li><p><code>flags</code>：可选字段，控制 <code>interpreter</code> 打开文件的行为。共支持 <code>POCF</code> 四种 flag。</p>
<ul>
<li><code>P</code> 表示 preserve-argv[0]，保留原始的 <code>argv[0]</code> 参数。</li>
<li><code>O</code> 表示 open-binary，<code>binfmt-misc</code> 默认会传递文件的路径，而启用这个参数时，<code>binfmt-misc</code> 会打开文件，传递文件描述符。</li>
<li><code>C</code> 表示 credentials，即会传递文件的 <code>setuid</code> 等权限，这个选项也隐含了 <code>O</code>。</li>
<li><code>F</code> 表示 fix binary，<code>binfmt-misc</code> 默认的行为在 spwan 进程时会延迟，这种方式可能会受到 <code>mount</code> 命名空间和 <code>chroot</code> 的影响，设置 <code>F</code> 时会立刻打开二进制文件。</li>
</ul>
</li>
</ul>
<p>举个例子，如果要在 x86_64 架构的系统上运行 RISC-V 架构的二进制文件，可以通过以下方式注册 RISC-V 二进制格式：</p>
<p>首先需要<strong>添加解释器</strong>，通常使用 QEMU 的静态二进制文件作为解释器，在 Ubuntu 系统中我们可以使用以下命令安装：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user-static<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>注册二进制格式</strong>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">':qemu-riscv64:M:0:7f454c460201010000000000000000000200f300::/usr/libexec/qemu-binfmt/riscv64-binfmt-P:POCF'</span> <span class="token operator">></span> /proc/sys/fs/binfmt_misc/register<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>表示将 RISC-V 二进制格式注册到 <code>/proc/sys/fs/binfmt_misc/qemu-riscv64</code> 文件中，使用 <code>/usr/libexec/qemu-binfmt/riscv64-binfmt-P</code> 作为解释器，同时传递 <code>POCF</code> 参数。执行了以上命令，内核会自动创建一个 <code>/proc/sys/fs/binfmt_misc/qemu-riscv64</code> 文件，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">cat</span>  /proc/sys/fs/binfmt_misc/qemu-riscv64
enabled
interpreter /usr/libexec/qemu-binfmt/riscv64-binfmt-P
flags: POCF
offset <span class="token number">0</span>
magic 7f454c460201010000000000000000000200f300
mask ffffffffffffff00fffffffffffffffffeffffff<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就完成了 RISC-V 二进制格式的注册。此时，你就可以在 x86_64 架构的系统上运行 RISC-V 架构的二进制文件了。</p>
<p>使用 Docker 运行 RISC-V 的容器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker run --rm -it devops/openeuler-builder:23.09-riscv64  <span class="token function">uname</span> -m
riscv64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="使用封装好的程序简化注册过程"><a href="#使用封装好的程序简化注册过程" class="headerlink" title="使用封装好的程序简化注册过程"></a>使用封装好的程序简化注册过程</h2><p>以上的写入 register 文件的方式比较繁琐，可以使用封装好的程序来简化注册过程。</p>
<p>方式一：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user-binfmt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以安装所有 QEMU 支持的架构。</p>
<p>方式二：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装解释器</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user-static
<span class="token comment"># 安装binfmt操作支持</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> binfmt-support
<span class="token comment"># 开启异构支持</span>
<span class="token function">sudo</span> update-binfmts --package<span class="token operator">=</span>qemu-user-static --enable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同上。</p>
<h2 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> -1 <span class="token operator">></span>/proc/sys/fs/binfmt_misc/status <span class="token comment"># 注销所有注册的条目</span>
<span class="token builtin class-name">echo</span> -1 <span class="token operator">></span>/proc/sys/fs/binfmt_misc/qemu-riscv64 <span class="token comment"># 注销单个条目</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>或者通过命令行工具完成：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装binfmt操作支持</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> binfmt-support
<span class="token comment"># 禁用qemu-riscv64，再次查看/proc/sys/fs/binfmt_misc/发现qemu-riscv64已被删除</span>
<span class="token function">sudo</span> update-binfmts --disable qemu-riscv64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Gitea-如何实现多架构应用构建？"><a href="#Gitea-如何实现多架构应用构建？" class="headerlink" title="Gitea 如何实现多架构应用构建？"></a>Gitea 如何实现多架构应用构建？</h1><p>Gitea 不会自己运行 Job，而是将 Job 委托给 Runner。Gitea Actions 的 Runner 被称为 act runner，它是一个独立的程序。在接收到 Job 后，act runner 会根据 Job 的内容，启用不同的 Container 来运行 Job。</p>
<p>为了避免消耗过多资源并影响 Gitea 实例，Gitea 和 Runner 一般运行在不同的机器上。但是同一个 Runner 启动的容器一定在同一台机器上。我这里演示的统一都在同一台 x86 架构的机器上。</p>
<p>因为都运行在 x86 架构的机器上，所有执行任务的 Container 也一定是 x86 架构的。但是我们了解了上面的 binfmt_misc 机制后，就可以在容器内部通过注册不同架构的二进制格式，从而在 x86 架构的机器上运行不同架构的二进制文件。就可以实现多架构应用构建。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/17-49-15-4cd035ef3794eae7de157dd25af6148e-giteaactionsrunner-5cf8e3.png"></p>
<p>打开 Gitea 的 tea 的项目源码找到它的 release <a target="_blank" rel="noopener" href="https://gitea.com/gitea/tea/src/commit/c74177556b8e63252491003f1cbcd3882bfff15d/.gitea/workflows/release-nightly.yml#L53">workflow 文件</a>，可以看到它使用了<code>docker/setup-qemu-action@v3</code>这个 action 来实现多架构构建。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
<span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>查阅<a target="_blank" rel="noopener" href="https://github.com/tonistiigi/binfmt/blob/a92dbabe8fddb096b8cb307aa1c6bbe65dc0884f/cmd/binfmt/main.go#L63C1-L103C2">action 的源码</a>，可以发现底层实现是通过<code>binfmt_misc</code>来实现的。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 定义了一些全局变量</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mount<span class="token punctuation">,</span> <span class="token string">"mount"</span><span class="token punctuation">,</span> <span class="token string">"/proc/sys/fs/binfmt_misc"</span><span class="token punctuation">,</span> <span class="token string">"binfmt_misc mount point"</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toInstall<span class="token punctuation">,</span> <span class="token string">"install"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"architectures to install"</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toUninstall<span class="token punctuation">,</span> <span class="token string">"uninstall"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"architectures to uninstall"</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flVersion<span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"display version"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">install</span><span class="token punctuation">(</span>arch <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	cfg<span class="token punctuation">,</span> ok <span class="token operator">:=</span> configs<span class="token punctuation">[</span>arch<span class="token punctuation">]</span>
    <span class="token comment">// 拼接路径为/proc/sys/fs/binfmt_misc/register，打开这个文件检查是否能够打开成功</span>
	register <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>mount<span class="token punctuation">,</span> <span class="token string">"register"</span><span class="token punctuation">)</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>register<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	binaryBasename<span class="token punctuation">,</span> binaryFullpath<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getBinaryNames</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
    <span class="token comment">// 向/proc/sys/fs/binfmt_misc/register 写入 line，注册二进制格式</span>
	line <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">":%s:M:0:%s:%s:%s:%s"</span><span class="token punctuation">,</span> binaryBasename<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>magic<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>mask<span class="token punctuation">,</span> binaryFullpath<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>PathError<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>Err <span class="token operator">==</span> syscall<span class="token punctuation">.</span>EEXIST <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s already registered"</span><span class="token punctuation">,</span> binaryBasename<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"cannot register %q to %s: %s"</span><span class="token punctuation">,</span> binaryFullpath<span class="token punctuation">,</span> register<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h1><h2 id="为何-proc-sys-fs-binfmt-misc-register-文件是只读的？"><a href="#为何-proc-sys-fs-binfmt-misc-register-文件是只读的？" class="headerlink" title="为何/proc/sys/fs/binfmt_misc/register 文件是只读的？"></a>为何/proc/sys/fs/binfmt_misc/register 文件是只读的？</h2><p><code>/proc/sys/fs/binfmt_misc/register</code> 文件是只写的，这是因为在 Linux 中，<code>/proc</code> 文件系统下的很多文件都是通过对文件进行写入来进行配置和控制的。这些文件通常<strong>代表内核参数或控制接口</strong>，提供了一种方便的方式来与内核进行交互。</p>
<p>对于 <code>/proc/sys/fs/binfmt_misc/register</code> 文件来说，通过写入注册信息，用户可以向内核注册新的二进制格式，告知内核如何执行特定的二进制文件。这种只写的设计是为了保持简单性和安全性。允许用户在运行时动态地注册新的格式，而不是从文件中读取注册信息，可以提供更大的灵活性。</p>
<p>虽然 <code>/proc/sys/fs/binfmt_misc/register</code> 文件是只写的，但是通过向文件中写入正确格式的注册信息，用户仍然能够有效地配置新的二进制格式。这种设计符合 Linux 中的文件系统和权限模型。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/pulse">Kernel Support for miscellaneous Binary Formats (binfmt_misc)</a></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/07/%E8%A7%A3%E5%86%B3Armoury-Crate-%E5%8D%8E%E7%A1%95%E5%A5%A5%E5%88%9B%E4%B8%AD%E5%BF%83%EF%BC%89%E5%AE%89%E8%A3%85%E9%A9%B1%E5%8A%A8%E5%8D%A1%E5%9C%A855/" itemprop="url">解决Armoury Crate(华硕奥创中心）安装驱动卡在55%</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-07T02:37:28.000Z" itemprop="datePublished">1月 7 2024</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            几秒 读完 (约 85 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>卡在55%的基本上驱动已经下载完成，但是还没有安装。这时我们找到下载的文件手动安装即可。一般保存的路径为<code>C:\Users\Administrator\AppData\Local\Packages\B9ECED6F.ArmouryCrate_qmba6cd70vzyy\LocalState\SupportTemp</code>，找到需要安装的驱动文件夹，双击<code>setup.exe</code>即可。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/06/%E8%BF%81%E7%A7%BBWSL2%E5%88%B0%E9%9D%9E%E7%B3%BB%E7%BB%9F%E7%9B%98/" itemprop="url">迁移WSL2到非系统盘</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-06T08:47:57.000Z" itemprop="datePublished">1月 6 2024</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 读完 (约 374 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="迁移过程"><a href="#迁移过程" class="headerlink" title="迁移过程"></a>迁移过程</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭WSL2</span></span><br><span class="line">wsl --shutdown</span><br><span class="line"><span class="comment"># 查看WSL2的状态</span></span><br><span class="line">wsl -l -v</span><br><span class="line">NAME                   STATE           VERSION</span><br><span class="line">Stopped         2</span><br><span class="line">  Ubuntu         Stopped         2</span><br><span class="line"><span class="comment"># 导出WSL2</span></span><br><span class="line">wsl --<span class="built_in">export</span> Ubuntu D:\wsl2\ubuntu.tar</span><br><span class="line">正在导出，这可能需要几分钟时间。</span><br><span class="line">操作成功完成。</span><br><span class="line"><span class="comment"># 删除WSL2</span></span><br><span class="line">wsl --unregister Ubuntu</span><br><span class="line">正在注销。</span><br><span class="line">操作成功完成。</span><br><span class="line"><span class="comment"># 导入WSL2</span></span><br><span class="line">wsl --import Ubuntu D:\wsl2 D:\wsl2\ubuntu.tar --version 2</span><br><span class="line">正在导入，这可能需要几分钟时间。</span><br><span class="line">操作成功完成。</span><br><span class="line"><span class="comment"># 设置默认用户，如果不设置将会使用root用户，因为之前我一直使用自己创建的用户，所以需要设置，否则zsh配置文件会找不到</span></span><br><span class="line">ubuntu.exe config --default-user nic</span><br><span class="line"><span class="comment"># 启动WSL2</span></span><br><span class="line">wsl</span><br></pre></td></tr></table></figure>

<p>可能有人和我一样安装了Docker，启用WSL后，docker运行数据都在WSL发行版中，文件位置都只能由WSL管理！</p>
<p>安装docker后，docker会自动创建2个发行版：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wsl -l -v</span><br><span class="line">NAME                   STATE           VERSION</span><br><span class="line">Stopped         2</span><br><span class="line">  docker-desktop         Stopped         2</span><br><span class="line">  docker-desktop-data    Stopped         2</span><br></pre></td></tr></table></figure>

<p>和上面一样需要到导出，删除，导入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭docker</span></span><br><span class="line">将Docker程序退出即可</span><br><span class="line"><span class="comment"># 导出docker-desktop</span></span><br><span class="line">wsl --<span class="built_in">export</span> docker-desktop D:\wsl2\docker-desktop\docker-desktop.tar</span><br><span class="line"><span class="comment"># 删除docker-desktop</span></span><br><span class="line">wsl --unregister docker-desktop</span><br><span class="line"><span class="comment"># 导入docker-desktop</span></span><br><span class="line">wsl --import docker-desktop D:\wsl2\docker-desktop D:\wsl2\docker-desktop\docker-desktop.tar --version 2</span><br><span class="line"><span class="comment"># 导出docker-desktop-data</span></span><br><span class="line">wsl --<span class="built_in">export</span> docker-desktop-data D:\wsl2\docker-desktop-data.tar</span><br><span class="line"><span class="comment"># 删除docker-desktop-data</span></span><br><span class="line">wsl --unregister docker-desktop-data</span><br><span class="line"><span class="comment"># 导入docker-desktop-data</span></span><br><span class="line">wsl --import docker-desktop-data D:\wsl2\docker-desktop-data D:\wsl2\docker-desktop-data\docker-desktop-data.tar --version 2</span><br></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2024/01/06/%E8%80%B3%E6%9C%BA%E6%8D%A2%E7%94%B5%E6%B1%A0%E5%A4%8D%E6%B4%BB%E8%80%B3%E6%9C%BA%E5%B0%8F%E8%AE%B0/" itemprop="url">耳机换电池复活耳机小记</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-06T02:34:10.000Z" itemprop="datePublished">1月 6 2024</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="categories/%E7%BC%9D%E7%BC%9D%E8%A1%A5%E8%A1%A5%E5%8F%88%E4%B8%89%E5%B9%B4/">缝缝补补又三年</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            8 分钟 读完 (约 1226 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>半月前给用了三年的小米 10 换了一块二手电池，手机又可以再战三年了。想着自己还有两个耳机，也没有严重故障，只是电池亏点用不了半小时，于是也想着换个电池，看看能不能复活。本来以为耳机太小，太精密，怕自己修不了，但是想想如果不换电池，这个耳机也还是死路一条，不如自己尝试尝试，也能积攒一点经验。实操下来，发现并没有想象中那么难，只要有耐心，还是能修好的。甚至比换手机电池还要容易些，没有那么多螺丝需要拆，也没有那么多胶需要撬。</p>
<h1 id="小米-FlipBuds-Pro"><a href="#小米-FlipBuds-Pro" class="headerlink" title="小米 FlipBuds Pro"></a>小米 FlipBuds Pro</h1><h2 id="配件和工具准备"><a href="#配件和工具准备" class="headerlink" title="配件和工具准备"></a>配件和工具准备</h2><p>配件</p>
<ul>
<li>CR1254 3V 锂电池（可以直接淘宝搜索 FlipBuds Pro 电池，也可以直接搜这个型号，最好买带线的，不带线焊接会比较麻烦）</li>
</ul>
<p>工具</p>
<ul>
<li>热风枪（吹风机即可）</li>
<li>电烙铁（小米的这个耳机是需要焊接电池线的）</li>
<li>镊子（清理耳机里面的胶水）</li>
</ul>
<h2 id="拆机"><a href="#拆机" class="headerlink" title="拆机"></a>拆机</h2><p>用吹风机对准耳机吹一两分钟，沿着合模线徒手就能掰开。打开腔体时需要慢一点，有地方有胶水粘粘，不是一打开就是图中的样子，需要把胶水清理干净。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/c97ee9c173d49027e1c145e7748f6b4e.png"></p>
<p>分离后可以从边缘将电池撬出来。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/17af1dbe363d6214d480c9fe2aa7519b.png"></p>
<p>电池正极上用的双面胶将导线粘到了正极，用吹风机对准图中位置稍微加热一分钟作用，然后将电池正极上的贴片取下来。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/943150df37aebd615bb13f44495a620a.png"></p>
<p>除了上面一个连接点，还有两个焊接的连接点，用电烙铁加热取下即可将电池脱离。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/10486c9c31baf01807387577005fde05.png"></p>
<blockquote>
<p>没有微距镜头，用了<a target="_blank" rel="noopener" href="https://www.52audio.com/archives/81082.html">我爱音频网的图片</a></p>
</blockquote>
<h2 id="装机"><a href="#装机" class="headerlink" title="装机"></a>装机</h2><p>将电池红线连接到正极，黑线连接到负极，然后将电池放回原位，合模即可。如果不知道正负极，可以在耳机线路板上有标识。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/3009a9fd386dfa462ed8670f86d589cb.png"></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/f4c49ecc202e7f2d1aeba87877ad6411.png"></p>
<p>还有个需要注意的地方就是吸附磁铁的安装，可能在拆电池时候磁铁会掉落，可以根据图片中磁铁的位置进行安装。先放磁铁再安电池。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/2aebcb22ce86092bc3fe9c6404f0dcfd.png"></p>
<p>在装机过程中就可以连接手机，并播放音乐测试耳机是否能正常工作。因为合模时需要大力压合，播放音乐还能保证压合过程中线路没有断开。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/06/574b07106665802d5f64677b6f1fb4d9.png"></p>
<p>用了一天，耳机电池能用四小时左右，基本上和全新的一样。</p>
<h1 id="索尼-WF-1000XM3、"><a href="#索尼-WF-1000XM3、" class="headerlink" title="索尼 WF-1000XM3、"></a>索尼 WF-1000XM3、</h1><h2 id="配件和工具准备-1"><a href="#配件和工具准备-1" class="headerlink" title="配件和工具准备"></a>配件和工具准备</h2><p>配件</p>
<ul>
<li>CR1254 3.7V 锂电池，原装的是 VARTA 品牌的，我买的是 ZeniPower，只要型号一样，品牌自己选。甚至可以选 3.85V，75mAh 的续航更好。</li>
</ul>
<p>工具</p>
<ul>
<li>热风枪（吹风机即可）</li>
<li>镊子（清理耳机里面的胶水）</li>
<li>螺丝刀</li>
</ul>
<h2 id="拆机-1"><a href="#拆机-1" class="headerlink" title="拆机"></a>拆机</h2><p>用吹风机对着耳机的触摸原盘吹一两分钟胶水只在这块区域，边缘是卡扣不需要加热，指甲长的话直接用指甲掰开即可。打开后的样子如下图所示。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/08/4a441a4377b1a34b8cf32615a75284ee.png"></p>
<p>有两个小螺丝，拧下后就可以将盖板翻过来，电池就在下方。电池下方有双面胶，直接抠不容易抠出来，用吹风机对着盖板吹一两分钟就可以将胶水软化，然后用镊子将胶水取下。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/08/a76356a4a815618316219d9cf652d9fb.png"></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>将电池放回原位，盖板合上，拧上螺丝即可。在安装回耳机盖时需要注意耳机盖是分左右的，如果左右颠倒了是合不上的。参考图中的位置。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2024/01/08/a2c39abaab296e00d56e4677efc472fb.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2023/12/23/%E8%A7%A3%E5%86%B3Adobe-Photoshop%E6%AD%A3%E7%89%88%E5%8D%87%E7%BA%A7%E5%BC%B9%E7%AA%97/" itemprop="url">解决Adobe Photoshop正版升级弹窗</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-12-23T04:08:36.000Z" itemprop="datePublished">12月 23 2023</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            4 分钟 读完 (约 590 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>不知什么原因，一直正常使用的Adobe Photoshop 2021突然开始弹窗提示升级，还是日文的（应该是代理到到日本了），可能根据地区不同，弹窗的内容也不同，但是都是提示升级，倒计时10天，不知道十天之后啥情况。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/12/23/a8b83c2f3e0916e9b2fd92dc7332dc89.png"></p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>Adobe的其他软件同理，比如我在用的Lightroom也是这样，解决方法也是一样的。以下方式基于Windows 11，其他版本的Windows也是类似的。</p>
<p><strong>如果没有用代理</strong>，可以直接将Photoshop程序禁止联网。可以通过配置Windows的防火墙来实现，具体方法如下：</p>
<ol>
<li><p>打开设置搜索“防火墙”，打开Windows防火墙，选择“高级设置”。</p>
<p> <img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/12/23/a38bd63b6c184481c797cd3143e3b21d.png"></p>
</li>
<li><p>选择“出站规则”，点击“新建规则”，选择规则类型为“程序”，程序选择为Photoshop的安装目录下的Photoshop.exe，然后选择“阻止连接”，一路下一步，最后命名规则为“禁止Photoshop联网”。<br> <img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/12/23/31498beb037fc282838480a3624850cc.png"></p>
</li>
</ol>
<p><strong>如果使用了代理</strong>，防火墙可能会被绕过，Photoshop可能仍然会通过代理访问更新服务器。需要通过配置代理将Photoshop禁止代理。如果不配置，可以在<strong>每次打开Adobe相关软件前关闭代理</strong>，如果配置，这里以Clash for Windows为例，可以通过配置Clash的规则来实现，不用关闭代理。具体方法如下：</p>
<p>点击“Profiles”，选择自己的订阅，右击选择“Edit”，将以下这些规则添加到配置文件中保存即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- PROCESS-NAME,Lightroom.exe,REJECT</span><br><span class="line">- PROCESS-NAME,lightroom.exe,REJECT</span><br><span class="line">- PROCESS-NAME,Photoshop.exe,REJECT</span><br><span class="line">- PROCESS-NAME,photoshop.exe,REJECT</span><br><span class="line">- PROCESS-NAME,Adobe Lightroom CEF Helper.exe,REJECT</span><br><span class="line">- PROCESS-NAME,AdobeIPCBroker.exe,REJECT</span><br><span class="line">- PROCESS-NAME,dynamiclinkmanager.exe,REJECT</span><br><span class="line">- PROCESS-NAME,dynamiclinkmediaserver.exe,REJECT</span><br></pre></td></tr></table></figure>

<p>其他程序你可以自己添加，格式为<code>PROCESS-NAME,程序名,REJECT</code>。表示拒绝这些程序访问网络。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="2023/12/17/ZWIFT%E4%BD%BF%E7%94%A8Tips/" itemprop="url">ZWIFT使用Tips</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-12-17T05:24:55.000Z" itemprop="datePublished">12月 17 2023</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            几秒 读完 (约 84 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/12/17/0573bf51587d55e549ac5fd4719733b4.png"></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/12/17/6fb1f8bb10562bb55eb8b7eddb97a0ce.png"></p>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="启动后闪退"><a href="#启动后闪退" class="headerlink" title="启动后闪退"></a>启动后闪退</h2><p>将输入法切换为英文模式再重新启动。</p>
<h2 id="没有其他玩家，只有自己"><a href="#没有其他玩家，只有自己" class="headerlink" title="没有其他玩家，只有自己"></a>没有其他玩家，只有自己</h2><p>挂全局代理重新启动。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
    
        
<nav class="pagination is-centered is-rounded" role="navigation" aria-label="pagination">
    <div class="pagination-previous is-invisible is-hidden-mobile">
        <a href="page/0/">上一页</a>
    </div>
    <div class="pagination-next">
        <a href="page/2/">下一页</a>
    </div>
    <ul class="pagination-list is-hidden-mobile">
        
        <li><a class="pagination-link is-current" href="">1</a></li>
        
        <li><a class="pagination-link" href="page/2/">2</a></li>
        
        <li><span class="pagination-ellipsis">&hellip;</span></li>
        
        <li><a class="pagination-link" href="page/26/">26</a></li>
        
    </ul>
</nav>
    
    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                powered_by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery > p > .gallery-item').unwrap();
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站内搜索" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="js/insight.js"></script>

    
</body>
</html>