<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">





    <meta property="og:type" content="website">
<meta property="og:title" content="如云泊">
<meta property="og:url" content="https://lifeislife.cn/page/3/index.html">
<meta property="og:site_name" content="如云泊">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Dominic">
<meta name="twitter:card" content="summary">





<link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="../../css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PS8L2EEEPR"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PS8L2EEEPR');
</script>


    


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="../../index.html">
                
                <img src="../../images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="../../archives">Archives</a>
            
            <a class="navbar-item "
               href="../../about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜索" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/Dunky-Z">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/09/04/uCore-%E5%AE%9E%E9%AA%8C%E7%AC%AC4%E7%AB%A0-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/" itemprop="url">uCore 实验第 4 章 - 地址空间</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-09-04T03:11:48.000Z" itemprop="datePublished">9月 4 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/uCore-%E5%AE%9E%E9%AA%8C/">uCore 实验</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 小时 读完 (约 6902 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <blockquote>
<p>为何指定 TRAMPOLINE 和 TRAPFRAME 在 va 的最高位？<br>TRAMPOLINE 和 TRAPFRAME 被定义在最高的虚拟内存地址上，是因为它们在操作系统的内存布局中起着重要作用。<br>TRAMPOLINE 被用作从用户模式切换到内核模式的跳转目标。当发生异常或中断时，处理器将从用户模式切换到内核模式，并将控制权转移到内核中预定义的位置，也就是陷阱处理程序。TRAMPOLINE 页面被映射到最高虚拟地址，以便处理器能够在这个转换过程中方便地引用它。通过将其放置在最高地址，确保了无论系统的具体内存布局如何，它始终是可访问的。<br>另一方面，TRAPFRAME 用于在发生异常或中断时存储机器状态。它包含寄存器、标志和其他操作系统处理异常所需的信息。TRAPFRAME 也被放置在最高的虚拟地址上，以确保它易于访问，并且陷阱处理程序可以高效地访问它。<br>通过将 TRAMPOLINE 和 TRAPFRAME 定义在最高的虚拟内存地址上，内核可以方便而可靠地处理异常和中断，而无需关心它们在内存中的特定位置。</p>
</blockquote>
<h1 id="如何确定分页方案-satp"><a href="#如何确定分页方案-satp" class="headerlink" title="如何确定分页方案 - satp"></a>如何确定分页方案 - satp</h1><p>在 MMU 没有使能的情况下，虚拟地址和物理地址是相同的。在 MMU 使能的情况下，虚拟地址会被转换成物理地址。这个转换过程是由操作系统来管理的，操作系统需要维护一个数据结构来记录虚拟地址和物理地址的映射关系。这个数据结构就是页表。</p>
<p>转换的过程需要分页机制，分页机制有多种。RISC-V 的分页方案以 SvX 的模式命名，其中 X 是以位为单位的<strong>虚拟地址的长度</strong>。在 RV64 架构下，RISC-V 支持多种分页方案，包括 Sv39，Sv48，Sv57 以及 Sv64。Sv39 最大支持 39 位的虚拟地址，这意味着它可以支持 512 GB 的虚拟地址空间。Sv48 最大支持 48 位的虚拟地址，这意味着它可以支持 256 TB 的虚拟地址空间。我们将在本章中实现 Sv39 分页方案。</p>
<p>如何开启分页机制呢？RISC-V 的分页机制是通过 satp（Supervisor address translation and protection）寄存器来开启的。satp 寄存器字段分布如下：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/09/05/5d1ec6e9adaf743f7c9abc177cd12eb1.png" title="RV64 架构下的 satp 寄存器"></p>
<ul>
<li>Mode 字段可以决定是否开启分页以及分页级数。Mode=0 时，不开启分页；Mode=8 时，开启 Sv39 分页机制。</li>
<li>ASID（Address Space Identifier，地址空间标识符）域是可选的，它可以用来降低上下文切换的开销。目前我们暂不考虑这个字段的作用。</li>
<li>PPN（Physical Page Number，物理页号），保存了根页表的物理地址。</li>
</ul>
<h1 id="SV39-多级页表机制"><a href="#SV39-多级页表机制" class="headerlink" title="SV39 多级页表机制"></a>SV39 多级页表机制</h1><h2 id="页表项描述"><a href="#页表项描述" class="headerlink" title="页表项描述"></a>页表项描述</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/09/05/86e06238c562bdd238e868fcd819df3c.png" title="Sv39 页表项"></p>
<p>Sv39 页表项（page-table entry，PTE）的布局，从左到右分别包含如下所述的域：</p>
<ul>
<li>V 位决定了该页表项的其余部分是否有效 (V=1 时有效)。若 V=0，则任何遍历到此页表项的虚址转换操作都会导致页错误。</li>
<li>R、W 和 X 位分别表示此页是否可以读取、写入和执行。如果这三个位都是 0，那么这个页表项是指向下一级页表的指针，否则它是页表树的一个叶节点。</li>
<li>U 位表示该页是否是用户页面。若 U=0，则 U 模式不能访问此页面，但 S 模式可以。若 U=1，则 U 模式下能访问这个页面，而 S 模式不能。</li>
<li>G 位表示这个映射是否对所有虚址空间有效，硬件可以用这个信息来提高地址转换的性能。这一位通常只用于属于操作系统的页面。</li>
<li>A 位表示自从上次 A 位被清除以来，该页面是否被访问过。</li>
<li>D 位表示自从上次清除 D 位以来页面是否被弄脏（例如被写入）。</li>
<li>RSW 域留给操作系统使用，它会被硬件忽略。</li>
<li>PPN 域包含物理页号，这是物理地址的一部分。若这个页表项是一个叶节点，那么 PPN 是转换后物理地址的一部分。否则 PPN 给出下一节页表的地址。</li>
</ul>
<h2 id="虚拟地址转换物理地址过程"><a href="#虚拟地址转换物理地址过程" class="headerlink" title="虚拟地址转换物理地址过程"></a>虚拟地址转换物理地址过程</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/09/05/48e6ce48ffb827a10371344ad07324c2.png"></p>
<p>当 satp 寄存器中开启分页时，S 模式和 U 模式中访存的地址都会被视为虚拟地址，需要将其转换为物理地址。虚拟地址转换物理地址的过程如下：</p>
<ul>
<li>从 satp 寄存器中读取 PPN，得到根页表的物理地址，为了表述方便，我们将其记做三级页表基地址 satp.PPN；</li>
<li>从虚拟地址中取出三级虚拟页号 L2</li>
<li>处理器会读取地址位于 satp.PPN * 4096 + L2 * 4 的页表项，得到下一级页表的基地址 L1.PPN；</li>
<li>从虚拟地址中取出二级虚拟页号 L1</li>
<li>处理器会读取地址位于 L1.PPN * 4096 + L1 * 4 的页表项，得到下一级页表的基地址 L0.PPN；</li>
<li>从虚拟地址中取出一级虚拟页号 L0</li>
<li>处理器会读取地址位于 L0.PPN * 4096 + L0 * 4 的页表项，得到物理页号 PPN；</li>
<li>将 PPN 和虚拟地址的低 12 位也就是 Offset 拼接起来，得到物理地址。</li>
</ul>
<p>我们看代码中是如何实现的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)</span></span><br><span class="line"><span class="comment">// 从虚拟地址中提取三个 9 位的页表索引</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PXMASK 0x1FF <span class="comment">// 9</span></span></span><br><span class="line"><span class="comment">// PGSHIFT = 12，这段宏定义用于定位 VPNx 的位置</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PXSHIFT(level) (PGSHIFT + (9 * (level)))</span></span><br><span class="line"><span class="comment">// 从虚拟地址 VA 中提取出第 level 级页表的索引</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PX(level, va) ((((uint64)(va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)</span></span><br></pre></td></tr></table></figure>
<p>上面这三个工具宏可以用来提取虚拟页号 VPN。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 返回页表 pagetable 中与虚拟地址 va 对应的 PTE 的地址。</span></span><br><span class="line"><span class="comment">// 如果 alloc != 0，则创建所需的页表页。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RISC-V Sv39 方案有三级页表页。一个页表页包含 512 个 64 位的 PTEs。</span></span><br><span class="line"><span class="comment">// 一个 64 位的虚拟地址被分为五个字段：</span></span><br><span class="line"><span class="comment">//   39..63 -- 必须为零。</span></span><br><span class="line"><span class="comment">//   30..38 -- 2 级索引的 9 位。</span></span><br><span class="line"><span class="comment">//   21..29 -- 1 级索引的 9 位。</span></span><br><span class="line"><span class="comment">//   12..20 -- 0 级索引的 9 位。</span></span><br><span class="line"><span class="comment">//    0..11 -- 页面内的 12 位字节偏移量。</span></span><br><span class="line"><span class="comment">// pagetable 页表</span></span><br><span class="line"><span class="comment">// va 虚拟地址</span></span><br><span class="line"><span class="comment">// alloc 页表项不存在时是否分配</span></span><br><span class="line"><span class="function"><span class="keyword">pte_t</span> *<span class="title">walk</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, <span class="keyword">int</span> alloc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (va &gt;= MAXVA)</span><br><span class="line">        panic(<span class="string">&quot;walk&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> level = <span class="number">2</span>; level &gt; <span class="number">0</span>; level--) &#123;</span><br><span class="line">        <span class="keyword">pte_t</span> *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">        <span class="comment">// 通过 PTE 的标志位判断每一级的 pte 是否是有效的（V 位）</span></span><br><span class="line">        <span class="keyword">if</span> (*pte &amp; PTE_V) &#123;</span><br><span class="line">            pagetable = (<span class="keyword">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果该项无效且 alloc 标志被设置，则分配一个新的页表</span></span><br><span class="line">            <span class="comment">// 如果 alloc 参数=0 或者已经没有空闲的内存了，那么遇到中途 V=0 的 pte 整个 walk 过程就会直接退出</span></span><br><span class="line">            <span class="keyword">if</span> (!alloc || (pagetable = (<span class="keyword">pde_t</span> *)kalloc()) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 清空分配的页表</span></span><br><span class="line">            <span class="built_in">memset</span>(pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">            <span class="comment">// 更新页表项，将其指向新分配的页表，并设置有效位 PTE_V</span></span><br><span class="line">            *pte = PA2PTE(pagetable) | PTE_V;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回最低级和虚拟地址的页表项，不是返回物理地址</span></span><br><span class="line">    <span class="keyword">return</span> &amp;pagetable[PX(<span class="number">0</span>, va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次从虚拟地址 va 中提取出一个虚拟页号，然后根据这个虚拟页号从页表中取出下一级页表的基地址。如果这个页表项无效，那么根据 alloc 参数决定是否分配一个新的页表。如果 alloc 参数为 0 或者已经没有空闲的内存了，那么遇到中途 V=0 的 pte 整个 walk 过程就会直接退出。如果 alloc 参数为 1，那么就会分配一个新的页表，然后将这个页表项指向新分配的页表，并设置有效位 PTE_V。</p>
<p>我们可以发现 walk 返回的结果不是物理地址，而是页表项的地址。这是因为 walk 函数的作用是将虚拟地址转换为物理地址，而页表项中的 PPN 只是物理地址的一部分，<strong>还需要加上虚拟地址的低 12 位偏移量才能得到物理地址</strong>。</p>
<h2 id="如何建立页表"><a href="#如何建立页表" class="headerlink" title="如何建立页表"></a>如何建立页表</h2><p>前面的过程实际上是以用户的角度来考虑的，也就是给你一个虚拟地址按照分页的规则将其转化成物理地址就能访问了。但是作为一个操作系统，我们还需要多考虑一下，页表是哪来的？我们知道从虚拟地址中去获取页表地址，但是<strong>页表的内容是哪来的呢</strong>？页表是如何建立起来的呢？这些是需要操作系统来完成的。</p>
<p>建立页表也就是建立虚拟地址到物理地址的映射关系。也就是给你一个虚拟地址，你需要告诉我如何查到物理地址，实际上这个过程就是建立页表的过程。这个过程也是通过 walk 函数来完成的，从上文我们知道如果页表都建好的情况下 walk 就是不断查页表的过程，那么在没有页表的情况下，walk 还可以建立一个个页表。稍有不同的是，walk 返回的是最后一级页表项的地址，我们需要将物理地址写入这个页表项中。</p>
<p>在 uCore 中使用 mappages 函数封装了 walk 函数，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为从虚拟地址 va 开始的页面创建指向物理地址 pa 开始的页表项（PTE）</span></span><br><span class="line"><span class="comment"> * 注意：va 和 size 可能不是页面对齐的</span></span><br><span class="line"><span class="comment"> * 如果无法分配所需的页表，则返回 0，否则返回 -1</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param pagetable 根页表地址</span></span><br><span class="line"><span class="comment"> * @param va        虚拟地址</span></span><br><span class="line"><span class="comment"> * @param size      映射的字节数</span></span><br><span class="line"><span class="comment"> * @param pa        物理地址</span></span><br><span class="line"><span class="comment"> * @param perm      权限位</span></span><br><span class="line"><span class="comment"> * @return          成功返回 0，否则返回 -1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mappages</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    uint64 virtualAddress, lastVirtualAddress;</span><br><span class="line">    <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地址必须是页面对齐的</span></span><br><span class="line">    virtualAddress     = PGROUNDDOWN(va);</span><br><span class="line">    lastVirtualAddress = PGROUNDDOWN(va + size - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 返回最低级的虚拟地址的页表项，如果不存在会创建一个新的页表项</span></span><br><span class="line">        <span class="comment">// 页表项可能会因为内存不足创建失败，如果创建失败，则返回 -1</span></span><br><span class="line">        <span class="keyword">if</span> ((pte = walk(pagetable, virtualAddress, <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果 PTE 已经有效，则输出错误信息并返回 -1</span></span><br><span class="line">        <span class="keyword">if</span> (*pte &amp; PTE_V) &#123;</span><br><span class="line">            errorf(<span class="string">&quot;remap&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将物理地址 pa 转换为页表项，并设置权限位 perm 和 有效位 PTE_V</span></span><br><span class="line">        *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line">        <span class="comment">// 如果当前是最后一个地址，则结束循环</span></span><br><span class="line">        <span class="keyword">if</span> (virtualAddress == lastVirtualAddress) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        virtualAddress += PGSIZE;</span><br><span class="line">        pa += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="问答作业"><a href="#问答作业" class="headerlink" title="问答作业"></a>问答作业</h1><h2 id="请列举-SV39-页表页表项的组成，结合课堂内容，描述其中的标志位有何作用／潜在作用？"><a href="#请列举-SV39-页表页表项的组成，结合课堂内容，描述其中的标志位有何作用／潜在作用？" class="headerlink" title="请列举 SV39 页表页表项的组成，结合课堂内容，描述其中的标志位有何作用／潜在作用？"></a>请列举 SV39 页表页表项的组成，结合课堂内容，描述其中的标志位有何作用／潜在作用？</h2><p>Sv39 页表页表项的组成如下：</p>
<ol>
<li>**有效位 (V)**：这是页表项的最高位，用于指示页表项是否有效。如果有效位设置为 1，表示页表项有效，可以使用；如果设置为 0，表示页表项无效，禁止使用。这是虚拟内存中页表项的基本有效性标志。</li>
<li>**写入位 (W)**：这个标志位用于指示是否可以对此页进行写入操作。如果设置为 1，表示允许写入；如果设置为 0，表示禁止写入。它是页表项的访问权限控制标志之一。</li>
<li>**用户位 (U)**：用户位用于指示是否允许用户态程序访问此页。如果设置为 1，表示允许用户态访问；如果设置为 0，表示只允许内核态访问。它是页表项的访问权限控制标志之一。</li>
<li>**执行位 (X)**：执行位用于指示是否允许执行此页上的指令。如果设置为 1，表示允许执行；如果设置为 0，表示禁止执行。它也是页表项的访问权限控制标志之一。</li>
<li>**全局位 (G)**：全局位用于指示此页是否是全局的，即无需 TLB 缓存，通常用于内核页。如果设置为 1，表示是全局的；如果设置为 0，表示不是全局的。</li>
<li>**已访问位 (A)**：已访问位表示是否已经访问过此页，通常由硬件设置。操作系统可以用它来实现页面置换算法，如 LRU。</li>
<li>**已修改位 (D)**：已修改位表示是否已经对此页进行了写入操作。与已访问位类似，操作系统可以用它来实现页面置换算法。</li>
<li>**物理页框地址 (PPN)**：这是页表项中存储的物理页框的地址。它指示了虚拟页到物理页的映射关系。</li>
</ol>
<p>Sv39 页表的页表项标志位允许操作系统和硬件实现对虚拟内存的细粒度控制和保护。不同的标志位组合可以实现不同级别的内存保护和权限控制，从而提高系统的安全性和可用性。例如，有效位、写入位、用户位和执行位的不同组合可以实现不同级别的内存保护，使操作系统可以将不同的内存区域分配给用户态和内核态，并设置不同的权限。已访问位和已修改位则用于实现页面置换算法，帮助操作系统决定哪些页面应该被置换出去，以优化内存利用率。全局位可以用于标识全局共享的页，从而节省 TLB 缓存空间。物理页框地址是页表项的核心，它建立了虚拟地址到物理地址的映射关系，使虚拟内存管理成为可能。</p>
<h2 id="缺页相关问题"><a href="#缺页相关问题" class="headerlink" title="缺页相关问题"></a>缺页相关问题</h2><h3 id="请问哪些异常可能是缺页导致的？"><a href="#请问哪些异常可能是缺页导致的？" class="headerlink" title="请问哪些异常可能是缺页导致的？"></a>请问哪些异常可能是缺页导致的？</h3><p>缺页异常是由于进程访问的页面不在页表中或者在页表中无效而引发的异常。以下这些异常可能是因为缺页导致的：</p>
<ul>
<li><p>Load Page Fault（Load 异常）：当进程试图读取一个不在页表中或者无效的页面时，会引发 Load Page Fault 异常。在 RISC-V 中，这个异常对应的异常代码是 5。</p>
</li>
<li><p>Store Page Fault（Store 异常）：当进程试图写入一个不在页表中或者无效的页面时，会引发 Store Page Fault 异常。在 RISC-V 中，这个异常对应的异常代码是 7。</p>
</li>
<li><p>Instruction Page Fault（指令页异常）：当进程试图执行一个不在页表中或者无效的页面上的指令时，会引发 Instruction Page Fault 异常。在 RISC-V 中，这个异常对应的异常代码是 12。</p>
</li>
</ul>
<h3 id="发生缺页时，描述相关的重要寄存器的值（lab2-中描述过的可以简单点）。"><a href="#发生缺页时，描述相关的重要寄存器的值（lab2-中描述过的可以简单点）。" class="headerlink" title="发生缺页时，描述相关的重要寄存器的值（lab2 中描述过的可以简单点）。"></a>发生缺页时，描述相关的重要寄存器的值（lab2 中描述过的可以简单点）。</h3><ul>
<li>sepc（Exception Program Counter）：trap 发生时会将当前指令的下一条指令地址写入其中，用于 trap 处理完成后返回。</li>
<li>stval（Machine Trap Value）：mtval 寄存器包含导致异常的原因，即导致异常的指令的具体信息。例如，如果是缺页异常，那么 mtval 寄存器包含导致缺页异常的虚拟地址。</li>
<li>scause: 中断/异常发生时， CSR 寄存器 scause 中会记录其信息， Interrupt 位记录是中断还是异常， Exception Code 记录中断/异常的种类。</li>
<li>sstatus: 记录处理器当前状态，其中 SPP 段记录当前特权等级。</li>
<li>stvec: 记录处理 trap 的入口地址，现有两种模式  Direct 和 Vectored 。</li>
<li>sscratch: 其中的值是指向hart相关的S态上下文的指针，比如内核栈的指针。</li>
</ul>
<h3 id="以下行为的好处？"><a href="#以下行为的好处？" class="headerlink" title="以下行为的好处？"></a>以下行为的好处？</h3><p>缺页有两个常见的原因，其一是 Lazy 策略，也就是直到内存页面被访问才实际进行页表操作。比如，一个程序被执行时，进程的代码段理论上需要从磁盘加载到内存。但是 os 并不会马上这样做，而是会保存 .text 段在磁盘的位置信息，在这些代码第一次被执行时才完成从磁盘的加载操作。</p>
<p>Lazy Loading 策略有以下好处：</p>
<ol>
<li><strong>减少初始化开销</strong>：Lazy Loading 允许操作系统在程序启动时只加载必需的页面，而不是一次性加载整个程序。这可以减少启动时间和初始化开销，因为不需要将整个程序加载到内存中。</li>
<li><strong>节省内存</strong>：Lazy Loading 策略避免了不必要的内存占用。如果程序的某些部分从不被访问，那么它们就不会被加载到内存中，从而节省了内存资源。</li>
<li><strong>提高响应速度</strong>：通过仅在需要时加载页面，Lazy Loading 可以提高系统的响应速度。只有当程序访问某个页面时，操作系统才会执行磁盘加载操作，而不会在程序启动时浪费时间加载可能永远不会被访问的内容。</li>
<li><strong>更好的磁盘利用率</strong>：Lazy Loading 允许操作系统将程序的不同部分分散在磁盘上，根据需要加载。这可以提高磁盘利用率，因为不需要在磁盘上为整个程序分配连续的空间。</li>
</ol>
<h3 id="请问处理-10G-连续的内存页面，需要操作的页表实际大致占用多少内存-给出数量级即可-？"><a href="#请问处理-10G-连续的内存页面，需要操作的页表实际大致占用多少内存-给出数量级即可-？" class="headerlink" title="请问处理 10G 连续的内存页面，需要操作的页表实际大致占用多少内存 (给出数量级即可)？"></a>请问处理 10G 连续的内存页面，需要操作的页表实际大致占用多少内存 (给出数量级即可)？</h3><blockquote>
<p>此外 COW(Copy On Write) 也是常见的容易导致缺页的 Lazy 策略，这个之后再说。其实，我们的 mmap 也可以采取 Lazy 策略，比如：一个用户进程先后申请了 10G 的内存空间，然后用了其中 1M 就直接退出了。按照现在的做法，我们显然亏大了，进行了很多没有意义的页表操作。</p>
</blockquote>
<p>处理 10GB 连续的内存页面所需的页表实际上占用的内存量取决于操作系统的页表结构和管理策略。在 RISC-V 的页表结构中，一个页表项（Page Table Entry，PTE）通常占据 8 字节（64 位系统），其中包括物理页框号和一些标志位。让我们假设一个 PTE 占用 8 字节。</p>
<p>为了估算 10GB 连续内存页面所需的页表实际占用内存量，我们可以按照以下步骤进行计算：</p>
<ol>
<li><p>首先，将 10GB 转换为字节数。1GB 等于 1,073,741,824 字节，所以 10GB 等于 10 * 1,073,741,824 = 10,737,418,240 字节。</p>
</li>
<li><p>然后，计算每个页面表项覆盖的内存范围。假设每个页面表项管理 4KB（4 * 1024 字节）的内存页面。</p>
</li>
<li><p>计算需要多少个页面表项来管理 10GB 的内存。这可以通过将 10GB 除以每个页面表项管理的内存范围来实现。</p>
</li>
<li><p>最后，将所需的页面表项数量乘以每个 PTE 的大小来估算所需的总内存量。</p>
</li>
</ol>
<p>让我们进行具体计算：</p>
<ul>
<li>内存大小：10,737,418,240 字节</li>
<li>每个页面表项管理的内存范围：4KB = 4 * 1024 字节</li>
<li>需要的页面表项数量：10,737,418,240 字节 / 4KB = 2,621,440 个页表项</li>
</ul>
<p>假设每个页表项占用 8 字节，则需要的总内存量为：</p>
<p>2,621,440 个页表项 * 8 字节/页表项 = 20,971,520 字节</p>
<p>所以，处理 10GB 连续的内存页面所需的页表实际占用内存量约为 20,971,520 字节，或者大约 20MB。这只是一个估算，实际内存占用可能会因操作系统的管理策略和对齐等因素而有所不同。</p>
<h3 id="请简单思考如何才能在现有框架基础上实现-Lazy-策略，缺页时又如何处理？描述合理即可，不需要考虑实现。"><a href="#请简单思考如何才能在现有框架基础上实现-Lazy-策略，缺页时又如何处理？描述合理即可，不需要考虑实现。" class="headerlink" title="请简单思考如何才能在现有框架基础上实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。"></a>请简单思考如何才能在现有框架基础上实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。</h3><p>要在现有框架基础上实现 Lazy 策略，可以采取以下简单思路：</p>
<ol>
<li><p><strong>延迟加载（Lazy Loading）</strong>：在用户进程请求内存映射时，不立即将整个内存区域加载到物理内存中。而是仅创建虚拟内存映射和页表项，记录对应的磁盘位置等信息。</p>
</li>
<li><p><strong>缺页处理（Page Fault Handling）</strong>：当用户进程访问虚拟内存中的某个尚未加载的内存页面时，会触发缺页异常。在缺页异常处理程序中，操作系统会根据页表中的磁盘位置信息，将相应的磁盘数据加载到物理内存中，并更新页表项，使其指向新加载的物理页面。</p>
</li>
<li><p><strong>惰性加载（Demand Paging）</strong>：为了提高性能，可以采用惰性加载策略，即只加载实际被访问的内存页面，而不是一次性加载整个区域。这可以通过在缺页处理程序中进行懒加载操作来实现。</p>
</li>
<li><p><strong>内存回收（Memory Reclamation）</strong>：当系统内存不足时，操作系统可以选择回收一些不常访问的内存页面，将其写回磁盘，并更新页表项为无效。这需要根据页面访问模式和策略来确定哪些页面可以被回收。</p>
</li>
<li><p><strong>性能优化</strong>：为了提高性能，可以采用预读取（Prefetching）策略，即在缺页处理时，不仅加载当前访问的页面，还预先加载相邻的页面，以减少未来可能的缺页次数。</p>
</li>
</ol>
<h3 id="此时页面失效如何表现在页表项-PTE-上？"><a href="#此时页面失效如何表现在页表项-PTE-上？" class="headerlink" title="此时页面失效如何表现在页表项 (PTE) 上？"></a>此时页面失效如何表现在页表项 (PTE) 上？</h3><blockquote>
<p>缺页的另一个常见原因是 swap 策略，也就是内存页面可能被换到磁盘上了，导致对应页面失效。</p>
</blockquote>
<p>Dirty bit (D 位)：当页面被修改并且尚未写回到主存时，该位会被设置为 1。如果页面已经被换出到磁盘上，D 位将保持为 1，以指示页面数据已过期。</p>
<p>Valid bit (V 位)：当页面在主存中有效时，V 位被设置为 1。如果页面被换出到磁盘上，V 位将被清除为 0，表示该页无效。</p>
<p>通过检查页表项的 D 位和 V 位，操作系统可以确定页面是否需要从磁盘重新加载到内存中。如果 D 位为 1，说明页面需要写回到主存，在将其置为有效之前，必须将页数据从磁盘读取到内存中。如果 V 位为 0，说明页面当前无效，需要将其从磁盘加载到内存中，并将 V 位设置为 1，表示页面有效。</p>
<h2 id="双页表与单页表"><a href="#双页表与单页表" class="headerlink" title="双页表与单页表"></a>双页表与单页表</h2><p>为了防范侧信道攻击，我们的 os 使用了双页表。但是传统的设计一直是单页表的，也就是说，用户线程和对应的内核线程共用同一张页表，只不过内核对应的地址只允许在内核态访问。请结合课堂知识回答如下问题：(备注：这里的单/双的说法仅为自创的通俗说法，并无这个名词概念，详情见 KPTI )</p>
<h2 id="单页表情况下，如何更换页表？"><a href="#单页表情况下，如何更换页表？" class="headerlink" title="单页表情况下，如何更换页表？"></a>单页表情况下，如何更换页表？</h2><p> 在单页表情况下，页表的更换通常是由操作系统的上下文切换来触发的。当从用户态切换到内核态或从一个进程切换到另一个进程时，操作系统会根据相应的上下文信息加载不同的页表，实现页表的更换。</p>
<h2 id="单页表情况下，如何控制用户态无法访问内核页面？（tips-看看第一题最后一问）"><a href="#单页表情况下，如何控制用户态无法访问内核页面？（tips-看看第一题最后一问）" class="headerlink" title="单页表情况下，如何控制用户态无法访问内核页面？（tips:看看第一题最后一问）"></a>单页表情况下，如何控制用户态无法访问内核页面？（tips:看看第一题最后一问）</h2><ul>
<li>设置页面权限：内核页面通常会被设置为只能在内核态下访问（例如，设置 PTE_U 位为 0），这样用户态无法访问内核页面。</li>
<li>操作系统权限：操作系统内核态拥有较高的权限，可以通过特权级别或访问控制机制来确保用户态无法直接访问内核页面。用户程序只能通过系统调用进入内核态，并在内核态下由操作系统执行，从而实现对内核页面的访问控制。</li>
</ul>
<h2 id="单页表有何优势？（回答合理即可）"><a href="#单页表有何优势？（回答合理即可）" class="headerlink" title="单页表有何优势？（回答合理即可）"></a>单页表有何优势？（回答合理即可）</h2><p>单页表的主要优势在于简化了地址转换过程，减少了内存访问的开销。由于用户线程和内核线程共享同一张页表，不需要在上下文切换时频繁切换页表，这可以提高地址转换的效率。此外，单页表还可以节省内存，因为不需要为每个用户线程分配独立的页表。</p>
<h2 id="双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？"><a href="#双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？" class="headerlink" title="双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？"></a>双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？</h2><p>在双页表实现下，页表的更换通常在发生上下文切换时需要。当从用户态切换到内核态或从一个进程切换到另一个进程时，需要加载相应的页表，以确保正确的地址转换。如果操作系统采用了每个进程独立的页表，那么在进程切换时需要更换页表。</p>
<p>如果我写一个单页表操作系统，我会选择在发生进程切换时更换页表，因为这是最频繁的上下文切换情况之一。在其他情况下，如从用户态切换到内核态，可能不需要更换整张页表，而只需修改页表项的权限位来实现访问控制。这样可以减少页表更换的开销，提高性能。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>修改user项目中的makefile，删除ch4_</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/09/02/uCore-%E5%AE%9E%E9%AA%8C%E7%AC%AC3%E7%AB%A0-%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E4%B8%8E%E5%88%86%E6%97%B6%E5%A4%9A%E4%BB%BB%E5%8A%A1/" itemprop="url">uCore 实验第 3 章 - 多道程序与分时多任务</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-09-02T08:03:02.000Z" itemprop="datePublished">9月 2 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/uCore-%E5%AE%9E%E9%AA%8C/">uCore 实验</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            26 分钟 读完 (约 3882 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动时初始化进程表</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (p = pool; p &lt; &amp;pool[NPROC]; p++) &#123;</span><br><span class="line">        p-&gt;state = UNUSED;</span><br><span class="line">        <span class="comment">// p - pool 是 p 指向的 proc 在 pool 中的下标，因此 p - pool 变化情况是 0, 1, 2, ..., NPROC - 1</span></span><br><span class="line">        p-&gt;kstack    = (uint64)kstack[p - pool];</span><br><span class="line">        p-&gt;ustack    = (uint64)ustack[p - pool];</span><br><span class="line">        p-&gt;trapframe = (struct trapframe *)trapframe[p - pool];</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    idle.kstack  = (uint64)boot_stack_top;</span><br><span class="line">    idle.pid     = <span class="number">0</span>;</span><br><span class="line">    current_proc = &amp;idle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>p - pool 表示什么？<br>假设我们有一个名为 pool 的数组，其中包含了多个类型为 struct proc 的元素，并且有一个指针 p 指向其中的某个元素。<br>当 p 指向 pool 数组的第一个元素时，p - pool 的结果将是 0，因为指针相对于数组首地址的偏移量为 0。<br>当 p 指向 pool 数组的第二个元素时，p - pool 的结果将是 1，因为指针相对于数组首地址的偏移量为 1。<br>以此类推，当 p 指向 pool 数组的第 N 个元素时，p - pool 的结果将是 N-1，因为指针相对于数组首地址的偏移量为 N-1。<br>总结来说，如果 p 是指向 pool 数组中第 N 个元素的指针，那么 p - pool 的结果将是 N-1。</p>
</blockquote>
<p>原调度函数每次都会从 pool 数组的第一个元素开始遍历，这样会导致每次都是从第一个进程开始运行，而不是从上次运行的进程开始运行。需要修改为如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调度程序永不返回。它循环执行以下操作：</span></span><br><span class="line"><span class="comment">//  - 选择要运行的进程。</span></span><br><span class="line"><span class="comment">//  - 切换以启动运行该进程。</span></span><br><span class="line"><span class="comment">//  - 最终，该进程通过切换将控制权</span></span><br><span class="line"><span class="comment">//    传递回调度程序。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">last_checked_proc</span> =</span> pool; <span class="comment">// 初始化指针为 pool</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (p = last_checked_proc; p &lt; &amp;pool[NPROC];</span><br><span class="line">             p++) &#123; <span class="comment">// 将 p 初始化为 last_checked_proc</span></span><br><span class="line">            <span class="keyword">if</span> (p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * LAB1：你可能需要在这里初始化进程的起始时间</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                p-&gt;state     = RUNNING;</span><br><span class="line">                current_proc = p;</span><br><span class="line">                swtch(&amp;idle.context, &amp;p-&gt;context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        last_checked_proc = pool + <span class="number">1</span>; <span class="comment">// 更新 last_checked_proc 的值为下一个位置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="LAB1"><a href="#LAB1" class="headerlink" title="LAB1"></a>LAB1</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"> os/loader.c           |   <span class="number">5</span> +-</span><br><span class="line"> os/proc.c             |  <span class="number">15</span> +-</span><br><span class="line"> os/proc.h             |  <span class="number">23</span> +-</span><br><span class="line"> os/syscall.c          |  <span class="number">55</span> ++++-</span><br><span class="line"> os/syscall_ids.h      |   <span class="number">5</span> +-</span><br><span class="line"> os/timer.h            |   <span class="number">2</span> +</span><br><span class="line"> <span class="number">9</span> files changed, <span class="number">374</span> insertions(+), <span class="number">291</span> deletions(-)</span><br><span class="line"></span><br><span class="line">diff --git a/os/loader.c b/os/loader.c</span><br><span class="line">index b45e85d..b21b0a4 <span class="number">100644</span></span><br><span class="line">--- a/os/loader.c</span><br><span class="line">+++ b/os/loader.c</span><br><span class="line">@@ <span class="number">-1</span>,<span class="number">6</span> +<span class="number">1</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;loader.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">static</span> uint64  app_num;</span><br><span class="line"> <span class="keyword">static</span> uint64 *app_info_ptr;</span><br><span class="line">@@ <span class="number">-49</span>,<span class="number">8</span> +<span class="number">50</span>,<span class="number">10</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">run_all_app</span><span class="params">()</span></span></span><br><span class="line"><span class="function">         trapframe-&gt;sp  </span>= (uint64)p-&gt;ustack + USER_STACK_SIZE;</span><br><span class="line">         p-&gt;state       = RUNNABLE;</span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">-		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">+		* LAB1: 初始化系统调用数以及进程开始时间</span></span><br><span class="line"><span class="comment"> 		*/</span></span><br><span class="line">+        <span class="built_in">memset</span>(p-&gt;syscall_times, <span class="number">0</span>, MAX_SYSCALL_NUM * <span class="keyword">sizeof</span>(uint32));</span><br><span class="line">+        p-&gt;start_time = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">\ No newline at end of file</span><br><span class="line">diff --git a/os/proc.c b/os/proc.c</span><br><span class="line">index fee3886.<span class="number">.0</span>c69ae5 <span class="number">100644</span></span><br><span class="line">--- a/os/proc.c</span><br><span class="line">+++ b/os/proc.c</span><br><span class="line">@@ <span class="number">-2</span>,<span class="number">6</span> +<span class="number">2</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;loader.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> <span class="title">pool</span>[<span class="title">NPROC</span>];</span></span><br><span class="line"> <span class="keyword">char</span>        kstack[NPROC][PAGE_SIZE];</span><br><span class="line">@@ <span class="number">-33</span>,<span class="number">9</span> +<span class="number">34</span>,<span class="number">8</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">         p-&gt;kstack    </span>= (uint64)kstack[p - pool];</span><br><span class="line">         p-&gt;ustack    = (uint64)ustack[p - pool];</span><br><span class="line">         p-&gt;trapframe = (struct trapframe *)trapframe[p - pool];</span><br><span class="line">-        <span class="comment">/*</span></span><br><span class="line"><span class="comment">-		* LAB1: you may need to initialize your new fields of proc here</span></span><br><span class="line"><span class="comment">-		*/</span></span><br><span class="line">+        <span class="built_in">memset</span>(p-&gt;syscall_times, <span class="number">0</span>, MAX_SYSCALL_NUM * <span class="keyword">sizeof</span>(uint32));</span><br><span class="line">+        p-&gt;start_time = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     idle.kstack  = (uint64)boot_stack_top;</span><br><span class="line">     idle.pid     = <span class="number">0</span>;</span><br><span class="line">@@ <span class="number">-47</span>,<span class="number">6</span> +<span class="number">47</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">allocpid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">     <span class="keyword">static</span> <span class="keyword">int</span> PID </span>= <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">return</span> PID++;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line"> <span class="comment">// 在进程表中寻找一个未使用的进程。</span></span><br><span class="line"> <span class="comment">// 如果找到，则初始化在内核中运行所需的状态。</span></span><br><span class="line"> <span class="comment">// 如果没有空闲的进程，或者内存分配失败，则返回 0。</span></span><br><span class="line">@@ <span class="number">-80</span>,<span class="number">14</span> +<span class="number">81</span>,<span class="number">18</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">last_checked_proc</span> =</span> pool; <span class="comment">// 初始化指针为 pool</span></span><br><span class="line">-</span><br><span class="line">     <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">         <span class="keyword">for</span> (p = last_checked_proc; p &lt; &amp;pool[NPROC];</span><br><span class="line">              p++) &#123; <span class="comment">// 将 p 初始化为 last_checked_proc</span></span><br><span class="line">             <span class="keyword">if</span> (p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">                 <span class="comment">/*</span></span><br><span class="line"><span class="comment">-                * LAB1：你可能需要在这里初始化进程的起始时间</span></span><br><span class="line"><span class="comment">+                * LAB1：在这里初始化进程的开始时间</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">+                <span class="keyword">if</span> (p-&gt;start_time == <span class="number">0</span>) &#123;</span><br><span class="line">+                    uint64 cycle = get_cycle();</span><br><span class="line">+                    p-&gt;start_time =</span><br><span class="line">+                        (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+                &#125;</span><br><span class="line">                 p-&gt;state     = RUNNING;</span><br><span class="line">                 current_proc = p;</span><br><span class="line">                 swtch(&amp;idle.context, &amp;p-&gt;context);</span><br><span class="line">diff --git a/os/proc.h b/os/proc.h</span><br><span class="line">index d208c5d.<span class="number">.53576</span>bf <span class="number">100644</span></span><br><span class="line">--- a/os/proc.h</span><br><span class="line">+++ b/os/proc.h</span><br><span class="line">@@ <span class="number">-3</span>,<span class="number">7</span> +<span class="number">3</span>,<span class="number">8</span> @@</span><br><span class="line"> </span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line">-<span class="meta">#<span class="meta-keyword">define</span> NPROC (16)</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> NPROC           (16)  <span class="comment">// 最大进程数</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> MAX_SYSCALL_NUM (500) <span class="comment">// 最大系统调用数</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">@@ <span class="number">-42</span>,<span class="number">14</span> +<span class="number">43</span>,<span class="number">28</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">     uint64            kstack;    <span class="comment">// 进程内核栈虚拟地址 (内核页表)</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">trapframe</span>;</span> <span class="comment">// 进程中断帧</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">context</span>    <span class="title">context</span>;</span> <span class="comment">// 用于保存进程内核态的寄存器信息，进程切换时使用</span></span><br><span class="line">-                               <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to add some new fields here</span></span><br><span class="line"><span class="comment">+    /*</span></span><br><span class="line"><span class="comment">+	* LAB1: 添加一些新的成员用于新的 sys_task_info 系统调用</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    uint32 syscall_times[MAX_SYSCALL_NUM]; <span class="comment">// 系统调用次数统计 <span class="doctag">TODO:</span> 后续改为指针</span></span><br><span class="line">+    uint64 start_time;                     <span class="comment">// 进程开始运行时间</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define struct for TaskInfo here</span></span><br><span class="line"><span class="comment">+* LAB1: 定义 TaskInfo 结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">+    UnInit,</span><br><span class="line">+    Ready,</span><br><span class="line">+    Running,</span><br><span class="line">+    Exited,</span><br><span class="line">+&#125; TaskStatus;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">+    TaskStatus status;</span><br><span class="line">+    uint32     syscall_times[MAX_SYSCALL_NUM];</span><br><span class="line">+    <span class="keyword">int</span>        time; <span class="comment">// 进程运行时间统计</span></span><br><span class="line">+&#125; TaskInfo;</span><br><span class="line"> </span><br><span class="line"> <span class="function">struct proc *<span class="title">curr_proc</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">void</span>         <span class="title">exit</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">diff --git a/os/syscall.c b/os/syscall.c</span><br><span class="line">index <span class="number">1</span>cc5aeb..f54ed86 <span class="number">100644</span></span><br><span class="line">--- a/os/syscall.c</span><br><span class="line">+++ b/os/syscall.c</span><br><span class="line">@@ <span class="number">-4</span>,<span class="number">6</span> +<span class="number">4</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;syscall_ids.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;trap.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;proc.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="function">uint64 <span class="title">sys_write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> *str, uint len)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">@@ <span class="number">-31</span>,<span class="number">14</span> +<span class="number">32</span>,<span class="number">46</span> @@ <span class="function">uint64 <span class="title">sys_sched_yield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> uint64 <span class="title">sys_gettimeofday</span><span class="params">(TimeVal *val, <span class="keyword">int</span> _tz)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     uint64 cycle = get_cycle();</span><br><span class="line">-    val-&gt;sec     = cycle / CPU_FREQ;</span><br><span class="line">-    val-&gt;usec    = (cycle % CPU_FREQ) * MICROSECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    tracef(<span class="string">&quot;sys_gettimeofday cycle = %d&quot;</span>, cycle);</span><br><span class="line">+    val-&gt;sec  = cycle / CPU_FREQ;</span><br><span class="line">+    val-&gt;msec = (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    val-&gt;usec = (cycle % CPU_FREQ) * MICROSECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">-<span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define sys_task_info here</span></span><br><span class="line"><span class="comment">-*/</span></span><br><span class="line">+<span class="comment">/** </span></span><br><span class="line"><span class="comment">+ * LAB1：此处定义 sys_task_info 函数</span></span><br><span class="line"><span class="comment">+ * 查询当前正在执行的任务信息，任务信息包括任务控制块相关信息（任务状态）、任务使用的系统调用次数、任务总运行时长。 </span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="function"><span class="keyword">int</span> <span class="title">sys_task_info</span><span class="params">(TaskInfo *ti)</span></span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">proc</span> =</span> curr_proc();</span><br><span class="line">+    <span class="comment">// <span class="doctag">TODO:</span> proc 检查为空</span></span><br><span class="line">+    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_SYSCALL_NUM; i++) &#123;</span><br><span class="line">+        ti-&gt;syscall_times[i] = proc-&gt;syscall_times[i];</span><br><span class="line">+    &#125;</span><br><span class="line">+    uint64 cycle = get_cycle();</span><br><span class="line">+    uint64 current_time =</span><br><span class="line">+        (cycle % CPU_FREQ) * MILLISECONDS_PER_SECOND / CPU_FREQ;</span><br><span class="line">+    infof(<span class="string">&quot;sys_task_info current_time = %d&quot;</span>, current_time);</span><br><span class="line">+    infof(<span class="string">&quot;proc-&gt;start_time = %d&quot;</span>, proc-&gt;start_time);</span><br><span class="line">+    infof(<span class="string">&quot;ti-&gt;time = %d&quot;</span>, current_time - proc-&gt;start_time);</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (proc-&gt;state == RUNNING) &#123;</span><br><span class="line">+        ti-&gt;status = Running;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == RUNNABLE) &#123;</span><br><span class="line">+        ti-&gt;status = Ready;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == SLEEPING) &#123;</span><br><span class="line">+        ti-&gt;status = Ready;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == ZOMBIE) &#123;</span><br><span class="line">+        ti-&gt;status = Exited;</span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;state == UNUSED) &#123;</span><br><span class="line">+        ti-&gt;status = UnInit;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    ti-&gt;time = current_time - proc-&gt;start_time;</span><br><span class="line">+    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">extern</span> <span class="keyword">char</span> trap_page[];</span><br><span class="line"> </span><br><span class="line">@@ <span class="number">-51</span>,<span class="number">8</span> +<span class="number">84</span>,<span class="number">9</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">syscall</span><span class="params">()</span></span></span><br><span class="line"><span class="function">     <span class="title">tracef</span><span class="params">(<span class="string">&quot;syscall %d args = [%x, %x, %x, %x, %x, %x]&quot;</span>, id, args[<span class="number">0</span>], args[<span class="number">1</span>],</span></span></span><br><span class="line"><span class="params"><span class="function">            args[<span class="number">2</span>], args[<span class="number">3</span>], args[<span class="number">4</span>], args[<span class="number">5</span>])</span></span>;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to update syscall counter for task info here</span></span><br><span class="line"><span class="comment">+	* LAB1: 更新系统调用次数</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    curr_proc()-&gt;syscall_times[id]++;</span><br><span class="line">     <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">     <span class="keyword">case</span> SYS_write:</span><br><span class="line">         ret = sys_write(args[<span class="number">0</span>], (<span class="keyword">char</span> *)args[<span class="number">1</span>], args[<span class="number">2</span>]);</span><br><span class="line">@@ <span class="number">-67</span>,<span class="number">8</span> +<span class="number">101</span>,<span class="number">15</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">syscall</span><span class="params">()</span></span></span><br><span class="line"><span class="function">         ret </span>= sys_gettimeofday((TimeVal *)args[<span class="number">0</span>], args[<span class="number">1</span>]);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">-	* LAB1: you may need to add SYS_taskinfo case here</span></span><br><span class="line"><span class="comment">+	* LAB1: 在此处添加 SYS_task_info 的系统调用处理情况</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line">+    <span class="keyword">case</span> SYS_task_info:</span><br><span class="line">+        ret = sys_task_info((TaskInfo *)args[<span class="number">0</span>]);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+    <span class="keyword">case</span> SYS_getpid:</span><br><span class="line">+        infof(<span class="string">&quot;SYS_getpid %d&quot;</span>, SYS_getpid);</span><br><span class="line">+        ret = curr_proc()-&gt;pid;</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">         ret = <span class="number">-1</span>;</span><br><span class="line">         errorf(<span class="string">&quot;unknown syscall %d&quot;</span>, id);</span><br><span class="line">diff --git a/os/syscall_ids.h b/os/syscall_ids.h</span><br><span class="line">index <span class="number">05</span>a6cb9.<span class="number">.3</span>c1a5a9 <span class="number">100644</span></span><br><span class="line">--- a/os/syscall_ids.h</span><br><span class="line">+++ b/os/syscall_ids.h</span><br><span class="line">@@ <span class="number">-277</span>,<span class="number">9</span> +<span class="number">277</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_pgetevents          292</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_rseq                   293</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_kexec_file_load        294</span></span><br><span class="line">-<span class="comment">/*</span></span><br><span class="line"><span class="comment">-* LAB1: you may need to define SYS_task_info here</span></span><br><span class="line"><span class="comment">-*/</span></span><br><span class="line">+<span class="comment">// LAB1：添加 SYS_task_info 的系统调用号</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> SYS_task_info          410</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_pidfd_send_signal  424</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_uring_setup     425</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> SYS_io_uring_enter     426</span></span><br><span class="line">diff --git a/os/timer.h b/os/timer.h</span><br><span class="line">index c6ebd14.<span class="number">.63</span>ab45c <span class="number">100644</span></span><br><span class="line">--- a/os/timer.h</span><br><span class="line">+++ b/os/timer.h</span><br><span class="line">@@ <span class="number">-6</span>,<span class="number">6</span> +<span class="number">6</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> TICKS_PER_SEC (100)</span></span><br><span class="line"> <span class="comment">// QEMU</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> CPU_FREQ                (12500000)</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> MILLISECONDS_PER_SECOND (1000)</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> MICROSECONDS_PER_SECOND (1000000)</span></span><br><span class="line"> </span><br><span class="line"> <span class="function">uint64 <span class="title">get_cycle</span><span class="params">()</span></span>;</span><br><span class="line">@@ <span class="number">-14</span>,<span class="number">6</span> +<span class="number">15</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">void</span>   <span class="title">set_next_timer</span><span class="params">()</span></span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">     uint64 sec;  <span class="comment">// 自 Unix 纪元起的秒数</span></span><br><span class="line">+    uint64 msec; <span class="comment">// 毫秒数</span></span><br><span class="line">     uint64 usec; <span class="comment">// 微秒数</span></span><br><span class="line"> &#125; TimeVal;</span><br><span class="line"> </span><br><span class="line">-- </span><br><span class="line"><span class="number">2.34</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="问答作业"><a href="#问答作业" class="headerlink" title="问答作业"></a>问答作业</h1><h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h2><p>正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。请同学们可以自行测试这些内容（参考 前三个测例，描述程序出错行为，同时注意注明你使用的 sbi 及其版本。</p>
<p>测试前三个测试用例指的是<code>uCore-Tutorial-Code-2023S/user/src/</code> 目录下的三个<code>bad</code>测试用例，查看<code>user</code>项目的 Makefile 可以发现在编译时修改<code>CHAPTER</code>参数值为<code>2_bad</code>即可编译运行这些测试用例。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[rustsbi] RustSBI version 0.3.0-alpha.2, adapting to RISC-V SBI v1.0.0</span><br><span class="line">.______       __    __      _______.___________.  _______..______   __</span><br><span class="line">|   _  \     |  |  |  |    /       |           | /       ||   _  \ |  |</span><br><span class="line">|  |_)  |    |  |  |  |   |   (----`---|  |----`|   (----`|  |_)  ||  |</span><br><span class="line">|      /     |  |  |  |    \   \       |  |      \   \    |   _  &lt; |  |</span><br><span class="line">|  |\  \----.|  `--<span class="string">&#x27;  |.----)   |      |  |  .----)   |   |  |_)  ||  |</span></span><br><span class="line"><span class="string">| _| `._____| \______/ |_______/       |__|  |_______/    |______/ |__|</span></span><br><span class="line"><span class="string">[rustsbi] Implementation     : RustSBI-QEMU Version 0.2.0-alpha.2</span></span><br><span class="line"><span class="string">[rustsbi] Platform Name      : riscv-virtio,qemu</span></span><br><span class="line"><span class="string">[rustsbi] Platform SMP       : 1</span></span><br><span class="line"><span class="string">[rustsbi] Platform Memory    : 0x80000000..0x88000000</span></span><br><span class="line"><span class="string">[rustsbi] Boot HART          : 0</span></span><br><span class="line"><span class="string">[rustsbi] Device Tree Region : 0x87000000..0x87000ef2</span></span><br><span class="line"><span class="string">[rustsbi] Firmware Address   : 0x80000000</span></span><br><span class="line"><span class="string">[rustsbi] Supervisor Address : 0x80200000</span></span><br><span class="line"><span class="string">[rustsbi] pmp01: 0x00000000..0x80000000 (-wr)</span></span><br><span class="line"><span class="string">[rustsbi] pmp02: 0x80000000..0x80200000 (---)</span></span><br><span class="line"><span class="string">[rustsbi] pmp03: 0x80200000..0x88000000 (xwr)</span></span><br><span class="line"><span class="string">[rustsbi] pmp04: 0x88000000..0x00000000 (-wr)</span></span><br><span class="line"><span class="string">[TRACE 0]load app 0 at 0x0000000080400000</span></span><br><span class="line"><span class="string">[TRACE 0]load app 1 at 0x0000000080420000</span></span><br><span class="line"><span class="string">[TRACE 0]load app 2 at 0x0000000080440000</span></span><br><span class="line"><span class="string">[INFO 0]start scheduler!</span></span><br><span class="line"><span class="string">[ERROR 1]unknown trap: 0x0000000000000007, stval = 0x0000000000000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[INFO 1]进程 1 以代码 -1 退出</span></span><br><span class="line"><span class="string">IllegalInstruction in application, core dumped.</span></span><br><span class="line"><span class="string">[INFO 2]进程 2 以代码 -3 退出</span></span><br><span class="line"><span class="string">IllegalInstruction in application, core dumped.</span></span><br><span class="line"><span class="string">[INFO 3]进程 3 以代码 -3 退出</span></span><br><span class="line"><span class="string">[PANIC 3] os/loader.c:15: all apps over</span></span><br></pre></td></tr></table></figure>

<p>第一个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> *p = (<span class="keyword">int</span> *)<span class="number">0</span>;</span><br><span class="line">	*p = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在您提供的代码中，将空指针分配给指针变量*p 后，试图对其进行解引用并将值 0 赋给该指针。由于用户模式下禁止直接访问物理内存，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped.</p>
<p>在 RISC-V 架构中，U 模式是最低的用户模式，用户程序无法直接访问物理内存或其他特权级别资源。这种限制是为了确保操作系统的安全性和稳定性。</p>
<p>第二个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;sret&quot;</span>)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>试图使用汇编语言执行 sret 指令，该指令用于从中断或异常处理程序返回。由于用户模式下禁止直接访问特权级别寄存器，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped。</p>
<p>第三个进程测试用例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	uint64 x;</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;csrr %0, sstatus&quot;</span> : <span class="string">&quot;=r&quot;</span>(x))</span></span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因同上，试图使用汇编语言执行 csrr 指令，该指令用于从特权级别寄存器中读取值。由于用户模式下禁止直接访问特权级别寄存器，操作系统会检测到这个非法操作并触发异常。因此，该程序 IllegalInstruction in application, core dumped。</p>
<p>在操作系统代码中，触发异常后会进入<code>void usertrap()</code> 函数，该函数会根据 <code>scause</code> 寄存器的值判断异常类型，用例中的结果进入了<code>case IllegalInstruction</code>，其中 <code>IllegalInstruction = 2</code>。我们查阅手册 <code>riscv-privileged.pdf</code> ，可以查到 <code>IllegalInstruction</code> 的值为 2，与预期相符。</p>
<h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h2><p>请结合用例理解 trampoline.S 中两个函数 <code>userret</code> 和 <code>uservec</code> 的作用，并回答如下几个问题：</p>
<h3 id="L79-刚进入-userret-时，a0、a1-分别代表了什么值。"><a href="#L79-刚进入-userret-时，a0、a1-分别代表了什么值。" class="headerlink" title="L79: 刚进入 userret 时，a0、a1 分别代表了什么值。"></a>L79: 刚进入 <code>userret</code> 时，<code>a0</code>、<code>a1</code> 分别代表了什么值。</h3><p>在进入<code>userret</code>函数时，<code>a0</code>和<code>a1</code>分别代表以下值：</p>
<ul>
<li><code>a0</code>: TRAPFRAME 的地址，指向当前进程的陷阱帧（trapframe）结构体。</li>
<li><code>a1</code>: 用户页表的地址，即进程的页表（pagetable）。这个地址会被写入到<code>satp</code>寄存器中，用于切换到用户模式的页表。</li>
</ul>
<h3 id="L87-L88-sfence-指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？"><a href="#L87-L88-sfence-指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？" class="headerlink" title="L87-L88: sfence 指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？"></a>L87-L88: <code>sfence</code> 指令有何作用？为什么要执行该指令，当前章节中，删掉该指令会导致错误吗？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">csrw satp, a1</span><br><span class="line">sfence.vma zero, zero</span><br></pre></td></tr></table></figure>

<p><code>sfence</code>指令（Store Fence）的作用是确保之前的存储操作完成，并且对其他处理器上的核心可见。</p>
<p>执行<code>sfence</code>指令的主要目的是为了保证内存访问的顺序性和一致性。在多核处理器系统中，不同的核心可能会有自己的缓存，当一个核心修改了共享内存中的数据时，为了保证其他核心能够看到这个修改，需要使用<code>sfence</code>指令来刷新缓存并将修改写回共享内存。</p>
<p>在代码中，<code>sfence</code>指令被用于确保对用户页表的修改对其他处理器上的核心可见。因为目前我只使用了单核处理器，所以不会出现多核处理器的情况，因此<code>sfence</code>指令的作用是确保对用户页表的修改对当前核心可见。</p>
<p>因此，当前章节中，<strong>删掉该指令不会导致错误</strong>。</p>
<h3 id="L96-L125-为何注释中说要除去-a0？哪一个地址代表-a0？现在-a0-的值存在何处？"><a href="#L96-L125-为何注释中说要除去-a0？哪一个地址代表-a0？现在-a0-的值存在何处？" class="headerlink" title="L96-L125: 为何注释中说要除去 a0？哪一个地址代表 a0？现在 a0 的值存在何处？"></a>L96-L125: 为何注释中说要除去 <code>a0</code>？哪一个地址代表 <code>a0</code>？现在 <code>a0</code> 的值存在何处？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># restore all but a0 from TRAPFRAME</span><br><span class="line">ld ra, 40(a0)</span><br><span class="line">ld sp, 48(a0)</span><br><span class="line">ld t5, 272(a0)</span><br><span class="line">ld t6, 280(a0)</span><br></pre></td></tr></table></figure>

<p><code>a0</code> 是<strong>保存在 <code>sscratch</code> 寄存器中的</strong>，首先，该代码通过 <code>ld</code> 指令从 <code>TRAPFRAME</code> 中加载各个寄存器的值。然后，这些值被存储在相应的寄存器中，以便在恢复用户上下文时使用。</p>
<p>接下来，代码使用 <code>csrrw</code> 指令将 sscratch 寄存器的值与 <code>a0</code>（即 <code>TRAPFRAME</code>）进行交换。这样做是为了将用户的 <code>a0</code>（<code>TRAPFRAME</code>）保存在 <code>sscratch</code> 寄存器中，以便后续步骤可以正确地恢复用户上下文。</p>
<p>最后，通过 <code>sret</code> 指令返回到用户模式，并将控制权交给用户代码。在执行 <code>sret</code> 指令后，处理器将根据用户上下文中的 <code>sepc</code> 寄存器的值跳转到用户代码的指令地址。返回的同时，处理器还会自动恢复 <code>sstatus</code> 寄存器的值，以确保正确的特权级别和中断状态。</p>
<h3 id="userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？"><a href="#userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？" class="headerlink" title="userret：中发生状态切换在哪一条指令？为何执行之后会进入用户态？"></a><code>userret</code>：中发生状态切换在哪一条指令？为何执行之后会进入用户态？</h3><p>在<code>userret</code>函数中，发生状态切换的指令是<code>sret</code>指令。 </p>
<p><code>sret</code>指令用于从内核模式切换到用户模式，并将控制权交给用户代码。执行<code>sret</code>指令后，处理器会根据用户上下文中的<code>sepc</code>寄存器的值跳转到用户代码的指令地址。</p>
<p>执行<code>sret</code>指令之后进入用户态的原因是，该指令会自动恢复<code>sstatus</code>寄存器的值，以确保正确的特权级别和中断状态。当<code>sret</code>指令执行后，处理器将从内核态切换回用户态，程序将继续执行用户代码。这意味着<code>userret</code>函数成功完成了从内核切换到用户模式的过程。</p>
<h3 id="L29：执行之后，a0-和-sscratch-中各是什么值，为什么？"><a href="#L29：执行之后，a0-和-sscratch-中各是什么值，为什么？" class="headerlink" title="L29：执行之后，a0 和 sscratch 中各是什么值，为什么？"></a>L29：执行之后，a0 和 sscratch 中各是什么值，为什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csrrw a0, sscratch, a0     </span><br></pre></td></tr></table></figure>

<p>在执行指令后，<code>a0</code>和<code>sscratch</code>中的值发生了互换。</p>
<p>假设原始<code>a0</code>寄存器中的值为 X，而<code>sscratch</code>寄存器中的值为 Y。执行<code>csrrw a0, sscratch, a0</code>指令后，<code>a0</code>寄存器中的值变为 Y，而<code>sscratch</code>寄存器中的值变为 X。</p>
<p>这是因为<code>csrrw</code>指令是一个特权指令，用于将某个 CSR（Control and Status Register）的值读取到目标寄存器，然后将目标寄存器的值写回到该 CSR 中。在这里，<code>csrrw a0, sscratch, a0</code>指令将<code>sscratch</code>寄存器的值读取到<code>a0</code>寄存器中，同时将<code>a0</code>寄存器中的值写回到<code>sscratch</code>寄存器中，从而实现了两者之间的数据交换。</p>
<h3 id="L32-L61-从-trapframe-第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？"><a href="#L32-L61-从-trapframe-第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？" class="headerlink" title="L32-L61: 从 trapframe 第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？"></a>L32-L61: 从 trapframe 第几项开始保存？为什么？是否从该项开始保存了所有的值，如果不是，为什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sd ra, 40(a0)</span><br><span class="line">sd sp, 48(a0)</span><br><span class="line">...</span><br><span class="line">sd t5, 272(a0)</span><br><span class="line">sd t6, 280(a0)</span><br></pre></td></tr></table></figure>

<h3 id="进入-S-态是哪一条指令发生的？"><a href="#进入-S-态是哪一条指令发生的？" class="headerlink" title="进入 S 态是哪一条指令发生的？"></a>进入 S 态是哪一条指令发生的？</h3><h3 id="L75-L76-ld-t0-16-a0-执行之后，t0中的值是什么，解释该值的由来？"><a href="#L75-L76-ld-t0-16-a0-执行之后，t0中的值是什么，解释该值的由来？" class="headerlink" title="L75-L76: ld t0, 16(a0) 执行之后，t0中的值是什么，解释该值的由来？"></a>L75-L76: <code>ld t0, 16(a0)</code> 执行之后，<code>t0</code>中的值是什么，解释该值的由来？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ld t0, 16(a0)</span><br><span class="line">jr t0</span><br></pre></td></tr></table></figure>

<p><code>ld t0, 16(a0)</code>就是从 <code>trapframe</code> 中恢复 <code>t0</code>寄存器值，<code>t0</code>保存了<code>kernel_trap</code>的入口地址。使用 <code>jr t0</code>，就跳转到了我们早先设定在 <code>trapframe-&gt;kernel_trap</code> 中的地址，也就是 <code>trap.c</code> 之中的 <code>usertrap</code> 函数。这个函数在 <code>main</code> 的初始化之中已经调用了。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/09/01/yq%E4%B8%BAyaml%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%8E%92%E5%BA%8F/" itemprop="url">yq 为 yaml 文件内容排序</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-09-01T13:37:25.000Z" itemprop="datePublished">9月 1 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 读完 (约 243 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>配置 <code>yaml</code> 文件时会遇到需要将配置的内容按照键值排序的情况，比如下面这样<code>riscv_fork_list.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">packages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">accumulo</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">abseil-cpp</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acpica-tools</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acpid</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">activemq</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">afflib</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">adcli</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">adwaita-icon-theme</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aide</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alsa-lib</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">amtk</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">anaconda</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-sshd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">annobin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">antlr3</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-csv</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aom</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-beanutils</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-daemon</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-el</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-exec</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-jexl</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-poi</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-rat</span></span><br></pre></td></tr></table></figure>

<p>我想按照 <code>name</code> 的字母顺序排序，可以使用 <code>yq</code> 工具来实现。</p>
<h1 id="安装-yq"><a href="#安装-yq" class="headerlink" title="安装 yq"></a>安装 yq</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq &amp;&amp;\</span><br><span class="line">    chmod +x /usr/bin/yq</span><br></pre></td></tr></table></figure>

<h1 id="使用-yq"><a href="#使用-yq" class="headerlink" title="使用 yq"></a>使用 yq</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yq -i <span class="string">&#x27;.packages |= sort_by(.name)&#x27;</span> riscv_fork_list.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">packages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">abseil-cpp</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">accumulo</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acpica-tools</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">acpid</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">activemq</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">adcli</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">adwaita-icon-theme</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">afflib</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aide</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alsa-lib</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">amtk</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">anaconda</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">annobin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">antlr3</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aom</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-beanutils</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-csv</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-daemon</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-el</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-exec</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-commons-jexl</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-poi</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-rat</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache-sshd</span></span><br></pre></td></tr></table></figure><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/09/01/%E8%A7%A3%E5%86%B3%E5%A4%8D%E5%88%B6Markdown%E6%96%87%E6%9C%AC%E5%88%B0%E6%80%9D%E6%BA%90%E7%AC%94%E8%AE%B0%E6%97%A0%E6%B3%95%E8%BD%AC%E4%B9%89%E4%B8%BAMarkdown%E6%A0%BC%E5%BC%8F/" itemprop="url">解决复制 Markdown 文本到思源笔记无法转义为 Markdown 格式</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-09-01T12:25:05.000Z" itemprop="datePublished">9月 1 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 读完 (约 300 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在 VSCode 中编辑 Markdown 文本，复制到思源笔记后，思源笔记无法转义为 Markdown 格式。会变成一个代码块，但是代码块内的内容并不是复制的内容。</p>
<p>比如上面这段话复制到思源笔记成了下图这样：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/09/01/264c4a2f58447a13c50012a676bf0ed7.png"></p>
<p>但是我需要的是能够转义为 Markdown 的阅读模式。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>问题的原因在于 VSCode 复制的文本是带格式的，而思源笔记默认的粘贴模式是纯文本模式，所以会出现上面的问题。</p>
<p>解决方法就是从 VSCode 复制的内容为纯文本，一种可以把文本复制到 <code>txt</code> 文件中，再复制，但是比较麻烦。</p>
<p>第二种方法是使用 VSCode 的插件 <code>Copy Plain Text</code>，搜索下载后，默认快捷键为 <code>Ctrl+Alt+C</code>，可以复制为纯文本。</p>
<p>再次粘贴到思源笔记中，就可以转义为 Markdown 格式了。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/09/01/4f9aa2d7cb07f061aabbc5977977b6cb.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/31/uCore-%E5%AE%9E%E9%AA%8C%E7%AC%AC2%E7%AB%A0-%E6%89%B9%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F/" itemprop="url">uCore 实验第 2 章 - 批处理系统</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-31T15:16:38.000Z" itemprop="datePublished">8月 31 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/uCore-%E5%AE%9E%E9%AA%8C/">uCore 实验</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            几秒 读完 (约 60 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">    subgraph entry.S</span><br><span class="line">        _entry[_entry]</span><br><span class="line">    end</span><br><span class="line">    subgraph link_app.S</span><br><span class="line">        _app_num[_app_num]</span><br><span class="line">    end</span><br><span class="line">    subgraph main.c</span><br><span class="line">        main[main]</span><br><span class="line">    end</span><br><span class="line">    subgraph loader.c</span><br><span class="line">        loader_init[loader_init]</span><br><span class="line">        run_next_app[run_next_app]</span><br><span class="line">        load_app[load_app]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    _entry --&gt; main</span><br><span class="line">    main --&gt; loader_init</span><br><span class="line">    main --&gt; run_next_app</span><br><span class="line">    run_next_app --&gt; load_app</span><br><span class="line">    loader_init --&gt; _app_num</span><br></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/29/%E5%A6%82%E4%BD%95%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85VSCode%E6%8F%92%E4%BB%B6/" itemprop="url">如何离线安装 VSCode 插件</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-29T12:59:19.000Z" itemprop="datePublished">8月 29 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E4%B8%87%E8%83%BD-VSCode/">万能 VSCode</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            3 分钟 读完 (约 458 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="背景简介"><a href="#背景简介" class="headerlink" title="背景简介"></a>背景简介</h1><p>在使用 VSCode 的过程中，我们经常会安装一些插件来提高开发效率。但是，由于某些原因，我们可能无法直接访问 VSCode 的插件市场，这时候我们就需要离线安装插件了。</p>
<p>这里存在两种情况，一种是为本地的 VSCode 安装插件，另一种是为远程的 VSCode 安装插件。本文将分别介绍这两种情况下的离线安装方法。</p>
<blockquote>
<p>远程 VSCode 也就是 VSCode 的<a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/remote-overview">Remote Development</a>功能，可以通过 SSH、Docker、WSL 等方式远程连接到远程主机上的 VSCode。</p>
</blockquote>
<h1 id="方法一：使用已安装的插件目录"><a href="#方法一：使用已安装的插件目录" class="headerlink" title="方法一：使用已安装的插件目录"></a>方法一：使用已安装的插件目录</h1><ul>
<li>从已经安装插件的电脑上拷贝所有插件，路径一般为 <code>C:\用户\用户名\.vscode\extensions</code></li>
<li>拷贝到离线安装的电脑上的 <code>.vscode/extensions</code> 文件夹下即可，重启 VScode 即可安装成功。</li>
</ul>
<p>对于远程 VSCode 我们需要知道，插件不区分操作系统，所以我们可以在本地的 Windows 上的 VSCode 上安装插件，然后将插件目录压缩后整个拷贝到远程主机上即可。</p>
<p>远程主机上的插件目录一般在 <code>~/.vscode-server/extensions</code> 下。将压缩的文件解药到这个目录下，重启 VSCode 即可。</p>
<h1 id="方法二：下载离线安装包-vslx-安装"><a href="#方法二：下载离线安装包-vslx-安装" class="headerlink" title="方法二：下载离线安装包 vslx 安装"></a>方法二：下载离线安装包 vslx 安装</h1><ul>
<li><p>到 <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/vscode">VScode 插件中心</a> 搜索需要使用的插件名称</p>
</li>
<li><p>下载对应的拓展程序文件，下载的文件的后缀是<code>.vslx</code><br><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/29/f4349bbfc8cf734951fc70e2f5b0eabd.png"></p>
</li>
<li><p>VSCode 中安装<br><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/29/25b2839add215a8a61449f0ac9b1ca81.png"></p>
</li>
</ul>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/28/Windows%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/" itemprop="url">Windows 端口映射</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-28T15:24:53.000Z" itemprop="datePublished">8月 28 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 读完 (约 312 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h1><p>在 Windows 中，可以使用 netsh 命令来添加、查看和删除端口转发规则。</p>
<p>要<strong>添加一个端口转发规则</strong>，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenaddress=&lt;local_address&gt; listenport=&lt;local_port&gt; connectaddress=&lt;remote_address&gt; connectport=&lt;remote_port&gt;</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>&lt;local_address&gt;</code>是本地监听的地址（可以是 IP 地址或 0.0.0.0 表示所有地址）。</li>
<li><code>&lt;local_port&gt;</code>是本地监听的端口。</li>
<li><code>&lt;remote_address&gt;</code>是转发连接到的远程地址。</li>
<li><code>&lt;remote_port&gt;</code>是转发连接到的远程端口。</li>
</ul>
<p>例如，要将本地的 8080 端口转发到远程服务器上的 80 端口，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenaddress=127.0.0.1 listenport=8080 connectaddress=192.168.0.100 connectport=80</span><br></pre></td></tr></table></figure>

<p>要<strong>查看当前的端口转发规则</strong>，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy show v4tov4</span><br></pre></td></tr></table></figure>

<p>要<strong>删除特定的端口转发规则</strong>，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy delete v4tov4 listenaddress=&lt;local_address&gt; listenport=&lt;local_port&gt;</span><br></pre></td></tr></table></figure>
<p>其中的<code>&lt;local_address&gt;</code>和<code>&lt;local_port&gt;</code>应该与你想删除的规则匹配。</p>
<p>请注意，执行这些操作通常需要管理员权限。</p>
<h1 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h1><p>使用开源工具<a target="_blank" rel="noopener" href="https://github.com/zmjack/PortProxyGUI/releases">PortProxyGUI</a>可以在 UI 界面快速增删改查端口映射。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/28/e5bf0ce1f4a25150f69586825c2e7309.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/28/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E5%AE%B6%E9%87%8C%E7%9A%84WSL2/" itemprop="url">内网穿透远程访问家里的 WSL2</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-28T14:45:01.000Z" itemprop="datePublished">8月 28 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            6 分钟 读完 (约 856 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="背景简介"><a href="#背景简介" class="headerlink" title="背景简介"></a>背景简介</h1><p>WSL2 是 Windows 的子系统，可以在 Windows 上运行 Linux，但是 WSL2 是运行在虚拟机中的，所以无法直接访问 WSL2 中的服务，比如 SSH 服务。本文介绍如何使用内网穿透工具<strong>花生壳</strong>来实现远程访问 WSL2 中的服务。</p>
<p>实现这一需求需要完成两个功能。</p>
<ol>
<li>WSL2 中的服务是运行在虚拟机中的，如何将公网的访问转发到 WSL2 中。</li>
<li>Windows 没有公网 IP，如何通过公网来访问。</li>
</ol>
<h1 id="WSL2-端口转发"><a href="#WSL2-端口转发" class="headerlink" title="WSL2 端口转发"></a>WSL2 端口转发</h1><p>获取 WSL2 的 IP 地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostname -I | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line">172.26.13.98</span><br></pre></td></tr></table></figure>

<p>Windows 自带的<code>netsh interface portproxy</code>可以实现端口转发。管理员身份打开 cmd，执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=2222 connectaddress=172.26.13.98 connectport=22</span><br></pre></td></tr></table></figure>
<ul>
<li>listenport：公网访问的端口（改一个不冲突的就行）</li>
<li>connectaddress：WSL2 的 IP 地址</li>
<li>connectport：WSL2 中 SSH 服务的端口 (默认为 22，不需要更改)</li>
</ul>
<p>开启 Windows 防火墙入站规则，管理员身份打开 cmd，执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name=WSL2 dir=<span class="keyword">in</span> action=allow protocol=TCP localport=2222</span><br></pre></td></tr></table></figure>

<p>这个命令是用于在 Windows 高级防火墙中添加一条规则。下面是对每个参数的解释：</p>
<ul>
<li><code>name=WSL2</code>：将规则命名为 “WSL2”。</li>
<li><code>dir=in</code>：指定规则适用于传入的网络流量。</li>
<li><code>action=allow</code>：允许通过该规则的流量通过防火墙。</li>
<li><code>protocol=TCP</code>：指定规则适用于 TCP 协议的流量。</li>
<li><code>localport=2222</code>：指定本地端口号为 2222。</li>
</ul>
<p>验证端口转发是否成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2222 user@localhost</span><br></pre></td></tr></table></figure>

<ul>
<li>user 修改成 WSL2 的用户名</li>
</ul>
<p>如果配置成功，则会成功登录 WSL2。</p>
<h1 id="安装配置花生壳"><a href="#安装配置花生壳" class="headerlink" title="安装配置花生壳"></a>安装配置花生壳</h1><p>进入官网<a target="_blank" rel="noopener" href="https://hsk.oray.com/download">下载花生壳客户端</a>，安装后打开，注册账号，登录。<strong>需要实名认证</strong></p>
<blockquote>
<p>免费账户可以绑定<strong>2 个映射</strong>，对我来说暂时够用了，免费流量 1G/月。实测阅读代码不编译的话大概<strong>每天 50M</strong>左右。</p>
</blockquote>
<p>打开客户端，添加映射，配置如下：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/28/3423c43e8d319abd89c11afd7be03a11.png"></p>
<p>保存即可。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/28/fddec1e9e0cc03c7208b4244dd35ad01.png"></p>
<p>验证是否配置成功，找一台不在同一个局域网的电脑，使用 SSH 连接 WSL2：</p>
<p>如果复制出来的访问地址为<code>abcdjsj.goho.co:33445</code>，那么 SSH 命令修改为如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 33445  user@abcdjsj.goho.co</span><br></pre></td></tr></table></figure>

<ul>
<li>user 修改成 WSL2 的用户名</li>
</ul>
<p>如果配置成功，则会成功登录 WSL2。</p>
<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><ol>
<li>WSL2 的 <strong>IP 会经常变化</strong>，如果连不上了，可以重新获取一下 IP，然后修改一下各个配置。或者想办法将 WSL2 的 IP 固定下来。</li>
<li>带宽有限，登录时比较慢，耐心等待。后续准备使用 frp 自建一个穿透服务。</li>
<li>PC 耗电伤不起啊，一百多瓦赶上三四台 NAS 了。这玩意只能应急，长时间挂机电费都够买个云服务器了。</li>
</ol>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="“System-is-booting-up-Unprivileged-users-are-not-permitted-to-log-in-yet”"><a href="#“System-is-booting-up-Unprivileged-users-are-not-permitted-to-log-in-yet”" class="headerlink" title="“System is booting up. Unprivileged users are not permitted to log in yet”"></a>“System is booting up. Unprivileged users are not permitted to log in yet”</h2><p>登录服务端，也就是 WSL2，执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /run/nologin</span><br></pre></td></tr></table></figure><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/20/PhotoPrism%E9%83%A8%E7%BD%B2%E7%A7%81%E4%BA%BA%E7%9B%B8%E5%86%8C/" itemprop="url">PhotoPrism 部署私人相册</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-20T01:48:13.000Z" itemprop="datePublished">8月 20 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/Self-Hosted/">Self-Hosted</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            5 分钟 读完 (约 759 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="Docker-compose-启动"><a href="#Docker-compose-启动" class="headerlink" title="Docker-compose 启动"></a>Docker-compose 启动</h1><p>下载官方的 <code>docker-compose.yml</code> 文件，然后修改一下端口和挂载路径，然后启动即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.photoprism.app/docker/docker-compose.yml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果无法下载下载地址可以前往 <a target="_blank" rel="noopener" href="https://docs.photoprism.app/getting-started/docker-compose/">Docker Compose - PhotoPrism</a> 查看最新。</p>
</blockquote>
<p>根据自己需要修改以下参数：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">photoprism:</span></span><br><span class="line">    <span class="comment">## Use photoprism/photoprism:preview for testing preview builds:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockerproxy.com/photoprism/photoprism:latest</span> <span class="comment"># 配置了镜像加速</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2342:2342&quot;</span> <span class="comment"># HTTP port (host:container)</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">PHOTOPRISM_ADMIN_USER:</span> <span class="string">&quot;admin&quot;</span>                 <span class="comment"># 管理员用户名</span></span><br><span class="line">      <span class="attr">PHOTOPRISM_ADMIN_PASSWORD:</span> <span class="string">&quot;12345678&quot;</span>          <span class="comment"># 管理员密码</span></span><br><span class="line">      <span class="attr">PHOTOPRISM_DETECT_NSFW:</span> <span class="string">&quot;true&quot;</span>                 <span class="comment"># 自动检测 NSFW 图片并标记隐私图片</span></span><br><span class="line">      <span class="attr">PHOTOPRISM_UPLOAD_NSFW:</span> <span class="string">&quot;true&quot;</span>                 <span class="comment"># 运行上传 NSFW 图片   </span></span><br><span class="line">    <span class="comment">## Share hardware devices with FFmpeg and TensorFlow (optional):</span></span><br><span class="line">    <span class="attr">devices:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;/dev/dri:/dev/dri&quot;</span>                           <span class="comment"># 如果有核显或者独显可以配置硬件加速</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/root/sharedfolder/syncthing/Photo_Album:/photoprism/originals/Photo_Album&quot;</span>               <span class="comment"># 照片存放路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/root/sharedfolder/syncthing/daily:/photoprism/originals/daily&quot;</span>               <span class="comment"># 照片存放路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/root/sharedfolder/syncthing/baby:/photoprism/originals/baby&quot;</span>               <span class="comment"># 照片存放路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./storage:/photoprism/storage&quot;</span>                  <span class="comment"># 不要删除 (DO NOT REMOVE)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后启动即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><strong>初始化需要时间，等待一分钟左右</strong>，然后访问 <code>http://&#123;hostip&#125;:2342</code> 即可看到登录界面。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="配置中文界面"><a href="#配置中文界面" class="headerlink" title="配置中文界面"></a>配置中文界面</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/20/eca4f02a6f2595302abe05ac41f5c965.png"></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/20/b4c5c56ab3eb0242e35a09bd5036885e.png"></p>
<h2 id="索引照片"><a href="#索引照片" class="headerlink" title="索引照片"></a>索引照片</h2><p>这个过程会调用 TensorFlow 进行照片的 AI 识别，然后自动进行分类，照片如果很多会很慢。如果只想索引某一个目录就点击图片中的区域选择指定目录，<strong>选择目录的过程会加载比较慢</strong>，需要等待。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/20/33a399732f66f9b768007377ffbcb748.png"></p>
<h1 id="使用相册"><a href="#使用相册" class="headerlink" title="使用相册"></a>使用相册</h1><p>索引完成就可以点击搜索进行查看所有照片了：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/20/c1bc29db426f442362ae17fdd8e29d63.png"></p>
<p>索引过程会根据照片的 Exif 信息自动分类，包括时间与地点。后悔从相机导出照片时把地点抹去了。</p>
<p>照片还是得及时整理呀，这成千上万张照片挨个标记还是很麻烦的，就这样吧，做个图片墙也不错。</p>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h2 id="在docker-compose-yml中删除已经索引的volume，为何图片库中还存在缓存"><a href="#在docker-compose-yml中删除已经索引的volume，为何图片库中还存在缓存" class="headerlink" title="在docker-compose.yml中删除已经索引的volume，为何图片库中还存在缓存"></a>在docker-compose.yml中删除已经索引的volume，为何图片库中还存在缓存</h2><p>缓存保存在storage中，如果图片内容不多，可以将该目录删除，重启容器。也可以通过以下命令将缓存删除：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it photo-prism bash</span><br><span class="line"><span class="comment"># 删除索引</span></span><br><span class="line">photoprism purge</span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">photoprism cleanup</span><br></pre></td></tr></table></figure>

<h2 id="全选图片，选择多个图片"><a href="#全选图片，选择多个图片" class="headerlink" title="全选图片，选择多个图片"></a>全选图片，选择多个图片</h2><p>可以选择一张图片后按住Shift到最后一张，批量选择图片</p>
<h2 id="定时索引照片"><a href="#定时索引照片" class="headerlink" title="定时索引照片"></a>定时索引照片</h2><p>可以使用 <code>crontab</code> 定时执行 <code>photoprism index</code> 命令，例如每天凌晨 3 点执行一次：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑定时任务</span></span><br><span class="line">crontab -e</span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line">0 3 * * * docker <span class="built_in">exec</span> -i photo-prism photoprism index</span><br></pre></td></tr></table></figure><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2023/08/17/Docker%E9%83%A8%E7%BD%B2Radarr%E5%88%AE%E5%89%8A%E7%94%B5%E5%BD%B1/" itemprop="url">Docker 部署 Radarr 刮削电影</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2023-08-17T14:46:26.000Z" itemprop="datePublished">8月 17 2023</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            几秒 读完 (约 90 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">radarr:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">radarr</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dockerproxy.com/linuxserver/radarr:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7878:7878&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UMASK=002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/sharedfolder/appdata/radarr:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/sharedfolder/media:/movies</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/sharedfolder/downloads/qbittorrent:/downloads</span></span><br></pre></td></tr></table></figure>

<p>配置中文界面：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/17/9dbfcaa5f918bccfa99ce64cc97a7e16.png"></p>
<p>导入视频：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/17/81a242b30d3ab2d29b7f4bf92ba246de.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
    
        
<nav class="pagination is-centered is-rounded" role="navigation" aria-label="pagination">
    <div class="pagination-previous">
        <a href="../2/">上一页</a>
    </div>
    <div class="pagination-next">
        <a href="../4/">下一页</a>
    </div>
    <ul class="pagination-list is-hidden-mobile">
        
        <li><a class="pagination-link" href="../../">1</a></li>
        
        <li><a class="pagination-link" href="../2/">2</a></li>
        
        <li><a class="pagination-link is-current" href="">3</a></li>
        
        <li><a class="pagination-link" href="../4/">4</a></li>
        
        <li><span class="pagination-ellipsis">&hellip;</span></li>
        
        <li><a class="pagination-link" href="../26/">26</a></li>
        
    </ul>
</nav>
    
    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                powered_by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ppoffice/hexo-theme-minos">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery > p > .gallery-item').unwrap();
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="../../js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站内搜索" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '../../content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="../../js/insight.js"></script>

    
</body>
</html>