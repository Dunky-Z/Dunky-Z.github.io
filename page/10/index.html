<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">










<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="../../css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>



<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="../../index.html">
                
                <img src="../../images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/26/%E8%A7%A3%E5%86%B3Unable-to-load-picture-or-PDF-file/" itemprop="url">解决 Unable to 加载 picture or PDF file</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-26T11:22:24.000Z" itemprop="datePublished">8月 26 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/Bug-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/">Bug 踩坑记录</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 分钟 lesen (Über 113 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="保留现场"><a href="#保留现场" class="headerlink" title="保留现场"></a>保留现场</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/19-25-10-0001dfd98f5655f4cb7f8c57dbb72723-20220826192508-b7c23b.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Unable to load picture or PDF file <span class="hljs-string">&#x27;xxxxxx&#x27;</span> &lt;to be <span class="hljs-built_in">read</span> again&gt; xxxx<br></code></pre></td></tr></table></figure>

<h2 id="探究原因"><a href="#探究原因" class="headerlink" title="探究原因"></a>探究原因</h2><p>图片链接错误，转换 PDF 过程中会先下载所有图片到<code>AppData/Local/Temp/tex2pdf.****</code>文件夹里，因为无法正常下载图片，所有报错。检查图片链接是否有效。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>检查图片链接是否有效。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/26/VSCode%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C-%E5%8C%B9%E9%85%8D%E9%AB%98%E4%BA%AE/" itemprop="url">VSCode搜索结果/匹配高亮</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-26T08:42:50.000Z" itemprop="datePublished">8月 26 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E4%B8%87%E8%83%BD-VSCode/">万能 VSCode</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            3 分钟 lesen (Über 451 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="调教背景"><a href="#调教背景" class="headerlink" title="调教背景"></a>调教背景</h1><p>在VSCode使用搜索/替换时，匹配的字符会“高亮”（高亮个屁），知道自己当前搜到到什么位置，如果匹配字符较少还好，如果匹配太多，默认的高亮就很难发现当前已经搜索到什么位置了。比如我当前在搜索“搜索”这两个字：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220826172833.png"></p>
<p>大家还能看到我当前搜索到哪了吗？</p>
<p>但是如果设置成这样呢？</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220826173732.png"></p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="搜索匹配时高亮颜色"><a href="#搜索匹配时高亮颜色" class="headerlink" title="搜索匹配时高亮颜色"></a>搜索匹配时高亮颜色</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/17-40-49-b7f234e14ff670f8c4292f17edb9929b-20220826174048-2a64ac.png"></p>
<p>添加如下配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-string">&quot;workbench.colorCustomizations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;editor.findMatchBackground&quot;</span>: <span class="hljs-string">&quot;#ff0000&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>表示搜索匹配时高亮，高亮颜色为红色。自己可以选择合适的颜色。</p>
<h2 id="搜索结果高亮"><a href="#搜索结果高亮" class="headerlink" title="搜索结果高亮"></a>搜索结果高亮</h2><p>与上面不同的是，搜索时会高亮所有的结果，但是点击箭头匹配到当前结果时就是上面的高亮，其余未匹配的状态就是下面的高亮：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/19-13-57-74e56317c2055ae8172b1d5e1b25491d-20220826191356-2d1dc8.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-string">&quot;workbench.colorCustomizations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;editor.findMatchHighlightBackground&quot;</span>: <span class="hljs-string">&quot;#ff00ff&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="选择时颜色"><a href="#选择时颜色" class="headerlink" title="选择时颜色"></a>选择时颜色</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/19-06-58-45781dd55134fcc6a88b0b1a0c222b06-20220826190657-1dd776.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-string">&quot;workbench.colorCustomizations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;editor.selectionBackground&quot;</span>: <span class="hljs-string">&quot;#2f00ff&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="范围搜索时背景颜色"><a href="#范围搜索时背景颜色" class="headerlink" title="范围搜索时背景颜色"></a>范围搜索时背景颜色</h2><p>有时候搜索不是全局搜索，是在自己选中的范围内搜索，那这个范围也是可以高亮的，开启范围搜索需要点击搜索框的按钮，如图所示：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/19-08-48-65f21c17444a9ebe51ce7f0f2edd4880-20220826190846-94ad92.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-string">&quot;workbench.colorCustomizations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;editor.findMatchHighlightBackground&quot;</span>: <span class="hljs-string">&quot;#ff00ff&quot;</span>,<br>    <span class="hljs-attr">&quot;editor.findRangeHighlightBackground&quot;</span>: <span class="hljs-string">&quot;#ff9900&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/26/RISC-V%E5%85%A5%E9%97%A8-%E4%BB%BB%E5%8A%A1%E5%88%87%E6%8D%A2%E4%B8%8E%E9%94%81/" itemprop="url">RISC-V 入门 - 任务切换与锁</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-26T07:15:34.000Z" itemprop="datePublished">8月 26 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/RISC-V-%E5%85%A5%E9%97%A8/">RISC-V 入门</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            15 分钟 lesen (Über 2227 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="任务切换"><a href="#任务切换" class="headerlink" title="任务切换"></a>任务切换</h1><h2 id="任务简介"><a href="#任务简介" class="headerlink" title="任务简介"></a>任务简介</h2><h3 id="多任务与上下文"><a href="#多任务与上下文" class="headerlink" title="多任务与上下文"></a>多任务与上下文</h3><p>任务就是一个指令执行流。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220826151826.png"></p>
<p>如果有多个 HART，那就可以同时执行多个指令执行流。</p>
<p>协作式多任务</p>
<p>协作式环境下，下一个任务被调度的前提是当前任务主动放弃处理器。</p>
<p>抢占式多任务</p>
<p>抢占式环境下，操作系统完全决定任务调度方案，操作系统可以剥夺当前任务对处理器的使用，将处理器提供给其它任务。</p>
<h2 id="协作式多任务"><a href="#协作式多任务" class="headerlink" title="协作式多任务"></a>协作式多任务</h2><h3 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a>上下文切换</h3><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-09-51-b76ed5f4ea873bd1530963a096aaa8e3-20220828140950-e37c6b.png"></p>
<p>切换过程需要完成：</p>
<ul>
<li>保存上文（保存上一个任务的寄存器信息）</li>
<li>恢复下文（恢复下一个任务的寄存器信息）</li>
</ul>
<p>CPU 中有 32 个寄存器，保存各种状态，在切换过程中我们主要关注两个寄存器：<code>ra(x1) 存放返回地址</code>，<code>mscratch 一个特权寄存器，指向当前处理的任务</code>。</p>
<h3 id="切换过程"><a href="#切换过程" class="headerlink" title="切换过程"></a>切换过程</h3><p>初始化寄存器，根据调用约定，<code>ra</code>都初始化为任务的第一条指令地址。<code>mscratch</code>开始指向 Task A。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-18-23-20b781289e8722e343e09f63910e5991-20220828141822-f0be20.png"></p>
<p>Task A 稳定执行，当他想要放弃 CPU 时，就会执行 <code>call swithc_to</code>指令。执行<code>call</code>的过程中，就会把当前指令的下一条指令的地址放到 CPU 的<code>ra</code>寄存器。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-21-23-1c9725267e1afd49dcc75e21da78c2e4-20220828142122-246130.png"></p>
<p>接下里跳转到<code>swithc_to</code>函数执行，该函数是切换上下文的核心函数。首先<strong>保存上文</strong>，将 CPU 中的寄存器信息全部保存：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-23-39-71d991190cae709f0135d994f9ccd7e2-20220828142338-67c814.png"></p>
<p><strong>切换</strong><code>mscratch</code>指针到下一个任务 Task B：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-24-41-47c1a159644584da7b435cbc5d7a2e56-20220828142440-398b0f.png"></p>
<p><strong>恢复下文</strong>：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-25-21-b5c57f4cd4d127e11679113987238f06-20220828142520-570733.png"></p>
<p>当<code>swithc_to</code>函数执行到<code>return</code>时，接下来执行的指令就是 CPU 中<code>ra</code>保存的那条指令，也就是地址为<code>j</code>指令，这就是 Task B 的第一条指令，这样就完成了任务的切换。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/14-28-34-62e744963f90c6a45930b7ec91c4960a-20220828142833-60e64d.png"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="切换核心函数-switch-to"><a href="#切换核心函数-switch-to" class="headerlink" title="切换核心函数 switch_to"></a>切换核心函数 switch_to</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">switch_to:</span><br><span class="line"> csrrw t6, mscratch, t6 # swap t6 and mscratch</span><br><span class="line"> beqz t6, 1f   # Notice: previous task may be NULL</span><br><span class="line"> reg_save t6   # save context of prev task</span><br><span class="line">                        # 把CPU的信息保存到内存</span><br><span class="line"></span><br><span class="line"> # Save the actual t6 register, which we swapped into</span><br><span class="line"> # mscratch</span><br><span class="line"> mv t5, t6  # t5 points to the context of current task</span><br><span class="line"> csrr t6, mscratch # read t6 back from mscratch</span><br><span class="line"> sw t6, 120(t5) # save t6 with t5 as base</span><br><span class="line"></span><br><span class="line">1:</span><br><span class="line"> # switch mscratch to point to the context of the next task</span><br><span class="line"> csrw mscratch, a0</span><br><span class="line"></span><br><span class="line"> # Restore all GP registers</span><br><span class="line"> # Use t6 to point to the context of the new task</span><br><span class="line"> mv t6, a0</span><br><span class="line"> reg_restore t6      # 把内存里的信息恢复到CPU</span><br><span class="line"></span><br><span class="line"> # Do actual context switching.</span><br><span class="line"> ret</span><br></pre></td></tr></table></figure>

<h4 id="创建和初始化第一号任务"><a href="#创建和初始化第一号任务" class="headerlink" title="创建和初始化第一号任务"></a>创建和初始化第一号任务</h4><p>使用结构体<code>context</code>保存上下文中寄存器的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line"> <span class="comment">/* ignore x0 */</span></span><br><span class="line"> <span class="keyword">reg_t</span> ra;</span><br><span class="line"> <span class="keyword">reg_t</span> sp;</span><br><span class="line"> <span class="keyword">reg_t</span> gp;</span><br><span class="line"> <span class="keyword">reg_t</span> tp;</span><br><span class="line"> <span class="keyword">reg_t</span> t0;</span><br><span class="line"> <span class="keyword">reg_t</span> t1;</span><br><span class="line"> <span class="keyword">reg_t</span> t2;</span><br><span class="line"> <span class="keyword">reg_t</span> s0;</span><br><span class="line"> <span class="keyword">reg_t</span> s1;</span><br><span class="line"> <span class="keyword">reg_t</span> a0;</span><br><span class="line"> <span class="keyword">reg_t</span> a1;</span><br><span class="line"> <span class="keyword">reg_t</span> a2;</span><br><span class="line"> <span class="keyword">reg_t</span> a3;</span><br><span class="line"> <span class="keyword">reg_t</span> a4;</span><br><span class="line"> <span class="keyword">reg_t</span> a5;</span><br><span class="line"> <span class="keyword">reg_t</span> a6;</span><br><span class="line"> <span class="keyword">reg_t</span> a7;</span><br><span class="line"> <span class="keyword">reg_t</span> s2;</span><br><span class="line"> <span class="keyword">reg_t</span> s3;</span><br><span class="line"> <span class="keyword">reg_t</span> s4;</span><br><span class="line"> <span class="keyword">reg_t</span> s5;</span><br><span class="line"> <span class="keyword">reg_t</span> s6;</span><br><span class="line"> <span class="keyword">reg_t</span> s7;</span><br><span class="line"> <span class="keyword">reg_t</span> s8;</span><br><span class="line"> <span class="keyword">reg_t</span> s9;</span><br><span class="line"> <span class="keyword">reg_t</span> s10;</span><br><span class="line"> <span class="keyword">reg_t</span> s11;</span><br><span class="line"> <span class="keyword">reg_t</span> t3;</span><br><span class="line"> <span class="keyword">reg_t</span> t4;</span><br><span class="line"> <span class="keyword">reg_t</span> t5;</span><br><span class="line"> <span class="keyword">reg_t</span> t6;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE 1024</span></span><br><span class="line"><span class="keyword">uint8_t</span> task_stack[STACK_SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">ctx_task</span>;</span></span><br></pre></td></tr></table></figure>

<p>写一个任务函数，功能就是每隔<code>1000</code> 滴答打印一句话。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">user_task0</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> uart_puts(<span class="string">&quot;Task 0: Created!\n&quot;</span>);</span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  uart_puts(<span class="string">&quot;Task 0: Running...\n&quot;</span>);</span><br><span class="line">  task_delay(<span class="number">1000</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化任务，需要初始化栈，并把任务的首地址保存到<code>context</code>的<code>ra</code>寄存器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sched_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> w_mscratch(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> ctx_task.sp = (<span class="keyword">reg_t</span>) &amp;task_stack[STACK_SIZE - <span class="number">1</span>];</span><br><span class="line"> ctx_task.ra = (<span class="keyword">reg_t</span>) user_task0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="切换到第一个用户任务"><a href="#切换到第一个用户任务" class="headerlink" title="切换到第一个用户任务"></a>切换到第一个用户任务</h4><p><code>switch_to</code>函数的参数就是上下文，当执行到<code>ret</code>时也就切换到了<code>user_task0</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">context</span> *<span class="title">next</span> =</span> &amp;ctx_task;</span><br><span class="line"> switch_to(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是单任务的情况，如果是多任务时，就用数组保存多个<code>context</code>，最大支持 10 个任务。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_TASKS 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE 1024</span></span><br><span class="line"><span class="keyword">uint8_t</span> task_stack[MAX_TASKS][STACK_SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">ctx_tasks</span>[<span class="title">MAX_TASKS</span>];</span></span><br></pre></td></tr></table></figure>

<p>使用简单的求模取余的方式确定下一个任务是哪一个：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * _top is used to mark the max available position of ctx_tasks</span></span><br><span class="line"><span class="comment"> * _current is used to point to the context of current task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _top = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> _current = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * implment a simple cycle FIFO schedular</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (_top &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">  panic(<span class="string">&quot;Num of task should be greater than zero!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> _current = (_current + <span class="number">1</span>) % _top;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">context</span> *<span class="title">next</span> =</span> &amp;(ctx_tasks[_current]);</span><br><span class="line"> switch_to(next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为多个任务协作，需要一个函数来表示主动放弃 CPU：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DESCRIPTION</span></span><br><span class="line"><span class="comment"> *  task_yield()  causes the calling task to relinquish the CPU and a new </span></span><br><span class="line"><span class="comment"> *  task gets to run.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">task_yield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> schedule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用关系"><a href="#调用关系" class="headerlink" title="调用关系"></a>调用关系</h4><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/16-43-26-148e18481402d4cbebda0b8cf437ea9a-20220828164325-f03e61.png"></p>
<h2 id="抢占式多任务"><a href="#抢占式多任务" class="headerlink" title="抢占式多任务"></a>抢占式多任务</h2><p>抢占式多任务：抢占式环境下，操作系统完全决定任务调度方案，操作系统可以剥夺当前任务对处理器的使用，将处理器提供给其他任务。</p>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/18-26-19-d09627e0016250e4dd00e93a6d816ccc-20220828182618-7b140d.png"></p>
<p>对 MSIP 写入 1 时触发 软中断，写入 0 时表示对中断进行应答，也就是处理完了软中断。</p>
<h1 id="任务同步与锁"><a href="#任务同步与锁" class="headerlink" title="任务同步与锁"></a>任务同步与锁</h1><h2 id="并发与同步"><a href="#并发与同步" class="headerlink" title="并发与同步"></a>并发与同步</h2><p>并发：多个控制流同时执行</p>
<ul>
<li>多处理器多任务</li>
<li>单处理器多任务</li>
<li>单处理器任务 + 中断</li>
</ul>
<p>同步：为了保证在并发执行的环境中各个控制流可以有效执行而采用的一种编程技术</p>
<h2 id="临界区、锁与死锁"><a href="#临界区、锁与死锁" class="headerlink" title="临界区、锁与死锁"></a>临界区、锁与死锁</h2><p>临界区：在并发的程序执行环境中，所谓临界区指的是一个会访问<strong>共享资源</strong>的<strong>指令片段</strong>，而且当这样的多个指令片段同时访问某个共享资源时可能会引发问题。</p>
<p>在并发环境下为了有效控制临界区的执行（同步），我们要做的是当有一个控制流进入临界区时，其他相关控制流必须等待。</p>
<p>锁：一种常见的用来实现同步的技术</p>
<ul>
<li>不可睡眠锁</li>
<li>可睡眠锁</li>
</ul>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/20-20-57-50e42984517b60ca08ec0dff17bc634f-20220828202056-fdd4f5.png"></p>
<p>当发生中断时，右边的任务获取 CPU 资源，开始执行，但是获取锁时发现当前已经处于锁定状态，所以就处于等待状态。</p>
<p>当下一个中断发生，左侧任务回去 CPU 后会继续执行，实际上左侧任务也不必等待，他可以一直执行，因为右侧任务一直无法获取锁。</p>
<p>当然，右侧任务也可以一直触发中断，让左侧任务让出 CPU。也就是左侧任务逻辑上可以一直运行，但是实际还是会被打断。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/20-22-25-783fb565f517c52bef12807070e8c0df-20220828202224-b7ec1e.png"></p>
<p>当左侧任务执行完释放锁，右侧任务就可以获取锁，并正常执行下去。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/20-28-29-39d640fb2c0f9ea420f9d8ceca38c8e2-20220828202828-bb9696.png"></p>
<p>死锁：当控制流执行路径中会涉及多个锁，并且这些控制流执行路径获取的顺序不同时就可能发送死锁。</p>
<p>解决死锁：</p>
<ul>
<li>调整获取锁的顺序，比如保持一致</li>
<li>尽可能防止任务在持有一把锁同时申请其他锁</li>
</ul>
<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/21-27-17-2a3d0048acc7b4a3d63b46b7fd67aa59-20220828212715-480a91.png"></p>
<p>不能从 C 语言的层面去理解锁，应该要从指令级别去理解。上面的这种上锁方式是有问题的。</p>
<p>如果两个控制流同时加锁，就可能同时获取了锁，因为在汇编指令级别，每条指令执行也是需要时间的：</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/21-33-11-e1ad7600b03b294097a9fe9b52ac2cd6-20220828213310-65b79a.png"></p>
<p>AMOSWAP</p>
<pre><code class="asm">loop:
    lw a4, -20(s0)  # 参数1
    li a5, 1        # 参数 2
    amoswap.w.aq a5, a5, (a4)   # 将a5与a4指向的内存的值进行交换
                                # 将 1 与 a4 交换，表示如果原来上锁（1）那就什么都没做
                                # 如果原来没上锁（0）那就立即上锁 
    mv a3, a5
    bnez a3,loop

![](https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2022/08/28/21-38-57-b7cece2166dba14bd128970cefdd2702-20220828213857-b116cd.png)
</code></pre>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/23/RISC-V%E5%85%A5%E9%97%A8-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" itemprop="url">RISC-V 入门 - 内存管理</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-23T14:33:11.000Z" itemprop="datePublished">8月 23 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/RISC-V-%E5%85%A5%E9%97%A8/">RISC-V 入门</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            8 分钟 lesen (Über 1230 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>如何计算堆的大小，只有算出可用空间才能对其管理。</p>
<p>ENTRY</p>
<p>功能：用于设置入口点，即程序中执行的第一条指令<br>symbol 参数是一个符号的名称</p>
<p>OUTPUT_ARCH</p>
<p>功能：指定输出文件所适用的计算机体系架构</p>
<blockquote>
<p>为什么用 riscv64-unknown-elf-gcc，但是编译出来的文件是 32 位程序？<br>riscv64 是 host 是 64 位系统，编译 target 是由 gcc 的参数决定</p>
</blockquote>
<p>MEMORY</p>
<p>功能：用于描述目标机器上内存区域的位置，大小和相关</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">MEMORY<br>&#123;<br>    <span class="hljs-comment">/* 内存类型为ROM，起始地址0，长度256K */</span><br>    rom(rx):<span class="hljs-attr">ORIGIN</span> = <span class="hljs-number">0</span>, <span class="hljs-attr">LENGTH</span> = <span class="hljs-number">256</span>K<br>    <span class="hljs-comment">/* 内存类型为RAM，起始地址0x40000000，长度4M */</span><br>    ram(!rx):<span class="hljs-attr">org</span> = <span class="hljs-number">0</span>x40000000, <span class="hljs-attr">l</span> = <span class="hljs-number">4</span>M<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>TODO：括号里的 rx 含义是？</p>
</blockquote>
<p>SECTION</p>
<p>功能：告诉链接器如何将 input sections 映射到 output sections，以及如何将 output sections 放置到内存中。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">SECTION<br>&#123;<br>    <span class="hljs-string">.=0x0000</span>;<br>    <span class="hljs-string">.text</span>:&#123;*<span class="hljs-params">(.text)</span>&#125;<br>    <span class="hljs-string">.=0x8000000</span>;<br>    <span class="hljs-string">.data</span>:&#123;*<span class="hljs-params">(.data)</span>&#125;<br>    <span class="hljs-string">.bss</span>:&#123;*<span class="hljs-params">(.bss)</span>&#125;<br>&#125;&gt;ram<br></code></pre></td></tr></table></figure>

<p>PROVIDE</p>
<p>功能：</p>
<ul>
<li>可以在 Linker Script 中定义符号（Symbols）</li>
<li>每个符号包括一个名字（name) 和一个对应的地址值（address）</li>
<li>在代码中可以访问这些符号，等同于访问一个地址。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asm">.bss :&#123;<br> PROVIDE(_bss_start = .);    /* 当前地址赋值给符号_bss_start */<br> *(.sbss .sbss.*)<br> *(.bss .bss.*)<br> *(COMMON)<br> PROVIDE(_bss_end = .);<br>&#125; &gt;ram<br>   PROVIDE(_memory_start = ORIGIN(ram));<br>PROVIDE(_memory_end = ORIGIN(ram) + LENGTH(ram));<br><br>PROVIDE(_heap_start = _bss_end); /* 堆空间就是接在了bss段之后，所以堆开始地址就是bss结束地址 */ <br>PROVIDE(_heap_size = _memory_end - _heap_start); /* 计算堆大小 */ <br></code></pre></td></tr></table></figure>

<p><code>.global</code>表示全局变量，<code>.word</code>表示定义变量，下面的代码就是定义一些全局变量，方便在 C 代码中使用。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">/* mem.S */</span> <br><span class="hljs-meta">.section</span> .rodata<br><span class="hljs-meta">.global</span> HEAP_START<br><span class="hljs-symbol">HEAP_START:</span> <span class="hljs-meta">.word</span> _heap_start<br><br><span class="hljs-meta">.global</span> HEAP_SIZE<br><span class="hljs-symbol">HEAP_SIZE:</span> <span class="hljs-meta">.word</span> _heap_size<br><br><span class="hljs-meta">.global</span> TEXT_START<br><span class="hljs-symbol">TEXT_START:</span> <span class="hljs-meta">.word</span> _text_start<br><br><span class="hljs-meta">.global</span> TEXT_END<br><span class="hljs-symbol">TEXT_END:</span> <span class="hljs-meta">.word</span> _text_end<br><br><span class="hljs-meta">.global</span> DATA_START<br><span class="hljs-symbol">DATA_START:</span> <span class="hljs-meta">.word</span> _data_start<br><br><span class="hljs-meta">.global</span> DATA_END<br><span class="hljs-symbol">DATA_END:</span> <span class="hljs-meta">.word</span> _data_end<br><br><span class="hljs-meta">.global</span> RODATA_START<br><span class="hljs-symbol">RODATA_START:</span> <span class="hljs-meta">.word</span> _rodata_start<br><br><span class="hljs-meta">.global</span> RODATA_END<br><span class="hljs-symbol">RODATA_END:</span> <span class="hljs-meta">.word</span> _rodata_end<br><br><span class="hljs-meta">.global</span> <span class="hljs-keyword">BSS_START</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">BSS_START: </span><span class="hljs-meta">.word</span> _bss_start<br><br><span class="hljs-meta">.global</span> <span class="hljs-keyword">BSS_END</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">BSS_END: </span><span class="hljs-meta">.word</span> _bss_end<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Following global vars are defined in mem.S</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> TEXT_START;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> TEXT_END;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> DATA_START;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> DATA_END;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> RODATA_START;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> RODATA_END;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> BSS_START;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> BSS_END;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> HEAP_START;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint32_t</span> HEAP_SIZE;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGE_SIZE 4096</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">uint32_t</span> _num_pages = _num_pages = (HEAP_SIZE / PAGE_SIZE) - <span class="hljs-number">8</span>;<br></code></pre></td></tr></table></figure>

<p>实现 Page 级别的内存分配与释放</p>
<p>日常使用的操作系统，都是以字节为单位分配空间，但是为了教学方便，RVOS 是以 Page 为单位分配内存。</p>
<p>数据结构设计</p>
<h3 id="数组方式管理"><a href="#数组方式管理" class="headerlink" title="数组方式管理"></a>数组方式管理</h3><p>将内存模拟为一个连续的数组，数组的前部预留 8 个 Page 来管理其余的内存。目前考虑管理的状态有：</p>
<ul>
<li>这 Page 是否被使用了</li>
<li>这个 Page 是不是最后一块分配的内存，方便我们释放内存时找到最后一块分配的内存</li>
</ul>
<p>我们可以使用一个 8 bit 的<code>flag</code>来记录这些信息，<code>flag bit[0]</code>表示是否已使用，<code>flag bit[1]</code>表示是否是最后一个分配的页面。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Page Descriptor </span><br><span class="hljs-comment"> * flags:</span><br><span class="hljs-comment"> * - bit 0: flag if this page is taken(allocated)</span><br><span class="hljs-comment"> * - bit 1: flag if this page is the last page of the memory block allocated</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> &#123;</span><br> <span class="hljs-keyword">uint8_t</span> flags;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>也就是每一个 Page 都由一个 8 bit 的结构体<code>struct Page</code>管理，我们总共分配了 8 个 Page 用来管理，一个 Page 占 4K，那么我们可以一个管理$8 \times 4096 = 32768$个 Page。那就刚好可以管理$32768 \times 4096 = 134217728 \text{bit}$内存=128M。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/2022/08/25/19-31-49-8eed060ecd2399b0c7b8bc8dba19ca01-20220825193148-7df975.png"></p>
<p>Page 分配与释放接口设计</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 分配连续n个可用物理页</span><br><span class="hljs-comment"> * - npages: 需要分配的页的个数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">page_alloc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> npages)</span></span><br><span class="hljs-function"></span>&#123;<br> <span class="hljs-comment">/* Note we are searching the page descriptor bitmaps. */</span><br> <span class="hljs-keyword">int</span> found = <span class="hljs-number">0</span>;<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page_i</span> =</span> (struct Page *)HEAP_START;<br> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; (_num_pages - npages); i++) &#123;<br>  <span class="hljs-keyword">if</span> (_is_free(page_i)) &#123;<br>   found = <span class="hljs-number">1</span>;<br>   <span class="hljs-comment">/* </span><br><span class="hljs-comment">    * 找到第一个可用Page，继续判断是否有N个连续可用page</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page_j</span> =</span> page_i;<br>   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = i; j &lt; (i + npages); j++) &#123;<br>    <span class="hljs-keyword">if</span> (!_is_free(page_j)) &#123;<br>     found = <span class="hljs-number">0</span>;<br>     <span class="hljs-keyword">break</span>;<br>    &#125;<br>    page_j++;<br>   &#125;<br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 找到了连续的N个可用page，将N个page设置为已分配状态</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">if</span> (found) &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page_k</span> =</span> page_i;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = i; k &lt; (i + npages); k++) &#123;<br>     _set_flag(page_k, PAGE_TAKEN);<br>     page_k++;<br>    &#125;<br>    page_k--;<br>    _set_flag(page_k, PAGE_LAST);<br>                <span class="hljs-comment">// 返回可用page首地址</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *)(_alloc_start + i * PAGE_SIZE);<br>   &#125;<br>  &#125;<br>  page_i++;<br> &#125;<br> <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 释放已分配的物理页</span><br><span class="hljs-comment"> * - p: 待释放的首地址</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">page_free</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *p)</span></span><br><span class="hljs-function"></span>&#123;<br> <span class="hljs-comment">/*</span><br><span class="hljs-comment">  * 判断非法输入，p不能为空或者超出最大可分配大小</span><br><span class="hljs-comment">  */</span><br> <span class="hljs-keyword">if</span> (!p || (<span class="hljs-keyword">uint32_t</span>)p &gt;= _alloc_end) &#123;<br>  <span class="hljs-keyword">return</span>;<br> &#125;<br> <span class="hljs-comment">/* 计算出这个首地址p所在的page的描述符，也就是找到第几个描述符在管理这块内存 */</span><br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Page</span> *<span class="hljs-title">page</span> =</span> (struct Page *)HEAP_START;<br> page += ((<span class="hljs-keyword">uint32_t</span>)p - _alloc_start)/ PAGE_SIZE;<br> <span class="hljs-comment">/* 循环清空标识 */</span><br> <span class="hljs-keyword">while</span> (!_is_free(page)) &#123;<br>  <span class="hljs-keyword">if</span> (_is_last(page)) &#123;<br>   _clear(page);<br>   <span class="hljs-keyword">break</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>   _clear(page);<br>   page++;;<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/21/LaTex-listing%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE/" itemprop="url">LaTex-listing 环境设置</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-21T06:28:42.000Z" itemprop="datePublished">8月 21 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/LaTeX/">LaTeX</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            9 分钟 lesen (Über 1295 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">% 代码块listing设置<br>\lstdefinestyle&#123;mppl-listing-style&#125;&#123;<br>    language         = java,                   % 语言类型<br>    backgroundcolor  = \color&#123;&#123;HTML&#125;&#123;F7F7F7&#125;&#125;, % 背景色<br>    numbers          = left,              % 行号显示位置<br>    xleftmargin      = 5em,               % 左边距<br>    xrightmargin     = 0em,               % 右边距<br>    aboveskip        = 2em,               % 上方留白<br>    belowskip        = 0em,               % 下方留白<br>    frame            = single,            % 代码块边框是单线条<br>    rulecolor        = \color&#123;black&#125;,    % 边框颜色<br>    frameround       = tttt,              % 边框圆角<br>    framesep         = 0.19em,            % 边框与代码间距<br>    rulesepcolor     = \color&#123;black&#125;,    % 阴影颜色<br>    framexleftmargin    = -2em,           % 左边框与代码距离<br>    framexrightmargin   = -5em,           % 右边框与代码距离<br>    framexbottommargin  = 2em,            % 下边框与代码距离<br>    framextopmargin     = 2em,            % 上边框与代码距离<br>    breaklines          = true,           % 代码超出边界换行<br>    tabsize             = 4,              % tab缩进<br>    numberstyle         = \color&#123;red&#125;,    % 行号颜色<br>    keywordstyle        = \color&#123;red&#125;,    % 关键字颜色<br>    identifierstyle     = \color&#123;listing-identifier&#125;,   % 变量颜色<br>    commentstyle        = \color&#123;listing-comment&#125;,      % 注释颜色<br><br>  basicstyle       = \color&#123;listing-text-color&#125;\small\ttfamily&#123;&#125;\linespread&#123;1.15&#125;, % print whole listing small<br>  abovecaptionskip = 0em,               % 上标题边距<br>  belowcaptionskip = 1.0em,             % 下标颜边距<br>  classoffset      = 0,                 % 类名偏移量<br>  sensitive        = true,              % 是否区分大小写<br>  morecomment      = [s][\color&#123;listing-javadoc-comment&#125;]&#123;/**&#125;&#123;*/&#125;,     <br>  stringstyle      = \color&#123;listing-string&#125;,<br>  showstringspaces = false,             % 是否显示字符串空格<br>  escapeinside     = &#123;/*@&#125;&#123;@*/&#125;, % Allow LaTeX inside these special comments<br>  literate         =<br>  &#123;á&#125;&#123;&#123;\&#x27;a&#125;&#125;1 &#123;é&#125;&#123;&#123;\&#x27;e&#125;&#125;1 &#123;í&#125;&#123;&#123;\&#x27;i&#125;&#125;1 &#123;ó&#125;&#123;&#123;\&#x27;o&#125;&#125;1 &#123;ú&#125;&#123;&#123;\&#x27;u&#125;&#125;1<br>  &#123;Á&#125;&#123;&#123;\&#x27;A&#125;&#125;1 &#123;É&#125;&#123;&#123;\&#x27;E&#125;&#125;1 &#123;Í&#125;&#123;&#123;\&#x27;I&#125;&#125;1 &#123;Ó&#125;&#123;&#123;\&#x27;O&#125;&#125;1 &#123;Ú&#125;&#123;&#123;\&#x27;U&#125;&#125;1<br>  &#123;à&#125;&#123;&#123;\`a&#125;&#125;1 &#123;è&#125;&#123;&#123;\&#x27;e&#125;&#125;1 &#123;ì&#125;&#123;&#123;\`i&#125;&#125;1 &#123;ò&#125;&#123;&#123;\`o&#125;&#125;1 &#123;ù&#125;&#123;&#123;\`u&#125;&#125;1<br>  &#123;À&#125;&#123;&#123;\`A&#125;&#125;1 &#123;È&#125;&#123;&#123;\&#x27;E&#125;&#125;1 &#123;Ì&#125;&#123;&#123;\`I&#125;&#125;1 &#123;Ò&#125;&#123;&#123;\`O&#125;&#125;1 &#123;Ù&#125;&#123;&#123;\`U&#125;&#125;1<br>  &#123;ä&#125;&#123;&#123;\&quot;a&#125;&#125;1 &#123;ë&#125;&#123;&#123;\&quot;e&#125;&#125;1 &#123;ï&#125;&#123;&#123;\&quot;i&#125;&#125;1 &#123;ö&#125;&#123;&#123;\&quot;o&#125;&#125;1 &#123;ü&#125;&#123;&#123;\&quot;u&#125;&#125;1<br>  &#123;Ä&#125;&#123;&#123;\&quot;A&#125;&#125;1 &#123;Ë&#125;&#123;&#123;\&quot;E&#125;&#125;1 &#123;Ï&#125;&#123;&#123;\&quot;I&#125;&#125;1 &#123;Ö&#125;&#123;&#123;\&quot;O&#125;&#125;1 &#123;Ü&#125;&#123;&#123;\&quot;U&#125;&#125;1<br>  &#123;â&#125;&#123;&#123;\^a&#125;&#125;1 &#123;ê&#125;&#123;&#123;\^e&#125;&#125;1 &#123;î&#125;&#123;&#123;\^i&#125;&#125;1 &#123;ô&#125;&#123;&#123;\^o&#125;&#125;1 &#123;û&#125;&#123;&#123;\^u&#125;&#125;1<br>  &#123;Â&#125;&#123;&#123;\^A&#125;&#125;1 &#123;Ê&#125;&#123;&#123;\^E&#125;&#125;1 &#123;Î&#125;&#123;&#123;\^I&#125;&#125;1 &#123;Ô&#125;&#123;&#123;\^O&#125;&#125;1 &#123;Û&#125;&#123;&#123;\^U&#125;&#125;1<br>  &#123;œ&#125;&#123;&#123;\oe&#125;&#125;1 &#123;Œ&#125;&#123;&#123;\OE&#125;&#125;1 &#123;æ&#125;&#123;&#123;\ae&#125;&#125;1 &#123;Æ&#125;&#123;&#123;\AE&#125;&#125;1 &#123;ß&#125;&#123;&#123;\ss&#125;&#125;1<br>  &#123;ç&#125;&#123;&#123;\c c&#125;&#125;1 &#123;Ç&#125;&#123;&#123;\c C&#125;&#125;1 &#123;ø&#125;&#123;&#123;\o&#125;&#125;1 &#123;å&#125;&#123;&#123;\r a&#125;&#125;1 &#123;Å&#125;&#123;&#123;\r A&#125;&#125;1<br>  &#123;€&#125;&#123;&#123;\EUR&#125;&#125;1 &#123;£&#125;&#123;&#123;\pounds&#125;&#125;1 &#123;«&#125;&#123;&#123;\guillemotleft&#125;&#125;1<br>  &#123;»&#125;&#123;&#123;\guillemotright&#125;&#125;1 &#123;ñ&#125;&#123;&#123;\~n&#125;&#125;1 &#123;Ñ&#125;&#123;&#123;\~N&#125;&#125;1 &#123;¿&#125;&#123;&#123;?`&#125;&#125;1<br>  &#123;…&#125;&#123;&#123;\ldots&#125;&#125;1 &#123;≥&#125;&#123;&#123;&gt;=&#125;&#125;1 &#123;≤&#125;&#123;&#123;&lt;=&#125;&#125;1 &#123;„&#125;&#123;&#123;\glqq&#125;&#125;1 &#123;“&#125;&#123;&#123;\grqq&#125;&#125;1<br>  &#123;”&#125;&#123;&#123;&#x27;&#x27;&#125;&#125;1    <br>&#125;       <br></code></pre></td></tr></table></figure>

<h1 id="backgroundcolor-背景颜色"><a href="#backgroundcolor-背景颜色" class="headerlink" title="backgroundcolor 背景颜色"></a>backgroundcolor 背景颜色</h1><h1 id="numbers-代码行号"><a href="#numbers-代码行号" class="headerlink" title="numbers 代码行号"></a>numbers 代码行号</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    numbers             = left,             % 行号靠左<br>    basicstyle          = \ttfamily,        % 基本代码风格<br>    keywordstyle        = \bfseries,        % 关键字风格<br>    commentstyle        = \ttfamily,        % 注释的风格<br>    frame       = single,                   % 阴影效果<br>    escapeinside=``,                        % 英文分号中可写入中文<br>    xleftmargin=2em,xrightmargin=2em, aboveskip=1em,<br>    breaklines          =   true,<br>    language            = C,                % 语言选C<br>&#125; <br><br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211022328.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    numbers             = right,            % 行号靠左<br>    basicstyle          = \ttfamily,        % 基本代码风格<br>    keywordstyle        = \bfseries,        % 关键字风格<br>    commentstyle        = \ttfamily,        % 注释的风格<br>    frame       = single,                   % 阴影效果<br>    escapeinside=``,                        % 英文分号中可写入中文<br>    xleftmargin=2em,xrightmargin=2em, aboveskip=1em,<br>    breaklines          =   true,<br>    language            = C,                % 语言选C<br>&#125; <br><br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211015076.png"></p>
<h2 id="stepnumber-间隔显示行号"><a href="#stepnumber-间隔显示行号" class="headerlink" title="stepnumber 间隔显示行号"></a>stepnumber 间隔显示行号</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    numbers             = right,            % 行号靠左<br>    stepnumber          = 2,                % 每两行显示一次行号<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="firstnumber-开始行号"><a href="#firstnumber-开始行号" class="headerlink" title="firstnumber 开始行号"></a>firstnumber 开始行号</h2><ul>
<li>firstnumber = 10 开始行号为 10</li>
<li>firstnumber = last 开始行号为上一段 listing 的结束行号</li>
</ul>
<h1 id="xleftmargin-xrightmargin-aboveskip-below-距离外部元素距离"><a href="#xleftmargin-xrightmargin-aboveskip-below-距离外部元素距离" class="headerlink" title="xleftmargin/xrightmargin/aboveskip/below 距离外部元素距离"></a>xleftmargin/xrightmargin/aboveskip/below 距离外部元素距离</h1><p>设置代码块上下左右的距离，与外部元素的距离，而不是代码与边框的距离。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    basicstyle          = \ttfamily,        % 基本代码风格<br>    numbers             = left,            % 行号靠左<br>    keywordstyle        = \bfseries,        % 关键字风格<br>    commentstyle        = \ttfamily,        % 注释的风格<br>    frame       = single,                   % 阴影效果<br>    escapeinside=``,                        % 英文分号中可写入中文<br>    xleftmargin=0em,xrightmargin=0em, aboveskip=0em,belowskip=0em,<br>    breaklines          =   true,<br>    language            = C,                % 语言选C<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211031682.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Bash">\lstset&#123;<br>    basicstyle          = \ttfamily,        % 基本代码风格<br>    numbers             = left,            % 行号靠左<br>    keywordstyle        = \bfseries,        % 关键字风格<br>    commentstyle        = \ttfamily,        % 注释的风格<br>    frame               = single,                   % 线框<br>    escapeinside        =``,                        % 英文分号中可写入中文<br>    xleftmargin         =5em,<br>    xrightmargin        =0em, <br>    aboveskip           =2em,<br>    belowskip           =0em,<br>    breaklines          =   <span class="hljs-literal">true</span>,<br>    language            = C,                % 语言选C<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211030490.png"></p>
<h1 id="frame-边框样式"><a href="#frame-边框样式" class="headerlink" title="frame 边框样式"></a>frame 边框样式</h1><p>设置边框样式：</p>
<ul>
<li>none:无框</li>
<li>single:单线框</li>
<li>leftline,topline,rightline,bottomline:上下左右的线</li>
<li>ltrb:上面参数的缩写，frame=lr 表示左右有线</li>
<li>LTRB:大写表示双线</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>  frame               = single,        % 线框<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211022328.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>  frame               = shadowbox,        % 阴影<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://secure2.wostatic.cn/static/3tyNfsqexLHfHPpcdEmPzT/image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>  frame               = LR,        % 左右边框双线<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211413702.png"></p>
<h1 id="rulesepcolor-阴影颜色"><a href="#rulesepcolor-阴影颜色" class="headerlink" title="rulesepcolor 阴影颜色"></a>rulesepcolor 阴影颜色</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>  frame               = shadowbox,        % 阴影<br>  rulesepcolor= \color&#123; red!20!green!20!blue!20&#125; , % 阴影颜色<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211415065.png"></p>
<h1 id="rulecolor-边框颜色"><a href="#rulecolor-边框颜色" class="headerlink" title="rulecolor 边框颜色"></a>rulecolor 边框颜色</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    rulecolor           = \color&#123;red&#125;,      % 边框颜色<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211422584.png"></p>
<h1 id="frameround-边框倒角"><a href="#frameround-边框倒角" class="headerlink" title="frameround 边框倒角"></a>frameround 边框倒角</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>  frameround          = fftt,        % 边框倒角，f表示尖角，t表示倒角，顺序是第一个字母表示右上角，顺时针<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211419962.png"></p>
<h1 id="framesep-边框与代码的距离"><a href="#framesep-边框与代码的距离" class="headerlink" title="framesep 边框与代码的距离"></a>framesep 边框与代码的距离</h1><p>代码不会移动，动的是边框。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    framesep           = 6em,              % 边框与代码的距离<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211435956.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    framesep           = 6em,              % 边框与代码的距离<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211436155.png"></p>
<h1 id="framexleftmargin-framexrightmargin-frameytopmargin-frameybottommargin-边框与代码距离"><a href="#framexleftmargin-framexrightmargin-frameytopmargin-frameybottommargin-边框与代码距离" class="headerlink" title="framexleftmargin/framexrightmargin/frameytopmargin/frameybottommargin 边框与代码距离"></a>framexleftmargin/framexrightmargin/frameytopmargin/frameybottommargin 边框与代码距离</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    framexleftmargin    = -2em,           % 左边框与代码距离<br>    framexrightmargin   = -5em,           % 右边框与代码距离<br>    framexbottommargin  = 2em,            % 下边框与代码距离<br>    framextopmargin     = 2em,            % 上边框与代码距离<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211442407.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    framexleftmargin    = 1em,           % 左边框与代码距离<br>    framexrightmargin   = 1em,           % 右边框与代码距离<br>    framexbottommargin  = 0em,            % 下边框与代码距离<br>    framextopmargin     = 0em,            % 上边框与代码距离<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211444676.png"></p>
<h1 id="breaklines-强制换行"><a href="#breaklines-强制换行" class="headerlink" title="breaklines 强制换行"></a>breaklines 强制换行</h1><p>设置代码超长时自动换行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    breaklines         = false,           % 不换行<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211448116.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\lstset&#123;<br>    breaklines         = true,           % 不换行<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211447939.png"></p>
<h2 id="numberstyle-keywordstyle-identifierstyle-commentstyle-commentstyle-行号、关键字、标识符、注释的样式"><a href="#numberstyle-keywordstyle-identifierstyle-commentstyle-commentstyle-行号、关键字、标识符、注释的样式" class="headerlink" title="numberstyle/keywordstyle/identifierstyle/commentstyle/commentstyle 行号、关键字、标识符、注释的样式"></a>numberstyle/keywordstyle/identifierstyle/commentstyle/commentstyle 行号、关键字、标识符、注释的样式</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs LaTeX">\definecolor&#123;listing-background&#125;&#123;HTML&#125;&#123;F7F7F7&#125;<br>\definecolor&#123;listing-rule&#125;&#123;HTML&#125;&#123;B3B2B3&#125;<br>\definecolor&#123;listing-numbers&#125;&#123;HTML&#125;&#123;B3B2B3&#125;<br>\definecolor&#123;listing-text-color&#125;&#123;HTML&#125;&#123;000000&#125;<br>\definecolor&#123;listing-keyword&#125;&#123;HTML&#125;&#123;435489&#125;<br>\definecolor&#123;listing-identifier&#125;&#123;HTML&#125;&#123;435489&#125;<br>\definecolor&#123;listing-string&#125;&#123;HTML&#125;&#123;00999A&#125;<br>\definecolor&#123;listing-comment&#125;&#123;HTML&#125;&#123;8E8E8E&#125;<br>\definecolor&#123;listing-javadoc-comment&#125;&#123;HTML&#125;&#123;006CA9&#125;<br><br>\lstset&#123;<br>    numberstyle         = \color&#123;listing-numbers&#125;,      % 行号颜色<br>    keywordstyle        = \color&#123;listing-keyword&#125;,      % 关键字颜色<br>    identifierstyle     = \color&#123;listing-identifier&#125;,   % 变量颜色<br>    commentstyle        = \color&#123;listing-comment&#125;,      % 注释颜色<br>&#125; <br></code></pre></td></tr></table></figure>

<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208211618598.png"></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/20/Markdown%E4%B9%A6%E5%86%99PDF%E8%BE%93%E5%87%BA%E4%BC%98%E9%9B%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" itemprop="url">Markdown 书写 PDF 输出优雅的解决方案</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-20T00:28:03.000Z" itemprop="datePublished">8月 20 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8/">工欲善其事必先利其器</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            14 分钟 lesen (Über 2140 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="折腾背景"><a href="#折腾背景" class="headerlink" title="折腾背景"></a>折腾背景</h1><p>Markdown 的简便性是 LaTeX 无法替代的，LaTeX 对排版的精准控制能力又是 Markdown 无法比拟的。一直在寻找一种能够将 Markdown 优雅地转换成 PDF 的解决方案，虽然早就听说也使用过 Pandoc 这把瑞士军刀，但是它太过强大，以致于一直都没用明白。只会简单的转换命令，但是实际效果并不好，最近学会了使用 LaTeX 模板的功能，这才让我眼前一亮，这才是我想要的结果。</p>
<h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><iframe src="/myjs/pdfjs/web/viewer.html?file=/misc/Markdown书写PDF输出优雅的解决方案.pdf" style="width:100%;height:600px"></iframe>

<h1 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h1><p>Markdown 生成 PDF 主要需要使用 Pandoc 和 LaTeX 两个工具，具体安装方式如下：</p>
<h2 id="Pandoc-的安装"><a href="#Pandoc-的安装" class="headerlink" title="Pandoc 的安装"></a>Pandoc 的安装</h2><p>Pandoc 是由 John MacFarlane 开发的标记语言转换工具，可实现不同标记语言间的格式转换。</p>
<ul>
<li><p>Windows 下的安装：</p>
<ul>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/jgm/pandoc/releases">安装包</a>直接安装即可</li>
<li>如果安装了 Chocolate：<code>choco install pandoc</code></li>
<li>如果安装了 winget：<code>winget install pandoc</code></li>
</ul>
</li>
<li><p>Linux/FreeBSD下的安装：</p>
<ul>
<li>Pandoc 已经包含在大部分 Linux 发行版的官方仓库中，直接使用诸如<code>apt/dnf/yum/pacman</code>之类的安装工具直接安装即可</li>
</ul>
</li>
<li><p>macOS 下的安装：</p>
<ul>
<li><code>brew install pandoc</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>详细的安装说明参见：<a target="_blank" rel="noopener" href="https://pandoc.org/installing.html">官方安装文档</a></p>
</blockquote>
<h2 id="LaTeX-的安装"><a href="#LaTeX-的安装" class="headerlink" title="LaTeX 的安装"></a>LaTeX 的安装</h2><p>LaTeX 工具，建议安装 texlive。</p>
<ul>
<li>Windows 下的安装：<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/41855480">参考该文章</a>下载完整 texlive，注意安装后需要再安装 cjk，cjk-fonts 等相关 package</li>
</ul>
</li>
<li>Linux/FreeBSD下的安装：<ul>
<li>使用 <code>apt/dnf/yum/pacman/pkg</code> 等安装工具安装 texlive、texlive-latex 等相关软件包</li>
</ul>
</li>
<li>macOS 下的安装：<ul>
<li>使用 HomeBrew 安装 texlive 即可</li>
</ul>
</li>
</ul>
<h1 id="模板配置"><a href="#模板配置" class="headerlink" title="模板配置"></a>模板配置</h1><h2 id="配置-Pandoc-模板"><a href="#配置-Pandoc-模板" class="headerlink" title="配置 Pandoc 模板"></a>配置 Pandoc 模板</h2><p>为保证生成的 pdf 格式（自动插入封面、目录页、页眉页脚等信息），在本地环境中安装模板，具体步骤是：</p>
<ul>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/Dunky-Z/MPPL">MPPL: Markdown to PDF with Pandoc via Latex</a>仓库</li>
<li>将<code>template/mppl.latex</code>拷贝到<code>*/pandoc/templates</code>目录下<ul>
<li>Window 下：<code>C:/Users/USERNAME/AppData/Roaming/pandoc/templates</code>，如果<code>Roaming</code>没有<code>pandoc</code>目录，请手动创建！</li>
<li>Linux/FreeBSD/MacOS：<code>~/.pandoc/templates/</code></li>
</ul>
</li>
</ul>
<h2 id="配置-LaTeX-模板"><a href="#配置-LaTeX-模板" class="headerlink" title="配置 LaTeX 模板"></a>配置 LaTeX 模板</h2><p>模板定制主要修改模板最前面的<strong>模板基础配置</strong>相关内容，主要可修改的包括：</p>
<ul>
<li>公司和组织，目前默认是”MPPL”</li>
<li>正文缩进，目前默认是 2em（2 个中文字符，4 个英文字符）</li>
<li>主要中文字体和英文字体：目前都是微软雅黑</li>
<li>页眉、页脚展示内容，目前是：<ul>
<li>左页眉：title</li>
<li>右页眉：”企业机密 - 禁止外传”</li>
<li>左页脚：company</li>
<li>右页脚：页码</li>
</ul>
</li>
</ul>
<h2 id="字体设置"><a href="#字体设置" class="headerlink" title="字体设置"></a>字体设置</h2><p>目前页面默认的字体是微软雅黑，对于非 Windows 系统，可能不存在该字体，则有以下两种解决方案：</p>
<ol>
<li>手工安装微软雅黑字体（需要 msyh,msyhbd 两个文件）</li>
<li>修改为其他字体，如苹方、文泉驿等</li>
</ol>
<p>若需要多个团队共同使用，建议采用方案一。</p>
<h1 id="如何生成-PDF"><a href="#如何生成-PDF" class="headerlink" title="如何生成 PDF"></a>如何生成 PDF</h1><h2 id="PDF-文件指定-metadata-信息"><a href="#PDF-文件指定-metadata-信息" class="headerlink" title="PDF 文件指定 metadata 信息"></a>PDF 文件指定 metadata 信息</h2><p>在每个 Markdown 最前面增加以下主要 metadata 信息，metadata 内容开始行内容为三个“-”，结束行为三个“.”，示例如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">title:</span> <span class="hljs-string">&quot;MPPL&quot;</span><br><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;0.1&quot;</span><br><span class="hljs-attr">subtitle:</span> <span class="hljs-string">&quot;Markdown to PDF with Pandoc via LaTeX&quot;</span><br><span class="hljs-attr">date:</span> <span class="hljs-string">&quot;2022-08&quot;</span><br><span class="hljs-attr">author:</span> <span class="hljs-string">&quot;Dominic&quot;</span><br><span class="hljs-attr">company:</span> <span class="hljs-string">COMPANYNAME</span><br><span class="hljs-attr">file-code:</span> <span class="hljs-string">COMPANY-DEPARTMENT-00000000</span><br><span class="hljs-attr">logo:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">logo-url:</span> <span class="hljs-string">./img/logo.png</span><br><span class="hljs-attr">history:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">version:</span> <span class="hljs-string">V0.1</span><br>    <span class="hljs-attr">author:</span> <span class="hljs-string">Dominic</span><br>    <span class="hljs-attr">date:</span> <span class="hljs-number">2022-08-19</span><br>    <span class="hljs-attr">desc:</span> <span class="hljs-string">创建文档</span><br></code></pre></td></tr></table></figure>

<p>其他可选配置项目如下：</p>
<ul>
<li>header-left: 左页眉</li>
<li>header-right: 右页眉</li>
<li>footer-left: 左页脚</li>
<li>footer-right: 右页脚</li>
<li>CJKmainfont: 主要中文字体</li>
<li>mainfont: 主要字体</li>
<li>lot: 是否创建表格目录</li>
<li>lof: 是否创建图片目录</li>
</ul>
<blockquote>
<p>可选配置项中，建议除了 subtitle 外，全部在模板中定制，不在 Markdown 文件中定制</p>
</blockquote>
<h2 id="Markdown-其他编写要求"><a href="#Markdown-其他编写要求" class="headerlink" title="Markdown 其他编写要求"></a>Markdown 其他编写要求</h2><p>Pandoc 默认使用的 pandoc_markdown 格式，为避免 Markdown 转 pdf 格式异常，在编写 Markdown 的时候有几个原则要求：</p>
<ul>
<li>每个标题前后都必须有空行</li>
<li>每个表格前后都必须有空行</li>
<li>每个代码块前后收必须有空行</li>
<li>每个列表前后必须有空行</li>
</ul>
<p><strong>总之，不同文本类型之间都要有空行</strong>。</p>
<h2 id="生成-PDF-文件"><a href="#生成-PDF-文件" class="headerlink" title="生成 PDF 文件"></a>生成 PDF 文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pandoc --listings --pdf-engine=xelatex --template=mppl.latex README.md -o README.pdf<br></code></pre></td></tr></table></figure>

<h1 id="摆脱命令行，优雅的-VSCode-书写转换方案"><a href="#摆脱命令行，优雅的-VSCode-书写转换方案" class="headerlink" title="摆脱命令行，优雅的 VSCode 书写转换方案"></a>摆脱命令行，优雅的 VSCode 书写转换方案</h1><h2 id="VSCode-与插件安装"><a href="#VSCode-与插件安装" class="headerlink" title="VSCode 与插件安装"></a>VSCode 与插件安装</h2><p>打开 VSCode 编辑器，在插件页搜索 <code>markdown-preview-enhanced</code>，接着点击 <code>Install</code> 按钮。详情参考<a target="_blank" rel="noopener" href="https://shd101wyy.github.io/markdown-preview-enhanced/#/zh-cn/vscode-installation">VS Code 安装 MPE</a>。</p>
<blockquote>
<p>Markdown Preview Enhanced 以下简称 MPE</p>
</blockquote>
<h2 id="使用-VSCode-书写-Markdown"><a href="#使用-VSCode-书写-Markdown" class="headerlink" title="使用 VSCode 书写 Markdown"></a>使用 VSCode 书写 Markdown</h2><p>新建文件以<code>.md</code>为后缀即可开始编辑 Markdown 文件，使用 MPE 实时预览与导出。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201459472.png"></p>
<h2 id="配置-MPE-使用-Pandoc-导出"><a href="#配置-MPE-使用-Pandoc-导出" class="headerlink" title="配置 MPE 使用 Pandoc 导出"></a>配置 MPE 使用 Pandoc 导出</h2><p>右击 MPE 的预览区域，可以看到 MPE 提供多种导出 PDF 的方案，如使用 Chrome 的 Puppeteer 导出，Prince 导出，Pandoc 导出等等。</p>
<p>在未使用 Pandoc 前，我也一直使用 MPE 提供的 Chrome 方式导出，但是导出的 PDF 排版总是不尽如意。现在介绍如何使用 Pandoc 方式导出。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201500627.png"></p>
<p>创建 PDF 文档，你需要在 <code>markdown</code> 文件中的 <code>front-matter</code> 里声明 <code>pdf_document</code> 的输出类型：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-meta">---</span><br><span class="hljs-attr">output:</span><br>  <span class="hljs-attr">pdf_document:</span><br>    <span class="hljs-attr">latex_engine:</span> <span class="hljs-string">xelatex</span><br>    <span class="hljs-attr">pandoc_args:</span> [<span class="hljs-string">--template=mppl.latex</span>,<span class="hljs-string">--listings</span>]<br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>front-matter</code>：文章的最开头，也就是上文元数据放的地方。和元数据放在一起即可，如图所示：</p>
<p>  <img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201526775.png"></p>
</li>
<li><p><code>latex_engine</code>：默认情况下 PDF 文档由 <code>pdflatex</code> 生成。你可以用 <code>latex_engine</code> 选项来定义你想用的引擎。支持的引擎有 <code>pdflatex</code>，<code>xelatex</code>，以及 <code>lualatex</code>。这里需要使用<code>xelatex</code>。</p>
</li>
<li><p><code>pandoc_args</code>：配置 Pandoc 接受的一些参数，这里我们使用 <code>--template=mppl.latex</code> 和 <code>--listings</code> 来指定模板和使用 <code>listings</code>。这里配置的参数就是执行 Pandoc 时使用的参数，以后就不需要命令行输入了。这里使用上文的<code>mppl.latex</code>模板。</p>
</li>
</ul>
<p>配置完之后，右击预览界面，选择 Pandoc 导出，稍等片刻，即可生成 PDF 文件。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201537508.png"></p>
<h1 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h1><h2 id="LaTeX-相关错误"><a href="#LaTeX-相关错误" class="headerlink" title="LaTeX 相关错误"></a>LaTeX 相关错误</h2><p>VSCode 导出出错时报错信息较短，并且常常不知道具体报错原因及位置，因为是 LaTeX 转换成 PDF 的过程中出现的错误。报错位置是 LaTeX 中间源码的位置，而不是 VSCode 中的位置。这时候我常用的方法是先将 Markdown 转为 LaTeX，然后再转为 PDF，在 LaTeX 编辑器里就可以看到错误位置了。</p>
<p>比如下面这个错误，我们能看到一些报错信息<code>cant use \spacefactor in math mode</code>，但是并不知道具体哪里的错误。从信息里可以看出和<code>\LaTex</code>有关，大概能推测出是使用了这个命令，因为文章里使用了这个命令的地方只有一处。但是如果有其他的错误，就很难确定了。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201655326.png"></p>
<h3 id="Markdown-转换-LaTeX"><a href="#Markdown-转换-LaTeX" class="headerlink" title="Markdown 转换 LaTeX"></a>Markdown 转换 LaTeX</h3><p>这里还是以模板仓库的<code>README.md</code>为例，当然这个文件是可以正常转换 PDF 的，不会报错。这里只是拿<code>README.md</code>做一个如何使用命令的演示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pandoc --listings --template=mppl.latex -s README.md -o README.tex<br></code></pre></td></tr></table></figure>

<h3 id="LaTeX-编辑器打开，以-TexStudio-为例"><a href="#LaTeX-编辑器打开，以-TexStudio-为例" class="headerlink" title="LaTeX 编辑器打开，以 TexStudio 为例"></a>LaTeX 编辑器打开，以 TexStudio 为例</h3><p>打开<code>README.tex</code>文件，编译：<br><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201708811.png"></p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208201717673.png"></p>
<p>我们可以快速的定位到问题出现的位置，只要搜索相关问题即可。</p>
<blockquote>
<p>\LaTeX{} 这个宏不能用在数学模式下。但是因为我在 Markdown 里必须使用美元符号<code>$$</code>才能表示 LaTeX 环境，才能正确输出 LaTeX 符号，而 Markdown 转换成 LaTeX 源码时，这个宏就会被包裹在数学环境里，就会报错。如果我想在 PDF 里显示这个符号，那就在 Markdown 里不使用美元符号<code>$$</code>，而是直接输入<code>\LaTeX&#123;&#125;</code>即可，再导出 PDF 时就不会报错。</p>
</blockquote>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/19/IIC%E5%8D%8F%E8%AE%AE/" itemprop="url">IIC 协议</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-19T06:16:29.000Z" itemprop="datePublished">8月 19 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/Embedded-Development/">Embedded Development</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            10 分钟 lesen (Über 1553 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="IIC-概述"><a href="#IIC-概述" class="headerlink" title="IIC 概述"></a>IIC 概述</h1><p><strong>IIC（Inter-Integrated Circuit）</strong>，也叫 I2C（Inter-IC Communication）总线，是一种串行通信协议，由 Philips 公司在 1980 年代初开发。IIC 总线用于连接微控制器、传感器和其他集成电路，它具有以下特点：</p>
<ol>
<li>双线制结构简单：由一条数据线（SDA）和一条时钟线（SCL）组成。</li>
<li>多主机并行通信：多个 Master 设备可同时接入同一条 IIC 总线上进行数据交换。</li>
<li>硬件资源占用少：只要两根线就可以连接多个器件。</li>
<li>数据传输速率快：现代 IIC 总线的最高传输速率可达到 400Kbps。</li>
<li>低功耗设计：使用者可以通过软件控制设备进入睡眠模式以减少功耗。</li>
</ol>
<h1 id="传输协议"><a href="#传输协议" class="headerlink" title="传输协议"></a>传输协议</h1><h2 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h2><ul>
<li>主机要发出一个<strong>起始信号</strong></li>
<li>主机发出一个<strong>设备地址</strong>用来确定是往那一个芯片写数据，以及写标记（0）</li>
<li>从设备回应（用来确定这个设备是香存在，然后就可以传输数据）</li>
<li>主设备发送一个字节数据给从设备，并等待回应</li>
<li>每传输一字节故据，接收方要有一个回应信号（确定故据是否接受完成），然后再传输下一个故据。</li>
<li>数据发送完之后，主机就会发送一个停止信号。</li>
</ul>
<h2 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h2><ul>
<li>主机要发出一个<strong>起始信号</strong></li>
<li>主机发出一个<strong>设备地址</strong>用来确定是往那一个芯片读数据，以及读标记（1）</li>
<li>从设备回应（用来确定这个设备是否存在），然后就可以传输数据</li>
<li>从设备发送一个字节放据给主设备，并等待回应</li>
<li>每传输一字节数据，接收方要有一个回应信号（确定数据是否接受完成），然后再传输下一个放据。</li>
<li>数据发送完之后，主芯片就会发送一个停止信号。</li>
</ul>
<h1 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h1><h2 id="空闲状态"><a href="#空闲状态" class="headerlink" title="空闲状态"></a>空闲状态</h2><ul>
<li>SCL 和 SDA 都为高电平</li>
</ul>
<p>此时各个器件的输出级场效应管均处在截止状态，即释放总线，由两条信号线各自的上拉电阻把电平拉高。</p>
<h2 id="起始状态"><a href="#起始状态" class="headerlink" title="起始状态"></a>起始状态</h2><p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/19/e9d2b88fa97d66c8a93d089299d6f636.png"></p>
<ul>
<li>SCL 为高电平，SDA 由高电平变为低电平</li>
</ul>
<p>标志着一次数据传输的开始。起始信号是由主控器主动建立的，在建立该信号之前 I2C 总线必须处于空闲状态。</p>
<h2 id="结束状态"><a href="#结束状态" class="headerlink" title="结束状态"></a>结束状态</h2><ul>
<li>SCL 为高电平，SDA 由低电平变为高电平</li>
</ul>
<h2 id="数据传输状态"><a href="#数据传输状态" class="headerlink" title="数据传输状态"></a>数据传输状态</h2><ul>
<li>SCL 高电平期间，SDL 保持稳定<ul>
<li>SDL 为高电平表示 1，低电平表示 0</li>
</ul>
</li>
</ul>
<p>在 IIC 总线上传送的每一位数据都有一个时钟脉冲相对应 (或同步控制)，即在 SCL 串行时钟的配合下，数据在 SDA 上从高位向低位依次串行传送每一位的数据。进行数据传送时，在 SCL 呈现高电平期间，SDA 上的电平必须保持稳定，低电平为数据 0，高电平为数据 1。只有在 SCL 为低电平期间，才允许 SDA 上的电平改变状态。下图是 <code>0xaa</code> 在 IIC 总线上有效传输 (有效传输是指第 9 个时钟的高电平期间，从机给主机反馈了一个有效的应答位 0) 的图示</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img//2023/08/19/d851ded7e34114e925809dbcf33fa894.png"></p>
<blockquote>
<p>在时序图中，MSB 代表的是 Most Significant Bit（最高位）。它表示二进制数中最左边的一位，也就是最高位。在一个 n 位的二进制数中，最高位的权值为 2^(n-1)。因此，MSB 在时序图中通常用来指示二进制数或数据字的最高位。同理，LSB 代表的是 Least Significant Bit（最低位）。它表示二进制数中最右边的一位，也就是最低位。</p>
</blockquote>
<h2 id="应答状态"><a href="#应答状态" class="headerlink" title="应答状态"></a>应答状态</h2><ul>
<li>SCL 为高电平，SDA 由高电平变为低电平（上图最后的 ACK 标记）</li>
</ul>
<p>I2C 总线上的所有数据都是以 8 位字节传送的，发送器 (主机) 每发送一个字节，就在<strong>第 9 个时钟</strong>脉冲期间释放数据线，由从设备反馈一个应答信号。应答信号为<strong>低电平</strong>时，规定为<strong>有效应答位</strong> (ACK 简称应答位)，表示接收器已经成功地接收了该字节；应答信号为<strong>高电平时</strong>，规定为<strong>非应答位</strong> (NACK)，一般表示接收器接收该字节没有成功。对于反馈有效应答位 ACK 的要求是，接收器在第 9 个时钟脉冲之前的低电平期间将 <strong>SDA</strong> 线拉低，并且确保在该<strong>时钟的高电平期间为稳定的低电平</strong>。</p>
<p>以下四种情况 IIC 通信过程中会产生非应答位（NACK）：</p>
<ul>
<li>从机正在处理某些实时的操作无法与主机实现 IIC 通信的时候，从机会给主机反馈一个非应答 (NACK)</li>
<li>主机发送数据的过程中，从机无法解析发送的数据，从机也会给主机反馈一个非应答位 (NACK)</li>
<li>主机发送数据的过程中，从机无法再继续接收数据，从机也会给主机反馈一个非应答位 (NACK)</li>
<li>主机从从机中读取数据的过程中，主机不想再接收数据，主机会给从机反馈一个非应答位 (NACK)，注意，这种情况是主机给从机反馈一个非应答位 (NACK)</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liujinggang/p/9656358.html">IIC总线的原理与Verilog实现 - jgliu - 博客园</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xuyan123/p/14134246.html">IIC时序分析 - 夏天师妹 - 博客园</a></li>
</ol>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/16/%E7%BC%96%E8%AF%91%E9%94%99%E8%AF%AF%E4%BB%A5%E8%8B%B1%E6%96%87%E8%BE%93%E5%87%BA/" itemprop="url">编译错误以英文输出</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-16T14:31:43.000Z" itemprop="datePublished">8月 16 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/%E4%B8%87%E8%83%BD-VSCode/">万能 VSCode</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            几秒 lesen (Über 61 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>因为终端配置的原因，编译的结果输出是中文，这样搜索问题不如英文的表述精确。配置终端的语言为英文，就可以输出英文。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> LANG=en_US<br></code></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/16/%E8%A7%A3%E5%86%B3cast-from-pointer-to-integer-of-different-size/" itemprop="url">解决 cast from pointer to integer of different size</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-16T03:42:24.000Z" itemprop="datePublished">8月 16 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="../../categories/Bug-%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/">Bug 踩坑记录</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            2 分钟 lesen (Über 326 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h1 id="保留现场"><a href="#保留现场" class="headerlink" title="保留现场"></a>保留现场</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dst, ...)</span> </span>&#123;<br>    <span class="hljs-comment">// some code</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> offset = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>) dst % <span class="hljs-number">8</span>; <span class="hljs-comment">// warning here!</span><br>    <span class="hljs-comment">// some code continue...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>写驱动程序时经常会直接对地址进行修改，配置寄存器的值，也会将地址的值作为数据进行传递，这就会遇到一个问题，指针强转成整型，类型不匹配数据丢失的问题。</p>
<h1 id="探究原因"><a href="#探究原因" class="headerlink" title="探究原因"></a>探究原因</h1><p>出现这个警告的原因是，将<code>void*</code>类型强转成<code>unsigned int</code>是不可移植的。什么叫<strong>不可移植</strong>呢？</p>
<p>我们知道指针类型，在 32 位系统下是 4 字节，在 64 位系统下是 8 字节，而<code>unsigned int</code>不管在什么系统下都是是 4 字节，所以，如果将<code>void*</code>类型强转成<code>unsigned int</code>，在 64 位系统下就没有足够的空间保存真正的数据。</p>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><h2 id="粗暴地用double来接收"><a href="#粗暴地用double来接收" class="headerlink" title="粗暴地用double来接收"></a>粗暴地用<code>double</code>来接收</h2><p>先接收，再截断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dst, ...)</span> </span>&#123;<br>    <span class="hljs-comment">// some code</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> offset = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">double</span>) dst % <span class="hljs-number">8</span>; <span class="hljs-comment">// warning here!</span><br>    <span class="hljs-comment">// some code continue...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="uintptr-t"><a href="#uintptr-t" class="headerlink" title="uintptr_t"></a>uintptr_t</h2><p><code>uintptr_t</code> 保证足够宽，以便将 <code>void*</code> 转换为 <code>uintptr_t</code> 并再次返回将产生原始指针值。还有一个类型 <code>intptr_t</code>，它是有符号的；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-comment">// 或者 &lt;inttypes.h&gt;</span><br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *dst, ...)</span> </span>&#123;<br>    <span class="hljs-comment">// some code</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> offset = (<span class="hljs-keyword">uintptr_t</span>) dst % <span class="hljs-number">8</span>; <span class="hljs-comment">// warning here!</span><br>    <span class="hljs-comment">// some code continue...</span><br>&#125;<br></code></pre></td></tr></table></figure>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
        <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="../../2022/08/14/DEBUG%E5%8E%9F%E7%90%86/" itemprop="url">DEBUG 原理</a>
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-08-14T06:17:26.000Z" itemprop="datePublished">8月 14 2022</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            19 分钟 lesen (Über 2866 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>了解调试原理时看到了一个质量比较高的视频，<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iN411Z7jk?spm_id_from=333.999.0.0&vd_source=7ff88341de4b5111bdf3db48b4e9ca44">【蛋饼嵌入式】一起探究调试原理</a>。UP 通俗，形象地讲解了 DEBUG 的一些原理，值得反复观看，但是视频不如文字查阅效率高，遂记录了以下文稿内容。</p>
<h2 id="什么是-JTAG"><a href="#什么是-JTAG" class="headerlink" title="什么是 JTAG"></a>什么是 JTAG</h2><p>1985 年，几家半导体厂商为了解决板级测试的问题，成立了 Joint Test Action Group（JTAG）联合测试行动小组，他们希望将测试点和测试电路集成在芯片内部引脚处。同时，留出一个统一协议的接口，大家都能通过这个接口来访问芯片的输入与输出状态。这样就省去了板级测试是的物理接触，同时还能进行逻辑性调试。后来 IEEE 组织，将这个方案制定成了标准 IEEE 1149.1，这就是现在我们常听到的 JTAG 调试。</p>
<h2 id="边界扫描技术"><a href="#边界扫描技术" class="headerlink" title="边界扫描技术"></a>边界扫描技术</h2><p>实现 JTAG 调试最重要的一个技术就是边界扫描技术，核心思想是<strong>给芯片的每一个输入输出引脚，添加一个移位寄存器单元，也称为边界扫描单元</strong>（Boundary Scan Cell，BSC）。通过它一边可以实现对芯片输出数据的截取，另一边可以完成对输入数据的替代。正常运行状态下，这些寄存器又是透明般的存在。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208141648874.gif"></p>
<p>这些位于引脚边界的移位寄存器，还可以串在一起，形成一条边界扫描链，以串行的方式从外部更新扫描单元上的数据，以及对外输出边界扫描单元捕获的数据。如果板上有多个这样的芯片，他们还能以菊花链的形式串联在一起，这样就大大方便了测试的过程。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208141654770.gif"></p>
<p>要实现对内部移位寄存器单元或者说对整个扫描链的访问和操作，便依赖于 JTAG 调试协议和相应的物理接口。JTAG 标准接口包括以下几个部分：</p>
<ul>
<li>TDI(Test Data In)</li>
<li>TDO(Test Data Out)</li>
<li>TCLK(Test Clock)</li>
<li>TMS(Test Mode Select)</li>
<li>TRST(Test Reset)：可选，用于复位</li>
</ul>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208141655524.png"></p>
<p>调试逻辑的实现，是通过芯片内部的 TAP（Test Access Port）来完成的。模式状态信号 TMS 配合测试时钟信号 TCLK，以一定的时序进入到 TAP 控制器后，由 TAP 控制器内部的状态机转化为相应的控制动作。从而完成数据的移位，引脚状态的捕获和更新。</p>
<p>设备 ID 寄存器构成的扫描链，板卡一连上调试器，通过对这条扫描链的访问，就能够识别到被调试芯片的信号。存放调试机制相关配置的数据寄存器，所构成的扫描链，后面断点和单步调试时就会用到。以及移位的 BYPASS 寄存器，当调试链路上有多个芯片连接时，来减少总调试链路的长度。</p>
<p>以上都属于数据寄存器构成扫描链，因为想要在他们之间进行切换，需要引入另外的指令寄存器，以及对应的扫描链，这样调试主机将不同的调试命令写到指令寄存器中，就可以选通需要调试的数据链路。数据与指令寄存器两种链路的切换，就通过 TAP 控制器完成。</p>
<blockquote>
<p>补充：<br>如果芯片支持 JTAG 调试，那么芯片上就必须有上述的四个接口，TDI，TDO，TCLK，TMS。<br><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208141725205.png"><br>芯片外有个 Adapter 与之 Pin to Pin 连接，负责协议转换，把 USB 的 JTAG 控制信息按 JTAG 协议转换输出，满足协议定义的电气特性。<br>Adapter 与 Host 连接，Host 可以是我们的 PC，也可以是另一个嵌入式调试器。<br>Host 上通常需要运行一些软件，如 OpenOCD，负责把 GDB 的高级别命令转换成 JTAG 命令，并通过特定 Adapter 的要求进行打包，调用 OS 提供的 USB/ETH/PCI 驱动发送出去。<br>GDB 与 OpenOCD 通过一些远程协议，如 TCP/IP，进行通信。这样就能够调试 Chip。</p>
</blockquote>
<h2 id="断点是如何实现的？"><a href="#断点是如何实现的？" class="headerlink" title="断点是如何实现的？"></a>断点是如何实现的？</h2><p>通过以上 JTAG 调试接口，我们已经能够测试引脚的输入输出了，同时也获得了观察和改变芯片内部数据的机会，那么接下来我们如何进行调试呢？比如打个断点？</p>
<p>断点作为一种干预性调试，根据调试行为的不同，分为监控模式和中止模式。</p>
<ul>
<li>监控模式（软件断点）：会触发异常，交由相应的软件程序来处理，处理器仍然处于运行状态。</li>
<li>中止模式（硬件断点），使处理器进入非正常运行的调试状态。</li>
</ul>
<p>以 ARM 架构来说，最初工程师想到的办法是插入一条指令集中没有定义的无效指令，来<strong>替换掉希望打断指令处的源指令</strong>。这样内核运行到这条指令时，就会进入到无效指令的服务程序，在这个异常的服务程序中，我们再去做想要的调试操作，操作完成后，还原当时被替换的指令。并继续执行。</p>
<p>后来 ARMv5 开始引入专门用于调试的<code>BKPT</code>指令，类似与 X86 指令集的<code>INT3</code>指令，但不管是不是专用指令，他们都属于软件中断。这意味着我想要实时地添加这种断点，就要求能够随时地更改程序，插入断点指令，而一般只有程序运行在 RAM 上，才方便这样操作。那如果直接从 FLASH 上取址运行的程序，因为 FLASH 先擦后写的物理特性，是无法通过随意插入指令来实现断点的。更不要说从只读存储器上运行的程序，比如说固化在 BIOS 中上电自检 POST 程序，面对这种情况，需要的就是硬件断点。</p>
<p>硬件断点顾名思义，需要额外的硬件逻辑支持，主要起的作用就是<strong>暂存和比较</strong>，我们把这种实现特定逻辑的组合电路，称为<strong>宏单元</strong>（Macro Cell）。</p>
<p>还记得我们前面说过 JTAG 协议，支持自定义扩展扫描链吗？硬件断点宏单元的控制和比较两种数据寄存器，就可以作为两条拓展扫描链，加入到 JTAG 调试框架中。</p>
<p>你在调试软件中按下一个按钮，对应的那行代码地址，就会通过上述扫描链，被记录到断点宏单元相应的寄存器中，当然，调试器能够知道某行代码的地址，是依赖于编译时生成的 ELF 文件中的符号表信息。而当程序正常运行取址时，如果宏单元的寄存器，发现了总线上出现了记录过的地址，比较器就会发出调试状态信号，CPU 接收到这个信号后暂停运行，进入调试模式或者异常。</p>
<p>因为每打一个断点，都需要宏单元相应的寄存器来保存地址信息。而寄存器数量是有限的，所以调试软件一旦和芯片建立起了连接，就会通过上述的另外一条控制寄存器获得该硬件断点宏单元所支持的最大断点数，这样你在调试过程中如果断点打多了，调试器就会报错。</p>
<h2 id="为什么调试器能够烧录程序呢？"><a href="#为什么调试器能够烧录程序呢？" class="headerlink" title="为什么调试器能够烧录程序呢？"></a>为什么调试器能够烧录程序呢？</h2><p>正常情况下，CPU 内核通过内部的系统总线，从 FLASH 或者 RAM 中获取运行的指令，交换数据，并在一定的驱动程序下，实现对 FLASH 的擦除和写入操作。为了把指令和数据直接给 CPU 内核，我们还需要定义一条扫描链，这条扫描链直接在系统总线上开了一个口子，通过上位机的调试信号，把相关的操作指令直接传到总线上，供 CPU 内核取用。</p>
<p><img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/202208141752418.gif"></p>
<p>那么整个调试器的下载过程是这样的：</p>
<ul>
<li>第一，通过调试器使得 CPU 进入调试模式；</li>
<li>第二，通过总线扫描链将 FLASH 编程算法与即将被下载的用户程序放到 RAM 中；</li>
<li>第三，将 CPU 的 PC 指针指向刚刚搬运完成的 RAM 地址起始处，并退出调试状态；</li>
<li>第四，CPU 将在正常状态下运行 RAM 中的 FLASH 编程算法。将用户代码烧录到确定位置上，执行完成后回到调试状态。</li>
</ul>
<p>如果 RAM 空间不够大，以上操作还需要重复多次执行。</p>
<p>需要注意的是，在第二步操作 RAM 时，是处于调试状态下，而调试时钟的速率是无法满足 RAM 或者 FLASH 的访问速率要求的，所以在这一过程中，CPU 会频繁的在系统时钟与调试时钟之间切换</p>
<p>调试时钟下，总线扫描链先传递来要写入的数据和 RAM 地址，CPU 先分别暂存在内部通用寄存器中，接着扫描链传递写入指令，并切换为系统时钟。CPU 在正常状态下执行搬运指令，往 RAM 里写入数据，执行完成后回到调试状态，继续通过扫描链传递后面要写入的值，</p>
<h2 id="OpenOCD-Open-On-Chip-Debugger"><a href="#OpenOCD-Open-On-Chip-Debugger" class="headerlink" title="OpenOCD (Open On-Chip Debugger)"></a>OpenOCD (Open On-Chip Debugger)</h2><p>OpenOCD（Open On-Chip Debugger）开源片上调试器，是一款开源软件，最初是由 Dominic Rath 同学还在大学期间发起的（2005 年）项目。OpenOCD 旨在提供针对嵌入式设备的调试、系统编程和边界扫描功能。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iN411Z7jk?spm_id_from=333.999.0.0&vd_source=7ff88341de4b5111bdf3db48b4e9ca44">【蛋饼嵌入式】饮茶先？DEBUG 先！一起探究调试原理_哔哩哔哩_bilibili</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/125145986">浅谈 RISC-V 的 DEBUG 系统及其仿真 - 知乎</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1s54y1Z7Zj/?spm_id_from=333.788&vd_source=7ff88341de4b5111bdf3db48b4e9ca44">ESP32 JTAG Debug 01: JTAG 接口简介_哔哩哔哩_bilibili</a>+</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    
</article>




    
    
        
<nav class="pagination is-centered is-rounded" role="navigation" aria-label="pagination">
    <div class="pagination-previous">
        <a href="../9/">Vorheriges</a>
    </div>
    <div class="pagination-next">
        <a href="../11/">Nächstes</a>
    </div>
    <ul class="pagination-list is-hidden-mobile">
        
        <li><a class="pagination-link" href="../../">1</a></li>
        
        <li><span class="pagination-ellipsis">&hellip;</span></li>
        
        <li><a class="pagination-link" href="../9/">9</a></li>
        
        <li><a class="pagination-link is-current" href="">10</a></li>
        
        <li><a class="pagination-link" href="../11/">11</a></li>
        
        <li><span class="pagination-ellipsis">&hellip;</span></li>
        
        <li><a class="pagination-link" href="../26/">26</a></li>
        
    </ul>
</nav>
    
    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>




<script src="../../js/script.js"></script>


    
</body>
</html>