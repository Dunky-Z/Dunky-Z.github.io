<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>C 语言预处理 - 如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">










<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="../../../../css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>



<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="../../../../index.html">
                
                <img src="../../../../images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            C 语言预处理
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2021-09-09T06:10:40.000Z" itemprop="datePublished">9月 9 2021</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            19 分钟 读完 (约 2797 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <h2 id="什么是预处理"><a href="#什么是预处理" class="headerlink" title="什么是预处理"></a>什么是预处理</h2><p>C 语言通过预处理器提供了一些语言功能。从概念上讲，预处理器是编译过程中单独执行的第一个步骤。两个最常用的预处理器指令是：<code>#include</code> 指令 (用于在编译期间把指定文件的内容包含进当前文件中) 和 <code>#define</code> 指令 (用任意字符序列替代一个标记)。</p>
<p>为啥要进行预先处理呢？如果要深入的了解的话可以参考《程序员的自我修养：链接、装载与库》这本书。这里举一个非常常见的例子，假如我们编写跨平台的程序时，我们就需要考虑不同平台的系统库是不同的，如果只包含了一个平台下的库文件，换个平台编译就可能出错。这时候就需要在编译前进行预处理。</p>
<p>有重要的预处理器指令：<br>| 指令     | 描述|<br>|:———-:|:—–:|<br>| #define  | 定义宏|<br>| #include | 包含一个源代码文件|<br>| #undef   | 取消已定义的宏|<br>| #ifdef   | 如果宏已经定义，则返回真|<br>| #ifndef  | 如果宏没有定义，则返回真|<br>| #if      | 如果给定条件为真，则编译下面代码|<br>| #else    | #if 的替代方案|<br>| #elif    | 如果前面的 #if 给定条件不为真，当前条件为真，则编译下面代码 |<br>| #endif   | 结束一个 #if……#else 条件编译块|<br>| #error   | 当遇到标准错误时，输出错误消息|<br>| #pragma  | 使用标准化方法，向编译器发布特殊的命令到编译器中|</p>
<h2 id="条件编译"><a href="#条件编译" class="headerlink" title="条件编译"></a>条件编译</h2><h3 id="if"><a href="#if" class="headerlink" title="#if"></a><code>#if</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 整型常量表达式1</span><br>    程序段<span class="hljs-number">1</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> 整型常量表达式2</span><br>    程序段<span class="hljs-number">2</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> 整型常量表达式3</span><br>    程序段<span class="hljs-number">3</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    程序段<span class="hljs-number">4</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>它的意思是：如常“表达式 1”的值为真（非 0），就对“程序段 1”进行编译，否则就计算“表达式 2”，结果为真的话就对“程序段 2”进行编译，为假的话就继续往下匹配，直到遇到值为真的表达式，或者遇到 <code>#else</code> 。这一点和 <code>if else</code> 非常类似。</p>
<p>需要注意的是， <code>#if</code> 命令要求判断条件为<strong>整型常量表达式</strong>，也就是说，表达式中不能包含变量，而且结果必须是整数；而 <code>if</code> 后面的表达式没有限制，只要符合语法就行。这是 <code>#if</code> 和 <code>if</code> 的一个重要区别。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-comment">//不同的平台下引入不同的头文件</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> _WIN32  <span class="hljs-comment">//识别 Windows 平台</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> __linux__  <span class="hljs-comment">//识别 Linux 平台</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">//不同的平台下调用不同的函数</span><br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> _WIN32  <span class="hljs-comment">//识别 Windows 平台</span></span><br>    Sleep(<span class="hljs-number">5000</span>);<br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> __linux__  <span class="hljs-comment">//识别 Linux 平台</span></span><br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;http://c.biancheng.net/&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ifedf"><a href="#ifedf" class="headerlink" title="#ifedf"></a><code>#ifedf</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span>  宏名</span><br>    程序段<span class="hljs-number">1</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    程序段<span class="hljs-number">2</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<h3 id="ifndef"><a href="#ifndef" class="headerlink" title="#ifndef"></a><code>#ifndef</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> 宏名</span><br>    程序段<span class="hljs-number">1</span> <br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> </span><br>    程序段<span class="hljs-number">2</span> <br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>与<code>#ifdef</code>相比，仅仅是将 <code>#ifdef</code> 改为了 <code>#ifndef</code>。它的意思是，如果当前的宏未被定义，则对“程序段 1”进行编译，否则对“程序段 2”进行编译，这与<code>#ifdef</code> 的功能正好相反。</p>
<h2 id="文件包含-include"><a href="#文件包含-include" class="headerlink" title="文件包含#include"></a>文件包含#include</h2><p><code>#include</code> 叫做文件包含命令，用来引入对应的头文件（.h 文件）。 <code>#include</code> 的处理过程很简单，就是将<strong>头文件的内容插入到该命令所在的位置</strong>，从而把头文件和当前源文件连接成一个源文件，这与复制粘贴的效果相同。</p>
<p><code>#include</code> 的用法有两种，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdHeader.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;myHeader.h&quot;</span></span><br></code></pre></td></tr></table></figure>

<p>使用尖括号 <code>&lt; &gt;</code> 和双引号 <code>&quot; &quot;</code> 的区别在于头文件的搜索路径不同：</p>
<ul>
<li>使用尖括号<code>&lt; &gt;</code>，编译器会到环境变量下查找头文件；</li>
<li>使用双引号<code>&quot; &quot;</code>，编译器首先在当前目录下查找头文件，如果没有找到，再到环境变量下查找。</li>
</ul>
<p>注意事项：</p>
<ul>
<li>在头文件中尽量不要进行函数的定义，只对其进行声明。否则如果有多个源文件链接时会报错</li>
<li>某一个头文件的内容发生变化，所有包含该文件的源文件都需要重新编译</li>
<li>一个<code>#include</code>命令指定一个头文件，多个头文件需要多个<code>#include</code></li>
<li>包含可以嵌套</li>
<li>文件 1 包含文件 2，文件 2 用到文件 3，则文件 3 的包含命令#include 应放在文件 1 的头部第一行；</li>
<li>被包含文件中的静态全局变量不用在包含文件中声明</li>
</ul>
<h2 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a>宏定义</h2><h3 id="what"><a href="#what" class="headerlink" title="what"></a>what</h3><p><code>#define</code> 叫做宏定义命令，它也是 C 语言预处理命令的一种。所谓宏定义，就是用一个标识符来表示一个字符串，如果在后面的代码中出现了该标识符，那么就<strong>全部替换成指定的字符串</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>  宏名  字符串    <span class="hljs-comment">//基本格式</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> N 100           <span class="hljs-comment">//将所有N都替换成整数100</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> forever for (;;) <span class="hljs-comment">//该语句为无限循环定义了一个新名字forever</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> max(A, B) ((A)&gt; (B) ? (A) : (B) )</span><br><br></code></pre></td></tr></table></figure>

<h3 id="why"><a href="#why" class="headerlink" title="why"></a>why</h3><p>对于函数，其调用必须要将程序执行的顺序跳转到函数所在内存的某个地址，在将函数程序执行完成后，再跳转回去执行函数调用前的地方。这种跳转操作要求在函数执行前保存现场并记录当前执行地址，函数调用返回后要恢复现场，并按原来保存地址继续执行。因此，函数调用会有一定的时间和空间方面的开销，必将影响程序的运行效率。</p>
<p>对于宏，它只是在预处理的地方<strong>把代码展开</strong>，而不需要额外的空间和时间方面的开销，因此调用宏比调用函数更有效率。</p>
<p>但是，宏也有很多的问题和缺陷：</p>
<ul>
<li>在 C 语言中，宏容易出现一些边界性的问题，容易产生歧义。(优先级的问题，能加括号都加括号)</li>
<li>在 C++语言中，宏不可以调用 C++类中的私有或受保护的成员。</li>
</ul>
<h3 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>能用括号的地方都用括号，不要偷懒省略，以免歧义，特别是于带参宏定义不仅要在参数两侧加括号，还应该在整个字符串外加括号</li>
<li>宏定义不是说明或语句，在行末不必加分号，如加上分号则连分号也一起替换</li>
<li>宏定义必须写在函数之外，其作用域为宏定义命令起到源程序结束。如要终止其作用域可使用<code>#undef</code>命令</li>
<li>代码中的宏名如果被引号包围，那么预处理程序不对其作宏代替</li>
<li>宏定义允许嵌套，在宏定义的字符串中可以使用已经定义的宏名，在宏展开时由预处理程序层层代换</li>
<li>习惯上宏名用大写字母表示，以便于与变量区别</li>
<li>可用宏定义表示数据类型，使书写方便</li>
<li>带参数的宏和函数很相似，但有本质上的区别：宏展开仅仅是字符串的替换，不会对表达式进行计算；宏在编译之前就被处理掉了，<strong>它没有机会参与编译，也不会占用内存</strong>。而函数是一段可以重复使用的代码，会被编译，会给它分配内存，每次调用函数，就是执行这块内存中的代码。</li>
</ul>
<h2 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h2><p>从上文可知，可以看到宏有一些难以避免的问题，对于不能访问 C++类中私有或者受保护的成员，我们应该如何解决呢？</p>
<h3 id="what-1"><a href="#what-1" class="headerlink" title="what"></a>what</h3><p>关键字 <code>inline</code> 告诉编译器，任何地方只要调用内联函数，就直接把该函数的机器码插入到调用它的地方。这样程序执行更有效率，就好像将内联函数中的语句直接插入到了源代码文件中需要调用该函数的地方一样。</p>
<h3 id="why-1"><a href="#why-1" class="headerlink" title="why"></a>why</h3><p>内联函数是代码被插入到调用者代码处的函数。如同 <code>#define</code> 宏，内联函数通过避免被调用的开销来提高执行效率，尤其是它能够通过调用（过程化集成）被编译器优化。</p>
<p>内联函数和宏很类似，而区别在于，宏是由预处理器对宏进行替代，而<strong>内联函数是通过编译器控制来实现的</strong>。而且内联函数是真正的函数，只是在需要用到的时候，内联函数像宏一样的展开，所以取消了函数的参数压栈，减少了调用的开销。你可以像调用函数一样来调用内联函数，而不必担心会产生于处理宏的一些问题。</p>
<h3 id="How"><a href="#How" class="headerlink" title="How"></a>How</h3><p>对于内联函数，其工作原理是：</p>
<p>对于任何内联函数，编译器在符号表里放入函数的声明（包括名字、参数类型、返回值类型）。如果编译器没有发现内联函数存在错误，那么该函数的代码也被放入符号表里。在调用一个内联函数时，编译器首先检查调用是否正确（<strong>进行类型安全检查</strong>，或者进行<strong>自动类型转换</strong>，当然对所有的函数都一样）。如果正确，内联函数的代码就会直接替换函数调用，于是省去了函数调用的开销。</p>
<p>这个过程与预处理有显著的不同，<strong>因为预处理器不能进行类型安全检查，或者进行自动类型转换</strong>。假如内联函数是成员函数，对象的地址（this）会被放在合适的地方，这也是预处理器办不到的。</p>
<h3 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h3><ul>
<li>当你定义一个内联函数时，在函数定义前加上 <code>inline</code> 关键字，并且将定义放入<strong>头文件</strong>。</li>
<li>内联函数必须是和函数体声明在一起才有效</li>
<li>内联函数不宜过大，比如循环体，递归体就不适合内联。如果过大，编译器会放弃内联，采用普通方式调用函数。</li>
</ul>
<h2 id="相关参考"><a href="#相关参考" class="headerlink" title="相关参考"></a>相关参考</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/cprogramming/c-preprocessors.html">C 预处理器</a><br><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/1878.html">C 语言预处理命令是什么？</a><br><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/632378">C 语言中宏与内联函数解析</a><br><a target="_blank" rel="noopener" href="http://c.biancheng.net/view/339.html">C 语言内联函数</a><br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0">内联函数</a></p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/C/">#C</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="../../10/%E8%A7%A3%E5%86%B3TypeError-ERR-INVALID-ARG-TYPE-The-data-argument-must-be-of-type-string-or-an-instance-of-Buffe/">解决 TypeError [ERR_INVALID_ARG_TYPE]: The data argument must be of type string or an instance of Buffe</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="../../08/%E8%A7%A3%E5%86%B3expected-char-const-but-argument-is-of-type-char/">解决 expected &#39;char * const*&#39; but argument is of type &#39;char **&#39;</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                powered_by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>




<script src="../../../../js/script.js"></script>


    
</body>
</html>