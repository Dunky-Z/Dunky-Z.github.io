<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Linux内核模块校验机制 - 如云泊</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">










<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="../../../../css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>



<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="如云泊" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="../../../../index.html">
                
                <img src="../../../../images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-end">
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Linux内核模块校验机制
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2024-01-13T14:00:16.000Z" itemprop="datePublished">1月 13 2024</time>
            
        </span>
        
        
        <span class="column is-narrow">
            
            
            23 分钟 读完 (约 3484 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>初学 Linux 内核或者第一次编译使用内核模块时经常会遇到类似这样的错误：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod: ERROR: could not insert module kvm.ko: Invalid module <span class="token function">format</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个报错通常由于当前插入<code>kvm.ko</code>的<code>version magic</code>版本信息与正在运行的 kernel 的<code>version magic</code>版本不一致导致的。</p>
<h1 id="内核校验模块的流程"><a href="#内核校验模块的流程" class="headerlink" title="内核校验模块的流程"></a>内核校验模块的流程</h1><p>我们从问题出发，看看内核是如何校验模块的。搜索了内核源码，找到了在函数<code>check_version</code>中抛出了<code>disagrees about version of symbol</code>错误信息，我们根据源码来回溯一下整个过程。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">check_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>symname<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">,</span>
    <span class="token keyword">const</span> s32 <span class="token operator">*</span>crc<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 Elf_Shdr <span class="token operator">*</span>sechdrs <span class="token operator">=</span> info<span class="token operator">-></span>sechdrs<span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> versindex <span class="token operator">=</span> info<span class="token operator">-></span>index<span class="token punctuation">.</span>vers<span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> num_versions<span class="token punctuation">;</span>
 <span class="token keyword">struct</span> <span class="token class-name">modversion_info</span> <span class="token operator">*</span>versions<span class="token punctuation">;</span>

 <span class="token comment">/* Exporting module didn't supply crcs?  OK, we're already tainted. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>crc<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

 <span class="token comment">/* No versions at all?  modprobe --force does this. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>versindex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">try_to_force_load</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> symname<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>

 versions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> sechdrs<span class="token punctuation">[</span>versindex<span class="token punctuation">]</span><span class="token punctuation">.</span>sh_addr<span class="token punctuation">;</span>
 num_versions <span class="token operator">=</span> sechdrs<span class="token punctuation">[</span>versindex<span class="token punctuation">]</span><span class="token punctuation">.</span>sh_size
  <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">modversion_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_versions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u32 crcval<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token keyword">continue</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_MODULE_REL_CRCS<span class="token punctuation">)</span><span class="token punctuation">)</span>
   crcval <span class="token operator">=</span> <span class="token function">resolve_rel_crc</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
   crcval <span class="token operator">=</span> <span class="token operator">*</span>crc<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>crc <span class="token operator">==</span> crcval<span class="token punctuation">)</span>
   <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Found checksum %X vs module %lX\n"</span><span class="token punctuation">,</span>
    crcval<span class="token punctuation">,</span> versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">goto</span> bad_version<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">/* Broken toolchain. Warn once, then let it go.. */</span>
 <span class="token function">pr_warn_once</span><span class="token punctuation">(</span><span class="token string">"%s: no symbol version for %s\n"</span><span class="token punctuation">,</span> info<span class="token operator">-></span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

bad_version<span class="token operator">:</span>
 <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"%s: disagrees about version of symbol %s\n"</span><span class="token punctuation">,</span>
        info<span class="token operator">-></span>name<span class="token punctuation">,</span> symname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数说明：</p>
<ul>
<li>info: 包含正在加载信息的结构体。</li>
<li>symname: 需要查找对比的符号的名称。</li>
<li>mod: 表示模块的结构体。</li>
<li>crc: 当前正在运行的内核的模块符号的 CRC（Cyclic Redundancy Check）值</li>
</ul>
<ol>
<li>如果 CRC 为空，不检查直接 PASS</li>
<li>如果模块中没有_versions 小节，表示模块没有开启 CRC<ol>
<li>如果开启了 CONFIG_MODULE_FORCE_LOAD，则强制加载，内核标记为 tainted，直接 PASS</li>
<li>如果没有开启 CONFIG_MODULE_FORCE_LOAD，则报错</li>
</ol>
</li>
<li>如果模块中有_versions 小节，没有找到 module_layout 符号，报 warning，直接 PASS</li>
<li>如果模块中有_versions 小节，找到 module_layout 符号<ol>
<li>对比_versions 小节中的 CRC 和参数中的 CRC，如果一致，PASS</li>
<li>如果不一致，报错</li>
</ol>
</li>
</ol>
<blockquote>
<p>插播一句，CRC是什么？在 Linux 内核中，模块符号 CRC（Cyclic Redundancy Check）是一种校验值，用于确保模块中的符号（函数、变量等）在加载时与内核中的符号一致。当模块被构建时，针对每个符号都会计算一个 CRC 值，然后将这些 CRC 值保存在模块的符号版本表中。简单理解就是如果要保持CRC不变，需要满足两个条件：</p>
<ol>
<li>语法保持不变<br>  遵守这个条件，说明如果模块在新内核下重新编译，那应该没有任何语法问题。 即导出符号的类型名没有变化，如果是函数，则要求参数和返回值类型没有任何变化；如果这些类型是结构体的话，结构体的成员名也没有有任何变化。</li>
<li>语义保持不变<br> 这要求符号的类型不能有变化，如果类型本身是结构体(struct)，则它成员的类型不能有变化，成员在结构体内的位置不能有变化，以及成员本身不能增删。<br>如果想要深入了解如何计算CRC可以参考这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/linyt/article/details/42559639">Linux内核模块符号CRC检查机制-CSDN博客</a></li>
</ol>
</blockquote>
<p>分析代码我们可以知道，内核会通过遍历正在加载的模块的版本信息的数组<code>versions</code>，从中查找与给定符号名称匹配的版本信息。如果找到匹配的版本信息，则计算 CRC 值，与参数中的 CRC 值进行比较。（通过后续分析我们知道参数的 CRC 就是正在运行的内核的 module_layout 符号的 CRC）如果匹配，表示版本一致，返回 1。如果不匹配，打印调试信息，并跳转到 <code>bad_version</code>，输出警告信息。</p>
<p>这里有两个疑问，</p>
<ol>
<li><code>versions</code> 内容是怎么链接到模块的 elf 文件中的？</li>
</ol>
<p>我们找到模块的<code>mod.c</code>文件，打开可以发现以下内容：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>vermagic<span class="token punctuation">,</span> VERMAGIC_STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> KBUILD_MODNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

__visible <span class="token keyword">struct</span> <span class="token class-name">module</span> __this_module
<span class="token function">__section</span><span class="token punctuation">(</span><span class="token punctuation">.</span>gnu<span class="token punctuation">.</span>linkonce<span class="token punctuation">.</span>this_module<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
 <span class="token punctuation">.</span>name <span class="token operator">=</span> KBUILD_MODNAME<span class="token punctuation">,</span>
 <span class="token punctuation">.</span>init <span class="token operator">=</span> init_module<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODULE_UNLOAD</span></span>
 <span class="token punctuation">.</span>exit <span class="token operator">=</span> cleanup_module<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 <span class="token punctuation">.</span>arch <span class="token operator">=</span> MODULE_ARCH_INIT<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_RETPOLINE</span></span>
<span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>retpoline<span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">modversion_info</span> ____versions<span class="token punctuation">[</span><span class="token punctuation">]</span>
__used <span class="token function">__section</span><span class="token punctuation">(</span>__versions<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x3e549f1d</span><span class="token punctuation">,</span> <span class="token string">"module_layout"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x5138e6ba</span><span class="token punctuation">,</span> <span class="token string">"param_ops_int"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x183b57f9</span><span class="token punctuation">,</span> <span class="token string">"phy_ethtool_nway_reset"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x6e5363eb</span><span class="token punctuation">,</span> <span class="token string">"eth_validate_addr"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x4df55e5b</span><span class="token punctuation">,</span> <span class="token string">"usb_deregister"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span> <span class="token number">0x8e48f69b</span><span class="token punctuation">,</span> <span class="token string">"usb_register_driver"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个文件是在编译过程中调用了<code>scripts/modpost</code>脚本生成的，它的功能是在里面增加了 2 个<code>__section</code>，<code>.gnu.linkonce.this_module</code>和<code>__versions</code>。__versions 小节的内容就是一些字符串和值组成的数组，<code>check_version</code>就是解析这个小节去做验证。</p>
<ol start="2">
<li>CRC 值哪来的？</li>
</ol>
<p>我们继续向上跟踪，找到函数<code>check_modstruct_version</code>，其中<code>find_symbol</code>会在内核符号表中查找给定符号名称的符号信息，接着调用<code>check_version</code>函数，传入符号名称、模块结构体和 CRC 值，进行版本匹配。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">check_modstruct_version</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
       <span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">const</span> s32 <span class="token operator">*</span>crc<span class="token punctuation">;</span>

 <span class="token comment">/*
  * Since this should be found in kernel (which can't be removed), no
  * locking is necessary -- use preempt_disable() to placate lockdep.
  */</span>
 <span class="token function">preempt_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">find_symbol</span><span class="token punctuation">(</span><span class="token string">"module_layout"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>crc<span class="token punctuation">,</span> true<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">BUG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">check_version</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"module_layout"</span><span class="token punctuation">,</span> mod<span class="token punctuation">,</span> crc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 获取当前运行内核 module_layout 函数的 crc 值</span>
<span class="token function">find_symbol</span><span class="token punctuation">(</span><span class="token string">"module_layout"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>crc<span class="token punctuation">,</span> true<span class="token punctuation">,</span> false<span class="token punctuation">)</span>
    <span class="token function">each_symbol_section</span><span class="token punctuation">(</span>find_exported_symbol_in_section<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fsa<span class="token punctuation">)</span>
        <span class="token comment">// 遍历内核三个导出符号表段__start___ksymtab，__start___ksymtab_gpl 和__start___ksymtab_gpl_future，为每段调用 find_symbol_in_section</span>
        <span class="token function">each_symbol_in_section</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token comment">// 遍历内核每个已加载模块的三个导出符号表段 mod->syms,mod->gpl_syms,mod->gpl_future_syms，为每段调用 find_symbol_in_section</span>
        <span class="token function">each_symbol_in_section</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> mod<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token comment">// 对导出符号表进行二分查找，按照字符串排序，符号表的地址按照地址排序</span>
            <span class="token function">find_exported_symbol_in_section</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">symsearch</span> <span class="token operator">*</span>syms<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Linux 对可装载模块采取了两层验证</strong>：除了上述的模块 CRC 值校验外还有 <code>vermagic</code> 的检查。模块 vermagic（即 Version Magic String）保存了模块编译时的内核版本以及 SMP 等配置信息，当模块 vermagic 与主机信息不相符时也无法加载模块。</p>
<p>在内核中<code>load_module</code>函数调用<code>check_modstruct_version</code>函数完成 CRC 校验后，就会继续调用<code>layout_and_allocate --&gt; check_modinfo</code> 完成 vermagic 校验。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// kernel/module.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">check_modinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>mod<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">load_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>modmagic <span class="token operator">=</span> <span class="token function">get_modinfo</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"vermagic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> err<span class="token punctuation">;</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> MODULE_INIT_IGNORE_VERMAGIC<span class="token punctuation">)</span>
  modmagic <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

 <span class="token comment">/* This is allowed: modprobe --force will invalidate it. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modmagic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  err <span class="token operator">=</span> <span class="token function">try_to_force_load</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"bad vermagic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token keyword">return</span> err<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">same_magic</span><span class="token punctuation">(</span>modmagic<span class="token punctuation">,</span> vermagic<span class="token punctuation">,</span> info<span class="token operator">-></span>index<span class="token punctuation">.</span>vers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: version magic '%s' should be '%s'\n"</span><span class="token punctuation">,</span>
         info<span class="token operator">-></span>name<span class="token punctuation">,</span> modmagic<span class="token punctuation">,</span> vermagic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">-</span>ENOEXEC<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>get_modinfo</code> 会获取内核中的 vermagic 信息，模块 vermagic 信息则被保存在了 ELF 的 <code>.modinfo</code> 小节中。这里我们说的 vermagic 就是下文提到的拓展版本信息，它就是系统配置信息组成的一个字符串。</p>
<h1 id="如何解决模块校验错误"><a href="#如何解决模块校验错误" class="headerlink" title="如何解决模块校验错误"></a>如何解决模块校验错误</h1><p>Linux 对可装载模块采取了两层验证，我们需要分别从 CRC 和 vermagic 两个方面来解决模块校验错误。首先从简单的 vermagic 校验开始。我们需要保证运行的内核版本与模块编译时的内核版本一致，这样才能保证 vermagic 校验通过。首先了解如何查看内核版本以及模块版本信息，然后修改内核模块版本信息。</p>
<h2 id="解决-vermagic-校验错误"><a href="#解决-vermagic-校验错误" class="headerlink" title="解决 vermagic 校验错误"></a>解决 vermagic 校验错误</h2><h3 id="如何查看内核版本以及模块版本信息"><a href="#如何查看内核版本以及模块版本信息" class="headerlink" title="如何查看内核版本以及模块版本信息"></a>如何查看内核版本以及模块版本信息</h3><p><code>uname</code>参数功能：</p>
<ul>
<li>-s, 输出 kernel 名称；</li>
<li>-n, 输出主机名；</li>
<li>-r, 输出 kernel 发行版本号；</li>
<li>-v, 输出操作系统版本；</li>
<li>-m, 输出主机的硬件架构名称；</li>
<li>-p, 输出处理器类型；</li>
<li>-i, 输出硬件平台；</li>
<li>-o, 输出操作系统名称</li>
<li>-a, 输出所有信息</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 输出kernel发行版本号</span>
<span class="token function">uname</span> -r
<span class="token number">6.4</span>.0-10.1.0.20.oe2309.riscv64
<span class="token comment"># 输出所有信息</span>
<span class="token function">uname</span> -a
Linux openeuler <span class="token number">6.4</span>.0-10.1.0.20.oe2309.riscv64 <span class="token comment">#1 SMP Sat Oct  7 06:19:28 UTC 2023 riscv64 riscv64 riscv64 GNU/Linux</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>modinfo 可以查看模块信息，包括模块vermagic信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">modinfo kvm.ko
filename:       /root/build-kernel/kernel/./arch/riscv/kvm/kvm.ko
license:        GPL
author:         Qumranet
srcversion:     5DA13DC0E55100B5FE1D56A
depends:
intree:         Y
name:           kvm
vermagic:       <span class="token number">6.4</span>.0 SMP mod_unload modversions riscv
parm:           halt_poll_ns:uint
parm:           halt_poll_ns_grow:uint
parm:           halt_poll_ns_grow_start:uint
parm:           halt_poll_ns_shrink:uint<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>vermagic</code>就是<code>version magic</code>版本信息，可以看到当前<code>kvm.ko</code>的<code>version magic</code>版本信息为<code>6.4.0</code>。与前文的<code>uname -r</code>输出的 kernel 发行版本号<code>6.4.0-10.1.0.20.oe2309.riscv64</code>不一致。所以会报错。</p>
<h3 id="修改内核模块版本信息"><a href="#修改内核模块版本信息" class="headerlink" title="修改内核模块版本信息"></a>修改内核模块版本信息</h3><ol>
<li>修改基础版本信息</li>
</ol>
<p>打开内核源代码根目录下的 Makefile 文件。你会找到一个包含内核版本信息的地方，类似于：</p>
<pre class="line-numbers language-Makefile" data-language="Makefile"><code class="language-Makefile"># SPDX-License-Identifier: GPL-2.0
VERSION &#x3D; 6
PATCHLEVEL &#x3D; 4
SUBLEVEL &#x3D; 0
EXTRAVERSION &#x3D;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表示内核版基础本号为<code>6.4.0</code>。</p>
<ol start="2">
<li>修改拓展版本信息</li>
</ol>
<p>kernel 引入了一些配置来增强版本信息，在内核源码的<code>&quot;include/linux/vermagic.h&quot;</code>下我们可以看到模块的健全版本信息，如下默认配置的有：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Simply sanity version stamp for modules. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SMP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_SMP</span> <span class="token string">"SMP "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_SMP</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_PREEMPT_BUILD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">"preempt "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_PREEMPT_RT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">"preempt_rt "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_PREEMPT</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODULE_UNLOAD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODULE_UNLOAD</span> <span class="token string">"mod_unload "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODULE_UNLOAD</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MODVERSIONS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODVERSIONS</span> <span class="token string">"modversions "</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_VERMAGIC_MODVERSIONS</span> <span class="token string">""</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RANDSTRUCT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;generated/randstruct_hash.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_RANDSTRUCT</span> <span class="token string">"RANDSTRUCT_"</span> <span class="token expression">RANDSTRUCT_HASHED_SEED</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MODULE_RANDSTRUCT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VERMAGIC_STRING</span>                                                 <span class="token punctuation">\</span>
        <span class="token expression">UTS_RELEASE </span><span class="token string">" "</span>                                                 <span class="token punctuation">\</span>
        <span class="token expression">MODULE_VERMAGIC_SMP MODULE_VERMAGIC_PREEMPT                     </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_VERMAGIC_MODULE_UNLOAD MODULE_VERMAGIC_MODVERSIONS       </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_ARCH_VERMAGIC                                            </span><span class="token punctuation">\</span>
        <span class="token expression">MODULE_RANDSTRUCT</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，<code>&quot;UTS_RELEASE&quot;</code>的配置在内核源码的<code>&quot;include/generated/utsrelease.h&quot;</code>下可以看到，<code>utsrelease.h</code>的内容是由<code>Makefile</code>和``.config<code>的内容来生成的，当成功编译kernel以后，</code>utsrelease.h`得到更新，</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#defineUTS_RELEASE "6.4.0"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>那么前文”6.4.0-d46299ae”中的”-d46299ae”是如何得来的呢？其实这个是开发者使用了 Git 来管理代码。当你修改或者提交代码以后，每次编译内核后，在”UTS_RELEASE”后面就会看到一串哈希值，例如”6.4.0-d46299ae”，其中”-d46299ae”这个就是 Git 版本控制而产生的哈希值。发行版本号只是各个厂商用于区别自己发布的不同时期的 kernel 版本或者产品版本而产生的编号，完全由各厂商自己定义。</p>
<h2 id="解决-CRC-校验错误"><a href="#解决-CRC-校验错误" class="headerlink" title="解决 CRC 校验错误"></a>解决 CRC 校验错误</h2><p>我们可以通过一些手段修改新模块的 module_layout 的 CRC 与内核CRC相同，再插入。<code>/boot</code>目录下通常有个在<code>symvers-&lt;kernel_version&gt;.gz</code> 文件通常包含了内核模块的符号版本信息。这个文件是由 Linux 内核构建时生成的，用于记录在该内核版本下构建的模块的符号信息，包括函数和变量的名称、版本号等。里面就保存了内核的 module_layout 的 CRC 值。我们可以使用<code>gzip -d</code>命令解压这个文件，找到 module_layout 的 CRC 值，记录下来。</p>
<ul>
<li><p>方法一：使用 16 进制编辑器修改模块文件，将 module_layout 的值修改为相同的值，再插入。<br>  在 Linux 中，可以使用 <code>hexdump</code> 和 <code>xxd</code> 等工具查看二进制文件的内容，并尝试编辑。下面是一种使用 <code>xxd</code> 查看和修改二进制文件的方法：</p>
<ol>
<li><p>使用 <code>xxd</code> 将二进制文件转换为十六进制文本：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xxd /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko <span class="token operator">></span> kvm_hex.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这将创建一个名为 <code>kvm_hex.txt</code> 的文本文件，其中包含 <code>kvm.ko</code> 的十六进制表示。</p>
</li>
<li><p>使用文本编辑器（如 <code>nano</code> 或 <code>vim</code>）打开 <code>kvm_hex.txt</code>，找到并编辑 <code>module_layout</code> 的值。请确保你了解所做更改的含义，并且只修改你确信的内容。</p>
</li>
<li><p>保存并关闭文本编辑器。</p>
</li>
<li><p>使用 <code>xxd</code> 将修改后的十六进制文本转换回二进制文件：</p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xxd -r kvm_hex.txt <span class="token operator">></span> /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> 这将覆盖原始的 <code>kvm.ko</code> 文件。</p>
</li>
</ol>
</li>
<li><p>方法二：修改 Module.symvers</p>
  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清理编译结果。不要使用 make distclean，这会删除.config 文件以及 Module.symvers 文件</span>
<span class="token function">make</span> clean
<span class="token comment"># 修改 Module.symvers 文件</span>
<span class="token function">sed</span> -i  <span class="token string">'/module_layout/ s/0x[0-9a-f][0-9a-f]*/0xdf88831e/'</span> Module.symvers
<span class="token comment"># 重新编译模块</span>
<span class="token function">make</span> <span class="token assign-left variable">M</span><span class="token operator">=</span>./arch/riscv/kvm/ -j33
<span class="token comment"># 检查模块的 module_layout</span>
modprobe --dump-modversions /usr/src/linux-6.4.0-10.1.0.20.oe2309.riscv64/arch/riscv/kvm/kvm.ko <span class="token operator">|</span> <span class="token function">grep</span> module_layout
0xdf88831e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h1 id="如何生成-mod-c-文件"><a href="#如何生成-mod-c-文件" class="headerlink" title="如何生成 .mod.c 文件"></a>如何生成 .mod.c 文件</h1><p>如果是自己写的模块，可以根据下面的命令编译模块，就可以得到<code>.mod.c</code>文件，它是源文件到<code>.mod.o</code>文件的一个中间文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> -C /root/build-kernel/kernel <span class="token assign-left variable">M</span><span class="token operator">=</span>/driver_study/ modules -j22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果是用内核自己的模块，执行<code>make modules</code>命令，也可以得到<code>.mod.c</code>文件。但是一般执行<code>make -j22</code>命令就不会生成这些文件，我们可以找一个启用的内核模块，例如<code>kvm.ko</code>，执行下面的命令，就可以得到<code>.mod.c</code>文件。不能随便找个模块，必须在 config 中开启的模块，否则会报错<code>undefined!</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span>  <span class="token assign-left variable">M</span><span class="token operator">=</span>./arch/riscv/kvm modules -j22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/Linux/">#Linux</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="../../../../tags/Kernel/">#Kernel</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="../../17/repo%E6%BA%90%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90/">repo源配置解析</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="../../10/x86%E5%B9%B3%E5%8F%B0%E4%BD%BF%E7%94%A8Gitea-Actions%E6%9E%84%E5%BB%BA%E5%A4%9A%E6%9E%B6%E6%9E%84%E5%BA%94%E7%94%A8/">x86 平台使用 Gitea Actions 构建多架构应用 (binfmt_misc)</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2024 Dominic&nbsp;
                powered_by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>




<script src="../../../../js/script.js"></script>


    
</body>
</html>