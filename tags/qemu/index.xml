<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>QEMU on å¤œäº‘æ³Š</title>
    <link>https://lifeislife.cn/tags/qemu/</link>
    <description>Recent content in QEMU on å¤œäº‘æ³Š</description>
    <generator>Hugo -- 0.133.1</generator>
    <language>zh</language>
    <lastBuildDate>Sun, 07 Jul 2024 10:22:12 +0000</lastBuildDate>
    <atom:link href="https://lifeislife.cn/tags/qemu/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>QEMU å¸¸ç”¨å‘½ä»¤</title>
      <link>https://lifeislife.cn/posts/qemu%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</link>
      <pubDate>Sun, 07 Jul 2024 10:22:12 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</guid>
      <description>QEMU æ˜¯ä¸€ä¸ªå¼€æºçš„è™šæ‹ŸåŒ–è½¯ä»¶ï¼Œå®ƒèƒ½å¤Ÿæ¨¡æ‹Ÿä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œè®©ç”¨æˆ·åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¹‹é—´è¿›è¡Œåˆ‡æ¢å’Œæµ‹è¯•ã€‚ä»¥ä¸‹æ˜¯ QEMU å¸¸ç”¨å‘½ä»¤çš„æ€»ç»“æ–‡æ¡£ï¼ŒåŒ…å«æ¯ä¸ªå‘½ä»¤çš„åŠŸèƒ½</description>
      <content:encoded><![CDATA[<p>QEMU æ˜¯ä¸€ä¸ªå¼€æºçš„è™šæ‹ŸåŒ–è½¯ä»¶ï¼Œå®ƒèƒ½å¤Ÿæ¨¡æ‹Ÿä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œè®©ç”¨æˆ·åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¹‹é—´è¿›è¡Œåˆ‡æ¢å’Œæµ‹è¯•ã€‚ä»¥ä¸‹æ˜¯ QEMU å¸¸ç”¨å‘½ä»¤çš„æ€»ç»“æ–‡æ¡£ï¼ŒåŒ…å«æ¯ä¸ªå‘½ä»¤çš„åŠŸèƒ½è¯´æ˜ã€‚</p>
<h2 id="qemu-å®‰è£…">QEMU å®‰è£…</h2>
<h3 id="æºç ä¸‹è½½">æºç ä¸‹è½½</h3>
<h4 id="å‹ç¼©åŒ…æ–¹å¼">å‹ç¼©åŒ…æ–¹å¼</h4>
<p>ç‰ˆæœ¬å¯ä»¥ä¿®æ”¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> qemu-build <span class="o">&amp;&amp;</span> wget  <span class="s2">&#34;https://download.qemu.org/qemu-8.0.2.tar.xz&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">tar -xf qemu-8.0.2.tar.xz --strip-components<span class="o">=</span><span class="m">1</span> 
</span></span></code></pre></div><h4 id="clone-æ–¹å¼">Clone æ–¹å¼</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">git clone https://gitlab.com/qemu-project/qemu.git</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cd qemu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">git submodule init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">git submodule update --recursive</span><span class="w">
</span></span></span></code></pre></div><h3 id="é…ç½®ç¼–è¯‘é€‰é¡¹">é…ç½®ç¼–è¯‘é€‰é¡¹</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./configure --target-list<span class="o">=</span>riscv32-softmmu,riscv32-linux-user,riscv64-linux-user,riscv64-softmmu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--enable-kvm <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--enable-debug <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--enable-sdl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--prefix<span class="o">=</span>/home/user/program/riscv64-qemu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--python<span class="o">=</span>/usr/bin/python3
</span></span><span class="line"><span class="cl"><span class="c1"># --python=pythonè·¯å¾„ï¼Œå¦‚æœæç¤ºé»˜è®¤pythonç‰ˆæœ¬ä½ï¼Œå¯ä»¥åŠ è¿™ä¸ªå‚æ•°</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --prefix é€‰é¡¹è®¾ç½®qemuçš„å®‰è£…ä½ç½®ç»å¯¹è·¯å¾„ï¼Œä¹‹åè‹¥è¦å¸è½½åˆ é™¤qemuåªè¦åˆ é™¤è¯¥æ–‡ä»¶å¤¹å³å¯ï¼Œ--enable-kvmå¼€å¯kvm</span>
</span></span><span class="line"><span class="cl"><span class="c1"># configå®Œï¼Œå¯ä»¥åœ¨æŒ‡å®šçš„qemuå®‰è£…æ–‡ä»¶å¤¹ä¸‹é¢æ‰¾åˆ°config-host.makæ–‡ä»¶ï¼Œ</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¯¥æ–‡ä»¶è®°å½•ç€qemué…ç½®çš„é€‰é¡¹ï¼Œå¯ä»¥å’Œè‡ªå·±è®¾ç½®çš„è¿›è¡Œå¯¹æ¯”ï¼Œç¡®ä¿é…ç½®å’Œè‡ªå·±å·²çŸ¥</span>
</span></span></code></pre></div><h4 id="ä¸€äº›å¸¸ç”¨çš„ç¼–è¯‘é€‰é¡¹">ä¸€äº›å¸¸ç”¨çš„ç¼–è¯‘é€‰é¡¹</h4>
<ul>
<li>&ndash;enable-debugï¼šç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬ï¼Œè°ƒè¯•ç‰ˆæœ¬çš„è¿è¡Œé€Ÿåº¦éå¸¸æ…¢</li>
<li>&ndash;disable-werrorï¼šå¿½ç•¥è­¦å‘Šï¼Œå¦åˆ™ä»»ä½•ç¼–è¯‘è­¦å‘Šéƒ½è¢«è§†ä¸ºç¼–è¯‘é”™è¯¯</li>
<li>&ndash;enable-pluginsï¼šå¼€å¯TCG Pluginæ”¯æŒ</li>
<li>&ndash;disable-stack-protectorï¼šå…³é—­QEMUè‡ªèº«çš„æ ˆä¿æŠ¤</li>
<li>&ndash;extra-cflags=&quot;-O3&quot;ï¼šèƒ½è®©ä½ çš„QEMUæé€Ÿ5~10%ï¼Œå¦‚æœç¼–è¯‘æ—¶æŠ¥é”™ï¼Œè¯·åŠ ä¸Š<code>--disable-werror</code></li>
<li>&ndash;prefix=&lt;è·¯å¾„&gt;ï¼šæŒ‡å®šå®‰è£…ç›®å½•çš„è·¯å¾„</li>
<li>&ndash;target-list=&lt;æ¶æ„&gt;ï¼šæŒ‡å®šè¦ç¼–è¯‘çš„ç›®æ ‡æ¶æ„åˆ—è¡¨ï¼Œä¾‹å¦‚ <code>x86_64-softmmu,arm-softmmu</code>ã€‚</li>
<li>&ndash;enable-&lt;åŠŸèƒ½&gt;ï¼šå¯ç”¨æŒ‡å®šçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ<code>--enable-kvm</code> å¯ç”¨ KVM æ”¯æŒï¼Œ<code>--enable-gtk</code> å¯ç”¨ GTK å›¾å½¢ç•Œé¢ç­‰ã€‚</li>
<li>&ndash;disable-&lt;åŠŸèƒ½&gt;ï¼šç¦ç”¨æŒ‡å®šçš„åŠŸèƒ½ã€‚</li>
<li>&ndash;enable-debugï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ŒåŒ…æ‹¬è°ƒè¯•ç¬¦å·å’Œè°ƒè¯•è¾“å‡ºã€‚</li>
<li>&ndash;enable-virtfsï¼šå¯ç”¨ virtio æ–‡ä»¶ç³»ç»Ÿæ”¯æŒã€‚</li>
<li>&ndash;enable-modulesï¼šå¯ç”¨æ¨¡å—æ”¯æŒã€‚</li>
<li>&ndash;disable-guest-agentï¼šç¦ç”¨å®¢æˆ·æœºä»£ç†æ”¯æŒã€‚</li>
<li>&ndash;enable-trace-backend=&lt;åç«¯&gt;ï¼šæŒ‡å®šè·Ÿè¸ªåç«¯ï¼Œä¾‹å¦‚ <code>simple</code>ã€<code>log</code> æˆ– <code>dtrace</code>ã€‚</li>
<li>&ndash;disable-vhost-netï¼šç¦ç”¨ vhost-net æ”¯æŒã€‚</li>
</ul>
<h4 id="ç¼–è¯‘æ—¶è¾“å‡ºi-æ–‡ä»¶ç”¨äºæŸ¥çœ‹å®å®šä¹‰å±•å¼€">ç¼–è¯‘æ—¶è¾“å‡º.i æ–‡ä»¶ç”¨äºæŸ¥çœ‹å®å®šä¹‰å±•å¼€</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ ./configure  --extra-cflags=&#34;-save-temps&#34;   --target-list=riscv64-linux-user,riscv64-softmmu --disable-werror  --python=/usr/bin/python3</span><span class="w">
</span></span></span></code></pre></div><h2 id="å¯åŠ¨è™šæ‹Ÿæœº">å¯åŠ¨è™šæ‹Ÿæœº</h2>
<p>ä»¥ä¸‹å‘½ä»¤ç”¨äºå¯åŠ¨è™šæ‹Ÿæœºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -boot d -cdrom /path/to/iso -m <span class="m">1024</span> -hda /path/to/hda.img
</span></span></code></pre></div><ul>
<li>-boot dï¼šä» CD/DVD å¯åŠ¨</li>
<li>-cdrom /path/to/isoï¼šæŒ‡å®š ISO æ–‡ä»¶çš„è·¯å¾„</li>
<li>-m 1024ï¼šè®¾ç½®è™šæ‹Ÿæœºçš„å†…å­˜å¤§å°ä¸º 1024MB</li>
<li>-hda /path/to/hda.imgï¼šæŒ‡å®šè™šæ‹Ÿç¡¬ç›˜çš„è·¯å¾„</li>
</ul>
<h2 id="å®‰è£…ç³»ç»Ÿè‡³ç£ç›˜">å®‰è£…ç³»ç»Ÿè‡³ç£ç›˜</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -cdrom ~/Downloads/ubuntu.iso <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -drive <span class="nv">file</span><span class="o">=</span>ubuntu.qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -enable-kvm <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -cpu host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -smp <span class="nv">cores</span><span class="o">=</span>2,threads<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -m 2G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -vga virtio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -display sdl,gl<span class="o">=</span>on 
</span></span></code></pre></div><h2 id="ç½‘ç»œé…ç½®">ç½‘ç»œé…ç½®</h2>
<p>ä»¥ä¸‹å‘½ä»¤ç”¨äºé…ç½®è™šæ‹Ÿæœºçš„ç½‘ç»œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -net nic -net user,hostfwd<span class="o">=</span>tcp::2222-:22
</span></span></code></pre></div><ul>
<li>-net nicï¼šå¯ç”¨è™šæ‹Ÿç½‘å¡</li>
<li>-net userï¼šä½¿ç”¨ç”¨æˆ·æ¨¡å¼ç½‘ç»œå †æ ˆ</li>
<li>hostfwd=tcp::2222-:22ï¼šå°†ä¸»æœºçš„ 2222 ç«¯å£è½¬å‘åˆ°è™šæ‹Ÿæœºçš„ 22 ç«¯å£</li>
</ul>
<h2 id="è°ƒè¯•ç›¸å…³å‘½ä»¤">è°ƒè¯•ç›¸å…³å‘½ä»¤</h2>
<h3 id="å¯åŠ¨è°ƒè¯•æ¨¡å¼">å¯åŠ¨è°ƒè¯•æ¨¡å¼</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -s -S
</span></span></code></pre></div><ul>
<li>-sï¼šå¯ç”¨ GDB è°ƒè¯•</li>
<li>-Sï¼šåœ¨å¯åŠ¨æ—¶æš‚åœè™šæ‹Ÿæœºï¼Œç­‰å¾…è°ƒè¯•å™¨è¿æ¥</li>
</ul>
<h3 id="è¾“å‡ºè°ƒè¯•æ—¥å¿—">è¾“å‡ºè°ƒè¯•æ—¥å¿—</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">/home/user/develop/qemu/build/qemu-riscv64 -d in_asm,exec,cpu,strace -D ./log hello</span><span class="w">
</span></span></span></code></pre></div><p>QEMU çš„ <code>-d</code> å‚æ•°è¯´æ˜</p>
<p>æ—¥å¿—é€‰é¡¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š</p>
<ul>
<li><code>out_asm</code>ï¼šæ˜¾ç¤ºæ¯ä¸ªå·²ç¼–è¯‘åŸºæœ¬å—ç”Ÿæˆçš„å®¿ä¸»æ±‡ç¼–ä»£ç </li>
<li><code>in_asm</code>ï¼šæ˜¾ç¤ºæ¯ä¸ªå·²ç¼–è¯‘åŸºæœ¬å—çš„ç›®æ ‡æ±‡ç¼–ä»£ç </li>
<li><code>op</code>ï¼šæ˜¾ç¤ºæ¯ä¸ªå·²ç¼–è¯‘åŸºæœ¬å—çš„å¾®æ“ä½œ</li>
<li><code>op_opt</code>ï¼šæ˜¾ç¤ºä¼˜åŒ–åçš„å¾®æ“ä½œ</li>
<li><code>op_ind</code>ï¼šæ˜¾ç¤ºé—´æ¥é™ä½å‰çš„å¾®æ“ä½œ</li>
<li><code>int</code>ï¼šä»¥ç®€çŸ­æ ¼å¼æ˜¾ç¤ºä¸­æ–­/å¼‚å¸¸</li>
<li><code>exec</code>ï¼šåœ¨æ¯æ¬¡æ‰§è¡ŒåŸºæœ¬å—å‰æ˜¾ç¤ºè·Ÿè¸ªï¼ˆå¤§é‡æ—¥å¿—ï¼‰</li>
<li><code>cpu</code>ï¼šåœ¨è¿›å…¥åŸºæœ¬å—å‰æ˜¾ç¤º CPU å¯„å­˜å™¨ï¼ˆå¤§é‡æ—¥å¿—ï¼‰</li>
<li><code>fpu</code>ï¼šåœ¨â€œcpuâ€æ—¥å¿—ä¸­åŒ…å« FPU å¯„å­˜å™¨</li>
<li><code>mmu</code>ï¼šè®°å½•ä¸ MMU ç›¸å…³çš„æ´»åŠ¨</li>
<li><code>pcall</code>ï¼šä»…é™ x86ï¼šæ˜¾ç¤ºä¿æŠ¤æ¨¡å¼ä¸‹çš„è¿œç¨‹è°ƒç”¨/è¿”å›/å¼‚å¸¸</li>
<li><code>cpu_reset</code>ï¼šåœ¨ CPU é‡ç½®å‰æ˜¾ç¤º CPU çŠ¶æ€</li>
<li><code>unimp</code>ï¼šè®°å½•æœªå®ç°çš„åŠŸèƒ½</li>
<li><code>guest_errors</code>ï¼šå½“æ¥å®¾æ“ä½œç³»ç»Ÿæ‰§è¡Œæ— æ•ˆæ“ä½œï¼ˆä¾‹å¦‚è®¿é—®ä¸å­˜åœ¨çš„å¯„å­˜å™¨ï¼‰æ—¶è®°å½•æ—¥å¿—</li>
<li><code>page</code>ï¼šåœ¨ç”¨æˆ·æ¨¡å¼ä»¿çœŸå¼€å§‹æ—¶è½¬å‚¨é¡µé¢</li>
<li><code>nochain</code>ï¼šä¸é“¾å¼ç¼–è¯‘åŸºæœ¬å—ï¼Œä»¥ä¾¿â€œexecâ€å’Œâ€œcpuâ€æ˜¾ç¤ºå®Œæ•´çš„è·Ÿè¸ª</li>
<li><code>plugin</code>ï¼šè¾“å‡ºæ¥è‡ª TCG æ’ä»¶çš„ä¿¡æ¯</li>
<li><code>strace</code>ï¼šè®°å½•æ¯ä¸ªç”¨æˆ·æ¨¡å¼ç³»ç»Ÿè°ƒç”¨ã€å…¶è¾“å…¥å’Œç»“æœ</li>
<li><code>trace:PATTERN</code>ï¼šå¯ç”¨è·Ÿè¸ªäº‹ä»¶</li>
</ul>
<p>ä½¿ç”¨ <code>&quot;-d trace:help&quot;</code> æ¥è·å–è·Ÿè¸ªäº‹ä»¶åˆ—è¡¨ã€‚</p>
<h2 id="qemu-system-xxx-å¸¸ç”¨ç›¸å…³å‚æ•°">qemu-system-xxx å¸¸ç”¨ç›¸å…³å‚æ•°</h2>
<ul>
<li>-Mï¼šæŒ‡å®š machineï¼Œ-help å¯ä»¥åˆ—å‡ºæ‰€æœ‰æ‰€æ”¯æŒçš„ machine</li>
<li>-cpuï¼šæŒ‡å®šæ¨¡æ‹Ÿçš„ CPU å‹å·ï¼Œä¾‹å¦‚ <code>cortex-a57</code>ã€<code>cortex-a53</code> ç­‰ã€‚</li>
<li>-smpï¼šCPU æ ¸æ•°</li>
<li>-mï¼šRAM å®¹é‡</li>
<li>-kernelï¼šLinux kernel æ–‡ä»¶</li>
<li>-appendï¼šLinux Kernel çš„ bootargsã€‚è¿™ä¸ªå‘½ä»¤çš„å‚æ•°å¾ˆå¤æ‚ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ kernel æ–‡æ¡£ã€‚</li>
<li>-consoleï¼šè®¾å¤‡åå¿…é¡»å’Œ machine çš„ä¸²å£ä¸€è‡´ï¼Œå¦åˆ™ä¼šçœ‹ä¸åˆ° kernel logã€‚è€Œä¸åŒçš„å¹³å° console åç§°éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™æ˜¯ Kernel å¾ˆä¸å‹å¥½çš„ä¸€ç‚¹ã€‚</li>
<li>-ignore_loglevelï¼šå¯ä»¥è®©ä½ çœ‹åˆ°å°½å¯èƒ½å¤šçš„ kernel logï¼Œå½“ç„¶ä¹Ÿä¼šå‡æ…¢ kernel çš„å¯åŠ¨é€Ÿåº¦</li>
<li>-initï¼šå¿…é¡»ä¿è¯ initrd é‡Œæœ‰/linuxrc è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæ— æ³•å¯åŠ¨ shell</li>
<li>-initrdï¼šæŒ‡å®š initrd æ–‡ä»¶</li>
</ul>
<h2 id="å¿«ç…§ç®¡ç†">å¿«ç…§ç®¡ç†</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># æ‹å¿«ç…§</span>
</span></span><span class="line"><span class="cl">qemu-img snapshot -c oe-rv-snapshot1  openEuler-22.09-riscv64-qemu.qcow2
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ—ä¸¾å¿«ç…§</span>
</span></span><span class="line"><span class="cl">qemu-img snapshot-l openEuler-22.09-riscv64-qemu.qcow2
</span></span><span class="line"><span class="cl"><span class="c1"># æ¢å¤å¿«ç…§</span>
</span></span><span class="line"><span class="cl">qemu-img snapshot -a my_snapshot mydisk.qcow2
</span></span></code></pre></div><h2 id="æŸ¥çœ‹è™šæ‹Ÿç¡¬ç›˜ä¿¡æ¯">æŸ¥çœ‹è™šæ‹Ÿç¡¬ç›˜ä¿¡æ¯</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-img info /path/to/image
</span></span></code></pre></div><h2 id="å°†è™šæ‹Ÿç¡¬ç›˜è½¬æ¢ä¸º-qcow2-æ ¼å¼">å°†è™šæ‹Ÿç¡¬ç›˜è½¬æ¢ä¸º QCOW2 æ ¼å¼</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-img convert -O qcow2 /path/to/image /path/to/new/image
</span></span></code></pre></div><h3 id="è°ƒæ•´ç£ç›˜å¤§å°">è°ƒæ•´ç£ç›˜å¤§å°</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-img resize ubuntu.qcow2 +5G
</span></span></code></pre></div><h2 id="æ˜¾ç¤ºå™¨é€‰é¡¹">æ˜¾ç¤ºå™¨é€‰é¡¹</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -vga std
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -display sdl
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -display gtk
</span></span></code></pre></div><ul>
<li>-vga stdï¼šä½¿ç”¨æ ‡å‡† VGA æ˜¾ç¤ºå™¨</li>
<li>-display sdlï¼šä½¿ç”¨ SDL æ˜¾ç¤ºå™¨</li>
<li>-display gtkï¼šä½¿ç”¨ GTK æ˜¾ç¤ºå™¨</li>
</ul>
<h2 id="è¾“å…¥é€‰é¡¹">è¾“å…¥é€‰é¡¹</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -k en-us
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -usb
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -device usb-mouse
</span></span></code></pre></div><ul>
<li>-k en-usï¼šä½¿ç”¨è‹±æ–‡é”®ç›˜å¸ƒå±€</li>
<li>-usbï¼šå¯ç”¨ USB æ”¯æŒ</li>
<li>-device usb-mouseï¼šä½¿ç”¨ USB é¼ æ ‡è®¾å¤‡</li>
</ul>
<h2 id="å£°éŸ³é€‰é¡¹">å£°éŸ³é€‰é¡¹</h2>
<p>ä»¥ä¸‹å‘½ä»¤ç”¨äºé…ç½®è™šæ‹Ÿæœºçš„å£°éŸ³ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -soundhw all
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -soundhw sb16
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -audiodev pa,id<span class="o">=</span>pa1,out.mixing-engine<span class="o">=</span>off
</span></span></code></pre></div><ul>
<li>-soundhw allï¼šå¯ç”¨æ‰€æœ‰å£°å¡</li>
<li>-soundhw sb16ï¼šå¯ç”¨ SoundBlaster 16 å£°å¡</li>
<li>-audiodev pa,id=pa1,out.mixing-engine=offï¼šä½¿ç”¨ PulseAudio å£°éŸ³è®¾å¤‡</li>
</ul>
<h2 id="usb-è®¾å¤‡ç®¡ç†">USB è®¾å¤‡ç®¡ç†</h2>
<p>ä»¥ä¸‹å‘½ä»¤ç”¨äºç®¡ç†è™šæ‹Ÿæœºçš„ USB è®¾å¤‡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-x86_64 -usbdevice host:1234:5678
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -usbdevice tablet
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -usbdevice keyboard
</span></span></code></pre></div><ul>
<li>-usbdevice hostğŸ”¢5678ï¼šå°†ä¸»æœºçš„ USB è®¾å¤‡ 1234:5678 åˆ†é…ç»™è™šæ‹Ÿæœº</li>
<li>-usbdevice tabletï¼šä½¿ç”¨ USB è§¦æ‘¸æ¿</li>
<li>-usbdevice keyboardï¼šä½¿ç”¨ USB é”®ç›˜</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU è™šæ‹Ÿæœºç½‘ç»œé…ç½®</title>
      <link>https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/</link>
      <pubDate>Sat, 05 Aug 2023 14:47:54 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/</guid>
      <description>Quick Setup å®‰è£…å·¥å…· å®‰è£…ä¸¤ä¸ªç½‘ç»œç®¡ç†å·¥å…·ç”¨äºå»ºç«‹ç½‘æ¡¥ä»¥åŠè™šæ‹Ÿç½‘å¡ï¼š # å®‰è£…è™šæ‹Ÿç½‘æ¡¥å·¥å…· sudo apt install bridge-utils -y # UMLï¼ˆUser-mode linuxï¼‰å·¥å…· sudo apt install uml-utilities -y</description>
      <content:encoded><![CDATA[<h1 id="quick-setup">Quick Setup</h1>
<h2 id="å®‰è£…å·¥å…·">å®‰è£…å·¥å…·</h2>
<p>å®‰è£…ä¸¤ä¸ªç½‘ç»œç®¡ç†å·¥å…·ç”¨äºå»ºç«‹ç½‘æ¡¥ä»¥åŠè™šæ‹Ÿç½‘å¡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># å®‰è£…è™šæ‹Ÿç½‘æ¡¥å·¥å…·</span>
</span></span><span class="line"><span class="cl">sudo apt install bridge-utils -y
</span></span><span class="line"><span class="cl"><span class="c1"># UMLï¼ˆUser-mode linuxï¼‰å·¥å…·        </span>
</span></span><span class="line"><span class="cl">sudo apt install uml-utilities  -y   
</span></span></code></pre></div><h2 id="é…ç½®è„šæœ¬">é…ç½®è„šæœ¬</h2>
<h3 id="qemu-ifup">qemu-ifup</h3>
<p>å°†ä¸‹é¢çš„è„šæœ¬ä¿å­˜ä¸ºæ–‡ä»¶ <code>qemu-ifup</code>ï¼Œå¹¶èµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š</p>
<blockquote>
<p>ä¸ºäº†æ–¹ä¾¿å¤åˆ¶è„šæœ¬ï¼Œåœ¨ confluence é¡µé¢æä¾›äº†è„šæœ¬å†…å®¹ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶ã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p /etc/qemu
</span></span><span class="line"><span class="cl">mv qemu-ifup /etc/qemu <span class="o">&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span class="line"><span class="cl">sudo chmod +x qemu-ifup
</span></span><span class="line"><span class="cl">sudo chmod +x qemu-ifdown
</span></span></code></pre></div><p>å› ä¸ºç½‘å¡ä¿¡æ¯ä¸å®¹æ˜“å®šä½ï¼Œå¯èƒ½ä¸€å°æœºå™¨æœ‰å¤šä¸ªç½‘å¡ï¼Œæ‰€ä»¥ä¸æ–¹ä¾¿ç”¨è„šæœ¬è·å–ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸€ä¸‹ã€‚å°†ä¸‹é¢çš„<code>NIC</code>å€¼ä¿®æ”¹ä¸ºå®¿ä¸»æœºå¯ä»¥ä¸Šç½‘çš„ç½‘å¡åç§°ã€‚å¯ä»¥é€šè¿‡<code>ifconfig</code>å‘½ä»¤æŸ¥çœ‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># è®¾ç½®é»˜è®¤ç½‘å¡ä¿¡æ¯</span>
</span></span><span class="line"><span class="cl"><span class="nv">NIC</span><span class="o">=</span>enp2s0
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®ç”¨æˆ·å</span>
</span></span><span class="line"><span class="cl"><span class="nv">USER_NAME</span><span class="o">=</span>user
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®ç½‘æ¡¥åç§°</span>
</span></span><span class="line"><span class="cl"><span class="nv">BRIDGE</span><span class="o">=</span>br0
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®ç½‘ç»œä¿¡æ¯</span>
</span></span><span class="line"><span class="cl"><span class="nv">NIC_IP</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$NIC</span> <span class="p">|</span> grep <span class="s2">&#34;inet\b&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NIC_NETMAST</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$NIC</span> <span class="p">|</span> grep <span class="s2">&#34;inet\b&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $4}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NIC_BROADCAST</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$NIC</span> <span class="p">|</span> grep <span class="s2">&#34;inet\b&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $6}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">NETMASK</span><span class="o">=</span>255.255.240.0
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®é»˜è®¤ç½‘å…³åœ°å€</span>
</span></span><span class="line"><span class="cl"><span class="nv">GATEWAY</span><span class="o">=</span>10.12.192.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è·å–å®¿ä¸»æœºç½‘å¡MACåœ°å€ï¼Œå› ä¸ºåˆ›å»ºçš„ç½‘æ¡¥MACåœ°å€æ˜¯éšæœºçš„ï¼Œ</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ— æ³•æ¥å…¥å…¬å¸ï¼Œéœ€è¦ä»å¼€å‘æœºç½‘å¡å°†å…¶MACåœ°å€èµ‹å€¼ç»™ç½‘æ¡¥</span>
</span></span><span class="line"><span class="cl"><span class="nv">MAC</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$NIC</span> <span class="p">|</span> grep <span class="s2">&#34;ether\b&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ£€æŸ¥ç½‘æ¡¥æ˜¯å¦å·²åˆ›å»ºï¼Œå·²åˆ›å»ºå°±å¿½ç•¥</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> check_bridge<span class="o">()</span> 
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    echO <span class="s2">&#34;Check bridge...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> brctl show <span class="p">|</span> grep <span class="s2">&#34;^</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºç½‘æ¡¥</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> create_bridge<span class="o">()</span> 
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Start Create bridge...&#34;</span>
</span></span><span class="line"><span class="cl">    brctl addbr <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    brctl addif <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span>  <span class="s2">&#34;</span><span class="nv">$NIC</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    ifconfig br0 0.0.0.0 promisc up
</span></span><span class="line"><span class="cl">    dhclient <span class="nv">$BRIDGE</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ifconfig &#34;$BRIDGE&#34; &#34;$NIC_IP&#34; netmask &#34;$NIC_NETMAST&#34; broadcast &#34;$NIC_BROADCAST&#34;  hw ether &#34;$MAC&#34; promisc up</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¯ç”¨IPè½¬å‘</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> enable_ip_forward<span class="o">()</span> 
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è®¾ç½®ç½‘æ¡¥</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> setup_bridge<span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    check_bridge <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        create_bridge
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    enable_ip_forward
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    setup_bridge
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Creating </span><span class="nv">$1</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">    tunctl -t <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> -u <span class="s2">&#34;</span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    ifconfig <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> 0.0.0.0 up
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Adding </span><span class="nv">$1</span><span class="s2"> to </span><span class="nv">$BRIDGE</span><span class="s2">...&#34;</span>
</span></span><span class="line"><span class="cl">    brctl addif <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">5</span>
</span></span><span class="line"><span class="cl">    ifconfig <span class="s2">&#34;</span><span class="nv">$BRIDGE</span><span class="s2">&#34;</span>  hw ether <span class="s2">&#34;</span><span class="nv">$MAC</span><span class="s2">&#34;</span> promisc up
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Error: no interface specified.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><h3 id="qemu-ifdown">qemu-ifdown</h3>
<p>ä»¥ä¸‹æ˜¯<code>qemu-ifdown</code>è„šæœ¬ï¼Œç”¨äºåœ¨å…³é—­ QEMU æ—¶å…³é—­è™šæ‹Ÿç½‘å¡ï¼Œå°†å…¶ä»ç½‘æ¡¥ä¸­ç§»é™¤ï¼Œåˆ é™¤è™šæ‹Ÿç½‘å¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># è®¾ç½®ç½‘æ¡¥åç§°</span>
</span></span><span class="line"><span class="cl"><span class="nv">BRIDGE</span><span class="o">=</span>br0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†tapè®¾å¤‡ä»ç½‘æ¡¥ä¸­ç§»é™¤</span>
</span></span><span class="line"><span class="cl">	brctl delif <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> <span class="nv">$1</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># å…³é—­tapè®¾å¤‡</span>
</span></span><span class="line"><span class="cl">	ip link link <span class="nv">$1</span> down
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆ é™¤tapè®¾å¤‡</span>
</span></span><span class="line"><span class="cl">    ip link del <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">	tunctl -d <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;Error: no interface specified&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>å°†ç³»ç»Ÿé•œåƒå¤åˆ¶ä¸€ä»½å¹¶ä¿®æ”¹æ–‡ä»¶åï¼ŒQEMU ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸€ä¸ªé•œåƒå¯åŠ¨ä¸¤ä¸ªè™šæ‹Ÿæœºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cp openEuler-22.09-riscv64-qemu.qcow2 openEuler-22.09-riscv64-qemu-vm1.qcow2
</span></span></code></pre></div><p>éœ€è¦ä¿®æ”¹å¯åŠ¨è„šæœ¬ä¸­çš„é•œåƒæ–‡ä»¶åï¼Œä»¥åŠå¯åŠ¨å‚æ•°ï¼Œå°†<code>drive</code>ä»¥åŠ<code>cmd</code>å˜é‡çš„å†…å®¹è¦†ç›–ä¸ºä¸‹é¢çš„å†…å®¹ï¼Œä¿®æ”¹<code>mac</code>ä¸ºåˆ†é…ç»™è‡ªå·±çš„è™šæ‹Ÿæœºçš„ MAC åœ°å€ï¼Œ<code>script</code>ä¸ºä¸Šé¢çš„è„šæœ¬<code>qemu-ifup</code>çš„è·¯å¾„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¯¥è„šæœ¬ç”¨äºå¯åŠ¨VM0</span>
</span></span><span class="line"><span class="cl"><span class="nv">drive</span><span class="o">=</span><span class="s2">&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;qemu-system-riscv64 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -nographic -machine virt \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -smp &#34;</span><span class="nv">$vcpu</span><span class="s2">&#34; -m &#34;</span><span class="nv">$memory</span><span class="s2">&#34;G \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -bios &#34;</span><span class="nv">$fw</span><span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -drive file=&#34;</span><span class="nv">$drive</span><span class="s2">&#34;,format=qcow2,id=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-vga \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>ä»¥<code>sudo</code>æƒé™å¯åŠ¨è„šæœ¬ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ./preview_start_vm0.sh
</span></span></code></pre></div><p>ä»¥ä¸‹ä¸ºé…ç½® VM1 è¿‡ç¨‹ï¼ŒVM1 çš„å¯åŠ¨è„šæœ¬ä¸ VM0 çš„å¯åŠ¨è„šæœ¬ç±»ä¼¼ï¼Œåªéœ€è¦ä¿®æ”¹<code>drive</code>ä»¥åŠ<code>MAC</code>ï¼Œå¿…é¡»ä¿è¯<code>MAC</code>ä¸ VM0 çš„<code>MAC</code>ä¸åŒã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¯¥è„šæœ¬ç”¨äºå¯åŠ¨VM1</span>
</span></span><span class="line"><span class="cl"><span class="nv">drive</span><span class="o">=</span><span class="s2">&#34;openEuler-22.09-riscv64-qemu.qcow2&#34;</span>
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;qemu-system-riscv64 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -nographic -machine virt \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -smp &#34;</span><span class="nv">$vcpu</span><span class="s2">&#34; -m &#34;</span><span class="nv">$memory</span><span class="s2">&#34;G \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -bios &#34;</span><span class="nv">$fw</span><span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -drive file=&#34;</span><span class="nv">$drive</span><span class="s2">&#34;,format=qcow2,id=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-vga \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-net-device,netdev=tapnet,mac=80:d4:09:62:cd:3c \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -netdev tap,id=tapnet,script=/etc/qemu/qemu-ifup,downscript=/etc/qemu/qemu-ifdown \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><h2 id="ç½‘ç»œé€šä¿¡æµ‹è¯•">ç½‘ç»œé€šä¿¡æµ‹è¯•</h2>
<p>å½“å‰ç½‘ç»œçŠ¶æ€å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">HOST:10.12.192.177
</span></span><span class="line"><span class="cl">VM0:10.12.193.53
</span></span><span class="line"><span class="cl">VM1:10.12.193.101
</span></span></code></pre></div><h3 id="host----vm0">HOST &ndash;&gt; VM0</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># user @ ubuntu18 in ~/openeuler/openEuler2209 [18:41:54] </span>
</span></span><span class="line"><span class="cl">$ ping -c <span class="m">3</span> 10.12.193.101
</span></span><span class="line"><span class="cl">PING 10.12.193.101 <span class="o">(</span>10.12.193.101<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.101: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.37 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.101: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.897 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.101: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.890 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.12.193.101 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2002ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.890/1.055/1.378/0.228 ms
</span></span></code></pre></div><p>Host &ndash;&gt; VM1 çš„æµ‹è¯•ç»“æœä¸ Host &ndash;&gt; VM0 çš„æµ‹è¯•ç»“æœç›¸åŒã€‚</p>
<h3 id="vm0----host">VM0 &ndash;&gt; HOST</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># ping -c 3 10.12.193.53 </span>
</span></span><span class="line"><span class="cl">PING 10.12.193.53 <span class="o">(</span>10.12.193.53<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.716 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.74 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.81 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.12.193.53 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2009ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM1 &ndash;&gt; Host çš„æµ‹è¯•ç»“æœä¸ Host &ndash;&gt; VM0 çš„æµ‹è¯•ç»“æœç›¸åŒã€‚</p>
<h3 id="vm1----vm0">VM1 &ndash;&gt; VM0</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># ping -c 3 10.12.193.53 </span>
</span></span><span class="line"><span class="cl">PING 10.12.193.53 <span class="o">(</span>10.12.193.53<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.716 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.74 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.12.193.53: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>1.81 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.12.193.53 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2009ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.716/1.424/1.812/0.501 ms
</span></span></code></pre></div><p>VM0 &ndash;&gt; VM1 ä¸ VM1 &ndash;&gt; VM0 çš„æµ‹è¯•ç»“æœç›¸åŒã€‚</p>
<h3 id="vm0----github">VM0 &ndash;&gt; github</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># ping -c 4 github.com</span>
</span></span><span class="line"><span class="cl">PING github.com <span class="o">(</span>192.30.255.113<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">221</span> ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">277</span> ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">216</span> ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">218</span> ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- github.com ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">4</span> packets transmitted, <span class="m">4</span> received, 0% packet loss, <span class="nb">time</span> 3014ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 215.984/232.733/276.593/25.374 ms
</span></span></code></pre></div><h3 id="host----github">HOST &ndash;&gt; github</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># user @ ubuntu18 in ~/openeuler/openEuler2209 [17:59:40] </span>
</span></span><span class="line"><span class="cl">$ ping -c <span class="m">3</span>  github.com
</span></span><span class="line"><span class="cl">PING github.com <span class="o">(</span>192.30.255.113<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">218</span> ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">216</span> ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from lb-192-30-255-113-sea.github.com <span class="o">(</span>192.30.255.113<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">46</span> <span class="nv">time</span><span class="o">=</span><span class="m">216</span> ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- github.com ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time</span> 2002ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 216.252/217.087/218.409/0.945 ms
</span></span></code></pre></div><h1 id="åŸç†æ¢ç©¶-ongoing">åŸç†æ¢ç©¶ (Ongoing)</h1>
<h2 id="step-by-step-è§£æ">Step by Step è§£æ</h2>
<p>æŸ¥çœ‹ä¸€ä¸‹ç½‘ç»œæ¥å£ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ifconfig
</span></span><span class="line"><span class="cl">enp3s0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class="line"><span class="cl">        inet6 fe80::a00:27ff:fe32:e709  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether 08:00:27:32:e7:09  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">6017</span>  bytes <span class="m">5412928</span> <span class="o">(</span>5.4 MB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">1979</span>  bytes <span class="m">179467</span> <span class="o">(</span>179.4 KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="m">65536</span>
</span></span><span class="line"><span class="cl">        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class="line"><span class="cl">        inet6 ::1  prefixlen <span class="m">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class="line"><span class="cl">        loop  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Local Loopback<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">125</span>  bytes <span class="m">10142</span> <span class="o">(</span>10.1 KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">125</span>  bytes <span class="m">10142</span> <span class="o">(</span>10.1 KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span></code></pre></div><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>br0</code>çš„ç½‘æ¡¥</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo brctl addbr br0
</span></span></code></pre></div><p>å°†ç½‘æ¡¥ä¸å®¿ä¸»æœºçš„ç½‘å¡ç»‘å®š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo brctl addif br0 enp3s0
</span></span></code></pre></div><p>å¯ç”¨ <code>br0</code> æ¥å£ï¼Œå¹¶ä» DHCP æœåŠ¡å™¨è·å¾— IP åœ°å€</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ifconfig br0 0.0.0.0 promisc up
</span></span><span class="line"><span class="cl">sudo dhclient br0
</span></span></code></pre></div><p>æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo brctl show br0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bridge name	    bridge id		    STP enabled    interfaces
</span></span><span class="line"><span class="cl">br0		            8000.e0be0388eec9  no             enp3s0
</span></span></code></pre></div><p>æŸ¥çœ‹ <code>br0</code> çš„å„æ¥å£ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo brctl showstp br0
</span></span><span class="line"><span class="cl">br0
</span></span><span class="line"><span class="cl"> bridge id		8000.e0be0388eec9
</span></span><span class="line"><span class="cl"> designated root	8000.e0be0388eec9
</span></span><span class="line"><span class="cl"> root port			0			path cost <span class="m">0</span>
</span></span><span class="line"><span class="cl"> max age			20.00s
</span></span><span class="line"><span class="cl"> forward delay		15.00s
</span></span><span class="line"><span class="cl"> hello <span class="nb">time</span>			2.00s
</span></span><span class="line"><span class="cl"> ageing <span class="nb">time</span>		300.00s
</span></span><span class="line"><span class="cl"> hello timer		0.00s		&lt;tbd&gt;
</span></span><span class="line"><span class="cl"> forward timer		0.00s		&lt;tbd&gt;
</span></span><span class="line"><span class="cl"> ageing timer		0.00s		&lt;tbd&gt;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> enp3s0 <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id			8001			<span class="nb">local</span> state forwarding
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709
</span></span><span class="line"><span class="cl"> path cost			<span class="m">100</span>
</span></span><span class="line"><span class="cl"> designated bridge	8000.08002732e709
</span></span><span class="line"><span class="cl"> designated port	<span class="m">8001</span>
</span></span><span class="line"><span class="cl"> forward delay		15.00s
</span></span><span class="line"><span class="cl"> hello <span class="nb">time</span>			2.00s
</span></span><span class="line"><span class="cl"> max age			20.00s
</span></span><span class="line"><span class="cl"> ageing <span class="nb">time</span>		300.00s
</span></span><span class="line"><span class="cl"> priority			<span class="m">128</span>
</span></span></code></pre></div><p>å½“å‰ç½‘ç»œæ‹“æ‰‘ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">            |          Internet                 |
</span></span><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                   enp3s0 (Host Interface)               |
</span></span><span class="line"><span class="cl">|                   IP: 10.12.192.173                     |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">                            |
</span></span><span class="line"><span class="cl">                            v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                         br0 (Bridge)                    |
</span></span><span class="line"><span class="cl">|                      IP: 10.12.192.173                  |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span></code></pre></div><p>åˆ›å»ºä¸€ä¸ª <code>tap0</code> æ¥å£ç”¨äº<code>VM0</code>ä½¿ç”¨ï¼Œå…è®¸ <code>user</code> ç”¨æˆ·è®¿é—®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo tunctl -t tap0 -u user       
</span></span></code></pre></div><p>åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ  <code>tap0</code> æ¥å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo brctl addif br0 tap0
</span></span></code></pre></div><p>å¯ç”¨ tap0 æ¥å£ï¼Œæ··æ‚æ¨¡å¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo ifconfig tap0 0.0.0.0 promisc up
</span></span></code></pre></div><p>å°†ç½‘æ¡¥çš„ MAC åœ°å€ä¿®æ”¹ä¸ºå®¿ä¸»æœºçš„ MAC åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥æ¥å…¥å…¬å¸ç½‘ç»œäº†ã€‚å¦åˆ™å› ä¸ºå†…ç½‘çš„ MAC åœ°å€è¿‡æ»¤ï¼Œæ— æ³•æ¥å…¥å…¬å¸ç½‘ç»œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ifconfig br0  hw ether 08:00:27:32:e7:09  promisc up
</span></span></code></pre></div><p>æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo brctl show br0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bridge name	    bridge id		    STP enabled    interfaces
</span></span><span class="line"><span class="cl">br0		            8000.08002732e709  no             enp3s0
</span></span><span class="line"><span class="cl">                                                        tap0
</span></span></code></pre></div><p>æŸ¥çœ‹å½“å‰çš„ç½‘æ¡¥çŠ¶æ€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo brctl showstp br0 
</span></span><span class="line"><span class="cl">br0
</span></span><span class="line"><span class="cl"> bridge id		8000.08002732e709
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709
</span></span><span class="line"><span class="cl"> root port		   0			path cost		   <span class="m">0</span>
</span></span><span class="line"><span class="cl"> max age		  20.00			bridge max age		  20.00
</span></span><span class="line"><span class="cl"> hello <span class="nb">time</span>		   2.00			bridge hello <span class="nb">time</span>	   2.00
</span></span><span class="line"><span class="cl"> forward delay		  15.00			bridge forward delay	  15.00
</span></span><span class="line"><span class="cl"> ageing <span class="nb">time</span>		 300.00
</span></span><span class="line"><span class="cl"> hello timer		   0.00			tcn timer		   0.00
</span></span><span class="line"><span class="cl"> topology change timer	   0.00			gc timer		   7.75
</span></span><span class="line"><span class="cl"> flags			
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">enp2s0 <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id		8001			state		     forwarding
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709	path cost		   <span class="m">4</span>
</span></span><span class="line"><span class="cl"> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span class="line"><span class="cl"> designated port	8001			forward delay timer	   0.00
</span></span><span class="line"><span class="cl"> designated cost	   0			hold timer		   0.00
</span></span><span class="line"><span class="cl"> flags			
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tap0 <span class="o">(</span>2<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id		8002			state		     disabled
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709	path cost		 <span class="m">100</span>
</span></span><span class="line"><span class="cl"> designated bridge	8000.08002732e709	message age timer	   0.00
</span></span><span class="line"><span class="cl"> designated port	8002			forward delay timer	   0.00
</span></span><span class="line"><span class="cl"> designated cost	   0			hold timer		   0.00
</span></span><span class="line"><span class="cl"> flags				
</span></span></code></pre></div><p><code>tap0</code>å¯èƒ½å¤„äº<code>disabled</code>çŠ¶æ€ï¼Œå› ä¸ºè¿˜æ²¡æœ‰è™šæ‹Ÿæœºä½¿ç”¨å®ƒã€‚å¯åŠ¨è™šæ‹Ÿæœºä¹‹åä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°<code>forwarding</code>çŠ¶æ€ã€‚</p>
<p>å½“å‰ç½‘ç»œæ‹“æ‰‘ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">            |          Internet                 |
</span></span><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                   enp3s0 (Host Interface)               |
</span></span><span class="line"><span class="cl">|                   IP: 10.12.192.173                     |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">                            |
</span></span><span class="line"><span class="cl">                            v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                         br0 (Bridge)                    |
</span></span><span class="line"><span class="cl">|                      IP: 10.12.192.173                  |
</span></span><span class="line"><span class="cl">|                  +---------------------+                |
</span></span><span class="line"><span class="cl">|                  |        tap0         |                |
</span></span><span class="line"><span class="cl">|                  |     IP: 0.0.0.0     |                |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span></code></pre></div><p>å¯åŠ¨ QEMU</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;qemu-system-riscv64 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -nographic -machine virt \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -smp &#34;</span><span class="nv">$vcpu</span><span class="s2">&#34; -m &#34;</span><span class="nv">$memory</span><span class="s2">&#34;G \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -bios &#34;</span><span class="nv">$fw</span><span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -drive file=&#34;</span><span class="nv">$drive</span><span class="s2">&#34;,format=qcow2,id=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-vga \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-net-device,netdev=tapnet,mac=e0:be:03:88:54:e8 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -netdev tap,id=tapnet,ifname=tap0,script=no,downscript=no \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet&#34;</span>
</span></span></code></pre></div><p>å…³æ³¨è¿™æ®µè„šæœ¬çš„ç½‘ç»œé…ç½®éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  -device virtio-net-device,netdev<span class="o">=</span>tapnet,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet,ifname<span class="o">=</span>tap0,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\
</span></span></span></code></pre></div><p>è¯¦ç»†è§£é‡Šå¯ä»¥æŸ¥çœ‹â€œQEMU ç½‘ç»œè™šæ‹ŸåŒ–ç« èŠ‚â€ï¼Œç¬¬ä¸€ä¸ªå‚æ•° <code>-device virtio-net-device</code> å®šä¹‰äº†åä¸º <code>virtio-net-device</code> çš„ç½‘ç»œè®¾å¤‡ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ä¸€ä¸ªåä¸º <code>tapnet</code> çš„ç½‘ç»œè®¾å¤‡ä¸Šï¼ŒæŒ‡å®šå®ƒçš„ MAC åœ°å€ä¸º <code>e0:be:03:88:54:e8</code>ã€‚ç¬¬äºŒä¸ªå‚æ•° <code>-netdev tap</code> ç”¨äºæŒ‡å®šåç«¯å®ç°ï¼Œä½¿ç”¨<code>tap</code>æ–¹å¼ï¼Œå¹¶ä¸”æŒ‡å®šå”¯ä¸€ ID ä¸º<code>tapnet</code>ç”±<code>-device</code>å‚æ•°ä¸­çš„å­å‚æ•°<code>netdev</code>ä½¿ç”¨ï¼ŒæŒ‡å®š<code>ifname=tap0</code>ï¼Œè¡¨ç¤ºä½¿ç”¨<code>tap0</code>æ¥å£ä½œä¸ºè™šæ‹ŸåŒ–çš„åç«¯ã€‚<code>script=no</code>å’Œ<code>downscript=no</code>è¡¨ç¤ºä¸ä½¿ç”¨è„šæœ¬æ¥å¯åŠ¨å’Œå…³é—­<code>tap0</code>æ¥å£ã€‚</p>
<p>æŸ¥çœ‹å½“å‰çš„ç½‘ç»œæ¥å£ä¿¡æ¯<code>ifconfig</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">br0: <span class="nv">flags</span><span class="o">=</span>4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class="line"><span class="cl">        inet6 fe80::e2be:3ff:fe88:eec9  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether 08:00:27:32:e7:09  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">861148</span>  bytes <span class="m">310707296</span> <span class="o">(</span>310.7 MB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">17556062</span>  bytes <span class="m">1516515693</span> <span class="o">(</span>1.5 GB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">enp2s0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 10.12.192.173  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class="line"><span class="cl">        inet6 fe80::4964:61f8:420d:6781  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether 08:00:27:32:e7:09  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">894523</span>  bytes <span class="m">325547917</span> <span class="o">(</span>325.5 MB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">1926</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">17563568</span>  bytes <span class="m">1516947572</span> <span class="o">(</span>1.5 GB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="m">65536</span>
</span></span><span class="line"><span class="cl">        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class="line"><span class="cl">        inet6 ::1  prefixlen <span class="m">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class="line"><span class="cl">        loop  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Local Loopback<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">1654925876</span>  bytes <span class="m">134933568498</span> <span class="o">(</span>134.9 GB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">1654925876</span>  bytes <span class="m">134933568498</span> <span class="o">(</span>134.9 GB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tap0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet6 fe80::f8ae:85ff:fed7:f9cd  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether fa:ae:85:d7:f9:cd  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">557</span>  bytes <span class="m">44913</span> <span class="o">(</span>44.9 KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">7165</span>  bytes <span class="m">832171</span> <span class="o">(</span>832.1 KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">55942</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span></code></pre></div><p>å½“å‰ç½‘ç»œæ‹“æ‰‘ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">            |          Internet                 |
</span></span><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                   enp3s0 (Host Interface)               |
</span></span><span class="line"><span class="cl">|                   IP: 10.12.192.173                     |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">                            |
</span></span><span class="line"><span class="cl">                            v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                         br0 (Bridge)                    |
</span></span><span class="line"><span class="cl">|                      IP: 10.12.192.173                  |
</span></span><span class="line"><span class="cl">|                  +---------------------+                |
</span></span><span class="line"><span class="cl">|                  |        tap0         |                |
</span></span><span class="line"><span class="cl">|                  |     IP: 0.0.0.0     |                |
</span></span><span class="line"><span class="cl">+---------------------------|-----------------------------+
</span></span><span class="line"><span class="cl">                            |
</span></span><span class="line"><span class="cl">                            v
</span></span><span class="line"><span class="cl">+---------------------------|-----------------------------+
</span></span><span class="line"><span class="cl">|                  |        eth0         |                |
</span></span><span class="line"><span class="cl">|                  |     IP:10.12.193.53 |                |
</span></span><span class="line"><span class="cl">|                  +---------------------+                |
</span></span><span class="line"><span class="cl">|                     VM0 (QEMU)                          |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span></code></pre></div><p>æŸ¥çœ‹å½“å‰çš„ç½‘æ¡¥çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ° tap0 å·²ç»å¤„äº forwarding çŠ¶æ€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo brctl showstp br0 
</span></span><span class="line"><span class="cl">br0
</span></span><span class="line"><span class="cl"> bridge id		8000.08002732e709
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">enp2s0 <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id		8001			state		     forwarding
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709	path cost		   <span class="m">4</span>
</span></span><span class="line"><span class="cl"> designated bridge	8000.08002732e709	message age 		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">tap0 <span class="o">(</span>2<span class="o">)</span>
</span></span><span class="line"><span class="cl"> port id		8002			state		     forwarding
</span></span><span class="line"><span class="cl"> designated root	8000.08002732e709	path cost		 <span class="m">100</span>
</span></span><span class="line"><span class="cl"> designated bridge	8000.08002732e709	message age 			
</span></span></code></pre></div><p>æ·»åŠ  VM1 è¿‡ç¨‹å°±å¿½ç•¥äº†ï¼Œæ·»åŠ åçš„ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">            |          Internet                 |
</span></span><span class="line"><span class="cl">            +-----------------------------------+
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             |
</span></span><span class="line"><span class="cl">                             v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                   enp3s0 (Host Interface)               |
</span></span><span class="line"><span class="cl">|                   IP: 10.12.192.173                     |
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">                            |
</span></span><span class="line"><span class="cl">                            v
</span></span><span class="line"><span class="cl">+---------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                         br0 (Bridge)                    |
</span></span><span class="line"><span class="cl">|                      IP: 10.12.192.173                  |
</span></span><span class="line"><span class="cl">|    +---------------------+  +-------------------+       |
</span></span><span class="line"><span class="cl">|    |        tap0         |  |        tap1       |       |
</span></span><span class="line"><span class="cl">|    |     IP: 0.0.0.0     |  |     IP: 0.0.0.0   |       |
</span></span><span class="line"><span class="cl">+---------------|-------------------------|---------------+
</span></span><span class="line"><span class="cl">                |                         |
</span></span><span class="line"><span class="cl">                v                         v
</span></span><span class="line"><span class="cl">+---------------|----------+  +-----------|---------------+
</span></span><span class="line"><span class="cl">|   |     eth0         |   |  |   |        eth0       |   |
</span></span><span class="line"><span class="cl">|   |  IP:10.12.193.53 |   |  |   |  IP:10.12.193.101 |   |
</span></span><span class="line"><span class="cl">|   +---------------------+|  |   +-------------------+   |
</span></span><span class="line"><span class="cl">|         VM0 (QEMU)       |  |         VM1 (QEMU)        |
</span></span><span class="line"><span class="cl">+--------------------------+  +---------------------------+
</span></span></code></pre></div><h2 id="qemu-ç½‘ç»œè™šæ‹ŸåŒ–">QEMU ç½‘ç»œè™šæ‹ŸåŒ–</h2>
<p>QEMU å¯¹äºç½‘ç»œçš„è™šæ‹ŸåŒ–éœ€è¦ä¸¤ä¸ªå‚æ•°æ¥æŒ‡å®šï¼š</p>
<ul>
<li>å…¶ä¸­ä¸€ä¸ªç”¨äºæŒ‡å®šç½‘ç»œçš„å‰ç«¯é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ Guest ä¸­çš„å®ç°</li>
<li>å¦ä¸€ä¸ªç”¨äºæŒ‡å®šç½‘ç»œçš„åç«¯å®ç°ï¼Œä¹Ÿå°±æ˜¯åœ¨ Host ä¸­çš„å®ç°ã€‚</li>
</ul>
<p>QEMU æ”¯æŒä¸¤ç§æ–¹å¼æ¥å®ç°ç½‘ç»œè™šæ‹ŸåŒ–ï¼Œä¸€ç§æ˜¯æ—§ç‰ˆæœ¬ä¸Šä½¿ç”¨çš„å‚æ•°ä¸º <code>-net</code> é…åˆ <code>-net</code> ï¼Œå¦ä¸€ç§æ˜¯åœ¨æ–°ç‰ˆæœ¬ä¸Šæ”¯æŒçš„ <code>-device</code> é…åˆ <code>-netdev</code> ã€‚QEMU çš„å‘å±•è¶‹åŠ¿æ˜¯å€¾å‘äºç”¨ <code>-device</code> ä¸€ç§å‘½ä»¤æ ¼å¼æ¥è™šæ‹Ÿå‡ºä¸åŒçš„è®¾å¤‡ï¼Œå…¶ä¸­åŒ…æ‹¬ç½‘å¡è®¾å¤‡ã€‚</p>
<h3 id="-net---net-legacy">-net &amp; -net (legacy)</h3>
<p>è™½ç„¶ä»ç„¶æ”¯æŒï¼Œä½†æ˜¯é€æ­¥è¢«åºŸå¼ƒï¼Œä¸æ¨èä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬ä»¥ä»¥ä¸‹å‘½ä»¤ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ <code>-net</code> å’Œ <code>-net</code> çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">vcpu</span><span class="o">=</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="nv">memory</span><span class="o">=</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="nv">drive</span><span class="o">=</span><span class="s2">&#34;openEuler-22.09-V1-riscv64-qemu.qcow2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">fw</span><span class="o">=</span><span class="s2">&#34;fw_payload_oe_qemuvirt.elf&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;qemu-system-riscv64 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -nographic -machine virt \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -smp &#34;</span><span class="nv">$vcpu</span><span class="s2">&#34; -m &#34;</span><span class="nv">$memory</span><span class="s2">&#34;G \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -kernel &#34;</span><span class="nv">$fw</span><span class="s2">&#34; \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -bios none \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -drive file=&#34;</span><span class="nv">$drive</span><span class="s2">&#34;,format=qcow2,id=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -object rng-random,filename=/dev/urandom,id=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-vga \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-rng-device,rng=rng0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device virtio-blk-device,drive=hd0 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -net nic,mac=52:54:00:12:34:56 \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -net tap,ifname=tap0,script=no,downscript=no \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -device qemu-xhci -usb -device usb-kbd -device usb-tablet \
</span></span></span><span class="line"><span class="cl"><span class="s2">  -append &#39;root=/dev/vda1 rw console=ttyS0 swiotlb=1 loglevel=3 systemd.default_timeout_start_sec=600 selinux=0 highres=off mem=&#34;</span><span class="nv">$memory_append</span><span class="s2">&#34;M earlycon&#39; &#34;</span>
</span></span></code></pre></div><p>å…¶ä¸­è¿™ä¸¤ä¸ªå‚æ•°å³å®ç°äº†è™šæ‹ŸåŒ–ç½‘ç»œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  -net nic,mac<span class="o">=</span>52:54:00:12:34:56 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -net tap,ifname<span class="o">=</span>tap0,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\
</span></span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•° <code>-net nic</code> ç”¨äºæŒ‡å®šä¸Šè¿°æ‰€è¯´çš„å‰ç«¯é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ Guest ä¸­çš„å®ç°ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ é»˜è®¤çš„é©±åŠ¨ï¼Œè¿™ä¸ªé©±åŠ¨æ˜¯ QEMU ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿç½‘å¡è®¾å¤‡ï¼ŒæŒ‡å®šå®ƒçš„ MAC åœ°å€ä¸º <code>52:54:00:12:34:56</code>ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•° <code>-net tap</code> ç”¨äºæŒ‡å®šåç«¯å®ç°ï¼Œä¹Ÿå°±æ˜¯ Host ä¸­çš„å®ç°ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>tap</code> é©±åŠ¨ï¼Œå®ƒçš„ç½‘å¡åç§°ä¸º <code>tap0</code>ï¼Œå¹¶ä¸”ä¸æ‰§è¡Œä»»ä½•è„šæœ¬ã€‚è¿™ä¸¤ä¸ªå‚æ•°çš„ç»„åˆå°±å®ç°äº†è™šæ‹ŸåŒ–ç½‘ç»œã€‚</p>
<p>æ›´å¤šç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-net nic,model<span class="o">=</span>virtio <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-net tap,ifname<span class="o">=</span>tap3,script<span class="o">=</span>/ect/qemu/qemu-ifup,downscript<span class="o">=</span>no <span class="se">\
</span></span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•° <code>-net nic</code> ç”¨äºæŒ‡å®šä¸Šè¿°æ‰€è¯´çš„å‰ç«¯é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ Guest ä¸­çš„å®ç°ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>virtio</code> é©±åŠ¨ï¼Œè¿™ä¸ªé©±åŠ¨æ˜¯ QEMU ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿç½‘å¡è®¾å¤‡ã€‚ç¬¬äºŒä¸ªå‚æ•° <code>-net tap</code> ç”¨äºæŒ‡å®šåç«¯å®ç°ï¼Œä¹Ÿå°±æ˜¯ Host ä¸­çš„å®ç°ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>tap</code> é©±åŠ¨ï¼Œå®ƒçš„ç½‘å¡åç§°ä¸º <code>tap3</code>ï¼Œå¹¶ä¸”æ‰§è¡Œè„šæœ¬ <code>/ect/qemu/qemu-ifup</code>ã€‚</p>
<blockquote>
<p>è§£é‡Š<code>/ect/qemu/qemu-ifup</code>
è¯¥è„šæœ¬ç”¨äºåˆ›å»ºç½‘æ¡¥ï¼Œå°†ç½‘æ¡¥ä¸å®¿ä¸»æœºçš„ç½‘å¡ç»‘å®šï¼Œç„¶åå°†è™šæ‹Ÿç½‘å¡ç»‘å®šåˆ°ç½‘æ¡¥ä¸Šï¼Œè¿™æ ·è™šæ‹Ÿæœºå°±å¯ä»¥é€šè¿‡ç½‘æ¡¥ä¸å®¿ä¸»æœºé€šä¿¡ï¼Œå®¿ä¸»æœºä¹Ÿå¯ä»¥é€šè¿‡ç½‘æ¡¥ä¸è™šæ‹Ÿæœºé€šä¿¡ã€‚</p>
</blockquote>
<h3 id="-device---netdev-recommended">-device &amp; -netdev ï¼ˆRecommendedï¼‰</h3>
<p>è¿™æ˜¯æ–°ç‰ˆæœ¬çš„ QEMU æ”¯æŒçš„å‘½ä»¤æ ¼å¼ï¼Œä¹Ÿæ˜¯ QEMU æœªæ¥çš„å‘å±•è¶‹åŠ¿ï¼Œæˆ‘ä»¬ä»¥ä»¥ä¸‹å‘½ä»¤ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ <code>-device</code> å’Œ <code>-netdev</code> çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-riscv64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -nographic -machine virt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -smp <span class="s2">&#34;</span><span class="nv">$vcpu</span><span class="s2">&#34;</span> -m <span class="s2">&#34;</span><span class="nv">$memory</span><span class="s2">&#34;</span>G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -bios <span class="s2">&#34;</span><span class="nv">$fw</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -drive <span class="nv">file</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$drive</span><span class="s2">&#34;</span>,format<span class="o">=</span>qcow2,id<span class="o">=</span>hd0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-vga <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-rng-device,rng<span class="o">=</span>rng0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-blk-device,drive<span class="o">=</span>hd0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-net-device,netdev<span class="o">=</span>tapnet,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet,ifname<span class="o">=</span>tap0,script<span class="o">=</span>~/qemu-script/qemu-ifup,downscript<span class="o">=</span>no <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>å…¶ä¸­è¿™ä¸¤ä¸ªå‚æ•°å³å®ç°äº†è™šæ‹ŸåŒ–ç½‘ç»œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  -device virtio-net-device,netdev<span class="o">=</span>tapnet,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet,ifname<span class="o">=</span>tap0,script<span class="o">=</span>~/qemu-script/qemu-ifup,downscript<span class="o">=</span>no <span class="se">\
</span></span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•° <code>-device virtio-net-device</code> ç”¨äºæŒ‡å®šä¸Šè¿°æ‰€è¯´çš„å‰ç«¯é©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯ Guest ä¸­çš„å®ç°ï¼Œå®šä¹‰äº†åä¸º <code>virtio-net-device</code> çš„ç½‘ç»œè®¾å¤‡ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ä¸€ä¸ªåä¸º <code>tapnet</code> çš„ç½‘ç»œè®¾å¤‡ä¸Šï¼ŒæŒ‡å®šå®ƒçš„ MAC åœ°å€ä¸º <code>e0:be:03:88:54:e8</code>ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•° <code>-netdev tap</code> ç”¨äºæŒ‡å®šåç«¯å®ç°ï¼Œä½¿ç”¨<code>tap</code>æ–¹å¼ï¼Œå¹¶ä¸”æŒ‡å®šå”¯ä¸€ ID ä¸º<code>tapnet</code>ç”±<code>-device</code>å‚æ•°ä¸­çš„å­å‚æ•°<code>netdev</code>ä½¿ç”¨ã€‚ç½‘å¡åç§°ä¸º<code>tap0</code>å¹¶ä¸”æ‰§è¡Œè„šæœ¬ <code>~/qemu-script/qemu-ifup</code>ã€‚</p>
<blockquote>
<p>-netdev å‚æ•°ä¸­ id çš„ä½¿ç”¨
-netdev å‚æ•°ä¸­çš„ id ç”¨äºæŒ‡å®šå”¯ä¸€çš„ IDï¼Œè¿™ä¸ª ID ä¼šè¢« <code>-device</code> å‚æ•°ä¸­çš„å­å‚æ•° <code>netdev</code> ä½¿ç”¨ï¼Œè¿™æ · <code>-device</code> å‚æ•°å°±çŸ¥é“è¦å°†å‰ç«¯é©±åŠ¨è¿æ¥åˆ°å“ªä¸ªåç«¯å®ç°ä¸Šäº†ã€‚id å¯ä»¥è‡ªå®šä¹‰ä»»æ„å”¯ä¸€å­—ç¬¦ä¸²å¦‚<code>-netdev tap,id=test</code>å¯¹åº”<code>-device virtio-net-device,netdev=test</code></p>
</blockquote>
<p>æ›´å¤šç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  -device virtio-net-pci,netdev<span class="o">=</span>tapnet,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\
</span></span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªå‚æ•° <code>-device virtio-net-pci</code> å®šä¹‰äº†åä¸º <code>virtio-net-pci</code> çš„ç½‘ç»œè®¾å¤‡ï¼Œå¹¶å°†å…¶è¿æ¥åˆ°ä¸€ä¸ªåä¸º <code>tapnet</code> çš„ç½‘ç»œè®¾å¤‡ä¸Šï¼ŒæŒ‡å®šå®ƒçš„ MAC åœ°å€ä¸º <code>e0:be:03:88:54:e8</code>ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•°ï¼Œä»”ç»†è§‚å¯Ÿä¼šå‘ç°ï¼Œæˆ‘ä»¬æ²¡æœ‰å®šä¹‰é“¾æ¥åˆ°åç«¯ç½‘å¡çš„åç§°<code>ifname</code>ï¼Œè¿™æ˜¯å› ä¸ºä»¥<code>tap</code>æ¨¡å¼å¯åŠ¨ QEMU æ—¶ä¼šè‡ªåŠ¨åˆ›å»º<code>tap</code>è®¾å¤‡ï¼Œå…·ä½“ç½‘å¡åç§°æ ¹æ®å½“å‰å®¿ä¸»æœºçš„ç½‘å¡æƒ…å†µè€Œå®šï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªåä¸º<code>tap0</code>çš„ç½‘å¡ï¼Œå¦‚æœå¯åŠ¨äº†ä¸¤ä¸ªè™šæ‹Ÿæœºï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªè™šæ‹Ÿæœºçš„ç½‘å¡åç§°å°±æ˜¯<code>tap1</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<h3 id="åŒºåˆ†-tap-æ¨¡å¼ä¸-bridge-æ¨¡å¼">åŒºåˆ† tap æ¨¡å¼ä¸ bridge æ¨¡å¼</h3>
<p>æˆ‘ä»¬æœ‰æ—¶å€™ä¼šç”¨ä»¥ä¸‹çš„å‘½ä»¤è¿›è¡Œ QEMU è™šæ‹Ÿæœºæ¡¥æ¥ç½‘ç»œçš„é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  -device virtio-net-device,netdev<span class="o">=</span>bridgenet,mac<span class="o">=</span>52:54:00:12:34:57 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev bridge,ifname<span class="o">=</span>br0,id<span class="o">=</span>bridgenet
</span></span></code></pre></div><p>è¿™ä¹Ÿèƒ½ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œè¿™æ˜¯å› ä¸ºå®ƒå’Œ <code>-netdev tap</code> çš„å·¥ä½œæ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯ <code>-netdev bridge</code> çš„ç®€åŒ–å†™æ³•ï¼Œ<code>qemu-bridge-helper</code> åœ¨èƒŒåæ›¿æˆ‘ä»¬åšäº† <code>tap</code> è®¾å¤‡åˆ›å»ºä»¥åŠå°† <code>tap</code> è®¾å¤‡åŠ å…¥æ¡¥æ¥å£çš„æ‰€æœ‰äº‹æƒ…ã€‚</p>
<h3 id="æ·»åŠ å¤šå¼ ç½‘å¡">æ·»åŠ å¤šå¼ ç½‘å¡</h3>
<p>å¦‚æœäº†è§£ä¸Šè¿°å†…å®¹ï¼Œæ·»åŠ å¤šå¼ ç½‘å¡å°±ååˆ†å®¹æ˜“å®ç°äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å†æ·»åŠ ä¸€å¯¹ <code>-device</code> å’Œ <code>-netdev</code> å‚æ•°å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-system-riscv64 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -nographic -machine virt <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -smp <span class="s2">&#34;</span><span class="nv">$vcpu</span><span class="s2">&#34;</span> -m <span class="s2">&#34;</span><span class="nv">$memory</span><span class="s2">&#34;</span>G <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -bios <span class="s2">&#34;</span><span class="nv">$fw</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -drive <span class="nv">file</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$drive</span><span class="s2">&#34;</span>,format<span class="o">=</span>qcow2,id<span class="o">=</span>hd0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-vga <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-rng-device,rng<span class="o">=</span>rng0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-blk-device,drive<span class="o">=</span>hd0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-net-device,netdev<span class="o">=</span>tapnet0,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet0,script<span class="o">=</span>/etc/qemu/qemu-ifup,downscript<span class="o">=</span>/etc/qemu/qemu-ifdown <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-net-device,netdev<span class="o">=</span>tapnet1,mac<span class="o">=</span>e0:be:03:88:54:e8 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -netdev tap,id<span class="o">=</span>tapnet1,script<span class="o">=</span>/etc/qemu/qemu-ifup,downscript<span class="o">=</span>/etc/qemu/qemu-ifdown <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device qemu-xhci -usb -device usb-kbd -device usb-tablet
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª <code>-device</code> å‚æ•°æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œè¿™ä¸ª ID ä¼šè¢« <code>-netdev</code> å‚æ•°ä¸­çš„å­å‚æ•° <code>netdev</code> ä½¿ç”¨ï¼Œè¿™æ · <code>-device</code> å‚æ•°å°±çŸ¥é“è¦å°†å‰ç«¯é©±åŠ¨è¿æ¥åˆ°å“ªä¸ªåç«¯å®ç°ä¸Šäº†ã€‚å¹¶ä¸”æ¯ä¸ª <code>tap</code> è®¾å¤‡åªèƒ½è¢«ä¸€ä¸ªè™šæ‹Ÿæœºä½¿ç”¨ï¼Œæ‰€ä»¥æ¯ä¸ªè™šæ‹Ÿæœºçš„ <code>tap</code> è®¾å¤‡åç§°ä¸èƒ½ç›¸åŒã€‚</p>
<p>ç™»å½•è™šæ‹ŸæœºæŸ¥çœ‹ç½‘å¡ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># ifconfig </span>
</span></span><span class="line"><span class="cl">eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 10.12.193.53  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class="line"><span class="cl">        inet6 fe80::9e6:287b:30a2:574d  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether e0:be:03:88:54:e8  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">81</span>  bytes <span class="m">9871</span> <span class="o">(</span>9.6 KiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">19</span>  bytes <span class="m">1735</span> <span class="o">(</span>1.6 KiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">eth1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 10.12.193.101  netmask 255.255.240.0  broadcast 10.12.207.255
</span></span><span class="line"><span class="cl">        inet6 fe80::4fe0:9e1e:4681:52b7  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether 80:d4:09:62:cd:3c  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">76</span>  bytes <span class="m">9471</span> <span class="o">(</span>9.2 KiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">15</span>  bytes <span class="m">1708</span> <span class="o">(</span>1.6 KiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="m">65536</span>
</span></span><span class="line"><span class="cl">        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class="line"><span class="cl">        inet6 ::1  prefixlen <span class="m">128</span>  scopeid 0x10&lt;host&gt;
</span></span><span class="line"><span class="cl">        loop  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Local Loopback<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span>0.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span>0.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span></code></pre></div><h2 id="ä¸åŒç½‘ç»œç­–ç•¥å·¥ä½œæ–¹å¼">ä¸åŒç½‘ç»œç­–ç•¥å·¥ä½œæ–¹å¼</h2>
<ul>
<li>NAT ç½‘ç»œæ¨¡å¼
<ul>
<li>NAT ç½‘ç»œä»¥è·¯ç”±å™¨çš„ NAT åŠŸèƒ½ä¸ºåŸç†ï¼Œå…è®¸è™šæ‹Ÿæœºé€šè¿‡å…±äº«ä¸»æœºçš„ IP åœ°å€è®¿é—®äº’è”ç½‘ï¼Œä½†è™šæ‹Ÿæœºä¹‹é—´ä¸èƒ½ç›´æ¥é€šä¿¡ã€‚é€šè¿‡ç«¯å£è½¬å‘å¯ä»¥å®ç°è™šæ‹Ÿæœºä¹‹é—´çš„è¿æ¥ã€‚</li>
</ul>
</li>
<li>æ¡¥æ¥ç½‘ç»œæ¨¡å¼
<ul>
<li>æ¡¥æ¥ç½‘ç»œæ¨¡å¼é€šè¿‡è™šæ‹Ÿäº¤æ¢æœºè¿æ¥è™šæ‹Ÿæœºå’Œä¸»æœºï¼Œä½¿å¾—è™šæ‹Ÿæœºå¯ä»¥é€šè¿‡å±€åŸŸç½‘è®¿é—®äº’è”ç½‘ï¼Œå¹¶å…è®¸è™šæ‹Ÿæœºä¹‹é—´ç›´æ¥é€šä¿¡ã€‚</li>
</ul>
</li>
<li>å†…éƒ¨ç½‘ç»œæ¨¡å¼
<ul>
<li>å†…éƒ¨ç½‘ç»œæ¨¡å¼ä½¿å¾—è™šæ‹Ÿæœºå¯ä»¥åˆ›å»ºä¸€ä¸ªå®Œå…¨éš”ç¦»çš„ç½‘ç»œï¼Œè™šæ‹Ÿæœºä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®äº’è”ç½‘æˆ–å¤–éƒ¨ç½‘ç»œã€‚</li>
</ul>
</li>
<li>ä»…ä¸»æœºç½‘ç»œæ¨¡å¼
<ul>
<li>ä»…ä¸»æœºç½‘ç»œæ¨¡å¼å…è®¸è™šæ‹Ÿæœºä¹‹é—´å¯ä»¥é€šä¿¡ï¼Œå¹¶ä¸”ä¸ä¸»æœºä¹‹é—´ä¹Ÿå¯ä»¥é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®äº’è”ç½‘æˆ–å¤–éƒ¨ç½‘ç»œã€‚</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>VM &lt;&gt; VM</th>
<th>VM â†’ HOST</th>
<th>HOST â†’ VM</th>
<th>VM â†’ Internet</th>
<th>Internet â†’ VM</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç½‘ç»œåœ°å€è½¬æ¢ NAT</td>
<td>Ã—</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>Ã—</td>
</tr>
<tr>
<td>NAT ç½‘ç»œ</td>
<td>âˆš</td>
<td>âˆš</td>
<td>Ã—</td>
<td>âˆš</td>
<td>Ã—</td>
</tr>
<tr>
<td>Bridged Adapter æ¡¥æ¥ç½‘å¡</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
<td>âˆš</td>
</tr>
</tbody>
</table>
<h2 id="tuntap-ç½‘ç»œè®¾å¤‡">TUN/TAP ç½‘ç»œè®¾å¤‡</h2>
<p>TAP å±äº Linux å†…æ ¸æ”¯æŒçš„ä¸€ç§è™šæ‹ŸåŒ–ç½‘ç»œè®¾å¤‡ï¼Œè¿˜æœ‰ TUN ä¹Ÿå±äºè¿™ç§è®¾å¤‡ï¼Œå®ƒä»¬å®Œå…¨ç”±è½¯ä»¶æ¨¡æ‹Ÿå®ç°ï¼ŒTUN/TAP è´Ÿè´£åœ¨å†…æ ¸åè®®æ ˆå’Œç”¨æˆ·è¿›ç¨‹ä¹‹é—´ä¼ é€åè®®æ•°æ®å•å…ƒã€‚TUN å·¥ä½œåœ¨ç½‘ç»œå±‚ï¼Œè€Œ TAP å·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚ï¼ŒTUN è´Ÿè´£ä¸åº”ç”¨ç¨‹åºäº¤æ¢ IP æ•°æ®åŒ…ï¼Œè€Œ TAP ä¸åº”ç”¨ç¨‹åºäº¤æ¢ä»¥å¤ªç½‘å¸§ã€‚æ‰€ä»¥ TUN ç»å¸¸æ¶‰åŠè·¯ç”±ï¼Œè€Œ TAP å¸¸ç”¨äºç½‘ç»œæ¡¥æ¥ã€‚</p>
<h1 id="ssh-è¿œç¨‹ç™»å½•è™šæ‹Ÿæœº">SSH è¿œç¨‹ç™»å½•è™šæ‹Ÿæœº</h1>
<p>å®¿ä¸»æœºä»»æ„ä¸‹ç›®å½•æ‰§è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ ssh-keygen -t rsa
</span></span><span class="line"><span class="cl">Generating public/private rsa key pair.
</span></span><span class="line"><span class="cl">Enter file in which to save the key <span class="o">(</span>/home/user/.ssh/id_rsa<span class="o">)</span>: host2vm0_id_irsa
</span></span><span class="line"><span class="cl">Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>: 
</span></span><span class="line"><span class="cl">Enter same passphrase again: 
</span></span><span class="line"><span class="cl">Your identification has been saved in host2vm0_id_irsa.
</span></span><span class="line"><span class="cl">Your public key has been saved in host2vm0_id_irsa.pub.
</span></span><span class="line"><span class="cl">The key fingerprint is:
</span></span><span class="line"><span class="cl">SHA256:OkWcw+R3x6Z2mzeYQuG033H3N9qIeym3TZKzz6YD8tQ user@ubuntu18
</span></span><span class="line"><span class="cl">The key<span class="err">&#39;</span>s randomart image is:
</span></span><span class="line"><span class="cl">+---<span class="o">[</span>RSA 2048<span class="o">]</span>----+
</span></span><span class="line"><span class="cl"><span class="p">|</span>        .        <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="o">=</span> .   .   <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>        B .o. +  <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       . oo.o+   <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>        S  ++ ..o<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       o ..+.E<span class="o">=</span><span class="nv">o</span><span class="o">=</span><span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>      o   +..B+<span class="o">=</span>+<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>       .   <span class="nv">oo</span><span class="o">=</span>@o+<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>           <span class="nv">o</span><span class="o">=</span>**<span class="o">=</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----<span class="o">[</span>SHA256<span class="o">]</span>-----+
</span></span></code></pre></div><p>ä¸€ç›´å›è½¦ç¡®å®šï¼Œç”Ÿæˆå…¬ç§é’¥ï¼Œä¿å­˜åœ¨<code>~/.ssh</code>ç›®å½•ä¸‹ã€‚</p>
<blockquote>
<p>æˆ‘åœ¨å®¿ä¸»æœºä¸Šç”Ÿæˆçš„å…¬ç§é’¥åç§°ä¸ºï¼Œåˆ†åˆ«æ˜¯<code>host2vm0_id_rsa</code>,<code>host2vm0_id_rsa.pub</code>æ–¹ä¾¿æˆ‘è®°å¿†ã€‚å¦‚æœä¸€ç›´å›è½¦ï¼Œé‚£ä¹ˆç”Ÿæˆçš„å…¬ç§é’¥åç§°ä¸º<code>id_rsa</code>ï¼Œ<code>id_rsa.pub</code>ã€‚</p>
</blockquote>
<p>å°†å…¬é’¥å¤åˆ¶åˆ°è™šæ‹Ÿæœº <code>VM0</code> ä¸Šï¼Œä»¥å½“å‰è™šæ‹Ÿæœº <code>VM0</code> çš„ IPï¼š<code>10.12.193.53</code> ä¸ºä¾‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ ssh-copy-id 10.12.193.53
</span></span><span class="line"><span class="cl"><span class="c1"># è¾“å…¥å¯†ç </span>
</span></span><span class="line"><span class="cl">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span class="o">(</span>s<span class="o">)</span>, to filter out any that are already installed
</span></span><span class="line"><span class="cl">/usr/bin/ssh-copy-id: INFO: <span class="m">1</span> key<span class="o">(</span>s<span class="o">)</span> remain to be installed -- <span class="k">if</span> you are prompted now it is to install the new keys
</span></span><span class="line"><span class="cl">user@10.12.193.53<span class="s1">&#39;s password: 
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Number of key(s) added: 1
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Now try logging into the machine, with:   &#34;ssh &#39;</span>10.12.193.53<span class="err">&#39;</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">and check to make sure that only the key(s) you wanted were added.
</span></span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥ç›´æ¥å…å¯†ç ç™»å½•äº†ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">ssh user@10.12.193.53
</span></span></code></pre></div><h1 id="fixed-problems-ongoing">Fixed Problems (Ongoing)</h1>
<h2 id="cannot-ioctl-tunsetiff-tap0-device-or-resource-busy-errno16">cannot ioctl tunsetiff tap0 device or resource busy (errno=16)</h2>
<h2 id="failed-to-initialize-tap-device-operation-not-permitted">failed to initialize tap device: Operation not permitted</h2>
<p>åŒç±»å‹é”™è¯¯ï¼šfailed to create TAP device: Operation not permittedã€‚å› ä¸ºåˆ›å»ºè™šæ‹Ÿè®¾å¤‡ <code>tap</code> éœ€è¦ <code>root</code> æƒé™ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ <code>sudo</code> å‘½ä»¤ã€‚æ‰§è¡Œ QEMU å¯åŠ¨æ˜¯éœ€è¦æ·»åŠ  <code>sudo</code>ã€‚</p>
<h2 id="qemu-è™šæ‹Ÿæœºå¯åŠ¨åç½‘å¡å¤„äº-down-çŠ¶æ€æ— æ³•è·å–-ip">QEMU è™šæ‹Ÿæœºå¯åŠ¨åç½‘å¡å¤„äº DOWN çŠ¶æ€ï¼Œæ— æ³•è·å– IP</h2>
<p>æŸ¥çœ‹æ˜¯å¦æ˜¯ MAC åœ°å€é…ç½®é”™è¯¯ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤æ£€æŸ¥ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo ifconfig eth0 up
</span></span><span class="line"><span class="cl">SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>å¦‚æœæŠ¥é”™ï¼Œå‚è€ƒä¸‹é¢ç« èŠ‚<strong>SIOCSIFFLAGS: Cannot assign requested address</strong>è§£å†³æ–¹æ³•è¿›è¡Œè§£å†³ã€‚</p>
<h2 id="è™šæ‹Ÿæœºå¯ä»¥-ping-é€šå¤–ç½‘å®¿ä¸»æœºæ— æ³•-ping-å¤–ç½‘">è™šæ‹Ÿæœºå¯ä»¥ ping é€šå¤–ç½‘ï¼Œå®¿ä¸»æœºæ— æ³• ping å¤–ç½‘</h2>
<p>è¿™ç§æƒ…å†µè¯´æ˜åŸºæœ¬ç½‘ç»œæ²¡æœ‰é—®é¢˜ï¼Œåªæ˜¯ DNS è§£ææœ‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹<code>/etc/resolv.conf</code>æ–‡ä»¶è§£å†³ã€‚</p>
<p>æµ·å® DNS æœåŠ¡å™¨åœ°å€ï¼š<code>10.12.2.21</code> å’Œ <code>10.12.2.22</code>ï¼Œæˆ‘çš„æƒ…å†µæ˜¯åªèƒ½ <code>ping 10.12.2.21</code>ï¼Œå¯ä»¥é€‰æ‹©è‡ªå·±èƒ½ <code>ping</code> é€šçš„ DNS æœåŠ¡å™¨åœ°å€ã€‚å¦‚æœæ— æ³• <code>ping</code> é€šï¼Œè¯´æ˜é—®é¢˜ä¸åœ¨è¿™ï¼Œéœ€è¦è‡ªè¡Œè§£å†³ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ä¿®æ”¹ DNS æœåŠ¡å™¨åœ°å€</span>
</span></span><span class="line"><span class="cl">sudo vim /etc/resolv.conf
</span></span><span class="line"><span class="cl"><span class="c1"># æ·»åŠ ä»¥ä¸‹å†…å®¹</span>
</span></span><span class="line"><span class="cl">nameserver 10.12.2.21
</span></span><span class="line"><span class="cl">nameserver 10.12.2.22
</span></span></code></pre></div><h2 id="ç½‘ç»œé…ç½®é”™è¯¯å¦‚ä½•æ¢å¤é…ç½®ä¹‹å‰çš„çŠ¶æ€">ç½‘ç»œé…ç½®é”™è¯¯ï¼Œå¦‚ä½•æ¢å¤é…ç½®ä¹‹å‰çš„çŠ¶æ€</h2>
<p>æœ€ç®€å•çš„æ–¹å¼ - é‡å¯ï¼Œå› ä¸ºæ‰€æœ‰æ“ä½œéƒ½æ˜¯å‘½ä»¤è¡Œé…ç½®ï¼Œéƒ½æ˜¯ä¸´æ—¶é…ç½®ï¼Œå¯ä»¥ç›´æ¥é‡å¯è§£å†³ã€‚</p>
<p>æ—¢ç„¶æœ‰è¿™ä¸€å°èŠ‚ï¼Œè¯´æ˜è‚¯å®šæœ‰æ—¶å€™ä¸æ–¹ä¾¿ç›´æ¥é‡å¯ï¼Œé‚£ä¹ˆå°±éœ€è¦æ‰‹åŠ¨æ¢å¤é…ç½®ä¹‹å‰çš„çŠ¶æ€ã€‚ä½†æ˜¯èƒ½å¤Ÿæ¢å¤çš„<strong>å‰ææ˜¯éœ€è¦è®°å¾—ä¹‹å‰çš„ç½‘å¡ IP åœ°å€ã€å­ç½‘æ©ç ã€ç½‘å…³ã€å¹¿æ’­åœ°å€ç­‰ä¿¡æ¯</strong>ã€‚è¿™äº›ä¿¡æ¯åœ¨å±€åŸŸç½‘é‡Œï¼Œå¯èƒ½åªæœ‰ IP ä¸åŒï¼Œå…¶ä»–ä¿¡æ¯å¦‚æœæ²¡è®°ä½å¯ä»¥æŸ¥çœ‹å…¶ä»–åŒäº‹çš„ç½‘å¡é…ç½®å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># å°†ç½‘æ¡¥ç»‘å®šçš„ç½‘å¡ä»ç½‘æ¡¥ä¸Šç§»é™¤</span>
</span></span><span class="line"><span class="cl">sudo brctl delif br0 enp2s0
</span></span><span class="line"><span class="cl">sudo brctl delif br0 tap0
</span></span><span class="line"><span class="cl"><span class="c1"># é…ç½®å®¿ä¸»æœºç½‘å¡ä¿¡æ¯ï¼Œå¿…é¡»ä¸€å­—ä¸å·®ï¼Œä¿æŒå’Œä¹‹å‰ä¸€æ¨¡ä¸€æ ·æ‰èƒ½æ¢å¤</span>
</span></span><span class="line"><span class="cl">sudo ip addr add 10.12.192.173/20 broadcast 10.12.207.255 dev enp2s0
</span></span><span class="line"><span class="cl"><span class="c1"># å¿…é¡»è®¾ç½®ç½‘å…³</span>
</span></span><span class="line"><span class="cl">sudo ip route add default via 10.12.192.1 dev enp2s0
</span></span><span class="line"><span class="cl"><span class="c1"># é‡å¯ç½‘ç»œç®¡ç†å™¨</span>
</span></span><span class="line"><span class="cl">systemctl restart NetworkManager
</span></span></code></pre></div><h2 id="-netdev-tapidtapnetscriptqemu-scriptqemu-ifupnetwork-script-qemu-scriptqemu-ifup-failed-with-status-256">-netdev tap,id=tapnet,script=/qemu-script/qemu-ifup,:network script /qemu-script/qemu-ifup failed with status 256</h2>
<p>å¯èƒ½åŸå›  1: <code>qemu-ifup</code> è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod +x qemu-ifup
</span></span></code></pre></div><p>å¯èƒ½åŸå›  2: <code>qemu-ifup</code> è·¯å¾„ä¸å¯¹ï¼Œå¿…é¡»æ”¾åˆ°<code>/etc/qemu/</code>ç›®å½•ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p /etc/qemu
</span></span><span class="line"><span class="cl">mv qemu-ifup /etc/qemu <span class="o">&amp;&amp;</span> mv qemu-ifdown /etc/qemu 
</span></span><span class="line"><span class="cl">sudo chmod +x qemu-ifup
</span></span><span class="line"><span class="cl">sudo chmod +x qemu-ifdown
</span></span></code></pre></div><h2 id="siocsifflags-cannot-assign-requested-address">SIOCSIFFLAGS: Cannot assign requested address</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo ifconfig eth0 up
</span></span><span class="line"><span class="cl">SIOCSIFFLAGS: Cannot assign requested address
</span></span></code></pre></div><p>ä¸€èˆ¬ç”±äº MAC åœ°å€é…ç½®é”™è¯¯å¯¼è‡´ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ MAC åœ°å€ä¸ºå¤šæ’­åœ°å€è§£å†³ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo ifconfig enp2s0 hw ether 00:11:22:33:44:55
</span></span></code></pre></div><p>é‡å¯ç½‘å¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo ifconfig enp2s0 down
</span></span><span class="line"><span class="cl">sudo ifconfig enp2s0 up
</span></span></code></pre></div><p>MAC åœ°å€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸­çš„æœ€åä¸€ä½ï¼ˆå³ç¬¬ 7 ä½ï¼‰ç”¨äºæ ‡è¯†è¯¥åœ°å€æ˜¯å•æ’­ï¼Œå¤šæ’­è¿˜æ˜¯å¹¿æ’­åœ°å€ã€‚å¦‚æœè¿™ä¸ªä½è®¾ç½®ä¸º 0ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•æ’­åœ°å€ï¼›å¦‚æœè®¾ç½®ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¤šæ’­æˆ–å¹¿æ’­åœ°å€ã€‚</p>
<p>ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šä¸Šè¿°æ¯ä¸ª MAC åœ°å€æ˜¯å¦æ˜¯å•æ’­åœ°å€ï¼š</p>
<ul>
<li><code>cd:c2:05:84:c8:2c</code> - å•æ’­åœ°å€</li>
<li><code>13:7b:49:fc:a6:aa</code> - å•æ’­åœ°å€</li>
<li><code>8f:aa:42:29:e8:68</code> - å•æ’­åœ°å€</li>
</ul>
<p><code>00:11:22:33:44:55</code> æ˜¯å¤šæ’­åœ°å€ã€‚</p>
<h2 id="qemu--device-drive-with-0-bus0-unit0-exists">qemu -device drive with 0 bus=0 unit=0 exists</h2>
<p>è¿™ä¸ªé”™è¯¯é€šå¸¸æ„å‘³ç€æ‚¨å°è¯•åœ¨ QEMU VM ä¸­æ·»åŠ ä¸€ä¸ªé‡å¤çš„è®¾å¤‡ã€‚</p>
<p>å¦‚æœæ‚¨å·²ç»åœ¨ VM ä¸­æ·»åŠ äº†é©±åŠ¨å™¨ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°æ­¤é—®é¢˜ã€‚æ‚¨å¯ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸¤ä¸ªå…·æœ‰ç›¸åŒ <code>bus</code> å’Œ <code>unit</code> çš„è®¾å¤‡ï¼ˆåœ¨æ­¤æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ 0ï¼‰ã€‚è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•æ˜¯åˆ é™¤é‡å¤è®¾å¤‡æˆ–æ›´æ”¹å…¶é…ç½®ä»¥åŒ…æ‹¬å”¯ä¸€çš„ <code>bus</code> å’Œ <code>unit</code>ã€‚</p>
<p>å¦‚æœæ‚¨æ²¡æœ‰æ„å›¾æ·»åŠ é‡å¤çš„è®¾å¤‡ï¼Œåœ¨è¿è¡Œ QEMU ä¹‹å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥æ‚¨çš„å‘½ä»¤è¡Œï¼Œä»¥ç¡®ä¿æ­£ç¡®è®¾ç½®äº† <code>-drive</code> é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œå½“ä½¿ç”¨ <code>-device</code> æ·»åŠ è®¾å¤‡æ—¶ï¼Œæ‚¨è¿˜åº”è¯¥é¿å…ä½¿ç”¨ <code>-drive</code> é€‰é¡¹ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½å¼•èµ·å†²çªã€‚</p>
<p>å¦‚æœæ‚¨éœ€è¦è¿›ä¸€æ­¥å¸®åŠ©ï¼Œå»ºè®®æä¾›å®Œæ•´çš„ QEMU å‘½ä»¤å’Œå‚æ•°åˆ—è¡¨ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£é—®é¢˜å¹¶æä¾›æ›´è¯¦ç»†çš„å»ºè®®ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<ol>
<li><a href="https://tomwei7.com/2021/10/09/qemu-network-config/">QEMU ç½‘ç»œé…ç½® // å›´åŸ</a></li>
<li><a href="https://www.junmajinlong.com/img/virtual/1594802457384.png">ç†è§£ Linux è™šæ‹Ÿç½‘å¡è®¾å¤‡ tun/tap çš„ä¸€åˆ‡ | éªé©¬é‡‘é¾™</a></li>
<li><a href="https://wzt.ac.cn/2021/05/28/QEMU-networking/">QEMU ç½‘ç»œé…ç½®ä¸€æŠŠæ¢­ | CataLpa&rsquo;s Site</a></li>
<li><a href="https://blog.csdn.net/u014022631/article/details/53411557">qemu è™šæ‹Ÿæœºä¸å¤–éƒ¨ç½‘ç»œçš„é€šä¿¡ li_Jiejun çš„åšå®¢-CSDN åšå®¢</a></li>
<li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html">å®‰è£… qemu-kvm ä»¥åŠé…ç½®æ¡¥æ¥ç½‘ç»œ</a></li>
<li><a href="https://blog.csdn.net/rikeyone/article/details/106767540">QEMU ä¸­çš„ç½‘ç»œè™šæ‹ŸåŒ–é…ç½®_ç¨‹åºçŒ¿ Ricky çš„æ—¥å¸¸å¹²è´§çš„åšå®¢-CSDN åšå®¢</a></li>
<li><a href="https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/QEMU/">Nginx Directory</a></li>
<li><a href="https://www.cnblogs.com/huqingyu/archive/2005/04/03/131102.html">QEMU ç½‘ç»œé…ç½® - æµ™æ—é¾™å“¥ - åšå®¢å›­</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/432022126">ã€qemuã€‘qemu ç½‘ç»œé…ç½® - çŸ¥ä¹</a></li>
<li><a href="https://tomwei7.com/2021/10/09/qemu-network-config/">QEMU ç½‘ç»œé…ç½® // å›´åŸ</a></li>
<li><a href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html">å®‰è£… qemu-kvm ä»¥åŠé…ç½®æ¡¥æ¥ç½‘ç»œ</a></li>
<li><a href="https://blog.virt.ltd/blog/archives/37/">åœ¨ qemu ä¸­ä½¿ç”¨æ¡¥æ¥ç½‘ç»œ - T^3 Blog</a></li>
<li><a href="http://wiki.yanick.site/wiki/os/qemu/">ä¸º QEMU é…ç½®ç½‘æ¡¥ä¸Šç½‘ | Yanick&rsquo;s Wiki</a></li>
<li><a href="https://www.junmajinlong.com/virtual/network/all_about_tun_tap/">ç†è§£ Linux è™šæ‹Ÿç½‘å¡è®¾å¤‡ tun/tap çš„ä¸€åˆ‡ | éªé©¬é‡‘é¾™</a></li>
<li><a href="https://wzt.ac.cn/2021/05/28/QEMU-networking/">QEMU ç½‘ç»œé…ç½®ä¸€æŠŠæ¢­ | CataLpa&rsquo;s Site</a></li>
</ol>
<h1 id="é™„å½•">é™„å½•</h1>
]]></content:encoded>
    </item>
    <item>
      <title>QEMUå¯åŠ¨RISC-Væ¶æ„OpenEulerå¹¶é…ç½®OSCç¯å¢ƒ</title>
      <link>https://lifeislife.cn/posts/qemu%E5%90%AF%E5%8A%A8risc-v%E6%9E%B6%E6%9E%84openeuler%E5%B9%B6%E9%85%8D%E7%BD%AEosc%E7%8E%AF%E5%A2%83/</link>
      <pubDate>Sun, 23 Jul 2023 19:28:29 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E5%90%AF%E5%8A%A8risc-v%E6%9E%B6%E6%9E%84openeuler%E5%B9%B6%E9%85%8D%E7%BD%AEosc%E7%8E%AF%E5%A2%83/</guid>
      <description>åŸºäºUbuntu 18.04ï¼ŒQEMU 8.0.2ï¼ŒOpenEuler 22.09 å®‰è£…QEMU å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…· sudo apt install build-essential autoconf automake autotools-dev pkg-config bc curl \ gawk git bison flex texinfo gperf libtool patchutils mingw-w64 libmpc-dev \</description>
      <content:encoded><![CDATA[<blockquote>
<p>åŸºäºUbuntu 18.04ï¼ŒQEMU 8.0.2ï¼ŒOpenEuler 22.09</p>
</blockquote>
<h1 id="å®‰è£…qemu">å®‰è£…QEMU</h1>
<h2 id="å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·">å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo apt install build-essential autoconf automake autotools-dev pkg-config bc curl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                 gawk git bison flex texinfo gperf libtool patchutils mingw-w64 libmpc-dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                 libmpfr-dev libgmp-dev libexpat-dev libfdt-dev zlib1g-dev libglib2.0-dev <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                 libpixman-1-dev libncurses5-dev libncursesw5-dev meson libvirglrenderer-dev libsdl2-dev  -y
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo add-apt-repository ppa:deadsnakes/ppa
</span></span><span class="line"><span class="cl">sudo apt install python3.8 python3-pip  -y
</span></span><span class="line"><span class="cl">sudo apt install -f
</span></span><span class="line"><span class="cl">pip3 install meson
</span></span></code></pre></div><h2 id="ä¸‹è½½qemu">ä¸‹è½½QEMU</h2>
<p>å»ºç«‹æ–‡ä»¶å¤¹ç”¨äºç¼–è¯‘ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="o">&amp;&amp;</span> mkdir -p qemu-build
</span></span></code></pre></div><p>å»ºç«‹æ–‡ä»¶å¤¹ç”¨äºå®‰è£…ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="o">&amp;&amp;</span> mkdir -p /home/user/program/riscv64-qemu
</span></span></code></pre></div><p>å¯ç™»å½•<a href="https://www.qemu.org/download/">å®˜ç½‘</a>å°†ç‰ˆæœ¬å·æ¢æˆæœ€æ–°ç‰ˆæœ¬å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> qemu-build <span class="o">&amp;&amp;</span> wget  <span class="s2">&#34;https://download.qemu.org/qemu-8.0.2.tar.xz&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">tar -xf qemu-8.0.2.tar.xz --strip-components<span class="o">=</span><span class="m">1</span> 
</span></span></code></pre></div><h2 id="å®‰è£…qemu-1">å®‰è£…QEMU</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> qemu-build <span class="o">&amp;&amp;</span> ./configure --target-list<span class="o">=</span>riscv32-softmmu,riscv32-linux-user,riscv64-linux-user,riscv64-softmmu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>               --enable-kvm --enable-sdl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>               --prefix<span class="o">=</span>/home/user/program/riscv64-qemu
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">make install -j <span class="k">$(</span>nproc<span class="k">)</span>
</span></span></code></pre></div><p>é…ç½®ç¯å¢ƒå˜é‡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s1">&#39;export QEMU_HOME=/home/user/program/riscv64-qemu&#39;</span> &gt;&gt; ~/.bashrc <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">&#39;export PATH=$QEMU_HOME/bin:$PATH&#39;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">source</span> ~/.bashrc
</span></span></code></pre></div><h1 id="ä¸‹è½½-openeuler-risc-v-ç³»ç»Ÿé•œåƒ">ä¸‹è½½ OpenEuler RISC-V ç³»ç»Ÿé•œåƒ</h1>
<p>å»ºç«‹ç›®å½•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="o">&amp;&amp;</span> mkdir -p /home/user/openeuler
</span></span></code></pre></div><blockquote>
<p>æ ¹æ®è‡ªå·±çš„ç”¨æˆ·åä¿®æ”¹user</p>
</blockquote>
<p>ä¸‹è½½<a href="https://repo.openeuler.org/openEuler-preview/RISC-V/openEuler-22.09-riscv64/QEMU/">OpenEuler 22.09ç‰ˆæœ¬</a>ï¼Œä¸‹è½½ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶/home/user/openeulerã€‚å¦‚éœ€ä¸‹è½½å…¶ä»–ç‰ˆæœ¬è¯·è¿›å…¥å…¶ä»–ç›®å½•é€‰æ‹©ä¸‹è½½å³å¯ã€‚</p>
<blockquote>
<p>ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›å…¥<a href="https://www.openeuler.org/zh/mirror/list/">é•œåƒç«™åˆ—è¡¨</a>é€‰æ‹©ä¸‹è½½é€Ÿåº¦æ›´å¿«çš„é•œåƒç«™ä¸‹è½½</p>
</blockquote>
<blockquote>
<p>æœ€æ–°çš„23.03ç‰ˆæœ¬éœ€è¦åœ¨<a href="https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-23.03-V1-riscv64/">ä¸­ç§‘é™¢é•œåƒç«™</a>ä¸‹è½½</p>
</blockquote>
<p>æ–‡ä»¶è¯´æ˜ï¼š</p>
<ul>
<li><code>fw_payload_oe_qemuvirt.elf</code>: åˆ©ç”¨ openSBI å°† kernel-5.10 çš„ image ä½œä¸º payload æ‰€åˆ¶ä½œçš„ QEMU å¯åŠ¨æ‰€éœ€æ–‡ä»¶</li>
<li><code>openEuler-22.09-qemu-xfce.qcow2.tar.zst</code>: openEuler RISC-V QEMU GUI é•œåƒå‹ç¼©åŒ…</li>
<li><code>preview_start_vm_xfce.sh</code>: GUI è™šæ‹Ÿæœºå¯åŠ¨è„šæœ¬</li>
<li><code>openeuler-22.09-qemu.qcow2.tar.zst</code>: openEuler RISC-V QEMU headless é•œåƒå‹ç¼©åŒ…</li>
<li><code>preview_start_vm.sh</code>: headless è™šæ‹Ÿæœºå¯åŠ¨è„šæœ¬</li>
</ul>
<p>è§£å‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"> sudo apt-get install zstd
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"> tar -I <span class="s1">&#39;zstdmt&#39;</span> -xvf openEuler-22.09-riscv64-qemu.qcow2.tar.zst
</span></span></code></pre></div><p>æ‰§è¡Œå¯åŠ¨è„šæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">chmod +x preview_start_vm.sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">bash preview_start_vm.sh
</span></span></code></pre></div><h1 id="ç™»å½•ç³»ç»Ÿ">ç™»å½•ç³»ç»Ÿ</h1>
<ul>
<li>ç”¨æˆ·å: <code>root</code></li>
<li>é»˜è®¤å¯†ç : <code>openEuler12#$</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">openEuler 22.09
</span></span><span class="line"><span class="cl">Kernel 5.10.0 on an riscv64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4penEuler-riscv6
</span></span><span class="line"><span class="cl"> login: openEuler 22.09
</span></span><span class="line"><span class="cl">Kernel 5.10.0 on an riscv64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openEuler-riscv64 login: root
</span></span><span class="line"><span class="cl">Password: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Welcome to 5.10.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">System information as of time:   Mon Jul  <span class="m">3</span> 07:52:19 PM CST <span class="m">2023</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">System load:   0.17
</span></span><span class="line"><span class="cl">Processes:   <span class="m">117</span>
</span></span><span class="line"><span class="cl">Memory used:   .6%
</span></span><span class="line"><span class="cl">Swap used:   0.0%
</span></span><span class="line"><span class="cl">Usage On:   6%
</span></span><span class="line"><span class="cl">Users online:   <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-riscv64 ~<span class="o">]</span><span class="c1"># pwd</span>
</span></span></code></pre></div><h3 id="è¿œç¨‹ç™»å½•ç³»ç»Ÿ">è¿œç¨‹ç™»å½•ç³»ç»Ÿ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">ssh -p <span class="m">12055</span> root@localhost
</span></span></code></pre></div><h1 id="é…ç½®ç³»ç»Ÿ">é…ç½®ç³»ç»Ÿ</h1>
<blockquote>
<p>ä»¥ä¸‹æ“ä½œå‡åœ¨rootç”¨æˆ·ä¸‹æ‰§è¡Œï¼Œå¦‚æœåˆ‡æ¢äº†ç”¨æˆ·ä¼šæœ‰æç¤ºã€‚å› ä¸ºç³»ç»Ÿåˆå§‹çŠ¶æ€æ²¡æœ‰æ™®é€šç”¨æˆ·ï¼Œä¹Ÿæ²¡æœ‰sudoï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨rootå®Œæˆä¸€äº›åŸºç¡€é…ç½®ã€‚</p>
</blockquote>
<h2 id="ä¿®æ”¹rootå¯†ç ">ä¿®æ”¹rootå¯†ç </h2>
<p>åŸå¯†ç å¤ªå¤æ‚ï¼Œä¿®æ”¹ç®€å•å¯†ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">passwd root
</span></span><span class="line"><span class="cl"><span class="c1"># è¾“å…¥ä¸¤æ¬¡å¯†ç </span>
</span></span></code></pre></div><h2 id="æ·»åŠ æ™®é€šç”¨æˆ·">æ·»åŠ æ™®é€šç”¨æˆ·</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="c1"># æ·»åŠ ç”¨æˆ· user</span>
</span></span><span class="line"><span class="cl">useradd -s /bin/bash -d /home/user -m user
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">passwd user
</span></span><span class="line"><span class="cl"><span class="c1"># è¾“å…¥ä¸¤æ¬¡å¯†ç </span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="c1"># æ·»åŠ ç®¡ç†å‘˜æƒé™</span>
</span></span><span class="line"><span class="cl">usermod -aG wheel user
</span></span></code></pre></div><h2 id="ä¿®æ”¹æ—¶é—´">ä¿®æ”¹æ—¶é—´</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;NTP=ntp.aliyun.com&#34;</span> &gt;&gt; /etc/systemd/timesyncd.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">systemctl restart systemd-timesyncd.service
</span></span></code></pre></div><p>æŸ¥çœ‹<code>timesyncd</code>è¿è¡ŒçŠ¶æ€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">systemctl status systemd-timesyncd.service
</span></span></code></pre></div><p><code>date</code>å‘½ä»¤å¯æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ—¶é—´ã€‚éªŒè¯æ˜¯å¦é…ç½®æˆåŠŸã€‚</p>
<p><strong>æ—¶é—´åŠ¡å¿…æ­£ç¡®è®¾ç½®</strong>ï¼Œé”™è¯¯çš„æ—¶é—´ä¼šå½±å“è¯¸å¦‚httpsçš„TLSè®¤è¯ç­‰è¿‡ç¨‹ã€‚</p>
<h2 id="é…ç½®dns">é…ç½®DNS</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">vim /etc/resolv.conf
</span></span><span class="line"><span class="cl">nameserver 119.29.29.29
</span></span></code></pre></div><h2 id="é…ç½®è½¯ä»¶åŒ…æº">é…ç½®è½¯ä»¶åŒ…æº</h2>
<p>é…ç½®æ–‡ä»¶ä¸º /etc/yum.repos.d/openEuler.repo ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">mv /etc/yum.repos.d/openEuler.repo  /etc/yum.repos.d/openEuler.repo.bk <span class="o">&amp;&amp;</span> sudo bash -c <span class="s2">&#34;cat &lt;&lt; EOF &gt; /etc/yum.repos.d/openEuler.repo
</span></span></span><span class="line"><span class="cl"><span class="s2"># just for test
</span></span></span><span class="line"><span class="cl"><span class="s2">[mainline]
</span></span></span><span class="line"><span class="cl"><span class="s2">name=mainline
</span></span></span><span class="line"><span class="cl"><span class="s2">baseurl=https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/repo/22.09/
</span></span></span><span class="line"><span class="cl"><span class="s2">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s2">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s2"># just for test
</span></span></span><span class="line"><span class="cl"><span class="s2">[epol]
</span></span></span><span class="line"><span class="cl"><span class="s2">name=epol
</span></span></span><span class="line"><span class="cl"><span class="s2">baseurl=https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/repo/22.09/
</span></span></span><span class="line"><span class="cl"><span class="s2">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s2">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s2">[extra]
</span></span></span><span class="line"><span class="cl"><span class="s2">name=extra
</span></span></span><span class="line"><span class="cl"><span class="s2">baseurl=https://mirror.iscas.ac.cn/openeuler-sig-riscv/openEuler-RISC-V/preview/openEuler-22.09-V1-riscv64/repo/extra/
</span></span></span><span class="line"><span class="cl"><span class="s2">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s2">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s2">EOF&#34;</span>
</span></span></code></pre></div><blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºOpenEulerè¿˜åœ¨å¿«é€Ÿå‘å±•ä¸­ï¼Œé•œåƒåœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥éœ€ç¡®è®¤åœ°å€æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è®¿é—®ï¼Œå¦‚æ— æ³•è®¿é—®ä¼šå¯¼è‡´404é”™è¯¯</p>
</blockquote>
<blockquote>
<p>[repoid]ä¸­çš„repoidä¸ºè½¯ä»¶ä»“åº“ï¼ˆrepositoryï¼‰çš„IDå·ï¼Œæ‰€æœ‰.repoé…ç½®æ–‡ä»¶ä¸­çš„å„repoidä¸èƒ½é‡å¤ï¼Œå¿…é¡»å”¯ä¸€ã€‚ç¤ºä¾‹ä¸­repoidè®¾ç½®ä¸ºbaseã€‚
nameä¸ºè½¯ä»¶ä»“åº“æè¿°çš„å­—ç¬¦ä¸²ã€‚
baseurlä¸ºè½¯ä»¶ä»“åº“çš„åœ°å€ã€‚
enabledä¸ºæ˜¯å¦å¯ç”¨è¯¥è½¯ä»¶æºä»“åº“ï¼Œå¯é€‰å€¼ä¸º1å’Œ0ã€‚é»˜è®¤å€¼ä¸º1ï¼Œè¡¨ç¤ºå¯ç”¨è¯¥è½¯ä»¶æºä»“åº“ã€‚
gpgcheckå¯è®¾ç½®ä¸º1æˆ–0ï¼Œ1è¡¨ç¤ºè¿›è¡Œgpgï¼ˆGNU Private Guardï¼‰æ ¡éªŒï¼Œ0è¡¨ç¤ºä¸è¿›è¡Œgpgæ ¡éªŒï¼Œgpgcheckå¯ä»¥ç¡®å®šrpmåŒ…çš„æ¥æºæ˜¯æœ‰æ•ˆå’Œå®‰å…¨çš„ã€‚
gpgkeyä¸ºéªŒè¯ç­¾åç”¨çš„å…¬é’¥ã€‚</p>
</blockquote>
<h2 id="ç£ç›˜æ‰©å®¹">ç£ç›˜æ‰©å®¹</h2>
<ol>
<li>åœ¨å®¿ä¸»æœºä¸Šå®‰è£… <code>qemu-img</code> å·¥å…·:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">apt install qemu-utils
</span></span></code></pre></div><ol start="2">
<li>åœ¨ openEuler RISC-V è™šæ‹Ÿæœºä¸Šå®‰è£… <code>growpart</code> å·¥å…·:</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">dnf install cloud-utils-growpart
</span></span></code></pre></div><ol start="3">
<li>å…³é—­QEMUè™šæ‹Ÿæœº</li>
<li>æŠŠ qcow2 æ–‡ä»¶çš„å®¹é‡åŠ 200GBï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">$ qemu-img resize *.qcow2 +200G
</span></span><span class="line"><span class="cl">Image resized.
</span></span><span class="line"><span class="cl">$ qemu-img info *.qcow2
</span></span><span class="line"><span class="cl">image: openEuler-preview.riscv64.qcow2
</span></span><span class="line"><span class="cl">file format: qcow2
</span></span><span class="line"><span class="cl">virtual size: <span class="m">220</span> GiB 
</span></span><span class="line"><span class="cl">disk size: 9.58 GiB
</span></span><span class="line"><span class="cl">cluster_size: <span class="m">65536</span>
</span></span><span class="line"><span class="cl">Format specific information:
</span></span><span class="line"><span class="cl">    compat: 1.1
</span></span><span class="line"><span class="cl">    compression type: zlib
</span></span><span class="line"><span class="cl">    lazy refcounts: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    refcount bits: <span class="m">16</span>
</span></span><span class="line"><span class="cl">    corrupt: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    extended l2: <span class="nb">false</span>
</span></span></code></pre></div><ol start="5">
<li>QEMU å¯åŠ¨ openEuler RISC-Vã€‚</li>
</ol>
<p>å¯åŠ¨ä»¥åï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹åˆ†åŒºæƒ…å†µï¼šå¯ä»¥çœ‹åˆ°æ ¹ç›®å½•å¯¹åº”çš„åˆ†åŒºåªä½¿ç”¨äº† 10Gã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-RISCV-rare ~<span class="o">]</span><span class="c1"># lsblk</span>
</span></span><span class="line"><span class="cl">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span></span><span class="line"><span class="cl">vda    254:0    <span class="m">0</span>  220G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">â””â”€vda1 254:1    <span class="m">0</span>   10G  <span class="m">0</span> part /
</span></span></code></pre></div><ol>
<li>æ‰©å±•åˆ†åŒº <code>vda1</code>ï¼Œæ‰§è¡Œ</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">growpart /dev/vda1
</span></span></code></pre></div><p>æ‰§è¡Œ <code>lsblk</code> å¯ä»¥çœ‹åˆ° / æ‰€åœ¨çš„ <code>vda1</code> åˆ†åŒºå·²ç»æ‰©å±•åˆ°äº†é¢„æœŸå¤§å°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-RISCV-rare ~<span class="o">]</span><span class="c1"># growpart /dev/vda 1</span>
</span></span><span class="line"><span class="cl">CHANGED: <span class="nv">partition</span><span class="o">=</span><span class="m">1</span> <span class="nv">start</span><span class="o">=</span><span class="m">2048</span> old: <span class="nv">size</span><span class="o">=</span><span class="m">20969472</span> <span class="nv">end</span><span class="o">=</span><span class="m">20971520</span> new: <span class="nv">size</span><span class="o">=</span><span class="m">419428319</span> <span class="nv">end</span><span class="o">=</span><span class="m">419430367</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@openEuler-RISCV-rare ~<span class="o">]</span><span class="c1"># lsblk</span>
</span></span><span class="line"><span class="cl">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span></span><span class="line"><span class="cl">vda    254:0    <span class="m">0</span>  220G  <span class="m">0</span> disk
</span></span><span class="line"><span class="cl">â””â”€vda1 254:1    <span class="m">0</span>  220G  <span class="m">0</span> part /
</span></span></code></pre></div><ol>
<li>æ‰©å±•æ–‡ä»¶ç³»ç»Ÿï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">resize2fs /dev/vda1
</span></span></code></pre></div><h1 id="bug">BUG</h1>
<h2 id="network-backend-user-is-not-compiled-into-this-binary">network backend â€˜userâ€˜ is not compiled into this binary</h2>
<p>git clone <a href="https://gitlab.freedesktop.org/slirp/libslirp.git">https://gitlab.freedesktop.org/slirp/libslirp.git</a></p>
<p><a href="http://security.ubuntu.com/ubuntu/pool/main/libs/libslirp/libslirp-dev_4.1.0-2ubuntu2.2_amd64.deb">http://security.ubuntu.com/ubuntu/pool/main/libs/libslirp/libslirp-dev_4.1.0-2ubuntu2.2_amd64.deb</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">sudo apt-get install libslirp-dev
</span></span></code></pre></div><p>é‡æ–°ç¼–è¯‘QEMUï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> qemu-build <span class="o">&amp;&amp;</span> rm -rf build
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl"><span class="nb">cd</span> qemu-build <span class="o">&amp;&amp;</span> ./configure --target-list<span class="o">=</span>riscv32-softmmu,riscv32-linux-user,riscv64-linux-user,riscv64-softmmu <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>               --enable-kvm --enable-sdl --enable-slirp<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>               --prefix<span class="o">=</span>/home/user/program/riscv64-qemu
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">make install -j <span class="k">$(</span>nproc<span class="k">)</span>
</span></span></code></pre></div><h1 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h1>
<p><a href="https://github.com/openeuler-mirror/RISC-V/blob/master/doc/tutorials/vm-qemu-oErv.md">RISC-V/doc/tutorials/vm-qemu-oErv.md at master Â· openeuler-mirror/RISC-V Â· GitHub</a></p>
<p><a href="https://www.openeuler.org/whitepaper/openEuler-whitepaper-2209.pdf">openEuler 22.09æŠ€æœ¯ç™½çš®ä¹¦</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU&#39;s instance_init() vs. realize()</title>
      <link>https://lifeislife.cn/posts/qemu-s-instance-init-vs-realize/</link>
      <pubDate>Tue, 01 Nov 2022 09:51:28 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu-s-instance-init-vs-realize/</guid>
      <description>è½¬è½½è‡ªhuth (Thomas Huth)çš„ä¸€ç¯‡æ–‡ç« ï¼ŒåŸæ–‡å·²ç» 404ï¼Œä»ç½‘é¡µå¿«ç…§ä¸­æ‰¾å›çš„æ–‡ç« ã€‚ Note that this is a blog post for (new) QEMU developers. If you are just interested in using QEMU, you can certainly skip this text. Otherwise, in case you have ever</description>
      <content:encoded><![CDATA[<p>è½¬è½½è‡ª<a href="https://github.com/huth">huth (Thomas Huth)</a>çš„ä¸€ç¯‡æ–‡ç« ï¼ŒåŸæ–‡å·²ç» 404ï¼Œä»ç½‘é¡µå¿«ç…§ä¸­æ‰¾å›çš„æ–‡ç« ã€‚</p>
<p>Note that this is a blog post for (new) QEMU developers. If you are just interested in using QEMU, you can certainly skip this text. Otherwise, in case you have ever been in touch with the QEMU device model (&ldquo;qdev&rdquo;), you are likely aware of the basic qdev code boilerplate already:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">mydev_realize</span><span class="p">(</span><span class="n">DeviceState</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">mydev_instance_init</span><span class="p">(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Property</span> <span class="n">mydev_properties</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DEFINE_PROP_xxx</span><span class="p">(</span><span class="s">&#34;myprop&#34;</span><span class="p">,</span> <span class="n">MyDevState</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="p">...),</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">DEFINE_PROP_END_OF_LIST</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">mydev_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DeviceClass</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="nf">DEVICE_CLASS</span><span class="p">(</span><span class="n">oc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">realize</span> <span class="o">=</span> <span class="n">mydev_realize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&#34;My cool device&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dc</span><span class="o">-&gt;</span><span class="n">props</span> <span class="o">=</span> <span class="n">mydev_properties</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">mydev_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="n">TYPE_MYDEV</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span>        <span class="o">=</span> <span class="n">TYPE_SYS_BUS_DEVICE</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mydev_state</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">mydev_instance_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">class_init</span>    <span class="o">=</span> <span class="n">mydev_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">mydev_register_types</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mydev_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">(</span><span class="n">mydev_register_types</span><span class="p">)</span>
</span></span></code></pre></div><p>There are three different initialization functions involved here, the <strong>class_init</strong>, the <strong>instance_init</strong> and the <strong>realize</strong> function. While it is quite obvious to distinguish the <em>class_init</em> function from the two others (it is used for initializing the class data, not the data that is used for an instance â€¦ this is similar to the object model with classes and instances in C++), I initially always wondered about the difference between the <em>instance_init()</em> and the <em>realize()</em> functions. Having fixed quite a lot of related bugs in the past months in the QEMU code base, I now know that a lot of other people are also not properly aware of the difference here, so I think it is now time to write down some information that I&rsquo;m now aware of, to make sure that I don&rsquo;t forget about this again, and maybe help others to avoid related bugs in the future ;-)</p>
<p>First it is of course always a good idea to have a look at the documentation. While the <a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/qom/object.h;hb%3Dv3.0.0%23l427">documentation of </a><a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/qom/object.h;hb%3Dv3.0.0%23l427"><em>TypeInfo</em></a> (where <a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/qom/object.h;hb%3Dv3.0.0%23l434"><em>instance_init()</em></a> is defined) is not very helpful to understand the differences, the <a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/hw/qdev-core.h;hb%3Dv3.0.0%23l40">documentation of </a><a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/hw/qdev-core.h;hb%3Dv3.0.0%23l40"><em>DeviceClass</em></a> (where <a href="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;prev=search&amp;u=https://git.qemu.org/?p%3Dqemu.git;a%3Dblob;f%3Dinclude/hw/qdev-core.h;hb%3Dv3.0.0%23l43"><em>realize()</em></a> is defined) has some more useful information: You can learn here that the object instantiation is done first, before the device is realized, i.e. the <em>instance_init()</em> function is called first, and the <em>realize()</em> function is called afterwards. The former must not fail, while the latter can return an error to its caller via a pointer to an <em>â€œErrorâ€</em> object pointer.</p>
<p>So the basic idea here is that device objects are first instantiated, then these objects can be inspected for their interfaces and their creators can set up their properties to configure their settings and wire them up with other devices, before the device finally becomes &ldquo;active&rdquo; by being <em>realized</em>. It is important here to notice that <strong>devices can be instantiated (and also finalized) <em><strong><strong>without</strong></strong></em> being realized</strong>! This happens for example if the device is introspected: If you enter for example <code>device_add xyz,help</code> at the HMP monitor, or if you send the <code>device-list-properties</code> QOM command to QEMU to retrieve the device&rsquo;s properties, QEMU creates a temporary instance of the device to query the properties of the object, without realizing it. The object gets destroyed (&ldquo;finalized&rdquo;) immediately afterwards.</p>
<p>Knowing this, you can avoid a set of bugs which could be found with a couple of devices in the past:</p>
<ul>
<li>If you want your device to provide properties for other parts of the QEMU code or for the users, and you want to add those properties via one of the many object_property_add*() functions of QEMU (instead of using the <em>â€œpropsâ€</em> field of the <em>DeviceClass</em>), then you should do this in the <em>instance_init()</em> and not in the <em>realize()</em> function. Otherwise the properties won&rsquo;t show up when the user runs <code>--device xyz,help</code> or the <code>device-list-properties</code> QOM command to get some information about your device.</li>
<li><em>instance_init()</em> functions must really never fail, i.e. also not call <em>abort()</em> or <em>exit()</em>. Otherwise QEMU can terminate unexpectedly when a user simply wanted to have a look at the list of device properties with <code>device_add xyz,help</code> or the <code>device-list-properties</code> QOM command. If your device cannot work in certain circumstances, check for the error condition in the <em>realize()</em> function instead and return with an appropriate error there.</li>
<li>Never assume that your device is always instantiated only with the machine that it was designed for. It&rsquo;s of course a good idea to set the <em>â€œuser_creatable = falseâ€</em> flag in the <em>DeviceClass</em> of your device if your device cannot be plugged in arbitrary machines. But device introspection can still happen at any time, with any machine. So if you wrote a device called &ldquo;mydev-a&rdquo; that only works with <code>--machine A</code>, the user still can start QEMU with the option <code>--machine B</code> instead and then run <code>device_add mydev-a,help</code> or the <code>device-list-properties</code> QOM command. The <em>instance_init()</em> function of your device will be called to create a temporary instance of your device, even though the base machine is B and not A here. So you especially should take care to not depend on the availability of certain buses or other devices in the <em>instance_init()</em> function, nor use things like <em>serial_hd()</em> or <em>nd_table[]</em> in your <em>instance_init()</em> function, since these might (and should) have been used by the machine init function already. If your device needs to be wired up, provide properties as interfaces to the outside and let the creator of your device (e.g. the machine init code) wire your device between the device instantiation and the realize phase instead.</li>
<li>Make sure that your device leaves a clean state after a temporary instance is destroyed again, i.e. don&rsquo;t assume that there will be only one instance of your device which is created at the beginning right after QEMU has been started and is destroyed at the very end before QEMU terminates. Thus do not assume that the things that you do in your <em>instance_init()</em> don&rsquo;t need explicit clean-up since the device instance will only be destroyed when QEMU terminates. Device instances can be created and destroyed at any time, so when the device is finalized, you must not leave any dangling pointers or references to your device behind you, e.g. in the QOM tree. When you create other objects in your <em>instance_init()</em> function, make sure to set proper parents of these objects or use an <em>instance_finalize()</em> function, so that the created objects get cleaned up correctly again when your device is destroyed.</li>
</ul>
<p>All in all, if you write code for a new QEMU device, it is likely a good idea to use the <em>instance_init()</em> function only for e.g. creating properties and other things that are required before device realization, and then do the main work in the <em>realize()</em> function instead.</p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æºç åˆ†æ-QOM</title>
      <link>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-qom/</link>
      <pubDate>Wed, 09 Mar 2022 16:02:19 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-qom/</guid>
      <description>QOM ç®€ä»‹ QOM(QEMU Object Model) æ˜¯ QEMU çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºæè¿°è™šæ‹Ÿæœºçš„ç»“æ„ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œã€è¾“å…¥è¾“å‡ºè®¾å¤‡ç­‰ã€‚QEMU ä¸ºäº†æ–¹ä¾¿æ•´ä¸ªç³»ç»Ÿçš„æ„å»ºï¼Œå®ç°</description>
      <content:encoded><![CDATA[<h2 id="qom-ç®€ä»‹">QOM ç®€ä»‹</h2>
<p>QOM(QEMU Object Model) æ˜¯ QEMU çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºæè¿°è™šæ‹Ÿæœºçš„ç»“æ„ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œã€è¾“å…¥è¾“å‡ºè®¾å¤‡ç­‰ã€‚QEMU ä¸ºäº†æ–¹ä¾¿æ•´ä¸ªç³»ç»Ÿçš„æ„å»ºï¼Œå®ç°äº†è‡ªå·±çš„ä¸€å¥—çš„é¢å‘å¯¹è±¡æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ QOM(QEMU Object Model)ã€‚å®ƒèƒ½å¤Ÿæ–¹ä¾¿çš„è¡¨ç¤ºå„ä¸ªè®¾å¤‡ï¼ˆDeviceï¼‰ä¸æ€»çº¿ï¼ˆBusï¼‰ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>è¿™ä¸ªæ¨¡å‹ä¸»è¦åŒ…å«å››ä¸ªç»“æ„ä½“ï¼š</p>
<ul>
<li>Object: æ˜¯æ‰€æœ‰å¯¹è±¡çš„ åŸºç±» Base Object</li>
<li>ObjectClass: æ˜¯æ‰€æœ‰ç±»å¯¹è±¡çš„åŸºç±»</li>
<li>TypeInfoï¼šæ˜¯ç”¨æˆ·ç”¨æ¥å®šä¹‰ä¸€ä¸ªÂ TypeÂ çš„å·¥å…·å‹çš„æ•°æ®ç»“æ„</li>
<li>TypeImplï¼šTypeInfo æŠ½è±¡æ•°æ®ç»“æ„ï¼ŒTypeInfo çš„å±æ€§ä¸ TypeImpl çš„å±æ€§å¯¹åº”</li>
</ul>
<p>åœ¨ QEMU é‡Œè¦åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡éœ€è¦å®Œæˆå››æ­¥ï¼š</p>
<ul>
<li>å°† TypeInfo æ³¨å†Œ TypeImpl</li>
<li>å®ä¾‹åŒ– Classï¼ˆObjectClassï¼‰</li>
<li>å®ä¾‹åŒ– Object</li>
<li>æ·»åŠ  Property</li>
</ul>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/15-09-19-4995177f1aeb782fadaf586f8f5c8b32-qemu-QOM%E5%88%86%E6%9E%90.drawio%20-2--1a4eac.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/15-09-19-4995177f1aeb782fadaf586f8f5c8b32-qemu-QOM%E5%88%86%E6%9E%90.drawio%20-2--1a4eac.png" alt=""  />
</a>
</div>

</p>
<h2 id="qom-ä¸­çš„é¢å‘å¯¹è±¡">QOM ä¸­çš„é¢å‘å¯¹è±¡</h2>
<h3 id="ç»§æ‰¿">ç»§æ‰¿</h3>
<p>åœ¨ QEMU ä¸­é€šè¿‡ <strong>TypeInfo</strong> æ¥å®šä¹‰ä¸€ä¸ªç±»ã€‚</p>
<p>ä¾‹å¦‚ <code>x86_base_cpu_type_info</code> å°±æ˜¯ä¸€ä¸ª <code>class</code>ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">x86_base_cpu_type_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nf">X86_CPU_TYPE_NAME</span><span class="p">(</span><span class="s">&#34;base&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_X86_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">x86_cpu_base_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p><strong>åˆ©ç”¨ç»“æ„ä½“åŒ…å«æ¥å®ç°ç»§æ‰¿</strong>ã€‚è¿™åº”è¯¥æ˜¯æ‰€æœ‰çš„è¯­è¨€å®ç°ç»§æ‰¿çš„æ–¹æ³•ï¼Œåœ¨ C++ ä¸­ï¼Œç»“æ„ä½“åŒ…å«çš„æ“ä½œè¢«è¯­è¨€å†…éƒ¨å®ç°äº†ï¼Œè€Œ C è¯­è¨€éœ€è¦è‡ªå·±å®ç°ã€‚</p>
<p>ä¾‹å¦‚ <code>x86_cpu_type_info</code> çš„ <code>parent</code> æ˜¯ <code>cpu_type_info</code>, ä»–ä»¬çš„ç»“æ„ä½“åˆ†åˆ«æ˜¯ <code>X86CPU</code> å’Œ <code>CPUState</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">x86_cpu_type_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_X86_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">X86CPU</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">cpu_type_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CPUState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>åœ¨ <code>X86CPU</code> ä¸­åŒ…å«ä¸€ä¸ª <code>CPUState</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">X86CPU</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*&lt; private &gt;*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">CPUState</span> <span class="n">parent_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*&lt; public &gt;*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CPUNegativeOffsetState</span> <span class="n">neg</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="é™æ€æˆå‘˜">é™æ€æˆå‘˜</h3>
<p>é™æ€æˆå‘˜å˜é‡å¯ä»¥åœ¨ç±»çš„å¤šä¸ªå¯¹è±¡ä¸­è®¿é—®ï¼Œä½†æ˜¯è¦åœ¨ç±»å¤–å£°æ˜ã€‚<strong>ä¸åŒå¯¹è±¡è®¿é—®çš„å…¶å®æ˜¯åŒä¸€ä¸ªå®ä½“ï¼Œé™æ€æˆå‘˜å˜é‡è¢«å¤šä¸ªå¯¹è±¡å…±äº«</strong>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">x86_cpu_type_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_X86_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_CPU</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">X86CPU</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">x86_cpu_initfn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_post_init</span> <span class="o">=</span> <span class="n">x86_cpu_post_initfn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">class_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">X86CPUClass</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">x86_cpu_common_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>å…¶ä¸­ <code>X86CPU</code> æè¿°çš„æ˜¯éé™æ€æˆå‘˜ï¼Œè€Œ <code>X86CPUClass</code> æè¿°çš„æ˜¯é™æ€çš„æˆå‘˜ã€‚ä¹Ÿå°±æ˜¯è¯´<code>class_init</code>åˆå§‹åŒ–é™æ€æˆå‘˜ï¼Œ<code>instance_init</code>åˆå§‹åŒ–éé™æ€æˆå‘˜ã€‚</p>
<p>é‚£ä¹ˆä½•æ—¶åˆå§‹åŒ–é™æ€æˆå‘˜å‘¢ï¼Ÿé¦–å…ˆå¾—å‘Šè¯‰ç³»ç»Ÿï¼Œå’±æœ‰<code>class_init</code>è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œç­‰éœ€è¦çš„æ—¶å€™éšæ—¶å¯ä»¥è°ƒç”¨å®ƒåˆå§‹åŒ–ï¼Œæ‰€æœ‰å…ˆè§£å†³å¦‚ä½•å°†è¿™ä¸ªåˆå§‹åŒ–å‡½æ•°æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Ÿ</p>
<p>åœ¨<code>target/i386/cpu.c</code>æœ€åä½¿ç”¨äº†<code>type_init</code>ã€‚åœ¨<code>qemu/include/qemu/module.h</code>ä¸­æœ‰ä¸€ä¸ª<code>type_init</code>å®å®šä¹‰ï¼Œé™¤äº†<code>type_init</code>è¿˜æœ‰å…¶ä»–å®ï¼Œæ¯”å¦‚<code>block_init</code>ï¼Œ<code>opts_init</code>ç­‰ã€‚æ¯ä¸ªå®éƒ½è¡¨ç¤ºä¸€ç±»<code>module</code>ï¼Œé€šè¿‡<code>module_init</code>æ„é€ å‡ºæ¥ã€‚æˆ‘ä»¬å±•å¼€è¿™ä¸ªå®ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nf">do_qemu_init_x86_cpu_register_types</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">register_module_init</span><span class="p">(</span><span class="n">x86_cpu_register_types</span><span class="p">,</span> <span class="n">MODULE_INIT_QOM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é€šè¿‡ <code>gcc</code> æ‰©å±•å±æ€§<code>__attribute__((constructor))</code>å¯ä»¥è®© <code>do_qemu_init_x86_cpu_register_types</code> åœ¨è¿è¡Œ <code>main</code> å‡½æ•°ä¹‹å‰è¿è¡Œã€‚ <code>register_module_init</code> ä¼šè®© <code>x86_cpu_register_types</code> è¿™ä¸ªå‡½æ•°æŒ‚è½½åˆ° <code>init_type_list[MODULE_INIT_QOM]</code> è¿™ä¸ªé“¾è¡¨ä¸Šã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210907133931.svg">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210907133931.svg" alt=""  />
</a>
</div>

</p>
<p>åˆ°åº•ï¼Œæ‰€æœ‰çš„ <code>TypeInfo</code> é€šè¿‡ <code>type_init</code> éƒ½è¢«æ”¾åˆ° <code>type_table</code> ä¸Šäº†ï¼Œä¹‹åé€šè¿‡ <code>Typeinfo</code> çš„åç§°è°ƒç”¨ <code>type_table_lookup</code> è·å–åˆ° <code>TypeImpl</code> äº†ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œå°†<code>TYPE_X86_CPU</code>æ³¨å†Œè¿›ç±»ç³»ç»Ÿï¼ŒåŒ…æ‹¬å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå°±æ˜¯ QEMU ä¸­ç±»å‹çš„æ„é€ ã€‚é‚£ä¹ˆä½•æ—¶è°ƒç”¨é™æ€æˆå‘˜åˆå§‹åŒ–å‡½æ•°å‘¢ï¼Ÿä¹Ÿå°±æ˜¯ç±»å‹çš„åˆå§‹åŒ–ã€‚</p>
<p>é™æ€æˆå‘˜æ˜¯æ‰€æœ‰çš„å¯¹è±¡å…¬ç”¨çš„ï¼Œå…¶åˆå§‹åŒ–æ˜¾ç„¶è¦å‘ç”Ÿåœ¨æ‰€æœ‰çš„å¯¹è±¡åˆå§‹åŒ–ä¹‹å‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">main</span>
</span></span><span class="line"><span class="cl">    <span class="n">qemu_init</span> 
</span></span><span class="line"><span class="cl">        <span class="n">select_machine</span> 
</span></span><span class="line"><span class="cl">            <span class="n">object_class_get_list</span> 
</span></span><span class="line"><span class="cl">                <span class="n">object_class_foreach</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">g_hash_table_foreach</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">object_class_foreach_tramp</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">type_initialize</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">type_initialize</span> 
</span></span><span class="line"><span class="cl">                                    <span class="n">x86_cpu_common_class_init</span> 
</span></span></code></pre></div><p><code>select_machine</code> éœ€è¦è·å–æ‰€æœ‰çš„ <code>TYPE_MACHINE</code> çš„ <code>class</code>, å…¶é¦–å…ˆä¼šè°ƒç”¨æ‰€æœ‰çš„<code>class_list</code>ï¼Œå…¶ä¼šéå† <code>type_table</code>ï¼Œéå†çš„è¿‡ç¨‹ä¸­ä¼šé¡ºå¸¦ <code>type_initialize</code> æ‰€æœ‰çš„ <code>TypeImpl</code> è¿›è€Œè°ƒç”¨çš„ <code>class_init</code>ã€‚</p>
<p>è¯´å®Œç±»å‹çš„åˆå§‹åŒ–ï¼Œå†è®²ä¸€ä¸‹å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–éé™æ€æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯<code>instance_init</code>åœ¨ä½•æ—¶è¢«è°ƒç”¨ï¼Ÿ</p>
<p>å¯¹è±¡åˆå§‹åŒ–ï¼Œé€šè¿‡è°ƒç”¨ <code>object_new</code> æ¥å®ç°åˆå§‹åŒ–ã€‚</p>
<ul>
<li><code>object_initialize_with_type</code>
<ul>
<li>åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ :<code>Object::properties</code></li>
<li><code>object_init_with_type</code>
<ul>
<li>å¦‚æœ <code>object</code> æœ‰ <code>parent</code>ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>object_init_with_type</code> é¦–å…ˆåˆå§‹åŒ– <code>parent</code> çš„</li>
<li>è°ƒç”¨<code>TypeImpl::instance_init</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">main</span> 
</span></span><span class="line"><span class="cl">    <span class="n">qemu_init</span> 
</span></span><span class="line"><span class="cl">        <span class="n">qmp_x_exit_preconfig</span> 
</span></span><span class="line"><span class="cl">            <span class="n">qemu_init_board</span> 
</span></span><span class="line"><span class="cl">                <span class="n">machine_run_board_init</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">pc_init_v6_1</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">pc_init1</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">x86_cpus_init</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">x86_cpu_new</span> 
</span></span><span class="line"><span class="cl">                                    <span class="n">object_new</span> 
</span></span><span class="line"><span class="cl">                                        <span class="n">object_new_with_type</span> 
</span></span><span class="line"><span class="cl">                                            <span class="n">object_initialize_with_type</span> 
</span></span><span class="line"><span class="cl">                                                <span class="n">object_init_with_type</span> 
</span></span><span class="line"><span class="cl">                                                    <span class="n">x86_cpu_initfn</span> 
</span></span></code></pre></div><h3 id="å¤šæ€">å¤šæ€</h3>
<p>å¤šæ€æ˜¯æŒ‡åŒä¸€æ“ä½œä½œç”¨äºä¸åŒçš„å¯¹è±¡ï¼Œå¯ä»¥æœ‰ä¸åŒçš„è§£é‡Šï¼Œäº§ç”Ÿä¸åŒçš„æ‰§è¡Œç»“æœã€‚ä¸ºäº†å®ç°å¤šæ€ï¼ŒQOM å®ç°äº†ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯åŠ¨æ€ç±»å‹è½¬æ¢ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸å…³çš„å‡½æ•°ï¼Œå°†ä¸€ä¸ª<code>Object</code>çš„æŒ‡é’ˆåœ¨è¿è¡Œæ—¶è½¬æ¢ä¸ºå­ç±»å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¯ä»¥å°†ä¸€ä¸ª<code>ObjectClass</code>çš„æŒ‡é’ˆåœ¨è¿è¡Œæ—¶è½¬æ¢ä¸ºå­ç±»çš„æŒ‡é’ˆã€‚è¿™æ ·å°±å¯ä»¥è°ƒç”¨å­ç±»ä¸­å®šä¹‰çš„å‡½æ•°æŒ‡é’ˆæ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚</p>
<p>QEMU å®šä¹‰äº†ä¸€äº›åˆ—çš„å®å°æ¥è¿›è¡ŒåŠ¨æ€ç±»å‹è½¬æ¢ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">//include/qom/object.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * DECLARE_INSTANCE_CHECKER:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @InstanceType: instance struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @OBJ_NAME: the object name in uppercase with underscore separators
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @TYPENAME: type name
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct usage of this macro should be avoided, and the complete
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_DECLARE_TYPE macro is recommended instead.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This macro will provide the instance type cast functions for a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * QOM type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DECLARE_INSTANCE_CHECKER(InstanceType, OBJ_NAME, TYPENAME) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    static inline G_GNUC_UNUSED InstanceType * \
</span></span></span><span class="line"><span class="cl"><span class="cp">    OBJ_NAME(const void *obj) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    { return OBJECT_CHECK(InstanceType, obj, TYPENAME); }
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * DECLARE_CLASS_CHECKERS:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @ClassType: class struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @OBJ_NAME: the object name in uppercase with underscore separators
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @TYPENAME: type name
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct usage of this macro should be avoided, and the complete
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_DECLARE_TYPE macro is recommended instead.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This macro will provide the class type cast functions for a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * QOM type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DECLARE_CLASS_CHECKERS(ClassType, OBJ_NAME, TYPENAME) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    static inline G_GNUC_UNUSED ClassType * \
</span></span></span><span class="line"><span class="cl"><span class="cp">    OBJ_NAME##_GET_CLASS(const void *obj) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    { return OBJECT_GET_CLASS(ClassType, obj, TYPENAME); } \
</span></span></span><span class="line"><span class="cl"><span class="cp">    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    static inline G_GNUC_UNUSED ClassType * \
</span></span></span><span class="line"><span class="cl"><span class="cp">    OBJ_NAME##_CLASS(const void *klass) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    { return OBJECT_CLASS_CHECK(ClassType, klass, TYPENAME); }
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * DECLARE_OBJ_CHECKERS:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @InstanceType: instance struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @ClassType: class struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @OBJ_NAME: the object name in uppercase with underscore separators
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @TYPENAME: type name
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Direct usage of this macro should be avoided, and the complete
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_DECLARE_TYPE macro is recommended instead.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This macro will provide the three standard type cast functions for a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * QOM type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DECLARE_OBJ_CHECKERS(InstanceType, ClassType, OBJ_NAME, TYPENAME) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    DECLARE_INSTANCE_CHECKER(InstanceType, OBJ_NAME, TYPENAME) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    DECLARE_CLASS_CHECKERS(ClassType, OBJ_NAME, TYPENAME)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_DECLARE_TYPE:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @InstanceType: instance struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @ClassType: class struct name
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @MODULE_OBJ_NAME: the object name in uppercase with underscore separators
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This macro is typically used in a header file, and will:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   - create the typedefs for the object and class structs
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   - register the type for use with g_autoptr
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   - provide three standard type cast functions
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The object struct and class struct need to be declared manually.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT_DECLARE_TYPE(InstanceType, ClassType, MODULE_OBJ_NAME) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    typedef struct InstanceType InstanceType; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    typedef struct ClassType ClassType; \
</span></span></span><span class="line"><span class="cl"><span class="cp">    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    G_DEFINE_AUTOPTR_CLEANUP_FUNC(InstanceType, object_unref) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    \
</span></span></span><span class="line"><span class="cl"><span class="cp">    DECLARE_OBJ_CHECKERS(InstanceType, ClassType, \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         MODULE_OBJ_NAME, TYPE_##MODULE_OBJ_NAME)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @obj: A derivative of #Object
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Converts an object to a #Object.  Since all objects are #Objects,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this function will always succeed.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT(obj) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    ((Object *)(obj))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_CLASS:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @class: A derivative of #ObjectClass.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Converts a class to an #ObjectClass.  Since all objects are #Objects,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this function will always succeed.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT_CLASS(class) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    ((ObjectClass *)(class))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_CHECK:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @type: The C type to use for the return value.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @obj: A derivative of @type to cast.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @name: The QOM typename of @type
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A type safe version of @object_dynamic_cast_assert.  Typically each class
</span></span></span><span class="line"><span class="cl"><span class="cm"> * will define a macro based on this type to perform type safe dynamic_casts to
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this object type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * If an invalid object is passed to this function, a run time assert will be
</span></span></span><span class="line"><span class="cl"><span class="cm"> * generated.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT_CHECK(type, obj, name) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    ((type *)object_dynamic_cast_assert(OBJECT(obj), (name), \
</span></span></span><span class="line"><span class="cl"><span class="cp">                                        __FILE__, __LINE__, __func__))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_CLASS_CHECK:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @class_type: The C type to use for the return value.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @class: A derivative class of @class_type to cast.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @name: the QOM typename of @class_type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A type safe version of @object_class_dynamic_cast_assert.  This macro is
</span></span></span><span class="line"><span class="cl"><span class="cm"> * typically wrapped by each type to perform type safe casts of a class to a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * specific class type.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT_CLASS_CHECK(class_type, class, name) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    ((class_type *)object_class_dynamic_cast_assert(OBJECT_CLASS(class), (name), \
</span></span></span><span class="line"><span class="cl"><span class="cp">                                               __FILE__, __LINE__, __func__))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OBJECT_GET_CLASS:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @class: The C type to use for the return value.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @obj: The object to obtain the class for.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @name: The QOM typename of @obj.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This function will return a specific class for a given object.  Its generally
</span></span></span><span class="line"><span class="cl"><span class="cm"> * used by each type to provide a type safe macro to get a specific class type
</span></span></span><span class="line"><span class="cl"><span class="cm"> * from an object.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define OBJECT_GET_CLASS(class, obj, name) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    OBJECT_CLASS_CHECK(class, object_get_class(OBJECT(obj)), name)
</span></span></span></code></pre></div><p>ä»¥<code>OBJECT_DECLARE_TYPE(X86CPU, X86CPUClass, X86_CPU)</code>ä¸ºä¾‹ï¼Œå®å±•å¼€å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">X86CPU</span> <span class="n">X86CPU</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">X86CPUClass</span> <span class="n">X86CPUClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">G_DEFINE_AUTOPTR_CLEANUP_FUNC</span><span class="p">(</span><span class="n">X86CPU</span><span class="p">,</span> <span class="n">object_unref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">G_GNUC_UNUSED</span> <span class="n">X86CPU</span> <span class="o">*</span><span class="nf">X86_CPU</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">((</span><span class="n">X86CPU</span> <span class="o">*</span><span class="p">)</span><span class="nf">object_dynamic_cast_assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="n">Object</span> <span class="o">*</span><span class="p">)(</span><span class="n">obj</span><span class="p">)),</span> <span class="p">(</span><span class="n">TYPE_X86_CPU</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;~/core/vn/docs/qemu/res/qom-macros.c&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">G_GNUC_UNUSED</span> <span class="n">X86CPUClass</span> <span class="o">*</span><span class="nf">X86_CPU_GET_CLASS</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">((</span><span class="n">X86CPUClass</span> <span class="o">*</span><span class="p">)</span><span class="nf">object_class_dynamic_cast_assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="p">)(</span><span class="nf">object_get_class</span><span class="p">(((</span><span class="n">Object</span> <span class="o">*</span><span class="p">)(</span><span class="n">obj</span><span class="p">))))),</span> <span class="p">(</span><span class="n">TYPE_X86_CPU</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;~/core/vn/docs/qemu/res/qom-macros.c&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">G_GNUC_UNUSED</span> <span class="n">X86CPUClass</span> <span class="o">*</span><span class="nf">X86_CPU_CLASS</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">((</span><span class="n">X86CPUClass</span> <span class="o">*</span><span class="p">)</span><span class="nf">object_class_dynamic_cast_assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="p">)(</span><span class="n">klass</span><span class="p">)),</span> <span class="p">(</span><span class="n">TYPE_X86_CPU</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;~/core/vn/docs/qemu/res/qom-macros.c&#34;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>OBJECT_DECLARE_TYPE</code>é€šå¸¸åœ¨å¤´æ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œæ•ˆæœæ˜¯ï¼š</p>
<ul>
<li>åˆ›å»ºäº†<code>X86CPU</code>å’Œ<code>X86CPUClass</code>çš„<code>typedef</code></li>
<li>ç”¨<code>G_DEFINE_AUTOPTR_CLEANUP_FUNC</code>æ³¨å†Œç±»å‹</li>
<li>åˆ›å»ºäº†ä¸‰ä¸ªç±»å‹è½¬æ¢å‡½æ•°
<ul>
<li><code>X86_CPU</code> : å°†ä»»ä½•ä¸€ä¸ª <code>object</code> æŒ‡é’ˆ è½¬æ¢ä¸º <code>X86CPU</code>ï¼ˆObject è½¬å­å¯¹è±¡ï¼‰</li>
<li><code>X86_CPU_GET_CLASS</code> : æ ¹æ® <code>object</code> æŒ‡é’ˆè·å–åˆ° <code>X86CPUClass</code></li>
<li><code>X86_CPU_CLASS</code> : æ ¹æ® <code>ObjectClass</code> æŒ‡é’ˆè½¬æ¢åˆ° <code>X86CPUClass</code>ï¼ˆåŸºç±»è½¬å­ç±»ï¼‰</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œçš„è½¬æ¢ä¾èµ–å†…å­˜å¸ƒå±€ï¼Œå­ç±»å‹çš„ç¬¬ä¸€ä¸ªæˆå‘˜æ€»æ˜¯åŸºç±»å‹ã€‚å­ç±»è½¬åŸºç±»å°±å¾ˆå®¹æ˜“ï¼Œåªéœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢å°±å¯ä»¥å®ç°ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://martins3.github.io/qemu/qom.html#init">QEMU ä¸­çš„é¢å‘å¯¹è±¡ : QOM | Deep Dark Fantasy</a>
<a href="https://www.jianshu.com/p/4a9d26abb44d">æµ…è°ˆ QEMU çš„å¯¹è±¡ç³»ç»Ÿ - ç®€ä¹¦</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æºç åˆ†æ-å†…å­˜è™šæ‹ŸåŒ–</title>
      <link>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/</link>
      <pubDate>Tue, 25 Jan 2022 13:42:11 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/</guid>
      <description>1.å¤§éƒ¨åˆ†è½¬è½½è‡ªQEMU å†…å­˜è™šæ‹ŸåŒ–æºç åˆ†æ | Keep Coding | è‹æ˜“åŒ— 2.åŸæ–‡æºç ä¸º QEMU1.2.0ï¼Œç‰ˆæœ¬è¾ƒæ—§ï¼Œéƒ¨åˆ†æºç å†…å®¹æ ¹æ® QEMU6.2 ç‰ˆæœ¬ä¿®æ”¹ 3.éƒ¨åˆ†å†…å®¹æ ¹</description>
      <content:encoded><![CDATA[<blockquote>
<p>1.å¤§éƒ¨åˆ†è½¬è½½è‡ª<a href="https://abelsu7.top/2019/07/07/kvm-memory-virtualization/">QEMU å†…å­˜è™šæ‹ŸåŒ–æºç åˆ†æ | Keep Coding | è‹æ˜“åŒ—</a>
2.åŸæ–‡æºç ä¸º QEMU1.2.0ï¼Œç‰ˆæœ¬è¾ƒæ—§ï¼Œéƒ¨åˆ†æºç å†…å®¹æ ¹æ® QEMU6.2 ç‰ˆæœ¬ä¿®æ”¹
3.éƒ¨åˆ†å†…å®¹æ ¹æ®è‡ªå·±ç†è§£è¡¥å……æ·»åŠ </p>
</blockquote>
<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<p>æˆ‘ä»¬çŸ¥é“æ“ä½œç³»ç»Ÿç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡é¡µè¡¨æ˜ å°„ï¼Œå˜æˆç‰©ç†å†…å­˜è¿›è¡Œè®¿é—®ã€‚å½“æœ‰äº†è™šæ‹Ÿæœºä¹‹åï¼Œæƒ…å†µä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚å› ä¸ºè™šæ‹Ÿæœºå¯¹äºç‰©ç†æœºæ¥è®²æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯è™šæ‹Ÿæœºé‡Œé¢ä¹Ÿæœ‰å†…æ ¸ï¼Œä¹Ÿæœ‰è™šæ‹Ÿæœºé‡Œé¢è·‘çš„è¿›ç¨‹ã€‚æ‰€ä»¥æœ‰äº†è™šæ‹Ÿæœºï¼Œå†…å­˜å°±å˜æˆäº†å››ç±»ï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºé‡Œé¢çš„è™šæ‹Ÿå†…å­˜ï¼ˆGuest OS Virtual Memoryï¼ŒGVAï¼‰ï¼Œè¿™æ˜¯è™šæ‹Ÿæœºé‡Œé¢çš„è¿›ç¨‹çœ‹åˆ°çš„å†…å­˜ç©ºé—´ï¼›</li>
<li>è™šæ‹Ÿæœºé‡Œé¢çš„ç‰©ç†å†…å­˜ï¼ˆGuest OS Physical Memoryï¼ŒGPAï¼‰ï¼Œè¿™æ˜¯è™šæ‹Ÿæœºé‡Œé¢çš„æ“ä½œç³»ç»Ÿçœ‹åˆ°çš„å†…å­˜ï¼Œå®ƒè®¤ä¸ºè¿™æ˜¯ç‰©ç†å†…å­˜ï¼›</li>
<li>ç‰©ç†æœºçš„è™šæ‹Ÿå†…å­˜ï¼ˆHost Virtual Memoryï¼ŒHVAï¼‰ï¼Œè¿™æ˜¯ç‰©ç†æœºä¸Šçš„ qemu è¿›ç¨‹çœ‹åˆ°çš„å†…å­˜ç©ºé—´ï¼›</li>
<li>ç‰©ç†æœºçš„ç‰©ç†å†…å­˜ï¼ˆHost Physical Memoryï¼ŒHPAï¼‰ï¼Œè¿™æ˜¯ç‰©ç†æœºä¸Šçš„æ“ä½œç³»ç»Ÿçœ‹åˆ°çš„å†…å­˜ã€‚</li>
</ul>
<p>å†…å­˜è™šæ‹ŸåŒ–çš„å…³é”®åœ¨äºç»´æŠ¤ <code>GPA</code> åˆ° <code>HVA</code> çš„æ˜ å°„å…³ç³»ã€‚</p>
<h2 id="é¡µé¢åˆ†é…å’Œæ˜ å°„çš„ä¸¤ç§æ–¹å¼">é¡µé¢åˆ†é…å’Œæ˜ å°„çš„ä¸¤ç§æ–¹å¼</h2>
<p>è¦ææ¸…æ¥š QEMU system emulation çš„ä»¿çœŸæ¶æ„ï¼Œé¦–å…ˆå¯¹äº Host OSï¼Œå°† QEMU ä½œä¸ºè¿›ç¨‹å¯åŠ¨ï¼Œç„¶åå¯¹äº QEMU è¿›ç¨‹ï¼Œä¼šä»¿çœŸå„ç§ç¡¬ä»¶å’Œè¿è¡Œ Guest OSï¼Œåœ¨è¿™å±‚ OS ä¸Šè¿è¡Œè¦å…¨ç³»ç»Ÿæ¨¡æ‹Ÿçš„åº”ç”¨ç¨‹åºï¼Œå› æ­¤å¯¹äº Guest OS ç®¡ç†çš„å†…å­˜è¦å®ç°åˆ° QEMU è¿›ç¨‹çš„è™šæ‹Ÿç©ºé—´çš„è½¬æ¢éœ€è¦ softMMUï¼ˆå³éœ€è¦å¯¹ GPA åˆ° HVA è¿›è¡Œè½¬æ¢ï¼‰ã€‚ä» GVA åˆ° GPA åˆ° HVA åˆ° HPAï¼Œæ€§èƒ½å¾ˆå·®ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ç§ä¸»è¦çš„æ€è·¯ã€‚</p>
<h3 id="å½±å­é¡µè¡¨-shadow-page-tablespt">å½±å­é¡µè¡¨ Shadow Page Tableï¼ŒSPT</h3>
<p>ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯è½¯ä»¶çš„æ–¹å¼ï¼Œå½±å­é¡µè¡¨ï¼ˆShadow Page Tableï¼‰ã€‚</p>
<p>KVM é€šè¿‡ç»´æŠ¤è®°å½• GVA-&gt;HPA çš„å½±å­é¡µè¡¨ SPTï¼Œå‡å°‘äº†åœ°å€è½¬æ¢å¸¦æ¥çš„å¼€é”€ï¼Œå¯ä»¥ç›´æ¥å°† GVA è½¬æ¢ä¸º HPAã€‚</p>
<p>å†…å­˜æ˜ å°„è¦é€šè¿‡é¡µè¡¨æ¥ç®¡ç†ï¼Œé¡µè¡¨åœ°å€åº”è¯¥æ”¾åœ¨ CR3 å¯„å­˜å™¨é‡Œé¢ã€‚åœ¨è½¯ä»¶è™šæ‹ŸåŒ–çš„å†…å­˜è½¬æ¢ä¸­ï¼ŒGVA åˆ° GPA çš„è½¬æ¢é€šè¿‡æŸ¥è¯¢ CR3 å¯„å­˜å™¨æ¥å®Œæˆï¼ŒCR3 ä¸­ä¿å­˜äº† Guest çš„é¡µè¡¨åŸºåœ°å€ï¼Œç„¶åè½½å…¥ MMU ä¸­è¿›è¡Œåœ°å€è½¬æ¢ã€‚</p>
<p>åœ¨åŠ å…¥äº† SPT æŠ€æœ¯åï¼Œå½“ Guest è®¿é—® CR3 æ—¶ï¼ŒKVM ä¼šæ•è·åˆ°è¿™ä¸ªæ“ä½œ EXIT_REASON_CR_ACCESSï¼Œä¹‹å KVM ä¼šè½½å…¥ç‰¹æ®Šçš„ CR3 å’Œå½±å­é¡µè¡¨ï¼Œæ¬ºéª— Guest è¿™å°±æ˜¯çœŸå®çš„ CR3ã€‚ä¹‹åå°±å’Œä¼ ç»Ÿçš„è®¿é—®å†…å­˜æ–¹å¼ä¸€è‡´ï¼Œå½“éœ€è¦è®¿é—®ç‰©ç†å†…å­˜çš„æ—¶å€™ï¼Œåªä¼šç»è¿‡ä¸€å±‚å½±å­é¡µè¡¨çš„è½¬æ¢ã€‚</p>
<blockquote>
<p>æœ¬æ¥çš„è¿‡ç¨‹æ˜¯ï¼Œå®¢æˆ·æœºè¦é€šè¿‡ cr3 æ‰¾åˆ°å®¢æˆ·æœºçš„é¡µè¡¨ï¼Œå®ç°ä» GVA åˆ° GPA çš„è½¬æ¢ï¼Œç„¶ååœ¨å®¿ä¸»æœºä¸Šï¼Œè¦é€šè¿‡ cr3 æ‰¾åˆ°å®¿ä¸»æœºçš„é¡µè¡¨ï¼Œå®ç°ä» HVA åˆ° HPA çš„è½¬æ¢ã€‚
ä¸ºäº†å®ç°å®¢æˆ·æœºè™šæ‹Ÿåœ°å€ç©ºé—´åˆ°å®¿ä¸»æœºç‰©ç†åœ°å€ç©ºé—´çš„ç›´æ¥æ˜ å°„ã€‚å®¢æˆ·æœºä¸­æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ KVM éœ€è¦ä¸ºå®¢æˆ·æœºä¸­çš„æ¯ä¸ªè¿›ç¨‹é¡µè¡¨éƒ½è¦ç»´æŠ¤ä¸€å¥—ç›¸åº”çš„å½±å­é¡µè¡¨ã€‚
åœ¨å®¢æˆ·æœºè®¿é—®å†…å­˜æ—¶ï¼Œä½¿ç”¨çš„ä¸æ˜¯å®¢æˆ·æœºçš„åŸæ¥çš„é¡µè¡¨ï¼Œè€Œæ˜¯è¿™ä¸ªé¡µè¡¨å¯¹åº”çš„å½±å­é¡µè¡¨ï¼Œä»è€Œå®ç°äº†ä»å®¢æˆ·æœºè™šæ‹Ÿåœ°å€åˆ°å®¿ä¸»æœºç‰©ç†åœ°å€çš„ç›´æ¥è½¬æ¢ã€‚è€Œä¸”ï¼Œåœ¨ TLB å’Œ CPU ç¼“å­˜ä¸Šç¼“å­˜çš„æ˜¯æ¥è‡ªå½±å­é¡µè¡¨ä¸­å®¢æˆ·æœºè™šæ‹Ÿåœ°å€å’Œå®¿ä¸»æœºç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„ï¼Œä¹Ÿå› æ­¤æé«˜äº†ç¼“å­˜çš„æ•ˆç‡ã€‚</p>
</blockquote>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220124192700.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220124192700.png" alt=""  />
</a>
</div>

</p>
<p>ä¸ºäº†å¿«é€Ÿæ£€ç´¢ Guest é¡µè¡¨å¯¹åº”çš„å½±å­é¡µè¡¨ï¼ŒKVM ä¸ºæ¯ä¸ªå®¢æˆ·æœºç»´æŠ¤äº†ä¸€ä¸ª hash è¡¨æ¥è¿›è¡Œå®¢æˆ·æœºé¡µè¡¨åˆ°å½±å­é¡µè¡¨ä¹‹é—´çš„æ˜ å°„ã€‚å¯¹äºæ¯ä¸€ä¸ª Guest æ¥è¯´ï¼Œå…¶é¡µç›®å½•å’Œé¡µè¡¨éƒ½æœ‰å”¯ä¸€çš„ GPAï¼Œé€šè¿‡é¡µç›®å½•/é¡µè¡¨çš„ GPA å°±å¯ä»¥åœ¨å“ˆå¸Œé“¾è¡¨ä¸­å¿«é€Ÿåœ°æ‰¾åˆ°å¯¹åº”çš„å½±å­é¡µç›®å½•/é¡µè¡¨ã€‚</p>
<p>å½“ Guest åˆ‡æ¢è¿›ç¨‹æ—¶ï¼ŒGuest ä¼šæŠŠå¾…åˆ‡æ¢è¿›ç¨‹çš„é¡µè¡¨åŸºå€è½½å…¥ CR3ï¼Œè€Œ KVM å°†ä¼šæˆªè·è¿™ä¸€ç‰¹æƒæŒ‡ä»¤ã€‚KVM åœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ°ä¸æ­¤é¡µè¡¨åŸºå€å¯¹åº”çš„å½±å­é¡µè¡¨åŸºå€ï¼Œè½½å…¥ Guest CR3ï¼Œä½¿ Guest åœ¨æ¢å¤è¿è¡Œæ—¶ CR3 å®é™…æŒ‡å‘çš„æ˜¯æ–°åˆ‡æ¢è¿›ç¨‹å¯¹åº”çš„å½±å­é¡µè¡¨ã€‚</p>
<p>å½±å­é¡µè¡¨çš„å¼•å…¥ï¼Œå‡å°‘äº† GVA-&gt;HPA çš„è½¬æ¢å¼€é”€ï¼Œä½†æ˜¯ç¼ºç‚¹åœ¨äºéœ€è¦ä¸º Guest çš„æ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ªå½±å­é¡µè¡¨ï¼Œè¿™å°†å¸¦æ¥å¾ˆå¤§çš„å†…å­˜å¼€é”€ã€‚åŒæ—¶å½±å­é¡µè¡¨çš„å»ºç«‹æ˜¯å¾ˆè€—æ—¶çš„ï¼Œå¦‚æœ Guest çš„è¿›ç¨‹è¿‡å¤šï¼Œå°†å¯¼è‡´å½±å­é¡µè¡¨é¢‘ç¹åˆ‡æ¢ã€‚</p>
<p>å› æ­¤ Intel å’Œ AMD åœ¨æ­¤åŸºç¡€ä¸Šæä¾›äº†åŸºäºç¡¬ä»¶çš„è™šæ‹ŸåŒ–æŠ€æœ¯ EPTã€‚</p>
<h3 id="æ‰©å±•é¡µè¡¨-extent-page-tableept">æ‰©å±•é¡µè¡¨ Extent Page Tableï¼ŒEPT</h3>
<p>Intel çš„ EPTï¼ˆExtent Page Tableï¼‰æŠ€æœ¯å’Œ AMD çš„ NPTï¼ˆNest Page Tableï¼‰æŠ€æœ¯éƒ½å¯¹å†…å­˜è™šæ‹ŸåŒ–æä¾›äº†ç¡¬ä»¶æ”¯æŒã€‚è¿™ä¸¤ç§æŠ€æœ¯åŸç†ç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨ç¡¬ä»¶å±‚é¢ä¸Šå®ç° GVA åˆ° HPA ä¹‹é—´çš„è½¬æ¢ã€‚ä¸‹é¢å°±ä»¥ EPT ä¸ºä¾‹åˆ†æä¸€ä¸‹ KVM åŸºäºç¡¬ä»¶è¾…åŠ©çš„å†…å­˜è™šæ‹ŸåŒ–å®ç°ã€‚</p>
<p>EPT åœ¨åŸæœ‰å®¢æˆ·æœºé¡µè¡¨å¯¹å®¢æˆ·æœºè™šæ‹Ÿåœ°å€ GVA åˆ°å®¢æˆ·æœºç‰©ç†åœ°å€ GPA æ˜ å°„çš„åŸºç¡€ä¸Šï¼Œåˆå¼•å…¥äº† EPT é¡µè¡¨æ¥å®ç°å®¢æˆ·æœºç‰©ç†åœ°å€ GPA åˆ°å®¿ä¸»æœºç‰©ç†åœ°å€ HPA çš„å¦ä¸€æ¬¡æ˜ å°„ã€‚å®¢æˆ·æœºè¿è¡Œæ—¶ï¼Œå®¢æˆ·æœºé¡µè¡¨è¢«è½½å…¥ CR3ï¼Œè€Œ EPT é¡µè¡¨è¢«è½½å…¥ä¸“é—¨çš„ EPT é¡µè¡¨æŒ‡é’ˆå¯„å­˜å™¨ EPTPã€‚</p>
<p>å³ EPT æŠ€æœ¯é‡‡ç”¨äº†åœ¨ä¸¤çº§é¡µè¡¨ç»“æ„ï¼Œå³åŸæœ‰ Guest OS é¡µè¡¨å¯¹ <strong>GVA-&gt;GPA</strong> æ˜ å°„çš„åŸºç¡€ä¸Šï¼Œåˆå¼•å…¥äº† EPT é¡µè¡¨æ¥å®ç° <strong>GPA-&gt;HPA</strong> çš„å¦ä¸€æ¬¡æ˜ å°„ï¼Œè¿™<strong>ä¸¤æ¬¡åœ°å€æ˜ å°„éƒ½æ˜¯ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆ</strong>ã€‚</p>
<p>æœ‰äº† EPTï¼Œåœ¨<strong>GPA-&gt;HPA</strong>è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œç¼ºé¡µä¼šäº§ç”Ÿ EPT ç¼ºé¡µå¼‚å¸¸ã€‚KVM é¦–å…ˆæ ¹æ®å¼•èµ·å¼‚å¸¸çš„å®¢æˆ·æœºç‰©ç†åœ°å€ï¼Œæ˜ å°„åˆ°å¯¹åº”çš„å®¿ä¸»æœºè™šæ‹Ÿåœ°å€ï¼Œç„¶åä¸ºæ­¤è™šæ‹Ÿåœ°å€åˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œæœ€å KVM å†æ›´æ–° EPT é¡µè¡¨ï¼Œå»ºç«‹èµ·å¼•èµ·å¼‚å¸¸çš„å®¢æˆ·æœºç‰©ç†åœ°å€åˆ°å®¿ä¸»æœºç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚</p>
<p>KVM åªéœ€ä¸ºæ¯ä¸ªå®¢æˆ·æœºç»´æŠ¤ä¸€å¥— EPT é¡µè¡¨ï¼Œä¹Ÿå¤§å¤§å‡å°‘äº†å†…å­˜çš„å¼€é”€ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ç¬¬äºŒç§æ–¹å¼ã€‚å› ä¸ºä½¿ç”¨äº† EPT ä¹‹åï¼Œå®¢æˆ·æœºé‡Œé¢çš„é¡µè¡¨æ˜ å°„ï¼Œä¹Ÿå³ä» GVA åˆ° GPA çš„è½¬æ¢ï¼Œè¿˜æ˜¯ç”¨ä¼ ç»Ÿçš„æ–¹å¼ï¼Œå’Œåœ¨å†…å­˜ç®¡ç†é‚£ä¸€ç« è®²çš„æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è€Œ EPT é‡ç‚¹å¸®æˆ‘ä»¬è§£å†³çš„å°±æ˜¯ä» GPA åˆ° HPA çš„è½¬æ¢é—®é¢˜ã€‚å› ä¸ºè¦ç»è¿‡ä¸¤æ¬¡é¡µè¡¨ï¼Œæ‰€ä»¥ EPT åˆ tdp(two dimentional paging)ã€‚</p>
<p>EPT çš„é¡µè¡¨ç»“æ„ä¹Ÿæ˜¯åˆ†ä¸ºå››å±‚ï¼ŒEPT Pointerï¼ˆEPTPï¼‰æŒ‡å‘ PML4 çš„é¦–åœ°å€ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220124194059.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220124194059.png" alt=""  />
</a>
</div>

</p>
<h2 id="qemu-çš„ä¸»è¦å·¥ä½œ">QEMU çš„ä¸»è¦å·¥ä½œ</h2>
<p>å†…å­˜è™šæ‹ŸåŒ–çš„ç›®çš„å°±æ˜¯è®©è™šæ‹Ÿæœºèƒ½å¤Ÿæ— ç¼çš„è®¿é—®å†…å­˜ã€‚æœ‰äº† Intel EPT çš„æ”¯æŒåï¼ŒCPU åœ¨ VMX non-root çŠ¶æ€æ—¶è¿›è¡Œå†…å­˜è®¿é—®ä¼šå†åšä¸€æ¬¡ EPT è½¬æ¢ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒQEMU ä¼šè´Ÿè´£ä»¥ä¸‹å†…å®¹ï¼š</p>
<p>é¦–å…ˆéœ€è¦ä»è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ç”³è¯·å†…å­˜ç”¨äº Guest
éœ€è¦å°†ä¸Šä¸€æ­¥ä¸­ç”³è¯·åˆ°çš„å†…å­˜çš„è™šæ‹Ÿåœ°å€ï¼ˆHVAï¼‰å’Œ Guest çš„ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ä¼ é€’ç»™ KVMï¼ˆkernelï¼‰ï¼Œå³ GPA-&gt;HVA
éœ€è¦ç»„ç»‡ä¸€ç³»åˆ—çš„æ•°æ®ç»“æ„æ¥ç®¡ç†è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œå¹¶åœ¨å†…å­˜æ‹“æ‰‘ç»“æ„æ›´æ”¹æ—¶å°†æœ€æ–°çš„å†…å­˜ä¿¡æ¯åŒæ­¥è‡³ KVM ä¸­</p>
<h2 id="qemu-å’Œ-kvm-çš„å·¥ä½œåˆ†ç•Œ">QEMU å’Œ KVM çš„å·¥ä½œåˆ†ç•Œ</h2>
<p>QEMU å’Œ KVM ä¹‹é—´æ˜¯é€šè¿‡ KVM æä¾›çš„ ioctl() æ¥å£è¿›è¡Œäº¤äº’çš„ã€‚åœ¨å†…æ ¸çš„ kvm_vm_ioctl() ä¸­ï¼Œ<strong>è®¾ç½®è™šæ‹Ÿæœºå†…å­˜</strong>çš„ç³»ç»Ÿè°ƒç”¨ã€kernel å°±æ˜¯ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ¥å£å’Œå¤„ç†é€»è¾‘ï¼Œå…¶ä¸­æœ‰ä¸ªå¤„ç†â€åˆ›å»º/è®¾ç½®è™šæ‹Ÿæœºå†…å­˜â€œçš„ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‘ä¸º  <code>VM_SET_USER_MEMORY_REGION</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">kvm_vm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">KVM_SET_USER_MEMORY_REGION</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// åœ¨ KVM ä¸­æ³¨å†Œç”¨æˆ·ç©ºé—´ä¼ å…¥çš„å†…å­˜ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="n">kvm_userspace_mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// å°†ä¼ å…¥çš„æ•°æ®ç»“æ„å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_userspace_mem</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">kvm_userspace_mem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// å®é™…è¿›è¡Œå¤„ç†çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span> <span class="o">=</span> <span class="nf">kvm_vm_ioctl_set_memory_region</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kvm_userspace_mem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œéœ€è¦ä¼ é€’çš„å‚æ•°ç±»å‹ä¸º <code>kvm_userspace_memory_region</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* for KVM_SET_USER_MEMORY_REGION */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u32</span> <span class="n">slot</span><span class="p">;</span>            <span class="c1">// slot ç¼–å· [å‚è€ƒï¼šhttps://www.cnblogs.com/LoyenWang/p/11922887.html]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>           <span class="c1">// æ ‡å¿—ä½ï¼Œä¾‹å¦‚æ˜¯å¦è¿½è¸ªè„é¡µã€æ˜¯å¦å¯ç”¨ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">guest_phys_addr</span><span class="p">;</span> <span class="c1">// Guest ç‰©ç†åœ°å€ï¼Œå³ GPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">memory_size</span><span class="p">;</span>     <span class="c1">// å†…å­˜å¤§å°ï¼Œå•ä½ bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">userspace_addr</span><span class="p">;</span>  <span class="c1">// ä» QEMU è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ†é…å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå³ HVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><p><code>KVM_SET_USER_MEMORY_REGION</code>è¿™ä¸ª <code>ioctl</code> ä¸»è¦ç›®çš„å°±æ˜¯è®¾ç½®<code>GPA-&gt;HVA</code>çš„æ˜ å°„å…³ç³»ï¼ŒKVM ä¼šç»§ç»­è°ƒç”¨<code>kvm_vm_ioctl_set_memory_region()</code>ï¼Œåœ¨å†…æ ¸ç©ºé—´ç»´æŠ¤å¹¶ç®¡ç† Guest çš„å†…å­˜ã€‚</p>
<h2 id="ç›¸å…³æ•°æ®ç»“æ„">ç›¸å…³æ•°æ®ç»“æ„</h2>
<h3 id="addressspace">AddressSpace</h3>
<h4 id="ç»“æ„ä½“å®šä¹‰">ç»“æ„ä½“å®šä¹‰</h4>
<p>QEMU ç”¨ AddressSpace ç»“æ„ä½“è¡¨ç¤º Guest ä¸­ CPU/è®¾å¤‡çœ‹åˆ°çš„å†…å­˜ã€ä¹Ÿå°±æ˜¯Guest OS å¯ä»¥åœ¨ QEMU è¿›ç¨‹è™šå­˜ä¸­ç”¨åˆ°çš„æ‰€æœ‰å†…å­˜ï¼Œæ˜¯ MemoryRegion çš„é›†åˆï¼Œå³ GPA çš„æ•´ä½“ã€‘ï¼Œç±»ä¼¼äºç‰©ç†æœºä¸­åœ°å€ç©ºé—´çš„æ¦‚å¿µï¼Œä½†åœ¨è¿™é‡Œè¡¨ç¤ºçš„æ˜¯ Guest çš„ä¸€æ®µåœ°å€ç©ºé—´ï¼Œå¦‚å†…å­˜åœ°å€ç©ºé—´ <code>address_space_memory</code> ã€<code>I/O</code> åœ°å€ç©ºé—´<code>address_space_io</code>ï¼Œå®ƒåœ¨ QEMU æºç <code>memory.c</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * struct AddressSpace: describes a mapping of addresses to #MemoryRegion objects
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">AddressSpace</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* private: */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Accessed via RCU.  */</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">FlatView</span> <span class="o">*</span><span class="n">current_map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ioeventfd_nb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">MemoryRegionIoeventfd</span> <span class="o">*</span><span class="n">ioeventfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_HEAD</span><span class="p">(,</span> <span class="n">MemoryListener</span><span class="p">)</span> <span class="n">listeners</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">AddressSpace</span><span class="p">)</span> <span class="n">address_spaces_link</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>æ¯ä¸ª AddressSpace ä¸€èˆ¬åŒ…å«ä¸€ç³»åˆ—çš„ MemoryRegionï¼š<code>root</code>æŒ‡é’ˆæŒ‡å‘æ ¹çº§ MemoryRegionï¼Œè€Œ root å¯èƒ½æœ‰è‡ªå·±çš„è‹¥å¹²ä¸ª sub-regionsï¼ˆå­èŠ‚ç‚¹ï¼‰ï¼Œäºæ˜¯å½¢æˆæ ‘çŠ¶ç»“æ„ã€‚è¿™äº› MemoryRegion é€šè¿‡æ ‘è¿æ¥èµ·æ¥ï¼Œæ ‘çš„æ ¹å³ä¸º AddressSpace çš„ root åŸŸã€‚</p>
<h4 id="å…¨å±€å˜é‡">å…¨å±€å˜é‡</h4>
<p>å¦å¤–ï¼ŒQEMU ä¸­æœ‰ä¸¤ä¸ªå…¨å±€çš„é™æ€ AddressSpaceï¼Œåœ¨ memory.c ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">AddressSpace</span> <span class="n">address_space_memory</span><span class="p">;</span> <span class="c1">// å†…å­˜åœ°å€ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">AddressSpace</span> <span class="n">address_space_io</span><span class="p">;</span>     <span class="c1">// I/O åœ°å€ç©ºé—´
</span></span></span></code></pre></div><p>å…¶ root åŸŸåˆ†åˆ«æŒ‡å‘ä¹‹åä¼šæåˆ°çš„ä¸¤ä¸ª MemoryRegion ç±»å‹å˜é‡ï¼šsystem_memoryã€system_ioã€‚</p>
<h3 id="memoryregion">MemoryRegion</h3>
<h4 id="ç»“æ„ä½“å®šä¹‰-1">ç»“æ„ä½“å®šä¹‰</h4>
<p><code>MemoryRegion</code> è¡¨ç¤ºåœ¨ <code>Guest Memory Layout</code> ä¸­çš„ä¸€æ®µå†…å­˜åŒºåŸŸã€ä¹Ÿå°±æ˜¯å•å…ƒçº§ GPA çš„æ¦‚å¿µï¼ŒGuest OS å¯ä»¥ç®¡ç†åˆ°çš„é‚£äº› Guest ç‰©ç†å†…å­˜å•å…ƒã€‘ï¼Œå®ƒæ˜¯è”ç³» <code>GPA</code> å’Œ <code>RAMBlocks</code>ï¼ˆæè¿°çœŸå®å†…å­˜ï¼‰ä¹‹é—´çš„æ¡¥æ¢ï¼Œåœ¨<code>memory.h</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* All fields are private - violators will be prosecuted */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>      <span class="c1">// å›è°ƒå‡½æ•°é›†åˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>            <span class="c1">// çˆ¶ MemoryRegion æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Int128</span> <span class="n">size</span><span class="p">;</span>                     <span class="c1">// è¯¥åŒºåŸŸå†…å­˜çš„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">target_phys_addr_t</span> <span class="n">addr</span><span class="p">;</span>         <span class="c1">// åœ¨ Address Space ä¸­çš„åœ°å€ï¼Œå³ HVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destructor</span><span class="p">)(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">ram_addr</span><span class="p">;</span>             <span class="c1">// MemoryRegion çš„èµ·å§‹åœ°å€ï¼Œå³ GPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">subpage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">terminates</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">readable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">ram</span><span class="p">;</span>                        <span class="c1">// æ˜¯å¦è¡¨ç¤º RAM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">readonly</span><span class="p">;</span> <span class="cm">/* For RAM regions */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">enabled</span><span class="p">;</span>                    <span class="c1">// æ˜¯å¦å·²ç»é€šçŸ¥ KVM ä½¿ç”¨è¿™æ®µå†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">rom_device</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">warning_printed</span><span class="p">;</span> <span class="cm">/* For reservations */</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>             <span class="c1">// æ˜¯å¦ä¸º MemoryRegion alias
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">target_phys_addr_t</span> <span class="n">alias_offset</span><span class="p">;</span> <span class="c1">// è‹¥ä¸º aliasï¼Œåœ¨åŸ MemoryRegion ä¸­çš„ offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">priority</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">may_overlap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_HEAD</span><span class="p">(</span><span class="n">subregions</span><span class="p">,</span> <span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions</span><span class="p">;</span> <span class="c1">// å­åŒºåŸŸé“¾è¡¨å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions_link</span><span class="p">;</span>       <span class="c1">// å­åŒºåŸŸé“¾è¡¨èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">QTAILQ_HEAD</span><span class="p">(</span><span class="n">coalesced_ranges</span><span class="p">,</span> <span class="n">CoalescedMemoryRange</span><span class="p">)</span> <span class="n">coalesced</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>       <span class="c1">// MemoryRegion çš„åå­—ï¼Œè°ƒè¯•æ—¶ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">dirty_log_mask</span><span class="p">;</span> <span class="c1">// è¡¨ç¤ºå“ªä¸€ç§ dirty map è¢«ä½¿ç”¨ï¼Œå…±åˆ†ä¸‰ç§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">ioeventfd_nb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegionIoeventfd</span> <span class="o">*</span><span class="n">ioeventfds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h4 id="å…¨å±€å˜é‡-1">å…¨å±€å˜é‡</h4>
<p>åœ¨ QEMU çš„ exec.c ä¸­ä¹Ÿå®šä¹‰äº†ä¸¤ä¸ªé™æ€çš„ MemoryRegion æŒ‡é’ˆå˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">;</span> <span class="c1">// å†…å­˜ MemoryRegionï¼Œå¯¹åº” address_space_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_io</span><span class="p">;</span>     <span class="c1">// I/O MemoryRegionï¼Œå¯¹åº” address_space_io
</span></span></span></code></pre></div><p>ä¸ä¸¤ä¸ªå…¨å±€ AddressSpace å¯¹åº”ï¼Œå³ AddressSpace çš„ root åŸŸæŒ‡å‘è¿™ä¸¤ä¸ª MemoryRegionã€‚</p>
<h4 id="memoryregion-çš„ç±»å‹">MemoryRegion çš„ç±»å‹</h4>
<p>MemoryRegion æœ‰å¤šç§ç±»å‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸€æ®µ RAMã€ROMã€MMIOã€alias(åˆ«å)ã€‚</p>
<p>è‹¥ä¸º alias åˆ™è¡¨ç¤ºä¸€ä¸ª MemoryRegion çš„éƒ¨åˆ†åŒºåŸŸï¼Œä¾‹å¦‚ï¼ŒQEMU ä¼šä¸º pc.ram è¿™ä¸ªè¡¨ç¤º RAM çš„ MemoryRegion æ·»åŠ ä¸¤ä¸ª aliasï¼šram-below-4g å’Œ ram-above-4gï¼Œä¹‹åä¼šçœ‹åˆ°å…·ä½“çš„ä»£ç å®ä¾‹ã€‚</p>
<p>å¦å¤–ï¼ŒMemoryRegion ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸€ä¸ª containerï¼Œè¿™å°±è¡¨ç¤ºå®ƒåªæ˜¯å…¶ä»–è‹¥å¹²ä¸ª MemoryRegion çš„å®¹å™¨ã€‚</p>
<p>é‚£ä¹ˆè¦å¦‚ä½•åˆ›å»ºä¸åŒç±»å‹çš„ <code>MemoryRegion</code> å‘¢ï¼Ÿ</p>
<p>åœ¨ QEMU ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡è°ƒç”¨ä¸åŒçš„åˆå§‹åŒ–å‡½æ•°åŒºåˆ†çš„ã€‚æ ¹æ®ä¸åŒçš„åˆå§‹åŒ–å‡½æ•°åŠå…¶åŠŸèƒ½ï¼Œå¯ä»¥å°† MemoryRegion åˆ’åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>æ ¹çº§ MemoryRegionï¼šç›´æ¥é€šè¿‡ memory_region_init åˆå§‹åŒ–ï¼Œæ²¡æœ‰è‡ªå·±çš„å†…å­˜ï¼Œç”¨äºç®¡ç† subregionï¼Œä¾‹å¦‚ system_memoryï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="nf">int128_make64</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">UINT64_MAX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="nf">int128_2_64</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">subpage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// éå®ä½“ MemoryRegionï¼Œæœç´¢æ—¶ä¼šç»§ç»­å‰å¾€å…¶ subregions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>        <span class="c1">// æ ¹çº§ MemoryRegion ä¸åˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">readable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">readonly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">rom_device</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">may_overlap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">subregions_link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">coalesced</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nf">g_strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ioeventfd_nb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ioeventfds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° mr-&gt;addr è¢«è®¾ç½®ä¸º 0ï¼Œè€Œ mr-&gt;ram_addr åˆ™å¹¶æ²¡æœ‰åˆå§‹åŒ–ã€‚</p>
<ul>
<li>å®ä½“ <code>MemoryRegion</code>ï¼šé€šè¿‡<code>memory_region_init_ram()</code>åˆå§‹åŒ–ï¼Œæœ‰è‡ªå·±çš„å†…å­˜ï¼ˆä» QEMU è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ†é…ï¼‰ï¼Œå¤§å°ä¸º<code>size</code>ï¼Œä¾‹å¦‚<code>ram_memory</code>ã€ <code>pci_memory</code>ï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">pc_memory_init</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_cmdline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">initrd_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">below_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">above_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">rom_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">**</span><span class="n">ram_memory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram</span><span class="p">,</span> <span class="o">*</span><span class="n">option_rom_mr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ...*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Allocate RAM.  We allocate it as a single memory region and use
</span></span></span><span class="line"><span class="cl"><span class="cm">     * aliases to address portions of it, mostly for backwards compatibility
</span></span></span><span class="line"><span class="cl"><span class="cm">     * with older qemus that used qemu_ram_alloc().
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ram</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ memory_region_init_ram å¯¹ ram_memory è¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="n">ram</span><span class="p">,</span> <span class="s">&#34;pc.ram&#34;</span><span class="p">,</span> <span class="n">below_4g_mem_size</span> <span class="o">+</span> <span class="n">above_4g_mem_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">vmstate_register_ram_global</span><span class="p">(</span><span class="n">ram</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ram_memory</span> <span class="o">=</span> <span class="n">ram</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_ram</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_addr</span> <span class="o">=</span> <span class="nf">qemu_ram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯å…ˆè°ƒç”¨äº†<code>memory_region_init()</code>ï¼Œä¹‹åè®¾ç½® <code>RAM</code> å±æ€§ï¼Œå¹¶ç»§ç»­è°ƒç”¨<code>qemu_ram_alloc()</code>åˆ†é…å†…å­˜ã€‚</p>
<ul>
<li>åˆ«å <code>MemoryRegion</code>ï¼šé€šè¿‡<code>memory_region_init_alias()</code> åˆå§‹åŒ–ï¼Œæ²¡æœ‰è‡ªå·±çš„å†…å­˜ï¼Œè¡¨ç¤ºå®ä½“ <code>MemoryRegion</code> çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡ <code>alias</code> æˆå‘˜æŒ‡å‘å®ä½“ <code>MemoryRegion</code>ï¼Œ<code>alias_offset</code>ä¸ºåœ¨å®ä½“ <code>MemoryRegion</code> ä¸­çš„åç§»é‡ï¼Œä¾‹å¦‚<code>ram_below_4g</code>ã€<code>ram_above_4g</code>ï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">pc_memory_init</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_cmdline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">initrd_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">below_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">above_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">rom_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">**</span><span class="n">ram_memory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="o">*</span><span class="n">ram_above_4g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ram_below_4g</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram_below_4g</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ memory_region_init_alias å¯¹ ram_below_4g è¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_init_alias</span><span class="p">(</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="s">&#34;ram-below-4g&#34;</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">below_4g_mem_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ..
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">memory_region_init_alias</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">orig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">target_phys_addr_t</span> <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias</span> <span class="o">=</span> <span class="n">orig</span><span class="p">;</span> <span class="c1">// æŒ‡å‘å®ä½“ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">alias_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span> <span class="c1">//é€šè¿‡ offset å¾—åˆ°å®ä½“çš„æŸä¸€ä¸ªéƒ¨åˆ†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="ramblock">RAMBlock</h3>
<h4 id="ç»“æ„ä½“å®šä¹‰-2">ç»“æ„ä½“å®šä¹‰</h4>
<p><code>MemoryRegion</code> ç”¨æ¥æè¿°ä¸€æ®µé€»è¾‘å±‚é¢ä¸Šçš„å†…å­˜åŒºåŸŸï¼Œè€Œè®°å½•å®é™…åˆ†é…çš„å†…å­˜åœ°å€ä¿¡æ¯çš„ç»“æ„ä½“åˆ™æ˜¯ <code>RAMBlock</code>ï¼Œåœ¨<code>ramblock.h</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">RAMBlock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">colo_cache</span><span class="p">;</span> <span class="cm">/* For colo, VM&#39;s ram cache */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">used_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">max_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resized</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Protected by iothread lock.  */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">idstr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* RCU-enabled, writes protected by the ramlist lock */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QLIST_ENTRY</span><span class="p">(</span><span class="n">RAMBlock</span><span class="p">)</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QLIST_HEAD</span><span class="p">(,</span> <span class="n">RAMBlockNotifier</span><span class="p">)</span> <span class="n">ramblock_notifiers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">page_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* dirty bitmap used during migration */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bmap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* bitmap of already received pages in postcopy */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">receivedmap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * bitmap to track already cleared dirty bitmap.  When the bit is
</span></span></span><span class="line"><span class="cl"><span class="cm">     * set, it means the corresponding memory chunk needs a log-clear.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Set this up to non-NULL to enable the capability to postpone
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and split clearing of dirty bitmap on the remote node (e.g.,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * KVM).  The bitmap will be set only when doing global sync.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * NOTE: this bitmap is different comparing to the other bitmaps
</span></span></span><span class="line"><span class="cl"><span class="cm">     * in that one bit can represent multiple guest pages (which is
</span></span></span><span class="line"><span class="cl"><span class="cm">     * decided by the `clear_bmap_shift&#39; variable below).  On
</span></span></span><span class="line"><span class="cl"><span class="cm">     * destination side, this should always be NULL, and the variable
</span></span></span><span class="line"><span class="cl"><span class="cm">     * `clear_bmap_shift&#39; is meaningless.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">clear_bmap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">clear_bmap_shift</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * RAM block length that corresponds to the used_length on the migration
</span></span></span><span class="line"><span class="cl"><span class="cm">     * source (after RAM block sizes were synchronized). Especially, after
</span></span></span><span class="line"><span class="cl"><span class="cm">     * starting to run the guest, used_length and postcopy_length can differ.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Used to register/unregister uffd handlers and as the size of the received
</span></span></span><span class="line"><span class="cl"><span class="cm">     * bitmap. Receiving any page beyond this length will bail out, as it
</span></span></span><span class="line"><span class="cl"><span class="cm">     * could not have been valid on the source.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">postcopy_length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°åœ¨ <code>RAMBlock</code> ä¸­ host å’Œ offset åŸŸåˆ†åˆ«å¯¹åº”äº† <code>HVA</code> å’Œ<code>GPA</code>ï¼Œå› æ­¤ä¹Ÿå¯ä»¥è¯´ <code>RAMBlock</code> ä¸­å­˜å‚¨äº†<code>GPA-&gt;HVA</code>çš„æ˜ å°„å…³ç³»ï¼Œå¦å¤–æ¯ä¸€ä¸ª <code>RAMBlock</code> éƒ½ä¼šæŒ‡å‘å…¶æ‰€å±çš„ <code>MemoryRegion</code>ã€‚</p>
<h4 id="å…¨å±€å˜é‡-ram_list">å…¨å±€å˜é‡ ram_list</h4>
<p>QEMU åœ¨<code>ramlist.h</code>ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡<code>ram_list</code>ï¼Œä»¥é“¾è¡¨çš„å½¢å¼ç»´æŠ¤äº†æ‰€æœ‰çš„ <code>RAMBlock</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">RAMList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">QemuMutex</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">mru_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* RCU-enabled, writes protected by the ramlist lock. */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QLIST_HEAD</span><span class="p">(,</span> <span class="n">RAMBlock</span><span class="p">)</span> <span class="n">blocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DirtyMemoryBlocks</span> <span class="o">*</span><span class="n">dirty_memory</span><span class="p">[</span><span class="n">DIRTY_MEMORY_NUM</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QLIST_HEAD</span><span class="p">(,</span> <span class="n">RAMBlockNotifier</span><span class="p">)</span> <span class="n">ramblock_notifiers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">RAMList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">RAMList</span> <span class="n">ram_list</span><span class="p">;</span>
</span></span></code></pre></div><p>æ¯ä¸€ä¸ªæ–°åˆ†é…çš„ <code>RAMBlock</code> éƒ½ä¼šè¢«æ’å…¥åˆ°<code>ram_list</code>çš„å¤´éƒ¨ã€‚å¦‚éœ€æŸ¥æ‰¾åœ°å€æ‰€å¯¹åº”çš„ <code>RAMBlock</code>ï¼Œåˆ™éœ€è¦éå†<code>ram_list</code>ï¼Œå½“ç›®æ ‡åœ°å€è½åœ¨å½“å‰<code>RAMBlock</code>çš„åœ°å€åŒºé—´æ—¶ï¼Œè¯¥ <code>RAMBlock</code> å³ä¸ºæŸ¥æ‰¾ç›®æ ‡ã€‚</p>
<h4 id="asmrramblock-ä¹‹é—´çš„å…³ç³»">ASã€MRã€RAMBlock ä¹‹é—´çš„å…³ç³»</h4>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220225155936.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220225155936.png" alt=""  />
</a>
</div>

</p>
<h3 id="flatview">FlatView</h3>
<p>AddressSpace çš„ root åŸŸåŠå…¶å­æ ‘å…±åŒæ„æˆäº† Guest çš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œä½†è¿™äº›éƒ½æ˜¯åœ¨ QEMU ä¾§å®šä¹‰çš„ã€‚è¦ä¼ å…¥ KVM è¿›è¡Œè®¾ç½®æ—¶ï¼Œå¤æ‚çš„æ ‘çŠ¶ç»“æ„æ˜¯ä¸åˆ©äºå†…æ ¸è¿›è¡Œå¤„ç†çš„ï¼Œå› æ­¤éœ€è¦å°†å…¶<strong>è½¬æ¢ä¸ºä¸€ä¸ªâ€œå¹³å¦â€çš„åœ°å€æ¨¡</strong>å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªä»é›¶å¼€å§‹ã€åªåŒ…å«åœ°å€ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œè¿™åœ¨ QEMU ä¸­é€šè¿‡ <strong>FlatView</strong> æ¥è¡¨ç¤ºã€‚æ¯ä¸ª AddressSpace éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ FlatView æŒ‡é’ˆ current_mapï¼Œè¡¨ç¤ºå…¶å¯¹åº”çš„å¹³é¢å±•å¼€è§†å›¾ã€‚</p>
<h4 id="ç»“æ„ä½“å®šä¹‰-3">ç»“æ„ä½“å®šä¹‰</h4>
<p><code>FlatView</code> åœ¨<code>memory.c</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Flattened global view of current active memory hierarchy.  Kept in sorted
</span></span></span><span class="line"><span class="cl"><span class="cm"> * order.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">FlatView</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlatRange</span> <span class="o">*</span><span class="n">ranges</span><span class="p">;</span>      <span class="c1">// å¯¹åº”çš„ FlatRange æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">nr</span><span class="p">;</span>            <span class="c1">// FlatRange çš„æ•°ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">nr_allocated</span><span class="p">;</span>  <span class="c1">// å½“å‰æ•°ç»„çš„é¡¹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">AddressSpaceDispatch</span> <span class="o">*</span><span class="n">dispatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œ<code>ranges</code>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè®°å½•äº† <code>FlatView</code> ä¸‹æ‰€æœ‰çš„ <code>FlatRange</code>ã€‚</p>
<h4 id="flatrange">FlatRange</h4>
<p>åœ¨ <code>FlatView</code> ä¸­ï¼Œ<code>FlatRange</code> è¡¨ç¤ºåœ¨ <code>FlatView</code> ä¸­çš„ä¸€æ®µå†…å­˜èŒƒå›´ï¼ŒåŒæ ·åœ¨<code>memory.c</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Range of memory in the global map.  Addresses are absolute. */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">FlatRange</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>           <span class="c1">// æŒ‡å‘æ‰€å±çš„ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hwaddr</span> <span class="n">offset_in_region</span><span class="p">;</span>    <span class="c1">// åœ¨å…¨å±€ MemoryRegion ä¸­çš„ offsetï¼Œå¯¹åº” GPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AddrRange</span> <span class="n">addr</span><span class="p">;</span>             <span class="c1">// ä»£è¡¨çš„åœ°å€åŒºé—´ï¼Œå¯¹åº” HVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint8_t</span> <span class="n">dirty_log_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">romd_mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">readonly</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">nonvolatile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>æ¯ä¸ª <code>FlatRange</code> å¯¹åº”ä¸€æ®µè™šæ‹Ÿæœºç‰©ç†åœ°å€åŒºé—´ï¼Œå„ä¸ª <code>FlatRange</code> ä¸ä¼šé‡å ï¼Œ<strong>æŒ‰ç…§åœ°å€çš„é¡ºåºä¿å­˜åœ¨æ•°ç»„ä¸­</strong>ï¼Œå…·ä½“çš„åœ°å€èŒƒå›´ç”±ä¸€ä¸ª <code>AddrRange</code> ç»“æ„æ¥æè¿°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AddrRange ç”¨äºè¡¨ç¤º FlatRange çš„èµ·å§‹åœ°å€åŠå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">AddrRange</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int128</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int128</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h3 id="memoryregionsection">MemoryRegionSection</h3>
<h4 id="ç»“æ„ä½“å®šä¹‰-4">ç»“æ„ä½“å®šä¹‰</h4>
<p>åœ¨ <code>QEMU</code> ä¸­ï¼Œè¿˜æœ‰å‡ ä¸ªèµ·åˆ°ä¸­ä»‹ä½œç”¨çš„ç»“æ„ä½“ï¼Œ<code>MemoryRegionSection</code> å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<p>ä¹‹å‰ä»‹ç»çš„ <code>FlatRange</code> ä»£è¡¨ä¸€ä¸ªç‰©ç†åœ°å€ç©ºé—´çš„ç‰‡æ®µï¼Œåå‘äºæè¿°åœ¨ <code>Host</code> ä¾§å³ <strong>AddressSpace ä¸­çš„åˆ†å¸ƒã€Guest çš„ç‰©ç†ç©ºé—´ã€‘</strong>ï¼Œè€Œ <code>MemoryRegionSection</code> åˆ™ä»£è¡¨åœ¨ <code>Guest</code> ä¾§å³ <strong>MemoryRegion ä¸­çš„ç‰‡æ®µ</strong>ã€‚<code>MemoryRegionSection</code> åœ¨<code>memory.h</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * MemoryRegionSection: describes a fragment of a #MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @mr: the region, or %NULL if empty
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @address_space: the address space the region is mapped in
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @offset_within_region: the beginning of the section, relative to @mr&#39;s start
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @size: the size of the section; will not exceed @mr&#39;s boundaries
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @offset_within_address_space: the address of the first byte of the section
</span></span></span><span class="line"><span class="cl"><span class="cm"> *     relative to the region&#39;s address space
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @readonly: writes to this section are ignored
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//åªæ˜¯èµ·åˆ°æè¿°çš„ä½œç”¨ï¼Œæè¿°äº†æ˜¯å“ªä¸ª AddressSpace çš„ MemoryRegionï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">//å¹¶ä¸”åœ¨ MemoryRegion ä¸­çš„ offsetï¼Œå’Œåœ¨ AddressSpace å±•å¼€ä¸ºå¹³å¦å†…å­˜çš„ offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">MemoryRegionSection</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>                               <span class="c1">// æ‰€å±çš„ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">address_space</span><span class="p">;</span>                    <span class="c1">// å…³è”çš„ AddressSpace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">target_phys_addr_t</span> <span class="n">offset_within_region</span><span class="p">;</span>        <span class="c1">// åœ¨ MemoryRegion å†…éƒ¨çš„ offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">;</span>                                  <span class="c1">// Section çš„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">target_phys_addr_t</span> <span class="n">offset_within_address_space</span><span class="p">;</span> <span class="c1">// åœ¨ AddressSpace å†…éƒ¨çš„ offset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">readonly</span><span class="p">;</span>                                  <span class="c1">// æ˜¯å¦ä¸ºåªè¯»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><ul>
<li><code>offset_within_region</code>ï¼šåœ¨æ‰€å± <code>MemoryRegion</code> ä¸­çš„<code>offset</code>ã€‚ä¸€ä¸ª<code>AddressSpace</code> å¯èƒ½ç”±å¤šä¸ª <code>MemoryRegion</code> ç»„æˆï¼Œå› æ­¤è¯¥ <code>offset</code> æ˜¯å±€éƒ¨çš„</li>
<li><code>offset_within_address_space</code>ï¼šåœ¨æ‰€å± <code>AddressSpace</code> ä¸­çš„ <code>offset</code>ï¼Œå®ƒæ˜¯å…¨å±€çš„</li>
</ul>
<h4 id="å’Œå…¶ä»–æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»">å’Œå…¶ä»–æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»</h4>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125110422.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125110422.png" alt=""  />
</a>
</div>

</p>
<ul>
<li><code>AddressSpace</code> çš„<code>root</code>æŒ‡å‘å¯¹åº”çš„æ ¹çº§<code>MemoryRegion</code>ï¼Œ<code>current_map</code>æŒ‡å‘<code>AddressSpace</code> çš„<code>root</code>é€šè¿‡<code>generate_memory_topology()</code>ç”Ÿæˆçš„ <code>FlatView</code></li>
<li><code>FlatView</code> ä¸­çš„<code>ranges</code>æ•°ç»„è¡¨ç¤ºè¯¥<code>MemoryRegion</code> æ‰€è¡¨ç¤ºçš„<code>Guest</code>åœ°å€åŒºé—´ã€GPA çš„æ•´ä¸ªå¹³å¦ç‰©ç†ç©ºé—´ã€‘ï¼Œå¹¶æŒ‰ç…§åœ°å€çš„é¡ºåºè¿›è¡Œæ’åˆ—</li>
<li><code>MemoryRegionSection</code> ç”±<code>ranges</code>æ•°ç»„ä¸­çš„ <code>FlatRange</code> å¯¹åº”ç”Ÿæˆï¼Œä½œä¸ºæ³¨å†Œåˆ° <code>KVM</code>ä¸­çš„åŸºæœ¬å•ä½</li>
</ul>
<hr>
<p><code>QEMU</code> åœ¨ç”¨æˆ·ç©ºé—´ç”³è¯·å†…å­˜åï¼Œéœ€è¦å°†å†…å­˜ä¿¡æ¯é€šè¿‡ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ä¼ å…¥å†…æ ¸ç©ºé—´çš„ <code>KVM</code>ï¼Œç”± <code>KVM</code> ä¾§è¿›è¡Œç®¡ç†ï¼Œå› æ­¤ <code>QEMU</code> ä¾§ä¹Ÿå®šä¹‰äº†ä¸€äº›ç”¨äºå‘ <code>KVM</code> ä¼ é€’å‚æ•°çš„ç»“æ„ä½“ã€‚</p>
<p>ä»¥ä¸‹ä¸º<code>KVM</code>ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚</p>
<h3 id="kvmslot">KVMSlot</h3>
<p><code>åœ¨ kvm_init.h</code>ä¸­å®šä¹‰ï¼Œæ˜¯ <code>KVM</code> ä¸­å†…å­˜ç®¡ç†çš„åŸºæœ¬å•ä½ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">KVMSlot</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hwaddr</span> <span class="n">start_addr</span><span class="p">;</span> <span class="c1">// Guest ç‰©ç†åœ°å€ï¼ŒGPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">ram_addr_t</span> <span class="n">memory_size</span><span class="p">;</span>        <span class="c1">// å†…å­˜å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">ram</span><span class="p">;</span> <span class="c1">// QEMU ç”¨æˆ·ç©ºé—´åœ°å€ï¼ŒHVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>  <span class="c1">// Slot ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span> <span class="c1">// æ ‡å¿—ä½ï¼Œä¾‹å¦‚æ˜¯å¦è¿½è¸ªè„é¡µã€æ˜¯å¦å¯ç”¨ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* Dirty bitmap cache for the slot */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dirty_bmap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dirty_bmap_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Cache of the address space ID */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">as_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Cache of the offset in ram address space */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ram_addr_t</span> <span class="n">ram_start_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">KVMSlot</span><span class="p">;</span>
</span></span></code></pre></div><p><code>KVMSlot</code> ç±»ä¼¼äºå†…å­˜æ’æ§½çš„æ¦‚å¿µã€‚</p>
<h3 id="kvm_userspace_memory_region">kvm_userspace_memory_region</h3>
<p>è°ƒç”¨<code>ioctl(KVM_SET_USER_MEMORY_REGION)</code>æ—¶éœ€è¦å‘ <code>KVM</code> ä¼ é€’çš„å‚æ•°ï¼Œåœ¨<code>kvm.h</code>ä¸­å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* for KVM_SET_USER_MEMORY_REGION */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u32</span> <span class="n">slot</span><span class="p">;</span>            <span class="c1">// slot ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u32</span> <span class="n">flags</span><span class="p">;</span>           <span class="c1">// æ ‡å¿—ä½ï¼Œä¾‹å¦‚æ˜¯å¦è¿½è¸ªè„é¡µã€æ˜¯å¦å¯ç”¨ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">guest_phys_addr</span><span class="p">;</span> <span class="c1">// Guest ç‰©ç†åœ°å€ï¼ŒGPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">memory_size</span><span class="p">;</span>     <span class="c1">// å†…å­˜å¤§å°ï¼Œbytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">__u64</span> <span class="n">userspace_addr</span><span class="p">;</span>  <span class="c1">// ä» QEMU è¿›ç¨‹ç©ºé—´åˆ†é…çš„èµ·å§‹åœ°å€ï¼ŒHVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><h3 id="memorylistener">MemoryListener</h3>
<h4 id="ç»“æ„ä½“å®šä¹‰-5">ç»“æ„ä½“å®šä¹‰</h4>
<p>ä¸ºäº†ç›‘æ§è™šæ‹Ÿæœºçš„ç‰©ç†åœ°å€è®¿é—®ï¼Œå¯¹äºæ¯ä¸€ä¸ª <code>AddressSpace</code>ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ª <code>MemoryListener</code> ä¸ä¹‹å¯¹åº”ã€‚æ¯å½“ç‰©ç†æ˜ å°„<code>GPA-&gt;HVA</code>å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°±ä¼šå›è°ƒè¿™äº›å‡½æ•°ã€‚<strong>MemoryListener</strong> æ˜¯å¯¹ä¸€äº›äº‹ä»¶çš„<strong>å›è°ƒå‡½æ•°åˆé›†</strong>ï¼Œåœ¨<code>memory.h</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * MemoryListener: callbacks structure for updates to the physical memory map
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Allows a component to adjust to changes in the guest-visible memory map.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Use with memory_listener_register() and memory_listener_unregister().
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">MemoryListener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">commit</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">region_add</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">region_del</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">region_nop</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">log_start</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">log_stop</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">log_sync</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">log_global_start</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">log_global_stop</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">eventfd_add</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">bool</span> <span class="n">match_data</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">data</span><span class="p">,</span> <span class="n">EventNotifier</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">eventfd_del</span><span class="p">)(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">MemoryRegionSection</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">bool</span> <span class="n">match_data</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">data</span><span class="p">,</span> <span class="n">EventNotifier</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Lower = earlier (during add), later (during del) */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">priority</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">address_space_filter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">MemoryListener</span><span class="p">)</span> <span class="n">link</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><h4 id="å…¨å±€å˜é‡-memory_listeners">å…¨å±€å˜é‡ memory_listeners</h4>
<p>æ‰€æœ‰çš„ <code>MemoryListener</code> éƒ½ä¼šæŒ‚åœ¨å…¨å±€å˜é‡<code>memory_listeners</code>é“¾è¡¨ä¸Šï¼Œåœ¨<code>memory.c</code>ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="nf">QTAILQ_HEAD</span><span class="p">(,</span> <span class="n">MemoryListener</span><span class="p">)</span> <span class="n">memory_listeners</span>
</span></span><span class="line"><span class="cl">    <span class="o">=</span> <span class="nf">QTAILQ_HEAD_INITIALIZER</span><span class="p">(</span><span class="n">memory_listeners</span><span class="p">);</span>
</span></span></code></pre></div><p>åœ¨<code>memory.c</code>ä¸­æšä¸¾äº†<code>ListenerDirection</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">ListenerDirection</span> <span class="p">{</span> <span class="n">Forward</span><span class="p">,</span> <span class="n">Reverse</span> <span class="p">};</span>
</span></span></code></pre></div><h3 id="é‡è¦æ•°æ®ç»“æ„æ€»è§ˆ">é‡è¦æ•°æ®ç»“æ„æ€»è§ˆ</h3>
<table>
<thead>
<tr>
<th style="text-align:center">ç»“æ„ä½“å</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">AddressSpace</td>
<td style="text-align:left">VM èƒ½çœ‹åˆ°çš„ä¸€æ®µåœ°å€ç©ºé—´ï¼Œåå‘ Host ä¾§ã€æ³¨æ„æŒ‡çš„æ˜¯åå‘ã€‘</td>
</tr>
<tr>
<td style="text-align:center">MemoryRegion</td>
<td style="text-align:left">åœ°å€ç©ºé—´ä¸­ä¸€æ®µé€»è¾‘å±‚é¢çš„å†…å­˜åŒºåŸŸï¼Œåå‘ Guest ä¾§</td>
</tr>
<tr>
<td style="text-align:center">RAMBlock</td>
<td style="text-align:left">è®°å½•å®é™…åˆ†é…çš„å†…å­˜åœ°å€ä¿¡æ¯ï¼Œå­˜å‚¨äº† GPA-&gt;HVA çš„æ˜ å°„å…³ç³»</td>
</tr>
<tr>
<td style="text-align:center">FlatView</td>
<td style="text-align:left">MemoryRegion å¯¹åº”çš„å¹³é¢å±•å¼€è§†å›¾ï¼ŒåŒ…å«ä¸€ä¸ª FlatRange ç±»å‹çš„ ranges æ•°ç»„</td>
</tr>
<tr>
<td style="text-align:center">FlatRange</td>
<td style="text-align:left">å¯¹åº”ä¸€æ®µè™šæ‹Ÿæœºç‰©ç†åœ°å€åŒºé—´ï¼Œå„ä¸ª FlatRange ä¸ä¼šé‡å ï¼ŒæŒ‰ç…§åœ°å€çš„é¡ºåºä¿å­˜åœ¨æ•°ç»„ä¸­</td>
</tr>
<tr>
<td style="text-align:center">MemoryRegionSection</td>
<td style="text-align:left">è¡¨ç¤º MemoryRegion ä¸­çš„ç‰‡æ®µ</td>
</tr>
<tr>
<td style="text-align:center">MemoryListener</td>
<td style="text-align:left">å›è°ƒå‡½æ•°é›†åˆ</td>
</tr>
<tr>
<td style="text-align:center">KVMSlot</td>
<td style="text-align:left">KVM ä¸­å†…å­˜ç®¡ç†çš„åŸºæœ¬å•ä½ï¼Œè¡¨ç¤ºä¸€ä¸ªå†…å­˜æ’æ§½</td>
</tr>
<tr>
<td style="text-align:center">kvm_userspace_memory_region</td>
<td style="text-align:left">è°ƒç”¨ ioctl(KVM_SET_USER_MEMORY_REGION) æ—¶éœ€è¦å‘ KVM ä¼ é€’çš„å‚æ•°</td>
</tr>
</tbody>
</table>
<h2 id="å…·ä½“å®ç°æœºåˆ¶">å…·ä½“å®ç°æœºåˆ¶</h2>
<p>QEMU çš„å†…å­˜ç”³è¯·æµç¨‹å¤§è‡´å¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šå›è°ƒå‡½æ•°çš„æ³¨å†Œã€AddressSpace çš„åˆå§‹åŒ–ã€å®é™…å†…å­˜çš„åˆ†é…ã€‚ä¸‹é¢å°†æ ¹æ®åœ¨ vl.c çš„ main() å‡½æ•°ä¸­çš„è°ƒç”¨é¡ºåºåˆ†åˆ«ä»‹ç»ã€‚</p>
<h3 id="å›è°ƒå‡½æ•°çš„æ³¨å†Œ">å›è°ƒå‡½æ•°çš„æ³¨å†Œ</h3>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125133808.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125133808.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_accelerator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="err">â””â”€</span> <span class="kt">int</span> <span class="nf">kvm_init</span><span class="p">()</span>                                     <span class="c1">// åˆå§‹åŒ– KVM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="err">â”œâ”€</span> <span class="kt">int</span> <span class="nf">kvm_ioctl</span><span class="p">(</span><span class="n">KVM_CREATE_VM</span><span class="p">)</span>                  <span class="c1">// åˆ›å»º VM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="err">â”œâ”€</span> <span class="kt">int</span> <span class="nf">kvm_arch_init</span><span class="p">()</span>                           <span class="c1">// é’ˆå¯¹ä¸åŒçš„æ¶æ„è¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">memory_listener_register</span><span class="p">()</span>               <span class="c1">// æ³¨å†Œ kvm_memory_listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                 <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">listener_add_address_space</span><span class="p">()</span> <span class="c1">// è°ƒç”¨ region_add å›è°ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_region_add</span><span class="p">()</span>        <span class="c1">// region_add å¯¹åº”çš„å›è°ƒå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_set_phys_mem</span><span class="p">()</span> <span class="c1">// æ ¹æ®ä¼ å…¥çš„ section å¡«å…… KVMSlot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_set_user_memory_region</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                     <span class="err">â””â”€</span> <span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">)</span>
</span></span></code></pre></div><p>è¿›å…¥<code>configure_accelerator()</code>åï¼Œ<code>QEMU</code>ä¼šå…ˆè°ƒç”¨<code>configure_accelerator()</code>è®¾ç½® <code>KVM</code> çš„åŠ é€Ÿæ”¯æŒï¼Œä¹‹åè¿›å…¥<code>kvm_init()</code>ã€‚è¯¥å‡½æ•°ä¸»è¦å®Œæˆå¯¹ KVM çš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ä¸€äº›å¸¸è§„æ£€æŸ¥å¦‚ <code>CPU</code> ä¸ªæ•°ã€<code>KVM</code> ç‰ˆæœ¬ç­‰ï¼Œä¹‹åé€šè¿‡<code>kvm_ioctl(KVM_CREATE_VM)</code>ä¸å†…æ ¸äº¤äº’ï¼Œåˆ›å»º <code>KVM</code> è™šæ‹Ÿæœºã€‚åœ¨<code>kvm_init()</code>çš„æœ€åï¼Œä¼šè°ƒç”¨<code>memory_listener_register()</code>æ³¨å†Œ<code>kvm_memory_listener</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_init</span><span class="p">(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="nf">MACHINE_GET_CLASS</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å¼€/dev/kvm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">s</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="nf">qemu_open_old</span><span class="p">(</span><span class="s">&#34;/dev/kvm&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º VM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">kvm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">KVM_CREATE_VM</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">kvm_arch_init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="c1">// é’ˆå¯¹ä¸åŒçš„æ¶æ„è¿›è¡Œåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯¹äºä»¥ä¸‹ AddressSpaceï¼Œè®¾ç½®å…¶å¯¹åº”çš„ listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">kvm_memory_listener_register</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">memory_listener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">&amp;</span><span class="n">address_space_memory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;kvm-memory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_listener_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_coalesced_pio_listener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="o">&amp;</span><span class="n">address_space_io</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">memory_listener_register</span><span class="p">(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryListener</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Only one of them can be defined for a listener */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_sync</span> <span class="o">&amp;&amp;</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_sync_global</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">listener</span><span class="o">-&gt;</span><span class="n">address_space</span> <span class="o">=</span> <span class="n">as</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="nf">QTAILQ_LAST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memory_listeners</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">||</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;=</span> <span class="nf">QTAILQ_LAST</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link_as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">,</span> <span class="n">link_as</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">QTAILQ_INSERT_BEFORE</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">link_as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">listener_add_address_space</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€åçš„<code>listener_add_address_space()</code>ä¸»è¦æ˜¯å°† listener æ³¨å†Œåˆ°å…¶å¯¹åº”çš„ <code>AddressSpace</code> ä¸Šï¼Œå¹¶æ ¹æ® <code>AddressSpace</code> å¯¹åº”çš„ <code>FlatRange</code> æ•°ç»„ï¼Œç”Ÿæˆ <code>MemoryRegionSection</code>ã€<code>MemoryRegionSection</code>å°±åƒæ˜¯ä¸º<code>FlatRange</code>æ•°ç»„è®¾ç½®çš„ä¸€ç§ä¸­ä»‹è¡¨ç¤ºï¼Œä¾¿äºä¼ å…¥<code>KVM</code>ï¼Œå› ä¸ºä¼ å…¥<code>KVM</code>åº”è¯¥æ˜¯å¯¹å¹³å¦å†…å­˜çš„ä¸€ç§è¡¨ç¤ºã€‘ï¼Œå¹¶æ³¨å†Œåˆ° <code>KVM</code> ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">listener_add_address_space</span><span class="p">(</span><span class="n">MemoryListener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlatView</span> <span class="o">*</span><span class="n">view</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlatRange</span> <span class="o">*</span><span class="n">fr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listener</span><span class="o">-&gt;</span><span class="nf">begin</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¼€å¯å†…å­˜è„é¡µè®°å½• */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">global_dirty_tracking</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_global_start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">listener</span><span class="o">-&gt;</span><span class="nf">log_global_start</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* éå† AddressSpace å¯¹åº”çš„ FlatRange æ•°ç»„ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ MemoryRegionSection */</span>
</span></span><span class="line"><span class="cl">    <span class="n">view</span> <span class="o">=</span> <span class="nf">address_space_get_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">FOR_EACH_FLAT_RANGE</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MemoryRegionSection</span> <span class="n">section</span> <span class="o">=</span> <span class="nf">section_from_flat_range</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å°† section æ‰€ä»£è¡¨çš„å†…å­˜åŒºåŸŸæ³¨å†Œåˆ° KVM ä¸­ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">region_add</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">listener</span><span class="o">-&gt;</span><span class="nf">region_add</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">section</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">fr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span> <span class="o">&amp;&amp;</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">log_start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">listener</span><span class="o">-&gt;</span><span class="nf">log_start</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">section</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listener</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">flatview_unref</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç”±äºæ­¤æ—¶ <code>AddressSapce</code> å°šæœªåˆå§‹åŒ–ï¼Œæ‰€ä»¥æ­¤å¤„çš„å¾ªç¯ä¸ºç©ºï¼Œä»…æ˜¯åœ¨å…¨å±€æ³¨å†Œäº†<code>kvm_memory_listener</code>ã€‚æœ€åè°ƒç”¨äº†<code>kvm_memory_listener-&gt;region_add()</code>ï¼Œå¯¹åº”çš„å®ç°æ˜¯<code>kvm_region_add()</code>ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šé€šè¿‡<code>ioctl(KVM_SET_USER_MEMORY_REGION)</code>ï¼Œå°† <code>QEMU</code> ä¾§ç”³è¯·çš„å†…å­˜ä¿¡æ¯ä¼ å…¥ <code>KVM</code> è¿›è¡Œæ³¨å†Œï¼Œè¿™é‡Œçš„æµç¨‹ä¼šåœ¨ä¸‹ä¸€éƒ¨åˆ†è¿›è¡Œåˆ†æã€‚</p>
<h3 id="addressspace-çš„åˆå§‹åŒ–">AddressSpace çš„åˆå§‹åŒ–</h3>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125154841.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220125154841.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">cpu_exec_init_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="err">â”œâ”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_map_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>    <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">memory_region_init</span><span class="p">()</span>    <span class="c1">// åˆå§‹åŒ– system_memory/io è¿™ä¸¤ä¸ªå…¨å±€ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">set_system_memory_map</span><span class="p">()</span> <span class="c1">// address_space_memory-&gt;root = system_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="o">|</span>    <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_region_update_topology</span><span class="p">()</span>        <span class="c1">// ä¸º MemoryRegion ç”Ÿæˆ FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="o">|</span>         <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology</span><span class="p">()</span>   <span class="c1">// as-&gt;current_map = new_view
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="o">|</span>              <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology_pass</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>    <span class="o">|</span>                   <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_region_add</span><span class="p">()</span>        <span class="c1">// region_add å¯¹åº”çš„å›è°ƒå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="o">|</span>                        <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_set_phys_mem</span><span class="p">()</span> <span class="c1">// æ ¹æ®ä¼ å…¥çš„ section å¡«å…… KVMSlot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>    <span class="o">|</span>                             <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_set_user_memory_region</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>    <span class="o">|</span>                                  <span class="err">â””â”€</span> <span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>    <span class="o">|</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>    <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">memory_listener_register</span><span class="p">()</span> <span class="c1">// æ³¨å†Œå¯¹åº”çš„ MemoryListener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="o">|</span>         <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">listener_add_address_space</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">       <span class="o">|</span>
</span></span><span class="line"><span class="cl">       <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">io_mem_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">memory_region_init_io</span><span class="p">()</span> <span class="c1">// ram/rom/unassigned/notdirty/subpage-ram/watch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                 <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">memory_region_init</span><span class="p">()</span>
</span></span></code></pre></div><p>ç¬¬ä¸€éƒ¨åˆ†åœ¨å…¨å±€æ³¨å†Œäº†<code>kvm_memory_listener</code>ï¼Œä½†ç”±äº<code>AddressSpace</code> å°šæœªåˆå§‹åŒ–ï¼Œå®é™…ä¸Šå¹¶æœªå‘ <code>KVM</code> ä¸­æ³¨å†Œä»»ä½•å®é™…çš„å†…å­˜ä¿¡æ¯ã€‚<code>QEMU</code> åœ¨<code>main()</code>å‡½æ•°ä¸­ä¼šç»§ç»­è°ƒç”¨<code>cpu_exec_init_all()</code>å¯¹<code>AddressSpace</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œè¯¥å‡½æ•°å®é™…ä¸Šæ˜¯å¯¹ä¸¤ä¸ª <code>init</code> å‡½æ•°çš„å°è£…è°ƒç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cpu_exec_init_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ram_list</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The data structures we set up here depend on knowing the page size,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * so no more changes can be made after this point.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * In an ideal world, nothing we did before we had finished the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * machine setup would care about the target page size, and we could
</span></span></span><span class="line"><span class="cl"><span class="cm">     * do this much later, rather than requiring board models to state
</span></span></span><span class="line"><span class="cl"><span class="cm">     * up front what their requirements are.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">finalize_target_page_bits</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">io_mem_init</span><span class="p">();</span>      <span class="c1">// åˆå§‹åŒ–å…­ä¸ªI/O MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_map_init</span><span class="p">();</span> <span class="c1">// åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€ AddressSpaceï¼Œä»¥åŠå¯¹åº”çš„ MemoryRegionã€FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">qemu_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_client_list_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…ˆæ¥çœ‹<code>memory_map_init()</code>ï¼Œä¸»è¦ç”¨æ¥åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€çš„ç³»ç»Ÿåœ°å€ç©ºé—´<code>system_memory</code>ã€<code>system_io</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_map_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">system_memory</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">system_memory</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆå§‹åŒ– system_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;system&#34;</span><span class="p">,</span> <span class="n">UINT64_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. è®¾ç½® address_space_memory å…³è” system_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸¤ä¸ªéƒ½æ˜¯å…¨å±€å˜é‡ï¼Œä¹Ÿå°±æ˜¯æŠŠå†…å­˜åœ°å€ç©ºé—´å’Œ IO åœ°å€ç©ºé—´äºå¯¹åº”çš„ MemoryRegion è”ç³»èµ·æ¥ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//åŠå…¶å¯¹åº”çš„ FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">address_space_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_space_memory</span><span class="p">,</span> <span class="n">system_memory</span><span class="p">,</span> <span class="s">&#34;memory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">system_io</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">system_io</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. åˆå§‹åŒ– system_io  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_init_io</span><span class="p">(</span><span class="n">system_io</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unassigned_io_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;io&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="mi">65536</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. è®¾ç½® address_space_io å…³è” system_io 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŠå…¶å¯¹åº”çš„ FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">address_space_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_space_io</span><span class="p">,</span> <span class="n">system_io</span><span class="p">,</span> <span class="s">&#34;I/O&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œæ¯”è¾ƒé‡è¦çš„æ˜¯<code>address_space_init()</code>ï¼Œå…ˆè®¾ç½® <code>AddressSpace</code> å¯¹åº”çš„ <code>MemoryRegion</code>ï¼Œä¹‹åæ ¹æ®<code>system_memory</code>æ›´æ–°<code>address_space_memory</code>å¯¹åº”çš„ <code>FlatView</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">address_space_init</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_region_ref</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°† address_space_memory çš„ root åŸŸæŒ‡å‘ system_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">    <span class="n">as</span><span class="o">-&gt;</span><span class="n">current_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfd_nb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">as</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nf">g_strdup</span><span class="p">(</span><span class="n">name</span> <span class="o">?</span> <span class="nl">name</span> <span class="p">:</span> <span class="s">&#34;anonymous&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ® system_memory æ›´æ–° address_space_memory å¯¹åº”çš„ FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">address_space_update_topology</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="nf">address_space_update_ioeventfds</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>address_space_update_topology()</code>ä¼šç»§ç»­è°ƒç”¨<code>generate_memory_topology()</code>ç”Ÿæˆ <code>AddressSpace</code> å¯¹åº”çš„ <code>FlatView</code>è§†å›¾ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">physmr</span> <span class="o">=</span> <span class="nf">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">flatviews_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">g_hash_table_lookup</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">physmr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">generate_memory_topology</span><span class="p">(</span><span class="n">physmr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">address_space_set_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>address_space_update_topology()</code>ä¼šå…ˆè°ƒç”¨<code>generate_memory_topology()</code>ç”Ÿæˆ<code>system_memory</code>æ›´æ–°åçš„è§†å›¾<code>new_view</code>ï¼Œå†å°†<code>address_space_memory</code>çš„<code>current_map</code>æŒ‡å‘è¿™ä¸ª<code>new_view</code>ï¼Œæœ€åé”€æ¯<code>old_view</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_set_flatview</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlatView</span> <span class="o">*</span><span class="n">old_view</span> <span class="o">=</span> <span class="nf">address_space_to_flatview</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">physmr</span> <span class="o">=</span> <span class="nf">memory_region_get_flatview_root</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlatView</span> <span class="o">*</span><span class="n">new_view</span> <span class="o">=</span> <span class="nf">g_hash_table_lookup</span><span class="p">(</span><span class="n">flat_views</span><span class="p">,</span> <span class="n">physmr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="n">new_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span> <span class="o">==</span> <span class="n">new_view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">flatview_ref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">flatview_ref</span><span class="p">(</span><span class="n">new_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">QTAILQ_EMPTY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FlatView</span> <span class="n">tmpview</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span> <span class="o">*</span><span class="n">old_view2</span> <span class="o">=</span> <span class="n">old_view</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_view2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">old_view2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmpview</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">address_space_update_topology_pass</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">old_view2</span><span class="p">,</span> <span class="n">new_view</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">address_space_update_topology_pass</span><span class="p">(</span><span class="n">as</span><span class="p">,</span> <span class="n">old_view2</span><span class="p">,</span> <span class="n">new_view</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Writes are protected by the BQL.  */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qatomic_rcu_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">current_map</span><span class="p">,</span> <span class="n">new_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">flatview_unref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Note that all the old MemoryRegions are still alive up to this
</span></span></span><span class="line"><span class="cl"><span class="cm">     * point.  This relieves most MemoryListeners from the need to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ref/unref the MemoryRegions they get---unless they use them
</span></span></span><span class="line"><span class="cl"><span class="cm">     * outside the iothread mutex, in which case precise reference
</span></span></span><span class="line"><span class="cl"><span class="cm">     * counting is necessary.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">flatview_unref</span><span class="p">(</span><span class="n">old_view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨<code>address_space_update_topology_pass()</code>çš„æœ€åï¼Œä¼šè°ƒç”¨<code>MEMORY_LISTENER_UPDATE_REGION</code>è¿™ä¸ªå®ï¼Œè§¦å‘<code>region_add</code>å¯¹åº”çš„å›è°ƒå‡½æ•°<code>kvm_region_add()</code>ã€‚</p>
<p>è¿™ä¸ªå®åœ¨<code>memory.c</code>ä¸­å®šä¹‰ï¼Œä¼šå°† <code>FlatView</code> ä¸­çš„ <code>FlatRange</code> è½¬æ¢ä¸º <code>MemoryRegionSection</code>ï¼Œä½œä¸ºå…¥å‚ä¼ é€’ç»™<code>kvm_region_add()</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cm">/* No need to ref/unref .mr, the FlatRange keeps it alive.  */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MEMORY_LISTENER_UPDATE_REGION(fr, as, dir, callback, _args...)  \
</span></span></span><span class="line"><span class="cl"><span class="cp">    do {                                                                \
</span></span></span><span class="line"><span class="cl"><span class="cp">        MemoryRegionSection mrs = section_from_flat_range(fr,           \
</span></span></span><span class="line"><span class="cl"><span class="cp">                address_space_to_flatview(as));                         \
</span></span></span><span class="line"><span class="cl"><span class="cp">        MEMORY_LISTENER_CALL(as, callback, dir, &amp;mrs, ##_args);         \
</span></span></span><span class="line"><span class="cl"><span class="cp">    } while(0)
</span></span></span></code></pre></div><p>è€Œ<code>kvm_region_add()</code>å®é™…ä¸Šæ˜¯å¯¹<code>kvm_set_phys_mem()</code>çš„å°è£…è°ƒç”¨ã€‚è¯¥å‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„<code>section</code>å¡«å…… KVMSlotï¼Œå†ä¼ é€’ç»™<code>kvm_set_user_memory_region()</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_set_user_memory_region</span><span class="p">(</span><span class="n">KVMMemoryListener</span> <span class="o">*</span><span class="n">kml</span><span class="p">,</span> <span class="n">KVMSlot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">KVMState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">kvm_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="n">mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ® KVMSlot å¡«å…… kvm_userspace_memory_region
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mem</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">|</span> <span class="p">(</span><span class="n">kml</span><span class="o">-&gt;</span><span class="n">as_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span><span class="p">.</span><span class="n">guest_phys_addr</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span><span class="p">.</span><span class="n">userspace_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">slot</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">flags</span> <span class="o">^</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">old_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">KVM_MEM_READONLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Set the slot size to 0 before setting the slot to the desired
</span></span></span><span class="line"><span class="cl"><span class="cm">         * value. This is needed based on KVM commit 75d61fbc. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">mem</span><span class="p">.</span><span class="n">memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">kvm_vm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem</span><span class="p">.</span><span class="n">memory_size</span> <span class="o">=</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">kvm_vm_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">slot</span><span class="o">-&gt;</span><span class="n">old_flags</span> <span class="o">=</span> <span class="n">mem</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆå°† <code>KVMSlot</code> è½¬æ¢ä¸º <code>kvm_userspace_memory_region</code>ï¼Œä½œä¸º<code>ioctl()</code>çš„å‚æ•°ï¼Œäº¤ç»™å†…æ ¸ä¸­çš„ <code>KVM</code> è¿›è¡Œå†…å­˜çš„æ³¨å†Œã€è®¾ç½®<code>GPA-&gt;HVA</code>çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…æ ¸ç©ºé—´ç»´æŠ¤å¹¶ç®¡ç† Guest çš„å†…å­˜ã€‘ã€‚</p>
<p>è‡³æ­¤ QEMU ä¾§è´Ÿè´£ç®¡ç†å†…å­˜çš„æ•°æ®ç»“æ„å‡å·²å®Œæˆåˆå§‹åŒ–ï¼Œ<strong>å¯ä»¥å‚è€ƒä¸‹é¢çš„å›¾ç‰‡äº†è§£å„æ•°æ®ç»“æ„ä¹‹é—´çš„å¯¹åº”å…³ç³»</strong></p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127155506.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127155506.png" alt=""  />
</a>
</div>

</p>
<h3 id="å®é™…å†…å­˜çš„åˆ†é…">å®é™…å†…å­˜çš„åˆ†é…</h3>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127160121.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127160121.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">â””â”€</span> <span class="kt">void</span> <span class="n">machine</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">(</span><span class="n">ram_size</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">       <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">pc_init_pci</span><span class="p">(</span><span class="n">ram_size</span><span class="p">,</span> <span class="p">...)</span> <span class="c1">// åˆå§‹åŒ–è™šæ‹Ÿæœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">pc_init1</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="n">system_io</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">                 <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">pci_memory</span><span class="p">,</span> <span class="s">&#34;pci&#34;</span><span class="p">,</span> <span class="p">...)</span> <span class="c1">// pci_memory, rom_memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                 <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">pc_memory_init</span><span class="p">()</span> <span class="c1">// åˆå§‹åŒ–å†…å­˜ï¼Œåˆ†é…å®é™…çš„ç‰©ç†å†…å­˜åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">memory_region_init_ram</span><span class="p">()</span> <span class="c1">// åˆ›å»º pc.ram, pc.rom å¹¶åˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="o">|</span>    <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">memory_region_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                      <span class="o">|</span>    <span class="err">â””â”€</span> <span class="kt">ram_addr_t</span> <span class="nf">qemu_ram_alloc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                      <span class="o">|</span>         <span class="err">â””â”€</span> <span class="kt">ram_addr_t</span> <span class="nf">qemu_ram_alloc_from_ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                      <span class="o">|</span>
</span></span><span class="line"><span class="cl">                      <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">vmstate_register_ram_global</span><span class="p">()</span> <span class="c1">// å°† MR çš„ name å†™å…¥ RAMBlock çš„ idstr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="o">|</span>    <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">vmstate_register_ram</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                      <span class="o">|</span>         <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">qemu_ram_set_idstr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                      <span class="o">|</span>
</span></span><span class="line"><span class="cl">                      <span class="err">â”œâ”€</span> <span class="kt">void</span> <span class="nf">memory_region_init_alias</span><span class="p">()</span>    <span class="c1">// åˆå§‹åŒ– ram_below_4g, ram_above_4g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                      <span class="err">â””â”€</span> <span class="kt">void</span> <span class="nf">memory_region_add_subregion</span><span class="p">()</span> <span class="c1">// åœ¨ system_memory ä¸­æ·»åŠ  subregions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                           <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_region_add_subregion_common</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">memory_region_update_topology</span><span class="p">()</span> <span class="c1">// ä¸º MemoryRegion ç”Ÿæˆ FlatView
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                     <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology</span><span class="p">()</span> <span class="c1">// as-&gt;current_map = new_view
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                          <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">address_space_update_topology_pass</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                               <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_region_add</span><span class="p">()</span> <span class="c1">// region_add å¯¹åº”çš„å›è°ƒå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                    <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_set_phys_mem</span><span class="p">()</span> <span class="c1">// æ ¹æ®ä¼ å…¥çš„ section å¡«å…… KVMSlot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                         <span class="err">â””â”€</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_set_user_memory_region</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                                              <span class="err">â””â”€</span> <span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="n">KVM_SET_USER_MEMORY_REGION</span><span class="p">)</span>
</span></span></code></pre></div><p>ä¹‹å‰çš„å›è°ƒå‡½æ•°æ³¨å†Œã€AddressSpace çš„åˆå§‹åŒ–ï¼Œå®é™…ä¸Šå‡æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜ã€‚ã€å®é™…çš„å†…å­˜æ˜¯åœ¨ RAMBlock ä¸­ã€‘</p>
<p>æˆ‘ä»¬å†å›åˆ° <code>qemu</code> å¯åŠ¨çš„ <code>main</code> å‡½æ•°ä¸­ã€‚æ¥ä¸‹æ¥çš„åˆå§‹åŒ–è¿‡ç¨‹ä¼šè°ƒç”¨ <code>pc_init1</code>ã€‚åœ¨è¿™é‡Œé¢ï¼Œå¯¹äº <code>CPU</code> è™šæ‹ŸåŒ–ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ <code>pc_cpus_init</code>ã€‚å¦å¤–ï¼Œ<code>pc_init1</code> è¿˜ä¼šè°ƒç”¨<code>pc_memory_init</code>ï¼Œè¿›è¡Œå†…å­˜çš„è™šæ‹ŸåŒ–ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">pc_memory_init</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">system_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kernel_cmdline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">initrd_filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">below_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">ram_addr_t</span> <span class="n">above_4g_mem_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">rom_memory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">MemoryRegion</span> <span class="o">**</span><span class="n">ram_memory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram</span><span class="p">,</span> <span class="o">*</span><span class="n">option_rom_mr</span><span class="p">;</span>         <span class="c1">// ä¸¤ä¸ªå®ä½“ MR: pc.ram, pc.rom
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="o">*</span><span class="n">ram_above_4g</span><span class="p">;</span> <span class="c1">// ä¸¤ä¸ªåˆ«å MR: ram_below_4g, ram_above_4g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Allocate RAM.  We allocate it as a single memory region and use
</span></span></span><span class="line"><span class="cl"><span class="cm">     * aliases to address portions of it, mostly for backwards compatibility
</span></span></span><span class="line"><span class="cl"><span class="cm">     * with older qemus that used qemu_ram_alloc().
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ram</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram</span><span class="p">));</span> <span class="c1">// åˆ›å»º ram
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ†é…å…·ä½“çš„å†…å­˜ï¼ˆå®é™…ä¸Šä¼šåˆ›å»ºä¸€ä¸ª RAMBlock å¹¶å°†å…¶ offset å€¼å†™å…¥ ram.ram_addrï¼Œå¯¹åº” GPAï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="n">ram</span><span class="p">,</span> <span class="s">&#34;pc.ram&#34;</span><span class="p">,</span> <span class="n">below_4g_mem_size</span> <span class="o">+</span> <span class="n">above_4g_mem_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°† MR çš„ name å†™å…¥ RAMBlock çš„ idstr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">vmstate_register_ram_global</span><span class="p">(</span><span class="n">ram</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ram_memory</span> <span class="o">=</span> <span class="n">ram</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º ram_below_4g è¡¨ç¤º 4G ä»¥ä¸‹çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ram_below_4g</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram_below_4g</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_region_init_alias</span><span class="p">(</span><span class="n">ram_below_4g</span><span class="p">,</span> <span class="s">&#34;ram-below-4g&#34;</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">below_4g_mem_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°† ram_below_4g æŒ‚åœ¨ system_memory ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memory_region_add_subregion</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ram_below_4g</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">above_4g_mem_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ram_above_4g</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ram_above_4g</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memory_region_init_alias</span><span class="p">(</span><span class="n">ram_above_4g</span><span class="p">,</span> <span class="s">&#34;ram-above-4g&#34;</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span> <span class="n">below_4g_mem_size</span><span class="p">,</span> <span class="n">above_4g_mem_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memory_region_add_subregion</span><span class="p">(</span><span class="n">system_memory</span><span class="p">,</span> <span class="mh">0x100000000ULL</span><span class="p">,</span> <span class="n">ram_above_4g</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ... */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œçš„é‡ç‚¹åœ¨äº<code>memory_region_init_ram()</code>ï¼Œå®ƒé€šè¿‡<code>qemu_ram_alloc()</code>è·å– ram è¿™ä¸ª <code>MemoryRegion</code> å¯¹åº”çš„ <code>RAMBlock</code> çš„<code>offset</code>ï¼Œå¹¶å­˜å…¥<code>ram.ram_addr</code>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨<code>ram_list</code>ä¸­æ ¹æ®è¯¥å­—æ®µæŸ¥æ‰¾ <code>MR</code> å¯¹åº”çš„ <code>RAMBlock</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">memory_region_init_ram</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span> <span class="c1">// å¡«å……å­—æ®µï¼Œåˆå§‹åŒ–é»˜è®¤å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// è¡¨ç¤ºä¸º RAM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// è¡¨ç¤ºä¸ºå®ä½“ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_ram</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_addr</span> <span class="o">=</span> <span class="nf">qemu_ram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span> <span class="c1">// è¿™é‡Œä¿å­˜ RAMBlock çš„ offsetï¼Œå³ GPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è€Œ qemu_ram_alloc() æœ€ç»ˆä¼šè°ƒç”¨ qemu_ram_alloc_from_ptr()ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”å¤§å° RAMBlock å¹¶åˆ†é…å†…å­˜ï¼Œè¿”å›å¯¹åº”çš„ GPA åœ°å€å­˜å…¥ mr-&gt;ram_addr ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="kt">ram_addr_t</span> <span class="nf">qemu_ram_alloc_from_ptr</span><span class="p">(</span><span class="kt">ram_addr_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">new_block</span><span class="p">;</span> <span class="c1">// åˆ›å»ºä¸€ä¸ª RAMBlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">=</span> <span class="nf">TARGET_PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// é¡µå¯¹é½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_block</span> <span class="o">=</span> <span class="nf">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_block</span><span class="p">));</span> <span class="c1">// åˆå§‹åŒ– new_block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">mr</span><span class="p">;</span> <span class="c1">// å°† new_block-&gt; æŒ‡å‘å…¥å‚çš„ MemoryRegion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="nf">find_ram_offset</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// ä» ram_list ä¸­çš„ RAMBlock ä¹‹é—´æ‰¾åˆ°ä¸€æ®µå¯ä»¥æ»¡è¶³ size éœ€æ±‚çš„ gapï¼Œå¹¶è¿”å›èµ·å§‹åœ°å€çš„ offsetï¼Œå¯¹åº” GPA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// æ–°å»ºçš„ RAMBlock host å­—æ®µä¸ºç©ºï¼Œè·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RAM_PREALLOC_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">mem_path</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// æœªæŒ‡å®š mem_path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined (__linux__) &amp;&amp; !defined(TARGET_S390X)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nf">file_ram_alloc</span><span class="p">(</span><span class="n">new_block</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mem_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nf">qemu_vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">qemu_madvise</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">QEMU_MADV_MERGEABLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;-mem-path option unsupported</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">xen_enabled</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">xen_ram_alloc</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">kvm_enabled</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// ä»è¿™é‡Œç»§ç»­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="cm">/* some s390/kvm configurations have special constraints */</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nf">kvm_vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// å®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨ qemu_vmalloc(size)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nf">qemu_vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// ä» QEMU çš„çº¿æ€§ç©ºé—´ä¸­åˆ†é… size å¤§å°çš„å†…å­˜ï¼Œè¿”å› HVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">qemu_madvise</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">QEMU_MADV_MERGEABLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// å°† length è®¾ç½®ä¸º size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">QLIST_INSERT_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ram_list</span><span class="p">.</span><span class="n">blocks</span><span class="p">,</span> <span class="n">new_block</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span> <span class="c1">// å°†è¯¥ RAMBlock æ’å…¥ ram_list å¤´éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">ram_list</span><span class="p">.</span><span class="n">phys_dirty</span> <span class="o">=</span> <span class="nf">g_realloc</span><span class="p">(</span><span class="n">ram_list</span><span class="p">.</span><span class="n">phys_dirty</span><span class="p">,</span> <span class="c1">// é‡æ–°åˆ†é… ram_list.phys_dirty çš„å†…å­˜ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                       <span class="nf">last_ram_offset</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="n">TARGET_PAGE_BITS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">ram_list</span><span class="p">.</span><span class="n">phys_dirty</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">TARGET_PAGE_BITS</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">           <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">TARGET_PAGE_BITS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">cpu_physical_memory_set_dirty_range</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span> <span class="c1">// å¯¹è¯¥ RAMBlock å¯¹åº”çš„å†…å­˜æ ‡è®°ä¸º dirty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_ram_setup_dump</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">kvm_enabled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nf">kvm_setup_guest_memory</span><span class="p">(</span><span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ ·ä¸€æ¥<code>ram</code>ã€å…¶å®å°±æ˜¯<code>system memory</code>ï¼Œæ•´ä¸ª<code>Guest</code>ç‰©ç†ç©ºé—´çš„å¤§å°ã€‘å¯¹åº”çš„ <code>RAMBlock</code> ä¸­å°±åˆ†é…å¥½äº† <code>GPA</code> å’Œ <code>HVA</code>ï¼Œå°±å¯ä»¥<strong>å°†å†…å­˜ä¿¡æ¯åŒæ­¥è‡³ KVM ä¾§</strong>äº†ã€‚</p>
<p>æœ€åå›åˆ°<code>pc_memory_init()</code>ä¸­ï¼Œåœ¨åˆ†é…å®Œå®é™…å†…å­˜åï¼Œä¼šå…ˆè°ƒç”¨<code>memory_region_init_alias()</code>åˆå§‹åŒ–<code>ram_below_4g</code>ã€<code>ram_above_4g</code>è¿™ä¸¤ä¸ª<code>alias</code>ï¼Œä¹‹åè°ƒç”¨<code>memory_region_add_subregion()</code>å°†è¿™ä¸¤ä¸ª <code>alias</code> æŒ‡å‘<code>ram</code>è¿™ä¸ªå®ä½“ <code>MemoryRegion</code>ã€‚å¦‚ä¸‹å›¾ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè§¦å‘<code>kvm_region_add()</code>å›è°ƒï¼Œå°†å®é™…çš„å†…å­˜ä¿¡æ¯ä¼ å…¥ <code>KVM</code> æ³¨å†Œã€‚è¯¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸ä¹‹å‰åˆ†æçš„æµç¨‹ç›¸åŒï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127163205.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127163205.png" alt=""  />
</a>
</div>

</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>è™šæ‹Ÿæœºçš„å†…å­˜ç®¡ç†ä¹Ÿæ˜¯éœ€è¦ç”¨æˆ·æ€çš„ <code>qemu</code> å’Œå†…æ ¸æ€çš„ <code>KVM</code> å…±åŒå®Œæˆã€‚ä¸ºäº†åŠ é€Ÿå†…å­˜æ˜ å°„ï¼Œéœ€è¦å€ŸåŠ©ç¡¬ä»¶çš„ <code>EPT</code> æŠ€æœ¯ã€‚</p>
<h3 id="qemu-ä¾§">QEMU ä¾§</h3>
<ul>
<li>
<p>åˆ›å»ºä¸€ç³»åˆ— <code>MemoryRegion</code>ï¼Œåˆ†åˆ«è¡¨ç¤º <code>Guest</code> ä¸­çš„ <code>RAM</code>ã€<code>ROM</code> ç­‰åŒºåŸŸã€‚<code>MemoryRegion</code>ä¹‹é—´é€šè¿‡ <code>alias</code> æˆ– <code>subregions</code> çš„æ–¹å¼ç»´æŠ¤ç›¸äº’ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œè¿›ä¸€æ­¥ç»†åŒ–åŒºåŸŸçš„å®šä¹‰</p>
</li>
<li>
<p>å¯¹äºä¸€ä¸ªå®ä½“ <code>MemoryRegion</code>ï¼ˆé <code>alias</code>ï¼‰ï¼Œåœ¨åˆå§‹åŒ–å†…å­˜çš„è¿‡ç¨‹ä¸­ <code>QEMU</code> ä¼šåˆ›å»ºå®ƒæ‰€å¯¹åº”çš„ <code>RAMBlock</code>ã€‚è¯¥ <code>RAMBlock</code> é€šè¿‡è°ƒç”¨<code>qemu_ram_alloc_from_ptr()</code>ä» <code>QEMU</code> çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­<strong>ä»¥ mmap çš„æ–¹å¼åˆ†é…å†…å­˜</strong>ï¼Œå¹¶è´Ÿè´£<strong>ç»´æŠ¤è¯¥ MemoryRegion å¯¹åº”å†…å­˜çš„èµ·å§‹ GPA/HVA/size ç­‰ç›¸å…³ä¿¡æ¯</strong>ã€åœ¨<code>qemu_ram_alloc_from_ptr</code>ä¸­åˆ›å»ºçš„æ–°<code>RAMBlock</code>æœ‰<code>offset</code>ã€<code>host</code>çš„èµ‹å€¼ï¼Œå³<code>GPA-&gt;HVA</code>çš„å¯¹åº”å…³ç³»ã€‘</p>
</li>
<li>
<p><code>AddressSpace</code> è¡¨ç¤º <code>Guest</code> çš„ç‰©ç†åœ°å€ç©ºé—´ã€‚å¦‚æœ <code>AddressSpace</code> ä¸­çš„ <code>MemoryRegion</code> å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ³¨å†Œçš„ <code>listener</code> ä¼šè¢«è§¦å‘ï¼Œå°†æ‰€å±çš„ <code>MemoryRegion</code> æ ‘å±•å¼€ç”Ÿæˆä¸€ç»´çš„ <code>FlatView</code>ï¼Œæ¯”è¾ƒ FlatRange æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ç›¸åº”çš„æ–¹æ³•å¯¹ <code>MemoryRegionSection</code> è¿›è¡Œæ£€æŸ¥ï¼Œæ›´æ–° <code>QEMU</code> ä¸­çš„ <code>KVMSlot</code>ï¼ŒåŒæ—¶å¡«å……<code>kvm_userspace_memory_region</code>ç»“æ„ä½“ï¼Œä½œä¸º<code>ioctl()</code>çš„å‚æ•°æ›´æ–° <code>KVM</code> ä¸­çš„<code>kvm_memory_slot</code></p>
</li>
</ul>
<h3 id="kvm-ä¾§">KVM ä¾§</h3>
<ul>
<li>
<p>å½“ <code>QEMU</code> é€šè¿‡<code>ioctl()</code>åˆ›å»º <code>vcpu</code> æ—¶ï¼Œè°ƒç”¨<code>kvm_mmu_create()</code>åˆå§‹åŒ– <code>MMU</code> ç›¸å…³ä¿¡æ¯ã€‚
å½“ <code>KVM</code> è¦è¿›å…¥ <code>Guest</code> å‰ï¼Œ<code>vcpu_enter_guest()=&gt;kvm_mmu_reload()</code>ä¼šå°†æ ¹çº§é¡µè¡¨åœ°å€åŠ è½½åˆ° <code>VMCS</code>ï¼Œè®© <code>Guest</code> ä½¿ç”¨è¯¥é¡µè¡¨</p>
</li>
<li>
<p>å½“å‘ç”Ÿ<code>EPT Violation</code> æ—¶ï¼Œ<code>VM-EXIT</code>åˆ° <code>KVM</code> ä¸­ã€‚å¦‚æœæ˜¯ç¼ºé¡µï¼Œåˆ™æ ¹æ® <code>GPA</code> ç®—å‡º <code>gfn</code>ï¼Œå†æ ¹æ® <code>gfn</code> æ‰¾åˆ°å¯¹åº”çš„ <code>KVMSlot</code>ï¼Œä»ä¸­å¾—åˆ°å¯¹åº”çš„ <code>HVA</code>ã€‚ç„¶åæ ¹æ® <code>HVA</code> ç®—å‡ºå¯¹åº”çš„ <code>pfn</code>ï¼Œç¡®ä¿è¯¥ <code>Page</code> ä½äºå†…å­˜ä¸­ã€‚å¡«å¥½ç¼ºå¤±çš„é¡µä¹‹åï¼Œéœ€è¦æ›´æ–° <code>EPT</code>ï¼Œå®Œå–„å…¶ä¸­ç¼ºå°‘çš„é¡µè¡¨é¡¹ï¼Œé€å±‚è¡¥å…¨é¡µè¡¨</p>
</li>
</ul>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127163418.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127163418.png" alt=""  />
</a>
</div>

</p>
<blockquote>
<p>è™šæ‹Ÿæœºçš„ç‰©ç†å†…å­˜ç©ºé—´é‡Œé¢çš„é¡µé¢å½“ç„¶ä¸æ˜¯ä¸€å¼€å§‹å°±æ˜ å°„åˆ°ç‰©ç†é¡µé¢çš„ï¼Œåªæœ‰å½“è™šæ‹Ÿæœºçš„å†…å­˜è¢«è®¿é—®çš„æ—¶å€™ï¼Œä¹Ÿå³ <code>mmap</code> åˆ†é…çš„è™šæ‹Ÿå†…å­˜ç©ºé—´è¢«è®¿é—®çš„æ—¶å€™ï¼Œå…ˆæŸ¥çœ‹ <code>EPT</code> é¡µè¡¨ï¼Œæ˜¯å¦å·²ç»æ˜ å°„è¿‡ï¼Œå¦‚æœå·²ç»æ˜ å°„è¿‡ï¼Œåˆ™ç»è¿‡å››çº§é¡µè¡¨æ˜ å°„ï¼Œå°±èƒ½è®¿é—®åˆ°ç‰©ç†é¡µé¢ã€‚
å¦‚æœæ²¡æœ‰æ˜ å°„è¿‡ï¼Œåˆ™è™šæ‹Ÿæœºä¼šé€šè¿‡<code>VM-Exit</code>æŒ‡ä»¤å›åˆ°å®¿ä¸»æœºæ¨¡å¼ï¼Œé€šè¿‡ <code>handle_ept_violation</code> è¡¥å……é¡µè¡¨æ˜ å°„ã€‚å…ˆæ˜¯é€šè¿‡ <code>handle_mm_fault</code>ä¸ºè™šæ‹Ÿæœºçš„ç‰©ç†å†…å­˜ç©ºé—´åˆ†é…çœŸæ­£çš„ç‰©ç†é¡µé¢ï¼Œç„¶åé€šè¿‡ <code>__direct_map</code> æ·»åŠ  <code>EPT</code> é¡µè¡¨æ˜ å°„ã€‚

<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127171031.jpg">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220127171031.jpg" alt=""  />
</a>
</div>

</p>
</blockquote>
<h2 id="reference">Reference</h2>
<p><a href="http://xudaxian.fun/2020/09/03/QEMU%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E8%99%9A%E6%8B%9F%E5%8C%96%E5%8F%8A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">â€œQEMU å†…å­˜ç©ºé—´è™šæ‹ŸåŒ–åŠå†…å­˜ç®¡ç†â€ - B10g | FÎ“om è®¸å¤§ä»™</a>
<a href="https://www.cnblogs.com/LoyenWang/p/13943005.html">ã€åŸåˆ›ã€‘Linux è™šæ‹ŸåŒ– KVM-Qemu åˆ†æï¼ˆäº”ï¼‰ä¹‹å†…å­˜è™šæ‹ŸåŒ– - LoyenWang - åšå®¢å›­</a>
<a href="https://blog.csdn.net/xiongwenwu/article/details/58586013">KVM/Qemu å·¥ä½œåŸç†ç³»åˆ—ç›®å½•_xiongwenwu çš„ä¸“æ -CSDN åšå®¢_qemu ç›®å½•ç»“æ„</a>
<a href="https://abelsu7.top/2019/07/07/kvm-memory-virtualization/">QEMU å†…å­˜è™šæ‹ŸåŒ–æºç åˆ†æ | Keep Coding | è‹æ˜“åŒ—</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æºç åˆ†æ-å¤–è®¾æ¨¡æ‹Ÿï¼ˆä»¥ GPIO ä¸ºä¾‹ï¼‰</title>
      <link>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%A4%96%E8%AE%BE%E6%A8%A1%E6%8B%9F%E4%BB%A5gpio%E4%B8%BA%E4%BE%8B/</link>
      <pubDate>Thu, 11 Nov 2021 10:11:32 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E5%A4%96%E8%AE%BE%E6%A8%A1%E6%8B%9F%E4%BB%A5gpio%E4%B8%BA%E4%BE%8B/</guid>
      <description>QEMU æ¨¡æ‹Ÿå¤–è®¾çš„åŸç† QEMU ä¸»è¦æ˜¯å®ç°äº† CPU æ ¸çš„æ¨¡æ‹Ÿï¼Œå¯ä»¥è¯»å†™æŸä¸ªåœ°å€ã€‚ QEMU çš„æ¨¡æ‹Ÿå¤–è®¾çš„åŸç†å¾ˆç®€å•ï¼šç¡¬ä»¶å³å†…å­˜ã€‚ è¦åœ¨ QEMU ä¸Šæ¨¡æ‹ŸæŸä¸ªå¤–è®¾ï¼Œæ€è·¯å°±æ˜¯ï¼š CPU è¯»æŸä¸ªåœ°</description>
      <content:encoded><![CDATA[<h2 id="qemu-æ¨¡æ‹Ÿå¤–è®¾çš„åŸç†">QEMU æ¨¡æ‹Ÿå¤–è®¾çš„åŸç†</h2>
<p>QEMU ä¸»è¦æ˜¯å®ç°äº† CPU æ ¸çš„æ¨¡æ‹Ÿï¼Œå¯ä»¥è¯»å†™æŸä¸ªåœ°å€ã€‚
QEMU çš„æ¨¡æ‹Ÿå¤–è®¾çš„åŸç†å¾ˆç®€å•ï¼š<strong>ç¡¬ä»¶å³å†…å­˜</strong>ã€‚
è¦åœ¨ QEMU ä¸Šæ¨¡æ‹ŸæŸä¸ªå¤–è®¾ï¼Œæ€è·¯å°±æ˜¯ï¼š</p>
<ul>
<li>CPU è¯»æŸä¸ªåœ°å€æ—¶ï¼ŒQEMU æ¨¡æ‹Ÿå¤–è®¾çš„è¡Œä¸ºï¼ŒæŠŠæ•°æ®è¿”å›ç»™ CPU</li>
<li>CPU å†™æŸä¸ªåœ°å€æ—¶ï¼ŒQEMU è·å¾—æ•°æ®ï¼Œç”¨æ¥æ¨¡æ‹Ÿå¤–è®¾çš„è¡Œä¸ºã€‚
å³ï¼šè¦æ¨¡æ‹Ÿå¤–è®¾å¤‡ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹å¤–è®¾çš„åœ°å€æä¾›å¯¹åº”çš„è¯»å†™å‡½æ•°å³å¯ã€‚</li>
</ul>
<p>ä»¥ GPIO ä¸ºä¾‹ï¼š</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20211111102930.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20211111102930.png" alt=""  />
</a>
</div>

</p>
<p>QEMU ä¸º<code>GPIO</code>å†…å­˜åœ°å€æä¾›è¯»å†™å›è°ƒå‡½æ•°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">sifive_gpio_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">sifive_gpio_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="ç»™å¤–è®¾åœ°å€æä¾›è¯»å†™å‡½æ•°">ç»™å¤–è®¾åœ°å€æä¾›è¯»å†™å‡½æ•°</h2>
<p>æ€ä¹ˆæè¿°æŸæ®µåœ°å€ï¼šåŸºåœ°å€ã€å¤§å°ï¼Ÿå¦‚ä½•ç»™è¿™æ®µåœ°å€æä¾›è¯»å†™å‡½æ•°å‘¢ï¼Ÿè¿™æ®µåœ°å€è®¾ç½®å¥½åï¼Œå¦‚ä½•æ·»åŠ è¿›<code>system_memory</code>å»ï¼Ÿæœ‰ 2 ç§æ–¹æ³•ã€‚</p>
<p><strong>æ³• 1ï¼šmemory_region_init_io/memory_region_add_subregion</strong>
ä»¥<code>SIFIVE_UART</code>ä¸ºä¾‹ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uart_ops</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">TYPE_SIFIVE_UART</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">memory_region_add_subregion</span><span class="p">(</span><span class="n">address_space</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
</span></span></code></pre></div><p><code>memory_region_init_io</code>å‡½æ•°åˆå§‹åŒ–<code>iomem</code>ï¼Œè¯»å†™å‡½æ•°ï¼Œå¤§å°ã€‚
<code>memory_region_add_subregion</code>å‡½æ•°<code>s-&gt;iomem</code>æŒ‡å®šäº†åŸºåœ°å€ï¼Œå¹¶æ·»åŠ è¿›<code>system_memory</code>ä¸­ã€‚
ä»¥åï¼Œå®¢æˆ·æœºä¸Šçš„ç¨‹åºè¯»å†™è¿™å—åœ°å€æ—¶ï¼Œå°±ä¼šå¯¼è‡´å¯¹åº”çš„è¯»å†™å‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p><strong>æ³• 2ï¼šmemory_region_init_io/sysbus_init_mmio/sysbus_mmio_map</strong>
ä»¥<code>SIFIVE_GPIO</code>ä¸ºä¾‹ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="nf">OBJECT</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">gpio_ops</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">TYPE_SIFIVE_GPIO</span><span class="p">,</span> <span class="n">SIFIVE_GPIO_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">sysbus_init_mmio</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
</span></span></code></pre></div><p><code>memory_region_init_io</code>å‡½æ•°åˆå§‹åŒ–<code>iomem</code>ï¼Œè¯»å†™å‡½æ•°ï¼Œå¤§å°ã€‚
<code>sysbus_init_mmio</code>å°†<code>mmin</code>ä¼ ç»™è®¾å¤‡ï¼›</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">sysbus_mmio_map</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">memmap</span><span class="p">[</span><span class="n">SIFIVE_E_DEV_GPIO0</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
</span></span></code></pre></div><p><code>sysbus_mmio_map</code>ä»è®¾å¤‡ä¸­å§<code>mmio</code>æ·»åŠ è¿›<code>system_memory</code>å¹¶æŒ‡å®šåŸºåœ°å€ã€‚</p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æºç åˆ†æ - è™šæ‹Ÿå¤–è®¾åˆ›å»º</title>
      <link>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%A4%96%E8%AE%BE%E5%88%9B%E5%BB%BA/</link>
      <pubDate>Tue, 09 Nov 2021 17:39:38 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%A4%96%E8%AE%BE%E5%88%9B%E5%BB%BA/</guid>
      <description>QOM ç®€ä»‹ QOM(QEMU Object Model) æ˜¯ QEMU çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºæè¿°è™šæ‹Ÿæœºçš„ç»“æ„ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œã€è¾“å…¥è¾“å‡ºè®¾å¤‡ç­‰ã€‚QEMU ä¸ºäº†æ–¹ä¾¿æ•´ä¸ªç³»ç»Ÿçš„æ„å»ºï¼Œå®ç°</description>
      <content:encoded><![CDATA[<h1 id="qom-ç®€ä»‹">QOM ç®€ä»‹</h1>
<p>QOM(QEMU Object Model) æ˜¯ QEMU çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºæè¿°è™šæ‹Ÿæœºçš„ç»“æ„ï¼ŒåŒ…æ‹¬è™šæ‹Ÿæœºçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œã€è¾“å…¥è¾“å‡ºè®¾å¤‡ç­‰ã€‚QEMU ä¸ºäº†æ–¹ä¾¿æ•´ä¸ªç³»ç»Ÿçš„æ„å»ºï¼Œå®ç°äº†è‡ªå·±çš„ä¸€å¥—çš„é¢å‘å¯¹è±¡æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ QOM(QEMU Object Model)ã€‚å®ƒèƒ½å¤Ÿæ–¹ä¾¿çš„è¡¨ç¤ºå„ä¸ªè®¾å¤‡ï¼ˆDeviceï¼‰ä¸æ€»çº¿ï¼ˆBusï¼‰ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p>è¿™ä¸ªæ¨¡å‹ä¸»è¦åŒ…å«å››ä¸ªç»“æ„ä½“ï¼š</p>
<ul>
<li>Object: æ˜¯æ‰€æœ‰å¯¹è±¡çš„ åŸºç±» Base Object</li>
<li>ObjectClass: æ˜¯æ‰€æœ‰ç±»å¯¹è±¡çš„åŸºç±»</li>
<li>TypeInfoï¼šæ˜¯ç”¨æˆ·ç”¨æ¥å®šä¹‰ä¸€ä¸ª <code>Type</code> çš„å·¥å…·å‹çš„æ•°æ®ç»“æ„</li>
<li>TypeImplï¼šTypeInfo æŠ½è±¡æ•°æ®ç»“æ„ï¼Œ<code>TypeInfo</code> çš„å±æ€§ä¸ <code>TypeImpl</code> çš„å±æ€§å¯¹åº”</li>
</ul>
<p>åœ¨ QEMU é‡Œè¦åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡éœ€è¦å®Œæˆå››æ­¥ï¼š</p>
<ul>
<li>å°† <code>TypeInfo</code> æ³¨å†Œ <code>TypeImpl</code></li>
<li>å®ä¾‹åŒ– <code>Class</code>ï¼ˆObjectClassï¼‰</li>
<li>å®ä¾‹åŒ– <code>Object</code></li>
<li>æ·»åŠ  <code>Property</code></li>
</ul>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/15-09-19-4995177f1aeb782fadaf586f8f5c8b32-qemu-QOM%E5%88%86%E6%9E%90.drawio%20-2--1a4eac.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/15-09-19-4995177f1aeb782fadaf586f8f5c8b32-qemu-QOM%E5%88%86%E6%9E%90.drawio%20-2--1a4eac.png" alt=""  />
</a>
</div>

</p>
<h1 id="å¦‚ä½•æè¿°ç¡¬ä»¶">å¦‚ä½•æè¿°ç¡¬ä»¶</h1>
<p>ä¸€ä¸ªæ¿å­ä¸Šæœ‰å¾ˆå¤šç¡¬ä»¶ï¼šèŠ¯ç‰‡ï¼ŒLEDã€æŒ‰é”®ã€LCDã€è§¦æ‘¸å±ã€ç½‘å¡ç­‰ç­‰ã€‚èŠ¯ç‰‡é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šéƒ¨ä»¶ï¼Œæ¯”å¦‚ CPUã€GPIOã€SD æ§åˆ¶å™¨ã€ä¸­æ–­æ§åˆ¶å™¨ç­‰ç­‰ã€‚</p>
<p>è¿™äº›ç¡¬ä»¶ï¼Œæˆ–æ˜¯éƒ¨ä»¶ï¼Œå„æœ‰ä¸åŒã€‚æ€ä¹ˆæè¿°å®ƒä»¬ï¼Ÿ</p>
<p>æ¯ä¸€ä¸ªéƒ½ä½¿ç”¨ä¸€ä¸ª <code>TypeInfo</code> ç»“æ„ä½“æ¥æè¿°ï¼Œ<code>TypeInfo</code> æ˜¯ç”¨æˆ·ç”¨æ¥å®šä¹‰ä¸€ä¸ªÂ TypeÂ çš„å·¥å…·å‹çš„æ•°æ®ç»“æ„ã€‚å®ƒåŒ…å«äº†å¾ˆå¤šæˆå‘˜å˜é‡ï¼Œè¿™äº›æˆå‘˜åˆåœ¨ä¸€èµ·æè¿°äº†ä¸€ä¸ªè®¾å¤‡ç±»å‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// include/qom/object.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">TypeInfo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">size_t</span> <span class="n">instance_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">size_t</span> <span class="n">instance_align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">instance_init</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">instance_post_init</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">instance_finalize</span><span class="p">)(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">bool</span> <span class="n">abstract</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">size_t</span> <span class="n">class_size</span><span class="p">;</span>Â  Â  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">class_init</span><span class="p">)(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">class_base_init</span><span class="p">)(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">void</span> <span class="o">*</span><span class="n">class_data</span><span class="p">;</span>Â  Â  <span class="n">InterfaceInfo</span> <span class="o">*</span><span class="n">interfaces</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>è¿™ä¸ªç»“æ„ä½“æˆ‘ä»¬åœ¨åˆšåˆšä¹Ÿæåˆ°ï¼Œä»–åœ¨å›¾é‡Œæ˜¯ç‹¬ç«‹çš„ï¼Œåœ¨æ³¨å†Œçš„æ—¶å€™ä¼šå°†å®ƒçš„ä¿¡æ¯éƒ½ä¼ ç»™ Typeimpl ç»“æ„ä½“ã€‚</p>
<p>æˆ‘ä»¬ä»¥ Timer ä¸ºä¾‹ï¼Œæˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ª Timer å¤–è®¾ï¼Œé¦–å…ˆå°±è¦å®šä¹‰ä¸€ä¸ª Typeinfo ç»“æ„ä½“ã€‚ä»–åœ¨ä»£ç ä¸­åƒè¿™æ ·ã€‚æˆ‘ä»¬åªçœ‹ nameï¼Œè¿™é‡Œç”¨ä¸€ä¸ªå®èµ‹å€¼ï¼Œè¿™ä¸ªå®æ˜¯ä¸ªæˆ‘ä»¬å®šä¹‰çš„å­—ç¬¦ä¸²ï¼Œå®ƒå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªç¡¬ä»¶ã€‚è¿™äº›ç»“æ„ä½“åœ¨è¿è¡Œæ—¶ä¼šè¢«æ³¨å†Œè¿›ç¨‹åºé‡Œï¼Œä¿å­˜åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­å¤‡ç”¨ï¼Œä¸ºä»€ä¹ˆæ˜¯å¤‡ç”¨ï¼Œå› ä¸ºä¸æ˜¯æ¯ä¸€ä¸ªç¡¬ä»¶éƒ½ä¼šè¢«ç”¨åˆ°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// hw/timer/dw_timer.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">dw_timer_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">name</span> Â  Â  Â  Â  Â <span class="o">=</span> <span class="n">TYPE_DW_TIMER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">parent</span> Â  Â  Â  Â <span class="o">=</span> <span class="n">TYPE_SYS_BUS_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWTimerState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">dw_timer_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">class_init</span> Â  Â <span class="o">=</span> <span class="n">dw_timer_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>è¿™äº›ç»“æ„ä½“åœ¨è¿è¡Œæ—¶ä¼šè¢«æ³¨å†Œè¿›ç¨‹åºé‡Œï¼Œä¿å­˜åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­å¤‡ç”¨ï¼Œä¸ºä»€ä¹ˆæ˜¯å¤‡ç”¨ï¼Œå› ä¸ºä¸æ˜¯æ¯ä¸€ä¸ªç¡¬ä»¶éƒ½ä¼šè¢«ç”¨åˆ°ã€‚</p>
<h1 id="å¦‚ä½•æ³¨å†Œç¡¬ä»¶">å¦‚ä½•æ³¨å†Œç¡¬ä»¶</h1>
<p>ä»€ä¹ˆæ˜¯æ³¨å†Œï¼Œè¯´ç™½äº†å°±æ˜¯å°†ä¸€äº›å¯èƒ½éœ€è¦çš„ä¿¡æ¯æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼Œåœ¨ç³»ç»Ÿè¿è¡Œæ—¶èƒ½å¤Ÿéšæ—¶è°ƒç”¨åˆ°ã€‚å°±æ‹¿ Timer æ¥è¯´ï¼Œç°åœ¨å°†ä¸€äº›ä¿¡æ¯æ·»åŠ åˆ°äº†åˆ—è¡¨ï¼Œç³»ç»Ÿè¿è¡Œèµ·æ¥æ—¶æˆ‘å¯ä»¥éšæ—¶ä»é“¾è¡¨ä¸­å–å‡º Timer è¿™ä¸ªè®¾å¤‡çš„ä¿¡æ¯ï¼Œç”¨æ¥å®ä¾‹åŒ–ä¸€ä¸ª Timerï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æ³¨å†Œ Timerï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å°†å…¶åŠ å…¥åˆ°é“¾è¡¨ï¼Œé‚£æˆ‘åæœŸå°±æ— æ³•æ‰¾åˆ°å®ƒã€‚</p>
<p>æ€ä¹ˆæ³¨å†Œè¿™äº›<code>TypeInfo</code>ç»“æ„ä½“å‘¢ï¼Ÿåœ¨å®ç°çš„æºç ä¸­æœ‰è¿™ä¸ªå‡½æ•° <code>dw_timer_register_types()</code>ï¼Œä»–æ˜¯ç”¨æ¥æ³¨å†Œ Timer è¿™ä¸ªè®¾å¤‡çš„ã€‚</p>
<p>æˆ‘ä»¬è¿½æ ¹æº¯æºï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼Œ</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/16-03-53-4d2fcf4deb7a9ed9c13a22a7fe3111be-20221107160352-084c2a.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/16-03-53-4d2fcf4deb7a9ed9c13a22a7fe3111be-20221107160352-084c2a.png" alt=""  />
</a>
</div>

</p>
<ul>
<li>åˆ†é…ä¸€ä¸ª <code>TypeImpl</code> ç»“æ„ä½“ï¼Œä½¿ç”¨ <code>Typeinfo</code> æ¥è®¾ç½®å®ƒ</li>
<li>æŠŠ <code>TypeImpl</code> åŠ å…¥é“¾è¡¨ï¼š<code>type_table</code></li>
</ul>
<p>åœ¨ QEMU é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ <code>type_table</code>ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å®šä¹‰çš„ç±»ã€‚åœ¨ <code>type_new</code> é‡Œé¢ï¼Œæˆ‘ä»¬å…ˆä»å…¨å±€è¡¨é‡Œé¢æ ¹æ®åå­— <code>type_table_lookup</code> æŸ¥æ‰¾æ‰¾è¿™ä¸ªç±»ã€‚</p>
<ul>
<li>å¦‚æœæ‰¾åˆ°ï¼Œè¯´æ˜è¿™ä¸ªç±»æ›¾ç»è¢«æ³¨å†Œè¿‡ï¼Œå°±æŠ¥é”™ï¼›</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„ç±»ï¼Œåˆ™å°† <code>Typeinfo</code> é‡Œé¢ä¿¡æ¯å¡«åˆ° <code>TypeImpl</code> é‡Œé¢ã€‚<code>type_table_add</code> ä¼šå°†è¿™ä¸ªç±»æ³¨å†Œåˆ°å…¨å±€çš„è¡¨é‡Œé¢ã€‚</li>
</ul>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/16-11-19-19d9b8686c2a5758a0231181b0fb4dfa-qemu-%E6%B3%A8%E5%86%8C%E8%AE%BE%E5%A4%87.drawio-8a4c5c.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/16-11-19-19d9b8686c2a5758a0231181b0fb4dfa-qemu-%E6%B3%A8%E5%86%8C%E8%AE%BE%E5%A4%87.drawio-8a4c5c.png" alt=""  />
</a>
</div>

</p>
<p>ä»¥ä¸Šçš„è¿‡ç¨‹å¯ä»¥ç”¨ä¸Šå›¾æ¥è¡¨ç¤ºã€‚<code>Typeinfo</code> é€šè¿‡ <code>type_new()</code> ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ <code>TypeImpl</code> ç±»å‹ï¼Œå¹¶ä»¥ <code>name</code> ä¸ºå…³é”®å­—æ·»åŠ åˆ°åä¸º <code>type_table</code> çš„ä¸€ä¸ª hash table ä¸­ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™æ³¨å†Œè¿™äº›è®¾å¤‡å‘¢ï¼Ÿä¸éœ€è¦æˆ‘ä»¬å»è°ƒç”¨æ³¨å†Œå‡½æ•°ï¼Œä»¥ Timer ä¸ºä¾‹ï¼Œåœ¨ <code>hw/timer/dw_timer.c</code> ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œä¸€èˆ¬åœ¨æœ€åä¸€è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">(</span><span class="n">dw_timer_register_types</span><span class="p">)</span>
</span></span></code></pre></div><p><code>F12</code>æ‰¾åˆ°è¿™ä¸ªå®å®šä¹‰ï¼Œæˆ‘ä»¬è¿½æ ¹æº¯æºï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="nf">module_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span> <span class="nf">register_module_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">(</span><span class="n">dw_timer_register_types</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define type_init(function) module_init(function, MODULE_INIT_QOM)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define module_init(function, type)                                         \
</span></span></span><span class="line"><span class="cl"><span class="cp">static void __attribute__((constructor)) do_qemu_init_ ## function(void)    \
</span></span></span><span class="line"><span class="cl"><span class="cp">{                                                                           \
</span></span></span><span class="line"><span class="cl"><span class="cp">    register_module_init(function, type);                                   \
</span></span></span><span class="line"><span class="cl"><span class="cp">}
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">register_module_init</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="p">),</span> <span class="n">module_init_type</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ModuleEntry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>     <span class="c1">//æ„é€  ModuleEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ModuleTypeList</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>  <span class="c1">//æ„é€ é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span> <span class="o">=</span> <span class="nf">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>       <span class="c1">//è®¾ç½®åˆå§‹åŒ–å‡½æ•°ï¼Œfn å³ sifive_gpio_register_types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="nf">find_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span><span class="c1">//å°† ModuleEntry æ’å…¥é“¾è¡¨å°¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>type_init</code>æ˜¯ä¸ªå®å®šä¹‰ï¼Œè°ƒç”¨äº†<code>__attribute__((constructor))</code>å‡½æ•°ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ª C è¯­è¨€ä¸­ä½æ•°ä¸å¤šçš„åœ¨<code>main</code>å‡½æ•°æ‰§è¡Œå‰ï¼Œæ‰§è¡Œçš„å‡½æ•°ã€‚å‡½æ•°ä¸­è°ƒç”¨äº†<code>register_module_init</code>æ³¨å†Œå‡½æ•°ï¼Œè¯´æ˜åœ¨<code>main</code>å‡½æ•°æ‰§è¡Œå‰ï¼Œå·²ç»æ³¨å†Œå¥½ç¡¬ä»¶äº†ã€‚è¯¥å‡½æ•°å°†ä¸€ä¸ªæ–°çš„<code>ModuleEntry</code>åŠ åˆ°é“¾è¡¨é‡Œã€‚</p>
<p>æ³¨æ„ï¼Œæ³¨å†Œçš„åªæ˜¯ä¸ªå‡½æ•°ï¼Œå¹¶ä¸æ˜¯æ³¨å†Œäº†è®¾å¤‡ã€‚ä¹Ÿå°±æ˜¯å·²ä¸Šè¿‡ç¨‹ï¼Œåªæ˜¯æŠŠä¸€ä¸ª <code>ModuleEntry</code> æ”¾åˆ°äº†ä¸€ä¸ªé“¾è¡¨é‡Œï¼Œè¿™ä¸ª <code>ModuleEntry</code> å¸¦äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ç±»å‹ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬çœŸæ­£çš„æ³¨å†Œæ³¨å†Œå‡½æ•°ã€‚</p>
<p>å·²ä¸Šè¿‡ç¨‹å¤§æ¦‚æ˜¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/18-31-54-b5c189903fc73c76057f57a95a10310d-qemu-module%20init%20%E9%93%BE%E8%A1%A8.drawio-1309c1.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/18-31-54-b5c189903fc73c76057f57a95a10310d-qemu-module%20init%20%E9%93%BE%E8%A1%A8.drawio-1309c1.png" alt=""  />
</a>
</div>

</p>
<p>é‚£ä»€ä¹ˆæ—¶å€™è¿˜çœŸæ­£æ³¨å†Œè®¾å¤‡å‘¢ï¼Œæˆ‘ä»¬å°±å¾—å›åˆ°ä¸»å‡½æ•°ï¼Œå®ƒæœ‰ä»¥ä¸‹è°ƒç”¨æµç¨‹ï¼Œåœ¨ <code>module_call_init</code> ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° <code>MODULE_INIT_QOM</code> è¿™ç§ç±»å‹å¯¹åº”çš„ <code>ModuleTypeList</code>
æ‰¾å‡ºåˆ—è¡¨ä¸­æ‰€æœ‰çš„ <code>ModuleEntry</code>ï¼Œç„¶åè°ƒç”¨æ¯ä¸ª <code>ModuleEntry</code> çš„ <code>init</code> å‡½æ•°ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/18-34-25-ad40a288b1376c0f9136c609b7d7ee0c-20221107183424-6d1641.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/18-34-25-ad40a288b1376c0f9136c609b7d7ee0c-20221107183424-6d1641.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// softmmu/runstate.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">module_call_init</span><span class="p">(</span><span class="n">MODULE_INIT_QOM</span><span class="p">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// utils/module.csoftmmu/runstate.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">module_call_init</span><span class="p">(</span><span class="n">module_init_type</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">ModuleTypeList</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">ModuleEntry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="c1">// æ‰¾åˆ° MODULE_INIT_QOM è¿™ç§ç±»å‹å¯¹åº”çš„ ModuleTypeList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>Â  Â  <span class="n">l</span> <span class="o">=</span> <span class="nf">find_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="nf">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="n">e</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="åˆå§‹åŒ–è®¾å¤‡">åˆå§‹åŒ–è®¾å¤‡</h1>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨æ³¨å†Œè®¾å¤‡çš„æ—¶å€™è™½ç„¶å°†è®¾å¤‡ä» <code>Typeinfo</code> å˜æˆäº† <code>TypeImpl</code>ï¼ŒæŠŠ <code>Typeinfo</code> é‡Œçš„ä¿¡æ¯éƒ½å¤åˆ¶åˆ°äº† <code>TypeImpl</code>ï¼Œä½†æ˜¯ <code>class_init</code> è¿˜æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä¹Ÿå³è¿™ä¸ªç±»ç°åœ¨è¿˜å¤„äºçº¸é¢çš„çŠ¶æ€ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™æ‰çœŸæ­£åˆå§‹åŒ–è¿™ä¸ªç±»å‘¢ï¼Œè¿™å¾—ç­‰åœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™ã€‚æˆ‘ä»¬åœ¨ä¸€å—æ¿å­ä¸Šæ‰ä¼šç”¨åˆ°ä¸€ä¸ªè®¾å¤‡ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Sifive-e è¿™ä¸ªæ¿å­ï¼Œå‡†ç¡®æ¥è¯´æˆ‘ä»¬ç”¨çš„ä¸æ˜¯è¿™ä¸ªæ¿å­ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨åŸå…ˆçš„ä»£ç ä¸Šåšäº†ä¿®æ”¹ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œå°±å½“æ˜¯ç”¨çš„ sifive-e è¿™ä¸ªæ¿å­ã€‚åœ¨å®ç°çš„æºç é‡Œï¼Œæœ‰ <code>object_initialize_child</code>å‡½æ•°ï¼Œè·Ÿè¸ªä¸€ä¸‹è°ƒç”¨æµç¨‹å¯ä»¥çœ‹åˆ°æœ€ååœ¨ <code>type_initialize</code> å‡½æ•°ä¸­åˆå§‹åŒ–äº†ç±»ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿçœ‹åˆ°åœ¨ <code>object_init_with_type</code> å‡½æ•°ä¸­å®ä¾‹åŒ–äº†ç±»ã€‚è¿™ä¸ªç¨åå†è®²ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// hw/riscv/sifive_e.cstatic void sifive_e_soc_init(Object *obj)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">MachineState</span> <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="nf">MACHINE</span><span class="p">(</span><span class="nf">qdev_get_machine</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">SiFiveESoCState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nf">RISCV_E_SOC</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span>Â  Â  <span class="nf">object_initialize_child</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#34;timer&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="n">TYPE_DW_TIMER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="nf">object_initialize_child</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">TYPE_DW_TIMER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="nf">object_initialize_child_internal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="nf">object_initialize_child_with_props</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  <span class="nf">object_initialize_child_with_propsv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  <span class="nf">object_initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="nf">object_initialize_with_type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="nf">type_initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_init</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="n">ti</span><span class="o">-&gt;</span><span class="nf">class_init</span><span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">}</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">}</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="nf">object_init_with_type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">{</span> Â  Â  Â  
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">instance_init</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="n">ti</span><span class="o">-&gt;</span><span class="nf">instance_init</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">}</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="p">}</span>
</span></span></code></pre></div><p>åœ¨è°ƒç”¨ <code>class_init</code> å‡½æ•°æ—¶ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨çš„è®¾å¤‡æ¨¡å—ä¸‹çš„ <code>dw_timer_class_init</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸­åˆæ˜¯ä¸€äº›é…ç½®ï¼Œå°¤å…¶æ˜¯ <code>realize</code> å‡½æ•°çš„é…ç½®ã€‚è¿˜æœ‰ä¸€äº›å±æ€§çš„é…ç½®ï¼Œå¦‚ Timer çš„é¢‘ç‡ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ‰æœ‰æœ‰äº†ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„è®¾å¤‡ç±»ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">hw</span><span class="o">/</span><span class="n">timer</span><span class="o">/</span><span class="n">dw_timer</span><span class="p">.</span><span class="n">c</span> 
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_timer_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="c1">// è¿™é‡Œåˆæ˜¯ä¸€äº›é…ç½®ï¼Œå°¤å…¶æ˜¯å›è°ƒå‡½æ•°çš„é…ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>Â  Â  <span class="n">DeviceClass</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="nf">DEVICE_CLASS</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">dc</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">dw_timer_reset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="c1">// è®¾ç½® Timer åŸºæœ¬å±æ€§å¦‚é¢‘ç‡ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>Â  Â  <span class="nf">device_class_set_props</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">dw_timer_properties</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">dc</span><span class="o">-&gt;</span><span class="n">vmsd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vmstate_dw_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">dc</span><span class="o">-&gt;</span><span class="n">realize</span> <span class="o">=</span> <span class="n">dw_timer_realize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="å®ä¾‹åŒ–è®¾å¤‡">å®ä¾‹åŒ–è®¾å¤‡</h1>
<p>è¯´ç™½äº†åˆå§‹åŒ–è¿‡ç¨‹å°±æ˜¯åœ¨é…ç½®å„ç§ç»“æ„ä½“æˆå‘˜çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚åˆšåˆšçš„åˆå§‹åŒ–è¿‡ç¨‹å°±æ˜¯åœ¨é…ç½® <code>DeviceClass</code> è¿™ä¸ªç±»çš„å„ä¸ªæˆå‘˜ã€‚å®é™…ä¸Šæˆ‘ä»¬è¿˜æ²¡æœ‰çœŸæ­£å®ä¾‹åŒ– Timerï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½ä½¿ç”¨å®ƒã€‚</p>
<p>æˆ‘ä»¬åªæœ‰åœ¨å®ä¾‹åŒ–åæ‰èƒ½ä½¿ç”¨å®ƒï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰æåˆ°çš„ <code>instance_init()</code>ã€‚ä½†æ˜¯åœ¨ QEMU ä¸­è¦å®ä¾‹åŒ–ä¸€ä¸ªè®¾å¤‡ï¼Œä¸ä»…ä»…éœ€è¦è°ƒç”¨ <code>instance_init</code>ï¼Œè¿˜éœ€è¦è°ƒç”¨åˆšåˆšåˆå§‹åŒ–æ—¶è®¾ç½®çš„ <code>realize</code> å‡½æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">dw_timer_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">name</span> Â  Â  Â  Â  Â <span class="o">=</span> <span class="n">TYPE_DW_TIMER</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">parent</span> Â  Â  Â  Â <span class="o">=</span> <span class="n">TYPE_SYS_BUS_DEVICE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWTimerState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">dw_timer_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">class_init</span> Â  Â <span class="o">=</span> <span class="n">dw_timer_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// hw/timer/dw_timer.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_timer_init</span><span class="p">(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">DWTimerState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nf">DWTIMER</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="c1">// ä¸ºè¿™æ®µå†…å­˜æ³¨å†Œå›è°ƒå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>Â  Â  <span class="nf">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_timer_ops</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="s">&#34;dw_timer&#34;</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="nf">sysbus_init_mmio</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½å¾ˆåƒï¼Œå…·ä½“ç»†èŠ‚å·®å¼‚æˆ‘ä¹Ÿè¿˜æ²¡å¼„æ˜ç™½ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ <code>instance_init</code> ä¸€å®šè¦åœ¨ <code>realize</code> ä¹‹å‰å®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰é”™è¯¯ã€‚å¦åˆ™å°†æ— æ³•å®Œæˆå®ä¾‹åŒ–ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// hw/timer/dw_timer.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_timer_realize</span><span class="p">(</span><span class="n">DeviceState</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">DWTimerState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nf">DWTIMER</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="nf">sysbus_init_irq</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="n">s</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">timer_new_ns</span><span class="p">(</span><span class="n">QEMU_CLOCK_VIRTUAL</span><span class="p">,</span> <span class="n">dw_timer_interrupt</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>instance_init</code> è¿™ä¸ªå‡½æ•°ä¸»è¦å®Œæˆçš„å·¥ä½œå°±æ˜¯ä¸ºä¸€æ®µå†…å­˜ç»‘å®šäº†è¯»å†™å‡½æ•°ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ã€‚</p>
<h1 id="å¦‚ä½•æ“ä½œè®¾å¤‡">å¦‚ä½•æ“ä½œè®¾å¤‡</h1>
<p>è®¾å¤‡åˆ›å»ºå®Œæˆäº†ï¼Œé‚£ QEMU æ˜¯å¦‚ä½•æ¨¡æ‹Ÿè®¾å¤‡çš„è¡Œä¸ºçš„ï¼Ÿè¿™ä¹Ÿæ˜¯ QEMU é©±åŠ¨å¼€å‘æœ€é‡è¦çš„ä¸€æ­¥ï¼Œå› ä¸ºä»¥ä¸Šçš„éƒ¨åˆ†æ˜¯å®ç°è®¾å¤‡æ‰€å¿…é¡»çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å‚è€ƒå…¶ä»–å·²ç»å®ç°çš„æ¨¡å—ï¼Œä¿®æ”¹æˆæˆ‘ä»¬çš„ä¿¡æ¯å³å¯ã€‚</p>
<p>ä½†æ˜¯æ¯ä¸ª IP çš„å¯„å­˜å™¨ä¸åŒï¼Œä»–ä»¬çš„åŠŸèƒ½ä¹Ÿå°±ä¸åŒï¼Œè¿™æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦å®ç°çš„å†…å®¹ã€‚æˆ‘ä»¬çŸ¥é“å†™é©±åŠ¨å…¶å®å°±æ˜¯æ“ä½œå„ä¸ª IP çš„å¯„å­˜å™¨ï¼Œä»¥å®ç°æƒ³è¦çš„åŠŸèƒ½ã€‚å¯¹åº”åˆ° QEMU ä¸­ï¼Œå°±æˆäº†åœ¨æ“ä½œå„ä¸ªå¯„å­˜å™¨æ—¶ï¼Œæˆ‘ä»¬è¦åœ¨ QEMU ä¸­å°†é©±åŠ¨å¯„å­˜å™¨çš„åŠŸèƒ½å…ˆæ¨¡æ‹Ÿå‡ºæ¥ï¼Œå†è¿”å›ç»™é©±åŠ¨ç¨‹åºã€‚</p>
<p>ä»¥ Timer ä¸ºä¾‹æˆ‘æƒ³è¦è·å– <code>TimerNLoadCount</code> çš„å€¼ï¼ŒçœŸå®ç¡¬ä»¶æœ‰è¿™ä¸ªå¯„å­˜å™¨ä¿å­˜äº†å€¼ï¼Œä½†æ˜¯ QEMU ä¸Šæˆ‘ä»¬å°±å¾—ç»´æŠ¤ä¸€ä¸ªå˜é‡å»ä¿å­˜è¿™ä¸ªå€¼ã€‚åœ¨éœ€è¦çš„æ—¶å€™èƒ½è¯»å–åˆ°ã€‚æ¯”å¦‚ä»£ç é‡Œæ¯”è¾ƒé‡è¦çš„å‚æ•°æ˜¯ <code>offset</code>ï¼Œè¿™ä¸ªå‚æ•°æ˜¯åŸºäºå¤–è®¾åŸºåœ°å€çš„åç§»ï¼Œå…¶å®å°±æ˜¯å¯„å­˜å™¨çš„åç§»é‡ã€‚æ¯”å¦‚æˆ‘ä»¬æŸ¥çœ‹ Timer çš„æ‰‹å†Œï¼Œ<code>TimerNLoadCount</code> åç§»é‡ä¸º 0ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åœ¨é©±åŠ¨ä¸­è¯»å–åœ°å€ä¸º <code>0x2000000</code> æ—¶ï¼Œä»£ç å°±ä¼šèµ°åˆ°è¿™é‡Œï¼Œå› ä¸ºæˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä¸ª <code>timer_n_load_count</code> å˜é‡ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥å°†è¿™ä¸ªå˜é‡å½“å‰å€¼è¿”å›å³å¯ï¼Œè¿™å°±æ˜¯è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚æˆ‘ä»¬è¦å†™è¿™ä¸ªå¯„å­˜å™¨ä¹ŸåŒç†ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° <code>timer_n_load_count</code> è¿™ä¸ªå˜é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// hw/timer/dw_timer.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">dw_timer_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">DWTimerState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="nl">TimerNLoadCount</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="mi">1</span><span class="o">*</span><span class="mh">0x14</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="mi">2</span><span class="o">*</span><span class="mh">0x14</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mh">0x14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">timer_n_load_count</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_timer_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">,</span> <span class="n">hwaddr</span> <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="kt">uint64_t</span> <span class="n">val64</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">DWTimerState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">uint32_t</span> <span class="n">value</span> <span class="o">=</span> <span class="n">val64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>Â  Â  <span class="k">switch</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="nl">TimerNLoadCount</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="mi">1</span><span class="o">*</span><span class="mh">0x14</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="k">case</span> <span class="mi">2</span><span class="o">*</span><span class="mh">0x14</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x14</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="n">s</span><span class="o">-&gt;</span><span class="n">timer_n_load_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="nf">set_alarm_time</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¯»å†™å‡½æ•°å†™å¥½äº†ï¼Œéœ€è¦ç»™è°è°ƒç”¨å‘¢ã€‚æˆ‘ä»¬åˆšåˆšæåˆ°äº†ï¼Œè¿™æ˜¯ä¸ªå›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ç»™ä¸€æ®µå†…å­˜æ³¨å†Œè¿™ä¸ªå›è°ƒå‡½æ•°ã€‚å¦‚ä»£ç æ‰€ç¤ºã€‚æˆ‘ä»¬ç»™ Timer iomem ç»‘å®šäº†è¯»å†™å‡½æ•°ã€‚å…·ä½“å“ªä¸€æ®µåœ°å€è¿˜æ²¡å®šï¼Œä½†æ˜¯æˆ‘ä»¬å®šäº† <code>0x2000</code> è¿™ä¹ˆé•¿ä¸€æ®µã€‚æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥æ˜¯æœ€é«˜ä½çš„ä¸€ä¸ªå¯„å­˜å™¨åç§»é‡ã€‚å› ä¸ºå†é«˜å°±æ²¡å•¥ç”¨äº†ï¼Œæˆ–è€…å°±æ˜¯ SoC é‡Œå®šçš„å¯„å­˜å™¨ç©ºé—´å¤§å° <code>0x1000</code>ã€‚è¿™é‡Œåº”è¯¥æ˜¯ä¸ºäº†å›¾çœäº‹å†™çš„ä¸€ä¸ªå€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// hw/timer/dw_timer.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="n">dw_timer_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dw_timer_read</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">dw_timer_write</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="p">.</span><span class="n">endianness</span> <span class="o">=</span> <span class="n">DEVICE_NATIVE_ENDIAN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">dw_timer_init</span><span class="p">(</span><span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="n">DWTimerState</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nf">DWTIMER</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="c1">// ä¸ºè¿™æ®µå†…å­˜æ³¨å†Œå›è°ƒå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>Â  Â  <span class="nf">memory_region_init_io</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_timer_ops</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="s">&#34;dw_timer&#34;</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">Â  Â  <span class="nf">sysbus_init_mmio</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸‹é¢åœ¨<code>hw/riscv/sifive_e.c</code>é‡Œä¼šæ˜ å°„å¯„å­˜å™¨ç©ºé—´åˆ° QEMU çš„å†…å­˜ç©ºé—´ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// hw/riscv/sifive_e.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">sysbus_mmio_map</span><span class="p">(</span><span class="nf">SYS_BUS_DEVICE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">memmap</span><span class="p">[</span><span class="n">SIFIVE_E_DEV_TIMER</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
</span></span></code></pre></div><h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<ol>
<li><a href="https://www.cnblogs.com/haiyonghao/p/14440761.html">QEMU ä¸­åŸºäº QOM çš„ VFIO ç±»çš„å®šä¹‰ - EwanHai - åšå®¢å›­</a></li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æºç åˆ†æ-è™šæ‹Ÿ CPU åˆ›å»º</title>
      <link>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9Fcpu%E5%88%9B%E5%BB%BA/</link>
      <pubDate>Wed, 01 Sep 2021 18:22:14 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9Fcpu%E5%88%9B%E5%BB%BA/</guid>
      <description>æµç¨‹å›¾ å…ˆå¼€ä¸ªå¤´å§ï¼ŒæŠŠåˆ›å»ºæµç¨‹ç¨å¾®æ‹ä¸€ä¸‹ï¼Œæ‰¾åˆ°åˆ›å»ºè™šæ‹Ÿ CPU çš„æ¨¡å—ã€‚è‡³äºä¸­é—´çš„æµç¨‹è¿˜æ²¡æœ‰è¯¦ç»†åˆ†æï¼Œä¸‡äº‹å¼€å¤´éš¾ï¼Œå…ˆä¸Šæ‰‹å†è¯´å§ã€‚ qemu_add_op</description>
      <content:encoded><![CDATA[<h2 id="æµç¨‹å›¾">æµç¨‹å›¾</h2>
<p>å…ˆå¼€ä¸ªå¤´å§ï¼ŒæŠŠåˆ›å»ºæµç¨‹ç¨å¾®æ‹ä¸€ä¸‹ï¼Œæ‰¾åˆ°åˆ›å»ºè™šæ‹Ÿ CPU çš„æ¨¡å—ã€‚è‡³äºä¸­é—´çš„æµç¨‹è¿˜æ²¡æœ‰è¯¦ç»†åˆ†æï¼Œä¸‡äº‹å¼€å¤´éš¾ï¼Œå…ˆä¸Šæ‰‹å†è¯´å§ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210901182329.svg">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210901182329.svg" alt=""  />
</a>
</div>

</p>
<h2 id="qemu_add_optsè§£æ-qemu-çš„å‘½ä»¤è¡Œ"><code>qemu_add_opts</code>è§£æ qemu çš„å‘½ä»¤è¡Œ</h2>
<p><code>qemu_init</code>å‡½æ•°ä¸­ä¸‹é¢è¿™ä¸€é•¿ä¸²å†…å®¹ï¼Œå°±æ˜¯åœ¨è§£æå‘½ä»¤è¡Œçš„å‚æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">drive</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="n">drive</span> <span class="nf">opts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">Legacy</span> <span class="n">drive</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="n">drive</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">common</span> <span class="n">drive</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="n">drive</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">drive</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="n">drive</span> <span class="nf">opts</span> <span class="p">(</span><span class="n">sbdry</span> <span class="n">runtime</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="n">qemu</span> <span class="n">chardev</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">device</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">netdev</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">nic</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="n">sqemu</span> <span class="n">net</span> <span class="n">opts</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">rtc</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">global_opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">qemu</span> <span class="n">mon</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">qemu</span> <span class="n">add</span> <span class="nf">opts</span> <span class="p">(</span><span class="n">sqemu</span> <span class="n">trace</span> <span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span></code></pre></div><p>ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šçš„ <code>opts</code>å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œå®é™…è¿è¡Œä¸­åˆ›å»ºçš„<code>kvm</code>å‚æ•°ä¼šå¤æ‚<code>N</code>å€ã€‚è¿™é‡Œæˆ‘ä»¬è´´ä¸€ä¸ªå¼€æºäº‘å¹³å°è½¯ä»¶ <code>OpenStack</code> åˆ›å»ºå‡ºæ¥çš„<code>KVM</code>çš„å‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">qemu-system-x86_64
</span></span><span class="line"><span class="cl">-enable-kvm
</span></span><span class="line"><span class="cl">-name instance-00000024
</span></span><span class="line"><span class="cl">-machine pc-i440fx-trusty,accel<span class="o">=</span>kvm,usb<span class="o">=</span>off
</span></span><span class="line"><span class="cl">-cpu SandyBridge,+erms,+smep,+fsgsbase,+pdpe1gb,+rdrand,+f16c,+osxsave,+dca,+pcid,+pdcm,+xtpr,+tm2,+est,+smx,+vmx,+ds_cpl,+monitor,+dtes64,+pbe,+tm,+ht,+ss,+acpi,+ds,+vme
</span></span><span class="line"><span class="cl">-m <span class="m">2048</span>
</span></span><span class="line"><span class="cl">-smp 1,sockets<span class="o">=</span>1,cores<span class="o">=</span>1,threads<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">-rtc <span class="nv">base</span><span class="o">=</span>utc,driftfix<span class="o">=</span>slew
</span></span><span class="line"><span class="cl">-drive <span class="nv">file</span><span class="o">=</span>/var/lib/nova/instances/1f8e6f7e-5a70-4780-89c1-464dc0e7f308/disk,if<span class="o">=</span>none,id<span class="o">=</span>drive-virtio-disk0,format<span class="o">=</span>qcow2,cache<span class="o">=</span>none
</span></span><span class="line"><span class="cl">-device virtio-blk-pci,scsi<span class="o">=</span>off,bus<span class="o">=</span>pci.0,addr<span class="o">=</span>0x4,drive<span class="o">=</span>drive-virtio-disk0,id<span class="o">=</span>virtio-disk0,bootindex<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">-netdev tap,fd<span class="o">=</span>32,id<span class="o">=</span>hostnet0,vhost<span class="o">=</span>on,vhostfd<span class="o">=</span><span class="m">37</span>
</span></span><span class="line"><span class="cl">-device virtio-net-pci,netdev<span class="o">=</span>hostnet0,id<span class="o">=</span>net0,mac<span class="o">=</span>fa:16:3e:d1:2d:99,bus<span class="o">=</span>pci.0,addr<span class="o">=</span>0x3
</span></span><span class="line"><span class="cl">-chardev file,id<span class="o">=</span>charserial0,path<span class="o">=</span>/var/lib/nova/instances/1f8e6f7e-5a70-4780-89c1-464dc0e7f308/console.log
</span></span><span class="line"><span class="cl">-vnc 0.0.0.0:12
</span></span><span class="line"><span class="cl">-device cirrus-vga,id<span class="o">=</span>video0,bus<span class="o">=</span>pci.0,addr<span class="o">=</span>0x2
</span></span></code></pre></div><ul>
<li>
<p><code>-enable-kvm</code>ï¼šè¡¨ç¤ºå¯ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–ã€‚</p>
</li>
<li>
<p><code>-name instance-00000024</code>ï¼šè¡¨ç¤ºè™šæ‹Ÿæœºçš„åç§°ã€‚</p>
</li>
<li>
<p><code>-machine pc-i440fx-trusty,accel=kvm,usb=off</code>ï¼šmachine æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯è®¡ç®—æœºä½“ç³»ç»“æ„ã€‚ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ä½“ç³»ç»“æ„çš„è¯ï¼Œå¯ä»¥è®¢é˜…æå®¢æ—¶é—´çš„å¦ä¸€ä¸ªä¸“æ ã€Šæ·±å…¥æµ…å‡ºè®¡ç®—æœºç»„æˆåŸç†ã€‹ã€‚
qemu ä¼šæ¨¡æ‹Ÿå¤šç§ä½“ç³»ç»“æ„ï¼Œå¸¸ç”¨çš„æœ‰æ™®é€š PC æœºï¼Œä¹Ÿå³ x86 çš„ 32 ä½æˆ–è€… 64 ä½çš„ä½“ç³»ç»“æ„ã€Mac ç”µè„‘ PowerPC çš„ä½“ç³»ç»“æ„ã€Sun çš„ä½“ç³»ç»“æ„ã€MIPS çš„ä½“ç³»ç»“æ„ï¼Œç²¾ç®€æŒ‡ä»¤é›†ã€‚å¦‚æœä½¿ç”¨ KVM hardware-assisted virtualizationï¼Œä¹Ÿå³ BIOS ä¸­ VD-T æ˜¯æ‰“å¼€çš„ï¼Œåˆ™å‚æ•°ä¸­ <code>accel=kvm</code>ã€‚å¦‚æœä¸ä½¿ç”¨ <code>hardware-assisted virtualization</code>ï¼Œç”¨çš„æ˜¯çº¯æ¨¡æ‹Ÿï¼Œåˆ™æœ‰å‚æ•° <code>accel = tcg</code>ï¼Œ<code>-no-kvm</code>ã€‚</p>
</li>
<li>
<p><code>-cpu SandyBridge,+erms,+smep,+fsgsbase,+pdpe1gb,+rdrand,+f16c,+osxsave,+dca,+pcid,+pdcm,+xtpr,+tm2,+est,+smx,+vmx,+ds_cpl,+monitor,+dtes64,+pbe,+tm,+ht,+ss,+acpi,+ds,+vme</code>ï¼šè¡¨ç¤ºè®¾ç½® CPUï¼ŒSandyBridge æ˜¯ Intel å¤„ç†å™¨ï¼Œåé¢çš„åŠ å·éƒ½æ˜¯æ·»åŠ çš„ CPU çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°ä¼šæ˜¾ç¤ºåœ¨ /proc/cpuinfo é‡Œé¢ã€‚</p>
</li>
<li>
<p><code>-m 2048</code>ï¼šè¡¨ç¤ºå†…å­˜ã€‚</p>
</li>
<li>
<p><code>-smp 1,sockets=1,cores=1,threads=1</code>ï¼š<code>SMP</code> æˆ‘ä»¬è§£æè¿‡ï¼Œå«å¯¹ç§°å¤šå¤„ç†å™¨ï¼Œå’Œ<code>NUMA</code> å¯¹åº”ã€‚qemu ä»¿çœŸäº†ä¸€ä¸ªå…·æœ‰ 1 ä¸ª <code>vcpu</code>ï¼Œä¸€ä¸ª <code>socket</code>ï¼Œä¸€ä¸ª <code>core</code>ï¼Œä¸€ä¸ª <code>threads</code> çš„å¤„ç†å™¨ã€‚
<code>socket</code>ã€<code>core</code>ã€<code>threads</code> æ˜¯ä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿ<code>socket</code> å°±æ˜¯ä¸»æ¿ä¸Šæ’ CPU çš„æ§½çš„æ•°ç›®ï¼Œä¹Ÿå³å¸¸è¯´çš„â€œè·¯â€ï¼Œ<code>core</code> å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è¯´çš„â€œæ ¸â€ï¼Œå³åŒæ ¸ã€4 æ ¸ç­‰ã€‚<code>thread</code> å°±æ˜¯æ¯ä¸ª core çš„ç¡¬ä»¶çº¿ç¨‹æ•°ï¼Œå³è¶…çº¿ç¨‹ã€‚ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­ï¼ŒæŸä¸ªæœåŠ¡å™¨æ˜¯ï¼š2 è·¯ 4 æ ¸è¶…çº¿ç¨‹ï¼ˆä¸€èˆ¬é»˜è®¤ä¸º 2 ä¸ªçº¿ç¨‹ï¼‰ï¼Œé€šè¿‡ <code>cat /proc/cpuinfo</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ˜¯ 242=16 ä¸ª<code>processor</code>ï¼Œå¾ˆå¤šäººä¹Ÿä¹ æƒ¯æˆä¸º 16 æ ¸äº†ã€‚</p>
</li>
<li>
<p><code>-rtc base=utc,driftfix=slew</code>ï¼šè¡¨ç¤ºç³»ç»Ÿæ—¶é—´ç”±å‚æ•° <code>-rtc</code> æŒ‡å®šã€‚</p>
</li>
<li>
<p><code>-device cirrus-vga,id=video0,bus=pci.0,addr=0x2</code>ï¼šè¡¨ç¤ºæ˜¾ç¤ºå™¨ç”¨å‚æ•° <code>-vga</code> è®¾ç½®ï¼Œé»˜è®¤ä¸º <code>cirrus</code>ï¼Œå®ƒæ¨¡æ‹Ÿäº† <code>CL-GD5446PCI VGA card</code>ã€‚</p>
</li>
<li>
<p>æœ‰å…³ç½‘å¡ï¼Œä½¿ç”¨ <code>-net</code> å‚æ•°å’Œ <code>-device</code>ã€‚</p>
</li>
<li>
<p>ä» HOST è§’åº¦ï¼š<code>-netdev tap,fd=32,id=hostnet0,vhost=on,vhostfd=37</code>ã€‚</p>
</li>
<li>
<p>ä» GUEST è§’åº¦ï¼š<code>-device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:d1:2d:99,bus=pci.0,addr=0x3</code>ã€‚</p>
</li>
<li>
<p>æœ‰å…³ç¡¬ç›˜ï¼Œä½¿ç”¨ <code>-hda -hdb</code>ï¼Œæˆ–è€…ä½¿ç”¨ <code>-drive</code> å’Œ <code>-device</code>ã€‚</p>
</li>
<li>
<p>ä» HOST è§’åº¦ï¼š<code>-drive file=/var/lib/nova/instances/1f8e6f7e-5a70-4780-89c1-464dc0e7f308/disk,if=none,id=drive-virtio-disk0,format=qcow2,cache=none</code></p>
</li>
<li>
<p>ä» GUEST è§’åº¦ï¼š<code>-device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1</code></p>
</li>
<li>
<p><code>-vnc 0.0.0.0:12</code>ï¼šè®¾ç½® VNCã€‚</p>
</li>
</ul>
<h2 id="module_call_initåˆå§‹åŒ–æ‰€æœ‰æ¨¡å—"><code>module_call_init</code>åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">--&gt;</span> <span class="nf">qemu_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">--&gt;</span> <span class="nf">qemu_init_subsystems</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">--&gt;</span> <span class="nf">module_call_init</span><span class="p">()</span>
</span></span></code></pre></div><p>å½“è™šæ‹ŸæœºçœŸçš„è¦ä½¿ç”¨ç‰©ç†èµ„æºçš„æ—¶å€™ï¼Œå¯¹ä¸‹é¢çš„ç‰©ç†æœºä¸Šçš„èµ„æºè¦è¿›è¡Œè¯·æ±‚ï¼Œæ‰€ä»¥å®ƒçš„å·¥ä½œæ¨¡å¼æœ‰ç‚¹å„¿ç±»ä¼¼æ“ä½œç³»ç»Ÿå¯¹æ¥é©±åŠ¨ã€‚é©±åŠ¨è¦ç¬¦åˆä¸€å®šçš„æ ¼å¼ï¼Œæ‰èƒ½ç®—æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªæ¨¡å—ã€‚åŒç†ï¼Œqemu ä¸ºäº†æ¨¡æ‹Ÿå„ç§å„æ ·çš„è®¾å¤‡ï¼Œä¹Ÿéœ€è¦ç®¡ç†å„ç§å„æ ·çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—ä¹Ÿéœ€è¦ç¬¦åˆä¸€å®šçš„æ ¼å¼ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ª qemu æ¨¡å—ä¼šè°ƒç”¨ <code>type_init</code>ã€‚ä¾‹å¦‚ï¼Œ<code>kvm</code> çš„æ¨¡å—è¦åœ¨ <code>accel/kvm/kvm-all.c</code> æ–‡ä»¶é‡Œé¢å®ç°ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæœ‰ä¸€è¡Œä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">kvm_accel_type</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_KVM_ACCEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_ACCEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">kvm_accel_instance_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">kvm_accel_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KVMState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_type_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_accel_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">(</span><span class="n">kvm_type_init</span><span class="p">);</span>
</span></span></code></pre></div><p>æ‰¾åˆ°<code>type_init</code>çš„å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define type_init(function) module_init(function, MODULE_INIT_QOM)
</span></span></span></code></pre></div><p>ä»ä»£ç é‡Œé¢çš„å®šä¹‰æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>type_init</code> åé¢çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨ <code>type_init</code> å°±ç›¸å½“äºè°ƒç”¨ <code>module_init</code>ï¼Œåœ¨è¿™é‡Œå‡½æ•°å°±æ˜¯ <code>kvm_type_init</code>ï¼Œç±»å‹å°±æ˜¯ <code>MODULE_INIT_QOM</code>ã€‚</p>
<p>å†æŸ¥çœ‹ä¸€ä¸‹<code>module_init</code>çš„å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//include/qemu/module.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define module_init(function, type)                                         \
</span></span></span><span class="line"><span class="cl"><span class="cp">static void __attribute__((constructor)) do_qemu_init_ ## function(void)    \
</span></span></span><span class="line"><span class="cl"><span class="cp">{                                                                           \
</span></span></span><span class="line"><span class="cl"><span class="cp">    register_module_init(function, type);                                   \
</span></span></span><span class="line"><span class="cl"><span class="cp">}
</span></span></span></code></pre></div><p><code>module_init</code> æœ€ç»ˆè¦è°ƒç”¨ <code>register_module_init</code>ã€‚å±äº <code>MODULE_INIT_QOM</code> è¿™ç§ç±»å‹çš„ï¼Œæœ‰ä¸€ä¸ª <code>Module</code> åˆ—è¡¨ <code>ModuleTypeList</code>ï¼Œåˆ—è¡¨é‡Œé¢æ˜¯ä¸€é¡¹ä¸€é¡¹çš„ <code>ModuleEntry</code>ã€‚<code>KVM</code> å°±æ˜¯å…¶ä¸­ä¸€é¡¹ï¼Œå¹¶ä¸”ä¼šåˆå§‹åŒ–æ¯ä¸€é¡¹çš„ <code>init</code> å‡½æ•°ä¸ºå‚æ•°è¡¨ç¤ºçš„å‡½æ•° <code>fn</code>ï¼Œä¹Ÿå³ <code>KVM</code> è¿™ä¸ª <code>module</code> çš„ <code>init</code> å‡½æ•°å°±æ˜¯ <code>kvm_type_init</code>ã€‚</p>
<p>å½“ç„¶ï¼Œ<code>MODULE_INIT_QOM</code> è¿™ç§ç±»å‹ä¼šæœ‰å¾ˆå¤šå¾ˆå¤šçš„ <code>module</code>ï¼Œä»åé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰€æœ‰è°ƒç”¨ <code>type_init</code> çš„åœ°æ–¹éƒ½æ³¨å†Œäº†ä¸€ä¸ª <code>MODULE_INIT_QOM</code> ç±»å‹çš„ <code>Module</code>ã€‚</p>
<p>äº†è§£äº† <code>Module</code> çš„æ³¨å†Œæœºåˆ¶ï¼Œæˆ‘ä»¬ç»§ç»­å›åˆ° <code>qemu_init_subsystems</code> å‡½æ•°ä¸­ <code>module_call_init</code> çš„è°ƒç”¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">qemu_init_subsystems</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Error</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">os_set_line_buffering</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">module_call_init</span><span class="p">(</span><span class="n">MODULE_INIT_TRACE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_init_cpu_list</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_init_cpu_loop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_mutex_lock_iothread</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">atexit</span><span class="p">(</span><span class="n">qemu_run_exit_notifiers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">module_call_init</span><span class="p">(</span><span class="n">MODULE_INIT_QOM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">module_call_init</span><span class="p">(</span><span class="n">MODULE_INIT_MIGRATION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// utils/module.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">module_call_init</span><span class="p">(</span><span class="n">module_init_type</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ModuleTypeList</span> <span class="o">*</span><span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ModuleEntry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">l</span> <span class="o">=</span> <span class="nf">find_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">QTAILQ_FOREACH</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨ <code>module_call_init</code> ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° <code>MODULE_INIT_QOM</code> è¿™ç§ç±»å‹å¯¹åº”çš„ <code>ModuleTypeList</code>ï¼Œæ‰¾å‡ºåˆ—è¡¨ä¸­æ‰€æœ‰çš„ <code>ModuleEntry</code>ï¼Œç„¶åè°ƒç”¨æ¯ä¸ª <code>ModuleEntry</code> çš„ <code>init</code> å‡½æ•°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ <code>module_call_init</code> è°ƒç”¨çš„è¿™ä¸€æ­¥ï¼Œæ‰€æœ‰ <code>Module</code> çš„ <code>init</code> å‡½æ•°éƒ½å·²ç»è¢«è°ƒç”¨è¿‡äº†ã€‚</p>
<p>åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°å¾ˆå¤šçš„ <code>Module</code>ï¼Œå½“æˆ‘ä»¬åé¢å†æ¬¡é‡åˆ°æ—¶ï¼Œéœ€è¦æ„è¯†åˆ°ï¼Œå®ƒçš„ <code>init</code> å‡½æ•°åœ¨è¿™é‡Œä¹Ÿè¢«è°ƒç”¨è¿‡äº†ã€‚è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥å¯¹äº <code>kvm</code> è¿™ä¸ª <code>module</code> ä¸ºä¾‹å­ï¼Œçœ‹çœ‹å®ƒçš„ <code>init</code> å‡½æ•°éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚æˆ‘ä»¬ä¼šå‘ç°ï¼Œå…¶å®å®ƒè°ƒç”¨çš„æ˜¯ <code>kvm_type_init</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_type_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm_accel_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">TypeImpl</span> <span class="o">*</span><span class="nf">type_register_static</span><span class="p">(</span><span class="k">const</span> <span class="n">TypeInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">type_register</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">TypeImpl</span> <span class="o">*</span><span class="nf">type_register</span><span class="p">(</span><span class="k">const</span> <span class="n">TypeInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">type_register_internal</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">TypeImpl</span> <span class="o">*</span><span class="nf">type_register_internal</span><span class="p">(</span><span class="k">const</span> <span class="n">TypeInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">ti</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span> <span class="o">=</span> <span class="nf">type_new</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="nf">type_table_add</span><span class="p">(</span><span class="n">ti</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ti</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">TypeImpl</span> <span class="o">*</span><span class="nf">type_new</span><span class="p">(</span><span class="k">const</span> <span class="n">TypeInfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="nf">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ti</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">type_table_lookup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nf">g_strdup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nf">g_strdup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">class_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">instance_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">instance_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">class_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_base_init</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">class_base_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">class_data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">class_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">instance_init</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">instance_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">instance_post_init</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">instance_post_init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">instance_finalize</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">instance_finalize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">abstract</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">abstract</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">interfaces</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ti</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">typename</span> <span class="o">=</span> <span class="nf">g_strdup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">interfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ti</span><span class="o">-&gt;</span><span class="n">num_interfaces</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ti</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">type_table_add</span><span class="p">(</span><span class="n">TypeImpl</span> <span class="o">*</span><span class="n">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assert</span><span class="p">(</span><span class="o">!</span><span class="n">enumerating_types</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">g_hash_table_insert</span><span class="p">(</span><span class="nf">type_table_get</span><span class="p">(),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ti</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">GHashTable</span> <span class="o">*</span><span class="nf">type_table_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">GHashTable</span> <span class="o">*</span><span class="n">type_table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">type_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">type_table</span> <span class="o">=</span> <span class="nf">g_hash_table_new</span><span class="p">(</span><span class="n">g_str_hash</span><span class="p">,</span> <span class="n">g_str_equal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">type_table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">kvm_accel_type</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TYPE_KVM_ACCEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">TYPE_ACCEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">class_init</span> <span class="o">=</span> <span class="n">kvm_accel_class_init</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">instance_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KVMState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼šè™šçº¿è¡¨ç¤ºè¿”å›</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210907133931.svg">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210907133931.svg" alt=""  />
</a>
</div>

</p>
<p>æ¯ä¸€ä¸ª <code>Module</code> æ—¢ç„¶è¦æ¨¡æ‹ŸæŸç§è®¾å¤‡ï¼Œé‚£åº”è¯¥å®šä¹‰ä¸€ç§ç±»å‹ <code>TypeImpl</code> æ¥è¡¨ç¤ºè¿™äº›è®¾å¤‡ï¼Œè¿™å…¶å®æ˜¯ä¸€ç§<code>é¢å‘å¯¹è±¡ç¼–ç¨‹</code>çš„æ€è·¯ï¼Œåªä¸è¿‡è¿™é‡Œç”¨çš„æ˜¯çº¯ C è¯­è¨€çš„å®ç°ï¼Œæ‰€ä»¥éœ€è¦å˜ç›¸å®ç°ä¸€ä¸‹ç±»å’Œå¯¹è±¡ã€‚</p>
<p><code>kvm_type_init</code> ä¼šæ³¨å†Œ <code>kvm_accel_type</code>ï¼Œå®šä¹‰ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™æ ·åŠ¨æ€å®šä¹‰äº†ä¸€ä¸ªç±»ã€‚è¿™ä¸ªç±»çš„åå­—æ˜¯ <code>TYPE_KVM_ACCEL</code>ï¼Œè¿™ä¸ªç±»æœ‰çˆ¶ç±» <code>TYPE_ACCEL</code>ï¼Œè¿™ä¸ªç±»çš„åˆå§‹åŒ–åº”è¯¥è°ƒç”¨å‡½æ•° <code>kvm_accel_class_init</code>ã€‚å¦‚æœç”¨è¿™ä¸ªç±»å£°æ˜ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„å¤§å°åº”è¯¥æ˜¯ <code>instance_size</code>ã€‚</p>
<p>åœ¨ <code>type_register_internal</code> ä¸­ï¼Œæˆ‘ä»¬ä¼šæ ¹æ® <code>kvm_accel_type</code> è¿™ä¸ª <code>TypeInfo</code>ï¼Œåˆ›å»ºä¸€ä¸ª<code>TypeImpl</code> æ¥è¡¨ç¤ºè¿™ä¸ªæ–°æ³¨å†Œçš„ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>TypeImpl</code> æ‰æ˜¯æˆ‘ä»¬æƒ³è¦å£°æ˜çš„é‚£ä¸ª <code>class</code>ã€‚åœ¨ qemu é‡Œé¢ï¼Œæœ‰ä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ <code>type_table</code>ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å®šä¹‰çš„ç±»ã€‚åœ¨ <code>type_new</code> é‡Œé¢ï¼Œæˆ‘ä»¬å…ˆä»å…¨å±€è¡¨é‡Œé¢æ ¹æ®åå­—<code>type_table_lookup</code>æŸ¥æ‰¾æ‰¾è¿™ä¸ªç±»ã€‚å¦‚æœæ‰¾åˆ°ï¼Œè¯´æ˜è¿™ä¸ªç±»æ›¾ç»è¢«æ³¨å†Œè¿‡ï¼Œå°±æŠ¥é”™ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ–°çš„ç±»ï¼Œåˆ™å°† <code>TypeInfo</code> é‡Œé¢ä¿¡æ¯å¡«åˆ° <code>TypeImpl</code> é‡Œé¢ã€‚<code>type_table_add</code> ä¼šå°†è¿™ä¸ªç±»æ³¨å†Œåˆ°å…¨å±€çš„è¡¨é‡Œé¢ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ³¨æ„ï¼Œ<code>class_init</code> è¿˜æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä¹Ÿå³è¿™ä¸ªç±»ç°åœ¨è¿˜å¤„äºçº¸é¢çš„çŠ¶æ€ã€‚</p>
<p>è¿™ç‚¹æ›´åŠ åƒ Java çš„åå°„æœºåˆ¶äº†ã€‚åœ¨ Java é‡Œé¢ï¼Œå¯¹äºä¸€ä¸ªç±»ï¼Œé¦–å…ˆæˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™è¦å†™ä¸€ä¸ª <code>class xxx</code> çš„å®šä¹‰ï¼Œç¼–è¯‘å¥½å°±æ”¾åœ¨<code>.class</code> æ–‡ä»¶ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å‡ºäºçº¸é¢çš„çŠ¶æ€ã€‚ç„¶åï¼ŒJava ä¼šæœ‰ä¸€ä¸ª <code>Class</code> å¯¹è±¡ï¼Œç”¨äºè¯»å–å’Œè¡¨ç¤ºè¿™ä¸ªçº¸é¢ä¸Šçš„ <code>class xxx</code>ï¼Œå¯ä»¥ç”ŸæˆçœŸæ­£çš„å¯¹è±¡ã€‚</p>
<p>ç›¸åŒçš„è¿‡ç¨‹åœ¨åé¢çš„ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ<code>class_init</code> ä¼šç”Ÿæˆ<code>XXXClass</code>ï¼Œå°±ç›¸å½“äº Java é‡Œé¢çš„ <code>Class</code>å¯¹è±¡ï¼Œ<code>TypeImpl</code> è¿˜ä¼šæœ‰ä¸€ä¸ª <code>instance_init</code> å‡½æ•°ï¼Œç›¸å½“äºæ„é€ å‡½æ•°ï¼Œç”¨äºæ ¹æ® <code>XXXClass</code> ç”Ÿæˆ <code>Object</code>ï¼Œè¿™å°±ç›¸å½“äº Java åå°„é‡Œé¢æœ€ç»ˆåˆ›å»ºçš„å¯¹è±¡ã€‚å’Œæ„é€ å‡½æ•°å¯¹åº”çš„è¿˜æœ‰ <code>instance_finalize</code>ï¼Œç›¸å½“äºææ„å‡½æ•°ã€‚</p>
<p>è¿™ä¸€å¥—åå°„æœºåˆ¶æ”¾åœ¨ <code>qom</code> æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œå…¨ç§° <code>QEMU Object Model</code>ï¼Œä¹Ÿå³ç”¨ C å®ç°äº†ä¸€å¥—<strong>é¢å‘å¯¹è±¡çš„åå°„æœºåˆ¶</strong>ã€‚</p>
<h2 id="åˆå§‹åŒ–-machine">åˆå§‹åŒ– machine</h2>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210913115046.svg">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210913115046.svg" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//vl.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">qemu_create_machine</span> <span class="p">(</span><span class="nf">select_machine</span><span class="p">());</span>
</span></span></code></pre></div><p>åœ¨åˆ›å»º machine ä¹‹å‰ï¼Œå…ˆè¦é€šè¿‡<code>select_machine</code>ç¡®å®šä¸€ä¸ª<code>machine</code>ã€‚<code>select_machine</code>åˆæ˜¯æ€ä¹ˆç¡®å®šçš„å‘¢ï¼Œè¿™å°±å’Œæˆ‘ä»¬å‘½ä»¤è¡Œçš„è¾“å…¥æœ‰å…³ï¼Œæ¯”å¦‚æˆ‘ä»¬<code>-m spike</code>ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šé€‰æ‹©<code>spike</code>ä½œä¸º<code>machine</code>ã€‚å®ƒçš„å®šä¹‰åœ¨<code>hw/riscv/spike.c</code>ä¸­ã€‚</p>
<p>åœ¨æºç æœ€åæœ‰è¿™ä¹ˆä¸€å¥ï¼Œä¼šå’Œæˆ‘ä»¬ä¸Šé¢è§£æçš„<code>type_init</code> æ˜¯ä¸€æ ·çš„ï¼Œåœ¨å…¨å±€çš„è¡¨é‡Œé¢æ³¨å†Œäº†ä¸€ä¸ªå…¨å±€çš„åå­—æ˜¯<code>spike</code>çš„çº¸é¢ä¸Šçš„ <code>class</code>ï¼Œä¹Ÿå³ <code>TypeImpl</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">type_init</span><span class="p">(</span><span class="n">spike_machine_init_reqister_types</span><span class="p">)</span>
</span></span></code></pre></div><p>ç°åœ¨å…¨å±€è¡¨ä¸­æœ‰è¿™ä¸ªçº¸é¢ä¸Šçš„ <code>class</code> äº†ã€‚æˆ‘ä»¬å›åˆ° <code>select_machine</code>ã€‚</p>
<p>åœ¨ <code>select_machine</code> ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”Ÿæˆ <code>MachineClass</code>ã€‚ä¸€ç§æ–¹å¼æ˜¯ <code>find_default_machine</code>ï¼Œæ‰¾ä¸€ä¸ªé»˜è®¤çš„ï¼›å¦ä¸€ç§æ–¹å¼æ˜¯ <code>machine_parse</code>ï¼Œé€šè¿‡è§£æå‚æ•°ç”Ÿæˆ <code>MachineClass</code>ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œéƒ½ä¼šè°ƒç”¨ <code>object_class_get_list</code> è·å¾—ä¸€ä¸ª <code>MachineClass</code> çš„åˆ—è¡¨ï¼Œç„¶ååœ¨é‡Œé¢æ‰¾ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">MachineClass</span> <span class="o">*</span><span class="nf">select_machine</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GSList</span> <span class="o">*</span><span class="n">machines</span> <span class="o">=</span> <span class="nf">object_class_get_list</span><span class="p">(</span><span class="n">TYPE_MACHINE</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">machine_class</span> <span class="o">=</span> <span class="nf">find_default_machine</span><span class="p">(</span><span class="n">machines</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">QemuOpts</span> <span class="o">*</span><span class="n">opts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Location</span> <span class="n">loc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">loc_push_none</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">opts</span> <span class="o">=</span> <span class="nf">qemu_get_machine_opts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">qemu_opts_loc_restore</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">optarg</span> <span class="o">=</span> <span class="nf">qemu_opt_get</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#34;type&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">machine_class</span> <span class="o">=</span> <span class="nf">machine_parse</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">machines</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_class</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">error_report</span><span class="p">(</span><span class="s">&#34;No machine specified, and there is no default&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">error_printf</span><span class="p">(</span><span class="s">&#34;Use -machine help to list supported machines</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">loc_pop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">g_slist_free</span><span class="p">(</span><span class="n">machines</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">machine_class</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">MachineClass</span> <span class="o">*</span><span class="nf">find_default_machine</span><span class="p">(</span><span class="n">GSList</span> <span class="o">*</span><span class="n">machines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GSList</span> <span class="o">*</span><span class="n">el</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">default_machineclass</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">el</span> <span class="o">=</span> <span class="n">machines</span><span class="p">;</span> <span class="n">el</span><span class="p">;</span> <span class="n">el</span> <span class="o">=</span> <span class="n">el</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="n">el</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">is_default</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">assert</span><span class="p">(</span><span class="n">default_machineclass</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="s">&#34;Multiple default machines&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">default_machineclass</span> <span class="o">=</span> <span class="n">mc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">default_machineclass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">MachineClass</span> <span class="o">*</span><span class="nf">machine_parse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">GSList</span> <span class="o">*</span><span class="n">machines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GSList</span> <span class="o">*</span><span class="n">el</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">is_help_option</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Supported machines are:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">machines</span> <span class="o">=</span> <span class="nf">g_slist_sort</span><span class="p">(</span><span class="n">machines</span><span class="p">,</span> <span class="n">machine_class_cmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">el</span> <span class="o">=</span> <span class="n">machines</span><span class="p">;</span> <span class="n">el</span><span class="p">;</span> <span class="n">el</span> <span class="o">=</span> <span class="n">el</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="n">el</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mc</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%-20s %s (alias of %s)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%-20s %s%s%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mc</span><span class="o">-&gt;</span><span class="n">is_default</span> <span class="o">?</span> <span class="s">&#34; (default)&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">mc</span><span class="o">-&gt;</span><span class="n">deprecation_reason</span> <span class="o">?</span> <span class="s">&#34; (deprecated)&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mc</span> <span class="o">=</span> <span class="nf">find_machine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">machines</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">error_report</span><span class="p">(</span><span class="s">&#34;unsupported machine type&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">error_printf</span><span class="p">(</span><span class="s">&#34;Use -machine help to list supported machines</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>object_class_get_list</code> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">GSList</span> <span class="o">*</span><span class="nf">object_class_get_list</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">implements_type</span><span class="p">,</span><span class="kt">bool</span> <span class="n">include_abstract</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GSList</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">object_class_foreach</span><span class="p">(</span><span class="n">object_class_get_list_tramp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">implements_type</span><span class="p">,</span> <span class="n">include_abstract</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">object_class_foreach</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">implements_type</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">include_abstract</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OCFData</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">fn</span><span class="p">,</span> <span class="n">implements_type</span><span class="p">,</span> <span class="n">include_abstract</span><span class="p">,</span> <span class="n">opaque</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">enumerating_types</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">g_hash_table_foreach</span><span class="p">(</span><span class="nf">type_table_get</span><span class="p">(),</span> <span class="n">object_class_foreach_tramp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">enumerating_types</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨å…¨å±€è¡¨ <code>type_table_get()</code> ä¸­ï¼Œå¯¹äºæ¯ä¸€é¡¹ <code>TypeImpl</code>ï¼Œæˆ‘ä»¬éƒ½æ‰§è¡Œ <code>object_class_foreach_tramp</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">object_class_foreach_tramp</span><span class="p">(</span><span class="n">gpointer</span> <span class="n">key</span><span class="p">,</span> <span class="n">gpointer</span> <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">gpointer</span> <span class="n">opaque</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OCFData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TypeImpl</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectClass</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">type_initialize</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">k</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">include_abstract</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">abstract</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">implements_type</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="nf">object_class_dynamic_cast</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">implements_type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">-&gt;</span><span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">opaque</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨ <code>object_class_foreach_tramp</code> ä¸­ï¼Œä¼šè°ƒç”¨å°† <code>type_initialize</code>ï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨ <code>class_init</code> å°†çº¸é¢ä¸Šçš„ <code>class</code> ä¹Ÿå³ <code>TypeImpl</code> å˜ä¸º <code>ObjectClass</code>ï¼Œ<code>ObjectClass</code> æ˜¯æ‰€æœ‰<code>Class</code> ç±»çš„ç¥–å…ˆï¼Œ<code>MachineClass</code> æ˜¯å®ƒçš„å­ç±»ã€‚</p>
<p>å› ä¸ºåœ¨ <code>machine</code> çš„å‘½ä»¤è¡Œé‡Œé¢ï¼Œæˆ‘ä»¬æŒ‡å®šäº†åå­—ä¸º<code>spike</code>ï¼Œå°±è‚¯å®šèƒ½å¤Ÿæ‰¾åˆ°æˆ‘ä»¬æ³¨å†Œè¿‡äº†çš„ <code>TypeImpl</code>ï¼Œå¹¶è°ƒç”¨å®ƒçš„ <code>class_init</code> å‡½æ•°ã€‚</p>
<p>æ‰€ä»¥ï¼Œå½“ <code>select_machine</code> æ‰§è¡Œå®Œæ¯•åï¼Œå°±æœ‰ä¸€ä¸ª <code>MachineClass</code> äº†ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬å›åˆ° <code>qemu_create_machine</code> ä¸­çš„<code>object_new_with_class</code>ã€‚è¿™å°±å¾ˆå¥½ç†è§£äº†ï¼Œ<code>MachineClass</code> æ˜¯ä¸€ä¸ª <code>Class</code> ç±»ï¼Œæ¥ä¸‹æ¥åº”è¯¥é€šè¿‡å®ƒç”Ÿæˆä¸€ä¸ª <code>Instance</code>ï¼Œä¹Ÿå³å¯¹è±¡ï¼Œè¿™å°±æ˜¯ <code>object_new_with_class</code> çš„ä½œç”¨ã€‚</p>
<p><code>object_new_with_class</code> ä¸­ï¼Œ<code>TypeImpl</code> çš„ <code>instance_init</code> ä¼šè¢«è°ƒç”¨ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚<code>current_machine</code> å°±æ˜¯è¿™ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ç±»å‹æ˜¯<code>MachineState</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Object</span> <span class="o">*</span><span class="nf">object_new_with_class</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">klass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">object_new_with_type</span><span class="p">(</span><span class="n">klass</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">Object</span> <span class="o">*</span><span class="nf">object_new_with_type</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">type_initialize</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">obj</span> <span class="o">=</span> <span class="nf">g_malloc</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">instance_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">object_initialize_with_type</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">instance_size</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">free</span> <span class="o">=</span> <span class="n">g_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œç»•äº†è¿™ä¹ˆå¤§ä¸€åœˆï¼Œæœ‰å…³ä½“ç³»ç»“æ„çš„å¯¹è±¡æ‰åˆ›å»ºå®Œæ¯•ï¼Œæ¥ä¸‹æ¥å¾ˆå¤šçš„è®¾å¤‡çš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ CPU å’Œå†…å­˜çš„åˆå§‹åŒ–ï¼Œéƒ½æ˜¯å›´ç»•ç€ä½“ç³»ç»“æ„çš„å¯¹è±¡æ¥çš„ï¼Œåé¢æˆ‘ä»¬ä¼šå¸¸å¸¸çœ‹åˆ°<code>current_machine</code>ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220308180036.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20220308180036.png" alt=""  />
</a>
</div>

</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://www.cnblogs.com/nm90/p/15661202.html">Qemu CPU è™šæ‹ŸåŒ– - äººç”Ÿä¸€ä¸–ï¼Œè‰æœ¨ä¸€ç§‹ã€‚ - åšå®¢å›­</a>
<a href="https://www.cnblogs.com/LoyenWang/p/13796537.html">ã€åŸåˆ›ã€‘Linux è™šæ‹ŸåŒ– KVM-Qemu åˆ†æï¼ˆå››ï¼‰ä¹‹ CPU è™šæ‹ŸåŒ–ï¼ˆ2ï¼‰ - LoyenWang - åšå®¢å›­</a></p>
]]></content:encoded>
    </item>
    <item>
      <title>VSCode å•æ­¥è°ƒè¯• QEMU</title>
      <link>https://lifeislife.cn/posts/vscode%E5%8D%95%E6%AD%A5%E8%B0%83%E8%AF%95qemu/</link>
      <pubDate>Tue, 24 Aug 2021 19:24:08 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/vscode%E5%8D%95%E6%AD%A5%E8%B0%83%E8%AF%95qemu/</guid>
      <description>äº†è§£äº†å¦‚ä½•åœ¨VSCode ä¸­è°ƒè¯•ç¨‹åºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ VSCode ä¸­æ­å»ºè°ƒè¯• QEMU çš„ç¯å¢ƒã€‚ é…ç½® é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸‹è½½å’Œç¼–è¯‘ QEMU æºç  ./configure --enable-debug --target-list=riscv32-softmmu,riscv32-linux-user --enable-kvm ä¸€å®šè¦åŠ ä¸Š--enable-d</description>
      <content:encoded><![CDATA[<p>äº†è§£äº†å¦‚ä½•åœ¨<a href="https://dunky-z.github.io/2021/08/23/VSCode%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F/">VSCode ä¸­è°ƒè¯•ç¨‹åº</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ VSCode ä¸­æ­å»ºè°ƒè¯• QEMU çš„ç¯å¢ƒã€‚</p>
<h2 id="é…ç½®">é…ç½®</h2>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦<a href="https://dunky-z.github.io/2021/07/23/QEMU%E5%88%9D%E8%AF%86/">ä¸‹è½½å’Œç¼–è¯‘ QEMU æºç </a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./configure --enable-debug --target-list=riscv32-softmmu,riscv32-linux-user --enable-kvm
</span></span></code></pre></div><p>ä¸€å®šè¦åŠ ä¸Š<code>--enable-debug</code>ï¼Œç¼–è¯‘å‡ºçš„ç¨‹åºæ‰å¸¦æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œä¸ç”¨è®¾ç½®å®‰è£…è·¯å¾„ï¼Œç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨åœ¨ qemu æ–‡ä»¶å¤¹ä¸‹è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>build</code>æ–‡ä»¶å¤¹ï¼Œç¼–è¯‘åçš„ç¨‹åºä¹Ÿåœ¨<code>build</code>æ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<p>ç”¨ VSCode æ‰“å¼€<code>qemu-6.X.X</code>æ–‡ä»¶å¤¹ï¼Œ<code>Ctrl+Shift+D</code>æ‰“å¼€è°ƒè¯•é…ç½®ã€‚å¦‚æœå‚è€ƒè¿‡<a href="https://dunky-z.github.io/2021/08/23/VSCode%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F/">VSCode ä¸­è°ƒè¯•ç¨‹åº</a>è¿™ç¯‡æ–‡ç« ï¼Œæ¥ä¸‹æ¥å°±å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬åªéœ€è¦å°†<code>launch.jason</code>æ–‡ä»¶ä¸­çš„<code>program</code>å±æ€§æ”¹ä¸º<code>${workspaceFolder}/build/qemu-system-riscv32</code>å³å¯ã€‚</p>
<h2 id="è°ƒè¯•">è°ƒè¯•</h2>
<p>æ‰“å¼€<code>qemu-6.X.X/softmmu/main.c</code>æ–‡ä»¶ï¼Œåœ¨<code>main</code>å‡½æ•°å…¥å£å¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œå³å¯å¼€å§‹è°ƒè¯•ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210824194442.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210824194442.png" alt=""  />
</a>
</div>

</p>
<p>ç°åœ¨åªéœ€è¦ç‚¹å‡»å±å¹•ä¸Šçš„å›¾æ ‡ï¼Œå°±å¯ä»¥å¿«é€Ÿçš„è¿›è¡Œå•æ­¥è°ƒè¯•ã€‚</p>
<p>å¦‚æœéœ€è¦è¿›è¡Œå‘½ä»¤è¡Œæ“ä½œï¼Œåœ¨å±å¹•ä¸‹æ–¹æ‰“å¼€<code>DEBUG CONSOLE</code>ï¼Œè¾“å…¥<code>-exec+æ­£å¸¸å‘½ä»¤è¡Œä¸‹çš„å‘½ä»¤</code>å³å¯åœ¨å‘½ä»¤è¡Œä¸­è¿›è¡Œæ›´å¤šçš„è°ƒè¯•ã€‚å¦‚æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯<code>-exec info breakpoints</code></p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210824201427.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210824201427.png" alt=""  />
</a>
</div>

</p>
]]></content:encoded>
    </item>
    <item>
      <title>åœ¨ QEMU ä¸Šè¿è¡Œ 64 ä½å’Œ 32 ä½ RISC-V-Linux</title>
      <link>https://lifeislife.cn/posts/qemu%E4%B8%8A%E8%BF%90%E8%A1%8C64%E4%BD%8D%E5%92%8C32%E4%BD%8Drisc-v-linux/</link>
      <pubDate>Wed, 28 Jul 2021 13:47:56 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E4%B8%8A%E8%BF%90%E8%A1%8C64%E4%BD%8D%E5%92%8C32%E4%BD%8Drisc-v-linux/</guid>
      <description>åˆ¶ä½œäº¤å‰å·¥å…·é“¾ riscv-gnu-toolchain ä¸‹è½½æºç  è¿™ä¸ªä»“åº“æ˜¯æˆ‘é‡åˆ°çš„æœ€éš¾ä¸‹è½½çš„ä¸€ä¸ªä»“åº“äº†ï¼Œå…¬å¸ç½‘æ…¢å’Œè™šæ‹Ÿæœºæ€§èƒ½å·®éƒ½è„±ä¸äº†å¹²ç³»ã€‚ä¼°è®¡ä¸‹è½½äº†äº”å°æ—¶éƒ½ä¸æ­¢ï¼Œåˆšå¼€å§‹è¿˜æŒ‡æœ›ä¸€ä¸ª</description>
      <content:encoded><![CDATA[<h2 id="åˆ¶ä½œäº¤å‰å·¥å…·é“¾-riscv-gnu-toolchain">åˆ¶ä½œäº¤å‰å·¥å…·é“¾ riscv-gnu-toolchain</h2>
<h3 id="ä¸‹è½½æºç ">ä¸‹è½½æºç </h3>
<p>è¿™ä¸ªä»“åº“æ˜¯æˆ‘é‡åˆ°çš„æœ€éš¾ä¸‹è½½çš„ä¸€ä¸ªä»“åº“äº†ï¼Œå…¬å¸ç½‘æ…¢å’Œè™šæ‹Ÿæœºæ€§èƒ½å·®éƒ½è„±ä¸äº†å¹²ç³»ã€‚ä¼°è®¡ä¸‹è½½äº†äº”å°æ—¶éƒ½ä¸æ­¢ï¼Œåˆšå¼€å§‹è¿˜æŒ‡æœ›ä¸€ä¸ªå‘½ä»¤æ‰€æœ‰å­æ¨¡å—éƒ½ä¸‹è½½å®Œçš„ï¼Œç»“æœæ„£æ˜¯ç­‰äº†åŠå¤©ä¸­æ–­äº†ã€‚è¯•äº†ä¸¤æ¬¡åæ”¾å¼ƒäº†ã€‚å¦‚æœå„ä½çœ‹å®˜èƒ½ä¸€æ¬¡å®Œæˆï¼Œé‚£æ‚¨æ˜¯ç¦å¤§ã€‚</p>
<p>å›½å†…çš„ç äº‘å¹³å°æœ‰ä¸ª<a href="https://gitee.com/organizations/mirrors/projects">Gitee æé€Ÿä¸‹è½½</a>é¡¹ç›®ï¼Œä¸Šé¢æœ‰ GitHub çš„ä¸€äº›å¸¸ç”¨å¼€æºé¡¹ç›®çš„é•œåƒï¼Œå¯ä¾›åŠ é€Ÿä¸‹è½½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># riscv-gnu-toolchain</span>
</span></span><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gitee</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">mirrors</span><span class="o">/</span><span class="n">riscv</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">toolchain</span><span class="o">.</span><span class="n">git</span>
</span></span></code></pre></div><p>ä¸‹è½½æ—¶é—®é¢˜å‡ºç°äº†ï¼Œå¦‚æœä¸‹è½½å­æ¨¡å—ä»ç„¶ä¼šå¡ä½ï¼Œå¦‚æœä¸åŠ <code>--recursive</code>å°±åªèƒ½ä¸‹è½½ä¸»ä½“å†…å®¹ï¼Œå­æ¨¡å—éƒ½æ²¡æœ‰ã€‚ï¼ˆ<strong>ä»¥ä¸‹å†…å®¹ä¸ºç¬¬ä¸€å®‰è£…æ—¶çš„æ–¹æ³•ï¼Œåç»­åˆæ‰¾åˆ°äº†<a href="">git clone å¿«é€Ÿä¸‹è½½å­æ¨¡å—</a>çš„æ–¹æ³•</strong>ï¼‰</p>
<p>å¼€å§‹ä¸‹è½½æ—¶ä¸åŠ <code>--recursive</code>å‚æ•°ï¼Œåªä¸‹è½½<code>riscv-gnu-toolchain</code>çš„ä¸»ä½“å†…å®¹ï¼Œç„¶åè¿›å…¥åˆ°<code>riscv-gnu-toolchain</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰‹åŠ¨ä¸‹è½½å­æ¨¡å—çš„å†…å®¹ã€‚</p>
<p>å½“ä¸‹å®Œ<code>riscv-binutils</code>ç»§ç»­ä¸‹è½½<code>riscv-gdb</code>æ—¶å‘ç°è¿™ä¸¤ä¸ªé¡¹ç›®æ˜¯åŒä¸€ä¸ªé¡¹ç›®ï¼Œåªæ˜¯ä¸åŒçš„åˆ†æ”¯ã€‚ä½†æ˜¯ç äº‘ä¸Šå¹¶æ²¡æœ‰åŒºåˆ†ï¼Œä½†æ˜¯æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°åœ¨ç äº‘ä¸Šçš„å¯¹åº”åˆ†æ”¯ã€‚åªèƒ½ç”¨æ²¹çŒ´è„šæœ¬äº†ã€‚</p>
<p>å¦‚æœä½ æœ‰æ²¹çŒ´æ’ä»¶å¯ä»¥å»<a href="https://greasyfork.org/zh-CN">greasyfork</a>æœç´¢å®‰è£…<strong>GitHub é•œåƒè®¿é—®ï¼ŒåŠ é€Ÿä¸‹è½½</strong>è¿™ä¸ªè„šæœ¬ï¼Œåˆ·æ–° GitHub ä»“åº“ç•Œé¢å°±ä¼šå¤šå‡ºå‡ ä¸ªé•œåƒåœ°å€ï¼Œä¸€èˆ¬ä¸‹è½½éƒ½ä¼šå¿«å¥½å‡ å€ã€‚å¦‚æœä¸ç”¨æ²¹çŒ´æ’ä»¶çš„å¯ä»¥ç”¨æˆ‘å¤åˆ¶å¥½çš„é“¾æ¥ã€‚</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210728155417.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210728155417.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># riscv-binutils
</span></span><span class="line"><span class="cl">git clone https://gitee.com/mirrors/riscv-binutils-gdb.git
</span></span><span class="line"><span class="cl"># riscv-gcc
</span></span><span class="line"><span class="cl">git clone https://gitee.com/mirrors/riscv-gcc.git
</span></span><span class="line"><span class="cl"># riscv-dejagnu
</span></span><span class="line"><span class="cl">git clone https://gitee.com/mirrors/riscv-dejagnu.git
</span></span><span class="line"><span class="cl"># riscv-glibc
</span></span><span class="line"><span class="cl">git clone https://gitee.com/mirrors/riscv-glibc.git
</span></span><span class="line"><span class="cl"># riscv-newlib
</span></span><span class="line"><span class="cl">git clone https://gitee.com/mirrors/riscv-newlib.git
</span></span><span class="line"><span class="cl"># riscv-gdb
</span></span><span class="line"><span class="cl">git clone --depth=1 https://hub.fastgit.org/riscv/riscv-binutils-gdb.git
</span></span></code></pre></div><h3 id="ç¼–è¯‘-riscv-gnu-toolchain">ç¼–è¯‘ riscv-gnu-toolchain</h3>
<p>æå‰å®‰è£…å¦‚ä¸‹è½¯ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">autoconf</span> <span class="n">automake</span> <span class="n">autotools</span><span class="o">-</span><span class="n">dev</span> <span class="n">curl</span> <span class="n">python3</span> <span class="n">libmpc</span><span class="o">-</span><span class="n">dev</span> <span class="n">libmpfr</span><span class="o">-</span><span class="n">dev</span> <span class="n">libgmp</span><span class="o">-</span><span class="n">dev</span> <span class="n">gawk</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">bison</span> <span class="n">flex</span> <span class="n">texinfo</span> <span class="n">gperf</span> <span class="n">libtool</span> <span class="n">patchutils</span> <span class="n">bc</span> <span class="n">zlib1g</span><span class="o">-</span><span class="n">dev</span> <span class="n">libexpat</span><span class="o">-</span><span class="n">dev</span>
</span></span></code></pre></div><p>ä¸å¬è€äººè¨€ï¼Œåƒäºåœ¨çœ¼å‰å‘€ï¼Œæœ¬ä»¥ä¸ºè¿™æ˜¯å¯é€‰é¡¹ï¼Œå¾ˆå¤šåº“éƒ½å®‰è£…äº†ï¼Œå°±æ²¡æœ‰æ“ä½œè¿™ä¸€æ­¥ï¼Œç»“æœå°±æ˜¯ç¼–è¯‘åŠå¤©ç»“æœè¿˜é”™äº†ã€‚å¦‚æœæŠ¥<code>make é”™è¯¯ 127</code>ï¼Œé‚£å°±è€è€å®å®æŠŠå‰ç½®çš„è¿™äº›åº“éƒ½è£…ä¸Šã€‚</p>
<p>å»ºç«‹<code>riscv-gnu-toolchain</code>å®‰è£…ç›®å½•<code>/opt/riscv64</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./configure --prefix=/opt/riscv64 
</span></span><span class="line"><span class="cl">sudo make linux -j8
</span></span></code></pre></div><h3 id="å¯¼å‡ºå®‰è£…è·¯å¾„">å¯¼å‡ºå®‰è£…è·¯å¾„</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">export</span> <span class="n">PATH</span><span class="o">=</span><span class="s2">&#34;$PATH:/opt/riscv64/bin&#34;</span>
</span></span></code></pre></div><p>å‡ºç°ä¸€ä¸‹ä¿¡æ¯è¡¨ç¤ºå®‰è£…æˆåŠŸã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">specs</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">COLLECT_GCC</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span>
</span></span><span class="line"><span class="cl"><span class="n">COLLECT_LTO_WRAPPER</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">riscv64</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mf">10.2</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lto</span><span class="o">-</span><span class="n">wrapper</span>
</span></span><span class="line"><span class="cl"><span class="n">Target</span><span class="p">:</span> <span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span>
</span></span><span class="line"><span class="cl"><span class="n">Configured</span> <span class="n">with</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">dominic</span><span class="o">/</span><span class="n">riscv64</span><span class="o">-</span><span class="n">linux</span><span class="o">/</span><span class="n">riscv</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">toolchain</span><span class="o">/</span><span class="n">riscv</span><span class="o">-</span><span class="n">gcc</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">riscv64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">riscv64</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">sysroot</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">riscv64</span><span class="o">/</span><span class="n">sysroot</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">zlib</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">shared</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">tls</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">languages</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">++</span><span class="p">,</span><span class="n">fortran</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">libmudflap</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">libssp</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">libquadmath</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">libsanitizer</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">nls</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">bootstrap</span> <span class="o">--</span><span class="n">src</span><span class="o">=.././</span><span class="n">riscv</span><span class="o">-</span><span class="n">gcc</span> <span class="o">--</span><span class="n">disable</span><span class="o">-</span><span class="n">multilib</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">abi</span><span class="o">=</span><span class="n">lp64d</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">arch</span><span class="o">=</span><span class="n">rv64imafdc</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">tune</span><span class="o">=</span><span class="n">rocket</span> <span class="s1">&#39;CFLAGS_FOR_TARGET=-O2   -mcmodel=medlow&#39;</span> <span class="s1">&#39;CXXFLAGS_FOR_TARGET=-O2   -mcmodel=medlow&#39;</span>
</span></span><span class="line"><span class="cl"><span class="ne">Thread</span> <span class="n">model</span><span class="p">:</span> <span class="n">posix</span>
</span></span><span class="line"><span class="cl"><span class="n">Supported</span> <span class="n">LTO</span> <span class="n">compression</span> <span class="n">algorithms</span><span class="p">:</span> <span class="n">zlib</span>
</span></span><span class="line"><span class="cl"><span class="n">gcc</span> <span class="n">version</span> <span class="mf">10.2</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">GCC</span><span class="p">)</span> 
</span></span></code></pre></div><h2 id="åˆ¶ä½œå†…æ ¸">åˆ¶ä½œå†…æ ¸</h2>
<h3 id="ä¸‹è½½-linux-å†…æ ¸">ä¸‹è½½ Linux å†…æ ¸</h3>
<p>makefile</p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU æ–‡æ¡£</title>
      <link>https://lifeislife.cn/posts/qemu%E6%96%87%E6%A1%A3/</link>
      <pubDate>Tue, 27 Jul 2021 11:12:01 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E6%96%87%E6%A1%A3/</guid>
      <description>è°ƒç”¨æ–‡æ¡£ qemu-system-x86_64 [options] [disk_image] disk_imageæ˜¯ IDE ç¡¬ç›˜ 0 çš„åŸå§‹ç¡¬ç›˜æ˜ åƒã€‚æŸäº›ç›®æ ‡ä¸éœ€è¦ç£ç›˜æ˜ åƒã€‚ æ ‡å‡†å‚æ•° Standard options -h åŠŸèƒ½ æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º å­å‚æ•° è°ƒç”¨å®ä¾‹ qemu-system-riscv32 -h -version</description>
      <content:encoded><![CDATA[<h1 id="è°ƒç”¨æ–‡æ¡£">è°ƒç”¨æ–‡æ¡£</h1>
<p><code>qemu-system-x86_64 [options] [disk_image] </code>
<code>disk_image</code>æ˜¯ IDE ç¡¬ç›˜ 0 çš„åŸå§‹ç¡¬ç›˜æ˜ åƒã€‚æŸäº›ç›®æ ‡ä¸éœ€è¦ç£ç›˜æ˜ åƒã€‚</p>
<h2 id="æ ‡å‡†å‚æ•°-standard-options">æ ‡å‡†å‚æ•° Standard options</h2>
<h3 id="-h"><code>-h</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º</p>
</li>
<li>
<p>å­å‚æ•°</p>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-riscv32 -h
</span></span></code></pre></div></li>
</ul>
<h3 id="-version"><code>-version</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
æ˜¾ç¤º qemu ç‰ˆæœ¬ä¿¡æ¯å¹¶é€€å‡º</p>
</li>
<li>
<p>å­å‚æ•°</p>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-riscv32 -version
</span></span></code></pre></div></li>
</ul>
<h3 id="-machine-typenamepropvalue"><code>-machine [type=]name[,prop=value[,...]]</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
é€šè¿‡åç§°é€‰æ‹©æ¨¡æ‹Ÿå™¨ã€‚ä½¿ç”¨ <code>-machine help</code> å¯ä»¥æŸ¥çœ‹å¯ç”¨çš„æ¨¡æ‹Ÿå™¨ã€‚
å¯¹äºæ”¯æŒè·¨ç‰ˆæœ¬å®æ—¶è¿ç§»å…¼å®¹æ€§çš„æ¶æ„ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬åŒ–æ¨¡æ‹Ÿå™¨ç±»å‹ã€‚ä¾‹å¦‚ï¼Œ2.8.0 ç‰ˆæœ¬ä¸º <code>x86_64/i686</code> æ¶æ„å¼•å…¥äº†<code>â€œpc-i440fx-2.8â€</code>å’Œ<code>â€œpc-q35-2.8â€</code>ã€‚</p>
</li>
<li>
<p>å­å‚æ•°
ä¸ºäº†å…è®¸ç”¨æˆ·ä» QEMU 2.8.0 ç‰ˆå®æ—¶è¿ç§»åˆ° QEMU 2.9.0 ç‰ˆï¼Œ2.9.0 ç‰ˆä¹Ÿå¿…é¡»æ”¯æŒ<code>â€œpc-i440fx-2.8â€</code>å’Œ<code>â€œpc-q35-2.8â€</code>æœºå™¨ã€‚ä¸ºäº†å…è®¸ç”¨æˆ·åœ¨å‡çº§æ—¶å®æ—¶è¿ç§» VMs è·³è¿‡å¤šä¸ªä¸­é—´ç‰ˆæœ¬ï¼ŒQEMU çš„æ–°ç‰ˆæœ¬å°†æ”¯æŒå¤šä¸ªä»¥å‰ç‰ˆæœ¬çš„æœºå™¨ç±»å‹ã€‚
æ”¯æŒçš„æœºå™¨å±æ€§æœ‰ï¼š</p>
<ul>
<li><code>accel=accels1[:accels2[:...]]</code>
This is used to enable an accelerator. Depending on the target architecture, kvm, xen, hax, hvf, nvmm, whpx or tcg can be available. By default, tcg is used. If there is more than one accelerator specified, the next one is used if the previous one fails to initialize.</li>
<li><code>vmport=on|off|auto</code>
Enables emulation of VMWare IO port, for vmmouse etc. auto says to select the value based on accel. For accel=xen the default is off otherwise the default is on.</li>
<li><code>dump-guest-core=on|off</code>
Include guest memory in a core dump. The default is on.</li>
<li><code>mem-merge=on|off</code>
Enables or disables memory merge support. This feature, when supported by the host, de-duplicates identical memory pages among VMs instances (enabled by default).</li>
<li><code>aes-key-wrap=on|off</code>
Enables or disables AES key wrapping support on s390-ccw hosts. This feature controls whether AES wrapping keys will be created to allow execution of AES cryptographic functions. The default is on.</li>
<li><code>dea-key-wrap=on|off</code>
Enables or disables DEA key wrapping support on s390-ccw hosts. This feature controls whether DEA wrapping keys will be created to allow execution of DEA cryptographic functions. The default is on.</li>
<li><code>nvdimm=on|off</code>
Enables or disables NVDIMM support. The default is off.</li>
<li><code>memory-encryption=</code>
Memory encryption object to use. The default is none.</li>
<li><code>hmat=on|off</code>
Enables or disables ACPI Heterogeneous Memory Attribute Table (HMAT) support. The default is off.</li>
<li><code>memory-backend='id'</code>
An alternative to legacy -mem-path and mem-prealloc options. Allows to use a memory backend as main RAM.
For example: <code>:: -object memory-backend-file,id=pc.ram,size=512M,mem-path=/hugetlbfs,prealloc=on,share=on -machine memory-backend=pc.ram -m 512M</code>
Migration compatibility note: a) as backend id one shall use value of â€˜default-ram-idâ€™, advertised by machine type (available via query-machines QMP command), if migration to/from old QEMU (&lt;5.0) is expected. b) for machine types 4.0 and older, user shall use x-use-canonical-path-for-ramblock-id=off backend option if migration to/from old QEMU (&lt;5.0) is expected. For example: :: -object memory-backend-ram,id=pc.ram,size=512M,x-use-canonical-path-for-ramblock-id=off -machine memory-backend=pc.ram -m 512M</li>
</ul>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-riscv32 -machine virt,mem-merge=on
</span></span></code></pre></div></li>
</ul>
<h3 id="-cpu-model"><code>-cpu model</code></h3>
<ul>
<li>åŠŸèƒ½
é€‰æ‹© CPU å‹å·ï¼ˆ<code>-cpu help</code>æ˜¾ç¤ºå¸®åŠ©åˆ—è¡¨å’Œé™„åŠ åŠŸèƒ½çš„é€‰é¡¹ï¼‰</li>
</ul>
<blockquote>
<p>é»˜è®¤æƒ…å†µä¼šç»™å®¢æˆ·æœºæä¾› qemu64 æˆ– qemu32 çš„åŸºæœ¬ CPU æ¨¡å‹ã€‚è¿™æ ·åšå¯ä»¥å¯¹ CPU ç‰¹æ€§æä¾›ä¸€äº›é«˜çº§çš„è¿‡æ»¤åŠŸèƒ½ï¼Œè®©å®¢æˆ·æœºåœ¨åŒä¸€ç»„ç¡¬ä»¶å¹³å°ä¸Šçš„åŠ¨æ€è¿ç§»ä¼šæ›´åŠ å¹³æ»‘å’Œå®‰å…¨ã€‚
åœ¨å®¢æˆ·æœºä¸­æŸ¥çœ‹ CPU ä¿¡æ¯ (cat /proc/cpuinfo)ï¼Œmodel name å°±æ˜¯å½“å‰ CPU æ¨¡å‹çš„åç§°ã€‚</p>
</blockquote>
<ul>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-riscv32 -cpu rv32
</span></span></code></pre></div></li>
</ul>
<h3 id="accel-namepropvalue"><code>accel name[,prop=value[,...]]</code></h3>
<ul>
<li>åŠŸèƒ½
This is used to enable an accelerator. Depending on the target architecture, kvm, xen, hax, hvf, nvmm, whpx or tcg can be available. By default, tcg is used. If there is more than one accelerator specified, the next one is used if the previous one fails to initialize.</li>
<li>å­å‚æ•°
<ul>
<li><code>igd-passthru=on|off</code>
When Xen is in use, this option controls whether Intel integrated graphics devices can be passed through to the guest (default=off)</li>
<li><code>kernel-irqchip=on|off|split</code>
Controls KVM in-kernel irqchip support. The default is full acceleration of the interrupt controllers. On x86, split irqchip reduces the kernel attack surface, at a performance cost for non-MSI interrupts. Disabling the in-kernel irqchip completely is not recommended except for debugging purposes.</li>
<li><code>kvm-shadow-mem=size</code>
Defines the size of the KVM shadow MMU.</li>
<li><code>split-wx=on|off</code>
Controls the use of split w^x mapping for the TCG code generation buffer. Some operating systems require this to be enabled, and in such a case this will default on. On other operating systems, this will default off, but one may enable this for testing or debugging.</li>
<li><code>tb-size=n</code>
Controls the size (in MiB) of the TCG translation block cache.</li>
<li><code>thread=single|multi</code>
Controls number of TCG threads. When the TCG is multi-threaded there will be one thread per vCPU therefore taking advantage of additional host cores. The default is to enable multi-threading where both the back-end and front-ends support it and no incompatible TCG features have been enabled (e.g. icount/replay).</li>
<li><code>dirty-ring-size=n</code>
When the KVM accelerator is used, it controls the size of the per-vCPU dirty page ring buffer (number of entries for each vCPU). It should be a value that is power of two, and it should be 1024 or bigger (but still less than the maximum value that the kernel supports). 4096 could be a good initial value if you have no idea which is the best. Set this value to 0 to disable the feature. By default, this feature is disabled (dirty-ring-size=0). When enabled, KVM will instead record dirty pages in a bitmap.</li>
</ul>
</li>
</ul>
<h3 id="smp-cpusnmaxcpusmaxcpussocketssocketsdiesdiescorescoresthreadsthreads"><code>smp [[cpus=]n][,maxcpus=maxcpus][,sockets=sockets][,dies=dies][,cores=cores][,threads=threads]</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
é…ç½®å®¢æˆ·æœºçš„ SMPï¼ˆSymmetric Multi-Processingï¼‰ï¼Œå¯¹ç§°å¤šå¤„ç†æœº</p>
</li>
<li>
<p>å­å‚æ•°</p>
<ul>
<li><code>[cpus=]n</code>
è®¾ç½®å®¢æˆ·æœºä¸­ä½¿ç”¨é€»è¾‘çš„ CPU æ•°é‡ï¼ˆé»˜è®¤å€¼æ˜¯ 1ï¼‰ã€‚</li>
<li><code>[,maxcpus=cpus]</code>
è®¾ç½®å®¢æˆ·æœºæœ€å¤§å¯èƒ½è¢«ä½¿ç”¨çš„ CPU æ•°é‡ï¼ˆå¯ä»¥ç”¨çƒ­æ’æ‹” hot-plug æ·»åŠ  CPUï¼Œä¸èƒ½è¶…è¿‡ maxcpus ä¸Šé™ï¼‰ã€‚</li>
<li><code>[,cores=cores]</code>
è®¾ç½®æ¯ä¸ª CPU socket ä¸Šçš„ core æ•°é‡ï¼ˆé»˜è®¤å€¼æ˜¯ 1ï¼‰ã€‚</li>
<li><code>[,threads=threads]</code>
è®¾ç½®æ¯ä¸ª CPU core ä¸Šçš„çº¿ç¨‹æ•°ï¼ˆé»˜è®¤å€¼æ˜¯ 1ï¼‰ã€‚</li>
<li><code>[,sockets=sockets]</code>
è®¾ç½®å®¢æˆ·æœºä¸­æ€»çš„ CPU socket æ•°é‡ã€‚</li>
</ul>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-x86_64  -smp 1,sockets=1,cores=2,threads=2
</span></span></code></pre></div><h3 id="-numa-nodememsizecpusfirstcpu-lastcpunodeidnodeinitiatorinitiator"><code>-numa node[,mem=size][,cpus=firstcpu[-lastcpu]][,nodeid=node][,initiator=initiator]</code></h3>
<h3 id="-numa-nodememdevidcpusfirstcpu-lastcpunodeidnodeinitiatorinitiator"><code>-numa node[,memdev=id][,cpus=firstcpu[-lastcpu]][,nodeid=node][,initiator=initiator]</code></h3>
<h3 id="-numa-distsrcsourcedstdestinationvaldistance"><code>-numa dist,src=source,dst=destination,val=distance</code></h3>
<h3 id="-numa-cpunode-idnodesocket-idxcore-idythread-idz"><code>-numa cpu,node-id=node[,socket-id=x][,core-id=y][,thread-id=z]</code></h3>
<h3 id="-numa-hmat-lbinitiatornodetargetnodehierarchyhierarchydata-typetpyelatencylatbandwidthbw"><code>-numa hmat-lb,initiator=node,target=node,hierarchy=hierarchy,data-type=tpye[,latency=lat][,bandwidth=bw]</code></h3>
<h3 id="-numa-hmat-cachenode-idnodesizesizelevellevelassociativitystrpolicystrlinesize"><code>-numa hmat-cache,node-id=node,size=size,level=level[,associativity=str][,policy=str][,line=size]</code></h3>
<ul>
<li>åŠŸèƒ½</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-add-fd-fdfdsetsetopaqueopaque"><code>-add-fd fd=fd,set=set[,opaque=opaque]</code></h3>
<ul>
<li>åŠŸèƒ½</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-set-groupidargvalue"><code>-set group.id.arg=value</code></h3>
<ul>
<li>åŠŸèƒ½</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-global-driverpropvalue"><code>-global driver.prop=value</code></h3>
<ul>
<li>åŠŸèƒ½</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-global-driverdriverpropertypropertyvaluevalue"><code>-global driver=driver,property=property,value=value</code></h3>
<ul>
<li>åŠŸèƒ½</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-boot-orderdrivesoncedrivesmenuonoffsplashsp_namesplash-timesp_timereboot-timeoutrb_timeoutstrictonoff"><code>-boot [order=drives][,once=drives][,menu=on|off][,splash=sp_name][,splash-time=sp_time][,reboot-timeout=rb_timeout][,strict=on|off]</code></h3>
<ul>
<li>åŠŸèƒ½
è®¾ç½®å®¢æˆ·æœºå¯åŠ¨é¡ºåº</li>
</ul>
<blockquote>
<p>åœ¨ qemu æ¨¡æ‹Ÿçš„ x86 å¹³å°ä¸­ï¼Œç”¨&quot;a&quot;ã€&ldquo;b&quot;åˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€å’Œç¬¬äºŒè½¯é©±ï¼Œç”¨&quot;c&quot;è¡¨ç¤ºç¬¬ä¸€ä¸ªç¡¬ç›˜ï¼Œç”¨&quot;d&quot;è¡¨ç¤º CD-ROM å…‰é©±ï¼Œç”¨&quot;n&quot;è¡¨ç¤ºä»ç½‘ç»œå¯åŠ¨ã€‚
é»˜è®¤ä»ç¡¬ç›˜å¯åŠ¨ã€‚</p>
</blockquote>
<ul>
<li>
<p>å­å‚æ•°</p>
<ul>
<li><code>[order=drives]</code>
è®¾ç½®å¯åŠ¨é¡ºåºã€‚</li>
<li><code>[,once=drives]</code>
åªè®¾ç½®ä¸‹ä¸€æ¬¡å¯åŠ¨çš„é¡ºåºï¼Œå†é‡å¯åæ— æ•ˆã€‚</li>
<li><code>[,menu=on|off]</code>
åªè¦å›ºä»¶/BIOS æ”¯æŒï¼Œå°±å¯ä»¥å¯ç”¨äº¤äº’å¼å¼•å¯¼èœå•/æç¤ºã€‚é»˜è®¤ä¸ºéäº¤äº’å¼å¼•å¯¼ã€‚</li>
<li><code>[,splash=sp_name]</code>
å¦‚æœå›ºä»¶/BIOS æ”¯æŒé€‰é¡¹ splash=sp_name å’Œ menu=onï¼Œåˆ™å¯ä»¥å°†å¯åŠ¨ç”»é¢ä¼ é€’ç»™ biosï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿå°†å…¶æ˜¾ç¤ºä¸ºå¾½æ ‡ã€‚ç›®å‰ Seabios for X86 ç³»ç»Ÿæ”¯æŒå®ƒã€‚é™åˆ¶ï¼šå¯åŠ¨æ–‡ä»¶å¯ä»¥æ˜¯ 24 BPP æ ¼å¼ï¼ˆçœŸå½©è‰²ï¼‰çš„ jpeg æ–‡ä»¶æˆ– BMP æ–‡ä»¶ã€‚åˆ†è¾¨ç‡åº”è¯¥æ˜¯ SVGA æ¨¡å¼æ”¯æŒçš„ï¼Œæ¨è 320x240ã€640x480ã€800x640ã€‚</li>
<li><code>[,splash-time=sp_time]</code></li>
<li><code>[,reboot-timeout=rb_timeout]</code>
å¼•å¯¼å¤±è´¥æ—¶ï¼Œå®¢æˆ·æœºå°†æš‚åœ <code>rb_timeout</code> æ¯«ç§’ï¼Œç„¶åé‡æ–°å¯åŠ¨ã€‚å¦‚æœ <code>rb_timeout</code> ä¸º &lsquo;-1&rsquo;ï¼Œå®¢æˆ·æœºä¸ä¼šé‡å¯ï¼Œqemu é»˜è®¤å°† &lsquo;-1&rsquo; ä¼ é€’ç»™ biosã€‚ç›®å‰ Seabios for X86 ç³»ç»Ÿæ”¯æŒå®ƒã€‚</li>
<li><code>[,strict=on|off]</code>
åªè¦å›ºä»¶/BIOS æ”¯æŒï¼Œå°±é€šè¿‡ä¸¥æ ¼å¯åŠ¨ã€‚è¿™ä»…åœ¨ bootindex é€‰é¡¹æ›´æ”¹å¼•å¯¼ä¼˜å…ˆçº§æ—¶æœ‰æ•ˆã€‚é»˜è®¤ä¸ºéä¸¥æ ¼å¼•å¯¼ã€‚</li>
</ul>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># å°è¯•å…ˆä»ç½‘ç»œå¯åŠ¨ï¼Œç„¶åä»ç¡¬ç›˜å¯åŠ¨
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -boot order=nc
</span></span><span class="line"><span class="cl"># å…ˆä»å…‰é©±å¯åŠ¨ï¼Œé‡å¯ååˆ‡æ¢å›é»˜è®¤é¡ºåº
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -boot once=d
</span></span><span class="line"><span class="cl"># 5 ç§’é’Ÿçš„å¯åŠ¨ç”»é¢ã€‚
</span></span><span class="line"><span class="cl">qemu-system-x86_64 -boot menu=on,splash=/root/boot.bmp,splash-time=5000
</span></span></code></pre></div></li>
</ul>
<h3 id="-m-sizemegsslotsnmaxmemsize"><code>-m [size=]megs[,slots=n,maxmem=size]</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
å°†å®¢æˆ·æœºå†…å­˜è®¾ç½®ä¸º <code>megs</code> Må­—èŠ‚ã€‚é»˜è®¤å€¼ä¸º <code>128 MiB</code>ã€‚æˆ–è€…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨â€œMâ€æˆ–â€œGâ€çš„åç¼€ã€‚é½ã€‚</p>
</li>
<li>
<p>å­å‚æ•°</p>
<ul>
<li><code>[size=]megs</code>
å°†å®¢æˆ·æœºå†…å­˜è®¾ç½®ä¸º <code>megs</code> Må­—èŠ‚</li>
<li><code>[,slots=n,maxmem=size]</code>
å¯ç”¨äºè®¾ç½®å¯çƒ­æ’æ‹”å†…å­˜æ’æ§½çš„æ•°é‡å’Œæœ€å¤§å†…å­˜æ•°é‡ã€‚<code>maxmem</code> å¿…é¡»ä¸é¡µé¢å¤§å°å¯¹</li>
</ul>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹
ä»¥ä¸‹å‘½ä»¤è¡Œå°†å®¢æˆ·æœºå¯åŠ¨ RAM å¤§å°è®¾ç½®ä¸º 1GBï¼Œåˆ›å»º 3 ä¸ªæ’æ§½ä»¥çƒ­æ’æ‹”é¢å¤–å†…å­˜ï¼Œå¹¶å°†å®¢æˆ·æœºå¯ä»¥è¾¾åˆ°çš„æœ€å¤§å†…å­˜è®¾ç½®ä¸º 4GBï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-x86_64 -m 1G,slots=3,maxmem=4G
</span></span></code></pre></div><p>å¦‚æœæœªæŒ‡å®š <code>slot</code> å’Œ <code>maxmem</code>ï¼Œåˆ™ä¸ä¼šå¯ç”¨å†…å­˜çƒ­æ’æ‹”ï¼Œå¹¶ä¸”å®¢æˆ·æœºå†…å­˜æ°¸è¿œä¸ä¼šå¢åŠ ã€‚</p>
</li>
</ul>
<h3 id="-mem-path-path"><code>-mem-path path</code></h3>
<ul>
<li>åŠŸèƒ½
ä½¿ç”¨huge pageã€‚å¯¹äºå†…å­˜è®¿é—®å¯†é›†å‹çš„åº”ç”¨ï¼Œä½¿ç”¨<code>huge page</code>æ˜¯å¯ä»¥æ¯”è¾ƒæ˜æ˜¾åœ°æé«˜å®¢æˆ·æœºæ€§èƒ½ã€‚ ä½¿ç”¨<code>huge page</code>çš„å†…å­˜ä¸èƒ½è¢«æ¢å‡ºï¼ˆswap outï¼‰ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨<code>ballooning</code>æ–¹å¼è‡ªåŠ¨å¢é•¿ã€‚</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-mem-prealloc"><code>-mem-prealloc</code></h3>
<ul>
<li>åŠŸèƒ½
ä½¿å®¿ä¸»æœºåœ¨å®¢æˆ·æœºå¯åŠ¨æ—¶å°±å…¨éƒ¨åˆ†é…å¥½å®¢æˆ·æœºçš„å†…å­˜</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-k-language"><code>-k language</code></h3>
<ul>
<li>
<p>åŠŸèƒ½
è®¾ç½®é”®ç›˜å¸ƒå±€è¯­è¨€ï¼Œé»˜è®¤ä¸º<code>en-us</code></p>
</li>
<li>
<p>å­å‚æ•°
å¯ç”¨å¸ƒå±€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ar  de-ch  es  fo     fr-ca  hu  ja  mk     no  pt-br  sv
</span></span><span class="line"><span class="cl">da  en-gb  et  fr     fr-ch  is  lt  nl     pl  ru     th
</span></span><span class="line"><span class="cl">de  en-us  fi  fr-be  hr     it  lv  nl-be  pt  sl     tr
</span></span></code></pre></div></li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
</li>
</ul>
<h2 id="å—è®¾å¤‡å‚æ•°-block-device-options">å—è®¾å¤‡å‚æ•° Block device options</h2>
<h3 id="fda-file"><code>fda file</code></h3>
<ul>
<li>åŠŸèƒ½
ä¸ºå®¢æˆ·æœºæŒ‡å®šè½¯ç›˜è®¾å¤‡ï¼ŒæŒ‡å®šå®¢æˆ·æœºçš„ç¬¬ä¸€ä¸ªè½¯ç›˜è®¾å¤‡ï¼Œåœ¨å®¢æˆ·æœºä¸­æ˜¾ç¤ºä¸º<code>/dev/fd0</code></li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="fdb-file"><code>fdb file</code></h3>
<ul>
<li>åŠŸèƒ½
ä¸ºå®¢æˆ·æœºæŒ‡å®šè½¯ç›˜è®¾å¤‡ï¼ŒæŒ‡å®šå®¢æˆ·æœºçš„ç¬¬ä¸€ä¸ªè½¯ç›˜è®¾å¤‡ï¼Œåœ¨å®¢æˆ·æœºä¸­æ˜¾ç¤ºä¸º<code>/dev/fd1</code></li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="hda-file"><code>hda file</code></h3>
<h3 id="hdb-file"><code>hdb file</code></h3>
<h3 id="hdc-file"><code>hdc file</code></h3>
<h3 id="hdd-file"><code>hdd file</code></h3>
<ul>
<li>åŠŸèƒ½
ä¸ºå®¢æˆ·æœºæŒ‡å®šå—å­˜å‚¨è®¾å¤‡ï¼ŒæŒ‡å®šå®¢æˆ·æœºç§çš„ç¬¬ä¸€ä¸ª IDE è®¾å¤‡</li>
<li>å­å‚æ•°
è‹¥å®¢æˆ·æœºä½¿ç”¨<code>PIIX_IDE</code>é©±åŠ¨ï¼Œæ˜¾ç¤ºä¸º<code>/dev/hda</code>è®¾å¤‡ï¼›
è‹¥å®¢æˆ·æœºä½¿ç”¨<code>ata_piix</code>é©±åŠ¨ï¼Œæ˜¾ç¤ºä¸º<code>/dev/sda</code>è®¾å¤‡ã€‚
è‹¥æ²¡æœ‰ä½¿ç”¨<code>-hdx</code>çš„å‚æ•°ï¼Œåˆ™é»˜è®¤ä½¿ç”¨<code>-hda</code>å‚æ•°ï¼›
å¯ä»¥å°†å®¿ä¸»æœºçš„ä¸€å—ç¡¬ç›˜ä½œä¸º<code>-hda</code>çš„å‚æ•°ä½¿ç”¨ï¼›
è‹¥æ–‡ä»¶ååŒ…å«é€—å·ï¼Œåº”ä½¿ç”¨ä¸¤ä¸ªè¿ç»­çš„é€—å·è¿›è¡Œè½¬ä¹‰ã€‚</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-cdrom-file"><code>-cdrom file</code></h3>
<ul>
<li>åŠŸèƒ½
ä¸ºå®¢æˆ·æœºæŒ‡å®šå…‰ç›˜ CD-ROMã€‚å¯ä»¥å°†å®¿ä¸»æœºçš„å…‰é©±<code>/dev/cdrom</code>è®¾å¤‡ä½œä¸º<code>-cdrom</code>å‚æ•°ä½¿ç”¨ã€‚<code>-cdrom</code>å‚æ•°ä¸èƒ½ä¸<code>-hdc</code>å‚æ•°åŒæ—¶ä½¿ç”¨ï¼Œå› ä¸º<code>-cdrom</code>å°±æ˜¯å®¢æˆ·æœºé‡Œçš„ç¬¬ä¸‰ä¸ª IDE è®¾å¤‡</li>
<li>å­å‚æ•°</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h3 id="-blockdev-optionoptionoption"><code>-blockdev option[,option[,option[,...]]]</code></h3>
<ul>
<li>
<p>åŠŸèƒ½</p>
</li>
<li>
<p>å­å‚æ•°</p>
</li>
<li>
<p>è°ƒç”¨å®ä¾‹</p>
</li>
</ul>
<h3 id="-drive-optionoptionoption"><code>-drive option[,option[,option[,...]]]</code></h3>
<ul>
<li>åŠŸèƒ½
å®šä¹‰ä¸€ä¸ªå­˜å‚¨é©±åŠ¨å™¨</li>
<li>å­å‚æ•°
<ul>
<li><code>[file=file]</code>
åŠ è½½<code>file</code>é•œåƒæ–‡ä»¶åˆ°å®¢æˆ·æœºçš„é©±åŠ¨å™¨ä¸­ã€‚</li>
<li><code>[,if=type]</code>
æŒ‡å®šé©±åŠ¨å™¨ä½¿ç”¨çš„æ¥å£ç±»å‹ï¼šå¯ç”¨çš„ç±»ç±»å‹æœ‰ï¼š<code>ide</code>ã€<code>scsi</code>ã€<code>virtio</code>ã€<code>sd</code>ã€<code>floopy</code>ã€<code>pflash</code>ç­‰ã€‚</li>
<li><code>[,bus=n]</code>
è®¾ç½®é©±åŠ¨å™¨åœ¨å®¢æˆ·æœºä¸­çš„æ€»çº¿ç¼–å·ã€‚</li>
<li><code>[,unit=m]</code>
è®¾ç½®é©±åŠ¨å™¨åœ¨å®¢æˆ·æœºä¸­çš„å•å…ƒç¼–å·ã€‚</li>
<li><code>[,media=d]</code>
è®¾ç½®é©±åŠ¨å™¨ä¸­åª’ä»‹çš„ç±»å‹ï¼Œå€¼ä¸º disk æˆ– cdromã€‚</li>
<li><code>[,index=i]</code>
è®¾ç½®åœ¨é€šä¸€ç§æ¥å£çš„é©±åŠ¨å™¨ä¸­çš„ç´¢å¼•ç¼–å·ã€‚</li>
<li><code>[,snapshot=on|off]</code>
å½“å€¼ä¸º on æ—¶ï¼Œqemu ä¸ä¼šå°†ç£ç›˜æ•°æ®çš„æ›´æ”¹å†™å›åˆ°é•œåƒæ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯å†™åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¯ä»¥åœ¨ qemu moinitor ä¸­ä½¿ç”¨ commit å‘½ä»¤å¼ºåˆ¶å°†ç£ç›˜æ•°æ®ä¿å­˜å›é•œåƒæ–‡ä»¶ä¸­ã€‚</li>
<li><code>[,cache=writethrough|writeback|none|directsync|unsafe]</code>
è®¾ç½®å®¿ä¸»æœºå¯¹å—è®¾å¤‡æ•°æ®è®¿é—®çš„ cache æ¨¡å¼ã€‚ï¼Œ
<code>writethrough</code>ï¼ˆç›´å†™æ¨¡å¼ï¼‰ï¼šè°ƒç”¨ write å†™å…¥æ•°æ®çš„åŒæ—¶å°†æ•°æ®å†™å…¥ç£ç›˜ç¼“å­˜å’Œåç«¯å—è®¾å¤‡ä¸­ã€‚
<code>writeback</code>ï¼ˆå›å†™æ¨¡å¼ï¼‰ï¼šè°ƒç”¨ write å†™å…¥æ•°æ®æ—¶åªå°†æ•°æ®å†™å…¥åˆ°ç£ç›˜ç¼“å­˜ä¸­ï¼Œå½“æ•°æ®è¢«æ¢å‡ºç¼“å­˜æ—¶æ‰å†™å…¥åˆ°åç«¯å­˜å‚¨ä¸­ã€‚ä¼˜ç‚¹å†™å…¥æ•°æ®å—ï¼Œç¼ºç‚¹ç³»ç»Ÿæ‰ç”µæ•°æ®æ— æ³•æ¢å¤ã€‚</li>
<li><code>[,aio=threads|native]</code>
é€‰æ‹©å¼‚æ­¥ IO çš„æ–¹å¼</li>
<li><code>threads</code>
ä¸º aio å‚æ•°çš„é»˜è®¤å€¼ï¼Œè®©ä¸€ä¸ªçº¿ç¨‹æ± å»å¤„ç†å¼‚æ­¥ IOï¼›</li>
<li><code>native</code>
åªé€‚ç”¨äº cache=none çš„æƒ…å†µï¼Œä½¿ç”¨çš„æ˜¯ Linux åŸç”Ÿçš„ AIOã€‚</li>
<li><code>[,format=f]</code>
æŒ‡å®šä½¿ç”¨çš„ç£ç›˜æ ¼å¼ï¼Œé»˜è®¤æ˜¯ QEMU è‡ªåŠ¨æ£€æµ‹ç£ç›˜æ ¼å¼çš„ã€‚</li>
<li><code>[,serial=s]</code>
æŒ‡å®šåˆ†é…ç»™è®¾å¤‡çš„åºåˆ—å·ã€‚</li>
<li><code>[,addr=A]</code>
åˆ†é…ç»™é©±åŠ¨å™¨æ§åˆ¶å™¨çš„ PCI åœ°å€ï¼Œåªåœ¨ä½¿ç”¨ virtio æ¥å£æ—¶é€‚ç”¨ã€‚</li>
<li><code>[,id=name]</code>
è®¾ç½®é©±åŠ¨å™¨çš„ IDï¼Œå¯ä»¥åœ¨ QEMU monitor ä¸­ç”¨ info block çœ‹åˆ°ã€‚
<code>[,readonly=on|off]</code>
è®¾ç½®é©±åŠ¨å™¨æ˜¯å¦åªè¯»ã€‚</li>
</ul>
</li>
<li>è°ƒç”¨å®ä¾‹</li>
</ul>
<h2 id="usb-å‚æ•°-usb-convenience-options">USB å‚æ•° USB convenience options</h2>
<h2 id="æ˜¾ç¤ºå‚æ•°-display-options">æ˜¾ç¤ºå‚æ•° Display options</h2>
<h2 id="ä»…é™-i386-æ¶æ„çš„å‚æ•°-i386-target-only">ä»…é™ i386 æ¶æ„çš„å‚æ•° i386 target only</h2>
<h2 id="ç½‘ç»œå‚æ•°-network-options">ç½‘ç»œå‚æ•° Network options</h2>
<h2 id="å­—ç¬¦è®¾å¤‡å‚æ•°-character-device-options">å­—ç¬¦è®¾å¤‡å‚æ•° Character device options</h2>
<h2 id="tpm-è®¾å¤‡-tpm-device-options">TPM è®¾å¤‡ TPM device options</h2>
<h2 id="æŒ‡å®šå¯åŠ¨æŒ‡å¼•-linuxmultiboot-boot-specific">æŒ‡å®šå¯åŠ¨æŒ‡å¼• Linux/Multiboot boot specific</h2>
<p>å½“ä½¿ç”¨è¯¥è°ƒç”¨å‚æ•°æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ç»™å®šçš„ Linux æˆ–è€…å¤šé‡å¼•å¯¼å†…æ ¸ï¼Œè€Œä¸éœ€è¦å®‰è£…å†…æ ¸åˆ°ä¸€ä¸ªå…‰ç›˜ä¸­ã€‚è¿™æ ·å¯ä»¥æ›´æ–¹ä¾¿åœ°æµ‹è¯•ä¸åŒå†…æ ¸ã€‚</p>
<ul>
<li>
<p><code>-kernel bzImage</code></p>
<ul>
<li>åŠŸèƒ½
ç”¨ bzImage ä½œä¸ºå†…æ ¸é•œåƒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–å¯åŠ¨æ ¼å¼ã€‚</li>
</ul>
</li>
<li>
<p><code>-append cmdline</code></p>
<ul>
<li>åŠŸèƒ½
ç”¨<code>cmd</code>å‘½ä»¤è¡Œï¼Œä½œä¸ºå†…æ ¸çš„å‘½ä»¤è¡Œ</li>
</ul>
</li>
<li>
<p><code>-initrd file</code></p>
<ul>
<li>åŠŸèƒ½
ç”¨æ–‡ä»¶ä½œä¸ºåˆå§‹åŒ– ram</li>
</ul>
</li>
<li>
<p><code>-initrd &quot;file1 arg=foo,file2&quot;</code></p>
<ul>
<li>åŠŸèƒ½
æ­¤è¯­æ³•ä»…é€‚ç”¨äºå¤šé‡å¼•å¯¼
ä½¿ç”¨ <code>file1</code> å’Œ <code>file2</code> ä½œä¸ºæ¨¡å—å¹¶å°† <code>arg=foo</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç¬¬ä¸€ä¸ªæ¨¡å—</li>
</ul>
</li>
<li>
<p><code>-dtb file</code></p>
<ul>
<li>åŠŸèƒ½
å°†æ–‡ä»¶ç”¨ä½œè®¾å¤‡æ ‘äºŒè¿›åˆ¶ (dtb) æ˜ åƒå¹¶åœ¨å¯åŠ¨æ—¶å°†å…¶ä¼ é€’ç»™å†…æ ¸</li>
</ul>
</li>
</ul>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU åˆè¯†</title>
      <link>https://lifeislife.cn/posts/qemu%E5%88%9D%E8%AF%86/</link>
      <pubDate>Fri, 23 Jul 2021 11:54:49 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E5%88%9D%E8%AF%86/</guid>
      <description>ç®€ä»‹ QEMU æ˜¯ä¸€æ¬¾å¼€æºçš„æ¨¡æ‹Ÿå™¨åŠè™šæ‹Ÿæœºç›‘ç®¡å™¨ (Virtual Machine Monitor, VMM)ã€‚QEMU ä¸»è¦æä¾›ä¸¤ç§åŠŸèƒ½ç»™ç”¨æˆ·ä½¿ç”¨ã€‚ä¸€æ˜¯ä½œä¸ºç”¨æˆ·æ€æ¨¡æ‹Ÿå™¨ï¼Œåˆ©ç”¨åŠ¨æ€ä»£ç ç¿»è¯‘æœºåˆ¶æ¥æ‰§è¡Œä¸</description>
      <content:encoded><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>QEMU æ˜¯ä¸€æ¬¾å¼€æºçš„æ¨¡æ‹Ÿå™¨åŠè™šæ‹Ÿæœºç›‘ç®¡å™¨ (Virtual Machine Monitor, VMM)ã€‚QEMU ä¸»è¦æä¾›ä¸¤ç§åŠŸèƒ½ç»™ç”¨æˆ·ä½¿ç”¨ã€‚ä¸€æ˜¯ä½œä¸ºç”¨æˆ·æ€æ¨¡æ‹Ÿå™¨ï¼Œåˆ©ç”¨åŠ¨æ€ä»£ç ç¿»è¯‘æœºåˆ¶æ¥æ‰§è¡Œä¸åŒäºä¸»æœºæ¶æ„çš„ä»£ç ã€‚äºŒæ˜¯ä½œä¸ºè™šæ‹Ÿæœºç›‘ç®¡å™¨ï¼Œæ¨¡æ‹Ÿå…¨ç³»ç»Ÿï¼Œåˆ©ç”¨å…¶ä»– VMM(Xen, KVM, etc) æ¥ä½¿ç”¨ç¡¬ä»¶æä¾›çš„è™šæ‹ŸåŒ–æ”¯æŒï¼Œåˆ›å»ºæ¥è¿‘äºä¸»æœºæ€§èƒ½çš„è™šæ‹Ÿæœºã€‚</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<h3 id="ä½¿ç”¨åŒ…ç®¡ç†å®‰è£…">ä½¿ç”¨åŒ…ç®¡ç†å®‰è£…</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo apt-get install qemu
</span></span></code></pre></div><h3 id="ä½¿ç”¨æºç å®‰è£…">ä½¿ç”¨æºç å®‰è£…</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">wget</span> <span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">qemu</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="mf">6.1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">rc3</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">xz</span>
</span></span><span class="line"><span class="cl"><span class="n">tar</span> <span class="n">xvJf</span> <span class="n">qemu</span><span class="o">-</span><span class="mf">6.1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">rc3</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">xz</span>
</span></span><span class="line"><span class="cl"><span class="n">cd</span> <span class="n">qemu</span><span class="o">-</span><span class="mf">6.1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">rc3</span>
</span></span></code></pre></div><h3 id="å®‰è£…ç›¸å…³åº“">å®‰è£…ç›¸å…³åº“</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apt-getÂ install libglib2.0-dev
</span></span><span class="line"><span class="cl">apt-get install ninja-build
</span></span><span class="line"><span class="cl">apt install g++
</span></span><span class="line"><span class="cl">apt install libpixman-1-dev
</span></span><span class="line"><span class="cl">apt install libsdl2-dev -y
</span></span></code></pre></div><h3 id="é…ç½®">é…ç½®</h3>
<p>é€šè¿‡<code>./configure --help</code> çš„æŸ¥çœ‹ç¼–è¯‘æ—¶çš„é€‰é¡¹ï¼Œ<code>--target-list</code>é€‰é¡¹ä¸ºå¯é€‰çš„æ¨¡æ‹Ÿå™¨ï¼Œé»˜è®¤å…¨é€‰ã€‚
<code>--target-list</code> ä¸­çš„ <code>xxx-soft</code> å’Œ <code>xxx-linux-user</code> åˆ†åˆ«æŒ‡ç³»ç»Ÿæ¨¡æ‹Ÿå™¨å’Œåº”ç”¨ç¨‹åºæ¨¡æ‹Ÿå™¨ï¼Œç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åå­—ä¸º<code>qemu-system-xxx</code>å’Œ <code>qemu-xxx</code>
æœ¬æ–‡ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./configure --prefix=XXX --enable-debug --target-list=riscv32-softmmu,riscv32-linux-user,riscv64-linux-user,riscv64-softmmu --enable-kvm
</span></span><span class="line"><span class="cl"># --prefix é€‰é¡¹è®¾ç½®qemuçš„å®‰è£…ä½ç½®ç»å¯¹è·¯å¾„ï¼Œä¹‹åè‹¥è¦å¸è½½åˆ é™¤qemuåªè¦åˆ é™¤è¯¥æ–‡ä»¶å¤¹å³å¯ï¼Œ--enable-kvmå¼€å¯kvm
</span></span><span class="line"><span class="cl"># configå®Œï¼Œå¯ä»¥åœ¨æŒ‡å®šçš„qemuå®‰è£…æ–‡ä»¶å¤¹ä¸‹é¢æ‰¾åˆ°config-host.makæ–‡ä»¶ï¼Œ
</span></span><span class="line"><span class="cl"># è¯¥æ–‡ä»¶è®°å½•ç€qemué…ç½®çš„é€‰é¡¹ï¼Œå¯ä»¥å’Œè‡ªå·±è®¾ç½®çš„è¿›è¡Œå¯¹æ¯”ï¼Œç¡®ä¿é…ç½®å’Œè‡ªå·±å·²çŸ¥
</span></span></code></pre></div><p>æ¥ç€è¿›è¡Œç¼–è¯‘</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">make -j8
</span></span></code></pre></div><p>ç›´æ¥<code>make</code>ä¼šå¾ˆæ…¢ï¼Œç¬¬ä¸€æ¬¡ç¼–è¯‘æ—¶é»˜è®¤å®‰è£…è¯´æœ‰æ¨¡æ‹Ÿå™¨ï¼Œç¼–è¯‘äº†ä¸‰å››ä¸ªå°æ—¶ã€‚åŠ ä¸Š<code>-j8</code>å¯ä»¥è¿›è¡Œå¤šçº¿ç¨‹ç¼–è¯‘</p>
<h2 id="åˆ›å»ºä¸ä½¿ç”¨">åˆ›å»ºä¸ä½¿ç”¨</h2>
<h3 id="åˆ›å»ºè™šæ‹Ÿé•œåƒ">åˆ›å»ºè™šæ‹Ÿé•œåƒ</h3>
<p>ä½¿ç”¨è™šæ‹Ÿé•œåƒæ¥æ¨¡æ‹Ÿè™šæ‹Ÿæœºçš„ç¡¬ç›˜ï¼Œåœ¨å¯åŠ¨è™šæ‹Ÿæœºä¹‹å‰éœ€è¦åˆ›å»ºä¸€ä¸ªé•œåƒæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# qemu-img create -f qcow2 qmtest.img 10G
</span></span><span class="line"><span class="cl">Formatting &#39;qmtest.img&#39;, fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 lazy_refcounts=off 
</span></span><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# ls
</span></span><span class="line"><span class="cl">qmtest.img
</span></span></code></pre></div><p><code>-f</code>é€‰é¡¹ç”¨äºæŒ‡å®šé•œåƒçš„æ ¼å¼ï¼Œ<code>qcow2</code>æ ¼å¼æ˜¯ QEMU æœ€å¸¸ç”¨çš„é•œåƒæ ¼å¼ï¼Œé‡‡ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯æ¥ä¼˜åŒ–æ€§èƒ½ã€‚<code>qmtest.img</code>æ˜¯é•œåƒæ–‡ä»¶çš„åå­—ï¼Œ<code>10G</code>æ˜¯é•œåƒæ–‡ä»¶å¤§å°ã€‚</p>
<p>é•œåƒæ–‡ä»¶åˆ›å»ºå®Œæˆåï¼Œå¯ä½¿ç”¨<code>qemu-system-x86</code>æ¥å¯åŠ¨<code>x86</code>æ¶æ„çš„è™šæ‹Ÿæœºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-x86_64 qmtest.img
</span></span></code></pre></div><p>qmtest.img ä¸­è¿˜æœªå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥ä¼šæç¤ºâ€œNo bootable deviceâ€çš„é”™è¯¯ã€‚</p>
<h3 id="å‡†å¤‡æ“ä½œç³»ç»Ÿé•œåƒ">å‡†å¤‡æ“ä½œç³»ç»Ÿé•œåƒ</h3>
<p>ä¸‹è½½éœ€è¦çš„ Linux å‘è¡Œç‰ˆé•œåƒæ–‡ä»¶ï¼Œ<a href="https://launchpad.net/ubuntu/+cdmirrors">https://launchpad.net/ubuntu/+cdmirrors</a>ï¼Œæ‰¾åˆ°æƒ³è¦ä¸‹è½½çš„é•œåƒï¼Œè¿™é‡Œä»¥äº¤é€šå¤§å­¦çš„é•œåƒä¸ºä¾‹
å³å‡»é“¾æ¥å¤åˆ¶åœ°å€ï¼š<a href="https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso">https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# wget https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso
</span></span></code></pre></div><h3 id="æ£€æŸ¥-kvm-æ˜¯å¦å¯ç”¨">æ£€æŸ¥ KVM æ˜¯å¦å¯ç”¨</h3>
<p>QEMU ä½¿ç”¨ KVM æ¥æå‡è™šæ‹Ÿæœºæ€§èƒ½ï¼Œå¦‚æœä¸å¯ç”¨ KVM ä¼šå¯¼è‡´æ€§èƒ½æŸå¤±ã€‚è¦ä½¿ç”¨ KVMï¼Œé¦–å…ˆè¦æ£€æŸ¥ç¡¬ä»¶æ˜¯å¦æœ‰è™šæ‹ŸåŒ–æ”¯æŒï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# grep -E &#39;vmx|svm&#39; /proc/cpuinfo
</span></span></code></pre></div><p>å¦‚æœæœ‰è¾“å‡ºåˆ™è¡¨ç¤ºç¡¬ä»¶æœ‰è™šæ‹ŸåŒ–æ”¯æŒã€‚å…¶æ¬¡è¦æ£€æŸ¥ kvm æ¨¡å—æ˜¯å¦å·²ç»åŠ è½½ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# lsmod | grep kvm
</span></span><span class="line"><span class="cl">kvm_intel             142999  0 
</span></span><span class="line"><span class="cl">kvm                   444314  1 kvm_intel
</span></span></code></pre></div><p>å¦‚æœ<code>kvm_intel/kvm_amd</code>ã€<code>kvm</code>æ¨¡å—è¢«æ˜¾ç¤ºå‡ºæ¥ï¼Œåˆ™<code>kvm</code>æ¨¡å—å·²ç»åŠ è½½ã€‚æœ€åè¦ç¡®ä¿ qemu åœ¨ç¼–è¯‘çš„æ—¶å€™ä½¿èƒ½äº†<code>KVM</code>ï¼Œå³åœ¨æ‰§è¡Œ<code>configure</code>è„šæœ¬çš„æ—¶å€™åŠ å…¥äº†<code>â€“enable-kvm</code>é€‰é¡¹ã€‚</p>
<h3 id="å¯åŠ¨è™šæ‹Ÿæœºå®‰è£…æ“ä½œç³»ç»Ÿ">å¯åŠ¨è™šæ‹Ÿæœºå®‰è£…æ“ä½œç³»ç»Ÿ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# qemu-system-x86_64 -m 2048 -enable-kvm qmtest.img -cdrom ./Fedora-Live-Desktop-x86_64-20-1.iso
</span></span></code></pre></div><p><code>-m</code>æŒ‡å®šè™šæ‹Ÿæœºå†…å­˜å¤§å°ï¼Œé»˜è®¤å•ä½æ˜¯ MBï¼Œ<code>-enable-kvm</code>ä½¿ç”¨ KVM è¿›è¡ŒåŠ é€Ÿï¼Œ<code>-cdrom</code>æ·»åŠ  fedora çš„å®‰è£…é•œåƒã€‚å¯åœ¨å¼¹å‡ºçš„çª—å£ä¸­æ“ä½œè™šæ‹Ÿæœºï¼Œå®‰è£…æ“ä½œç³»ç»Ÿï¼Œå®‰è£…å®Œæˆåé‡èµ·è™šæ‹Ÿæœºä¾¿ä¼šä»ç¡¬ç›˜ (qmtest.img) å¯åŠ¨ã€‚ä¹‹åå†å¯åŠ¨è™šæ‹Ÿæœºåªéœ€è¦æ‰§è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/#  qemu-system-x86_64 -m 2048 -enable-kvm qmtest.img
</span></span></code></pre></div><h2 id="é€€å‡º-qemu">é€€å‡º qemu</h2>
<p>åœ¨è¿è¡Œ qemu åï¼Œå…³é—­å›¾å½¢ç•Œé¢ä½†æ˜¯ç»ˆç«¯ä»ç„¶æ˜¯å¤„äº qemu ç¯å¢ƒä¸­ï¼Œå¯ä»¥ç›´æ¥å…³é—­ç»ˆç«¯é€€å‡ºã€‚å¦‚æœä¸æƒ³å…³é—­ç»ˆç«¯ï¼Œå¯ä»¥å¦å¤–æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ kill è¿›ç¨‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">killall qemu-system-riscv32
</span></span></code></pre></div><p>å¦‚æœè®°ä¸æ¸…å…¨ç§°ï¼Œå¯ä»¥è¾“å…¥å¤§æ¦‚åç§°å›è½¦åä¼šåˆ—å‡ºç›¸å…³çš„è¿›ç¨‹</p>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU å­¦ä¹ è®°å½•</title>
      <link>https://lifeislife.cn/posts/qemu%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</link>
      <pubDate>Tue, 20 Jul 2021 16:51:34 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</guid>
      <description>QEMU å­¦ä¹ è®°å½• ä»€ä¹ˆæ˜¯ KVMï¼Ÿ åŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº Kernel-based Virtual Machineï¼ˆKVMï¼‰æ˜¯ä¸€ç§å†…å»ºäº Linux ä¸­çš„å¼€æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å…·ä½“è€Œè¨€ï¼ŒKVM å¯å¸®åŠ©ç”¨æˆ·å°† Linux è½¬å˜ä¸ºè™š</description>
      <content:encoded><![CDATA[<h1 id="qemu-å­¦ä¹ è®°å½•">QEMU å­¦ä¹ è®°å½•</h1>
<h2 id="ä»€ä¹ˆæ˜¯-kvm">ä»€ä¹ˆæ˜¯ KVMï¼Ÿ</h2>
<p>åŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº <code>Kernel-based Virtual Machineï¼ˆKVMï¼‰</code>æ˜¯ä¸€ç§å†…å»ºäº Linux ä¸­çš„å¼€æºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å…·ä½“è€Œè¨€ï¼Œ<code>KVM</code> å¯å¸®åŠ©ç”¨æˆ·å°† Linux è½¬å˜ä¸ºè™šæ‹Ÿæœºç›‘æ§ç¨‹åºï¼Œä½¿ä¸»æœºè®¡ç®—æœºèƒ½å¤Ÿè¿è¡Œå¤šä¸ªéš”ç¦»çš„è™šæ‹Ÿç¯å¢ƒï¼Œå³è™šæ‹Ÿå®¢æˆ·æœºæˆ–è™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-qemu">ä»€ä¹ˆæ˜¯ QEMUï¼Ÿ</h2>
<p>Qemu æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯ä»¥å•ç‹¬è¿è¡Œçš„è½¯ä»¶ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿä¸åŒæ¶æ„çš„æœºå™¨ï¼Œéå¸¸çµæ´»å’Œå¯ç§»æ¤ã€‚å®ƒä¸»è¦é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„&rsquo;é‡ç¼–è¯‘å™¨&rsquo;å°†ä¸ºç‰¹å®šå¤„ç†å™¨ç¼–å†™äºŒè¿›åˆ¶ä»£ç è½¬æ¢ä¸ºå¦ä¸€ç§ã€‚</p>
<h2 id="kvm-ä¸-qemu-çš„å…³ç³»">KVM ä¸ QEMU çš„å…³ç³»</h2>
<p>KVM æ˜¯ Linux çš„ä¸€ä¸ªæ¨¡å—ã€‚å¯ä»¥ç”¨<code>modprobe</code>å»åŠ è½½ KVM æ¨¡å—ã€‚åŠ è½½äº†æ¨¡å—åï¼Œæ‰èƒ½è¿›ä¸€æ­¥é€šè¿‡å…¶ä»–å·¥å…·åˆ›å»ºè™šæ‹Ÿæœºã€‚ä½†ä»…æœ‰ KVM æ¨¡å—æ˜¯ è¿œè¿œä¸å¤Ÿçš„ï¼Œå› ä¸ºç”¨æˆ·æ— æ³•ç›´æ¥æ§åˆ¶å†…æ ¸æ¨¡å—å»ä½œäº‹æƒ…ï¼šè¿˜å¿…é¡»æœ‰ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„å·¥å…·æ‰è¡Œã€‚è¿™ä¸ªç”¨æˆ·ç©ºé—´çš„å·¥å…·ï¼Œå¼€å‘è€…é€‰æ‹©äº†å·²ç»æˆå‹çš„å¼€æºè™šæ‹ŸåŒ–è½¯ä»¶ QEMUã€‚KVM ä½¿ç”¨äº† QEMU çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç¨åŠ æ”¹é€ ï¼Œå°±æˆäº†å¯æ§åˆ¶ KVM çš„ç”¨æˆ·ç©ºé—´å·¥å…·äº†ã€‚æ‰€ä»¥ä½ ä¼šçœ‹åˆ°ï¼Œå®˜æ–¹æä¾›çš„ KVM ä¸‹è½½æœ‰ä¸¤ å¤§éƒ¨åˆ†ä¸‰ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ KVM æ¨¡å—ã€QEMU å·¥å…·ä»¥åŠäºŒè€…çš„åˆé›†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åªå‡çº§ KVM æ¨¡å—ï¼Œä¹Ÿå¯ä»¥åªå‡çº§ QEMU å·¥å…·ã€‚</p>
<h2 id="qemu-ç”¨æˆ·æ¨¡å¼ä¸ç³»ç»Ÿæ¨¡å¼">QEMU ç”¨æˆ·æ¨¡å¼ä¸ç³»ç»Ÿæ¨¡å¼</h2>
<p>QEMU å±äºåº”ç”¨å±‚çš„ä»¿çœŸç¨‹åºï¼Œå®ƒæ”¯æŒä¸¤ç§æ“ä½œæ¨¡å¼ï¼š<strong>ç”¨æˆ·æ¨¡å¼</strong>æ¨¡æ‹Ÿå’Œ<strong>ç³»ç»Ÿæ¨¡å¼</strong>æ¨¡æ‹Ÿã€‚</p>
<ul>
<li><strong>ç”¨æˆ·æ¨¡å¼ä»¿çœŸ</strong> åˆ©ç”¨åŠ¨æ€ä»£ç ç¿»è¯‘æœºåˆ¶ï¼Œå¯ä»¥åœ¨å½“å‰ CPU ä¸Šæ‰§è¡Œè¢«ç¼–è¯‘ä¸ºæ”¯æŒå…¶ä»– CPU çš„ç¨‹åºï¼Œå¦‚å¯ä»¥åœ¨ x86 æœºå™¨ä¸Šæ‰§è¡Œä¸€ä¸ª ARM äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åºã€‚ï¼ˆæ‰§è¡Œä¸»æœº CPU æŒ‡ä»¤çš„åŠ¨æ€ç¿»è¯‘å¹¶ç›¸åº”åœ°è½¬æ¢ Linux ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚</li>
<li><strong>ç³»ç»Ÿæ¨¡å¼ä»¿çœŸ</strong> åˆ©ç”¨å…¶å®ƒ VMM(Xen, KVM) æ¥ä½¿ç”¨ç¡¬ä»¶æä¾›çš„è™šæ‹ŸåŒ–æ”¯æŒï¼Œåˆ›å»ºæ¥è¿‘äºä¸»æœºæ€§èƒ½çš„å…¨åŠŸèƒ½è™šæ‹Ÿæœºï¼ŒåŒ…æ‹¬å¤„ç†å™¨å’Œé…å¥—çš„å¤–å›´è®¾å¤‡ï¼ˆç£ç›˜ï¼Œä»¥å¤ªç½‘ç­‰ï¼‰ã€‚</li>
</ul>
<h3 id="ç”¨æˆ·æ¨¡å¼">ç”¨æˆ·æ¨¡å¼</h3>
<p>æ”¯æŒçš„ CPUï¼šx86 (32 and 64 bit), PowerPC (32 and 64 bit), ARM, MIPS (32 bit only), Sparc (32 and 64 bit), Alpha, ColdFire(m68k), CRISv32 å’Œ MicroBlaze
ä¸‹åˆ—æ“ä½œç³»ç»Ÿæ”¯æŒ QEMU çš„ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿï¼š</p>
<ul>
<li>Linux (referred as qemu-linux-user)</li>
<li>BSD (referred as qemu-bsd-user)</li>
</ul>
<p>è°ƒç”¨ï¼ˆ<a href="https://qemu.readthedocs.io/en/latest/user/main.html">å…·ä½“å‚æ•°å«ä¹‰</a>ï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-i386 [-h] [-d] [-L path] [-s size] [-cpu model] [-g port] [-B offset] [-R size] program [arguments...]
</span></span></code></pre></div><p>ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿç¯å¢ƒä¸‹è¿è¡Œé€Ÿåº¦è¦æ¯”ç³»ç»Ÿæ¨¡å¼æ¨¡æ‹Ÿç¯å¢ƒä¸‹å¿«ï¼Œä½†å¹¶ä¸æ˜¯å®Œç¾æ¨¡æ‹Ÿï¼Œæ¯”å¦‚ç¨‹åºè¯»å–<code>/proc/cpuinfo</code>å†…å®¹æ—¶ï¼Œç”±ä¸»æœºå†…æ ¸è¿”å›ï¼Œå› æ­¤è¿”å›çš„ä¿¡æ¯æ˜¯æè¿°ä¸»æœº CPU çš„ï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿçš„ CPUã€‚</p>
<h3 id="ç³»ç»Ÿæ¨¡å¼">ç³»ç»Ÿæ¨¡å¼</h3>
<p>é¦–å…ˆåˆ›å»ºè™šæ‹Ÿé•œåƒï¼Œæ¨¡æ‹Ÿç¡¬ç›˜ç©ºé—´ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# qemu-img create -f qcow2 qmtest.img 10G
</span></span><span class="line"><span class="cl">Formatting &#39;qmtest.img&#39;, fmt=qcow2 size=10737418240 encryption=off cluster_size=65536 lazy_refcounts=off 
</span></span><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# ls
</span></span><span class="line"><span class="cl">qmtest.img
</span></span></code></pre></div><p><code>-f</code>é€‰é¡¹ç”¨äºæŒ‡å®šé•œåƒçš„æ ¼å¼ï¼Œ<code>qcow2</code>æ ¼å¼æ˜¯ QEMU æœ€å¸¸ç”¨çš„é•œåƒæ ¼å¼ï¼Œé‡‡ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯æ¥ä¼˜åŒ–æ€§èƒ½ã€‚<code>qmtest.img</code>æ˜¯é•œåƒæ–‡ä»¶çš„åå­—ï¼Œ<code>10G</code>æ˜¯é•œåƒæ–‡ä»¶å¤§å°ã€‚</p>
<p>é•œåƒæ–‡ä»¶åˆ›å»ºå®Œæˆåï¼Œå¯ä½¿ç”¨<code>qemu-system-x86</code>æ¥å¯åŠ¨<code>x86</code>æ¶æ„çš„è™šæ‹Ÿæœºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">qemu-system-x86_64 qmtest.img
</span></span></code></pre></div><p>qmtest.img ä¸­è¿˜æœªå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥ä¼šæç¤ºâ€œNo bootable deviceâ€çš„é”™è¯¯ã€‚</p>
<p>å…¶æ¬¡ï¼Œå‡†å¤‡æ“ä½œç³»ç»Ÿé•œåƒ
ä¸‹è½½éœ€è¦çš„ Linux å‘è¡Œç‰ˆé•œåƒæ–‡ä»¶ï¼Œ<a href="https://launchpad.net/ubuntu/+cdmirrors">https://launchpad.net/ubuntu/+cdmirrors</a>ï¼Œæ‰¾åˆ°æƒ³è¦ä¸‹è½½çš„é•œåƒï¼Œè¿™é‡Œä»¥äº¤é€šå¤§å­¦çš„é•œåƒä¸ºä¾‹
å³å‡»é“¾æ¥å¤åˆ¶åœ°å€ï¼š<a href="https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso">https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# wget https://ftp.sjtu.edu.cn/ubuntu-cd/20.10/ubuntu-20.10-live-server-amd64.iso
</span></span></code></pre></div><p>æœ€åï¼Œå¯åŠ¨è™šæ‹Ÿæœºå®‰è£…æ“ä½œç³»ç»Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@hanhan:/home/dominic/qemu/# qemu-system-x86_64 -m 2048 -enable-kvm qmtest.img -cdrom ./Fedora-Live-Desktop-x86_64-20-1.iso
</span></span></code></pre></div><p><code>-m</code>æŒ‡å®šè™šæ‹Ÿæœºå†…å­˜å¤§å°ï¼Œé»˜è®¤å•ä½æ˜¯ MBï¼Œ<code>-enable-kvm</code>ä½¿ç”¨ KVM è¿›è¡ŒåŠ é€Ÿï¼Œ<code>-cdrom</code>æ·»åŠ  fedora çš„å®‰è£…é•œåƒã€‚</p>
<p>è¯¥æ¨¡å¼ä¸‹ï¼Œè¦æ¯”ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿæ…¢å¾—å¤šï¼Œå› ä¸ºæ¨¡æ‹Ÿäº†ç›®æ ‡å†…æ ¸ï¼Œä»¥åŠè®¾å¤‡è¾“å…¥/è¾“å‡ºã€ä¸­æ–­ç­‰ã€‚</p>
<h2 id="qemu-å·¥ä½œåŸç†">QEMU å·¥ä½œåŸç†</h2>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210721140349.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/20210721140349.png" alt=""  />
</a>
</div>


å•çº¯ä½¿ç”¨ qemuï¼Œé‡‡ç”¨çš„æ˜¯å®Œå…¨è™šæ‹ŸåŒ–çš„æ¨¡å¼ã€‚qemu å‘ Guest OS æ¨¡æ‹Ÿ CPUï¼Œä¹Ÿæ¨¡æ‹Ÿå…¶ä»–çš„ç¡¬ä»¶ï¼ŒGuestOS è®¤ä¸ºè‡ªå·±å’Œç¡¬ä»¶ç›´æ¥æ‰“äº¤é“ï¼Œå…¶å®æ˜¯åŒ qemu æ¨¡æ‹Ÿå‡ºæ¥çš„ç¡¬ä»¶æ‰“äº¤é“ï¼Œqemu ä¼šå°†è¿™äº›æŒ‡ä»¤è½¬è¯‘ç»™çœŸæ­£çš„ç¡¬ä»¶ã€‚ç”±äºæ‰€æœ‰çš„æŒ‡ä»¤éƒ½è¦ä» qemu é‡Œé¢è¿‡ä¸€æ‰‹ï¼Œå› è€Œæ€§èƒ½å°±ä¼šæ¯”è¾ƒå·®ã€‚</p>
<p>å®Œå…¨è™šæ‹ŸåŒ–æ˜¯éå¸¸æ…¢çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æŠ€æœ¯ <code>Intel-VT</code>ï¼Œ<code>AMD-V</code>ï¼Œæ‰€ä»¥éœ€è¦ CPU ç¡¬ä»¶å¼€å¯è¿™ä¸ªæ ‡å¿—ä½ï¼Œä¸€èˆ¬åœ¨ BIOS é‡Œé¢è®¾ç½®ã€‚å½“ç¡®è®¤å¼€å§‹äº†æ ‡å¿—ä½ä¹‹åï¼Œé€šè¿‡<code>KVM</code>ï¼ŒGuestOS çš„ CPU æŒ‡ä»¤ä¸ç”¨ç»è¿‡ Qemu è½¬è¯‘ï¼Œç›´æ¥è¿è¡Œï¼Œå¤§å¤§æé«˜äº†é€Ÿåº¦ã€‚æ‰€ä»¥ï¼Œ<code>KVM</code> åœ¨å†…æ ¸é‡Œé¢éœ€è¦æœ‰ä¸€ä¸ªæ¨¡å—ï¼Œæ¥è®¾ç½®å½“å‰ CPU æ˜¯ Guest OS åœ¨ç”¨ï¼Œè¿˜æ˜¯ Host OS åœ¨ç”¨ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å†…æ ¸æ¨¡å—ä¸­æ˜¯å¦æœ‰ KVM</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lsmod | grep kvm
</span></span></code></pre></div><p>KVM å†…æ ¸æ¨¡å—é€šè¿‡ <code>/dev/kvm</code> æš´éœ²æ¥å£ï¼Œç”¨æˆ·æ€ç¨‹åºå¯ä»¥é€šè¿‡ <code>ioctl</code>æ¥è®¿é—®è¿™ä¸ªæ¥å£ã€‚Qemu å°† KVM æ•´åˆè¿›æ¥ï¼Œå°†æœ‰å…³ CPU æŒ‡ä»¤çš„éƒ¨åˆ†äº¤ç”±å†…æ ¸æ¨¡å—æ¥åšï¼Œå°±æ˜¯ <code>qemu-kvm (qemu-system-XXX)</code>ã€‚</p>
<p>qemu å’Œ kvm æ•´åˆä¹‹åï¼ŒCPU çš„æ€§èƒ½é—®é¢˜è§£å†³äº†ã€‚å¦å¤– Qemu è¿˜ä¼šæ¨¡æ‹Ÿå…¶ä»–çš„ç¡¬ä»¶ï¼Œå¦‚ç½‘ç»œå’Œç¡¬ç›˜ã€‚åŒæ ·ï¼Œå…¨è™šæ‹ŸåŒ–çš„æ–¹å¼ä¹Ÿä¼šå½±å“è¿™äº›è®¾å¤‡çš„æ€§èƒ½ã€‚</p>
<p>äºæ˜¯ï¼Œqemu é‡‡å–åŠè™šæ‹ŸåŒ–çš„æ–¹å¼ï¼Œè®© Guest OS åŠ è½½ç‰¹æ®Šçš„é©±åŠ¨æ¥åšè¿™ä»¶äº‹æƒ…ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç½‘ç»œéœ€è¦åŠ è½½ <code>virtio_net</code>ï¼Œå­˜å‚¨éœ€è¦åŠ è½½ <code>virtio_blk</code>ï¼ŒGuest éœ€è¦å®‰è£…è¿™äº›åŠè™šæ‹ŸåŒ–é©±åŠ¨ï¼ŒGuestOS çŸ¥é“è‡ªå·±æ˜¯è™šæ‹Ÿæœºï¼Œæ‰€ä»¥æ•°æ®ä¼šç›´æ¥å‘é€ç»™åŠè™šæ‹ŸåŒ–è®¾å¤‡ï¼Œç»è¿‡ç‰¹æ®Šå¤„ç†ï¼ˆä¾‹å¦‚æ’é˜Ÿã€ç¼“å­˜ã€æ‰¹é‡å¤„ç†ç­‰æ€§èƒ½ä¼˜åŒ–æ–¹å¼ï¼‰ï¼Œæœ€ç»ˆå‘é€ç»™çœŸæ­£çš„ç¡¬ä»¶ã€‚è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº†æ€§èƒ½ã€‚</p>
<blockquote>
<p>Q : ç³»ç»Ÿæ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼çš„åŒºåˆ«ï¼Ÿ
ç³»ç»Ÿæ¨¡å¼ æ˜¯ qemu è™šæ‹Ÿå‡ºä¸€å¥—å®Œæ•´çš„ç¡¬ä»¶ç¯å¢ƒï¼ŒåŒ…å« CPUï¼Œå†…å­˜ï¼Œç½‘å¡ï¼Œç¡¬ç›˜ï¼Œå¯¹äºè™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ OS çœ‹åˆ°çš„å’Œç¡¬ä»¶å’ŒçœŸå®çš„æ˜¯ä¸€æ ·çš„ã€‚
ç”¨æˆ·æ¨¡å¼æ˜¯ç›´æ¥å°†å¯æ‰§è¡Œçš„æ–‡ä»¶è¿›è¡ŒæŒ‡ä»¤ç¿»è¯‘ï¼Œåªè™šæ‹Ÿå‡º CPUã€‚
å‡è®¾æœ‰ KVMï¼šhost æ˜¯ x86ï¼ŒQEMU è™šæ‹Ÿå‡º x86 çš„ç³»ç»Ÿæ¨¡å¼ è¿è¡Œ Windows ç³»ç»Ÿã€‚QEMU ä¼šå°† Windows æŒ‡ä»¤ç›´æ¥äº¤ç»™  host CPU ç›´æ¥è¿è¡Œï¼ˆè¿™ä¸ªåŠŸèƒ½æ˜¯ç”± KVM å®ç°çš„ï¼Œç›¸å½“äºç›´æ¥è°ƒç”¨ host CPUï¼‰ï¼Œæ€§èƒ½æŸå¤±å°ã€‚å†…å­˜ï¼Œç¡¬ç›˜ï¼Œç½‘ç»œç­‰å¤–è®¾æ˜¯ç”± qemu è™šæ‹Ÿå‡ºæ¥çš„ã€‚
å‡è®¾æ—  KVMï¼šhost æ˜¯ x86ï¼ŒQEMU è™šæ‹Ÿå‡º x86 çš„ç³»ç»Ÿæ¨¡å¼è¿è¡Œ Windows ç³»ç»Ÿã€‚QEMU ä¼šå°† Windows æŒ‡ä»¤ç¿»è¯‘æˆä¸­é—´ç ï¼Œä¸­é—´ç å†è½¬æˆ   host CPU æŒ‡ä»¤ï¼ˆè¿™ä¸ªåŠŸèƒ½æ˜¯ç”± qemu TCG å®ç°çš„ï¼‰ï¼Œæ€§èƒ½æŸå¤±å¤§ã€‚å†…å­˜ï¼Œç¡¬ç›˜ï¼Œç½‘æ´›ç­‰å¤–è®¾æ˜¯ç”± qemu è™šæ‹Ÿå‡ºæ¥çš„ã€‚
å‡è®¾æœ‰ KVMï¼šhost æ˜¯ x86ï¼ŒQEMU è™šæ‹Ÿå‡º RISC-V çš„ç³»ç»Ÿæ¨¡å¼ è¿è¡Œ Linux ç³»ç»Ÿã€‚QEMU ä¼šå°† Linux æŒ‡ä»¤ç¿»è¯‘æˆä¸­é—´ç ï¼Œä¸­é—´ç å†è½¬æˆ host CPU æŒ‡ä»¤ï¼ˆè¿™ä¸ªåŠŸèƒ½æ˜¯ç”± qemu TCG å®ç°çš„ï¼‰ï¼Œæ€§èƒ½æŸå¤±å¤§ã€‚å†…å­˜ï¼Œç¡¬ç›˜ï¼Œç½‘æ´›ç­‰å¤–è®¾æ˜¯ç”± qemu è™šæ‹Ÿå‡ºæ¥çš„ã€‚
KVM éœ€è¦åœ¨è™šæ‹Ÿæœºä¸å®¿ä¸»æœºæ¶æ„ç›¸åŒæ—¶æ‰ç”Ÿæ•ˆã€‚
æ­¤å¤–ï¼Œç”¨æˆ·æ¨¡å¼ä¸‹è°ƒç”¨ IO ç¡¬ä»¶ä¼šæŠ¥é”™ã€‚qemu ç³»ç»Ÿæ¨¡å¼ä¸‹ä¼šæ¨¡æ‹Ÿå‡ºæ‰€æœ‰è®¾å¤‡ï¼Œä½†æ˜¯æ¨¡æ‹Ÿçš„ IO è®¾å¤‡æ•ˆç‡ä½ï¼Œæ‰€ä»¥åæ¥æœ‰äº†åŠè™šæ‹ŸåŒ–ã€‚</p>
</blockquote>
]]></content:encoded>
    </item>
    <item>
      <title>QEMU Decodetreeè¯¦è§£</title>
      <link>https://lifeislife.cn/posts/qemu-decodetree%E8%AF%A6%E8%A7%A3/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      <guid>https://lifeislife.cn/posts/qemu-decodetree%E8%AF%A6%E8%A7%A3/</guid>
      <description>QEMU åœ¨ decode æŒ‡ä»¤çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨å„å¹³å°æ‰€å®šä¹‰çš„ instruction decoders æ¥è§£ææŒ‡ä»¤ã€‚å¦‚åœ¨ ARM å¹³å°ä¸‹ï¼Œå°±å®šä¹‰äº†ï¼šdisas_arm_insn()ã€disas_thumb_i</description>
      <content:encoded><![CDATA[<p>QEMU åœ¨ decode æŒ‡ä»¤çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨å„å¹³å°æ‰€å®šä¹‰çš„ instruction decoders æ¥è§£ææŒ‡ä»¤ã€‚å¦‚åœ¨ ARM å¹³å°ä¸‹ï¼Œå°±å®šä¹‰äº†ï¼š<code>disas_arm_insn()</code>ã€<code>disas_thumb_insn()</code> åŠ <code>disas_thumb2_insn()</code> ç­‰æ¥åˆ†åˆ«è´Ÿè´£ ARM 32-bits æŒ‡ä»¤ã€ARM Thumb æŒ‡ä»¤åŠ ARM Thumb2 æŒ‡ä»¤çš„è§£æã€‚</p>
<p>è€Œ <code>Decodetree</code> åˆ™æ˜¯ç”± <code>Bastian Koppelmann</code> äº 2017 å¹´åœ¨ ç§»æ¤ RISC-V QEMU çš„æ—¶å€™æ‰€æå‡ºæ¥çš„æœºåˆ¶ (è¯¦è§ï¼š<a href="https://lists.gnu.org/archive/html/qemu-devel/2017-07/msg07735.html">è®¨è®ºé‚®ä»¶1</a>ã€<a href="https://lists.gnu.org/archive/html/qemu-devel/2017-10/msg05046.html">è®¨è®ºé‚®ä»¶2</a>)ã€‚æå‡ºè¯¥æœºåˆ¶ä¸»è¦æ˜¯å› ä¸ºè¿‡å¾€çš„ instruction decoders (å¦‚ï¼šARM) éƒ½æ˜¯é‡‡ç”¨ä¸€å † <code>switch-case</code> æ¥åšåˆ¤æ–­ã€‚ä¸ä»…éš¾é˜…è¯»ï¼Œä¹Ÿéš¾ä»¥ç»´æŠ¤ã€‚</p>
<p>å› æ­¤ <code>Bastian Koppelmann</code> å°±æå‡ºäº† <code>Decodetree</code> çš„æœºåˆ¶ï¼Œå¼€å‘è€…åªéœ€è¦é€šè¿‡ <code>Decodetree</code> çš„è¯­æ³•å®šä¹‰å„ä¸ªæŒ‡ä»¤çš„æ ¼å¼ï¼Œä¾¿å¯äº¤ç”± <code>Decodetree</code> æ¥åŠ¨æ€ç”Ÿæˆå¯¹åº”åŒ…å« <code>switch-case</code> çš„ instruction decoder <code>.c</code> æ–‡æ¡£ã€‚</p>
<p><code>Decodetree</code> ç‰¹åˆ«é€‚åˆåƒ RISC-V è¿™ç§å…·æœ‰<strong>å›ºå®šæŒ‡ä»¤æ ¼å¼</strong>çš„ ISAã€‚</p>
<ul>
<li>å› ä¸ºå„å­—æ®µéƒ½åœ¨å›ºå®šçš„ä½ç½®ï¼Œ(å¦‚ RISC-V çš„ <code>opcode</code> éƒ½æ˜¯å›ºå®šåœ¨ <code>bits[6..0]</code> çš„ä½ç½®)ã€‚</li>
</ul>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F18%2F5a051d22c43a2ce34069fecd2e4fb8c0.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F18%2F5a051d22c43a2ce34069fecd2e4fb8c0.png" alt=""  />
</a>
</div>

</p>
<p><code>Decodetree</code> å…¶å®æ˜¯ç”± Python script (<code>./scripts/decodetree.py</code>) æ‰€ç”Ÿæˆçš„ã€‚ä½¿ç”¨æ–‡æ¡£å¯ä»¥å‚è€ƒï¼š<code>./docs/devel/decodetree.rst</code>ï¼Œé‡Œé¢æœ‰è¯¦ç»†å®šä¹‰äº†å…¶è¯­æ³•çš„æ ¼å¼ã€‚QEMU åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šè°ƒç”¨ <code>Decodetree</code>ï¼Œæ ¹æ®å„å¹³å°æ‰€å®šä¹‰çš„ decode æ–‡æ¡£ï¼ŒåŠ¨æ€ç”Ÿæˆå¯¹åº”çš„ decoderã€‚</p>
<ul>
<li>
<p>å¦‚ RISC-V çš„ instruction decoders å°±æ˜¯è¢«å®šä¹‰åœ¨ï¼š<code>./target/riscv/*.decode</code> ä¸­ã€‚å…¶ <code>Makefile.obj</code> å°±æœ‰å¦‚ä¸‹çš„å£°æ˜ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DECODETREE = $(SRC_PATH)/scripts/decodetree.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">decode32-y = $(SRC_PATH)/target/riscv/insn32.decode
</span></span><span class="line"><span class="cl">decode32-$(TARGET_RISCV64) += $(SRC_PATH)/target/riscv/insn32-64.decode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">target/riscv/decode_insn32.inc.c: $(decode32-y) $(DECODETREE)
</span></span><span class="line"><span class="cl">	$(call quiet-command, \
</span></span><span class="line"><span class="cl">	  $(PYTHON) $(DECODETREE) -o $@ --static-decode decode_insn32 \
</span></span><span class="line"><span class="cl">          $(decode32-y), &#34;GEN&#34;, $(TARGET_DIR)$@)
</span></span></code></pre></div></li>
</ul>
<p><code>Decodetree</code> çš„è¯­æ³•å…±åˆ†ä¸ºï¼šFieldsã€Argument Setsã€Formatsã€Patterns äº”éƒ¨åˆ†ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡ <code>Decodetree</code> çš„è¯­æ³•ï¼Œæ¥åŠ¨æ€ç”Ÿæˆä¸€ä¸ªæŒ‡ä»¤çš„ decoderã€‚</p>
<h2 id="field">Field</h2>
<p><code>Field</code> å®šä¹‰å¦‚ä½•å–å‡ºä¸€æŒ‡ä»¤ä¸­ï¼Œå„<strong>å­—æ®µ</strong> (eg: <code>rd</code>, <code>rs1</code>, <code>rs2</code>, <code>imm</code>) çš„å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">field_def     := &#39;%&#39; identifier ( unnamed_field )* ( !function=identifier )?
</span></span><span class="line"><span class="cl">unnamed_field := number &#39;:&#39; ( &#39;s&#39; ) number
</span></span></code></pre></div><p>å…¶è¯­æ³•ç”± <code>%</code> å¼€å¤´ï¼Œéšåç´§æ¥ç€ä¸€ä¸ª <code>identifier</code> åŠé›¶ä¸ªæˆ–å¤šä¸ª <code>unamed_field</code>ï¼Œå¹¶å¯å†åŠ ä¸Šå¯é€‰çš„ <code>!function</code>ã€‚</p>
<ul>
<li><code>identifier</code> å¯ç”±å¼€å‘è€…è‡ªå®šï¼Œå¦‚ï¼š<code>rd</code>ã€<code>imm</code>â€¦ ç­‰ã€‚</li>
<li><code>unamed_field</code> å®šä¹‰äº†è¯¥å­—æ®µçš„æ‰€åœ¨æ¯”ç‰¹ã€‚ç¬¬ä¸€ä¸ªæ•°å­—å®šä¹‰äº†è¯¥å­—æ®µçš„ <code>least-significant bit position</code>ï¼Œç¬¬äºŒä¸ªæ•°å­—åˆ™å®šä¹‰äº†è¯¥å­—æ®µçš„<code>æ¯”ç‰¹é•¿åº¦</code>ã€‚å¦å¤–å¯åŠ ä¸Šå¯é€‰çš„ <code>s</code> å­—ç¬¦æ¥æ ‡æ˜åœ¨å–å‡ºè¯¥å­—æ®µåï¼Œæ˜¯å¦éœ€è¦åš ç¬¦å·æ‰©å±•ã€‚
<ul>
<li>Egï¼š<code>%rd 7:5</code> ä»£è¡¨ <code>rd</code> å äº†æŒ‡ä»¤ä¸­ bits 7 ~ bits 11 çš„ä½ç½® (insn[11:7])ï¼Œå…± 5 bitsã€‚</li>
</ul>
</li>
<li><code>!function</code> å®šä¹‰åœ¨æˆªå–å‡ºè¯¥å­—æ®µçš„å€¼åï¼Œæ‰€ä¼šå†è°ƒç”¨çš„ functionã€‚</li>
</ul>
<p><code>Field</code> (32-bits æŒ‡ä»¤) æœ€åä¼šç”Ÿæˆå¯¹åº”çš„ <code>extract32()</code> åŠ <code>sextract32()</code> ä»£ç ï¼Œä»¥ç”¨æ¥å–å¾—æŒ‡ä»¤ä¸­å„å­—æ®µçš„å€¼ï¼š</p>
<h3 id="field-ç¤ºä¾‹">Field ç¤ºä¾‹</h3>
<table>
<thead>
<tr>
<th>Input</th>
<th>Generated code</th>
</tr>
</thead>
<tbody>
<tr>
<td>%disp 0:s16</td>
<td>sextract(i, 0, 16)</td>
</tr>
<tr>
<td>%imm9 16:6 10:3</td>
<td>extract(i, 16, 6) &laquo; 3</td>
</tr>
<tr>
<td>%disp12 0:s1 1:1 2:10</td>
<td>sextract(i, 0, 1) &laquo; 11</td>
</tr>
<tr>
<td>%shimm8 5:s8 13:1 !function=expand_shimm8</td>
<td>expand_shimm8(sextract(i, 5, 8)) &laquo; 1</td>
</tr>
</tbody>
</table>
<p>ä»¥ RISC-V çš„ <code>U-type</code> æŒ‡ä»¤ä¸ºä¾‹ï¼š</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F18%2Ffb558390c2c5a8c8b9e1645d90cabfc8.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F18%2Ffb558390c2c5a8c8b9e1645d90cabfc8.png" alt=""  />
</a>
</div>

</p>
<p>å…¶ä¸­ï¼Œ<code>imm</code> å  <code>insn[31:12]</code>ï¼Œå…±20ä½ï¼Œ<code>rd</code> å  <code>insn[11:7]</code>ï¼Œä¸” <code>imm</code> éœ€è¦åš ç¬¦å·æ‰©å±• å <code>å·¦ç§» 12 ä½</code> (<code>20-bit immediate is shifted left by 12 bits to form U immediates</code>)ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è¦å®šä¹‰ RISC-V çš„ <code>U-type</code> æŒ‡ä»¤ï¼Œåˆ™å¯ä»¥å£°æ˜æˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">%rd       7:5
</span></span><span class="line"><span class="cl">%imm_u    12:s20                 !function=ex_shift_12
</span></span></code></pre></div><blockquote>
<p>20 è¡¨ç¤ºå  20 bits</p>
</blockquote>
<p>æœ€åä¼šç”Ÿæˆå¦‚ä¸‹çš„ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_u</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p><code>static void decode_insn32_extract_u()</code> æ˜¯ç”±ä¸‹æ–‡ Format å®šä¹‰æ‰€ç”Ÿæˆçš„ï¼Œè€Œ <code>arg_u *a</code> åˆ™æ˜¯ç”± Argument Set å®šä¹‰æ‰€ç”Ÿæˆçš„ï¼Œå°†ä¼šåœ¨åé¢çš„éƒ¨åˆ†å†åšè¯´æ˜ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>
<p><code>a-&gt;imm</code> æ˜¯ç”± <code>insn[31:12]</code> æ‰€å–å¾—å¹¶åšç¬¦å·æ‰©å±•ï¼Œä¸”ä¼šå†è°ƒç”¨ <code>ex_shift_12()</code> æ¥ <code>å·¦ç§» 12 ä¸ª bits</code>ã€‚</p>
<ul>
<li>
<p>P.S. RISC-V çš„ <code>ex_shift_12()</code> æ˜¯é€šè¿‡å®šä¹‰åœ¨<code>./target/riscv/translate.c</code> ä¸­ <code>EX_SH</code> è¿™ä¸ª macro æ‰€å±•å¼€çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define EX_SH(amount) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    static int ex_shift_##amount(DisasContext *ctx, int imm) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    {                                         \
</span></span></span><span class="line"><span class="cl"><span class="cp">        return imm &lt;&lt; amount;                 \
</span></span></span><span class="line"><span class="cl"><span class="cp">    }
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nf">EX_SH</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">EX_SH</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">EX_SH</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">EX_SH</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">EX_SH</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><code>a-&gt;rd</code> æ˜¯ç”± <code>insn[11:7]</code> æ‰€å–å¾—ã€‚</p>
</li>
</ul>
<p>æ­¤å¤–ï¼Œåœ¨ <code>Decodetree</code> çš„ spec ä¸­ä¹Ÿæœ‰æåˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åªå®šä¹‰ <code>!function</code> æ¥ç›´æ¥è°ƒç”¨è¯¥ functionã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªæœ‰ <code>DisasContext</code> ä¼šè¢«ä¼ å…¥è¯¥ functionã€‚</p>
<p>å¦‚ ARM Thumb <code>./target/arm/t16.decode</code> å°±æœ‰å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># Set S if the instruction is outside of an IT block.
</span></span><span class="line"><span class="cl">%s               !function=t16_setflags
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">disas_t16_extract_addsub_2i</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_s_rri_rot</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rn</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">=</span> <span class="nf">t16_setflags</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¯·æ³¨æ„ï¼ŒæœªåŒ…å«ä»»ä½• <code>unnamed_fields</code> æˆ– <code>!function</code> çš„ <code>Field</code> ä¼šè¢«è§†ä¸ºé”™è¯¯ã€‚</p>
<hr>
<h2 id="argument-set">Argument Set</h2>
<p><code>Argument Set</code> å®šä¹‰ç”¨æ¥ä¿å­˜ä»æŒ‡ä»¤ä¸­æ‰€æˆªå–å‡ºæ¥å„å­—æ®µçš„å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">args_def    := &#39;&amp;&#39; identifier ( args_elt )+ ( !extern )?
</span></span><span class="line"><span class="cl">args_elt    := identifier
</span></span></code></pre></div><p>å…¶è¯­æ³•ç”± <code>&amp;</code> å¼€å¤´ï¼Œéšåç´§æ¥ç€ä¸€ä¸ªæˆ–å¤šä¸ªçš„ <code>identifier</code> ï¼Œå¹¶å¯å†åŠ ä¸Šå¯é€‰çš„ <code>!extern</code> ã€‚</p>
<ul>
<li><code>identifier</code> å¯ç”±å¼€å‘è€…è‡ªè®¢ï¼Œå¦‚ï¼š<code>regs</code>ã€<code>loadstore</code>â€¦ ç­‰ã€‚</li>
<li><code>!extern</code> åˆ™è¡¨ç¤ºæ˜¯å¦åœ¨å…¶ä»–åœ°æ–¹å·²ç»ç”±å…¶ä»–çš„ decoder å®šä¹‰è¿‡ã€‚å¦‚æœæœ‰è¯¥å­—æ®µï¼Œå°±<strong>ä¸ä¼š</strong>å†æ¬¡ç”Ÿæˆå¯¹åº”çš„ <code>argument set struct</code>ã€‚</li>
</ul>
<h3 id="argument-set-ç¤ºä¾‹">Argument Set ç¤ºä¾‹</h3>
<p>ä¾‹1ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">&amp;ampreg3 ra rb rc
</span></span></code></pre></div><p>ä¼šç”Ÿæˆä»¥ä¸‹çš„ <code>argument set struct</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ra</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_reg3</span><span class="p">;</span>
</span></span></code></pre></div><p>ä¾‹2ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">&amp;loadstore reg base offset
</span></span></code></pre></div><p>åˆ™ä¼šç”Ÿæˆä»¥ä¸‹çš„ <code>argument set struct</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_loadstore</span><span class="p">;</span>
</span></span></code></pre></div><p>å› æ­¤ï¼Œä»¥åˆšåˆšçš„ RISC-V <code>U-type</code> æŒ‡ä»¤ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä»æŒ‡ä»¤ä¸­æˆªå– <code>imm</code> åŠ <code>rd</code> å­—æ®µçš„å€¼ï¼Œå¯ä»¥å£°æ˜å…¶ <code>argument set</code> å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">&amp;u    imm rd
</span></span></code></pre></div><p>æœ€åä¼šç”Ÿæˆä»¥ä¸‹çš„ <code>argument set struct</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_u</span><span class="p">;</span>
</span></span></code></pre></div><p>æ­¤ <code>argument set struct</code> ä¼šè¢«ä¼ å…¥ç”± <code>Format</code> å®šä¹‰æ‰€ç”Ÿæˆçš„ extract functionï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_u</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ‰€ä¼ å…¥çš„<code>arg_u</code> ä¼šä¿å­˜ä»æŒ‡ä»¤ä¸­æˆªå–å‡ºçš„ <code>imm</code> åŠ <code>rd</code> å­—æ®µçš„å€¼ï¼Œå¾…åç»­ä½¿ç”¨ã€‚</p>
<h2 id="format">Format</h2>
<p><code>Format</code> å®šä¹‰äº†æŒ‡ä»¤çš„æ ¼å¼ (å¦‚ RISC-V ä¸­çš„ <code>R</code>ã€<code>I</code>ã€<code>S</code>ã€<code>B</code>ã€<code>U</code>ã€<code>J-type</code>)ï¼Œå¹¶ä¼šç”Ÿæˆå¯¹åº”çš„ decode functionã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">fmt_def      := &#39;@&#39; identifier ( fmt_elt )+
</span></span><span class="line"><span class="cl">fmt_elt      := fixedbit_elt | field_elt | field_ref | args_ref
</span></span><span class="line"><span class="cl">fixedbit_elt := [01.-]+
</span></span><span class="line"><span class="cl">field_elt    := identifier &#39;:&#39; &#39;s&#39;? number
</span></span><span class="line"><span class="cl">field_ref    := &#39;%&#39; identifier | identifier &#39;=&#39; &#39;%&#39; identifier
</span></span><span class="line"><span class="cl">args_ref     := &#39;&amp;&#39; identifier
</span></span></code></pre></div><p>å…¶è¯­æ³•ç”± <code>@</code> å¼€å¤´ï¼Œéšåç´§æ¥ç€ä¸€ä¸ª <code>identifier</code> åŠä¸€ä¸ªä»¥ä¸Šçš„ <code>fmt_elt</code>ã€‚</p>
<ul>
<li>
<p><code>identifier</code> å¯ç”±å¼€å‘è€…è‡ªè®¢ï¼Œå¦‚ï¼š<code>opr</code>ã€<code>opi</code>â€¦ ç­‰ã€‚</p>
</li>
<li>
<p><code>fmt_elt</code> åˆ™å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä¸åŒçš„è¯­æ³•ï¼š</p>
<ul>
<li>
<p><code>fixedbit_elt</code> åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª <code>0</code>ã€<code>1</code>ã€<code>.</code>ã€<code>-</code>ï¼Œæ¯ä¸€ä¸ªä»£è¡¨æŒ‡ä»¤ä¸­çš„ 1 ä¸ª bitã€‚</p>
<ul>
<li><code>.</code> ä»£è¡¨è¯¥ bit å¯ä»¥ç”¨ <code>0</code> æˆ–æ˜¯ <code>1</code> æ¥è¡¨ç¤ºã€‚</li>
<li><code>-</code> ä»£è¡¨è¯¥ bit å®Œå…¨è¢«å¿½ç•¥ã€‚</li>
</ul>
</li>
<li>
<p><code>field_elt</code> å¯ä»¥ç”¨ Field çš„è¯­æ³•æ¥å£°æ˜ã€‚</p>
<ul>
<li>Egï¼š<code>ra:5</code>ã€<code>rb:5</code>ã€<code>lit:8</code></li>
</ul>
</li>
<li>
<p><code>field_ref</code> æœ‰ä¸‹åˆ—ä¸¤ç§æ ¼å¼ (ä»¥ä¸‹èŒƒä¾‹å‚è€ƒä¸Šæ–‡æ‰€å®šä¹‰ä¹‹ Field)ï¼š</p>
<ul>
<li>
<p><code>'%' identifier</code>ï¼šç›´æ¥å‚è€ƒä¸€ä¸ªè¢«å®šä¹‰è¿‡çš„ <code>Field</code>ã€‚</p>
<ul>
<li>
<p>å¦‚ï¼š<code>%rd</code>ï¼Œä¼šç”Ÿæˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><code>identifier '=' '%' identifier</code>ï¼šç›´æ¥å‚è€ƒä¸€ä¸ªè¢«å®šä¹‰è¿‡çš„ <code>Field</code>ï¼Œä½†é€šè¿‡ç¬¬ä¸€ä¸ª <code>identifier</code> æ¥é‡å‘½åå…¶æ‰€å¯¹åº”çš„ <code>argument</code> åç§°ã€‚æ­¤æ–¹å¼å¯ä»¥ç”¨æ¥æŒ‡å®šä¸åŒçš„ <code>argument</code> åç§°æ¥å‚è€ƒè‡³åŒä¸€ä¸ª <code>Field</code>ã€‚</p>
<ul>
<li>
<p>å¦‚ï¼š<code>my_rd=%rd</code>ï¼Œä¼šç”Ÿæˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">my_rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> 
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>args_ref</code> æŒ‡å®šæ‰€ä¼ å…¥ decode function çš„ <code>Argument Set</code>ã€‚è‹¥æ²¡æœ‰æŒ‡å®š <code>args_ref</code> çš„è¯ï¼Œ<code>Decodetree</code> ä¼šæ ¹æ® <code>field_elt</code> æˆ– <code>field_ref</code> è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <code>Argument Set</code>ã€‚æ­¤å¤–ï¼Œä¸€ä¸ª <code>Format</code> æœ€å¤šåªèƒ½åŒ…å«ä¸€ä¸ª <code>args_ref</code>ã€‚</p>
</li>
</ul>
</li>
</ul>
<p>å½“ <code>fixedbit_elt</code> æˆ– <code>field_ref</code> è¢«å®šä¹‰æ—¶ï¼Œè¯¥ <code>Foramt</code> çš„æ‰€æœ‰çš„ bits éƒ½å¿…é¡»è¢«å®šä¹‰ (å¯é€šè¿‡ <code>fixedbit_elt</code> æˆ– <code>.</code> æ¥å®šä¹‰å„ä¸ª bitsï¼Œ<code>ç©ºæ ¼</code>ä¼šè¢«å¿½ç•¥)ã€‚</p>
<h3 id="format-ç¤ºä¾‹">Format ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">@opi    ...... ra:5 lit:8    1 ....... rc:5
</span></span></code></pre></div><p>å®šä¹‰äº† <code>op1</code> è¿™ä¸ª <code>Format</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>insn[31:26] å¯ä¸º <code>0</code> æˆ– <code>1</code>ã€‚</li>
<li>insn[25:21] ä¸º <code>ra</code>ã€‚</li>
<li>insn[20:13] ä¸º <code>lit</code>ã€‚</li>
<li>insn[12] å›ºå®šä¸º <code>1</code>ã€‚</li>
<li>insn[11:5] å¯ä¸º <code>0</code> æˆ– <code>1</code>ã€‚</li>
<li>insn[4:0] ä¸º <code>rc</code>ã€‚</li>
</ul>
<p>æ­¤ <code>Format</code> ä¼šç”Ÿæˆä»¥ä¸‹çš„ decode functionï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">lit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ra</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_decode_insn320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_opi</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_decode_insn320</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">ra</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">lit</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rc</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç”±äºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®š <code>args_ref</code>ï¼Œå› æ­¤ <code>Decodetree</code> æ ¹æ®äº† <code>field_elt</code> çš„å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆäº† <code>arg_decode_insn320</code> è¿™ä¸ª <code>Argument Set</code>ã€‚</p>
<p>ä»¥ RISC-V <code>I-type</code> æŒ‡ä»¤ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># Fields:
</span></span><span class="line"><span class="cl">%rs1       15:5
</span></span><span class="line"><span class="cl">%rd        7:5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># immediates:
</span></span><span class="line"><span class="cl">%imm_i    20:s12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Argment sets:
</span></span><span class="line"><span class="cl">&amp;i    imm rs1 rd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@i       ........ ........ ........ ........ &amp;i      imm=%imm_i     %rs1 %rd
</span></span></code></pre></div><p>å®šä¹‰äº† <code>i</code> è¿™ä¸ª <code>Format</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>insn[31:20] ä¸º <code>imm</code>ï¼Œä¸”ä¸º ç¬¦å·æ‰©å±•ã€‚</li>
<li>insn[19:5] ä¸º <code>rs1</code>ã€‚</li>
<li>insn[11:7] ä¸º <code>rd</code>ã€‚</li>
</ul>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>æ­¤ <code>Format</code> æŒ‡å®šäº† <code>Argument Set</code>ï¼š<code>&amp;i</code>ã€‚ <code>&amp;i</code> ä¸­å¿…é¡»åŒ…å«æ‰€æœ‰æœ‰ç”¨åˆ°çš„ <code>arguments</code> (ä¹Ÿå°±æ˜¯ï¼š<code>imm</code>ã€<code>rs1</code> åŠ <code>rd</code>)</li>
<li><code>imm</code> æ˜¯é€šè¿‡é‡å‘½åçš„æ–¹å¼æ¥å‚è€ƒ <code>%imm_i</code> è¿™ä¸ª <code>Field</code>ã€‚</li>
</ul>
<p>æ­¤èŒƒä¾‹ä¼šç”Ÿæˆä»¥ä¸‹çš„ decode functionï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rs1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32extract_i</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_i</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rs1</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç›¸æ¯”äºç¬¬ä¸€ä¸ªèŒƒä¾‹ï¼Œç”±äºè¿™æ¬¡æˆ‘ä»¬æœ‰æŒ‡å®š <code>args_ref</code>ï¼š<code>&amp;i</code>ï¼Œå› æ­¤å¯¹åº”çš„ <code>arg_i</code> ä¼šè¢«ä¼ å…¥ decode functionã€‚</p>
<hr>
<p>å›åˆ°å…ˆå‰çš„ RISC-V <code>U-type</code> æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚åŒ <code>I-type</code> æŒ‡ä»¤å®šä¹‰å…¶æ ¼å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># Fields:
</span></span><span class="line"><span class="cl">%rd        7:5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># immediates:
</span></span><span class="line"><span class="cl">%imm_u    12:s20                 !function=ex_shift_12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Argument sets:
</span></span><span class="line"><span class="cl">&amp;u    imm rd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@u       ....................      ..... ....... &amp;u      imm=%imm_u          %rd
</span></span></code></pre></div><p>å®šä¹‰äº† <code>u</code> è¿™ä¸ª <code>Format</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>insn[31:12] ä¸º <code>imm</code>ï¼Œä¸”ä¸º ç¬¦å·æ‰©å±•ã€‚</li>
<li>insn[11:7] ä¸º <code>rd</code>ã€‚</li>
</ul>
<p>ä¼šç”Ÿæˆä»¥ä¸‹çš„ decode functionï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_u</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>æ­¤ <code>Format</code> æŒ‡å®šäº† <code>Argument Set</code>ï¼š<code>&amp;u</code>ã€‚ <code>&amp;u</code> ä¸­å¿…é¡»åŒ…å«æ‰€æœ‰æœ‰ç”¨åˆ°çš„ <code>arguments</code> (ä¹Ÿå°±æ˜¯ï¼š<code>imm</code>ã€<code>rd</code>)</li>
<li><code>imm</code> æ˜¯é€šè¿‡é‡å‘½åçš„æ–¹å¼æ¥å‚è€ƒ <code>%imm_u</code> è¿™ä¸ª <code>Field</code>ã€‚</li>
</ul>
<h2 id="pattern">Pattern</h2>
<p><code>Pattern</code> å®é™…å®šä¹‰äº†ä¸€ä¸ªæŒ‡ä»¤çš„ decode æ–¹å¼ã€‚<code>Decodetree</code> ä¼šæ ¹æ® <code>Patterns</code> çš„å®šä¹‰ï¼Œæ¥åŠ¨æ€äº§ç”Ÿå‡ºå¯¹åº”çš„ <code>switch-case</code> decode åˆ¤æ–­åˆ†æ”¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">pat_def      := identifier ( pat_elt )+
</span></span><span class="line"><span class="cl">pat_elt      := fixedbit_elt | field_elt | field_ref | args_ref | fmt_ref | const_elt
</span></span><span class="line"><span class="cl">fmt_ref      := &#39;@&#39; identifier
</span></span><span class="line"><span class="cl">const_elt    := identifier &#39;=&#39; number
</span></span></code></pre></div><p>å…¶è¯­æ³•ç”±ç”¨æˆ·æ‰€å®šä¹‰çš„ <code>identifier</code>ï¼Œéšåç´§æ¥ç€ä¸€ä¸ªä»¥ä¸Šçš„ <code>pat_elt</code>ã€‚</p>
<ul>
<li>
<p><code>identifier</code> å¯ç”±å¼€å‘è€…è‡ªè®¢ï¼Œå¦‚ï¼š<code>addl_r</code>ã€<code>addli</code> â€¦ ç­‰ã€‚</p>
</li>
<li>
<p><code>pat_elt</code> åˆ™å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä¸åŒçš„è¯­æ³•ï¼š</p>
<ul>
<li><code>fixedbit_elt</code> ä¸åœ¨ <code>Format</code> ä¸­ <code>fixedbit_elt</code> çš„å®šä¹‰ç›¸åŒã€‚</li>
<li><code>field_elt</code> ä¸åœ¨ <code>Format</code> ä¸­ <code>field_elt</code> çš„å®šä¹‰ç›¸åŒã€‚</li>
<li><code>field_ref</code> ä¸åœ¨ <code>Format</code> ä¸­ <code>field_ref</code> çš„å®šä¹‰ç›¸åŒã€‚</li>
<li><code>args_ref</code> ä¸åœ¨ <code>Format</code> ä¸­ <code>args_ref</code> çš„å®šä¹‰ç›¸åŒã€‚</li>
<li><code>fmt_ref</code> ç›´æ¥å‚è€ƒä¸€ä¸ªè¢«å®šä¹‰è¿‡çš„Formatã€‚</li>
<li><code>const_elt</code> å¯ä»¥ç›´æ¥æŒ‡å®šæŸä¸€ä¸ª <code>argument</code> çš„å€¼ã€‚</li>
</ul>
</li>
</ul>
<p>ç”±äº <code>Pattern</code> å®é™…å®šä¹‰äº†ä¸€ä¸ªæŒ‡ä»¤çš„ decode æ–¹å¼ï¼Œå› æ­¤<strong>æ‰€æœ‰çš„ bits</strong> åŠ <strong>arguments (å¦‚æœæœ‰å‚è€ƒ args_ref çš„è¯)</strong>  éƒ½å¿…é¡»æ˜ç¡®çš„è¢«å®šä¹‰ï¼Œå¦‚æœåœ¨æ­é…äº†æ‰€æœ‰çš„ <code>pat_elt</code> åè¿˜æœ‰æœªå®šä¹‰çš„ bits æˆ–æ˜¯ arguments çš„è¯ï¼Œ<code>Decodetree</code> ä¾¿ä¼šæŠ¥é”™ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>Pattern</code> æ‰€äº§ç”Ÿå‡ºæ¥çš„ decoderï¼Œæœ€åè¿˜ä¼šè°ƒç”¨å¯¹åº”çš„ <code>translator function</code>ã€‚<code>translator function</code> éœ€å¼€å‘è€…è‡ªè¡Œå®šä¹‰ã€‚</p>
<h3 id="pattern-ç¤ºä¾‹">Pattern ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">addl_i   010000 ..... ..... .... 0000000 ..... @opi
</span></span></code></pre></div><p>å®šä¹‰äº† <code>addl_i</code> è¿™ä¸ªæŒ‡ä»¤çš„ <code>Pattern</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>insn[31:26] ä¸º <code>010000</code>ã€‚</li>
<li>insn[11:5] ä¸º <code>0000000</code>ã€‚</li>
<li>å‚è€ƒäº† Format ç¤ºä¾‹ä¸­ å®šä¹‰çš„ <code>@opi</code> <code>Format</code>ã€‚</li>
<li>ç”±äº <code>Pattern</code> çš„<strong>æ‰€æœ‰ bits</strong> éƒ½å¿…é¡»æ˜ç¡®çš„è¢«å®šä¹‰ï¼Œå› æ­¤ <code>@opi</code> å¿…é¡»åŒ…å«å…¶ä½™ <code>insn[25:12]</code> åŠ <code>insn[4:0]</code> çš„æ ¼å¼å®šä¹‰ï¼Œå¦åˆ™ <code>Decodetree</code> ä¾¿ä¼šæŠ¥é”™ã€‚</li>
</ul>
<p>æœ€å <code>addl_i</code> çš„ decoder è¿˜ä¼šè°ƒç”¨ <code>trans_addl_i()</code> è¿™ä¸ª <code>translator function</code>ã€‚</p>
<p>æ­é…ä¹‹å‰ä»‹ç»çš„ Fieldsã€Argument Sets åŠ Formatsï¼Œè®©æˆ‘ä»¬å†çœ‹å‡ ä¸ªå®Œæ•´çš„ä¾‹å­åº”è¯¥ä¼šæ›´æ¸…æ¥š <code>Decodetree</code> æ˜¯æ€äº§ç”Ÿä¸€ä¸ªæŒ‡ä»¤çš„ decoder çš„ã€‚</p>
<p>é¦–å…ˆæ˜¯ RISC-V çš„ <code>lui</code> åŠ <code>auipc</code> æŒ‡ä»¤ï¼š</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F19%2F922be39211d73158159edf9993a2c906.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F19%2F922be39211d73158159edf9993a2c906.png" alt=""  />
</a>
</div>

</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># Fields:
</span></span><span class="line"><span class="cl">%rd        7:5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># immediates:
</span></span><span class="line"><span class="cl">%imm_u    12:s20                 !function=ex_shift_12
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Argument sets:
</span></span><span class="line"><span class="cl">&amp;u    imm rd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Formats:
</span></span><span class="line"><span class="cl">@u       ....................      ..... ....... &amp;u      imm=%imm_u          %rd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Patterns
</span></span><span class="line"><span class="cl">lui      ....................       ..... 0110111 @u
</span></span><span class="line"><span class="cl">auipc    ....................       ..... 0010111 @u
</span></span></code></pre></div><p>ä¼šäº§ç”Ÿä»¥ä¸‹ <code>lui</code> åŠ <code>auipc</code> çš„ decoderï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_u</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">decode_insn32</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_u</span> <span class="n">f_u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000007f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x00000017</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_auipc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x00000037</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_lui</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å›é¡¾åˆ°ç›®å‰ä¸ºæ­¢æ‰€ä»‹ç»çš„ï¼š</p>
<ul>
<li>
<p><code>Argument Sets</code>ï¼š<code>&amp;u</code> è¿™ä¸ª <code>argument set</code> åŒ…å«äº† <code>imm</code> åŠ <code>rd</code> è¿™ä¸¤ä¸ª <code>arguments</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">imm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_u</span><span class="p">;</span>
</span></span></code></pre></div></li>
<li>
<p><code>Fields</code>ï¼š <code>imm</code> åŠ <code>rd</code> åˆ†åˆ«ä½åœ¨ insn[31:12] åŠ insn[11:7]ï¼Œä¸” <code>imm</code> ä¸º ç¬¦å·æ‰©å±•ã€‚æœ€ååœ¨æˆªå–å‡º <code>imm</code> çš„å€¼åï¼Œè¿˜ä¼šè°ƒç”¨ <code>ex_shift_12()</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span></code></pre></div></li>
<li>
<p><code>Formats</code>ï¼š<code>@u</code> å®šä¹‰äº† RISC-V <code>U-type</code> æŒ‡ä»¤çš„æ ¼å¼</p>
<ul>
<li>å‚è€ƒäº† <code>&amp;u</code> è¿™ä¸ª <code>Argument Set</code>ï¼Œå› æ­¤ decode function ä¼šä¼ å…¥ <code>arg_u</code> ä½œä¸ºå‚æ•°ã€‚</li>
<li>insn[31:12] å‚è€ƒäº† <code>imm_u</code> è¿™ä¸ª <code>Field</code> (å¹¶é‡å‘½åä¸º <code>imm</code>)</li>
<li>insn[11:7] å‚è€ƒäº† <code>rd</code> è¿™ä¸ª <code>Field</code>ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_u</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="nf">ex_shift_12</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">sextract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>Patterns</code>ï¼š</p>
<ul>
<li><code>lui</code> çš„ <code>opcode</code> (insn[6:0]) ä¸º <code>0010111</code>ï¼Œä¹Ÿå°±æ˜¯ <code>0x17</code>ï¼Œåœ¨äº§ç”Ÿå‡ºæ¥çš„ <code>switch-case</code> ä¸­å¯ä»¥çœ‹åˆ°å…¶å¯¹åº”çš„ <code>case</code>ã€‚</li>
<li><code>lui</code> çš„ decoder æœ€åè°ƒç”¨äº† <code>trans_lui()</code>ï¼Œå¹¶ä¼ å…¥ <code>DisasContext</code> åŠç»ç”± <code>decode_insn32_extract_u()</code> æ‰€è§£æå‡ºæ¥çš„ <code>arg_u</code>ã€‚</li>
<li><code>auipc</code> çš„ <code>opcode</code> (insn[6:0]) ä¸º <code>0110111</code>ï¼Œä¹Ÿå°±æ˜¯ <code>0x37</code>ï¼Œåœ¨äº§ç”Ÿå‡ºæ¥çš„ <code>switch-case</code> ä¸­å¯ä»¥çœ‹åˆ°å…¶å¯¹åº”çš„ <code>case</code>ã€‚</li>
<li><code>auipc</code> çš„ decoder æœ€åè°ƒç”¨äº† <code>trans_auipc()</code>ï¼Œå¹¶ä¼ å…¥ <code>DisasContext</code> åŠç»ç”± <code>decode_insn32_extract_u()</code> æ‰€è§£æå‡ºæ¥çš„ <code>arg_u</code>ã€‚</li>
<li>P.S. è¿™è¾¹ç”±äº <code>Decodetree</code> å‘ç° <code>lui</code> åŠ <code>auipc</code> å¯ä»¥å…±ç”¨ <code>decode_insn32_extract_u()</code>ï¼Œå› æ­¤å°†å…¶æåˆ°äº† <code>switch-case</code> ä¹‹å¤–ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">decode_insn32</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_u</span> <span class="n">f_u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">decode_insn32_extract_u</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000007f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x00000017</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_auipc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x00000037</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_lui</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_u</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¦å¤–å¯ä»¥å‘ç°ï¼Œ<code>Pattern</code> + <code>Format</code> æŠŠæ‰€æœ‰çš„ 32-bits éƒ½ç»™äº†æ˜ç¡®çš„å®šä¹‰ï¼š</p>
<ul>
<li><code>Pattern</code> å®šä¹‰äº† <code>opcode</code> (insn[6:0])ã€‚</li>
<li><code>Format</code> å‚è€ƒäº† <code>imm</code> (insn[31:12]) åŠ <code>rd</code> (insn[11:7])ã€‚</li>
</ul>
<p>å¦‚æœæœ‰ä»»ä½•æœªæ˜ç¡®å®šä¹‰çš„ bits çš„è¯ï¼Œ<code>Decodetree</code> ä¾¿ä¼šæŠ¥é”™ï¼Œä¾‹å¦‚å¦‚æœæˆ‘ä»¬å°† <code>lui</code> çš„ <code>opcode</code> æœ€é«˜ 2 ä¸ª bits (insn[6:5]) ç”± <code>01</code> æ”¹æˆ <code>..</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">lui      ....................       ..... ..10111 @u
</span></span></code></pre></div><p><code>Decodetree</code> åœ¨è§£ææ—¶ï¼Œä¾¿ä¼šæŠ¥é”™ï¼š</p>
<blockquote>
<p>./insn32.decode:17: error: (â€˜bits left unspecified (0x00000060)â€™,)</p>
</blockquote>
<p><code>Decodetree</code> æé†’æˆ‘ä»¬ï¼Œinsn[6:5] (<code>0x00000060</code>) å°šæœªç»™å‡ºæ˜ç¡®å®šä¹‰ï¼Œå¹¶ä¼šæ˜¾ç¤ºå‡ºå…¶é”™è¯¯çš„è¡Œæ•°ã€‚</p>
<p><code>trans_lui()</code> å’Œ <code>trans_auipc()</code> è¢«å®šä¹‰åœ¨ <code>target/riscv/insn_trans/trans_rvi.inc.c</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">trans_lui</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_lui</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">tcg_gen_movi_tl</span><span class="p">(</span><span class="n">cpu_gpr</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">],</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">trans_auipc</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_auipc</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">tcg_gen_movi_tl</span><span class="p">(</span><span class="n">cpu_gpr</span><span class="p">[</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">],</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">pc_next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° <code>trans_*()</code> è´Ÿè´£å®é™…æŒ‡ä»¤çš„ä¸šåŠ¡é€»è¾‘åŠäº§ç”Ÿå¯¹åº”çš„ <code>TCG codes</code>ã€‚</p>
</li>
</ul>
<p>å¦‚åŒå…ˆå‰æ‰€ä»‹ç»ï¼Œ<code>Patterns</code> çš„ <code>pat_elt</code> ä¹Ÿå¯ä»¥é‡‡ç”¨ <code>field_elt</code> è¯­æ³•ï¼Œå¦‚ RISC-V çš„ <code>fence</code> æŒ‡ä»¤ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">fence    ---- pred:4 succ:4 ----- 000 ----- 0001111
</span></span></code></pre></div><ul>
<li>insn[27:24] ä¸º <code>pred</code>ã€‚</li>
<li>insn[23:20] ä¸º <code>succ</code>ã€‚</li>
<li>insn[14:12] å›ºå®šä¸º <code>000</code>ã€‚</li>
<li>insn[6:0] ä¸º <code>opcode</code> (<code>0001111</code>)ã€‚</li>
<li>æ²¡æœ‰å‚è€ƒä»»ä½•çš„ <code>Format</code>ã€‚</li>
<li>å‰©ä¸‹çš„ insn[31:28]ã€insn[19:15]ã€insn[11:7] è¢«å£°æ˜ä¸º <code>-</code>ï¼Œå› æ­¤å°±ç®—æ²¡æœ‰è¢«æ˜ç¡®å®šä¹‰ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚</li>
</ul>
<p>æ‰€ç”Ÿæˆ <code>fence</code> çš„ decoder å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">succ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">arg_decode_insn320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn32_extract_decode_insn32_Fmt_0</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_decode_insn320</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">pred</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">succ</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">decode_insn32</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_decode_insn320</span> <span class="n">f_decode_insn320</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">decode_insn32_extract_decode_insn32_Fmt_0</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode_insn320</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000707f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x0000000f</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_fence</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode_insn320</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™æ¬¡æˆ‘ä»¬æ²¡æœ‰å‚è€ƒä»»ä½•çš„ <code>Argument Set</code>ï¼Œä½† <code>Decodetree</code> è¿˜æ˜¯æ›¿æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªåŒ…å« <code>pred</code> å’Œ <code>succ</code> çš„ <code>arg_decode_insn320</code> ã€‚</p>
<p><code>trans_fence()</code> åŒæ ·æ˜¯è¢«å®šä¹‰åœ¨ <code>./target/riscv/insn_trans/trans_rvi.inc.c</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">trans_fence</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_fence</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="nf">tcg_gen_mb</span><span class="p">(</span><span class="n">TCG_MO_ALL</span> <span class="o">|</span> <span class="n">TCG_BAR_SC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="pattern-groups">Pattern Groups</h2>
<p><code>Pattern Groups</code> ç”±ä¸€ä¸ªä»¥ä¸Šçš„ <code>Patterns</code> æ‰€ç»„æˆï¼Œå…¶ä¸»è¦å·®åˆ«æ˜¯ä¸åŒ <code>Patterns</code> ä¹‹é—´çš„ bits å¯ä»¥ overlapã€‚å½“åŒç»„ä¸­æœ‰å¤šä¸ª <code>Patterns</code> æ—¶ï¼Œä¼šä¾æ®è¯¥ç»„ä¸­å„ <code>Pattern</code> çš„å£°æ˜é¡ºåºä¾åºåˆ¤æ–­ç›®å‰çš„æŒ‡ä»¤æ˜¯å¦ç¬¦åˆå…¶å®šä¹‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå½“ç¬¦åˆçš„ <code>Pattern</code> å…¶ <code>trans_*()</code> å›ä¼ å€¼ä¸º <code>false</code> æ—¶ï¼Œä¹Ÿä¼šè¢«è§†ä¸º<strong>ä¸ç›¸ç¬¦</strong>ï¼Œè€Œç»§ç»­åˆ¤æ–­è¯¥ç»„ä¸­çš„ä¸‹ä¸€ä¸ª <code>Pattern</code>ã€‚å› æ­¤ <code>Pattern Groups</code> éå¸¸é€‚åˆå°†å¤šä¸ªç›¸ä¼¼æ ¼å¼çš„æŒ‡ä»¤ç»™ç»„æˆåŒä¸€ä¸ª <code>Pattern Group</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">group    := &#39;{&#39; ( pat_def | group )+ &#39;}&#39;
</span></span></code></pre></div><p>å„ <code>Pattern Group</code> ä»¥ <code>{</code> å¼€å¤´ï¼Œå¹¶ä»¥ <code>}</code> ç»“å°¾ï¼Œä¸”å…è®¸ <code>nested pattern groups</code> çš„å­˜åœ¨ï¼Œå…¶ä»–è¯­æ³•çš†ä¸ <code>Pattern</code> ç›¸åŒã€‚</p>
<h3 id="pattern-group-ç¤ºä¾‹">Pattern Group ç¤ºä¾‹</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    nop   000010 ----- ----- 0000 001001 0 00000
</span></span><span class="line"><span class="cl">    copy  000010 00000 r1:5  0000 001001 0 rt:5
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  or      000010 rt2:5 r1:5  cf:4 001001 0 rt:5
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ä¼šäº§ç”Ÿä»¥ä¸‹çš„ decoderï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">switch</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xfc000fe0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="mh">0x08000240</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000f000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="nf">extract_decode_Fmt_0</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode0</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">trans_nop</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode0</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x03e00000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">          <span class="nf">extract_decode_Fmt_1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode1</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nf">trans_copy</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode1</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				ã€€
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">extract_decode_Fmt_2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode2</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">trans_or</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode2</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å½“æŒ‡ä»¤çš„å€¼ç¬¦åˆ <code>nop</code> åŠ <code>copy</code> è¿™ä¸ªå†…å±‚ <code>Pattern Group</code> æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­è¯¥æŒ‡ä»¤æ˜¯å¦ç¬¦åˆ <code>nop</code> æŒ‡ä»¤çš„å®šä¹‰ï¼Œä¸” <code>trans_nop()</code> çš„å›ä¼ å€¼ä¸º <code>true</code>ã€‚å¦åˆ™çš„è¯ï¼Œå°±ä¼šç»§ç»­åˆ¤æ–­æ˜¯å¦ç¬¦åˆåŒç»„ä¸­çš„ <code>copy</code> æŒ‡ä»¤ã€‚è‹¥éƒ½ä¸ç¬¦ï¼Œå°±ä¼šå†åˆ¤æ–­æ˜¯å¦ç¬¦åˆå¤–å±‚ <code>Pattern Group</code> çš„ <code>or</code> æŒ‡ä»¤ã€‚è‹¥ä»ä¸ç¬¦ï¼Œæ‰ä¼šå›ä¼  <code>false</code> è¡¨ç¤º decode å¤±è´¥ã€‚</p>
<p>ä¸å•çº¯ä½¿ç”¨ <code>Pattern</code> æœ€å¤§ä¸åŒçš„æ˜¯ï¼Œå½“ä¸€ <code>Pattern</code> çš„ <code>trans_*()</code> å›ä¼ å€¼ä¸º <code>false</code> æ—¶ï¼Œä¸ä¼šç›´æ¥å›ä¼  <code>false</code> (ä»£è¡¨ decode å¤±è´¥)ï¼Œè€Œæ˜¯ä¼šæ¥ç»­ç€åˆ¤æ–­åç»­çš„ <code>Patterns</code> æ˜¯å¦ç›¸ç¬¦ã€‚</p>
<p>RISC-V Compressed-Extension ä¸­çš„ <code>c.ebreak</code>ã€<code>c.jalr</code>ã€åŠ <code>c.add</code> æŒ‡ä»¤ï¼Œç”±äºè¿™ä¸‰ä¸ªæŒ‡ä»¤çš„æ ¼å¼éå¸¸ç›¸ä¼¼ï¼Œå› æ­¤éå¸¸é€‚åˆä½¿ç”¨ <code>Pattern Group</code> æ¥å®šä¹‰ï¼š</p>
<p>RISC-V spec. ä¸­å®šä¹‰ï¼š</p>
<p>
<div class="post-img-view">
<a data-fancybox="gallery" href="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F19%2F722c64cc1a321ef23fab81e722a24154.png">
<img src="https://picbed-1311007548.cos.ap-shanghai.myqcloud.com/markdown_picbed/img/%2F2024%2F03%2F19%2F722c64cc1a321ef23fab81e722a24154.png" alt=""  />
</a>
</div>

</p>
<ul>
<li><code>C.EBREAK</code>æŒ‡ä»¤ä¸<code>C.ADD</code>æŒ‡ä»¤å…±äº«ç›¸åŒçš„<code>opcode</code>ï¼Œä½†æ˜¯<code>rd</code>å’Œ<code>rs2</code>éƒ½ä¸º<code>zero</code>ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨<code>CR</code>æ ¼å¼ã€‚</li>
<li><code>C.JALR</code>æŒ‡ä»¤åªæœ‰åœ¨<code>rs1â‰ x0</code>æ—¶æ‰æœ‰æ•ˆï¼›å½“<code>rs1=x0</code>æ—¶ï¼Œå¯¹åº”çš„ä»£ç ç‚¹æ˜¯<code>C.EBREAK</code>æŒ‡ä»¤ã€‚</li>
<li><code>C.ADD</code>æŒ‡ä»¤åªæœ‰åœ¨<code>rs2â‰ x0</code>æ—¶æ‰æœ‰æ•ˆï¼›å½“<code>rs2=x0</code>æ—¶ï¼Œå¯¹åº”çš„ä»£ç ç‚¹æ˜¯<code>C.JALR</code>å’Œ<code>C.EBREAK</code>æŒ‡ä»¤ã€‚å…·æœ‰<code>rs2Ì¸=x0</code>å’Œ<code>rd=x0</code>çš„ä»£ç ç‚¹æ˜¯<code>HINTs</code>ã€‚</li>
</ul>
<p><code>c.ebreak</code>ã€<code>c.jalr</code>ã€<code>c.add</code> ä¸‰ä¸ªæŒ‡ä»¤ï¼š</p>
<ul>
<li>insn[15:13]ã€insn[12]ã€insn[1:0] çš„å€¼çš†ç›¸åŒã€‚</li>
<li>å½“ insn[11:7] ä¸” insn[6:2] çš„å€¼çš†ä¸º <code>0</code> (<code>rs1=0</code> ä¸” <code>rs2=0</code>) æ—¶ä¸º <code>c.ebreak</code> æŒ‡ä»¤ã€‚</li>
<li>å½“åªæœ‰ insn[11:7] çš„å€¼ä¸º <code>0</code> (<code>rs1=0</code> ä¸” <code>rs2â‰ 0</code>) æ—¶ä¸º <code>c.jalr</code> æŒ‡ä»¤ã€‚</li>
<li>å¦åˆ™ä¸º <code>c.add</code> æŒ‡ä»¤ (<code>rs1â‰ x0</code> ä¸” <code>rs2â‰ 0</code>)ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl"># Fields
</span></span><span class="line"><span class="cl">%rd        7:5
</span></span><span class="line"><span class="cl">%rs2_5     2:5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Argument Sets
</span></span><span class="line"><span class="cl">&amp;r         rd rs1 rs2   !extern
</span></span><span class="line"><span class="cl">&amp;i         imm rs1 rd   !extern
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Formats
</span></span><span class="line"><span class="cl">@cr        ....  ..... .....  .. &amp;r      rs2=%rs2_5       rs1=%rd     %rd
</span></span><span class="line"><span class="cl">@c_jalr    ... . .....  ..... .. &amp;i      imm=0 rs1=%rd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Pattern Groups
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  ebreak          100 1  00000  00000 10
</span></span><span class="line"><span class="cl">  jalr            100 1  .....  00000 10 @c_jalr rd=1  # C.JALR
</span></span><span class="line"><span class="cl">  add             100 1  .....  ..... 10 @cr
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>æ‰€ç”Ÿæˆçš„ decoder å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn16_extract_c_jalr</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_i</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">imm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rs1</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn16_extract_cr</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_r</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rs2</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rs1</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="nf">extract32</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_insn16_extract_decode_insn16_Fmt_2</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg_decode_insn162</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">decode_insn16</span><span class="p">(</span><span class="n">DisasContext</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">insn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_decode_insn162</span> <span class="n">f_decode_insn162</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_i</span> <span class="n">f_i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">arg_r</span> <span class="n">f_r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000f003</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x00009002</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x00000ffc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="nf">decode_insn16_extract_decode_insn16_Fmt_2</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode_insn162</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">trans_ebreak</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_decode_insn162</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000007c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00000000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="nf">decode_insn16_extract_c_jalr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_i</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">u</span><span class="p">.</span><span class="n">f_i</span><span class="p">.</span><span class="n">rd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">trans_jalr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_i</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="nf">decode_insn16_extract_cr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_r</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">trans_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">f_r</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å½“æŒ‡ä»¤æ ¼å¼ç¬¦åˆ <code>c.ebreak</code>ã€<code>c.jalr</code>ã€<code>c.add</code> çš„ <code>Pattern Group</code> æ—¶ï¼Œä¼šä¾åºåˆ¤æ–­è¯¥æŒ‡ä»¤æ˜¯å¦ç¬¦åˆ <code>c.ebreak</code>ã€<code>c.jalr</code>ã€<code>c.add</code> çš„å®šä¹‰ä»¥åŠå…¶å¯¹åº”çš„ <code>trans_*()</code>ã€‚</p>
<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ <code>c_jalr</code> <code>Format</code> å’Œ <code>jalr</code> <code>Pattern</code> ä¸­æœ‰åˆ†åˆ«æŒ‡å®šå…¶ <code>imm</code> åŠ <code>rd</code> çš„å€¼ä¸º <code>0</code>ï¼Œæ‰€ç”Ÿæˆçš„ codes ä¹Ÿä¼šåˆ†åˆ«åœ¨å¯¹åº”çš„åœ°æ–¹å°†è¯¥å€¼è®¾ä¸º <code>0</code> (è§ codes æ³¨è§£è¯´æ˜)ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä»¥ä¸Šå°±æ˜¯ <code>Decodetree</code> çš„è¯­æ³•è¯´æ˜ã€‚é€šè¿‡ <code>Decodetree</code>ï¼Œæˆ‘ä»¬ä¸ç”¨å†åƒä»¥å‰ä»¥æ ·å†™ä¸€å¤§åŒ…çš„ <code>switch-case</code> æ¥ decode æŒ‡ä»¤ã€‚å°†ä¸åŒç±»å‹çš„æŒ‡ä»¤å†™è‡³ä¸åŒçš„ decode æ¡£ï¼Œä¸ä»…æ–¹ä¾¿ç»´æŠ¤ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿæ›´ä¸ºå®¹æ˜“ã€‚</p>
<hr>
<ul>
<li><code>--translate</code>ï¼štranslator function çš„ prefixï¼Œé»˜è®¤ä¸º <code>trans</code>ã€‚ä¸€æ—¦æŒ‡å®šåï¼Œtranslator function çš„ scope å°±ä¸ä¼šå†æ˜¯ <code>static</code>ã€‚</li>
<li><code>--decode</code>ï¼šdecode function çš„ prefixï¼Œé»˜è®¤ä¸º <code>decode</code>ï¼Œä¸” scope ä¸º <code>static</code>ã€‚ä¸€æ—¦æŒ‡å®šåï¼Œdecode function çš„ scope å°±ä¸ä¼šå†æ˜¯ <code>static</code>ã€‚</li>
<li><code>--static-decode</code>ï¼šå¦‚åŒ <code>--decode</code>ï¼Œä¸è¿‡ decode function çš„ scope ä»ç»´æŒä¸º <code>static</code>ã€‚</li>
<li><code>-o</code> / <code>--output</code>ï¼šæŒ‡å®šç”Ÿæˆçš„ decoder <code>.c</code> æ¡£è·¯å¾„ã€‚</li>
<li><code>-w</code> / <code>--insnwidth</code>ï¼šæŒ‡ä»¤é•¿åº¦ï¼Œegï¼š<code>32</code> or <code>16</code>ï¼Œé»˜è®¤ä¸º <code>32</code>ã€‚</li>
<li><code>--varinsnwidth</code>ï¼šæŒ‡ä»¤ä¸ºä¸å®šé•¿åº¦ã€‚</li>
<li><code>æœ€åä¸€ä¸ªå‚æ•°</code>ä¸ºè¾“å…¥çš„ decode æ¡£è·¯å¾„ã€‚</li>
</ul>
<p>è¿è¡ŒèŒƒä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">./decodetree.py -o target/riscv/decode_insn16.inc.c --static-decode decode_insn16 \
</span></span><span class="line"><span class="cl">    -w 16 ./insn16.decode
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">static inline int32_t sextract32(uint32_t value, int start, int length){    assert(start &gt;= 0 &amp;&amp; length &gt; 0 &amp;&amp; length &lt;= 32 - start);        return ((int32_t)(value &lt;&lt; (32 - length - start))) &gt;&gt; (32 - length);}
</span></span></code></pre></div>]]></content:encoded>
    </item>
  </channel>
</rss>
